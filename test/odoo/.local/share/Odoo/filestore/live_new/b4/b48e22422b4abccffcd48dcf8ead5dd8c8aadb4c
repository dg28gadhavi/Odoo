
/* /web/static/src/polyfills/object.js */
if(!Object.hasOwn){Object.hasOwn=(obj,key)=>Object.prototype.hasOwnProperty.call(obj,key);};

/* /web/static/src/polyfills/array.js */
if(!Array.prototype.at){Object.defineProperty(Array.prototype,"at",{enumerable:false,value:function(index){if(index>=0){return this[index];}
return this[this.length+index];}});};

/* /web/static/src/module_loader.js */
(function(){"use strict";class ModuleLoader{factories=new Map();jobs=new Set();failed=new Set();modules=new Map();bus=new EventTarget();checkErrorProm=null;define(name,deps,factory){if(typeof name!=="string"){throw new Error(`Invalid name definition: ${name} (should be a string)"`);}
if(!(deps instanceof Array)){throw new Error(`Dependencies should be defined by an array: ${deps}`);}
if(typeof factory!=="function"){throw new Error(`Factory should be defined by a function ${factory}`);}
if(!this.factories.has(name)){this.factories.set(name,{deps,fn:factory,ignoreMissingDeps:globalThis.__odooIgnoreMissingDependencies,});this.addJob(name);this.checkErrorProm||=Promise.resolve().then(()=>{this.checkAndReportErrors();this.checkErrorProm=null;});}}
addJob(name){this.jobs.add(name);this.startModules();}
findJob(){for(const job of this.jobs){if(this.factories.get(job).deps.every((dep)=>this.modules.has(dep))){return job;}}
return null;}
startModules(){let job;while((job=this.findJob())){this.startModule(job);}}
startModule(name){const require=(name)=>this.modules.get(name);this.jobs.delete(name);const factory=this.factories.get(name);let value=null;try{value=factory.fn(require);}catch(error){this.failed.add(name);throw new Error(`Error while loading "${name}":\n${error}`);}
this.modules.set(name,value);this.bus.dispatchEvent(new CustomEvent("module-started",{detail:{moduleName:name,module:value}}));}
findErrors(){const dependencyGraph=new Map();for(const job of this.jobs){dependencyGraph.set(job,this.factories.get(job).deps);}
function visitJobs(jobs,visited=new Set()){for(const job of jobs){const result=visitJob(job,visited);if(result){return result;}}
return null;}
function visitJob(job,visited){if(visited.has(job)){const jobs=Array.from(visited).concat([job]);const index=jobs.indexOf(job);return jobs.slice(index).map((j)=>`"${j}"`).join(" => ");}
const deps=dependencyGraph.get(job);return deps?visitJobs(deps,new Set(visited).add(job)):null;}
const missing=new Set();for(const job of this.jobs){const factory=this.factories.get(job);if(factory.ignoreMissingDeps){continue;}
for(const dep of factory.deps){if(!this.factories.has(dep)){missing.add(dep);}}}
return{failed:[...this.failed],cycle:visitJobs(this.jobs),missing:[...missing],unloaded:[...this.jobs].filter((j)=>!this.factories.get(j).ignoreMissingDeps),};}
async checkAndReportErrors(){const{failed,cycle,missing,unloaded}=this.findErrors();if(!failed.length&&!unloaded.length){return;}
function domReady(cb){if(document.readyState==="complete"){cb();}else{document.addEventListener("DOMContentLoaded",cb);}}
function list(heading,names){const frag=document.createDocumentFragment();if(!names||!names.length){return frag;}
frag.textContent=heading;const ul=document.createElement("ul");for(const el of names){const li=document.createElement("li");li.textContent=el;ul.append(li);}
frag.appendChild(ul);return frag;}
domReady(()=>{while(document.body.childNodes.length){document.body.childNodes[0].remove();}
const container=document.createElement("div");container.className="o_module_error position-fixed w-100 h-100 d-flex align-items-center flex-column bg-white overflow-auto modal";container.style.zIndex="10000";const alert=document.createElement("div");alert.className="alert alert-danger o_error_detail fw-bold m-auto";container.appendChild(alert);alert.appendChild(list("The following modules failed to load because of an error, you may find more information in the devtools console:",failed));alert.appendChild(list("The following modules could not be loaded because they form a dependency cycle:",cycle&&[cycle]));alert.appendChild(list("The following modules are needed by other modules but have not been defined, they may not be present in the correct asset bundle:",missing));alert.appendChild(list("The following modules could not be loaded because they have unmet dependencies, this is a secondary error which is likely caused by one of the above problems:",unloaded));document.body.appendChild(container);});}}
if(!globalThis.odoo){globalThis.odoo={};}
const odoo=globalThis.odoo;if(odoo.debug&&!new URLSearchParams(location.search).has("debug")){odoo.debug="";}
const loader=new ModuleLoader();odoo.define=loader.define.bind(loader);odoo.loader=loader;})();;

/* /web/static/src/session.js */
odoo.define('@web/session',[],function(require){'use strict';let __exports={};const session=__exports.session=odoo.__session_info__||{};delete odoo.__session_info__;return __exports;});;

/* /web/static/src/core/browser/cookie.js */
odoo.define('@web/core/browser/cookie',[],function(require){'use strict';let __exports={};const COOKIE_TTL=24*60*60*365;const cookie=__exports.cookie={get _cookieMonster(){return document.cookie;},set _cookieMonster(value){document.cookie=value;},get(str){const parts=this._cookieMonster.split("; ");for(const part of parts){const[key,value]=part.split(/=(.*)/);if(key===str){return value||"";}}},set(key,value,ttl=COOKIE_TTL){let fullCookie=[];if(value!==undefined){fullCookie.push(`${key}=${value}`);}
fullCookie=fullCookie.concat(["path=/",`max-age=${ttl}`]);this._cookieMonster=fullCookie.join("; ");},delete(key){this.set(key,"kill",0);},};return __exports;});;

/* /web/static/src/legacy/js/core/minimal_dom.js */
odoo.define('@web/legacy/js/core/minimal_dom',[],function(require){'use strict';let __exports={};const DEBOUNCE=__exports.DEBOUNCE=400;const BUTTON_HANDLER_SELECTOR=__exports.BUTTON_HANDLER_SELECTOR='a, button, input[type="submit"], input[type="button"], .btn';__exports.makeAsyncHandler=makeAsyncHandler;function makeAsyncHandler(fct,preventDefault,stopPropagation){const stopImmediatePropagation=this&&this.__makeAsyncHandler_stopImmediatePropagation;let pending=false;function _isLocked(){return pending;}
function _lock(){pending=true;}
function _unlock(){pending=false;}
return function(ev){if(preventDefault===true||preventDefault&&preventDefault()){ev.preventDefault();}
if(stopPropagation===true||stopPropagation&&stopPropagation()){ev.stopPropagation();}
if(stopImmediatePropagation===true||stopImmediatePropagation&&stopImmediatePropagation()){ev.stopImmediatePropagation();}
if(_isLocked()){return;}
_lock();const result=fct.apply(this,arguments);Promise.resolve(result).finally(_unlock);return result;};}
__exports.makeButtonHandler=makeButtonHandler;function makeButtonHandler(fct){const preventDefault=this&&this.__makeButtonHandler_preventDefault;const stopPropagation=this&&this.__makeButtonHandler_stopPropagation;const stopImmediatePropagation=this&&this.__makeButtonHandler_stopImmediatePropagation;fct=makeAsyncHandler.call({'__makeAsyncHandler_stopImmediatePropagation':stopImmediatePropagation,},fct,preventDefault,stopPropagation);return function(ev){const result=fct.apply(this,arguments);const buttonEl=ev.target&&ev.target.closest&&ev.target.closest(BUTTON_HANDLER_SELECTOR);if(!(buttonEl instanceof HTMLElement)){return result;}
buttonEl.classList.add('pe-none');Promise.resolve(DEBOUNCE&&new Promise(r=>setTimeout(r,DEBOUNCE))).then(function(){buttonEl.classList.remove('pe-none');const restore=addButtonLoadingEffect(buttonEl);return Promise.resolve(result).finally(restore);});return result;};}
__exports.addButtonLoadingEffect=addButtonLoadingEffect;function addButtonLoadingEffect(btnEl){if(!(btnEl instanceof HTMLElement)){return()=>{};}
btnEl.classList.add('o_website_btn_loading','disabled','pe-none');btnEl.disabled=true;const loaderEl=document.createElement('span');loaderEl.classList.add('fa','fa-refresh','fa-spin','me-2');btnEl.prepend(loaderEl);return()=>{btnEl.classList.remove('o_website_btn_loading','disabled','pe-none');btnEl.disabled=false;loaderEl.remove();};}
return __exports;});;

/* /web/static/src/legacy/js/public/lazyloader.js */
odoo.define('@web/legacy/js/public/lazyloader',['@web/legacy/js/core/minimal_dom'],function(require){'use strict';let __exports={};const{BUTTON_HANDLER_SELECTOR,makeAsyncHandler,makeButtonHandler,}=require('@web/legacy/js/core/minimal_dom');let allScriptsLoadedResolve=null;const _allScriptsLoaded=new Promise(resolve=>{allScriptsLoadedResolve=resolve;}).then(stopWaitingLazy);const retriggeringWaitingProms=[];async function waitForLazyAndRetrigger(ev){const targetEl=ev.target;await _allScriptsLoaded;await Promise.all(retriggeringWaitingProms);setTimeout(()=>{if(targetEl.isConnected){targetEl.dispatchEvent(new ev.constructor(ev.type,ev));}},0);}
const loadingEffectHandlers=[];function registerLoadingEffectHandler(el,type,handler){el.addEventListener(type,handler,{capture:true});loadingEffectHandlers.push({el,type,handler});}
let waitingLazy=false;function waitLazy(){if(waitingLazy){return;}
waitingLazy=true;document.body.classList.add('o_lazy_js_waiting');const mainEl=document.getElementById('wrapwrap')||document.body;const loadingEffectButtonEls=[...mainEl.querySelectorAll(BUTTON_HANDLER_SELECTOR)].filter(el=>{return!el.classList.contains('o_no_wait_lazy_js')&&!(el.nodeName==='A'&&el.href&&el.getAttribute('href')!=='#');});const loadingEffectEventTypes=['mouseover','mouseenter','mousedown','mouseup','click','mouseout','mouseleave'];for(const buttonEl of loadingEffectButtonEls){for(const eventType of loadingEffectEventTypes){const loadingEffectHandler=eventType==='click'?makeButtonHandler.call({'__makeButtonHandler_preventDefault':true,'__makeButtonHandler_stopImmediatePropagation':true,},waitForLazyAndRetrigger):makeAsyncHandler.call({'__makeAsyncHandler_stopImmediatePropagation':true,},waitForLazyAndRetrigger,true);registerLoadingEffectHandler(buttonEl,eventType,loadingEffectHandler);}}
for(const formEl of document.querySelectorAll('form:not(.o_no_wait_lazy_js)')){registerLoadingEffectHandler(formEl,'submit',ev=>{ev.preventDefault();ev.stopImmediatePropagation();});}}
function stopWaitingLazy(){if(!waitingLazy){return;}
waitingLazy=false;document.body.classList.remove('o_lazy_js_waiting');for(const{el,type,handler}of loadingEffectHandlers){el.removeEventListener(type,handler,{capture:true});}}
if(document.readyState!=='loading'){waitLazy();}else{document.addEventListener('DOMContentLoaded',function(){waitLazy();});}
if(document.readyState==='complete'){setTimeout(_loadScripts,0);}else{window.addEventListener('load',function(){setTimeout(_loadScripts,0);});}
function _loadScripts(scripts,index){if(scripts===undefined){scripts=document.querySelectorAll('script[data-src]');}
if(index===undefined){index=0;}
if(index>=scripts.length){allScriptsLoadedResolve();return;}
const script=scripts[index];script.addEventListener('load',_loadScripts.bind(this,scripts,index+1));script.setAttribute('defer','defer');script.src=script.dataset.src;script.removeAttribute('data-src');}
__exports[Symbol.for("default")]={loadScripts:_loadScripts,allScriptsLoaded:_allScriptsLoaded,registerPageReadinessDelay:retriggeringWaitingProms.push.bind(retriggeringWaitingProms),};return __exports;});;

/* /web_editor/static/src/js/frontend/loader_loading.js */
(function(){'use strict';document.addEventListener('DOMContentLoaded',()=>{var textareaEls=document.querySelectorAll('textarea.o_wysiwyg_loader');for(var i=0;i<textareaEls.length;i++){var textarea=textareaEls[i];var wrapper=document.createElement('div');wrapper.classList.add('position-relative','o_wysiwyg_textarea_wrapper');var loadingElement=document.createElement('div');loadingElement.classList.add('o_wysiwyg_loading');var loadingIcon=document.createElement('i');loadingIcon.classList.add('text-600','text-center','fa','fa-circle-o-notch','fa-spin','fa-2x');loadingElement.appendChild(loadingIcon);wrapper.appendChild(loadingElement);textarea.parentNode.insertBefore(wrapper,textarea);wrapper.insertBefore(textarea,loadingElement);}});})();;

/* /website/static/src/js/content/inject_dom.js */
odoo.define('@website/js/content/inject_dom',['@web/core/browser/cookie','@web/session'],function(require){'use strict';let __exports={};const{cookie:cookieManager}=require("@web/core/browser/cookie");const{session}=require("@web/session");__exports.unhideConditionalElements=unhideConditionalElements;function unhideConditionalElements(){const styleEl=document.createElement('style');styleEl.id="conditional_visibility";document.head.appendChild(styleEl);const conditionalEls=document.querySelectorAll('[data-visibility="conditional"]');for(const conditionalEl of conditionalEls){const selectors=conditionalEl.dataset.visibilitySelectors;styleEl.sheet.insertRule(`${selectors} { display: none !important; }`);}
for(const conditionalEl of conditionalEls){conditionalEl.classList.remove('o_conditional_hidden');}}
__exports.setUtmsHtmlDataset=setUtmsHtmlDataset;function setUtmsHtmlDataset(){const htmlEl=document.documentElement;const cookieNamesToDataNames={'utm_source':'utmSource','utm_medium':'utmMedium','utm_campaign':'utmCampaign',};for(const[name,dsName]of Object.entries(cookieNamesToDataNames)){const cookie=cookieManager.get(`odoo_${name}`);if(cookie){htmlEl.dataset[dsName]=cookie.replace(/(^["']|["']$)/g,'');}}}
document.addEventListener('DOMContentLoaded',()=>{setUtmsHtmlDataset();const htmlEl=document.documentElement;const country=session.geoip_country_code;if(country){htmlEl.dataset.country=country;}
htmlEl.dataset.logged=!session.is_website_user;unhideConditionalElements();});return __exports;});;

/* /website/static/src/js/content/auto_hide_menu.js */
odoo.define('@website/js/content/auto_hide_menu',[],function(require){'use strict';let __exports={};const BREAKPOINT_SIZES={sm:'575',md:'767',lg:'991',xl:'1199',xxl:'1399'};async function autoHideMenu(el,options){if(!el){return;}
const navbar=el.closest('.navbar');const[breakpoint='md']=navbar?Object.keys(BREAKPOINT_SIZES).filter(suffix=>navbar.classList.contains(`navbar-expand-${suffix}`)):[];const isNoHamburgerMenu=!!navbar&&navbar.classList.contains('navbar-expand');const minSize=BREAKPOINT_SIZES[breakpoint];let isExtraMenuOpen=false;options=Object.assign({unfoldable:'none',images:[],loadingStyleClasses:[],autoClose:()=>true,},options||{});const isUserNavbar=el.parentElement.classList.contains('o_main_navbar');const dropdownSubMenuClasses=['show','border-0','position-static'];const dropdownToggleClasses=['h-auto','py-2','text-secondary'];const autoMarginLeftRegex=/\bm[sx]?(?:-(?:sm|md|lg|xl|xxl))?-auto\b/;const autoMarginRightRegex=/\bm[ex]?(?:-(?:sm|md|lg|xl|xxl))?-auto\b/;var extraItemsToggle=null;const afterFontsloading=new Promise((resolve)=>{if(document.fonts){document.fonts.ready.then(resolve);}else{setTimeout(resolve,150);}});afterFontsloading.then(_adapt);if(options.images.length){await _afterImagesLoading(options.images);_adapt();}
let pending=false;let refreshId=null;const onRefresh=()=>{if(pending){refreshId=window.requestAnimationFrame(onRefresh);_adapt();pending=false;}else{refreshId=null;}};const throttleAdapt=()=>{if(refreshId===null){refreshId=window.requestAnimationFrame(onRefresh);_adapt();}else{pending=true;}};window.addEventListener('resize',throttleAdapt);function _restore(){if(!extraItemsToggle){return;}
[...extraItemsToggle.querySelector('.dropdown-menu').children].forEach((item)=>{if(!isUserNavbar){item.classList.add('nav-item');const itemLink=item.querySelector('.dropdown-item');if(itemLink){itemLink.classList.remove('dropdown-item');itemLink.classList.add('nav-link');}}else{item.classList.remove('dropdown-item');const dropdownSubMenu=item.querySelector('.dropdown-menu');const dropdownSubMenuButton=item.querySelector('.dropdown-toggle');if(dropdownSubMenu){dropdownSubMenu.classList.remove(...dropdownSubMenuClasses);}
if(dropdownSubMenuButton){dropdownSubMenuButton.classList.remove(...dropdownToggleClasses);}}
el.insertBefore(item,extraItemsToggle);});extraItemsToggle.remove();extraItemsToggle=null;}
function _adapt(){const wysiwyg=window.$&&$('#wrapwrap').data('wysiwyg');const odooEditor=wysiwyg&&wysiwyg.odooEditor;if(odooEditor){odooEditor.observerUnactive("adapt");odooEditor.withoutRollback(__adapt);odooEditor.observerActive("adapt");return;}
__adapt();}
function __adapt(){if(options.loadingStyleClasses.length){el.classList.add(...options.loadingStyleClasses);}
const extraMenuEl=_getExtraMenuEl();isExtraMenuOpen=extraMenuEl&&extraMenuEl.classList.contains("show");_restore();if(!el.getClientRects().length||el.closest('.show')||(window.matchMedia(`(max-width: ${minSize}px)`).matches&&!isNoHamburgerMenu)){return _endAutoMoreMenu();}
let unfoldableItems=[];const items=[...el.children].filter((node)=>{if(node.matches&&!node.matches(options.unfoldable)){return true;}
unfoldableItems.push(node);return false;});var nbItems=items.length;var menuItemsWidth=items.reduce((sum,el)=>sum+computeFloatOuterWidthWithMargins(el,true,true,false),0);let maxWidth=0;if(!maxWidth){maxWidth=computeFloatOuterWidthWithMargins(el,true,true,true);var style=window.getComputedStyle(el);maxWidth-=(parseFloat(style.paddingLeft)+parseFloat(style.paddingRight)+parseFloat(style.borderLeftWidth)+parseFloat(style.borderRightWidth));maxWidth-=unfoldableItems.reduce((sum,el)=>sum+computeFloatOuterWidthWithMargins(el,true,true,false),0);}
if(maxWidth-menuItemsWidth>=-0.001){return _endAutoMoreMenu();}
const dropdownMenu=_addExtraItemsButton(items[nbItems-1].nextElementSibling);menuItemsWidth+=computeFloatOuterWidthWithMargins(extraItemsToggle,true,true,false);do{menuItemsWidth-=computeFloatOuterWidthWithMargins(items[--nbItems],true,true,false);}while(!(maxWidth-menuItemsWidth>=-0.001)&&(nbItems>0));const extraItems=items.slice(nbItems);extraItems.forEach((el)=>{if(!isUserNavbar){const navLink=el.querySelector('.nav-link, a');el.classList.remove('nav-item');if(navLink){navLink.classList.remove('nav-link');navLink.classList.add('dropdown-item');navLink.classList.toggle('active',el.classList.contains('active'));}}else{const dropdownSubMenu=el.querySelector('.dropdown-menu');const dropdownSubMenuButton=el.querySelector('.dropdown-toggle');el.classList.add('dropdown-item','p-0');if(dropdownSubMenu){dropdownSubMenu.classList.add(...dropdownSubMenuClasses);}
if(dropdownSubMenuButton){dropdownSubMenuButton.classList.add(...dropdownToggleClasses);}}
dropdownMenu.appendChild(el);});_endAutoMoreMenu();}
function computeFloatOuterWidthWithMargins(el,mLeft,mRight,considerAutoMargins){var rect=el.getBoundingClientRect();var style=window.getComputedStyle(el);var outerWidth=rect.right-rect.left;const isRTL=style.direction==='rtl';if(mLeft!==false&&(considerAutoMargins||!(isRTL?autoMarginRightRegex:autoMarginLeftRegex).test(el.getAttribute('class')))){outerWidth+=parseFloat(style.marginLeft);}
if(mRight!==false&&(considerAutoMargins||!(isRTL?autoMarginLeftRegex:autoMarginRightRegex).test(el.getAttribute('class')))){outerWidth+=parseFloat(style.marginRight);}
return isNaN(outerWidth)?0:outerWidth;}
function _addExtraItemsButton(target){let dropdownMenu=document.createElement('div');extraItemsToggle=dropdownMenu.cloneNode();const extraItemsToggleIcon=document.createElement('i');const extraItemsToggleLink=document.createElement('a');dropdownMenu.className='dropdown-menu';extraItemsToggle.className='nav-item dropdown o_extra_menu_items';extraItemsToggle.setAttribute("role","presentation");extraItemsToggleIcon.className='fa fa-plus';const extraItemsToggleAriaLabel=el.closest("[data-extra-items-toggle-aria-label]")?.dataset.extraItemsToggleAriaLabel;Object.entries({role:'menuitem',href:'#',class:'nav-link dropdown-toggle o-no-caret','data-bs-toggle':'dropdown','aria-expanded':false,'aria-label':extraItemsToggleAriaLabel||" ",}).forEach(([key,value])=>{extraItemsToggleLink.setAttribute(key,value);});extraItemsToggleLink.appendChild(extraItemsToggleIcon);extraItemsToggle.appendChild(extraItemsToggleLink);extraItemsToggle.appendChild(dropdownMenu);el.insertBefore(extraItemsToggle,target);if(!options.autoClose()){extraItemsToggleLink.setAttribute("data-bs-auto-close","outside");}
return dropdownMenu;}
function _afterImagesLoading(images){const defs=images.map((image)=>{if(image.complete||!image.getClientRects().length){return null;}
return new Promise(function(resolve,reject){if(!image.width){image.classList.add('o_menu_image_placeholder');}
image.addEventListener('load',()=>{image.classList.remove('o_menu_image_placeholder');resolve();});});});return Promise.all(defs);}
function _getExtraMenuEl(){return el.querySelector(".o_extra_menu_items .dropdown-toggle");}
function _endAutoMoreMenu(){const extraMenuEl=_getExtraMenuEl();if(extraMenuEl&&isExtraMenuOpen){extraMenuEl.click();}
el.classList.remove(...options.loadingStyleClasses);}}
document.addEventListener('DOMContentLoaded',async()=>{const header=document.querySelector('header#top');if(header){const topMenu=header.querySelector("#top_menu, .top_menu");if(header.classList.contains('o_no_autohide_menu')){topMenu.classList.remove('o_menu_loading');return;}
const unfoldable='.divider, .divider ~ li, .o_no_autohide_item, .js_language_selector';const excludedImagesSelector='.o_mega_menu, .o_offcanvas_logo_container, .o_lang_flag';const excludedImages=[...header.querySelectorAll(excludedImagesSelector)];const images=[...header.querySelectorAll('img')].filter((img)=>{excludedImages.forEach(node=>{if(node.contains(img)){return false;}});return img.matches&&!img.matches(excludedImagesSelector);});autoHideMenu(topMenu,{unfoldable:unfoldable,images:images,loadingStyleClasses:['o_menu_loading'],autoClose:()=>!document.body.classList.contains("editor_enable"),});}});return __exports;});;

/* /website/static/src/js/content/redirect.js */
odoo.define('@website/js/content/redirect',['@web/session'],function(require){'use strict';let __exports={};const{session}=require('@web/session');document.addEventListener('DOMContentLoaded',()=>{if(session.is_website_user){return;}
if(!window.frameElement){const frontendToBackendNavEl=document.querySelector('.o_frontend_to_backend_nav');if(frontendToBackendNavEl){frontendToBackendNavEl.classList.add('d-flex');frontendToBackendNavEl.classList.remove('d-none');}
const currentUrl=new URL(window.location.href);currentUrl.pathname=`/@${currentUrl.pathname}`;if(currentUrl.searchParams.get('enable_editor')||currentUrl.searchParams.get('edit_translations')){document.body.innerHTML='';window.location.replace(currentUrl.href);return;}
const backendEditBtnEl=document.querySelector('.o_frontend_to_backend_edit_btn');if(backendEditBtnEl){backendEditBtnEl.href=currentUrl.href;document.addEventListener("keydown",ev=>{if(ev.key==="a"&&ev.altKey){currentUrl.searchParams.set('enable_editor',1);window.location.replace(currentUrl.href);}},true);}}else{const backendUserDropdownLinkEl=document.getElementById('o_backend_user_dropdown_link');if(backendUserDropdownLinkEl){backendUserDropdownLinkEl.classList.add('d-none');backendUserDropdownLinkEl.classList.remove('d-flex');}
window.frameElement.dispatchEvent(new CustomEvent('OdooFrameContentLoaded'));}});return __exports;});;

/* /website/static/src/js/content/adapt_content.js */
odoo.define('@website/js/content/adapt_content',[],function(require){'use strict';let __exports={};document.addEventListener('DOMContentLoaded',()=>{const htmlEl=document.documentElement;const editTranslations=!!htmlEl.dataset.edit_translations;if(editTranslations){[...document.querySelectorAll('textarea')].map(textarea=>{if(textarea.value.indexOf('data-oe-translation-initial-sha')!==-1){textarea.classList.add('o_text_content_invisible');}});}
const searchModalEl=document.querySelector("header#top .modal#o_search_modal");if(searchModalEl){document.querySelector("#o_shared_blocks").appendChild(searchModalEl);}});return __exports;});;

/* /web/static/lib/popper/popper.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?factory(exports):typeof define==='function'&&define.amd?define(['exports'],factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,factory(global.Popper={}));}(this,(function(exports){'use strict';function getWindow(node){if(node==null){return window;}
if(node.toString()!=='[object Window]'){var ownerDocument=node.ownerDocument;return ownerDocument?ownerDocument.defaultView||window:window;}
return node;}
function isElement(node){var OwnElement=getWindow(node).Element;return node instanceof OwnElement||node instanceof Element;}
function isHTMLElement(node){var OwnElement=getWindow(node).HTMLElement;return node instanceof OwnElement||node instanceof HTMLElement;}
function isShadowRoot(node){if(typeof ShadowRoot==='undefined'){return false;}
var OwnElement=getWindow(node).ShadowRoot;return node instanceof OwnElement||node instanceof ShadowRoot;}
var max=Math.max;var min=Math.min;var round=Math.round;function getBoundingClientRect(element,includeScale){if(includeScale===void 0){includeScale=false;}
var rect=element.getBoundingClientRect();var scaleX=1;var scaleY=1;if(isHTMLElement(element)&&includeScale){var offsetHeight=element.offsetHeight;var offsetWidth=element.offsetWidth;if(offsetWidth>0){scaleX=round(rect.width)/offsetWidth||1;}
if(offsetHeight>0){scaleY=round(rect.height)/offsetHeight||1;}}
return{width:rect.width/scaleX,height:rect.height/scaleY,top:rect.top/scaleY,right:rect.right/scaleX,bottom:rect.bottom/scaleY,left:rect.left/scaleX,x:rect.left/scaleX,y:rect.top/scaleY};}
function getWindowScroll(node){var win=getWindow(node);var scrollLeft=win.pageXOffset;var scrollTop=win.pageYOffset;return{scrollLeft:scrollLeft,scrollTop:scrollTop};}
function getHTMLElementScroll(element){return{scrollLeft:element.scrollLeft,scrollTop:element.scrollTop};}
function getNodeScroll(node){if(node===getWindow(node)||!isHTMLElement(node)){return getWindowScroll(node);}else{return getHTMLElementScroll(node);}}
function getNodeName(element){return element?(element.nodeName||'').toLowerCase():null;}
function getDocumentElement(element){return((isElement(element)?element.ownerDocument:element.document)||window.document).documentElement;}
function getWindowScrollBarX(element){return getBoundingClientRect(getDocumentElement(element)).left+getWindowScroll(element).scrollLeft;}
function getComputedStyle(element){return getWindow(element).getComputedStyle(element);}
function isScrollParent(element){var _getComputedStyle=getComputedStyle(element),overflow=_getComputedStyle.overflow,overflowX=_getComputedStyle.overflowX,overflowY=_getComputedStyle.overflowY;return/auto|scroll|overlay|hidden/.test(overflow+overflowY+overflowX);}
function isElementScaled(element){var rect=element.getBoundingClientRect();var scaleX=round(rect.width)/element.offsetWidth||1;var scaleY=round(rect.height)/element.offsetHeight||1;return scaleX!==1||scaleY!==1;}
function getCompositeRect(elementOrVirtualElement,offsetParent,isFixed){if(isFixed===void 0){isFixed=false;}
var isOffsetParentAnElement=isHTMLElement(offsetParent);var offsetParentIsScaled=isHTMLElement(offsetParent)&&isElementScaled(offsetParent);var documentElement=getDocumentElement(offsetParent);var rect=getBoundingClientRect(elementOrVirtualElement,offsetParentIsScaled);var scroll={scrollLeft:0,scrollTop:0};var offsets={x:0,y:0};if(isOffsetParentAnElement||!isOffsetParentAnElement&&!isFixed){if(getNodeName(offsetParent)!=='body'||isScrollParent(documentElement)){scroll=getNodeScroll(offsetParent);}
if(isHTMLElement(offsetParent)){offsets=getBoundingClientRect(offsetParent,true);offsets.x+=offsetParent.clientLeft;offsets.y+=offsetParent.clientTop;}else if(documentElement){offsets.x=getWindowScrollBarX(documentElement);}}
return{x:rect.left+scroll.scrollLeft-offsets.x,y:rect.top+scroll.scrollTop-offsets.y,width:rect.width,height:rect.height};}
function getLayoutRect(element){var clientRect=getBoundingClientRect(element);var width=element.offsetWidth;var height=element.offsetHeight;if(Math.abs(clientRect.width-width)<=1){width=clientRect.width;}
if(Math.abs(clientRect.height-height)<=1){height=clientRect.height;}
return{x:element.offsetLeft,y:element.offsetTop,width:width,height:height};}
function getParentNode(element){if(getNodeName(element)==='html'){return element;}
return(element.assignedSlot||element.parentNode||(isShadowRoot(element)?element.host:null)||getDocumentElement(element));}
function getScrollParent(node){if(['html','body','#document'].indexOf(getNodeName(node))>=0){return node.ownerDocument.body;}
if(isHTMLElement(node)&&isScrollParent(node)){return node;}
return getScrollParent(getParentNode(node));}
function listScrollParents(element,list){var _element$ownerDocumen;if(list===void 0){list=[];}
var scrollParent=getScrollParent(element);var isBody=scrollParent===((_element$ownerDocumen=element.ownerDocument)==null?void 0:_element$ownerDocumen.body);var win=getWindow(scrollParent);var target=isBody?[win].concat(win.visualViewport||[],isScrollParent(scrollParent)?scrollParent:[]):scrollParent;var updatedList=list.concat(target);return isBody?updatedList:updatedList.concat(listScrollParents(getParentNode(target)));}
function isTableElement(element){return['table','td','th'].indexOf(getNodeName(element))>=0;}
function getTrueOffsetParent(element){if(!isHTMLElement(element)||getComputedStyle(element).position==='fixed'){return null;}
return element.offsetParent;}
function getContainingBlock(element){var isFirefox=navigator.userAgent.toLowerCase().indexOf('firefox')!==-1;var isIE=navigator.userAgent.indexOf('Trident')!==-1;if(isIE&&isHTMLElement(element)){var elementCss=getComputedStyle(element);if(elementCss.position==='fixed'){return null;}}
var currentNode=getParentNode(element);while(isHTMLElement(currentNode)&&['html','body'].indexOf(getNodeName(currentNode))<0){var css=getComputedStyle(currentNode);if(css.transform!=='none'||css.perspective!=='none'||css.contain==='paint'||['transform','perspective'].indexOf(css.willChange)!==-1||isFirefox&&css.willChange==='filter'||isFirefox&&css.filter&&css.filter!=='none'){return currentNode;}else{currentNode=currentNode.parentNode;}}
return null;}
function getOffsetParent(element){var window=getWindow(element);var offsetParent=getTrueOffsetParent(element);while(offsetParent&&isTableElement(offsetParent)&&getComputedStyle(offsetParent).position==='static'){offsetParent=getTrueOffsetParent(offsetParent);}
if(offsetParent&&(getNodeName(offsetParent)==='html'||getNodeName(offsetParent)==='body'&&getComputedStyle(offsetParent).position==='static')){return window;}
return offsetParent||getContainingBlock(element)||window;}
var top='top';var bottom='bottom';var right='right';var left='left';var auto='auto';var basePlacements=[top,bottom,right,left];var start='start';var end='end';var clippingParents='clippingParents';var viewport='viewport';var popper='popper';var reference='reference';var variationPlacements=basePlacements.reduce(function(acc,placement){return acc.concat([placement+"-"+start,placement+"-"+end]);},[]);var placements=[].concat(basePlacements,[auto]).reduce(function(acc,placement){return acc.concat([placement,placement+"-"+start,placement+"-"+end]);},[]);var beforeRead='beforeRead';var read='read';var afterRead='afterRead';var beforeMain='beforeMain';var main='main';var afterMain='afterMain';var beforeWrite='beforeWrite';var write='write';var afterWrite='afterWrite';var modifierPhases=[beforeRead,read,afterRead,beforeMain,main,afterMain,beforeWrite,write,afterWrite];function order(modifiers){var map=new Map();var visited=new Set();var result=[];modifiers.forEach(function(modifier){map.set(modifier.name,modifier);});function sort(modifier){visited.add(modifier.name);var requires=[].concat(modifier.requires||[],modifier.requiresIfExists||[]);requires.forEach(function(dep){if(!visited.has(dep)){var depModifier=map.get(dep);if(depModifier){sort(depModifier);}}});result.push(modifier);}
modifiers.forEach(function(modifier){if(!visited.has(modifier.name)){sort(modifier);}});return result;}
function orderModifiers(modifiers){var orderedModifiers=order(modifiers);return modifierPhases.reduce(function(acc,phase){return acc.concat(orderedModifiers.filter(function(modifier){return modifier.phase===phase;}));},[]);}
function debounce(fn){var pending;return function(){if(!pending){pending=new Promise(function(resolve){Promise.resolve().then(function(){pending=undefined;resolve(fn());});});}
return pending;};}
function format(str){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
return[].concat(args).reduce(function(p,c){return p.replace(/%s/,c);},str);}
var INVALID_MODIFIER_ERROR='Popper: modifier "%s" provided an invalid %s property, expected %s but got %s';var MISSING_DEPENDENCY_ERROR='Popper: modifier "%s" requires "%s", but "%s" modifier is not available';var VALID_PROPERTIES=['name','enabled','phase','fn','effect','requires','options'];function validateModifiers(modifiers){modifiers.forEach(function(modifier){[].concat(Object.keys(modifier),VALID_PROPERTIES).filter(function(value,index,self){return self.indexOf(value)===index;}).forEach(function(key){switch(key){case'name':if(typeof modifier.name!=='string'){console.error(format(INVALID_MODIFIER_ERROR,String(modifier.name),'"name"','"string"',"\""+String(modifier.name)+"\""));}
break;case'enabled':if(typeof modifier.enabled!=='boolean'){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"enabled"','"boolean"',"\""+String(modifier.enabled)+"\""));}
break;case'phase':if(modifierPhases.indexOf(modifier.phase)<0){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"phase"',"either "+modifierPhases.join(', '),"\""+String(modifier.phase)+"\""));}
break;case'fn':if(typeof modifier.fn!=='function'){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"fn"','"function"',"\""+String(modifier.fn)+"\""));}
break;case'effect':if(modifier.effect!=null&&typeof modifier.effect!=='function'){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"effect"','"function"',"\""+String(modifier.fn)+"\""));}
break;case'requires':if(modifier.requires!=null&&!Array.isArray(modifier.requires)){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"requires"','"array"',"\""+String(modifier.requires)+"\""));}
break;case'requiresIfExists':if(!Array.isArray(modifier.requiresIfExists)){console.error(format(INVALID_MODIFIER_ERROR,modifier.name,'"requiresIfExists"','"array"',"\""+String(modifier.requiresIfExists)+"\""));}
break;case'options':case'data':break;default:console.error("PopperJS: an invalid property has been provided to the \""+modifier.name+"\" modifier, valid properties are "+VALID_PROPERTIES.map(function(s){return"\""+s+"\"";}).join(', ')+"; but \""+key+"\" was provided.");}
modifier.requires&&modifier.requires.forEach(function(requirement){if(modifiers.find(function(mod){return mod.name===requirement;})==null){console.error(format(MISSING_DEPENDENCY_ERROR,String(modifier.name),requirement,requirement));}});});});}
function uniqueBy(arr,fn){var identifiers=new Set();return arr.filter(function(item){var identifier=fn(item);if(!identifiers.has(identifier)){identifiers.add(identifier);return true;}});}
function getBasePlacement(placement){return placement.split('-')[0];}
function mergeByName(modifiers){var merged=modifiers.reduce(function(merged,current){var existing=merged[current.name];merged[current.name]=existing?Object.assign({},existing,current,{options:Object.assign({},existing.options,current.options),data:Object.assign({},existing.data,current.data)}):current;return merged;},{});return Object.keys(merged).map(function(key){return merged[key];});}
function getViewportRect(element){var win=getWindow(element);var html=getDocumentElement(element);var visualViewport=win.visualViewport;var width=html.clientWidth;var height=html.clientHeight;var x=0;var y=0;if(visualViewport){width=visualViewport.width;height=visualViewport.height;if(!/^((?!chrome|android).)*safari/i.test(navigator.userAgent)){x=visualViewport.offsetLeft;y=visualViewport.offsetTop;}}
return{width:width,height:height,x:x+getWindowScrollBarX(element),y:y};}
function getDocumentRect(element){var _element$ownerDocumen;var html=getDocumentElement(element);var winScroll=getWindowScroll(element);var body=(_element$ownerDocumen=element.ownerDocument)==null?void 0:_element$ownerDocumen.body;var width=max(html.scrollWidth,html.clientWidth,body?body.scrollWidth:0,body?body.clientWidth:0);var height=max(html.scrollHeight,html.clientHeight,body?body.scrollHeight:0,body?body.clientHeight:0);var x=-winScroll.scrollLeft+getWindowScrollBarX(element);var y=-winScroll.scrollTop;if(getComputedStyle(body||html).direction==='rtl'){x+=max(html.clientWidth,body?body.clientWidth:0)-width;}
return{width:width,height:height,x:x,y:y};}
function contains(parent,child){var rootNode=child.getRootNode&&child.getRootNode();if(parent.contains(child)){return true;}
else if(rootNode&&isShadowRoot(rootNode)){var next=child;do{if(next&&parent.isSameNode(next)){return true;}
next=next.parentNode||next.host;}while(next);}
return false;}
function rectToClientRect(rect){return Object.assign({},rect,{left:rect.x,top:rect.y,right:rect.x+rect.width,bottom:rect.y+rect.height});}
function getInnerBoundingClientRect(element){var rect=getBoundingClientRect(element);rect.top=rect.top+element.clientTop;rect.left=rect.left+element.clientLeft;rect.bottom=rect.top+element.clientHeight;rect.right=rect.left+element.clientWidth;rect.width=element.clientWidth;rect.height=element.clientHeight;rect.x=rect.left;rect.y=rect.top;return rect;}
function getClientRectFromMixedType(element,clippingParent){return clippingParent===viewport?rectToClientRect(getViewportRect(element)):isElement(clippingParent)?getInnerBoundingClientRect(clippingParent):rectToClientRect(getDocumentRect(getDocumentElement(element)));}
function getClippingParents(element){var clippingParents=listScrollParents(getParentNode(element));var canEscapeClipping=['absolute','fixed'].indexOf(getComputedStyle(element).position)>=0;var clipperElement=canEscapeClipping&&isHTMLElement(element)?getOffsetParent(element):element;if(!isElement(clipperElement)){return[];}
return clippingParents.filter(function(clippingParent){return isElement(clippingParent)&&contains(clippingParent,clipperElement)&&getNodeName(clippingParent)!=='body';});}
function getClippingRect(element,boundary,rootBoundary){var mainClippingParents=boundary==='clippingParents'?getClippingParents(element):[].concat(boundary);var clippingParents=[].concat(mainClippingParents,[rootBoundary]);var firstClippingParent=clippingParents[0];var clippingRect=clippingParents.reduce(function(accRect,clippingParent){var rect=getClientRectFromMixedType(element,clippingParent);accRect.top=max(rect.top,accRect.top);accRect.right=min(rect.right,accRect.right);accRect.bottom=min(rect.bottom,accRect.bottom);accRect.left=max(rect.left,accRect.left);return accRect;},getClientRectFromMixedType(element,firstClippingParent));clippingRect.width=clippingRect.right-clippingRect.left;clippingRect.height=clippingRect.bottom-clippingRect.top;clippingRect.x=clippingRect.left;clippingRect.y=clippingRect.top;return clippingRect;}
function getVariation(placement){return placement.split('-')[1];}
function getMainAxisFromPlacement(placement){return['top','bottom'].indexOf(placement)>=0?'x':'y';}
function computeOffsets(_ref){var reference=_ref.reference,element=_ref.element,placement=_ref.placement;var basePlacement=placement?getBasePlacement(placement):null;var variation=placement?getVariation(placement):null;var commonX=reference.x+reference.width/2-element.width/2;var commonY=reference.y+reference.height/2-element.height/2;var offsets;switch(basePlacement){case top:offsets={x:commonX,y:reference.y-element.height};break;case bottom:offsets={x:commonX,y:reference.y+reference.height};break;case right:offsets={x:reference.x+reference.width,y:commonY};break;case left:offsets={x:reference.x-element.width,y:commonY};break;default:offsets={x:reference.x,y:reference.y};}
var mainAxis=basePlacement?getMainAxisFromPlacement(basePlacement):null;if(mainAxis!=null){var len=mainAxis==='y'?'height':'width';switch(variation){case start:offsets[mainAxis]=offsets[mainAxis]-(reference[len]/2-element[len]/2);break;case end:offsets[mainAxis]=offsets[mainAxis]+(reference[len]/2-element[len]/2);break;}}
return offsets;}
function getFreshSideObject(){return{top:0,right:0,bottom:0,left:0};}
function mergePaddingObject(paddingObject){return Object.assign({},getFreshSideObject(),paddingObject);}
function expandToHashMap(value,keys){return keys.reduce(function(hashMap,key){hashMap[key]=value;return hashMap;},{});}
function detectOverflow(state,options){if(options===void 0){options={};}
var _options=options,_options$placement=_options.placement,placement=_options$placement===void 0?state.placement:_options$placement,_options$boundary=_options.boundary,boundary=_options$boundary===void 0?clippingParents:_options$boundary,_options$rootBoundary=_options.rootBoundary,rootBoundary=_options$rootBoundary===void 0?viewport:_options$rootBoundary,_options$elementConte=_options.elementContext,elementContext=_options$elementConte===void 0?popper:_options$elementConte,_options$altBoundary=_options.altBoundary,altBoundary=_options$altBoundary===void 0?false:_options$altBoundary,_options$padding=_options.padding,padding=_options$padding===void 0?0:_options$padding;var paddingObject=mergePaddingObject(typeof padding!=='number'?padding:expandToHashMap(padding,basePlacements));var altContext=elementContext===popper?reference:popper;var popperRect=state.rects.popper;var element=state.elements[altBoundary?altContext:elementContext];var clippingClientRect=getClippingRect(isElement(element)?element:element.contextElement||getDocumentElement(state.elements.popper),boundary,rootBoundary);var referenceClientRect=getBoundingClientRect(state.elements.reference);var popperOffsets=computeOffsets({reference:referenceClientRect,element:popperRect,strategy:'absolute',placement:placement});var popperClientRect=rectToClientRect(Object.assign({},popperRect,popperOffsets));var elementClientRect=elementContext===popper?popperClientRect:referenceClientRect;var overflowOffsets={top:clippingClientRect.top-elementClientRect.top+paddingObject.top,bottom:elementClientRect.bottom-clippingClientRect.bottom+paddingObject.bottom,left:clippingClientRect.left-elementClientRect.left+paddingObject.left,right:elementClientRect.right-clippingClientRect.right+paddingObject.right};var offsetData=state.modifiersData.offset;if(elementContext===popper&&offsetData){var offset=offsetData[placement];Object.keys(overflowOffsets).forEach(function(key){var multiply=[right,bottom].indexOf(key)>=0?1:-1;var axis=[top,bottom].indexOf(key)>=0?'y':'x';overflowOffsets[key]+=offset[axis]*multiply;});}
return overflowOffsets;}
var INVALID_ELEMENT_ERROR='Popper: Invalid reference or popper argument provided. They must be either a DOM element or virtual element.';var INFINITE_LOOP_ERROR='Popper: An infinite loop in the modifiers cycle has been detected! The cycle has been interrupted to prevent a browser crash.';var DEFAULT_OPTIONS={placement:'bottom',modifiers:[],strategy:'absolute'};function areValidElements(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
return!args.some(function(element){return!(element&&typeof element.getBoundingClientRect==='function');});}
function popperGenerator(generatorOptions){if(generatorOptions===void 0){generatorOptions={};}
var _generatorOptions=generatorOptions,_generatorOptions$def=_generatorOptions.defaultModifiers,defaultModifiers=_generatorOptions$def===void 0?[]:_generatorOptions$def,_generatorOptions$def2=_generatorOptions.defaultOptions,defaultOptions=_generatorOptions$def2===void 0?DEFAULT_OPTIONS:_generatorOptions$def2;return function createPopper(reference,popper,options){if(options===void 0){options=defaultOptions;}
var state={placement:'bottom',orderedModifiers:[],options:Object.assign({},DEFAULT_OPTIONS,defaultOptions),modifiersData:{},elements:{reference:reference,popper:popper},attributes:{},styles:{}};var effectCleanupFns=[];var isDestroyed=false;var instance={state:state,setOptions:function setOptions(setOptionsAction){var options=typeof setOptionsAction==='function'?setOptionsAction(state.options):setOptionsAction;cleanupModifierEffects();state.options=Object.assign({},defaultOptions,state.options,options);state.scrollParents={reference:isElement(reference)?listScrollParents(reference):reference.contextElement?listScrollParents(reference.contextElement):[],popper:listScrollParents(popper)};var orderedModifiers=orderModifiers(mergeByName([].concat(defaultModifiers,state.options.modifiers)));state.orderedModifiers=orderedModifiers.filter(function(m){return m.enabled;});{var modifiers=uniqueBy([].concat(orderedModifiers,state.options.modifiers),function(_ref){var name=_ref.name;return name;});validateModifiers(modifiers);if(getBasePlacement(state.options.placement)===auto){var flipModifier=state.orderedModifiers.find(function(_ref2){var name=_ref2.name;return name==='flip';});if(!flipModifier){console.error(['Popper: "auto" placements require the "flip" modifier be','present and enabled to work.'].join(' '));}}
var _getComputedStyle=getComputedStyle(popper),marginTop=_getComputedStyle.marginTop,marginRight=_getComputedStyle.marginRight,marginBottom=_getComputedStyle.marginBottom,marginLeft=_getComputedStyle.marginLeft;if([marginTop,marginRight,marginBottom,marginLeft].some(function(margin){return parseFloat(margin);})){console.warn(['Popper: CSS "margin" styles cannot be used to apply padding','between the popper and its reference element or boundary.','To replicate margin, use the `offset` modifier, as well as','the `padding` option in the `preventOverflow` and `flip`','modifiers.'].join(' '));}}
runModifierEffects();return instance.update();},forceUpdate:function forceUpdate(){if(isDestroyed){return;}
var _state$elements=state.elements,reference=_state$elements.reference,popper=_state$elements.popper;if(!areValidElements(reference,popper)){{console.error(INVALID_ELEMENT_ERROR);}
return;}
state.rects={reference:getCompositeRect(reference,getOffsetParent(popper),state.options.strategy==='fixed'),popper:getLayoutRect(popper)};state.reset=false;state.placement=state.options.placement;state.orderedModifiers.forEach(function(modifier){return state.modifiersData[modifier.name]=Object.assign({},modifier.data);});var __debug_loops__=0;for(var index=0;index<state.orderedModifiers.length;index++){{__debug_loops__+=1;if(__debug_loops__>100){console.error(INFINITE_LOOP_ERROR);break;}}
if(state.reset===true){state.reset=false;index=-1;continue;}
var _state$orderedModifie=state.orderedModifiers[index],fn=_state$orderedModifie.fn,_state$orderedModifie2=_state$orderedModifie.options,_options=_state$orderedModifie2===void 0?{}:_state$orderedModifie2,name=_state$orderedModifie.name;if(typeof fn==='function'){state=fn({state:state,options:_options,name:name,instance:instance})||state;}}},update:debounce(function(){return new Promise(function(resolve){instance.forceUpdate();resolve(state);});}),destroy:function destroy(){cleanupModifierEffects();isDestroyed=true;}};if(!areValidElements(reference,popper)){{console.error(INVALID_ELEMENT_ERROR);}
return instance;}
instance.setOptions(options).then(function(state){if(!isDestroyed&&options.onFirstUpdate){options.onFirstUpdate(state);}});function runModifierEffects(){state.orderedModifiers.forEach(function(_ref3){var name=_ref3.name,_ref3$options=_ref3.options,options=_ref3$options===void 0?{}:_ref3$options,effect=_ref3.effect;if(typeof effect==='function'){var cleanupFn=effect({state:state,name:name,instance:instance,options:options});var noopFn=function noopFn(){};effectCleanupFns.push(cleanupFn||noopFn);}});}
function cleanupModifierEffects(){effectCleanupFns.forEach(function(fn){return fn();});effectCleanupFns=[];}
return instance;};}
var passive={passive:true};function effect$2(_ref){var state=_ref.state,instance=_ref.instance,options=_ref.options;var _options$scroll=options.scroll,scroll=_options$scroll===void 0?true:_options$scroll,_options$resize=options.resize,resize=_options$resize===void 0?true:_options$resize;var window=getWindow(state.elements.popper);var scrollParents=[].concat(state.scrollParents.reference,state.scrollParents.popper);if(scroll){scrollParents.forEach(function(scrollParent){scrollParent.addEventListener('scroll',instance.update,passive);});}
if(resize){window.addEventListener('resize',instance.update,passive);}
return function(){if(scroll){scrollParents.forEach(function(scrollParent){scrollParent.removeEventListener('scroll',instance.update,passive);});}
if(resize){window.removeEventListener('resize',instance.update,passive);}};}
var eventListeners={name:'eventListeners',enabled:true,phase:'write',fn:function fn(){},effect:effect$2,data:{}};function popperOffsets(_ref){var state=_ref.state,name=_ref.name;state.modifiersData[name]=computeOffsets({reference:state.rects.reference,element:state.rects.popper,strategy:'absolute',placement:state.placement});}
var popperOffsets$1={name:'popperOffsets',enabled:true,phase:'read',fn:popperOffsets,data:{}};var unsetSides={top:'auto',right:'auto',bottom:'auto',left:'auto'};function roundOffsetsByDPR(_ref){var x=_ref.x,y=_ref.y;var win=window;var dpr=win.devicePixelRatio||1;return{x:round(x*dpr)/dpr||0,y:round(y*dpr)/dpr||0};}
function mapToStyles(_ref2){var _Object$assign2;var popper=_ref2.popper,popperRect=_ref2.popperRect,placement=_ref2.placement,variation=_ref2.variation,offsets=_ref2.offsets,position=_ref2.position,gpuAcceleration=_ref2.gpuAcceleration,adaptive=_ref2.adaptive,roundOffsets=_ref2.roundOffsets,isFixed=_ref2.isFixed;var _offsets$x=offsets.x,x=_offsets$x===void 0?0:_offsets$x,_offsets$y=offsets.y,y=_offsets$y===void 0?0:_offsets$y;var _ref3=typeof roundOffsets==='function'?roundOffsets({x:x,y:y}):{x:x,y:y};x=_ref3.x;y=_ref3.y;var hasX=offsets.hasOwnProperty('x');var hasY=offsets.hasOwnProperty('y');var sideX=left;var sideY=top;var win=window;if(adaptive){var offsetParent=getOffsetParent(popper);var heightProp='clientHeight';var widthProp='clientWidth';if(offsetParent===getWindow(popper)){offsetParent=getDocumentElement(popper);if(getComputedStyle(offsetParent).position!=='static'&&position==='absolute'){heightProp='scrollHeight';widthProp='scrollWidth';}}
offsetParent=offsetParent;if(placement===top||(placement===left||placement===right)&&variation===end){sideY=bottom;var offsetY=isFixed&&win.visualViewport?win.visualViewport.height:offsetParent[heightProp];y-=offsetY-popperRect.height;y*=gpuAcceleration?1:-1;}
if(placement===left||(placement===top||placement===bottom)&&variation===end){sideX=right;var offsetX=isFixed&&win.visualViewport?win.visualViewport.width:offsetParent[widthProp];x-=offsetX-popperRect.width;x*=gpuAcceleration?1:-1;}}
var commonStyles=Object.assign({position:position},adaptive&&unsetSides);var _ref4=roundOffsets===true?roundOffsetsByDPR({x:x,y:y}):{x:x,y:y};x=_ref4.x;y=_ref4.y;if(gpuAcceleration){var _Object$assign;return Object.assign({},commonStyles,(_Object$assign={},_Object$assign[sideY]=hasY?'0':'',_Object$assign[sideX]=hasX?'0':'',_Object$assign.transform=(win.devicePixelRatio||1)<=1?"translate("+x+"px, "+y+"px)":"translate3d("+x+"px, "+y+"px, 0)",_Object$assign));}
return Object.assign({},commonStyles,(_Object$assign2={},_Object$assign2[sideY]=hasY?y+"px":'',_Object$assign2[sideX]=hasX?x+"px":'',_Object$assign2.transform='',_Object$assign2));}
function computeStyles(_ref5){var state=_ref5.state,options=_ref5.options;var _options$gpuAccelerat=options.gpuAcceleration,gpuAcceleration=_options$gpuAccelerat===void 0?true:_options$gpuAccelerat,_options$adaptive=options.adaptive,adaptive=_options$adaptive===void 0?true:_options$adaptive,_options$roundOffsets=options.roundOffsets,roundOffsets=_options$roundOffsets===void 0?true:_options$roundOffsets;{var transitionProperty=getComputedStyle(state.elements.popper).transitionProperty||'';if(adaptive&&['transform','top','right','bottom','left'].some(function(property){return transitionProperty.indexOf(property)>=0;})){console.warn(['Popper: Detected CSS transitions on at least one of the following','CSS properties: "transform", "top", "right", "bottom", "left".','\n\n','Disable the "computeStyles" modifier\'s `adaptive` option to allow','for smooth transitions, or remove these properties from the CSS','transition declaration on the popper element if only transitioning','opacity or background-color for example.','\n\n','We recommend using the popper element as a wrapper around an inner','element that can have any CSS property transitioned for animations.'].join(' '));}}
var commonStyles={placement:getBasePlacement(state.placement),variation:getVariation(state.placement),popper:state.elements.popper,popperRect:state.rects.popper,gpuAcceleration:gpuAcceleration,isFixed:state.options.strategy==='fixed'};if(state.modifiersData.popperOffsets!=null){state.styles.popper=Object.assign({},state.styles.popper,mapToStyles(Object.assign({},commonStyles,{offsets:state.modifiersData.popperOffsets,position:state.options.strategy,adaptive:adaptive,roundOffsets:roundOffsets})));}
if(state.modifiersData.arrow!=null){state.styles.arrow=Object.assign({},state.styles.arrow,mapToStyles(Object.assign({},commonStyles,{offsets:state.modifiersData.arrow,position:'absolute',adaptive:false,roundOffsets:roundOffsets})));}
state.attributes.popper=Object.assign({},state.attributes.popper,{'data-popper-placement':state.placement});}
var computeStyles$1={name:'computeStyles',enabled:true,phase:'beforeWrite',fn:computeStyles,data:{}};function applyStyles(_ref){var state=_ref.state;Object.keys(state.elements).forEach(function(name){var style=state.styles[name]||{};var attributes=state.attributes[name]||{};var element=state.elements[name];if(!isHTMLElement(element)||!getNodeName(element)){return;}
Object.assign(element.style,style);Object.keys(attributes).forEach(function(name){var value=attributes[name];if(value===false){element.removeAttribute(name);}else{element.setAttribute(name,value===true?'':value);}});});}
function effect$1(_ref2){var state=_ref2.state;var initialStyles={popper:{position:state.options.strategy,left:'0',top:'0',margin:'0'},arrow:{position:'absolute'},reference:{}};Object.assign(state.elements.popper.style,initialStyles.popper);state.styles=initialStyles;if(state.elements.arrow){Object.assign(state.elements.arrow.style,initialStyles.arrow);}
return function(){Object.keys(state.elements).forEach(function(name){var element=state.elements[name];var attributes=state.attributes[name]||{};var styleProperties=Object.keys(state.styles.hasOwnProperty(name)?state.styles[name]:initialStyles[name]);var style=styleProperties.reduce(function(style,property){style[property]='';return style;},{});if(!isHTMLElement(element)||!getNodeName(element)){return;}
Object.assign(element.style,style);Object.keys(attributes).forEach(function(attribute){element.removeAttribute(attribute);});});};}
var applyStyles$1={name:'applyStyles',enabled:true,phase:'write',fn:applyStyles,effect:effect$1,requires:['computeStyles']};function distanceAndSkiddingToXY(placement,rects,offset){var basePlacement=getBasePlacement(placement);var invertDistance=[left,top].indexOf(basePlacement)>=0?-1:1;var _ref=typeof offset==='function'?offset(Object.assign({},rects,{placement:placement})):offset,skidding=_ref[0],distance=_ref[1];skidding=skidding||0;distance=(distance||0)*invertDistance;return[left,right].indexOf(basePlacement)>=0?{x:distance,y:skidding}:{x:skidding,y:distance};}
function offset(_ref2){var state=_ref2.state,options=_ref2.options,name=_ref2.name;var _options$offset=options.offset,offset=_options$offset===void 0?[0,0]:_options$offset;var data=placements.reduce(function(acc,placement){acc[placement]=distanceAndSkiddingToXY(placement,state.rects,offset);return acc;},{});var _data$state$placement=data[state.placement],x=_data$state$placement.x,y=_data$state$placement.y;if(state.modifiersData.popperOffsets!=null){state.modifiersData.popperOffsets.x+=x;state.modifiersData.popperOffsets.y+=y;}
state.modifiersData[name]=data;}
var offset$1={name:'offset',enabled:true,phase:'main',requires:['popperOffsets'],fn:offset};var hash$1={left:'right',right:'left',bottom:'top',top:'bottom'};function getOppositePlacement(placement){return placement.replace(/left|right|bottom|top/g,function(matched){return hash$1[matched];});}
var hash={start:'end',end:'start'};function getOppositeVariationPlacement(placement){return placement.replace(/start|end/g,function(matched){return hash[matched];});}
function computeAutoPlacement(state,options){if(options===void 0){options={};}
var _options=options,placement=_options.placement,boundary=_options.boundary,rootBoundary=_options.rootBoundary,padding=_options.padding,flipVariations=_options.flipVariations,_options$allowedAutoP=_options.allowedAutoPlacements,allowedAutoPlacements=_options$allowedAutoP===void 0?placements:_options$allowedAutoP;var variation=getVariation(placement);var placements$1=variation?flipVariations?variationPlacements:variationPlacements.filter(function(placement){return getVariation(placement)===variation;}):basePlacements;var allowedPlacements=placements$1.filter(function(placement){return allowedAutoPlacements.indexOf(placement)>=0;});if(allowedPlacements.length===0){allowedPlacements=placements$1;{console.error(['Popper: The `allowedAutoPlacements` option did not allow any','placements. Ensure the `placement` option matches the variation','of the allowed placements.','For example, "auto" cannot be used to allow "bottom-start".','Use "auto-start" instead.'].join(' '));}}
var overflows=allowedPlacements.reduce(function(acc,placement){acc[placement]=detectOverflow(state,{placement:placement,boundary:boundary,rootBoundary:rootBoundary,padding:padding})[getBasePlacement(placement)];return acc;},{});return Object.keys(overflows).sort(function(a,b){return overflows[a]-overflows[b];});}
function getExpandedFallbackPlacements(placement){if(getBasePlacement(placement)===auto){return[];}
var oppositePlacement=getOppositePlacement(placement);return[getOppositeVariationPlacement(placement),oppositePlacement,getOppositeVariationPlacement(oppositePlacement)];}
function flip(_ref){var state=_ref.state,options=_ref.options,name=_ref.name;if(state.modifiersData[name]._skip){return;}
var _options$mainAxis=options.mainAxis,checkMainAxis=_options$mainAxis===void 0?true:_options$mainAxis,_options$altAxis=options.altAxis,checkAltAxis=_options$altAxis===void 0?true:_options$altAxis,specifiedFallbackPlacements=options.fallbackPlacements,padding=options.padding,boundary=options.boundary,rootBoundary=options.rootBoundary,altBoundary=options.altBoundary,_options$flipVariatio=options.flipVariations,flipVariations=_options$flipVariatio===void 0?true:_options$flipVariatio,allowedAutoPlacements=options.allowedAutoPlacements;var preferredPlacement=state.options.placement;var basePlacement=getBasePlacement(preferredPlacement);var isBasePlacement=basePlacement===preferredPlacement;var fallbackPlacements=specifiedFallbackPlacements||(isBasePlacement||!flipVariations?[getOppositePlacement(preferredPlacement)]:getExpandedFallbackPlacements(preferredPlacement));var placements=[preferredPlacement].concat(fallbackPlacements).reduce(function(acc,placement){return acc.concat(getBasePlacement(placement)===auto?computeAutoPlacement(state,{placement:placement,boundary:boundary,rootBoundary:rootBoundary,padding:padding,flipVariations:flipVariations,allowedAutoPlacements:allowedAutoPlacements}):placement);},[]);var referenceRect=state.rects.reference;var popperRect=state.rects.popper;var checksMap=new Map();var makeFallbackChecks=true;var firstFittingPlacement=placements[0];for(var i=0;i<placements.length;i++){var placement=placements[i];var _basePlacement=getBasePlacement(placement);var isStartVariation=getVariation(placement)===start;var isVertical=[top,bottom].indexOf(_basePlacement)>=0;var len=isVertical?'width':'height';var overflow=detectOverflow(state,{placement:placement,boundary:boundary,rootBoundary:rootBoundary,altBoundary:altBoundary,padding:padding});var mainVariationSide=isVertical?isStartVariation?right:left:isStartVariation?bottom:top;if(referenceRect[len]>popperRect[len]){mainVariationSide=getOppositePlacement(mainVariationSide);}
var altVariationSide=getOppositePlacement(mainVariationSide);var checks=[];if(checkMainAxis){checks.push(overflow[_basePlacement]<=0);}
if(checkAltAxis){checks.push(overflow[mainVariationSide]<=0,overflow[altVariationSide]<=0);}
if(checks.every(function(check){return check;})){firstFittingPlacement=placement;makeFallbackChecks=false;break;}
checksMap.set(placement,checks);}
if(makeFallbackChecks){var numberOfChecks=flipVariations?3:1;var _loop=function _loop(_i){var fittingPlacement=placements.find(function(placement){var checks=checksMap.get(placement);if(checks){return checks.slice(0,_i).every(function(check){return check;});}});if(fittingPlacement){firstFittingPlacement=fittingPlacement;return"break";}};for(var _i=numberOfChecks;_i>0;_i--){var _ret=_loop(_i);if(_ret==="break")break;}}
if(state.placement!==firstFittingPlacement){state.modifiersData[name]._skip=true;state.placement=firstFittingPlacement;state.reset=true;}}
var flip$1={name:'flip',enabled:true,phase:'main',fn:flip,requiresIfExists:['offset'],data:{_skip:false}};function getAltAxis(axis){return axis==='x'?'y':'x';}
function within(min$1,value,max$1){return max(min$1,min(value,max$1));}
function withinMaxClamp(min,value,max){var v=within(min,value,max);return v>max?max:v;}
function preventOverflow(_ref){var state=_ref.state,options=_ref.options,name=_ref.name;var _options$mainAxis=options.mainAxis,checkMainAxis=_options$mainAxis===void 0?true:_options$mainAxis,_options$altAxis=options.altAxis,checkAltAxis=_options$altAxis===void 0?false:_options$altAxis,boundary=options.boundary,rootBoundary=options.rootBoundary,altBoundary=options.altBoundary,padding=options.padding,_options$tether=options.tether,tether=_options$tether===void 0?true:_options$tether,_options$tetherOffset=options.tetherOffset,tetherOffset=_options$tetherOffset===void 0?0:_options$tetherOffset;var overflow=detectOverflow(state,{boundary:boundary,rootBoundary:rootBoundary,padding:padding,altBoundary:altBoundary});var basePlacement=getBasePlacement(state.placement);var variation=getVariation(state.placement);var isBasePlacement=!variation;var mainAxis=getMainAxisFromPlacement(basePlacement);var altAxis=getAltAxis(mainAxis);var popperOffsets=state.modifiersData.popperOffsets;var referenceRect=state.rects.reference;var popperRect=state.rects.popper;var tetherOffsetValue=typeof tetherOffset==='function'?tetherOffset(Object.assign({},state.rects,{placement:state.placement})):tetherOffset;var normalizedTetherOffsetValue=typeof tetherOffsetValue==='number'?{mainAxis:tetherOffsetValue,altAxis:tetherOffsetValue}:Object.assign({mainAxis:0,altAxis:0},tetherOffsetValue);var offsetModifierState=state.modifiersData.offset?state.modifiersData.offset[state.placement]:null;var data={x:0,y:0};if(!popperOffsets){return;}
if(checkMainAxis){var _offsetModifierState$;var mainSide=mainAxis==='y'?top:left;var altSide=mainAxis==='y'?bottom:right;var len=mainAxis==='y'?'height':'width';var offset=popperOffsets[mainAxis];var min$1=offset+overflow[mainSide];var max$1=offset-overflow[altSide];var additive=tether?-popperRect[len]/2:0;var minLen=variation===start?referenceRect[len]:popperRect[len];var maxLen=variation===start?-popperRect[len]:-referenceRect[len];var arrowElement=state.elements.arrow;var arrowRect=tether&&arrowElement?getLayoutRect(arrowElement):{width:0,height:0};var arrowPaddingObject=state.modifiersData['arrow#persistent']?state.modifiersData['arrow#persistent'].padding:getFreshSideObject();var arrowPaddingMin=arrowPaddingObject[mainSide];var arrowPaddingMax=arrowPaddingObject[altSide];var arrowLen=within(0,referenceRect[len],arrowRect[len]);var minOffset=isBasePlacement?referenceRect[len]/2-additive-arrowLen-arrowPaddingMin-normalizedTetherOffsetValue.mainAxis:minLen-arrowLen-arrowPaddingMin-normalizedTetherOffsetValue.mainAxis;var maxOffset=isBasePlacement?-referenceRect[len]/2+additive+arrowLen+arrowPaddingMax+normalizedTetherOffsetValue.mainAxis:maxLen+arrowLen+arrowPaddingMax+normalizedTetherOffsetValue.mainAxis;var arrowOffsetParent=state.elements.arrow&&getOffsetParent(state.elements.arrow);var clientOffset=arrowOffsetParent?mainAxis==='y'?arrowOffsetParent.clientTop||0:arrowOffsetParent.clientLeft||0:0;var offsetModifierValue=(_offsetModifierState$=offsetModifierState==null?void 0:offsetModifierState[mainAxis])!=null?_offsetModifierState$:0;var tetherMin=offset+minOffset-offsetModifierValue-clientOffset;var tetherMax=offset+maxOffset-offsetModifierValue;var preventedOffset=within(tether?min(min$1,tetherMin):min$1,offset,tether?max(max$1,tetherMax):max$1);popperOffsets[mainAxis]=preventedOffset;data[mainAxis]=preventedOffset-offset;}
if(checkAltAxis){var _offsetModifierState$2;var _mainSide=mainAxis==='x'?top:left;var _altSide=mainAxis==='x'?bottom:right;var _offset=popperOffsets[altAxis];var _len=altAxis==='y'?'height':'width';var _min=_offset+overflow[_mainSide];var _max=_offset-overflow[_altSide];var isOriginSide=[top,left].indexOf(basePlacement)!==-1;var _offsetModifierValue=(_offsetModifierState$2=offsetModifierState==null?void 0:offsetModifierState[altAxis])!=null?_offsetModifierState$2:0;var _tetherMin=isOriginSide?_min:_offset-referenceRect[_len]-popperRect[_len]-_offsetModifierValue+normalizedTetherOffsetValue.altAxis;var _tetherMax=isOriginSide?_offset+referenceRect[_len]+popperRect[_len]-_offsetModifierValue-normalizedTetherOffsetValue.altAxis:_max;var _preventedOffset=tether&&isOriginSide?withinMaxClamp(_tetherMin,_offset,_tetherMax):within(tether?_tetherMin:_min,_offset,tether?_tetherMax:_max);popperOffsets[altAxis]=_preventedOffset;data[altAxis]=_preventedOffset-_offset;}
state.modifiersData[name]=data;}
var preventOverflow$1={name:'preventOverflow',enabled:true,phase:'main',fn:preventOverflow,requiresIfExists:['offset']};var toPaddingObject=function toPaddingObject(padding,state){padding=typeof padding==='function'?padding(Object.assign({},state.rects,{placement:state.placement})):padding;return mergePaddingObject(typeof padding!=='number'?padding:expandToHashMap(padding,basePlacements));};function arrow(_ref){var _state$modifiersData$;var state=_ref.state,name=_ref.name,options=_ref.options;var arrowElement=state.elements.arrow;var popperOffsets=state.modifiersData.popperOffsets;var basePlacement=getBasePlacement(state.placement);var axis=getMainAxisFromPlacement(basePlacement);var isVertical=[left,right].indexOf(basePlacement)>=0;var len=isVertical?'height':'width';if(!arrowElement||!popperOffsets){return;}
var paddingObject=toPaddingObject(options.padding,state);var arrowRect=getLayoutRect(arrowElement);var minProp=axis==='y'?top:left;var maxProp=axis==='y'?bottom:right;var endDiff=state.rects.reference[len]+state.rects.reference[axis]-popperOffsets[axis]-state.rects.popper[len];var startDiff=popperOffsets[axis]-state.rects.reference[axis];var arrowOffsetParent=getOffsetParent(arrowElement);var clientSize=arrowOffsetParent?axis==='y'?arrowOffsetParent.clientHeight||0:arrowOffsetParent.clientWidth||0:0;var centerToReference=endDiff/2-startDiff/2;var min=paddingObject[minProp];var max=clientSize-arrowRect[len]-paddingObject[maxProp];var center=clientSize/2-arrowRect[len]/2+centerToReference;var offset=within(min,center,max);var axisProp=axis;state.modifiersData[name]=(_state$modifiersData$={},_state$modifiersData$[axisProp]=offset,_state$modifiersData$.centerOffset=offset-center,_state$modifiersData$);}
function effect(_ref2){var state=_ref2.state,options=_ref2.options;var _options$element=options.element,arrowElement=_options$element===void 0?'[data-popper-arrow]':_options$element;if(arrowElement==null){return;}
if(typeof arrowElement==='string'){arrowElement=state.elements.popper.querySelector(arrowElement);if(!arrowElement){return;}}
{if(!isHTMLElement(arrowElement)){console.error(['Popper: "arrow" element must be an HTMLElement (not an SVGElement).','To use an SVG arrow, wrap it in an HTMLElement that will be used as','the arrow.'].join(' '));}}
if(!contains(state.elements.popper,arrowElement)){{console.error(['Popper: "arrow" modifier\'s `element` must be a child of the popper','element.'].join(' '));}
return;}
state.elements.arrow=arrowElement;}
var arrow$1={name:'arrow',enabled:true,phase:'main',fn:arrow,effect:effect,requires:['popperOffsets'],requiresIfExists:['preventOverflow']};function getSideOffsets(overflow,rect,preventedOffsets){if(preventedOffsets===void 0){preventedOffsets={x:0,y:0};}
return{top:overflow.top-rect.height-preventedOffsets.y,right:overflow.right-rect.width+preventedOffsets.x,bottom:overflow.bottom-rect.height+preventedOffsets.y,left:overflow.left-rect.width-preventedOffsets.x};}
function isAnySideFullyClipped(overflow){return[top,right,bottom,left].some(function(side){return overflow[side]>=0;});}
function hide(_ref){var state=_ref.state,name=_ref.name;var referenceRect=state.rects.reference;var popperRect=state.rects.popper;var preventedOffsets=state.modifiersData.preventOverflow;var referenceOverflow=detectOverflow(state,{elementContext:'reference'});var popperAltOverflow=detectOverflow(state,{altBoundary:true});var referenceClippingOffsets=getSideOffsets(referenceOverflow,referenceRect);var popperEscapeOffsets=getSideOffsets(popperAltOverflow,popperRect,preventedOffsets);var isReferenceHidden=isAnySideFullyClipped(referenceClippingOffsets);var hasPopperEscaped=isAnySideFullyClipped(popperEscapeOffsets);state.modifiersData[name]={referenceClippingOffsets:referenceClippingOffsets,popperEscapeOffsets:popperEscapeOffsets,isReferenceHidden:isReferenceHidden,hasPopperEscaped:hasPopperEscaped};state.attributes.popper=Object.assign({},state.attributes.popper,{'data-popper-reference-hidden':isReferenceHidden,'data-popper-escaped':hasPopperEscaped});}
var hide$1={name:'hide',enabled:true,phase:'main',requiresIfExists:['preventOverflow'],fn:hide};var defaultModifiers$1=[eventListeners,popperOffsets$1,computeStyles$1,applyStyles$1];var createPopper$1=popperGenerator({defaultModifiers:defaultModifiers$1});var defaultModifiers=[eventListeners,popperOffsets$1,computeStyles$1,applyStyles$1,offset$1,flip$1,preventOverflow$1,arrow$1,hide$1];var createPopper=popperGenerator({defaultModifiers:defaultModifiers});exports.applyStyles=applyStyles$1;exports.arrow=arrow$1;exports.computeStyles=computeStyles$1;exports.createPopper=createPopper;exports.createPopperLite=createPopper$1;exports.defaultModifiers=defaultModifiers;exports.detectOverflow=detectOverflow;exports.eventListeners=eventListeners;exports.flip=flip$1;exports.hide=hide$1;exports.offset=offset$1;exports.popperGenerator=popperGenerator;exports.popperOffsets=popperOffsets$1;exports.preventOverflow=preventOverflow$1;Object.defineProperty(exports,'__esModule',{value:true});})));;

/* /web/static/lib/bootstrap/js/dist/dom/data.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Data=factory());})(this,(function(){'use strict';const elementMap=new Map();const data={set(element,key,instance){if(!elementMap.has(element)){elementMap.set(element,new Map());}
const instanceMap=elementMap.get(element);if(!instanceMap.has(key)&&instanceMap.size!==0){console.error(`Bootstrap doesn't allow more than one instance per element. Bound instance: ${Array.from(instanceMap.keys())[0]}.`);return;}
instanceMap.set(key,instance);},get(element,key){if(elementMap.has(element)){return elementMap.get(element).get(key)||null;}
return null;},remove(element,key){if(!elementMap.has(element)){return;}
const instanceMap=elementMap.get(element);instanceMap.delete(key);if(instanceMap.size===0){elementMap.delete(element);}}};return data;}));;

/* /web/static/lib/bootstrap/js/dist/dom/event-handler.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.EventHandler=factory());})(this,(function(){'use strict';const getjQuery=()=>{const{jQuery}=window;if(jQuery&&!document.body.hasAttribute('data-bs-no-jquery')){return jQuery;}
return null;};const namespaceRegex=/[^.]*(?=\..*)\.|.*/;const stripNameRegex=/\..*/;const stripUidRegex=/::\d+$/;const eventRegistry={};let uidEvent=1;const customEvents={mouseenter:'mouseover',mouseleave:'mouseout'};const customEventsRegex=/^(mouseenter|mouseleave)/i;const nativeEvents=new Set(['click','dblclick','mouseup','mousedown','contextmenu','mousewheel','DOMMouseScroll','mouseover','mouseout','mousemove','selectstart','selectend','keydown','keypress','keyup','orientationchange','touchstart','touchmove','touchend','touchcancel','pointerdown','pointermove','pointerup','pointerleave','pointercancel','gesturestart','gesturechange','gestureend','focus','blur','change','reset','select','submit','focusin','focusout','load','unload','beforeunload','resize','move','DOMContentLoaded','readystatechange','error','abort','scroll']);function getUidEvent(element,uid){return uid&&`${uid}::${uidEvent++}`||element.uidEvent||uidEvent++;}
function getEvent(element){const uid=getUidEvent(element);element.uidEvent=uid;eventRegistry[uid]=eventRegistry[uid]||{};return eventRegistry[uid];}
function bootstrapHandler(element,fn){return function handler(event){event.delegateTarget=element;if(handler.oneOff){EventHandler.off(element,event.type,fn);}
return fn.apply(element,[event]);};}
function bootstrapDelegationHandler(element,selector,fn){return function handler(event){const domElements=element.querySelectorAll(selector);for(let{target}=event;target&&target!==this;target=target.parentNode){for(let i=domElements.length;i--;){if(domElements[i]===target){event.delegateTarget=target;if(handler.oneOff){EventHandler.off(element,event.type,selector,fn);}
return fn.apply(target,[event]);}}}
return null;};}
function findHandler(events,handler,delegationSelector=null){const uidEventList=Object.keys(events);for(let i=0,len=uidEventList.length;i<len;i++){const event=events[uidEventList[i]];if(event.originalHandler===handler&&event.delegationSelector===delegationSelector){return event;}}
return null;}
function normalizeParams(originalTypeEvent,handler,delegationFn){const delegation=typeof handler==='string';const originalHandler=delegation?delegationFn:handler;let typeEvent=getTypeEvent(originalTypeEvent);const isNative=nativeEvents.has(typeEvent);if(!isNative){typeEvent=originalTypeEvent;}
return[delegation,originalHandler,typeEvent];}
function addHandler(element,originalTypeEvent,handler,delegationFn,oneOff){if(typeof originalTypeEvent!=='string'||!element){return;}
if(!handler){handler=delegationFn;delegationFn=null;}
if(customEventsRegex.test(originalTypeEvent)){const wrapFn=fn=>{return function(event){if(!event.relatedTarget||event.relatedTarget!==event.delegateTarget&&!event.delegateTarget.contains(event.relatedTarget)){return fn.call(this,event);}};};if(delegationFn){delegationFn=wrapFn(delegationFn);}else{handler=wrapFn(handler);}}
const[delegation,originalHandler,typeEvent]=normalizeParams(originalTypeEvent,handler,delegationFn);const events=getEvent(element);const handlers=events[typeEvent]||(events[typeEvent]={});const previousFn=findHandler(handlers,originalHandler,delegation?handler:null);if(previousFn){previousFn.oneOff=previousFn.oneOff&&oneOff;return;}
const uid=getUidEvent(originalHandler,originalTypeEvent.replace(namespaceRegex,''));const fn=delegation?bootstrapDelegationHandler(element,handler,delegationFn):bootstrapHandler(element,handler);fn.delegationSelector=delegation?handler:null;fn.originalHandler=originalHandler;fn.oneOff=oneOff;fn.uidEvent=uid;handlers[uid]=fn;element.addEventListener(typeEvent,fn,delegation);}
function removeHandler(element,events,typeEvent,handler,delegationSelector){const fn=findHandler(events[typeEvent],handler,delegationSelector);if(!fn){return;}
element.removeEventListener(typeEvent,fn,Boolean(delegationSelector));delete events[typeEvent][fn.uidEvent];}
function removeNamespacedHandlers(element,events,typeEvent,namespace){const storeElementEvent=events[typeEvent]||{};Object.keys(storeElementEvent).forEach(handlerKey=>{if(handlerKey.includes(namespace)){const event=storeElementEvent[handlerKey];removeHandler(element,events,typeEvent,event.originalHandler,event.delegationSelector);}});}
function getTypeEvent(event){event=event.replace(stripNameRegex,'');return customEvents[event]||event;}
const EventHandler={on(element,event,handler,delegationFn){addHandler(element,event,handler,delegationFn,false);},one(element,event,handler,delegationFn){addHandler(element,event,handler,delegationFn,true);},off(element,originalTypeEvent,handler,delegationFn){if(typeof originalTypeEvent!=='string'||!element){return;}
const[delegation,originalHandler,typeEvent]=normalizeParams(originalTypeEvent,handler,delegationFn);const inNamespace=typeEvent!==originalTypeEvent;const events=getEvent(element);const isNamespace=originalTypeEvent.startsWith('.');if(typeof originalHandler!=='undefined'){if(!events||!events[typeEvent]){return;}
removeHandler(element,events,typeEvent,originalHandler,delegation?handler:null);return;}
if(isNamespace){Object.keys(events).forEach(elementEvent=>{removeNamespacedHandlers(element,events,elementEvent,originalTypeEvent.slice(1));});}
const storeElementEvent=events[typeEvent]||{};Object.keys(storeElementEvent).forEach(keyHandlers=>{const handlerKey=keyHandlers.replace(stripUidRegex,'');if(!inNamespace||originalTypeEvent.includes(handlerKey)){const event=storeElementEvent[keyHandlers];removeHandler(element,events,typeEvent,event.originalHandler,event.delegationSelector);}});},trigger(element,event,args){if(typeof event!=='string'||!element){return null;}
const $=getjQuery();const typeEvent=getTypeEvent(event);const inNamespace=event!==typeEvent;const isNative=nativeEvents.has(typeEvent);let jQueryEvent;let bubbles=true;let nativeDispatch=true;let defaultPrevented=false;let evt=null;if(inNamespace&&$){jQueryEvent=$.Event(event,args);$(element).trigger(jQueryEvent);bubbles=!jQueryEvent.isPropagationStopped();nativeDispatch=!jQueryEvent.isImmediatePropagationStopped();defaultPrevented=jQueryEvent.isDefaultPrevented();}
if(isNative){evt=document.createEvent('HTMLEvents');evt.initEvent(typeEvent,bubbles,true);}else{evt=new CustomEvent(event,{bubbles,cancelable:true});}
if(typeof args!=='undefined'){Object.keys(args).forEach(key=>{Object.defineProperty(evt,key,{get(){return args[key];}});});}
if(defaultPrevented){evt.preventDefault();}
if(nativeDispatch){element.dispatchEvent(evt);}
if(evt.defaultPrevented&&typeof jQueryEvent!=='undefined'){jQueryEvent.preventDefault();}
return evt;}};return EventHandler;}));;

/* /web/static/lib/bootstrap/js/dist/dom/manipulator.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Manipulator=factory());})(this,(function(){'use strict';function normalizeData(val){if(val==='true'){return true;}
if(val==='false'){return false;}
if(val===Number(val).toString()){return Number(val);}
if(val===''||val==='null'){return null;}
return val;}
function normalizeDataKey(key){return key.replace(/[A-Z]/g,chr=>`-${chr.toLowerCase()}`);}
const Manipulator={setDataAttribute(element,key,value){element.setAttribute(`data-bs-${normalizeDataKey(key)}`,value);},removeDataAttribute(element,key){element.removeAttribute(`data-bs-${normalizeDataKey(key)}`);},getDataAttributes(element){if(!element){return{};}
const attributes={};Object.keys(element.dataset).filter(key=>key.startsWith('bs')).forEach(key=>{let pureKey=key.replace(/^bs/,'');pureKey=pureKey.charAt(0).toLowerCase()+pureKey.slice(1,pureKey.length);attributes[pureKey]=normalizeData(element.dataset[key]);});return attributes;},getDataAttribute(element,key){return normalizeData(element.getAttribute(`data-bs-${normalizeDataKey(key)}`));},offset(element){const rect=element.getBoundingClientRect();return{top:rect.top+window.pageYOffset,left:rect.left+window.pageXOffset};},position(element){return{top:element.offsetTop,left:element.offsetLeft};}};return Manipulator;}));;

/* /web/static/lib/bootstrap/js/dist/dom/selector-engine.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.SelectorEngine=factory());})(this,(function(){'use strict';const isElement=obj=>{if(!obj||typeof obj!=='object'){return false;}
if(typeof obj.jquery!=='undefined'){obj=obj[0];}
return typeof obj.nodeType!=='undefined';};const isVisible=element=>{if(!isElement(element)||element.getClientRects().length===0){return false;}
return getComputedStyle(element).getPropertyValue('visibility')==='visible';};const isDisabled=element=>{if(!element||element.nodeType!==Node.ELEMENT_NODE){return true;}
if(element.classList.contains('disabled')){return true;}
if(typeof element.disabled!=='undefined'){return element.disabled;}
return element.hasAttribute('disabled')&&element.getAttribute('disabled')!=='false';};const NODE_TEXT=3;const SelectorEngine={find(selector,element=document.documentElement){return[].concat(...Element.prototype.querySelectorAll.call(element,selector));},findOne(selector,element=document.documentElement){return Element.prototype.querySelector.call(element,selector);},children(element,selector){return[].concat(...element.children).filter(child=>child.matches(selector));},parents(element,selector){const parents=[];let ancestor=element.parentNode;while(ancestor&&ancestor.nodeType===Node.ELEMENT_NODE&&ancestor.nodeType!==NODE_TEXT){if(ancestor.matches(selector)){parents.push(ancestor);}
ancestor=ancestor.parentNode;}
return parents;},prev(element,selector){let previous=element.previousElementSibling;while(previous){if(previous.matches(selector)){return[previous];}
previous=previous.previousElementSibling;}
return[];},next(element,selector){let next=element.nextElementSibling;while(next){if(next.matches(selector)){return[next];}
next=next.nextElementSibling;}
return[];},focusableChildren(element){const focusables=['a','button','input','textarea','select','details','[tabindex]','[contenteditable="true"]'].map(selector=>`${selector}:not([tabindex^="-"])`).join(', ');return this.find(focusables,element).filter(el=>!isDisabled(el)&&isVisible(el));}};return SelectorEngine;}));;

/* /web/static/lib/bootstrap/js/dist/base-component.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory(require('./dom/data.js'),require('./dom/event-handler.js')):typeof define==='function'&&define.amd?define(['./dom/data','./dom/event-handler'],factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Base=factory(global.Data,global.EventHandler));})(this,(function(Data,EventHandler){'use strict';const _interopDefaultLegacy=e=>e&&typeof e==='object'&&'default'in e?e:{default:e};const Data__default=_interopDefaultLegacy(Data);const EventHandler__default=_interopDefaultLegacy(EventHandler);const MILLISECONDS_MULTIPLIER=1000;const TRANSITION_END='transitionend';const getTransitionDurationFromElement=element=>{if(!element){return 0;}
let{transitionDuration,transitionDelay}=window.getComputedStyle(element);const floatTransitionDuration=Number.parseFloat(transitionDuration);const floatTransitionDelay=Number.parseFloat(transitionDelay);if(!floatTransitionDuration&&!floatTransitionDelay){return 0;}
transitionDuration=transitionDuration.split(',')[0];transitionDelay=transitionDelay.split(',')[0];return(Number.parseFloat(transitionDuration)+Number.parseFloat(transitionDelay))*MILLISECONDS_MULTIPLIER;};const triggerTransitionEnd=element=>{element.dispatchEvent(new Event(TRANSITION_END));};const isElement=obj=>{if(!obj||typeof obj!=='object'){return false;}
if(typeof obj.jquery!=='undefined'){obj=obj[0];}
return typeof obj.nodeType!=='undefined';};const getElement=obj=>{if(isElement(obj)){return obj.jquery?obj[0]:obj;}
if(typeof obj==='string'&&obj.length>0){return document.querySelector(obj);}
return null;};const execute=callback=>{if(typeof callback==='function'){callback();}};const executeAfterTransition=(callback,transitionElement,waitForTransition=true)=>{if(!waitForTransition){execute(callback);return;}
const durationPadding=5;const emulatedDuration=getTransitionDurationFromElement(transitionElement)+durationPadding;let called=false;const handler=({target})=>{if(target!==transitionElement){return;}
called=true;transitionElement.removeEventListener(TRANSITION_END,handler);execute(callback);};transitionElement.addEventListener(TRANSITION_END,handler);setTimeout(()=>{if(!called){triggerTransitionEnd(transitionElement);}},emulatedDuration);};const VERSION='5.1.3';class BaseComponent{constructor(element){element=getElement(element);if(!element){return;}
this._element=element;Data__default.default.set(this._element,this.constructor.DATA_KEY,this);}
dispose(){Data__default.default.remove(this._element,this.constructor.DATA_KEY);EventHandler__default.default.off(this._element,this.constructor.EVENT_KEY);Object.getOwnPropertyNames(this).forEach(propertyName=>{this[propertyName]=null;});}
_queueCallback(callback,element,isAnimated=true){executeAfterTransition(callback,element,isAnimated);}
static getInstance(element){return Data__default.default.get(getElement(element),this.DATA_KEY);}
static getOrCreateInstance(element,config={}){return this.getInstance(element)||new this(element,typeof config==='object'?config:null);}
static get VERSION(){return VERSION;}
static get NAME(){throw new Error('You have to implement the static method "NAME", for each component!');}
static get DATA_KEY(){return`bs.${this.NAME}`;}
static get EVENT_KEY(){return`.${this.DATA_KEY}`;}}
return BaseComponent;}));;

/* /web/static/lib/bootstrap/js/dist/collapse.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory(require('./dom/data.js'),require('./dom/event-handler.js'),require('./dom/manipulator.js'),require('./dom/selector-engine.js'),require('./base-component.js')):typeof define==='function'&&define.amd?define(['./dom/data','./dom/event-handler','./dom/manipulator','./dom/selector-engine','./base-component'],factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Collapse=factory(global.Data,global.EventHandler,global.Manipulator,global.SelectorEngine,global.Base));})(this,(function(Data,EventHandler,Manipulator,SelectorEngine,BaseComponent){'use strict';const _interopDefaultLegacy=e=>e&&typeof e==='object'&&'default'in e?e:{default:e};const Data__default=_interopDefaultLegacy(Data);const EventHandler__default=_interopDefaultLegacy(EventHandler);const Manipulator__default=_interopDefaultLegacy(Manipulator);const SelectorEngine__default=_interopDefaultLegacy(SelectorEngine);const BaseComponent__default=_interopDefaultLegacy(BaseComponent);const toType=obj=>{if(obj===null||obj===undefined){return`${obj}`;}
return{}.toString.call(obj).match(/\s([a-z]+)/i)[1].toLowerCase();};const getSelector=element=>{let selector=element.getAttribute('data-bs-target');if(!selector||selector==='#'){let hrefAttr=element.getAttribute('href');if(!hrefAttr||!hrefAttr.includes('#')&&!hrefAttr.startsWith('.')){return null;}
if(hrefAttr.includes('#')&&!hrefAttr.startsWith('#')){hrefAttr=`#${hrefAttr.split('#')[1]}`;}
selector=hrefAttr&&hrefAttr!=='#'?hrefAttr.trim():null;}
return selector;};const getSelectorFromElement=element=>{const selector=getSelector(element);if(selector){return document.querySelector(selector)?selector:null;}
return null;};const getElementFromSelector=element=>{const selector=getSelector(element);return selector?document.querySelector(selector):null;};const isElement=obj=>{if(!obj||typeof obj!=='object'){return false;}
if(typeof obj.jquery!=='undefined'){obj=obj[0];}
return typeof obj.nodeType!=='undefined';};const getElement=obj=>{if(isElement(obj)){return obj.jquery?obj[0]:obj;}
if(typeof obj==='string'&&obj.length>0){return document.querySelector(obj);}
return null;};const typeCheckConfig=(componentName,config,configTypes)=>{Object.keys(configTypes).forEach(property=>{const expectedTypes=configTypes[property];const value=config[property];const valueType=value&&isElement(value)?'element':toType(value);if(!new RegExp(expectedTypes).test(valueType)){throw new TypeError(`${componentName.toUpperCase()}: Option "${property}" provided type "${valueType}" but expected type "${expectedTypes}".`);}});};const reflow=element=>{element.offsetHeight;};const getjQuery=()=>{const{jQuery}=window;if(jQuery&&!document.body.hasAttribute('data-bs-no-jquery')){return jQuery;}
return null;};const DOMContentLoadedCallbacks=[];const onDOMContentLoaded=callback=>{if(document.readyState==='loading'){if(!DOMContentLoadedCallbacks.length){document.addEventListener('DOMContentLoaded',()=>{DOMContentLoadedCallbacks.forEach(callback=>callback());});}
DOMContentLoadedCallbacks.push(callback);}else{callback();}};const defineJQueryPlugin=plugin=>{onDOMContentLoaded(()=>{const $=getjQuery();if($){const name=plugin.NAME;const JQUERY_NO_CONFLICT=$.fn[name];$.fn[name]=plugin.jQueryInterface;$.fn[name].Constructor=plugin;$.fn[name].noConflict=()=>{$.fn[name]=JQUERY_NO_CONFLICT;return plugin.jQueryInterface;};}});};const NAME='collapse';const DATA_KEY='bs.collapse';const EVENT_KEY=`.${DATA_KEY}`;const DATA_API_KEY='.data-api';const Default={toggle:true,parent:null};const DefaultType={toggle:'boolean',parent:'(null|element)'};const EVENT_SHOW=`show${EVENT_KEY}`;const EVENT_SHOWN=`shown${EVENT_KEY}`;const EVENT_HIDE=`hide${EVENT_KEY}`;const EVENT_HIDDEN=`hidden${EVENT_KEY}`;const EVENT_CLICK_DATA_API=`click${EVENT_KEY}${DATA_API_KEY}`;const CLASS_NAME_SHOW='show';const CLASS_NAME_COLLAPSE='collapse';const CLASS_NAME_COLLAPSING='collapsing';const CLASS_NAME_COLLAPSED='collapsed';const CLASS_NAME_DEEPER_CHILDREN=`:scope .${CLASS_NAME_COLLAPSE} .${CLASS_NAME_COLLAPSE}`;const CLASS_NAME_HORIZONTAL='collapse-horizontal';const WIDTH='width';const HEIGHT='height';const SELECTOR_ACTIVES='.collapse.show, .collapse.collapsing';const SELECTOR_DATA_TOGGLE='[data-bs-toggle="collapse"]';class Collapse extends BaseComponent__default.default{constructor(element,config){super(element);this._isTransitioning=false;this._config=this._getConfig(config);this._triggerArray=[];const toggleList=SelectorEngine__default.default.find(SELECTOR_DATA_TOGGLE);for(let i=0,len=toggleList.length;i<len;i++){const elem=toggleList[i];const selector=getSelectorFromElement(elem);const filterElement=SelectorEngine__default.default.find(selector).filter(foundElem=>foundElem===this._element);if(selector!==null&&filterElement.length){this._selector=selector;this._triggerArray.push(elem);}}
this._initializeChildren();if(!this._config.parent){this._addAriaAndCollapsedClass(this._triggerArray,this._isShown());}
if(this._config.toggle){this.toggle();}}
static get Default(){return Default;}
static get NAME(){return NAME;}
toggle(){if(this._isShown()){this.hide();}else{this.show();}}
show(){if(this._isTransitioning||this._isShown()){return;}
let actives=[];let activesData;if(this._config.parent){const children=SelectorEngine__default.default.find(CLASS_NAME_DEEPER_CHILDREN,this._config.parent);actives=SelectorEngine__default.default.find(SELECTOR_ACTIVES,this._config.parent).filter(elem=>!children.includes(elem));}
const container=SelectorEngine__default.default.findOne(this._selector);if(actives.length){const tempActiveData=actives.find(elem=>container!==elem);activesData=tempActiveData?Collapse.getInstance(tempActiveData):null;if(activesData&&activesData._isTransitioning){return;}}
const startEvent=EventHandler__default.default.trigger(this._element,EVENT_SHOW);if(startEvent.defaultPrevented){return;}
actives.forEach(elemActive=>{if(container!==elemActive){Collapse.getOrCreateInstance(elemActive,{toggle:false}).hide();}
if(!activesData){Data__default.default.set(elemActive,DATA_KEY,null);}});const dimension=this._getDimension();this._element.classList.remove(CLASS_NAME_COLLAPSE);this._element.classList.add(CLASS_NAME_COLLAPSING);this._element.style[dimension]=0;this._addAriaAndCollapsedClass(this._triggerArray,true);this._isTransitioning=true;const complete=()=>{this._isTransitioning=false;this._element.classList.remove(CLASS_NAME_COLLAPSING);this._element.classList.add(CLASS_NAME_COLLAPSE,CLASS_NAME_SHOW);this._element.style[dimension]='';EventHandler__default.default.trigger(this._element,EVENT_SHOWN);};const capitalizedDimension=dimension[0].toUpperCase()+dimension.slice(1);const scrollSize=`scroll${capitalizedDimension}`;this._queueCallback(complete,this._element,true);this._element.style[dimension]=`${this._element[scrollSize]}px`;}
hide(){if(this._isTransitioning||!this._isShown()){return;}
const startEvent=EventHandler__default.default.trigger(this._element,EVENT_HIDE);if(startEvent.defaultPrevented){return;}
const dimension=this._getDimension();this._element.style[dimension]=`${this._element.getBoundingClientRect()[dimension]}px`;reflow(this._element);this._element.classList.add(CLASS_NAME_COLLAPSING);this._element.classList.remove(CLASS_NAME_COLLAPSE,CLASS_NAME_SHOW);const triggerArrayLength=this._triggerArray.length;for(let i=0;i<triggerArrayLength;i++){const trigger=this._triggerArray[i];const elem=getElementFromSelector(trigger);if(elem&&!this._isShown(elem)){this._addAriaAndCollapsedClass([trigger],false);}}
this._isTransitioning=true;const complete=()=>{this._isTransitioning=false;this._element.classList.remove(CLASS_NAME_COLLAPSING);this._element.classList.add(CLASS_NAME_COLLAPSE);EventHandler__default.default.trigger(this._element,EVENT_HIDDEN);};this._element.style[dimension]='';this._queueCallback(complete,this._element,true);}
_isShown(element=this._element){return element.classList.contains(CLASS_NAME_SHOW);}
_getConfig(config){config={...Default,...Manipulator__default.default.getDataAttributes(this._element),...config};config.toggle=Boolean(config.toggle);config.parent=getElement(config.parent);typeCheckConfig(NAME,config,DefaultType);return config;}
_getDimension(){return this._element.classList.contains(CLASS_NAME_HORIZONTAL)?WIDTH:HEIGHT;}
_initializeChildren(){if(!this._config.parent){return;}
const children=SelectorEngine__default.default.find(CLASS_NAME_DEEPER_CHILDREN,this._config.parent);SelectorEngine__default.default.find(SELECTOR_DATA_TOGGLE,this._config.parent).filter(elem=>!children.includes(elem)).forEach(element=>{const selected=getElementFromSelector(element);if(selected){this._addAriaAndCollapsedClass([element],this._isShown(selected));}});}
_addAriaAndCollapsedClass(triggerArray,isOpen){if(!triggerArray.length){return;}
triggerArray.forEach(elem=>{if(isOpen){elem.classList.remove(CLASS_NAME_COLLAPSED);}else{elem.classList.add(CLASS_NAME_COLLAPSED);}
elem.setAttribute('aria-expanded',isOpen);});}
static jQueryInterface(config){return this.each(function(){const _config={};if(typeof config==='string'&&/show|hide/.test(config)){_config.toggle=false;}
const data=Collapse.getOrCreateInstance(this,_config);if(typeof config==='string'){if(typeof data[config]==='undefined'){throw new TypeError(`No method named "${config}"`);}
data[config]();}});}}
EventHandler__default.default.on(document,EVENT_CLICK_DATA_API,SELECTOR_DATA_TOGGLE,function(event){if(event.target.tagName==='A'||event.delegateTarget&&event.delegateTarget.tagName==='A'){event.preventDefault();}
const selector=getSelectorFromElement(this);const selectorElements=SelectorEngine__default.default.find(selector);selectorElements.forEach(element=>{Collapse.getOrCreateInstance(element,{toggle:false}).toggle();});});defineJQueryPlugin(Collapse);return Collapse;}));;

/* /web/static/lib/bootstrap/js/dist/dropdown.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory(require('@popperjs/core'),require('./dom/event-handler.js'),require('./dom/manipulator.js'),require('./dom/selector-engine.js'),require('./base-component.js')):typeof define==='function'&&define.amd?define(['@popperjs/core','./dom/event-handler','./dom/manipulator','./dom/selector-engine','./base-component'],factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Dropdown=factory(global.Popper,global.EventHandler,global.Manipulator,global.SelectorEngine,global.Base));})(this,(function(Popper,EventHandler,Manipulator,SelectorEngine,BaseComponent){'use strict';const _interopDefaultLegacy=e=>e&&typeof e==='object'&&'default'in e?e:{default:e};function _interopNamespace(e){if(e&&e.__esModule)return e;const n=Object.create(null);if(e){for(const k in e){if(k!=='default'){const d=Object.getOwnPropertyDescriptor(e,k);Object.defineProperty(n,k,d.get?d:{enumerable:true,get:()=>e[k]});}}}
n.default=e;return Object.freeze(n);}
const Popper__namespace=_interopNamespace(Popper);const EventHandler__default=_interopDefaultLegacy(EventHandler);const Manipulator__default=_interopDefaultLegacy(Manipulator);const SelectorEngine__default=_interopDefaultLegacy(SelectorEngine);const BaseComponent__default=_interopDefaultLegacy(BaseComponent);const toType=obj=>{if(obj===null||obj===undefined){return`${obj}`;}
return{}.toString.call(obj).match(/\s([a-z]+)/i)[1].toLowerCase();};const getSelector=element=>{let selector=element.getAttribute('data-bs-target');if(!selector||selector==='#'){let hrefAttr=element.getAttribute('href');if(!hrefAttr||!hrefAttr.includes('#')&&!hrefAttr.startsWith('.')){return null;}
if(hrefAttr.includes('#')&&!hrefAttr.startsWith('#')){hrefAttr=`#${hrefAttr.split('#')[1]}`;}
selector=hrefAttr&&hrefAttr!=='#'?hrefAttr.trim():null;}
return selector;};const getElementFromSelector=element=>{const selector=getSelector(element);return selector?document.querySelector(selector):null;};const isElement=obj=>{if(!obj||typeof obj!=='object'){return false;}
if(typeof obj.jquery!=='undefined'){obj=obj[0];}
return typeof obj.nodeType!=='undefined';};const getElement=obj=>{if(isElement(obj)){return obj.jquery?obj[0]:obj;}
if(typeof obj==='string'&&obj.length>0){return document.querySelector(obj);}
return null;};const typeCheckConfig=(componentName,config,configTypes)=>{Object.keys(configTypes).forEach(property=>{const expectedTypes=configTypes[property];const value=config[property];const valueType=value&&isElement(value)?'element':toType(value);if(!new RegExp(expectedTypes).test(valueType)){throw new TypeError(`${componentName.toUpperCase()}: Option "${property}" provided type "${valueType}" but expected type "${expectedTypes}".`);}});};const isVisible=element=>{if(!isElement(element)||element.getClientRects().length===0){return false;}
return getComputedStyle(element).getPropertyValue('visibility')==='visible';};const isDisabled=element=>{if(!element||element.nodeType!==Node.ELEMENT_NODE){return true;}
if(element.classList.contains('disabled')){return true;}
if(typeof element.disabled!=='undefined'){return element.disabled;}
return element.hasAttribute('disabled')&&element.getAttribute('disabled')!=='false';};const noop=()=>{};const getjQuery=()=>{const{jQuery}=window;if(jQuery&&!document.body.hasAttribute('data-bs-no-jquery')){return jQuery;}
return null;};const DOMContentLoadedCallbacks=[];const onDOMContentLoaded=callback=>{if(document.readyState==='loading'){if(!DOMContentLoadedCallbacks.length){document.addEventListener('DOMContentLoaded',()=>{DOMContentLoadedCallbacks.forEach(callback=>callback());});}
DOMContentLoadedCallbacks.push(callback);}else{callback();}};const isRTL=()=>document.documentElement.dir==='rtl';const defineJQueryPlugin=plugin=>{onDOMContentLoaded(()=>{const $=getjQuery();if($){const name=plugin.NAME;const JQUERY_NO_CONFLICT=$.fn[name];$.fn[name]=plugin.jQueryInterface;$.fn[name].Constructor=plugin;$.fn[name].noConflict=()=>{$.fn[name]=JQUERY_NO_CONFLICT;return plugin.jQueryInterface;};}});};const getNextActiveElement=(list,activeElement,shouldGetNext,isCycleAllowed)=>{let index=list.indexOf(activeElement);if(index===-1){return list[!shouldGetNext&&isCycleAllowed?list.length-1:0];}
const listLength=list.length;index+=shouldGetNext?1:-1;if(isCycleAllowed){index=(index+listLength)%listLength;}
return list[Math.max(0,Math.min(index,listLength-1))];};const NAME='dropdown';const DATA_KEY='bs.dropdown';const EVENT_KEY=`.${DATA_KEY}`;const DATA_API_KEY='.data-api';const ESCAPE_KEY='Escape';const SPACE_KEY='Space';const TAB_KEY='Tab';const ARROW_UP_KEY='ArrowUp';const ARROW_DOWN_KEY='ArrowDown';const RIGHT_MOUSE_BUTTON=2;const REGEXP_KEYDOWN=new RegExp(`${ARROW_UP_KEY}|${ARROW_DOWN_KEY}|${ESCAPE_KEY}`);const EVENT_HIDE=`hide${EVENT_KEY}`;const EVENT_HIDDEN=`hidden${EVENT_KEY}`;const EVENT_SHOW=`show${EVENT_KEY}`;const EVENT_SHOWN=`shown${EVENT_KEY}`;const EVENT_CLICK_DATA_API=`click${EVENT_KEY}${DATA_API_KEY}`;const EVENT_KEYDOWN_DATA_API=`keydown${EVENT_KEY}${DATA_API_KEY}`;const EVENT_KEYUP_DATA_API=`keyup${EVENT_KEY}${DATA_API_KEY}`;const CLASS_NAME_SHOW='show';const CLASS_NAME_DROPUP='dropup';const CLASS_NAME_DROPEND='dropend';const CLASS_NAME_DROPSTART='dropstart';const CLASS_NAME_NAVBAR='navbar';const SELECTOR_DATA_TOGGLE='[data-bs-toggle="dropdown"]';const SELECTOR_MENU='.dropdown-menu:not(.o-dropdown--menu)';const SELECTOR_MENU_NOT_SUB='.dropdown-menu:not(.o-dropdown--menu):not(.o_wysiwyg_submenu)';const SELECTOR_NAVBAR_NAV='.navbar-nav';const SELECTOR_VISIBLE_ITEMS='.dropdown-menu .dropdown-item:not(.disabled):not(:disabled)';const PLACEMENT_TOP=isRTL()?'top-end':'top-start';const PLACEMENT_TOPEND=isRTL()?'top-start':'top-end';const PLACEMENT_BOTTOM=isRTL()?'bottom-end':'bottom-start';const PLACEMENT_BOTTOMEND=isRTL()?'bottom-start':'bottom-end';const PLACEMENT_RIGHT=isRTL()?'left-start':'right-start';const PLACEMENT_LEFT=isRTL()?'right-start':'left-start';const Default={offset:[0,2],boundary:'clippingParents',reference:'toggle',display:'dynamic',popperConfig:null,autoClose:true};const DefaultType={offset:'(array|string|function)',boundary:'(string|element)',reference:'(string|element|object)',display:'string',popperConfig:'(null|object|function)',autoClose:'(boolean|string)'};class Dropdown extends BaseComponent__default.default{constructor(element,config){super(element);this._popper=null;this._config=this._getConfig(config);this._menu=this._getMenuElement();this._inNavbar=this._detectNavbar();}
static get Default(){return Default;}
static get DefaultType(){return DefaultType;}
static get NAME(){return NAME;}
toggle(){return this._isShown()?this.hide():this.show();}
show(){if(isDisabled(this._element)||this._isShown(this._menu)){return;}
const relatedTarget={relatedTarget:this._element};const showEvent=EventHandler__default.default.trigger(this._element,EVENT_SHOW,relatedTarget);if(showEvent.defaultPrevented){return;}
const parent=Dropdown.getParentFromElement(this._element);if(this._inNavbar){Manipulator__default.default.setDataAttribute(this._menu,'popper','none');}else{this._createPopper(parent);}
if('ontouchstart'in document.documentElement&&!parent.closest(SELECTOR_NAVBAR_NAV)){[].concat(...document.body.children).forEach(elem=>EventHandler__default.default.on(elem,'mouseover',noop));}
this._element.focus();this._element.setAttribute('aria-expanded',true);this._menu.classList.add(CLASS_NAME_SHOW);this._element.classList.add(CLASS_NAME_SHOW);EventHandler__default.default.trigger(this._element,EVENT_SHOWN,relatedTarget);}
hide(){if(isDisabled(this._element)||!this._isShown(this._menu)){return;}
const relatedTarget={relatedTarget:this._element};this._completeHide(relatedTarget);}
dispose(){if(this._popper){this._popper.destroy();}
super.dispose();}
update(){this._inNavbar=this._detectNavbar();if(this._popper){this._popper.update();}}
_completeHide(relatedTarget){const hideEvent=EventHandler__default.default.trigger(this._element,EVENT_HIDE,relatedTarget);if(hideEvent.defaultPrevented){return;}
if('ontouchstart'in document.documentElement){[].concat(...document.body.children).forEach(elem=>EventHandler__default.default.off(elem,'mouseover',noop));}
if(this._popper){this._popper.destroy();}
this._menu.classList.remove(CLASS_NAME_SHOW);this._element.classList.remove(CLASS_NAME_SHOW);this._element.setAttribute('aria-expanded','false');Manipulator__default.default.removeDataAttribute(this._menu,'popper');EventHandler__default.default.trigger(this._element,EVENT_HIDDEN,relatedTarget);}
_getConfig(config){config={...this.constructor.Default,...Manipulator__default.default.getDataAttributes(this._element),...config};typeCheckConfig(NAME,config,this.constructor.DefaultType);if(typeof config.reference==='object'&&!isElement(config.reference)&&typeof config.reference.getBoundingClientRect!=='function'){throw new TypeError(`${NAME.toUpperCase()}: Option "reference" provided type "object" without a required "getBoundingClientRect" method.`);}
return config;}
_createPopper(parent){if(typeof Popper__namespace==='undefined'){throw new TypeError('Bootstrap\'s dropdowns require Popper (https://popper.js.org)');}
let referenceElement=this._element;if(this._config.reference==='parent'){referenceElement=parent;}else if(isElement(this._config.reference)){referenceElement=getElement(this._config.reference);}else if(typeof this._config.reference==='object'){referenceElement=this._config.reference;}
const popperConfig=this._getPopperConfig();const isDisplayStatic=popperConfig.modifiers.find(modifier=>modifier.name==='applyStyles'&&modifier.enabled===false);this._popper=Popper__namespace.createPopper(referenceElement,this._menu,popperConfig);if(isDisplayStatic){Manipulator__default.default.setDataAttribute(this._menu,'popper','static');}}
_isShown(element=this._element){return element.classList.contains(CLASS_NAME_SHOW);}
_getMenuElement(){return SelectorEngine__default.default.next(this._element,SELECTOR_MENU)[0];}
_getPlacement(){const parentDropdown=this._element.parentNode;if(parentDropdown.classList.contains(CLASS_NAME_DROPEND)){return PLACEMENT_RIGHT;}
if(parentDropdown.classList.contains(CLASS_NAME_DROPSTART)){return PLACEMENT_LEFT;}
const isEnd=getComputedStyle(this._menu).getPropertyValue('--bs-position').trim()==='end';if(parentDropdown.classList.contains(CLASS_NAME_DROPUP)){return isEnd?PLACEMENT_TOPEND:PLACEMENT_TOP;}
return isEnd?PLACEMENT_BOTTOMEND:PLACEMENT_BOTTOM;}
_detectNavbar(){return this._element.closest(`.${CLASS_NAME_NAVBAR}`)!==null;}
_getOffset(){const{offset}=this._config;if(typeof offset==='string'){return offset.split(',').map(val=>Number.parseInt(val,10));}
if(typeof offset==='function'){return popperData=>offset(popperData,this._element);}
return offset;}
_getPopperConfig(){const defaultBsPopperConfig={placement:this._getPlacement(),modifiers:[{name:'preventOverflow',options:{boundary:this._config.boundary}},{name:'offset',options:{offset:this._getOffset()}}]};if(this._config.display==='static'){defaultBsPopperConfig.modifiers=[{name:'applyStyles',enabled:false}];}
return{...defaultBsPopperConfig,...(typeof this._config.popperConfig==='function'?this._config.popperConfig(defaultBsPopperConfig):this._config.popperConfig)};}
_selectMenuItem({key,target}){const items=SelectorEngine__default.default.find(SELECTOR_VISIBLE_ITEMS,this._menu).filter(isVisible);if(!items.length){return;}
getNextActiveElement(items,target,key===ARROW_DOWN_KEY,!items.includes(target)).focus();}
static jQueryInterface(config){return this.each(function(){const data=Dropdown.getOrCreateInstance(this,config);if(typeof config!=='string'){return;}
if(typeof data[config]==='undefined'){throw new TypeError(`No method named "${config}"`);}
data[config]();});}
static clearMenus(event){if(event&&(event.button===RIGHT_MOUSE_BUTTON||event.type==='keyup'&&event.key!==TAB_KEY)){return;}
const toggles=SelectorEngine__default.default.find(SELECTOR_DATA_TOGGLE);for(let i=0,len=toggles.length;i<len;i++){const context=Dropdown.getInstance(toggles[i]);if(!context||context._config.autoClose===false){continue;}
if(!context._isShown()){continue;}
const relatedTarget={relatedTarget:context._element};if(event){const composedPath=event.composedPath();const isMenuTarget=composedPath.includes(context._menu);if(composedPath.includes(context._element)||context._config.autoClose==='inside'&&!isMenuTarget||context._config.autoClose==='outside'&&isMenuTarget){continue;}
if(context._menu.contains(event.target)&&(event.type==='keyup'&&event.key===TAB_KEY||/input|select|option|textarea|form/i.test(event.target.tagName))){continue;}
if(event.type==='click'){relatedTarget.clickEvent=event;}}
context._completeHide(relatedTarget);}}
static getParentFromElement(element){return getElementFromSelector(element)||element.parentNode;}
static dataApiKeydownHandler(event){if(/input|textarea/i.test(event.target.tagName)?event.key===SPACE_KEY||event.key!==ESCAPE_KEY&&(event.key!==ARROW_DOWN_KEY&&event.key!==ARROW_UP_KEY||event.target.closest(SELECTOR_MENU)):!REGEXP_KEYDOWN.test(event.key)){return;}
const isActive=this.classList.contains(CLASS_NAME_SHOW);if(!isActive&&event.key===ESCAPE_KEY){return;}
event.preventDefault();event.stopPropagation();if(isDisabled(this)){return;}
const getToggleButton=this.matches(SELECTOR_DATA_TOGGLE)?this:SelectorEngine__default.default.prev(this,SELECTOR_DATA_TOGGLE)[0];const instance=Dropdown.getOrCreateInstance(getToggleButton);if(event.key===ESCAPE_KEY){instance.hide();return;}
if(event.key===ARROW_UP_KEY||event.key===ARROW_DOWN_KEY){if(!isActive){instance.show();}
instance._selectMenuItem(event);return;}
if(!isActive||event.key===SPACE_KEY){Dropdown.clearMenus();}}}
EventHandler__default.default.on(document,EVENT_KEYDOWN_DATA_API,SELECTOR_DATA_TOGGLE,Dropdown.dataApiKeydownHandler);EventHandler__default.default.on(document,EVENT_KEYDOWN_DATA_API,SELECTOR_MENU_NOT_SUB,Dropdown.dataApiKeydownHandler);EventHandler__default.default.on(document,EVENT_CLICK_DATA_API,Dropdown.clearMenus);EventHandler__default.default.on(document,EVENT_KEYUP_DATA_API,Dropdown.clearMenus);EventHandler__default.default.on(document,EVENT_CLICK_DATA_API,SELECTOR_DATA_TOGGLE,function(event){event.preventDefault();Dropdown.getOrCreateInstance(this).toggle();});defineJQueryPlugin(Dropdown);return Dropdown;}));;

/* /web/static/lib/owl/owl.js */
(function(exports){'use strict';function filterOutModifiersFromData(dataList){dataList=dataList.slice();const modifiers=[];let elm;while((elm=dataList[0])&&typeof elm==="string"){modifiers.push(dataList.shift());}
return{modifiers,data:dataList};}
const config={shouldNormalizeDom:true,mainEventHandler:(data,ev,currentTarget)=>{if(typeof data==="function"){data(ev);}
else if(Array.isArray(data)){data=filterOutModifiersFromData(data).data;data[0](data[1],ev);}
return false;},};class VToggler{constructor(key,child){this.key=key;this.child=child;}
mount(parent,afterNode){this.parentEl=parent;this.child.mount(parent,afterNode);}
moveBeforeDOMNode(node,parent){this.child.moveBeforeDOMNode(node,parent);}
moveBeforeVNode(other,afterNode){this.moveBeforeDOMNode((other&&other.firstNode())||afterNode);}
patch(other,withBeforeRemove){if(this===other){return;}
let child1=this.child;let child2=other.child;if(this.key===other.key){child1.patch(child2,withBeforeRemove);}
else{child2.mount(this.parentEl,child1.firstNode());if(withBeforeRemove){child1.beforeRemove();}
child1.remove();this.child=child2;this.key=other.key;}}
beforeRemove(){this.child.beforeRemove();}
remove(){this.child.remove();}
firstNode(){return this.child.firstNode();}
toString(){return this.child.toString();}}
function toggler(key,child){return new VToggler(key,child);}
class OwlError extends Error{}
const{setAttribute:elemSetAttribute,removeAttribute}=Element.prototype;const tokenList=DOMTokenList.prototype;const tokenListAdd=tokenList.add;const tokenListRemove=tokenList.remove;const isArray=Array.isArray;const{split,trim}=String.prototype;const wordRegexp=/\s+/;function setAttribute(key,value){switch(value){case false:case undefined:removeAttribute.call(this,key);break;case true:elemSetAttribute.call(this,key,"");break;default:elemSetAttribute.call(this,key,value);}}
function createAttrUpdater(attr){return function(value){setAttribute.call(this,attr,value);};}
function attrsSetter(attrs){if(isArray(attrs)){if(attrs[0]==="class"){setClass.call(this,attrs[1]);}
else{setAttribute.call(this,attrs[0],attrs[1]);}}
else{for(let k in attrs){if(k==="class"){setClass.call(this,attrs[k]);}
else{setAttribute.call(this,k,attrs[k]);}}}}
function attrsUpdater(attrs,oldAttrs){if(isArray(attrs)){const name=attrs[0];const val=attrs[1];if(name===oldAttrs[0]){if(val===oldAttrs[1]){return;}
if(name==="class"){updateClass.call(this,val,oldAttrs[1]);}
else{setAttribute.call(this,name,val);}}
else{removeAttribute.call(this,oldAttrs[0]);setAttribute.call(this,name,val);}}
else{for(let k in oldAttrs){if(!(k in attrs)){if(k==="class"){updateClass.call(this,"",oldAttrs[k]);}
else{removeAttribute.call(this,k);}}}
for(let k in attrs){const val=attrs[k];if(val!==oldAttrs[k]){if(k==="class"){updateClass.call(this,val,oldAttrs[k]);}
else{setAttribute.call(this,k,val);}}}}}
function toClassObj(expr){const result={};switch(typeof expr){case"string":const str=trim.call(expr);if(!str){return{};}
let words=split.call(str,wordRegexp);for(let i=0,l=words.length;i<l;i++){result[words[i]]=true;}
return result;case"object":for(let key in expr){const value=expr[key];if(value){key=trim.call(key);if(!key){continue;}
const words=split.call(key,wordRegexp);for(let word of words){result[word]=value;}}}
return result;case"undefined":return{};case"number":return{[expr]:true};default:return{[expr]:true};}}
function setClass(val){val=val===""?{}:toClassObj(val);const cl=this.classList;for(let c in val){tokenListAdd.call(cl,c);}}
function updateClass(val,oldVal){oldVal=oldVal===""?{}:toClassObj(oldVal);val=val===""?{}:toClassObj(val);const cl=this.classList;for(let c in oldVal){if(!(c in val)){tokenListRemove.call(cl,c);}}
for(let c in val){if(!(c in oldVal)){tokenListAdd.call(cl,c);}}}
function batched(callback){let scheduled=false;return async(...args)=>{if(!scheduled){scheduled=true;await Promise.resolve();scheduled=false;callback(...args);}};}
function inOwnerDocument(el){if(!el){return false;}
if(el.ownerDocument.contains(el)){return true;}
const rootNode=el.getRootNode();return rootNode instanceof ShadowRoot&&el.ownerDocument.contains(rootNode.host);}
function validateTarget(target){const document=target&&target.ownerDocument;if(document){const HTMLElement=document.defaultView.HTMLElement;if(target instanceof HTMLElement||target instanceof ShadowRoot){if(!document.body.contains(target instanceof HTMLElement?target:target.host)){throw new OwlError("Cannot mount a component on a detached dom node");}
return;}}
throw new OwlError("Cannot mount component: the target is not a valid DOM element");}
class EventBus extends EventTarget{trigger(name,payload){this.dispatchEvent(new CustomEvent(name,{detail:payload}));}}
function whenReady(fn){return new Promise(function(resolve){if(document.readyState!=="loading"){resolve(true);}
else{document.addEventListener("DOMContentLoaded",resolve,false);}}).then(fn||function(){});}
async function loadFile(url){const result=await fetch(url);if(!result.ok){throw new OwlError("Error while fetching xml templates");}
return await result.text();}
class Markup extends String{}
function markup(value){return new Markup(value);}
function createEventHandler(rawEvent){const eventName=rawEvent.split(".")[0];const capture=rawEvent.includes(".capture");if(rawEvent.includes(".synthetic")){return createSyntheticHandler(eventName,capture);}
else{return createElementHandler(eventName,capture);}}
let nextNativeEventId=1;function createElementHandler(evName,capture=false){let eventKey=`__event__${evName}_${nextNativeEventId++}`;if(capture){eventKey=`${eventKey}_capture`;}
function listener(ev){const currentTarget=ev.currentTarget;if(!currentTarget||!inOwnerDocument(currentTarget))
return;const data=currentTarget[eventKey];if(!data)
return;config.mainEventHandler(data,ev,currentTarget);}
function setup(data){this[eventKey]=data;this.addEventListener(evName,listener,{capture});}
function remove(){delete this[eventKey];this.removeEventListener(evName,listener,{capture});}
function update(data){this[eventKey]=data;}
return{setup,update,remove};}
let nextSyntheticEventId=1;function createSyntheticHandler(evName,capture=false){let eventKey=`__event__synthetic_${evName}`;if(capture){eventKey=`${eventKey}_capture`;}
setupSyntheticEvent(evName,eventKey,capture);const currentId=nextSyntheticEventId++;function setup(data){const _data=this[eventKey]||{};_data[currentId]=data;this[eventKey]=_data;}
function remove(){delete this[eventKey];}
return{setup,update:setup,remove};}
function nativeToSyntheticEvent(eventKey,event){let dom=event.target;while(dom!==null){const _data=dom[eventKey];if(_data){for(const data of Object.values(_data)){const stopped=config.mainEventHandler(data,event,dom);if(stopped)
return;}}
dom=dom.parentNode;}}
const CONFIGURED_SYNTHETIC_EVENTS={};function setupSyntheticEvent(evName,eventKey,capture=false){if(CONFIGURED_SYNTHETIC_EVENTS[eventKey]){return;}
document.addEventListener(evName,(event)=>nativeToSyntheticEvent(eventKey,event),{capture,});CONFIGURED_SYNTHETIC_EVENTS[eventKey]=true;}
const getDescriptor$3=(o,p)=>Object.getOwnPropertyDescriptor(o,p);const nodeProto$4=Node.prototype;const nodeInsertBefore$3=nodeProto$4.insertBefore;const nodeSetTextContent$1=getDescriptor$3(nodeProto$4,"textContent").set;const nodeRemoveChild$3=nodeProto$4.removeChild;class VMulti{constructor(children){this.children=children;}
mount(parent,afterNode){const children=this.children;const l=children.length;const anchors=new Array(l);for(let i=0;i<l;i++){let child=children[i];if(child){child.mount(parent,afterNode);}
else{const childAnchor=document.createTextNode("");anchors[i]=childAnchor;nodeInsertBefore$3.call(parent,childAnchor,afterNode);}}
this.anchors=anchors;this.parentEl=parent;}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;const children=this.children;const anchors=this.anchors;for(let i=0,l=children.length;i<l;i++){let child=children[i];if(child){child.moveBeforeDOMNode(node,parent);}
else{const anchor=anchors[i];nodeInsertBefore$3.call(parent,anchor,node);}}}
moveBeforeVNode(other,afterNode){if(other){const next=other.children[0];afterNode=(next?next.firstNode():other.anchors[0])||null;}
const children=this.children;const parent=this.parentEl;const anchors=this.anchors;for(let i=0,l=children.length;i<l;i++){let child=children[i];if(child){child.moveBeforeVNode(null,afterNode);}
else{const anchor=anchors[i];nodeInsertBefore$3.call(parent,anchor,afterNode);}}}
patch(other,withBeforeRemove){if(this===other){return;}
const children1=this.children;const children2=other.children;const anchors=this.anchors;const parentEl=this.parentEl;for(let i=0,l=children1.length;i<l;i++){const vn1=children1[i];const vn2=children2[i];if(vn1){if(vn2){vn1.patch(vn2,withBeforeRemove);}
else{const afterNode=vn1.firstNode();const anchor=document.createTextNode("");anchors[i]=anchor;nodeInsertBefore$3.call(parentEl,anchor,afterNode);if(withBeforeRemove){vn1.beforeRemove();}
vn1.remove();children1[i]=undefined;}}
else if(vn2){children1[i]=vn2;const anchor=anchors[i];vn2.mount(parentEl,anchor);nodeRemoveChild$3.call(parentEl,anchor);}}}
beforeRemove(){const children=this.children;for(let i=0,l=children.length;i<l;i++){const child=children[i];if(child){child.beforeRemove();}}}
remove(){const parentEl=this.parentEl;if(this.isOnlyChild){nodeSetTextContent$1.call(parentEl,"");}
else{const children=this.children;const anchors=this.anchors;for(let i=0,l=children.length;i<l;i++){const child=children[i];if(child){child.remove();}
else{nodeRemoveChild$3.call(parentEl,anchors[i]);}}}}
firstNode(){const child=this.children[0];return child?child.firstNode():this.anchors[0];}
toString(){return this.children.map((c)=>(c?c.toString():"")).join("");}}
function multi(children){return new VMulti(children);}
const getDescriptor$2=(o,p)=>Object.getOwnPropertyDescriptor(o,p);const nodeProto$3=Node.prototype;const characterDataProto$1=CharacterData.prototype;const nodeInsertBefore$2=nodeProto$3.insertBefore;const characterDataSetData$1=getDescriptor$2(characterDataProto$1,"data").set;const nodeRemoveChild$2=nodeProto$3.removeChild;class VSimpleNode{constructor(text){this.text=text;}
mountNode(node,parent,afterNode){this.parentEl=parent;nodeInsertBefore$2.call(parent,node,afterNode);this.el=node;}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;nodeInsertBefore$2.call(parent,this.el,node);}
moveBeforeVNode(other,afterNode){nodeInsertBefore$2.call(this.parentEl,this.el,other?other.el:afterNode);}
beforeRemove(){}
remove(){nodeRemoveChild$2.call(this.parentEl,this.el);}
firstNode(){return this.el;}
toString(){return this.text;}}
class VText$1 extends VSimpleNode{mount(parent,afterNode){this.mountNode(document.createTextNode(toText(this.text)),parent,afterNode);}
patch(other){const text2=other.text;if(this.text!==text2){characterDataSetData$1.call(this.el,toText(text2));this.text=text2;}}}
class VComment extends VSimpleNode{mount(parent,afterNode){this.mountNode(document.createComment(toText(this.text)),parent,afterNode);}
patch(){}}
function text(str){return new VText$1(str);}
function comment(str){return new VComment(str);}
function toText(value){switch(typeof value){case"string":return value;case"number":return String(value);case"boolean":return value?"true":"false";default:return value||"";}}
const getDescriptor$1=(o,p)=>Object.getOwnPropertyDescriptor(o,p);const nodeProto$2=Node.prototype;const elementProto=Element.prototype;const characterDataProto=CharacterData.prototype;const characterDataSetData=getDescriptor$1(characterDataProto,"data").set;const nodeGetFirstChild=getDescriptor$1(nodeProto$2,"firstChild").get;const nodeGetNextSibling=getDescriptor$1(nodeProto$2,"nextSibling").get;const NO_OP=()=>{};function makePropSetter(name){return function setProp(value){this[name]=value===0?0:value?value.valueOf():"";};}
const cache$1={};function createBlock(str){if(str in cache$1){return cache$1[str];}
const doc=new DOMParser().parseFromString(`<t>${str}</t>`,"text/xml");const node=doc.firstChild.firstChild;if(config.shouldNormalizeDom){normalizeNode(node);}
const tree=buildTree(node);const context=buildContext(tree);const template=tree.el;const Block=buildBlock(template,context);cache$1[str]=Block;return Block;}
function normalizeNode(node){if(node.nodeType===Node.TEXT_NODE){if(!/\S/.test(node.textContent)){node.remove();return;}}
if(node.nodeType===Node.ELEMENT_NODE){if(node.tagName==="pre"){return;}}
for(let i=node.childNodes.length-1;i>=0;--i){normalizeNode(node.childNodes.item(i));}}
function buildTree(node,parent=null,domParentTree=null){switch(node.nodeType){case Node.ELEMENT_NODE:{let currentNS=domParentTree&&domParentTree.currentNS;const tagName=node.tagName;let el=undefined;const info=[];if(tagName.startsWith("block-text-")){const index=parseInt(tagName.slice(11),10);info.push({type:"text",idx:index});el=document.createTextNode("");}
if(tagName.startsWith("block-child-")){if(!domParentTree.isRef){addRef(domParentTree);}
const index=parseInt(tagName.slice(12),10);info.push({type:"child",idx:index});el=document.createTextNode("");}
currentNS||(currentNS=node.namespaceURI);if(!el){el=currentNS?document.createElementNS(currentNS,tagName):document.createElement(tagName);}
if(el instanceof Element){if(!domParentTree){const fragment=document.createElement("template").content;fragment.appendChild(el);}
const attrs=node.attributes;for(let i=0;i<attrs.length;i++){const attrName=attrs[i].name;const attrValue=attrs[i].value;if(attrName.startsWith("block-handler-")){const idx=parseInt(attrName.slice(14),10);info.push({type:"handler",idx,event:attrValue,});}
else if(attrName.startsWith("block-attribute-")){const idx=parseInt(attrName.slice(16),10);info.push({type:"attribute",idx,name:attrValue,tag:tagName,});}
else if(attrName.startsWith("block-property-")){const idx=parseInt(attrName.slice(15),10);info.push({type:"property",idx,name:attrValue,tag:tagName,});}
else if(attrName==="block-attributes"){info.push({type:"attributes",idx:parseInt(attrValue,10),});}
else if(attrName==="block-ref"){info.push({type:"ref",idx:parseInt(attrValue,10),});}
else{el.setAttribute(attrs[i].name,attrValue);}}}
const tree={parent,firstChild:null,nextSibling:null,el,info,refN:0,currentNS,};if(node.firstChild){const childNode=node.childNodes[0];if(node.childNodes.length===1&&childNode.nodeType===Node.ELEMENT_NODE&&childNode.tagName.startsWith("block-child-")){const tagName=childNode.tagName;const index=parseInt(tagName.slice(12),10);info.push({idx:index,type:"child",isOnlyChild:true});}
else{tree.firstChild=buildTree(node.firstChild,tree,tree);el.appendChild(tree.firstChild.el);let curNode=node.firstChild;let curTree=tree.firstChild;while((curNode=curNode.nextSibling)){curTree.nextSibling=buildTree(curNode,curTree,tree);el.appendChild(curTree.nextSibling.el);curTree=curTree.nextSibling;}}}
if(tree.info.length){addRef(tree);}
return tree;}
case Node.TEXT_NODE:case Node.COMMENT_NODE:{const el=node.nodeType===Node.TEXT_NODE?document.createTextNode(node.textContent):document.createComment(node.textContent);return{parent:parent,firstChild:null,nextSibling:null,el,info:[],refN:0,currentNS:null,};}}
throw new OwlError("boom");}
function addRef(tree){tree.isRef=true;do{tree.refN++;}while((tree=tree.parent));}
function parentTree(tree){let parent=tree.parent;while(parent&&parent.nextSibling===tree){tree=parent;parent=parent.parent;}
return parent;}
function buildContext(tree,ctx,fromIdx){if(!ctx){const children=new Array(tree.info.filter((v)=>v.type==="child").length);ctx={collectors:[],locations:[],children,cbRefs:[],refN:tree.refN,refList:[]};fromIdx=0;}
if(tree.refN){const initialIdx=fromIdx;const isRef=tree.isRef;const firstChild=tree.firstChild?tree.firstChild.refN:0;const nextSibling=tree.nextSibling?tree.nextSibling.refN:0;if(isRef){for(let info of tree.info){info.refIdx=initialIdx;}
tree.refIdx=initialIdx;updateCtx(ctx,tree);fromIdx++;}
if(nextSibling){const idx=fromIdx+firstChild;ctx.collectors.push({idx,prevIdx:initialIdx,getVal:nodeGetNextSibling});buildContext(tree.nextSibling,ctx,idx);}
if(firstChild){ctx.collectors.push({idx:fromIdx,prevIdx:initialIdx,getVal:nodeGetFirstChild});buildContext(tree.firstChild,ctx,fromIdx);}}
return ctx;}
function updateCtx(ctx,tree){for(let info of tree.info){switch(info.type){case"text":ctx.locations.push({idx:info.idx,refIdx:info.refIdx,setData:setText,updateData:setText,});break;case"child":if(info.isOnlyChild){ctx.children[info.idx]={parentRefIdx:info.refIdx,isOnlyChild:true,};}
else{ctx.children[info.idx]={parentRefIdx:parentTree(tree).refIdx,afterRefIdx:info.refIdx,};}
break;case"property":{const refIdx=info.refIdx;const setProp=makePropSetter(info.name);ctx.locations.push({idx:info.idx,refIdx,setData:setProp,updateData:setProp,});break;}
case"attribute":{const refIdx=info.refIdx;let updater;let setter;if(info.name==="class"){setter=setClass;updater=updateClass;}
else{setter=createAttrUpdater(info.name);updater=setter;}
ctx.locations.push({idx:info.idx,refIdx,setData:setter,updateData:updater,});break;}
case"attributes":ctx.locations.push({idx:info.idx,refIdx:info.refIdx,setData:attrsSetter,updateData:attrsUpdater,});break;case"handler":{const{setup,update}=createEventHandler(info.event);ctx.locations.push({idx:info.idx,refIdx:info.refIdx,setData:setup,updateData:update,});break;}
case"ref":const index=ctx.cbRefs.push(info.idx)-1;ctx.locations.push({idx:info.idx,refIdx:info.refIdx,setData:makeRefSetter(index,ctx.refList),updateData:NO_OP,});}}}
function buildBlock(template,ctx){let B=createBlockClass(template,ctx);if(ctx.cbRefs.length){const cbRefs=ctx.cbRefs;const refList=ctx.refList;let cbRefsNumber=cbRefs.length;B=class extends B{mount(parent,afterNode){refList.push(new Array(cbRefsNumber));super.mount(parent,afterNode);for(let cbRef of refList.pop()){cbRef();}}
remove(){super.remove();for(let cbRef of cbRefs){let fn=this.data[cbRef];fn(null);}}};}
if(ctx.children.length){B=class extends B{constructor(data,children){super(data);this.children=children;}};B.prototype.beforeRemove=VMulti.prototype.beforeRemove;return(data,children=[])=>new B(data,children);}
return(data)=>new B(data);}
function createBlockClass(template,ctx){const{refN,collectors,children}=ctx;const colN=collectors.length;ctx.locations.sort((a,b)=>a.idx-b.idx);const locations=ctx.locations.map((loc)=>({refIdx:loc.refIdx,setData:loc.setData,updateData:loc.updateData,}));const locN=locations.length;const childN=children.length;const childrenLocs=children;const isDynamic=refN>0;const nodeCloneNode=nodeProto$2.cloneNode;const nodeInsertBefore=nodeProto$2.insertBefore;const elementRemove=elementProto.remove;class Block{constructor(data){this.data=data;}
beforeRemove(){}
remove(){elementRemove.call(this.el);}
firstNode(){return this.el;}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;nodeInsertBefore.call(parent,this.el,node);}
moveBeforeVNode(other,afterNode){nodeInsertBefore.call(this.parentEl,this.el,other?other.el:afterNode);}
toString(){const div=document.createElement("div");this.mount(div,null);return div.innerHTML;}
mount(parent,afterNode){const el=nodeCloneNode.call(template,true);nodeInsertBefore.call(parent,el,afterNode);this.el=el;this.parentEl=parent;}
patch(other,withBeforeRemove){}}
if(isDynamic){Block.prototype.mount=function mount(parent,afterNode){const el=nodeCloneNode.call(template,true);const refs=new Array(refN);this.refs=refs;refs[0]=el;for(let i=0;i<colN;i++){const w=collectors[i];refs[w.idx]=w.getVal.call(refs[w.prevIdx]);}
if(locN){const data=this.data;for(let i=0;i<locN;i++){const loc=locations[i];loc.setData.call(refs[loc.refIdx],data[i]);}}
nodeInsertBefore.call(parent,el,afterNode);if(childN){const children=this.children;for(let i=0;i<childN;i++){const child=children[i];if(child){const loc=childrenLocs[i];const afterNode=loc.afterRefIdx?refs[loc.afterRefIdx]:null;child.isOnlyChild=loc.isOnlyChild;child.mount(refs[loc.parentRefIdx],afterNode);}}}
this.el=el;this.parentEl=parent;};Block.prototype.patch=function patch(other,withBeforeRemove){if(this===other){return;}
const refs=this.refs;if(locN){const data1=this.data;const data2=other.data;for(let i=0;i<locN;i++){const val1=data1[i];const val2=data2[i];if(val1!==val2){const loc=locations[i];loc.updateData.call(refs[loc.refIdx],val2,val1);}}
this.data=data2;}
if(childN){let children1=this.children;const children2=other.children;for(let i=0;i<childN;i++){const child1=children1[i];const child2=children2[i];if(child1){if(child2){child1.patch(child2,withBeforeRemove);}
else{if(withBeforeRemove){child1.beforeRemove();}
child1.remove();children1[i]=undefined;}}
else if(child2){const loc=childrenLocs[i];const afterNode=loc.afterRefIdx?refs[loc.afterRefIdx]:null;child2.mount(refs[loc.parentRefIdx],afterNode);children1[i]=child2;}}}};}
return Block;}
function setText(value){characterDataSetData.call(this,toText(value));}
function makeRefSetter(index,refs){return function setRef(fn){refs[refs.length-1][index]=()=>fn(this);};}
const getDescriptor=(o,p)=>Object.getOwnPropertyDescriptor(o,p);const nodeProto$1=Node.prototype;const nodeInsertBefore$1=nodeProto$1.insertBefore;const nodeAppendChild=nodeProto$1.appendChild;const nodeRemoveChild$1=nodeProto$1.removeChild;const nodeSetTextContent=getDescriptor(nodeProto$1,"textContent").set;class VList{constructor(children){this.children=children;}
mount(parent,afterNode){const children=this.children;const _anchor=document.createTextNode("");this.anchor=_anchor;nodeInsertBefore$1.call(parent,_anchor,afterNode);const l=children.length;if(l){const mount=children[0].mount;for(let i=0;i<l;i++){mount.call(children[i],parent,_anchor);}}
this.parentEl=parent;}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;const children=this.children;for(let i=0,l=children.length;i<l;i++){children[i].moveBeforeDOMNode(node,parent);}
parent.insertBefore(this.anchor,node);}
moveBeforeVNode(other,afterNode){if(other){const next=other.children[0];afterNode=(next?next.firstNode():other.anchor)||null;}
const children=this.children;for(let i=0,l=children.length;i<l;i++){children[i].moveBeforeVNode(null,afterNode);}
this.parentEl.insertBefore(this.anchor,afterNode);}
patch(other,withBeforeRemove){if(this===other){return;}
const ch1=this.children;const ch2=other.children;if(ch2.length===0&&ch1.length===0){return;}
this.children=ch2;const proto=ch2[0]||ch1[0];const{mount:cMount,patch:cPatch,remove:cRemove,beforeRemove,moveBeforeVNode:cMoveBefore,firstNode:cFirstNode,}=proto;const _anchor=this.anchor;const isOnlyChild=this.isOnlyChild;const parent=this.parentEl;if(ch2.length===0&&isOnlyChild){if(withBeforeRemove){for(let i=0,l=ch1.length;i<l;i++){beforeRemove.call(ch1[i]);}}
nodeSetTextContent.call(parent,"");nodeAppendChild.call(parent,_anchor);return;}
let startIdx1=0;let startIdx2=0;let startVn1=ch1[0];let startVn2=ch2[0];let endIdx1=ch1.length-1;let endIdx2=ch2.length-1;let endVn1=ch1[endIdx1];let endVn2=ch2[endIdx2];let mapping=undefined;while(startIdx1<=endIdx1&&startIdx2<=endIdx2){if(startVn1===null){startVn1=ch1[++startIdx1];continue;}
if(endVn1===null){endVn1=ch1[--endIdx1];continue;}
let startKey1=startVn1.key;let startKey2=startVn2.key;if(startKey1===startKey2){cPatch.call(startVn1,startVn2,withBeforeRemove);ch2[startIdx2]=startVn1;startVn1=ch1[++startIdx1];startVn2=ch2[++startIdx2];continue;}
let endKey1=endVn1.key;let endKey2=endVn2.key;if(endKey1===endKey2){cPatch.call(endVn1,endVn2,withBeforeRemove);ch2[endIdx2]=endVn1;endVn1=ch1[--endIdx1];endVn2=ch2[--endIdx2];continue;}
if(startKey1===endKey2){cPatch.call(startVn1,endVn2,withBeforeRemove);ch2[endIdx2]=startVn1;const nextChild=ch2[endIdx2+1];cMoveBefore.call(startVn1,nextChild,_anchor);startVn1=ch1[++startIdx1];endVn2=ch2[--endIdx2];continue;}
if(endKey1===startKey2){cPatch.call(endVn1,startVn2,withBeforeRemove);ch2[startIdx2]=endVn1;const nextChild=ch1[startIdx1];cMoveBefore.call(endVn1,nextChild,_anchor);endVn1=ch1[--endIdx1];startVn2=ch2[++startIdx2];continue;}
mapping=mapping||createMapping(ch1,startIdx1,endIdx1);let idxInOld=mapping[startKey2];if(idxInOld===undefined){cMount.call(startVn2,parent,cFirstNode.call(startVn1)||null);}
else{const elmToMove=ch1[idxInOld];cMoveBefore.call(elmToMove,startVn1,null);cPatch.call(elmToMove,startVn2,withBeforeRemove);ch2[startIdx2]=elmToMove;ch1[idxInOld]=null;}
startVn2=ch2[++startIdx2];}
if(startIdx1<=endIdx1||startIdx2<=endIdx2){if(startIdx1>endIdx1){const nextChild=ch2[endIdx2+1];const anchor=nextChild?cFirstNode.call(nextChild)||null:_anchor;for(let i=startIdx2;i<=endIdx2;i++){cMount.call(ch2[i],parent,anchor);}}
else{for(let i=startIdx1;i<=endIdx1;i++){let ch=ch1[i];if(ch){if(withBeforeRemove){beforeRemove.call(ch);}
cRemove.call(ch);}}}}}
beforeRemove(){const children=this.children;const l=children.length;if(l){const beforeRemove=children[0].beforeRemove;for(let i=0;i<l;i++){beforeRemove.call(children[i]);}}}
remove(){const{parentEl,anchor}=this;if(this.isOnlyChild){nodeSetTextContent.call(parentEl,"");}
else{const children=this.children;const l=children.length;if(l){const remove=children[0].remove;for(let i=0;i<l;i++){remove.call(children[i]);}}
nodeRemoveChild$1.call(parentEl,anchor);}}
firstNode(){const child=this.children[0];return child?child.firstNode():undefined;}
toString(){return this.children.map((c)=>c.toString()).join("");}}
function list(children){return new VList(children);}
function createMapping(ch1,startIdx1,endIdx2){let mapping={};for(let i=startIdx1;i<=endIdx2;i++){mapping[ch1[i].key]=i;}
return mapping;}
const nodeProto=Node.prototype;const nodeInsertBefore=nodeProto.insertBefore;const nodeRemoveChild=nodeProto.removeChild;class VHtml{constructor(html){this.content=[];this.html=html;}
mount(parent,afterNode){this.parentEl=parent;const template=document.createElement("template");template.innerHTML=this.html;this.content=[...template.content.childNodes];for(let elem of this.content){nodeInsertBefore.call(parent,elem,afterNode);}
if(!this.content.length){const textNode=document.createTextNode("");this.content.push(textNode);nodeInsertBefore.call(parent,textNode,afterNode);}}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;for(let elem of this.content){nodeInsertBefore.call(parent,elem,node);}}
moveBeforeVNode(other,afterNode){const target=other?other.content[0]:afterNode;this.moveBeforeDOMNode(target);}
patch(other){if(this===other){return;}
const html2=other.html;if(this.html!==html2){const parent=this.parentEl;const afterNode=this.content[0];const template=document.createElement("template");template.innerHTML=html2;const content=[...template.content.childNodes];for(let elem of content){nodeInsertBefore.call(parent,elem,afterNode);}
if(!content.length){const textNode=document.createTextNode("");content.push(textNode);nodeInsertBefore.call(parent,textNode,afterNode);}
this.remove();this.content=content;this.html=other.html;}}
beforeRemove(){}
remove(){const parent=this.parentEl;for(let elem of this.content){nodeRemoveChild.call(parent,elem);}}
firstNode(){return this.content[0];}
toString(){return this.html;}}
function html(str){return new VHtml(str);}
function createCatcher(eventsSpec){const n=Object.keys(eventsSpec).length;class VCatcher{constructor(child,handlers){this.handlerFns=[];this.afterNode=null;this.child=child;this.handlerData=handlers;}
mount(parent,afterNode){this.parentEl=parent;this.child.mount(parent,afterNode);this.afterNode=document.createTextNode("");parent.insertBefore(this.afterNode,afterNode);this.wrapHandlerData();for(let name in eventsSpec){const index=eventsSpec[name];const handler=createEventHandler(name);this.handlerFns[index]=handler;handler.setup.call(parent,this.handlerData[index]);}}
wrapHandlerData(){for(let i=0;i<n;i++){let handler=this.handlerData[i];let idx=handler.length-2;let origFn=handler[idx];const self=this;handler[idx]=function(ev){const target=ev.target;let currentNode=self.child.firstNode();const afterNode=self.afterNode;while(currentNode&&currentNode!==afterNode){if(currentNode.contains(target)){return origFn.call(this,ev);}
currentNode=currentNode.nextSibling;}};}}
moveBeforeDOMNode(node,parent=this.parentEl){this.parentEl=parent;this.child.moveBeforeDOMNode(node,parent);parent.insertBefore(this.afterNode,node);}
moveBeforeVNode(other,afterNode){if(other){afterNode=other.firstNode()||afterNode;}
this.child.moveBeforeVNode(other?other.child:null,afterNode);this.parentEl.insertBefore(this.afterNode,afterNode);}
patch(other,withBeforeRemove){if(this===other){return;}
this.handlerData=other.handlerData;this.wrapHandlerData();for(let i=0;i<n;i++){this.handlerFns[i].update.call(this.parentEl,this.handlerData[i]);}
this.child.patch(other.child,withBeforeRemove);}
beforeRemove(){this.child.beforeRemove();}
remove(){for(let i=0;i<n;i++){this.handlerFns[i].remove.call(this.parentEl);}
this.child.remove();this.afterNode.remove();}
firstNode(){return this.child.firstNode();}
toString(){return this.child.toString();}}
return function(child,handlers){return new VCatcher(child,handlers);};}
function mount$1(vnode,fixture,afterNode=null){vnode.mount(fixture,afterNode);}
function patch(vnode1,vnode2,withBeforeRemove=false){vnode1.patch(vnode2,withBeforeRemove);}
function remove(vnode,withBeforeRemove=false){if(withBeforeRemove){vnode.beforeRemove();}
vnode.remove();}
const fibersInError=new WeakMap();const nodeErrorHandlers=new WeakMap();function _handleError(node,error){if(!node){return false;}
const fiber=node.fiber;if(fiber){fibersInError.set(fiber,error);}
const errorHandlers=nodeErrorHandlers.get(node);if(errorHandlers){let handled=false;for(let i=errorHandlers.length-1;i>=0;i--){try{errorHandlers[i](error);handled=true;break;}
catch(e){error=e;}}
if(handled){return true;}}
return _handleError(node.parent,error);}
function handleError(params){let{error}=params;if(!(error instanceof OwlError)){error=Object.assign(new OwlError(`An error occured in the owl lifecycle (see this Error's "cause" property)`),{cause:error});}
const node="node"in params?params.node:params.fiber.node;const fiber="fiber"in params?params.fiber:node.fiber;if(fiber){let current=fiber;do{current.node.fiber=current;current=current.parent;}while(current);fibersInError.set(fiber.root,error);}
const handled=_handleError(node,error);if(!handled){console.warn(`[Owl] Unhandled error. Destroying the root component`);try{node.app.destroy();}
catch(e){console.error(e);}
throw error;}}
function makeChildFiber(node,parent){let current=node.fiber;if(current){cancelFibers(current.children);current.root=null;}
return new Fiber(node,parent);}
function makeRootFiber(node){let current=node.fiber;if(current){let root=current.root;root.locked=true;root.setCounter(root.counter+1-cancelFibers(current.children));root.locked=false;current.children=[];current.childrenMap={};current.bdom=null;if(fibersInError.has(current)){fibersInError.delete(current);fibersInError.delete(root);current.appliedToDom=false;}
return current;}
const fiber=new RootFiber(node,null);if(node.willPatch.length){fiber.willPatch.push(fiber);}
if(node.patched.length){fiber.patched.push(fiber);}
return fiber;}
function throwOnRender(){throw new OwlError("Attempted to render cancelled fiber");}
function cancelFibers(fibers){let result=0;for(let fiber of fibers){let node=fiber.node;fiber.render=throwOnRender;if(node.status===0){node.cancel();}
node.fiber=null;if(fiber.bdom){node.forceNextRender=true;}
else{result++;}
result+=cancelFibers(fiber.children);}
return result;}
class Fiber{constructor(node,parent){this.bdom=null;this.children=[];this.appliedToDom=false;this.deep=false;this.childrenMap={};this.node=node;this.parent=parent;if(parent){this.deep=parent.deep;const root=parent.root;root.setCounter(root.counter+1);this.root=root;parent.children.push(this);}
else{this.root=this;}}
render(){let prev=this.root.node;let scheduler=prev.app.scheduler;let current=prev.parent;while(current){if(current.fiber){let root=current.fiber.root;if(root.counter===0&&prev.parentKey in current.fiber.childrenMap){current=root.node;}
else{scheduler.delayedRenders.push(this);return;}}
prev=current;current=current.parent;}
this._render();}
_render(){const node=this.node;const root=this.root;if(root){try{this.bdom=true;this.bdom=node.renderFn();}
catch(e){node.app.handleError({node,error:e});}
root.setCounter(root.counter-1);}}}
class RootFiber extends Fiber{constructor(){super(...arguments);this.counter=1;this.willPatch=[];this.patched=[];this.mounted=[];this.locked=false;}
complete(){const node=this.node;this.locked=true;let current=undefined;try{for(current of this.willPatch){let node=current.node;if(node.fiber===current){const component=node.component;for(let cb of node.willPatch){cb.call(component);}}}
current=undefined;node._patch();this.locked=false;let mountedFibers=this.mounted;while((current=mountedFibers.pop())){current=current;if(current.appliedToDom){for(let cb of current.node.mounted){cb();}}}
let patchedFibers=this.patched;while((current=patchedFibers.pop())){current=current;if(current.appliedToDom){for(let cb of current.node.patched){cb();}}}}
catch(e){this.locked=false;node.app.handleError({fiber:current||this,error:e});}}
setCounter(newValue){this.counter=newValue;if(newValue===0){this.node.app.scheduler.flush();}}}
class MountFiber extends RootFiber{constructor(node,target,options={}){super(node,null);this.target=target;this.position=options.position||"last-child";}
complete(){let current=this;try{const node=this.node;node.children=this.childrenMap;node.app.constructor.validateTarget(this.target);if(node.bdom){node.updateDom();}
else{node.bdom=this.bdom;if(this.position==="last-child"||this.target.childNodes.length===0){mount$1(node.bdom,this.target);}
else{const firstChild=this.target.childNodes[0];mount$1(node.bdom,this.target,firstChild);}}
node.fiber=null;node.status=1;this.appliedToDom=true;let mountedFibers=this.mounted;while((current=mountedFibers.pop())){if(current.appliedToDom){for(let cb of current.node.mounted){cb();}}}}
catch(e){this.node.app.handleError({fiber:current,error:e});}}}
const KEYCHANGES=Symbol("Key changes");const NO_CALLBACK=()=>{throw new Error("Called NO_CALLBACK. Owl is broken, please report this to the maintainers.");};const objectToString=Object.prototype.toString;const objectHasOwnProperty=Object.prototype.hasOwnProperty;const SUPPORTED_RAW_TYPES=["Object","Array","Set","Map","WeakMap"];const COLLECTION_RAW_TYPES=["Set","Map","WeakMap"];function rawType(obj){return objectToString.call(toRaw(obj)).slice(8,-1);}
function canBeMadeReactive(value){if(typeof value!=="object"){return false;}
return SUPPORTED_RAW_TYPES.includes(rawType(value));}
function possiblyReactive(val,cb){return canBeMadeReactive(val)?reactive(val,cb):val;}
const skipped=new WeakSet();function markRaw(value){skipped.add(value);return value;}
function toRaw(value){return targets.has(value)?targets.get(value):value;}
const targetToKeysToCallbacks=new WeakMap();function observeTargetKey(target,key,callback){if(callback===NO_CALLBACK){return;}
if(!targetToKeysToCallbacks.get(target)){targetToKeysToCallbacks.set(target,new Map());}
const keyToCallbacks=targetToKeysToCallbacks.get(target);if(!keyToCallbacks.get(key)){keyToCallbacks.set(key,new Set());}
keyToCallbacks.get(key).add(callback);if(!callbacksToTargets.has(callback)){callbacksToTargets.set(callback,new Set());}
callbacksToTargets.get(callback).add(target);}
function notifyReactives(target,key){const keyToCallbacks=targetToKeysToCallbacks.get(target);if(!keyToCallbacks){return;}
const callbacks=keyToCallbacks.get(key);if(!callbacks){return;}
for(const callback of[...callbacks]){clearReactivesForCallback(callback);callback();}}
const callbacksToTargets=new WeakMap();function clearReactivesForCallback(callback){const targetsToClear=callbacksToTargets.get(callback);if(!targetsToClear){return;}
for(const target of targetsToClear){const observedKeys=targetToKeysToCallbacks.get(target);if(!observedKeys){continue;}
for(const[key,callbacks]of observedKeys.entries()){callbacks.delete(callback);if(!callbacks.size){observedKeys.delete(key);}}}
targetsToClear.clear();}
function getSubscriptions(callback){const targets=callbacksToTargets.get(callback)||[];return[...targets].map((target)=>{const keysToCallbacks=targetToKeysToCallbacks.get(target);let keys=[];if(keysToCallbacks){for(const[key,cbs]of keysToCallbacks){if(cbs.has(callback)){keys.push(key);}}}
return{target,keys};});}
const targets=new WeakMap();const reactiveCache=new WeakMap();function reactive(target,callback=NO_CALLBACK){if(!canBeMadeReactive(target)){throw new OwlError(`Cannot make the given value reactive`);}
if(skipped.has(target)){return target;}
if(targets.has(target)){return reactive(targets.get(target),callback);}
if(!reactiveCache.has(target)){reactiveCache.set(target,new WeakMap());}
const reactivesForTarget=reactiveCache.get(target);if(!reactivesForTarget.has(callback)){const targetRawType=rawType(target);const handler=COLLECTION_RAW_TYPES.includes(targetRawType)?collectionsProxyHandler(target,callback,targetRawType):basicProxyHandler(callback);const proxy=new Proxy(target,handler);reactivesForTarget.set(callback,proxy);targets.set(proxy,target);}
return reactivesForTarget.get(callback);}
function basicProxyHandler(callback){return{get(target,key,receiver){const desc=Object.getOwnPropertyDescriptor(target,key);if(desc&&!desc.writable&&!desc.configurable){return Reflect.get(target,key,receiver);}
observeTargetKey(target,key,callback);return possiblyReactive(Reflect.get(target,key,receiver),callback);},set(target,key,value,receiver){const hadKey=objectHasOwnProperty.call(target,key);const originalValue=Reflect.get(target,key,receiver);const ret=Reflect.set(target,key,toRaw(value),receiver);if(!hadKey&&objectHasOwnProperty.call(target,key)){notifyReactives(target,KEYCHANGES);}
if(originalValue!==Reflect.get(target,key,receiver)||(key==="length"&&Array.isArray(target))){notifyReactives(target,key);}
return ret;},deleteProperty(target,key){const ret=Reflect.deleteProperty(target,key);notifyReactives(target,KEYCHANGES);notifyReactives(target,key);return ret;},ownKeys(target){observeTargetKey(target,KEYCHANGES,callback);return Reflect.ownKeys(target);},has(target,key){observeTargetKey(target,KEYCHANGES,callback);return Reflect.has(target,key);},};}
function makeKeyObserver(methodName,target,callback){return(key)=>{key=toRaw(key);observeTargetKey(target,key,callback);return possiblyReactive(target[methodName](key),callback);};}
function makeIteratorObserver(methodName,target,callback){return function*(){observeTargetKey(target,KEYCHANGES,callback);const keys=target.keys();for(const item of target[methodName]()){const key=keys.next().value;observeTargetKey(target,key,callback);yield possiblyReactive(item,callback);}};}
function makeForEachObserver(target,callback){return function forEach(forEachCb,thisArg){observeTargetKey(target,KEYCHANGES,callback);target.forEach(function(val,key,targetObj){observeTargetKey(target,key,callback);forEachCb.call(thisArg,possiblyReactive(val,callback),possiblyReactive(key,callback),possiblyReactive(targetObj,callback));},thisArg);};}
function delegateAndNotify(setterName,getterName,target){return(key,value)=>{key=toRaw(key);const hadKey=target.has(key);const originalValue=target[getterName](key);const ret=target[setterName](key,value);const hasKey=target.has(key);if(hadKey!==hasKey){notifyReactives(target,KEYCHANGES);}
if(originalValue!==target[getterName](key)){notifyReactives(target,key);}
return ret;};}
function makeClearNotifier(target){return()=>{const allKeys=[...target.keys()];target.clear();notifyReactives(target,KEYCHANGES);for(const key of allKeys){notifyReactives(target,key);}};}
const rawTypeToFuncHandlers={Set:(target,callback)=>({has:makeKeyObserver("has",target,callback),add:delegateAndNotify("add","has",target),delete:delegateAndNotify("delete","has",target),keys:makeIteratorObserver("keys",target,callback),values:makeIteratorObserver("values",target,callback),entries:makeIteratorObserver("entries",target,callback),[Symbol.iterator]:makeIteratorObserver(Symbol.iterator,target,callback),forEach:makeForEachObserver(target,callback),clear:makeClearNotifier(target),get size(){observeTargetKey(target,KEYCHANGES,callback);return target.size;},}),Map:(target,callback)=>({has:makeKeyObserver("has",target,callback),get:makeKeyObserver("get",target,callback),set:delegateAndNotify("set","get",target),delete:delegateAndNotify("delete","has",target),keys:makeIteratorObserver("keys",target,callback),values:makeIteratorObserver("values",target,callback),entries:makeIteratorObserver("entries",target,callback),[Symbol.iterator]:makeIteratorObserver(Symbol.iterator,target,callback),forEach:makeForEachObserver(target,callback),clear:makeClearNotifier(target),get size(){observeTargetKey(target,KEYCHANGES,callback);return target.size;},}),WeakMap:(target,callback)=>({has:makeKeyObserver("has",target,callback),get:makeKeyObserver("get",target,callback),set:delegateAndNotify("set","get",target),delete:delegateAndNotify("delete","has",target),}),};function collectionsProxyHandler(target,callback,targetRawType){const specialHandlers=rawTypeToFuncHandlers[targetRawType](target,callback);return Object.assign(basicProxyHandler(callback),{get(target,key){if(objectHasOwnProperty.call(specialHandlers,key)){return specialHandlers[key];}
observeTargetKey(target,key,callback);return possiblyReactive(target[key],callback);},});}
let currentNode=null;function getCurrent(){if(!currentNode){throw new OwlError("No active component (a hook function should only be called in 'setup')");}
return currentNode;}
function useComponent(){return currentNode.component;}
function applyDefaultProps(props,defaultProps){for(let propName in defaultProps){if(props[propName]===undefined){props[propName]=defaultProps[propName];}}}
const batchedRenderFunctions=new WeakMap();function useState(state){const node=getCurrent();let render=batchedRenderFunctions.get(node);if(!render){render=batched(node.render.bind(node,false));batchedRenderFunctions.set(node,render);node.willDestroy.push(clearReactivesForCallback.bind(null,render));}
return reactive(state,render);}
class ComponentNode{constructor(C,props,app,parent,parentKey){this.fiber=null;this.bdom=null;this.status=0;this.forceNextRender=false;this.nextProps=null;this.children=Object.create(null);this.refs={};this.willStart=[];this.willUpdateProps=[];this.willUnmount=[];this.mounted=[];this.willPatch=[];this.patched=[];this.willDestroy=[];currentNode=this;this.app=app;this.parent=parent;this.props=props;this.parentKey=parentKey;const defaultProps=C.defaultProps;props=Object.assign({},props);if(defaultProps){applyDefaultProps(props,defaultProps);}
const env=(parent&&parent.childEnv)||app.env;this.childEnv=env;for(const key in props){const prop=props[key];if(prop&&typeof prop==="object"&&targets.has(prop)){props[key]=useState(prop);}}
this.component=new C(props,env,this);const ctx=Object.assign(Object.create(this.component),{this:this.component});this.renderFn=app.getTemplate(C.template).bind(this.component,ctx,this);this.component.setup();currentNode=null;}
mountComponent(target,options){const fiber=new MountFiber(this,target,options);this.app.scheduler.addFiber(fiber);this.initiateRender(fiber);}
async initiateRender(fiber){this.fiber=fiber;if(this.mounted.length){fiber.root.mounted.push(fiber);}
const component=this.component;try{await Promise.all(this.willStart.map((f)=>f.call(component)));}
catch(e){this.app.handleError({node:this,error:e});return;}
if(this.status===0&&this.fiber===fiber){fiber.render();}}
async render(deep){if(this.status>=2){return;}
let current=this.fiber;if(current&&(current.root.locked||current.bdom===true)){await Promise.resolve();current=this.fiber;}
if(current){if(!current.bdom&&!fibersInError.has(current)){if(deep){current.deep=deep;}
return;}
deep=deep||current.deep;}
else if(!this.bdom){return;}
const fiber=makeRootFiber(this);fiber.deep=deep;this.fiber=fiber;this.app.scheduler.addFiber(fiber);await Promise.resolve();if(this.status>=2){return;}
if(this.fiber===fiber&&(current||!fiber.parent)){fiber.render();}}
cancel(){this._cancel();delete this.parent.children[this.parentKey];this.app.scheduler.scheduleDestroy(this);}
_cancel(){this.status=2;const children=this.children;for(let childKey in children){children[childKey]._cancel();}}
destroy(){let shouldRemove=this.status===1;this._destroy();if(shouldRemove){this.bdom.remove();}}
_destroy(){const component=this.component;if(this.status===1){for(let cb of this.willUnmount){cb.call(component);}}
for(let child of Object.values(this.children)){child._destroy();}
if(this.willDestroy.length){try{for(let cb of this.willDestroy){cb.call(component);}}
catch(e){this.app.handleError({error:e,node:this});}}
this.status=3;}
async updateAndRender(props,parentFiber){this.nextProps=props;props=Object.assign({},props);const fiber=makeChildFiber(this,parentFiber);this.fiber=fiber;const component=this.component;const defaultProps=component.constructor.defaultProps;if(defaultProps){applyDefaultProps(props,defaultProps);}
currentNode=this;for(const key in props){const prop=props[key];if(prop&&typeof prop==="object"&&targets.has(prop)){props[key]=useState(prop);}}
currentNode=null;const prom=Promise.all(this.willUpdateProps.map((f)=>f.call(component,props)));await prom;if(fiber!==this.fiber){return;}
component.props=props;fiber.render();const parentRoot=parentFiber.root;if(this.willPatch.length){parentRoot.willPatch.push(fiber);}
if(this.patched.length){parentRoot.patched.push(fiber);}}
updateDom(){if(!this.fiber){return;}
if(this.bdom===this.fiber.bdom){for(let k in this.children){const child=this.children[k];child.updateDom();}}
else{this.bdom.patch(this.fiber.bdom,false);this.fiber.appliedToDom=true;this.fiber=null;}}
setRef(name,el){if(el){this.refs[name]=el;}}
firstNode(){const bdom=this.bdom;return bdom?bdom.firstNode():undefined;}
mount(parent,anchor){const bdom=this.fiber.bdom;this.bdom=bdom;bdom.mount(parent,anchor);this.status=1;this.fiber.appliedToDom=true;this.children=this.fiber.childrenMap;this.fiber=null;}
moveBeforeDOMNode(node,parent){this.bdom.moveBeforeDOMNode(node,parent);}
moveBeforeVNode(other,afterNode){this.bdom.moveBeforeVNode(other?other.bdom:null,afterNode);}
patch(){if(this.fiber&&this.fiber.parent){this._patch();this.props=this.nextProps;}}
_patch(){let hasChildren=false;for(let _k in this.children){hasChildren=true;break;}
const fiber=this.fiber;this.children=fiber.childrenMap;this.bdom.patch(fiber.bdom,hasChildren);fiber.appliedToDom=true;this.fiber=null;}
beforeRemove(){this._destroy();}
remove(){this.bdom.remove();}
get name(){return this.component.constructor.name;}
get subscriptions(){const render=batchedRenderFunctions.get(this);return render?getSubscriptions(render):[];}}
const TIMEOUT=Symbol("timeout");function wrapError(fn,hookName){const error=new OwlError(`The following error occurred in ${hookName}: `);const timeoutError=new OwlError(`${hookName}'s promise hasn't resolved after 3 seconds`);const node=getCurrent();return(...args)=>{const onError=(cause)=>{error.cause=cause;if(cause instanceof Error){error.message+=`"${cause.message}"`;}
else{error.message=`Something that is not an Error was thrown in ${hookName} (see this Error's "cause" property)`;}
throw error;};try{const result=fn(...args);if(result instanceof Promise){if(hookName==="onWillStart"||hookName==="onWillUpdateProps"){const fiber=node.fiber;Promise.race([result.catch(()=>{}),new Promise((resolve)=>setTimeout(()=>resolve(TIMEOUT),3000)),]).then((res)=>{if(res===TIMEOUT&&node.fiber===fiber){console.warn(timeoutError);}});}
return result.catch(onError);}
return result;}
catch(cause){onError(cause);}};}
function onWillStart(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.willStart.push(decorate(fn.bind(node.component),"onWillStart"));}
function onWillUpdateProps(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.willUpdateProps.push(decorate(fn.bind(node.component),"onWillUpdateProps"));}
function onMounted(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.mounted.push(decorate(fn.bind(node.component),"onMounted"));}
function onWillPatch(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.willPatch.unshift(decorate(fn.bind(node.component),"onWillPatch"));}
function onPatched(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.patched.push(decorate(fn.bind(node.component),"onPatched"));}
function onWillUnmount(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.willUnmount.unshift(decorate(fn.bind(node.component),"onWillUnmount"));}
function onWillDestroy(fn){const node=getCurrent();const decorate=node.app.dev?wrapError:(fn)=>fn;node.willDestroy.push(decorate(fn.bind(node.component),"onWillDestroy"));}
function onWillRender(fn){const node=getCurrent();const renderFn=node.renderFn;const decorate=node.app.dev?wrapError:(fn)=>fn;fn=decorate(fn.bind(node.component),"onWillRender");node.renderFn=()=>{fn();return renderFn();};}
function onRendered(fn){const node=getCurrent();const renderFn=node.renderFn;const decorate=node.app.dev?wrapError:(fn)=>fn;fn=decorate(fn.bind(node.component),"onRendered");node.renderFn=()=>{const result=renderFn();fn();return result;};}
function onError(callback){const node=getCurrent();let handlers=nodeErrorHandlers.get(node);if(!handlers){handlers=[];nodeErrorHandlers.set(node,handlers);}
handlers.push(callback.bind(node.component));}
class Component{constructor(props,env,node){this.props=props;this.env=env;this.__owl__=node;}
setup(){}
render(deep=false){this.__owl__.render(deep===true);}}
Component.template="";const VText=text("").constructor;class VPortal extends VText{constructor(selector,content){super("");this.target=null;this.selector=selector;this.content=content;}
mount(parent,anchor){super.mount(parent,anchor);this.target=document.querySelector(this.selector);if(this.target){this.content.mount(this.target,null);}
else{this.content.mount(parent,anchor);}}
beforeRemove(){this.content.beforeRemove();}
remove(){if(this.content){super.remove();this.content.remove();this.content=null;}}
patch(other){super.patch(other);if(this.content){this.content.patch(other.content,true);}
else{this.content=other.content;this.content.mount(this.target,null);}}}
function portalTemplate(app,bdom,helpers){let{callSlot}=helpers;return function template(ctx,node,key=""){return new VPortal(ctx.props.target,callSlot(ctx,node,key,"default",false,null));};}
class Portal extends Component{setup(){const node=this.__owl__;onMounted(()=>{const portal=node.bdom;if(!portal.target){const target=document.querySelector(this.props.target);if(target){portal.content.moveBeforeDOMNode(target.firstChild,target);}
else{throw new OwlError("invalid portal target");}}});onWillUnmount(()=>{const portal=node.bdom;portal.remove();});}}
Portal.template="__portal__";Portal.props={target:{type:String,},slots:true,};const isUnionType=(t)=>Array.isArray(t);const isBaseType=(t)=>typeof t!=="object";const isValueType=(t)=>typeof t==="object"&&t&&"value"in t;function isOptional(t){return typeof t==="object"&&"optional"in t?t.optional||false:false;}
function describeType(type){return type==="*"||type===true?"value":type.name.toLowerCase();}
function describe(info){if(isBaseType(info)){return describeType(info);}
else if(isUnionType(info)){return info.map(describe).join(" or ");}
else if(isValueType(info)){return String(info.value);}
if("element"in info){return`list of ${describe({ type: info.element, optional: false })}s`;}
if("shape"in info){return`object`;}
return describe(info.type||"*");}
function toSchema(spec){return Object.fromEntries(spec.map((e)=>e.endsWith("?")?[e.slice(0,-1),{optional:true}]:[e,{type:"*",optional:false}]));}
function validate(obj,spec){let errors=validateSchema(obj,spec);if(errors.length){throw new OwlError("Invalid object: "+errors.join(", "));}}
function validateSchema(obj,schema){if(Array.isArray(schema)){schema=toSchema(schema);}
obj=toRaw(obj);let errors=[];for(let key in obj){if(key in schema){let result=validateType(key,obj[key],schema[key]);if(result){errors.push(result);}}
else if(!("*"in schema)){errors.push(`unknown key '${key}'`);}}
for(let key in schema){const spec=schema[key];if(key!=="*"&&!isOptional(spec)&&!(key in obj)){const isObj=typeof spec==="object"&&!Array.isArray(spec);const isAny=spec==="*"||(isObj&&"type"in spec?spec.type==="*":isObj);let detail=isAny?"":` (should be a ${describe(spec)})`;errors.push(`'${key}' is missing${detail}`);}}
return errors;}
function validateBaseType(key,value,type){if(typeof type==="function"){if(typeof value==="object"){if(!(value instanceof type)){return`'${key}' is not a ${describeType(type)}`;}}
else if(typeof value!==type.name.toLowerCase()){return`'${key}' is not a ${describeType(type)}`;}}
return null;}
function validateArrayType(key,value,descr){if(!Array.isArray(value)){return`'${key}' is not a list of ${describe(descr)}s`;}
for(let i=0;i<value.length;i++){const error=validateType(`${key}[${i}]`,value[i],descr);if(error){return error;}}
return null;}
function validateType(key,value,descr){if(value===undefined){return isOptional(descr)?null:`'${key}' is undefined (should be a ${describe(descr)})`;}
else if(isBaseType(descr)){return validateBaseType(key,value,descr);}
else if(isValueType(descr)){return value===descr.value?null:`'${key}' is not equal to '${descr.value}'`;}
else if(isUnionType(descr)){let validDescr=descr.find((p)=>!validateType(key,value,p));return validDescr?null:`'${key}' is not a ${describe(descr)}`;}
let result=null;if("element"in descr){result=validateArrayType(key,value,descr.element);}
else if("shape"in descr){if(typeof value!=="object"||Array.isArray(value)){result=`'${key}' is not an object`;}
else{const errors=validateSchema(value,descr.shape);if(errors.length){result=`'${key}' doesn't have the correct shape (${errors.join(", ")})`;}}}
else if("values"in descr){if(typeof value!=="object"||Array.isArray(value)){result=`'${key}' is not an object`;}
else{const errors=Object.entries(value).map(([key,value])=>validateType(key,value,descr.values)).filter(Boolean);if(errors.length){result=`some of the values in '${key}' are invalid (${errors.join(", ")})`;}}}
if("type"in descr&&!result){result=validateType(key,value,descr.type);}
if("validate"in descr&&!result){result=!descr.validate(value)?`'${key}' is not valid`:null;}
return result;}
const ObjectCreate=Object.create;function withDefault(value,defaultValue){return value===undefined||value===null||value===false?defaultValue:value;}
function callSlot(ctx,parent,key,name,dynamic,extra,defaultContent){key=key+"__slot_"+name;const slots=ctx.props.slots||{};const{__render,__ctx,__scope}=slots[name]||{};const slotScope=ObjectCreate(__ctx||{});if(__scope){slotScope[__scope]=extra;}
const slotBDom=__render?__render(slotScope,parent,key):null;if(defaultContent){let child1=undefined;let child2=undefined;if(slotBDom){child1=dynamic?toggler(name,slotBDom):slotBDom;}
else{child2=defaultContent(ctx,parent,key);}
return multi([child1,child2]);}
return slotBDom||text("");}
function capture(ctx){const result=ObjectCreate(ctx);for(let k in ctx){result[k]=ctx[k];}
return result;}
function withKey(elem,k){elem.key=k;return elem;}
function prepareList(collection){let keys;let values;if(Array.isArray(collection)){keys=collection;values=collection;}
else if(collection instanceof Map){keys=[...collection.keys()];values=[...collection.values()];}
else if(Symbol.iterator in Object(collection)){keys=[...collection];values=keys;}
else if(collection&&typeof collection==="object"){values=Object.values(collection);keys=Object.keys(collection);}
else{throw new OwlError(`Invalid loop expression: "${collection}" is not iterable`);}
const n=values.length;return[keys,values,n,new Array(n)];}
const isBoundary=Symbol("isBoundary");function setContextValue(ctx,key,value){const ctx0=ctx;while(!ctx.hasOwnProperty(key)&&!ctx.hasOwnProperty(isBoundary)){const newCtx=ctx.__proto__;if(!newCtx){ctx=ctx0;break;}
ctx=newCtx;}
ctx[key]=value;}
function toNumber(val){const n=parseFloat(val);return isNaN(n)?val:n;}
function shallowEqual(l1,l2){for(let i=0,l=l1.length;i<l;i++){if(l1[i]!==l2[i]){return false;}}
return true;}
class LazyValue{constructor(fn,ctx,component,node,key){this.fn=fn;this.ctx=capture(ctx);this.component=component;this.node=node;this.key=key;}
evaluate(){return this.fn.call(this.component,this.ctx,this.node,this.key);}
toString(){return this.evaluate().toString();}}
function safeOutput(value,defaultValue){if(value===undefined||value===null){return defaultValue?toggler("default",defaultValue):toggler("undefined",text(""));}
let safeKey;let block;switch(typeof value){case"object":if(value instanceof Markup){safeKey=`string_safe`;block=html(value);}
else if(value instanceof LazyValue){safeKey=`lazy_value`;block=value.evaluate();}
else if(value instanceof String){safeKey="string_unsafe";block=text(value);}
else{safeKey="block_safe";block=value;}
break;case"string":safeKey="string_unsafe";block=text(value);break;default:safeKey="string_unsafe";block=text(String(value));}
return toggler(safeKey,block);}
function validateProps(name,props,comp){const ComponentClass=typeof name!=="string"?name:comp.constructor.components[name];if(!ComponentClass){return;}
const schema=ComponentClass.props;if(!schema){if(comp.__owl__.app.warnIfNoStaticProps){console.warn(`Component '${ComponentClass.name}' does not have a static props description`);}
return;}
const defaultProps=ComponentClass.defaultProps;if(defaultProps){let isMandatory=(name)=>Array.isArray(schema)?schema.includes(name):name in schema&&!("*"in schema)&&!isOptional(schema[name]);for(let p in defaultProps){if(isMandatory(p)){throw new OwlError(`A default value cannot be defined for a mandatory prop (name: '${p}', component: ${ComponentClass.name})`);}}}
const errors=validateSchema(props,schema);if(errors.length){throw new OwlError(`Invalid props for component '${ComponentClass.name}': `+errors.join(", "));}}
function makeRefWrapper(node){let refNames=new Set();return(name,fn)=>{if(refNames.has(name)){throw new OwlError(`Cannot set the same ref more than once in the same component, ref "${name}" was set multiple times in ${node.name}`);}
refNames.add(name);return fn;};}
const helpers={withDefault,zero:Symbol("zero"),isBoundary,callSlot,capture,withKey,prepareList,setContextValue,shallowEqual,toNumber,validateProps,LazyValue,safeOutput,createCatcher,markRaw,OwlError,makeRefWrapper,};function parseXML(xml){const parser=new DOMParser();const doc=parser.parseFromString(xml,"text/xml");if(doc.getElementsByTagName("parsererror").length){let msg="Invalid XML in template.";const parsererrorText=doc.getElementsByTagName("parsererror")[0].textContent;if(parsererrorText){msg+="\nThe parser has produced the following error message:\n"+parsererrorText;const re=/\d+/g;const firstMatch=re.exec(parsererrorText);if(firstMatch){const lineNumber=Number(firstMatch[0]);const line=xml.split("\n")[lineNumber-1];const secondMatch=re.exec(parsererrorText);if(line&&secondMatch){const columnIndex=Number(secondMatch[0])-1;if(line[columnIndex]){msg+=`\nThe error might be located at xml line ${lineNumber} column ${columnIndex}\n`+`${line}\n${"-".repeat(columnIndex - 1)}^`;}}}}
throw new OwlError(msg);}
return doc;}
const bdom={text,createBlock,list,multi,html,toggler,comment};class TemplateSet{constructor(config={}){this.rawTemplates=Object.create(globalTemplates);this.templates={};this.Portal=Portal;this.dev=config.dev||false;this.translateFn=config.translateFn;this.translatableAttributes=config.translatableAttributes;if(config.templates){if(config.templates instanceof Document||typeof config.templates==="string"){this.addTemplates(config.templates);}
else{for(const name in config.templates){this.addTemplate(name,config.templates[name]);}}}
this.getRawTemplate=config.getTemplate;}
static registerTemplate(name,fn){globalTemplates[name]=fn;}
addTemplate(name,template){if(name in this.rawTemplates){if(!this.dev){return;}
const rawTemplate=this.rawTemplates[name];const currentAsString=typeof rawTemplate==="string"?rawTemplate:rawTemplate instanceof Element?rawTemplate.outerHTML:rawTemplate.toString();const newAsString=typeof template==="string"?template:template.outerHTML;if(currentAsString===newAsString){return;}
throw new OwlError(`Template ${name} already defined with different content`);}
this.rawTemplates[name]=template;}
addTemplates(xml){if(!xml){return;}
xml=xml instanceof Document?xml:parseXML(xml);for(const template of xml.querySelectorAll("[t-name]")){const name=template.getAttribute("t-name");this.addTemplate(name,template);}}
getTemplate(name){var _a;if(!(name in this.templates)){const rawTemplate=((_a=this.getRawTemplate)===null||_a===void 0?void 0:_a.call(this,name))||this.rawTemplates[name];if(rawTemplate===undefined){let extraInfo="";try{const componentName=getCurrent().component.constructor.name;extraInfo=` (for component "${componentName}")`;}
catch{}
throw new OwlError(`Missing template: "${name}"${extraInfo}`);}
const isFn=typeof rawTemplate==="function"&&!(rawTemplate instanceof Element);const templateFn=isFn?rawTemplate:this._compileTemplate(name,rawTemplate);const templates=this.templates;this.templates[name]=function(context,parent){return templates[name].call(this,context,parent);};const template=templateFn(this,bdom,helpers);this.templates[name]=template;}
return this.templates[name];}
_compileTemplate(name,template){throw new OwlError(`Unable to compile a template. Please use owl full build instead`);}
callTemplate(owner,subTemplate,ctx,parent,key){const template=this.getTemplate(subTemplate);return toggler(subTemplate,template.call(owner,ctx,parent,key+subTemplate));}}
const globalTemplates={};function xml(...args){const name=`__template__${xml.nextId++}`;const value=String.raw(...args);globalTemplates[name]=value;return name;}
xml.nextId=1;TemplateSet.registerTemplate("__portal__",portalTemplate);const RESERVED_WORDS="true,false,NaN,null,undefined,debugger,console,window,in,instanceof,new,function,return,eval,void,Math,RegExp,Array,Object,Date".split(",");const WORD_REPLACEMENT=Object.assign(Object.create(null),{and:"&&",or:"||",gt:">",gte:">=",lt:"<",lte:"<=",});const STATIC_TOKEN_MAP=Object.assign(Object.create(null),{"{":"LEFT_BRACE","}":"RIGHT_BRACE","[":"LEFT_BRACKET","]":"RIGHT_BRACKET",":":"COLON",",":"COMMA","(":"LEFT_PAREN",")":"RIGHT_PAREN",});const OPERATORS="...,.,===,==,+,!==,!=,!,||,&&,>=,>,<=,<,?,-,*,/,%,typeof ,=>,=,;,in ,new ,|,&,^,~".split(",");let tokenizeString=function(expr){let s=expr[0];let start=s;if(s!=="'"&&s!=='"'&&s!=="`"){return false;}
let i=1;let cur;while(expr[i]&&expr[i]!==start){cur=expr[i];s+=cur;if(cur==="\\"){i++;cur=expr[i];if(!cur){throw new OwlError("Invalid expression");}
s+=cur;}
i++;}
if(expr[i]!==start){throw new OwlError("Invalid expression");}
s+=start;if(start==="`"){return{type:"TEMPLATE_STRING",value:s,replace(replacer){return s.replace(/\$\{(.*?)\}/g,(match,group)=>{return"${"+replacer(group)+"}";});},};}
return{type:"VALUE",value:s};};let tokenizeNumber=function(expr){let s=expr[0];if(s&&s.match(/[0-9]/)){let i=1;while(expr[i]&&expr[i].match(/[0-9]|\./)){s+=expr[i];i++;}
return{type:"VALUE",value:s};}
else{return false;}};let tokenizeSymbol=function(expr){let s=expr[0];if(s&&s.match(/[a-zA-Z_\$]/)){let i=1;while(expr[i]&&expr[i].match(/\w/)){s+=expr[i];i++;}
if(s in WORD_REPLACEMENT){return{type:"OPERATOR",value:WORD_REPLACEMENT[s],size:s.length};}
return{type:"SYMBOL",value:s};}
else{return false;}};const tokenizeStatic=function(expr){const char=expr[0];if(char&&char in STATIC_TOKEN_MAP){return{type:STATIC_TOKEN_MAP[char],value:char};}
return false;};const tokenizeOperator=function(expr){for(let op of OPERATORS){if(expr.startsWith(op)){return{type:"OPERATOR",value:op};}}
return false;};const TOKENIZERS=[tokenizeString,tokenizeNumber,tokenizeOperator,tokenizeSymbol,tokenizeStatic,];function tokenize(expr){const result=[];let token=true;let error;let current=expr;try{while(token){current=current.trim();if(current){for(let tokenizer of TOKENIZERS){token=tokenizer(current);if(token){result.push(token);current=current.slice(token.size||token.value.length);break;}}}
else{token=false;}}}
catch(e){error=e;}
if(current.length||error){throw new OwlError(`Tokenizer error: could not tokenize \`${expr}\``);}
return result;}
const isLeftSeparator=(token)=>token&&(token.type==="LEFT_BRACE"||token.type==="COMMA");const isRightSeparator=(token)=>token&&(token.type==="RIGHT_BRACE"||token.type==="COMMA");function compileExprToArray(expr){const localVars=new Set();const tokens=tokenize(expr);let i=0;let stack=[];while(i<tokens.length){let token=tokens[i];let prevToken=tokens[i-1];let nextToken=tokens[i+1];let groupType=stack[stack.length-1];switch(token.type){case"LEFT_BRACE":case"LEFT_BRACKET":stack.push(token.type);break;case"RIGHT_BRACE":case"RIGHT_BRACKET":stack.pop();}
let isVar=token.type==="SYMBOL"&&!RESERVED_WORDS.includes(token.value);if(token.type==="SYMBOL"&&!RESERVED_WORDS.includes(token.value)){if(prevToken){if(groupType==="LEFT_BRACE"&&isLeftSeparator(prevToken)&&isRightSeparator(nextToken)){tokens.splice(i+1,0,{type:"COLON",value:":"},{...token});nextToken=tokens[i+1];}
if(prevToken.type==="OPERATOR"&&prevToken.value==="."){isVar=false;}
else if(prevToken.type==="LEFT_BRACE"||prevToken.type==="COMMA"){if(nextToken&&nextToken.type==="COLON"){isVar=false;}}}}
if(token.type==="TEMPLATE_STRING"){token.value=token.replace((expr)=>compileExpr(expr));}
if(nextToken&&nextToken.type==="OPERATOR"&&nextToken.value==="=>"){if(token.type==="RIGHT_PAREN"){let j=i-1;while(j>0&&tokens[j].type!=="LEFT_PAREN"){if(tokens[j].type==="SYMBOL"&&tokens[j].originalValue){tokens[j].value=tokens[j].originalValue;localVars.add(tokens[j].value);}
j--;}}
else{localVars.add(token.value);}}
if(isVar){token.varName=token.value;if(!localVars.has(token.value)){token.originalValue=token.value;token.value=`ctx['${token.value}']`;}}
i++;}
for(const token of tokens){if(token.type==="SYMBOL"&&token.varName&&localVars.has(token.value)){token.originalValue=token.value;token.value=`_${token.value}`;token.isLocal=true;}}
return tokens;}
const paddedValues=new Map([["in "," in "]]);function compileExpr(expr){return compileExprToArray(expr).map((t)=>paddedValues.get(t.value)||t.value).join("");}
const INTERP_REGEXP=/\{\{.*?\}\}|\#\{.*?\}/g;function replaceDynamicParts(s,replacer){let matches=s.match(INTERP_REGEXP);if(matches&&matches[0].length===s.length){return`(${replacer(s.slice(2, matches[0][0] === "{" ? -2 : -1))})`;}
let r=s.replace(INTERP_REGEXP,(s)=>"${"+replacer(s.slice(2,s[0]==="{"?-2:-1))+"}");return"`"+r+"`";}
function interpolate(s){return replaceDynamicParts(s,compileExpr);}
const whitespaceRE=/\s+/g;const xmlDoc=document.implementation.createDocument(null,null,null);const MODS=new Set(["stop","capture","prevent","self","synthetic"]);let nextDataIds={};function generateId(prefix=""){nextDataIds[prefix]=(nextDataIds[prefix]||0)+1;return prefix+nextDataIds[prefix];}
function isProp(tag,key){switch(tag){case"input":return(key==="checked"||key==="indeterminate"||key==="value"||key==="readonly"||key==="readOnly"||key==="disabled");case"option":return key==="selected"||key==="disabled";case"textarea":return key==="value"||key==="readonly"||key==="readOnly"||key==="disabled";case"select":return key==="value"||key==="disabled";case"button":case"optgroup":return key==="disabled";}
return false;}
class BlockDescription{constructor(target,type){this.dynamicTagName=null;this.isRoot=false;this.hasDynamicChildren=false;this.children=[];this.data=[];this.childNumber=0;this.parentVar="";this.id=BlockDescription.nextBlockId++;this.varName="b"+this.id;this.blockName="block"+this.id;this.target=target;this.type=type;}
insertData(str,prefix="d"){const id=generateId(prefix);this.target.addLine(`let ${id} = ${str};`);return this.data.push(id)-1;}
insert(dom){if(this.currentDom){this.currentDom.appendChild(dom);}
else{this.dom=dom;}}
generateExpr(expr){if(this.type==="block"){const hasChildren=this.children.length;let params=this.data.length?`[${this.data.join(", ")}]`:hasChildren?"[]":"";if(hasChildren){params+=", ["+this.children.map((c)=>c.varName).join(", ")+"]";}
if(this.dynamicTagName){return`toggler(${this.dynamicTagName}, ${this.blockName}(${this.dynamicTagName})(${params}))`;}
return`${this.blockName}(${params})`;}
else if(this.type==="list"){return`list(c_block${this.id})`;}
return expr;}
asXmlString(){const t=xmlDoc.createElement("t");t.appendChild(this.dom);return t.innerHTML;}}
BlockDescription.nextBlockId=1;function createContext(parentCtx,params){return Object.assign({block:null,index:0,forceNewBlock:true,translate:parentCtx.translate,tKeyExpr:null,nameSpace:parentCtx.nameSpace,tModelSelectedExpr:parentCtx.tModelSelectedExpr,},params);}
class CodeTarget{constructor(name,on){this.indentLevel=0;this.loopLevel=0;this.code=[];this.hasRoot=false;this.hasCache=false;this.shouldProtectScope=false;this.hasRefWrapper=false;this.name=name;this.on=on||null;}
addLine(line,idx){const prefix=new Array(this.indentLevel+2).join("  ");if(idx===undefined){this.code.push(prefix+line);}
else{this.code.splice(idx,0,prefix+line);}}
generateCode(){let result=[];result.push(`function ${this.name}(ctx, node, key = "") {`);if(this.shouldProtectScope){result.push(`  ctx = Object.create(ctx);`);result.push(`  ctx[isBoundary] = 1`);}
if(this.hasRefWrapper){result.push(`  let refWrapper = makeRefWrapper(this.__owl__);`);}
if(this.hasCache){result.push(`  let cache = ctx.cache || {};`);result.push(`  let nextCache = ctx.cache = {};`);}
for(let line of this.code){result.push(line);}
if(!this.hasRoot){result.push(`return text('');`);}
result.push(`}`);return result.join("\n  ");}
currentKey(ctx){let key=this.loopLevel?`key${this.loopLevel}`:"key";if(ctx.tKeyExpr){key=`${ctx.tKeyExpr} + ${key}`;}
return key;}}
const TRANSLATABLE_ATTRS=["label","title","placeholder","alt"];const translationRE=/^(\s*)([\s\S]+?)(\s*)$/;class CodeGenerator{constructor(ast,options){this.blocks=[];this.nextBlockId=1;this.isDebug=false;this.targets=[];this.target=new CodeTarget("template");this.translatableAttributes=TRANSLATABLE_ATTRS;this.staticDefs=[];this.slotNames=new Set();this.helpers=new Set();this.translateFn=options.translateFn||((s)=>s);if(options.translatableAttributes){const attrs=new Set(TRANSLATABLE_ATTRS);for(let attr of options.translatableAttributes){if(attr.startsWith("-")){attrs.delete(attr.slice(1));}
else{attrs.add(attr);}}
this.translatableAttributes=[...attrs];}
this.hasSafeContext=options.hasSafeContext||false;this.dev=options.dev||false;this.ast=ast;this.templateName=options.name;}
generateCode(){const ast=this.ast;this.isDebug=ast.type===12;BlockDescription.nextBlockId=1;nextDataIds={};this.compileAST(ast,{block:null,index:0,forceNewBlock:false,isLast:true,translate:true,tKeyExpr:null,});let mainCode=[`  let { text, createBlock, list, multi, html, toggler, comment } = bdom;`];if(this.helpers.size){mainCode.push(`let { ${[...this.helpers].join(", ")} } = helpers;`);}
if(this.templateName){mainCode.push(`// Template name: "${this.templateName}"`);}
for(let{id,expr}of this.staticDefs){mainCode.push(`const ${id} = ${expr};`);}
if(this.blocks.length){mainCode.push(``);for(let block of this.blocks){if(block.dom){let xmlString=block.asXmlString();xmlString=xmlString.replace(/\\/g,"\\\\").replace(/`/g,"\\`");if(block.dynamicTagName){xmlString=xmlString.replace(/^<\w+/,`<\${tag || '${block.dom.nodeName}'}`);xmlString=xmlString.replace(/\w+>$/,`\${tag || '${block.dom.nodeName}'}>`);mainCode.push(`let ${block.blockName} = tag => createBlock(\`${xmlString}\`);`);}
else{mainCode.push(`let ${block.blockName} = createBlock(\`${xmlString}\`);`);}}}}
if(this.targets.length){for(let fn of this.targets){mainCode.push("");mainCode=mainCode.concat(fn.generateCode());}}
mainCode.push("");mainCode=mainCode.concat("return "+this.target.generateCode());const code=mainCode.join("\n  ");if(this.isDebug){const msg=`[Owl Debug]\n${code}`;console.log(msg);}
return code;}
compileInNewTarget(prefix,ast,ctx,on){const name=generateId(prefix);const initialTarget=this.target;const target=new CodeTarget(name,on);this.targets.push(target);this.target=target;this.compileAST(ast,createContext(ctx));this.target=initialTarget;return name;}
addLine(line,idx){this.target.addLine(line,idx);}
define(varName,expr){this.addLine(`const ${varName} = ${expr};`);}
insertAnchor(block,index=block.children.length){const tag=`block-child-${index}`;const anchor=xmlDoc.createElement(tag);block.insert(anchor);}
createBlock(parentBlock,type,ctx){const hasRoot=this.target.hasRoot;const block=new BlockDescription(this.target,type);if(!hasRoot){this.target.hasRoot=true;block.isRoot=true;}
if(parentBlock){parentBlock.children.push(block);if(parentBlock.type==="list"){block.parentVar=`c_block${parentBlock.id}`;}}
return block;}
insertBlock(expression,block,ctx){let blockExpr=block.generateExpr(expression);if(block.parentVar){let key=this.target.currentKey(ctx);this.helpers.add("withKey");this.addLine(`${block.parentVar}[${ctx.index}] = withKey(${blockExpr}, ${key});`);return;}
if(ctx.tKeyExpr){blockExpr=`toggler(${ctx.tKeyExpr}, ${blockExpr})`;}
if(block.isRoot){if(this.target.on){blockExpr=this.wrapWithEventCatcher(blockExpr,this.target.on);}
this.addLine(`return ${blockExpr};`);}
else{this.define(block.varName,blockExpr);}}
captureExpression(expr,forceCapture=false){if(!forceCapture&&!expr.includes("=>")){return compileExpr(expr);}
const tokens=compileExprToArray(expr);const mapping=new Map();return tokens.map((tok)=>{if(tok.varName&&!tok.isLocal){if(!mapping.has(tok.varName)){const varId=generateId("v");mapping.set(tok.varName,varId);this.define(varId,tok.value);}
tok.value=mapping.get(tok.varName);}
return tok.value;}).join("");}
translate(str){const match=translationRE.exec(str);return match[1]+this.translateFn(match[2])+match[3];}
compileAST(ast,ctx){switch(ast.type){case 1:return this.compileComment(ast,ctx);case 0:return this.compileText(ast,ctx);case 2:return this.compileTDomNode(ast,ctx);case 4:return this.compileTEsc(ast,ctx);case 8:return this.compileTOut(ast,ctx);case 5:return this.compileTIf(ast,ctx);case 9:return this.compileTForeach(ast,ctx);case 10:return this.compileTKey(ast,ctx);case 3:return this.compileMulti(ast,ctx);case 7:return this.compileTCall(ast,ctx);case 15:return this.compileTCallBlock(ast,ctx);case 6:return this.compileTSet(ast,ctx);case 11:return this.compileComponent(ast,ctx);case 12:return this.compileDebug(ast,ctx);case 13:return this.compileLog(ast,ctx);case 14:return this.compileTSlot(ast,ctx);case 16:return this.compileTTranslation(ast,ctx);case 17:return this.compileTPortal(ast,ctx);}}
compileDebug(ast,ctx){this.addLine(`debugger;`);if(ast.content){return this.compileAST(ast.content,ctx);}
return null;}
compileLog(ast,ctx){this.addLine(`console.log(${compileExpr(ast.expr)});`);if(ast.content){return this.compileAST(ast.content,ctx);}
return null;}
compileComment(ast,ctx){let{block,forceNewBlock}=ctx;const isNewBlock=!block||forceNewBlock;if(isNewBlock){block=this.createBlock(block,"comment",ctx);this.insertBlock(`comment(\`${ast.value}\`)`,block,{...ctx,forceNewBlock:forceNewBlock&&!block,});}
else{const text=xmlDoc.createComment(ast.value);block.insert(text);}
return block.varName;}
compileText(ast,ctx){let{block,forceNewBlock}=ctx;let value=ast.value;if(value&&ctx.translate!==false){value=this.translate(value);}
if(!ctx.inPreTag){value=value.replace(whitespaceRE," ");}
if(!block||forceNewBlock){block=this.createBlock(block,"text",ctx);this.insertBlock(`text(\`${value}\`)`,block,{...ctx,forceNewBlock:forceNewBlock&&!block,});}
else{const createFn=ast.type===0?xmlDoc.createTextNode:xmlDoc.createComment;block.insert(createFn.call(xmlDoc,value));}
return block.varName;}
generateHandlerCode(rawEvent,handler){const modifiers=rawEvent.split(".").slice(1).map((m)=>{if(!MODS.has(m)){throw new OwlError(`Unknown event modifier: '${m}'`);}
return`"${m}"`;});let modifiersCode="";if(modifiers.length){modifiersCode=`${modifiers.join(",")}, `;}
return`[${modifiersCode}${this.captureExpression(handler)}, ctx]`;}
compileTDomNode(ast,ctx){let{block,forceNewBlock}=ctx;const isNewBlock=!block||forceNewBlock||ast.dynamicTag!==null||ast.ns;let codeIdx=this.target.code.length;if(isNewBlock){if((ast.dynamicTag||ctx.tKeyExpr||ast.ns)&&ctx.block){this.insertAnchor(ctx.block);}
block=this.createBlock(block,"block",ctx);this.blocks.push(block);if(ast.dynamicTag){const tagExpr=generateId("tag");this.define(tagExpr,compileExpr(ast.dynamicTag));block.dynamicTagName=tagExpr;}}
const attrs={};for(let key in ast.attrs){let expr,attrName;if(key.startsWith("t-attf")){expr=interpolate(ast.attrs[key]);const idx=block.insertData(expr,"attr");attrName=key.slice(7);attrs["block-attribute-"+idx]=attrName;}
else if(key.startsWith("t-att")){attrName=key==="t-att"?null:key.slice(6);expr=compileExpr(ast.attrs[key]);if(attrName&&isProp(ast.tag,attrName)){if(attrName==="readonly"){attrName="readOnly";}
if(attrName==="value"){expr=`new String((${expr}) === 0 ? 0 : ((${expr}) || ""))`;}
else{expr=`new Boolean(${expr})`;}
const idx=block.insertData(expr,"prop");attrs[`block-property-${idx}`]=attrName;}
else{const idx=block.insertData(expr,"attr");if(key==="t-att"){attrs[`block-attributes`]=String(idx);}
else{attrs[`block-attribute-${idx}`]=attrName;}}}
else if(this.translatableAttributes.includes(key)){attrs[key]=this.translateFn(ast.attrs[key]);}
else{expr=`"${ast.attrs[key]}"`;attrName=key;attrs[key]=ast.attrs[key];}
if(attrName==="value"&&ctx.tModelSelectedExpr){let selectedId=block.insertData(`${ctx.tModelSelectedExpr} === ${expr}`,"attr");attrs[`block-attribute-${selectedId}`]="selected";}}
let tModelSelectedExpr;if(ast.model){const{hasDynamicChildren,baseExpr,expr,eventType,shouldNumberize,shouldTrim,targetAttr,specialInitTargetAttr,}=ast.model;const baseExpression=compileExpr(baseExpr);const bExprId=generateId("bExpr");this.define(bExprId,baseExpression);const expression=compileExpr(expr);const exprId=generateId("expr");this.define(exprId,expression);const fullExpression=`${bExprId}[${exprId}]`;let idx;if(specialInitTargetAttr){let targetExpr=targetAttr in attrs&&`'${attrs[targetAttr]}'`;if(!targetExpr&&ast.attrs){const dynamicTgExpr=ast.attrs[`t-att-${targetAttr}`];if(dynamicTgExpr){targetExpr=compileExpr(dynamicTgExpr);}}
idx=block.insertData(`${fullExpression} === ${targetExpr}`,"prop");attrs[`block-property-${idx}`]=specialInitTargetAttr;}
else if(hasDynamicChildren){const bValueId=generateId("bValue");tModelSelectedExpr=`${bValueId}`;this.define(tModelSelectedExpr,fullExpression);}
else{idx=block.insertData(`${fullExpression}`,"prop");attrs[`block-property-${idx}`]=targetAttr;}
this.helpers.add("toNumber");let valueCode=`ev.target.${targetAttr}`;valueCode=shouldTrim?`${valueCode}.trim()`:valueCode;valueCode=shouldNumberize?`toNumber(${valueCode})`:valueCode;const handler=`[(ev) => { ${fullExpression} = ${valueCode}; }]`;idx=block.insertData(handler,"hdlr");attrs[`block-handler-${idx}`]=eventType;}
for(let ev in ast.on){const name=this.generateHandlerCode(ev,ast.on[ev]);const idx=block.insertData(name,"hdlr");attrs[`block-handler-${idx}`]=ev;}
if(ast.ref){if(this.dev){this.helpers.add("makeRefWrapper");this.target.hasRefWrapper=true;}
const isDynamic=INTERP_REGEXP.test(ast.ref);let name=`\`${ast.ref}\``;if(isDynamic){name=replaceDynamicParts(ast.ref,(expr)=>this.captureExpression(expr,true));}
let setRefStr=`(el) => this.__owl__.setRef((${name}), el)`;if(this.dev){setRefStr=`refWrapper(${name}, ${setRefStr})`;}
const idx=block.insertData(setRefStr,"ref");attrs["block-ref"]=String(idx);}
const nameSpace=ast.ns||ctx.nameSpace;const dom=nameSpace?xmlDoc.createElementNS(nameSpace,ast.tag):xmlDoc.createElement(ast.tag);for(const[attr,val]of Object.entries(attrs)){if(!(attr==="class"&&val==="")){dom.setAttribute(attr,val);}}
block.insert(dom);if(ast.content.length){const initialDom=block.currentDom;block.currentDom=dom;const children=ast.content;for(let i=0;i<children.length;i++){const child=ast.content[i];const subCtx=createContext(ctx,{block,index:block.childNumber,forceNewBlock:false,isLast:ctx.isLast&&i===children.length-1,tKeyExpr:ctx.tKeyExpr,nameSpace,tModelSelectedExpr,inPreTag:ctx.inPreTag||ast.tag==="pre",});this.compileAST(child,subCtx);}
block.currentDom=initialDom;}
if(isNewBlock){this.insertBlock(`${block.blockName}(ddd)`,block,ctx);if(block.children.length&&block.hasDynamicChildren){const code=this.target.code;const children=block.children.slice();let current=children.shift();for(let i=codeIdx;i<code.length;i++){if(code[i].trimStart().startsWith(`const ${current.varName} `)){code[i]=code[i].replace(`const ${current.varName}`,current.varName);current=children.shift();if(!current)
break;}}
this.addLine(`let ${block.children.map((c) => c.varName).join(", ")};`,codeIdx);}}
return block.varName;}
compileTEsc(ast,ctx){let{block,forceNewBlock}=ctx;let expr;if(ast.expr==="0"){this.helpers.add("zero");expr=`ctx[zero]`;}
else{expr=compileExpr(ast.expr);if(ast.defaultValue){this.helpers.add("withDefault");expr=`withDefault(${expr}, \`${ast.defaultValue}\`)`;}}
if(!block||forceNewBlock){block=this.createBlock(block,"text",ctx);this.insertBlock(`text(${expr})`,block,{...ctx,forceNewBlock:forceNewBlock&&!block});}
else{const idx=block.insertData(expr,"txt");const text=xmlDoc.createElement(`block-text-${idx}`);block.insert(text);}
return block.varName;}
compileTOut(ast,ctx){let{block}=ctx;if(block){this.insertAnchor(block);}
block=this.createBlock(block,"html",ctx);let blockStr;if(ast.expr==="0"){this.helpers.add("zero");blockStr=`ctx[zero]`;}
else if(ast.body){let bodyValue=null;bodyValue=BlockDescription.nextBlockId;const subCtx=createContext(ctx);this.compileAST({type:3,content:ast.body},subCtx);this.helpers.add("safeOutput");blockStr=`safeOutput(${compileExpr(ast.expr)}, b${bodyValue})`;}
else{this.helpers.add("safeOutput");blockStr=`safeOutput(${compileExpr(ast.expr)})`;}
this.insertBlock(blockStr,block,ctx);return block.varName;}
compileTIfBranch(content,block,ctx){this.target.indentLevel++;let childN=block.children.length;this.compileAST(content,createContext(ctx,{block,index:ctx.index}));if(block.children.length>childN){this.insertAnchor(block,childN);}
this.target.indentLevel--;}
compileTIf(ast,ctx,nextNode){let{block,forceNewBlock}=ctx;const codeIdx=this.target.code.length;const isNewBlock=!block||(block.type!=="multi"&&forceNewBlock);if(block){block.hasDynamicChildren=true;}
if(!block||(block.type!=="multi"&&forceNewBlock)){block=this.createBlock(block,"multi",ctx);}
this.addLine(`if (${compileExpr(ast.condition)}) {`);this.compileTIfBranch(ast.content,block,ctx);if(ast.tElif){for(let clause of ast.tElif){this.addLine(`} else if (${compileExpr(clause.condition)}) {`);this.compileTIfBranch(clause.content,block,ctx);}}
if(ast.tElse){this.addLine(`} else {`);this.compileTIfBranch(ast.tElse,block,ctx);}
this.addLine("}");if(isNewBlock){if(block.children.length){const code=this.target.code;const children=block.children.slice();let current=children.shift();for(let i=codeIdx;i<code.length;i++){if(code[i].trimStart().startsWith(`const ${current.varName} `)){code[i]=code[i].replace(`const ${current.varName}`,current.varName);current=children.shift();if(!current)
break;}}
this.addLine(`let ${block.children.map((c) => c.varName).join(", ")};`,codeIdx);}
const args=block.children.map((c)=>c.varName).join(", ");this.insertBlock(`multi([${args}])`,block,ctx);}
return block.varName;}
compileTForeach(ast,ctx){let{block}=ctx;if(block){this.insertAnchor(block);}
block=this.createBlock(block,"list",ctx);this.target.loopLevel++;const loopVar=`i${this.target.loopLevel}`;this.addLine(`ctx = Object.create(ctx);`);const vals=`v_block${block.id}`;const keys=`k_block${block.id}`;const l=`l_block${block.id}`;const c=`c_block${block.id}`;this.helpers.add("prepareList");this.define(`[${keys}, ${vals}, ${l}, ${c}]`,`prepareList(${compileExpr(ast.collection)});`);if(this.dev){this.define(`keys${block.id}`,`new Set()`);}
this.addLine(`for (let ${loopVar} = 0; ${loopVar} < ${l}; ${loopVar}++) {`);this.target.indentLevel++;this.addLine(`ctx[\`${ast.elem}\`] = ${keys}[${loopVar}];`);if(!ast.hasNoFirst){this.addLine(`ctx[\`${ast.elem}_first\`] = ${loopVar} === 0;`);}
if(!ast.hasNoLast){this.addLine(`ctx[\`${ast.elem}_last\`] = ${loopVar} === ${keys}.length - 1;`);}
if(!ast.hasNoIndex){this.addLine(`ctx[\`${ast.elem}_index\`] = ${loopVar};`);}
if(!ast.hasNoValue){this.addLine(`ctx[\`${ast.elem}_value\`] = ${vals}[${loopVar}];`);}
this.define(`key${this.target.loopLevel}`,ast.key?compileExpr(ast.key):loopVar);if(this.dev){this.helpers.add("OwlError");this.addLine(`if (keys${block.id}.has(String(key${this.target.loopLevel}))) { throw new OwlError(\`Got duplicate key in t-foreach: \${key${this.target.loopLevel}}\`)}`);this.addLine(`keys${block.id}.add(String(key${this.target.loopLevel}));`);}
let id;if(ast.memo){this.target.hasCache=true;id=generateId();this.define(`memo${id}`,compileExpr(ast.memo));this.define(`vnode${id}`,`cache[key${this.target.loopLevel}];`);this.addLine(`if (vnode${id}) {`);this.target.indentLevel++;this.addLine(`if (shallowEqual(vnode${id}.memo, memo${id})) {`);this.target.indentLevel++;this.addLine(`${c}[${loopVar}] = vnode${id};`);this.addLine(`nextCache[key${this.target.loopLevel}] = vnode${id};`);this.addLine(`continue;`);this.target.indentLevel--;this.addLine("}");this.target.indentLevel--;this.addLine("}");}
const subCtx=createContext(ctx,{block,index:loopVar});this.compileAST(ast.body,subCtx);if(ast.memo){this.addLine(`nextCache[key${this.target.loopLevel}] = Object.assign(${c}[${loopVar}], {memo: memo${id}});`);}
this.target.indentLevel--;this.target.loopLevel--;this.addLine(`}`);if(!ctx.isLast){this.addLine(`ctx = ctx.__proto__;`);}
this.insertBlock("l",block,ctx);return block.varName;}
compileTKey(ast,ctx){const tKeyExpr=generateId("tKey_");this.define(tKeyExpr,compileExpr(ast.expr));ctx=createContext(ctx,{tKeyExpr,block:ctx.block,index:ctx.index,});return this.compileAST(ast.content,ctx);}
compileMulti(ast,ctx){let{block,forceNewBlock}=ctx;const isNewBlock=!block||forceNewBlock;let codeIdx=this.target.code.length;if(isNewBlock){const n=ast.content.filter((c)=>c.type!==6).length;let result=null;if(n<=1){for(let child of ast.content){const blockName=this.compileAST(child,ctx);result=result||blockName;}
return result;}
block=this.createBlock(block,"multi",ctx);}
let index=0;for(let i=0,l=ast.content.length;i<l;i++){const child=ast.content[i];const isTSet=child.type===6;const subCtx=createContext(ctx,{block,index,forceNewBlock:!isTSet,isLast:ctx.isLast&&i===l-1,});this.compileAST(child,subCtx);if(!isTSet){index++;}}
if(isNewBlock){if(block.hasDynamicChildren&&block.children.length){const code=this.target.code;const children=block.children.slice();let current=children.shift();for(let i=codeIdx;i<code.length;i++){if(code[i].trimStart().startsWith(`const ${current.varName} `)){code[i]=code[i].replace(`const ${current.varName}`,current.varName);current=children.shift();if(!current)
break;}}
this.addLine(`let ${block.children.map((c) => c.varName).join(", ")};`,codeIdx);}
const args=block.children.map((c)=>c.varName).join(", ");this.insertBlock(`multi([${args}])`,block,ctx);}
return block.varName;}
compileTCall(ast,ctx){let{block,forceNewBlock}=ctx;let ctxVar=ctx.ctxVar||"ctx";if(ast.context){ctxVar=generateId("ctx");this.addLine(`let ${ctxVar} = ${compileExpr(ast.context)};`);}
const isDynamic=INTERP_REGEXP.test(ast.name);const subTemplate=isDynamic?interpolate(ast.name):"`"+ast.name+"`";if(block&&!forceNewBlock){this.insertAnchor(block);}
block=this.createBlock(block,"multi",ctx);if(ast.body){this.addLine(`${ctxVar} = Object.create(${ctxVar});`);this.addLine(`${ctxVar}[isBoundary] = 1;`);this.helpers.add("isBoundary");const subCtx=createContext(ctx,{ctxVar});const bl=this.compileMulti({type:3,content:ast.body},subCtx);if(bl){this.helpers.add("zero");this.addLine(`${ctxVar}[zero] = ${bl};`);}}
const key=`key + \`${this.generateComponentKey()}\``;if(isDynamic){const templateVar=generateId("template");if(!this.staticDefs.find((d)=>d.id==="call")){this.staticDefs.push({id:"call",expr:`app.callTemplate.bind(app)`});}
this.define(templateVar,subTemplate);this.insertBlock(`call(this, ${templateVar}, ${ctxVar}, node, ${key})`,block,{...ctx,forceNewBlock:!block,});}
else{const id=generateId(`callTemplate_`);this.staticDefs.push({id,expr:`app.getTemplate(${subTemplate})`});this.insertBlock(`${id}.call(this, ${ctxVar}, node, ${key})`,block,{...ctx,forceNewBlock:!block,});}
if(ast.body&&!ctx.isLast){this.addLine(`${ctxVar} = ${ctxVar}.__proto__;`);}
return block.varName;}
compileTCallBlock(ast,ctx){let{block,forceNewBlock}=ctx;if(block){if(!forceNewBlock){this.insertAnchor(block);}}
block=this.createBlock(block,"multi",ctx);this.insertBlock(compileExpr(ast.name),block,{...ctx,forceNewBlock:!block});return block.varName;}
compileTSet(ast,ctx){this.target.shouldProtectScope=true;this.helpers.add("isBoundary").add("withDefault");const expr=ast.value?compileExpr(ast.value||""):"null";if(ast.body){this.helpers.add("LazyValue");const bodyAst={type:3,content:ast.body};const name=this.compileInNewTarget("value",bodyAst,ctx);let key=this.target.currentKey(ctx);let value=`new LazyValue(${name}, ctx, this, node, ${key})`;value=ast.value?(value?`withDefault(${expr}, ${value})`:expr):value;this.addLine(`ctx[\`${ast.name}\`] = ${value};`);}
else{let value;if(ast.defaultValue){const defaultValue=ctx.translate?this.translate(ast.defaultValue):ast.defaultValue;if(ast.value){value=`withDefault(${expr}, \`${defaultValue}\`)`;}
else{value=`\`${defaultValue}\``;}}
else{value=expr;}
this.helpers.add("setContextValue");this.addLine(`setContextValue(${ctx.ctxVar || "ctx"}, "${ast.name}", ${value});`);}
return null;}
generateComponentKey(){const parts=[generateId("__")];for(let i=0;i<this.target.loopLevel;i++){parts.push(`\${key${i + 1}}`);}
return parts.join("__");}
formatProp(name,value){value=this.captureExpression(value);if(name.includes(".")){let[_name,suffix]=name.split(".");name=_name;switch(suffix){case"bind":value=`(${value}).bind(this)`;break;case"alike":break;default:throw new OwlError("Invalid prop suffix");}}
name=/^[a-z_]+$/i.test(name)?name:`'${name}'`;return`${name}: ${value || undefined}`;}
formatPropObject(obj){return Object.entries(obj).map(([k,v])=>this.formatProp(k,v));}
getPropString(props,dynProps){let propString=`{${props.join(",")}}`;if(dynProps){propString=`Object.assign({}, ${compileExpr(dynProps)}${props.length ? ", " + propString : ""})`;}
return propString;}
compileComponent(ast,ctx){let{block}=ctx;const hasSlotsProp="slots"in(ast.props||{});const props=ast.props?this.formatPropObject(ast.props):[];let slotDef="";if(ast.slots){let ctxStr="ctx";if(this.target.loopLevel||!this.hasSafeContext){ctxStr=generateId("ctx");this.helpers.add("capture");this.define(ctxStr,`capture(ctx)`);}
let slotStr=[];for(let slotName in ast.slots){const slotAst=ast.slots[slotName];const params=[];if(slotAst.content){const name=this.compileInNewTarget("slot",slotAst.content,ctx,slotAst.on);params.push(`__render: ${name}.bind(this), __ctx: ${ctxStr}`);}
const scope=ast.slots[slotName].scope;if(scope){params.push(`__scope: "${scope}"`);}
if(ast.slots[slotName].attrs){params.push(...this.formatPropObject(ast.slots[slotName].attrs));}
const slotInfo=`{${params.join(", ")}}`;slotStr.push(`'${slotName}': ${slotInfo}`);}
slotDef=`{${slotStr.join(", ")}}`;}
if(slotDef&&!(ast.dynamicProps||hasSlotsProp)){this.helpers.add("markRaw");props.push(`slots: markRaw(${slotDef})`);}
let propString=this.getPropString(props,ast.dynamicProps);let propVar;if((slotDef&&(ast.dynamicProps||hasSlotsProp))||this.dev){propVar=generateId("props");this.define(propVar,propString);propString=propVar;}
if(slotDef&&(ast.dynamicProps||hasSlotsProp)){this.helpers.add("markRaw");this.addLine(`${propVar}.slots = markRaw(Object.assign(${slotDef}, ${propVar}.slots))`);}
const key=this.generateComponentKey();let expr;if(ast.isDynamic){expr=generateId("Comp");this.define(expr,compileExpr(ast.name));}
else{expr=`\`${ast.name}\``;}
if(this.dev){this.addLine(`helpers.validateProps(${expr}, ${propVar}, this);`);}
if(block&&(ctx.forceNewBlock===false||ctx.tKeyExpr)){this.insertAnchor(block);}
let keyArg=`key + \`${key}\``;if(ctx.tKeyExpr){keyArg=`${ctx.tKeyExpr} + ${keyArg}`;}
let id=generateId("comp");const propList=[];for(let p in ast.props||{}){let[name,suffix]=p.split(".");if(!suffix){propList.push(`"${name}"`);}}
this.staticDefs.push({id,expr:`app.createComponent(${ast.isDynamic ? null : expr}, ${!ast.isDynamic}, ${!!ast.slots}, ${!!ast.dynamicProps}, [${propList}])`,});if(ast.isDynamic){keyArg=`(${expr}).name + ${keyArg}`;}
let blockExpr=`${id}(${propString}, ${keyArg}, node, this, ${ast.isDynamic ? expr : null})`;if(ast.isDynamic){blockExpr=`toggler(${expr}, ${blockExpr})`;}
if(ast.on){blockExpr=this.wrapWithEventCatcher(blockExpr,ast.on);}
block=this.createBlock(block,"multi",ctx);this.insertBlock(blockExpr,block,ctx);return block.varName;}
wrapWithEventCatcher(expr,on){this.helpers.add("createCatcher");let name=generateId("catcher");let spec={};let handlers=[];for(let ev in on){let handlerId=generateId("hdlr");let idx=handlers.push(handlerId)-1;spec[ev]=idx;const handler=this.generateHandlerCode(ev,on[ev]);this.define(handlerId,handler);}
this.staticDefs.push({id:name,expr:`createCatcher(${JSON.stringify(spec)})`});return`${name}(${expr}, [${handlers.join(",")}])`;}
compileTSlot(ast,ctx){this.helpers.add("callSlot");let{block}=ctx;let blockString;let slotName;let dynamic=false;let isMultiple=false;if(ast.name.match(INTERP_REGEXP)){dynamic=true;isMultiple=true;slotName=interpolate(ast.name);}
else{slotName="'"+ast.name+"'";isMultiple=isMultiple||this.slotNames.has(ast.name);this.slotNames.add(ast.name);}
const dynProps=ast.attrs?ast.attrs["t-props"]:null;if(ast.attrs){delete ast.attrs["t-props"];}
let key=this.target.loopLevel?`key${this.target.loopLevel}`:"key";if(isMultiple){key=`${key} + \`${this.generateComponentKey()}\``;}
const props=ast.attrs?this.formatPropObject(ast.attrs):[];const scope=this.getPropString(props,dynProps);if(ast.defaultContent){const name=this.compileInNewTarget("defaultContent",ast.defaultContent,ctx);blockString=`callSlot(ctx, node, ${key}, ${slotName}, ${dynamic}, ${scope}, ${name}.bind(this))`;}
else{if(dynamic){let name=generateId("slot");this.define(name,slotName);blockString=`toggler(${name}, callSlot(ctx, node, ${key}, ${name}, ${dynamic}, ${scope}))`;}
else{blockString=`callSlot(ctx, node, ${key}, ${slotName}, ${dynamic}, ${scope})`;}}
if(ast.on){blockString=this.wrapWithEventCatcher(blockString,ast.on);}
if(block){this.insertAnchor(block);}
block=this.createBlock(block,"multi",ctx);this.insertBlock(blockString,block,{...ctx,forceNewBlock:false});return block.varName;}
compileTTranslation(ast,ctx){if(ast.content){return this.compileAST(ast.content,Object.assign({},ctx,{translate:false}));}
return null;}
compileTPortal(ast,ctx){if(!this.staticDefs.find((d)=>d.id==="Portal")){this.staticDefs.push({id:"Portal",expr:`app.Portal`});}
let{block}=ctx;const name=this.compileInNewTarget("slot",ast.content,ctx);const key=this.generateComponentKey();let ctxStr="ctx";if(this.target.loopLevel||!this.hasSafeContext){ctxStr=generateId("ctx");this.helpers.add("capture");this.define(ctxStr,`capture(ctx)`);}
let id=generateId("comp");this.staticDefs.push({id,expr:`app.createComponent(null, false, true, false, false)`,});const target=compileExpr(ast.target);const blockString=`${id}({target: ${target},slots: {'default': {__render: ${name}.bind(this), __ctx: ${ctxStr}}}}, key + \`${key}\`, node, ctx, Portal)`;if(block){this.insertAnchor(block);}
block=this.createBlock(block,"multi",ctx);this.insertBlock(blockString,block,{...ctx,forceNewBlock:false});return block.varName;}}
const cache=new WeakMap();function parse(xml){if(typeof xml==="string"){const elem=parseXML(`<t>${xml}</t>`).firstChild;return _parse(elem);}
let ast=cache.get(xml);if(!ast){ast=_parse(xml.cloneNode(true));cache.set(xml,ast);}
return ast;}
function _parse(xml){normalizeXML(xml);const ctx={inPreTag:false};return parseNode(xml,ctx)||{type:0,value:""};}
function parseNode(node,ctx){if(!(node instanceof Element)){return parseTextCommentNode(node,ctx);}
return(parseTDebugLog(node,ctx)||parseTForEach(node,ctx)||parseTIf(node,ctx)||parseTPortal(node,ctx)||parseTCall(node,ctx)||parseTCallBlock(node)||parseTEscNode(node,ctx)||parseTOutNode(node,ctx)||parseTKey(node,ctx)||parseTTranslation(node,ctx)||parseTSlot(node,ctx)||parseComponent(node,ctx)||parseDOMNode(node,ctx)||parseTSetNode(node,ctx)||parseTNode(node,ctx));}
function parseTNode(node,ctx){if(node.tagName!=="t"){return null;}
return parseChildNodes(node,ctx);}
const lineBreakRE=/[\r\n]/;function parseTextCommentNode(node,ctx){if(node.nodeType===Node.TEXT_NODE){let value=node.textContent||"";if(!ctx.inPreTag&&lineBreakRE.test(value)&&!value.trim()){return null;}
return{type:0,value};}
else if(node.nodeType===Node.COMMENT_NODE){return{type:1,value:node.textContent||""};}
return null;}
function parseTDebugLog(node,ctx){if(node.hasAttribute("t-debug")){node.removeAttribute("t-debug");return{type:12,content:parseNode(node,ctx),};}
if(node.hasAttribute("t-log")){const expr=node.getAttribute("t-log");node.removeAttribute("t-log");return{type:13,expr,content:parseNode(node,ctx),};}
return null;}
const hasDotAtTheEnd=/\.[\w_]+\s*$/;const hasBracketsAtTheEnd=/\[[^\[]+\]\s*$/;const ROOT_SVG_TAGS=new Set(["svg","g","path"]);function parseDOMNode(node,ctx){const{tagName}=node;const dynamicTag=node.getAttribute("t-tag");node.removeAttribute("t-tag");if(tagName==="t"&&!dynamicTag){return null;}
if(tagName.startsWith("block-")){throw new OwlError(`Invalid tag name: '${tagName}'`);}
ctx=Object.assign({},ctx);if(tagName==="pre"){ctx.inPreTag=true;}
let ns=!ctx.nameSpace&&ROOT_SVG_TAGS.has(tagName)?"http://www.w3.org/2000/svg":null;const ref=node.getAttribute("t-ref");node.removeAttribute("t-ref");const nodeAttrsNames=node.getAttributeNames();let attrs=null;let on=null;let model=null;for(let attr of nodeAttrsNames){const value=node.getAttribute(attr);if(attr==="t-on"||attr==="t-on-"){throw new OwlError("Missing event name with t-on directive");}
if(attr.startsWith("t-on-")){on=on||{};on[attr.slice(5)]=value;}
else if(attr.startsWith("t-model")){if(!["input","select","textarea"].includes(tagName)){throw new OwlError("The t-model directive only works with <input>, <textarea> and <select>");}
let baseExpr,expr;if(hasDotAtTheEnd.test(value)){const index=value.lastIndexOf(".");baseExpr=value.slice(0,index);expr=`'${value.slice(index + 1)}'`;}
else if(hasBracketsAtTheEnd.test(value)){const index=value.lastIndexOf("[");baseExpr=value.slice(0,index);expr=value.slice(index+1,-1);}
else{throw new OwlError(`Invalid t-model expression: "${value}" (it should be assignable)`);}
const typeAttr=node.getAttribute("type");const isInput=tagName==="input";const isSelect=tagName==="select";const isCheckboxInput=isInput&&typeAttr==="checkbox";const isRadioInput=isInput&&typeAttr==="radio";const hasTrimMod=attr.includes(".trim");const hasLazyMod=hasTrimMod||attr.includes(".lazy");const hasNumberMod=attr.includes(".number");const eventType=isRadioInput?"click":isSelect||hasLazyMod?"change":"input";model={baseExpr,expr,targetAttr:isCheckboxInput?"checked":"value",specialInitTargetAttr:isRadioInput?"checked":null,eventType,hasDynamicChildren:false,shouldTrim:hasTrimMod,shouldNumberize:hasNumberMod,};if(isSelect){ctx=Object.assign({},ctx);ctx.tModelInfo=model;}}
else if(attr.startsWith("block-")){throw new OwlError(`Invalid attribute: '${attr}'`);}
else if(attr==="xmlns"){ns=value;}
else if(attr!=="t-name"){if(attr.startsWith("t-")&&!attr.startsWith("t-att")){throw new OwlError(`Unknown QWeb directive: '${attr}'`);}
const tModel=ctx.tModelInfo;if(tModel&&["t-att-value","t-attf-value"].includes(attr)){tModel.hasDynamicChildren=true;}
attrs=attrs||{};attrs[attr]=value;}}
if(ns){ctx.nameSpace=ns;}
const children=parseChildren(node,ctx);return{type:2,tag:tagName,dynamicTag,attrs,on,ref,content:children,model,ns,};}
function parseTEscNode(node,ctx){if(!node.hasAttribute("t-esc")){return null;}
const escValue=node.getAttribute("t-esc");node.removeAttribute("t-esc");const tesc={type:4,expr:escValue,defaultValue:node.textContent||"",};let ref=node.getAttribute("t-ref");node.removeAttribute("t-ref");const ast=parseNode(node,ctx);if(!ast){return tesc;}
if(ast.type===2){return{...ast,ref,content:[tesc],};}
return tesc;}
function parseTOutNode(node,ctx){if(!node.hasAttribute("t-out")&&!node.hasAttribute("t-raw")){return null;}
if(node.hasAttribute("t-raw")){console.warn(`t-raw has been deprecated in favor of t-out. If the value to render is not wrapped by the "markup" function, it will be escaped`);}
const expr=(node.getAttribute("t-out")||node.getAttribute("t-raw"));node.removeAttribute("t-out");node.removeAttribute("t-raw");const tOut={type:8,expr,body:null};const ref=node.getAttribute("t-ref");node.removeAttribute("t-ref");const ast=parseNode(node,ctx);if(!ast){return tOut;}
if(ast.type===2){tOut.body=ast.content.length?ast.content:null;return{...ast,ref,content:[tOut],};}
return tOut;}
function parseTForEach(node,ctx){if(!node.hasAttribute("t-foreach")){return null;}
const html=node.outerHTML;const collection=node.getAttribute("t-foreach");node.removeAttribute("t-foreach");const elem=node.getAttribute("t-as")||"";node.removeAttribute("t-as");const key=node.getAttribute("t-key");if(!key){throw new OwlError(`"Directive t-foreach should always be used with a t-key!" (expression: t-foreach="${collection}" t-as="${elem}")`);}
node.removeAttribute("t-key");const memo=node.getAttribute("t-memo")||"";node.removeAttribute("t-memo");const body=parseNode(node,ctx);if(!body){return null;}
const hasNoTCall=!html.includes("t-call");const hasNoFirst=hasNoTCall&&!html.includes(`${elem}_first`);const hasNoLast=hasNoTCall&&!html.includes(`${elem}_last`);const hasNoIndex=hasNoTCall&&!html.includes(`${elem}_index`);const hasNoValue=hasNoTCall&&!html.includes(`${elem}_value`);return{type:9,collection,elem,body,memo,key,hasNoFirst,hasNoLast,hasNoIndex,hasNoValue,};}
function parseTKey(node,ctx){if(!node.hasAttribute("t-key")){return null;}
const key=node.getAttribute("t-key");node.removeAttribute("t-key");const body=parseNode(node,ctx);if(!body){return null;}
return{type:10,expr:key,content:body};}
function parseTCall(node,ctx){if(!node.hasAttribute("t-call")){return null;}
const subTemplate=node.getAttribute("t-call");const context=node.getAttribute("t-call-context");node.removeAttribute("t-call");node.removeAttribute("t-call-context");if(node.tagName!=="t"){const ast=parseNode(node,ctx);const tcall={type:7,name:subTemplate,body:null,context};if(ast&&ast.type===2){ast.content=[tcall];return ast;}
if(ast&&ast.type===11){return{...ast,slots:{default:{content:tcall,scope:null,on:null,attrs:null}},};}}
const body=parseChildren(node,ctx);return{type:7,name:subTemplate,body:body.length?body:null,context,};}
function parseTCallBlock(node,ctx){if(!node.hasAttribute("t-call-block")){return null;}
const name=node.getAttribute("t-call-block");return{type:15,name,};}
function parseTIf(node,ctx){if(!node.hasAttribute("t-if")){return null;}
const condition=node.getAttribute("t-if");node.removeAttribute("t-if");const content=parseNode(node,ctx)||{type:0,value:""};let nextElement=node.nextElementSibling;const tElifs=[];while(nextElement&&nextElement.hasAttribute("t-elif")){const condition=nextElement.getAttribute("t-elif");nextElement.removeAttribute("t-elif");const tElif=parseNode(nextElement,ctx);const next=nextElement.nextElementSibling;nextElement.remove();nextElement=next;if(tElif){tElifs.push({condition,content:tElif});}}
let tElse=null;if(nextElement&&nextElement.hasAttribute("t-else")){nextElement.removeAttribute("t-else");tElse=parseNode(nextElement,ctx);nextElement.remove();}
return{type:5,condition,content,tElif:tElifs.length?tElifs:null,tElse,};}
function parseTSetNode(node,ctx){if(!node.hasAttribute("t-set")){return null;}
const name=node.getAttribute("t-set");const value=node.getAttribute("t-value")||null;const defaultValue=node.innerHTML===node.textContent?node.textContent||null:null;let body=null;if(node.textContent!==node.innerHTML){body=parseChildren(node,ctx);}
return{type:6,name,value,defaultValue,body};}
const directiveErrorMap=new Map([["t-ref","t-ref is no longer supported on components. Consider exposing only the public part of the component's API through a callback prop.",],["t-att","t-att makes no sense on component: props are already treated as expressions"],["t-attf","t-attf is not supported on components: use template strings for string interpolation in props",],]);function parseComponent(node,ctx){let name=node.tagName;const firstLetter=name[0];let isDynamic=node.hasAttribute("t-component");if(isDynamic&&name!=="t"){throw new OwlError(`Directive 't-component' can only be used on <t> nodes (used on a <${name}>)`);}
if(!(firstLetter===firstLetter.toUpperCase()||isDynamic)){return null;}
if(isDynamic){name=node.getAttribute("t-component");node.removeAttribute("t-component");}
const dynamicProps=node.getAttribute("t-props");node.removeAttribute("t-props");const defaultSlotScope=node.getAttribute("t-slot-scope");node.removeAttribute("t-slot-scope");let on=null;let props=null;for(let name of node.getAttributeNames()){const value=node.getAttribute(name);if(name.startsWith("t-")){if(name.startsWith("t-on-")){on=on||{};on[name.slice(5)]=value;}
else{const message=directiveErrorMap.get(name.split("-").slice(0,2).join("-"));throw new OwlError(message||`unsupported directive on Component: ${name}`);}}
else{props=props||{};props[name]=value;}}
let slots=null;if(node.hasChildNodes()){const clone=node.cloneNode(true);const slotNodes=Array.from(clone.querySelectorAll("[t-set-slot]"));for(let slotNode of slotNodes){if(slotNode.tagName!=="t"){throw new OwlError(`Directive 't-set-slot' can only be used on <t> nodes (used on a <${slotNode.tagName}>)`);}
const name=slotNode.getAttribute("t-set-slot");let el=slotNode.parentElement;let isInSubComponent=false;while(el&&el!==clone){if(el.hasAttribute("t-component")||el.tagName[0]===el.tagName[0].toUpperCase()){isInSubComponent=true;break;}
el=el.parentElement;}
if(isInSubComponent||!el){continue;}
slotNode.removeAttribute("t-set-slot");slotNode.remove();const slotAst=parseNode(slotNode,ctx);let on=null;let attrs=null;let scope=null;for(let attributeName of slotNode.getAttributeNames()){const value=slotNode.getAttribute(attributeName);if(attributeName==="t-slot-scope"){scope=value;continue;}
else if(attributeName.startsWith("t-on-")){on=on||{};on[attributeName.slice(5)]=value;}
else{attrs=attrs||{};attrs[attributeName]=value;}}
slots=slots||{};slots[name]={content:slotAst,on,attrs,scope};}
const defaultContent=parseChildNodes(clone,ctx);slots=slots||{};if(defaultContent&&!slots.default){slots.default={content:defaultContent,on,attrs:null,scope:defaultSlotScope};}}
return{type:11,name,isDynamic,dynamicProps,props,slots,on};}
function parseTSlot(node,ctx){if(!node.hasAttribute("t-slot")){return null;}
const name=node.getAttribute("t-slot");node.removeAttribute("t-slot");let attrs=null;let on=null;for(let attributeName of node.getAttributeNames()){const value=node.getAttribute(attributeName);if(attributeName.startsWith("t-on-")){on=on||{};on[attributeName.slice(5)]=value;}
else{attrs=attrs||{};attrs[attributeName]=value;}}
return{type:14,name,attrs,on,defaultContent:parseChildNodes(node,ctx),};}
function parseTTranslation(node,ctx){if(node.getAttribute("t-translation")!=="off"){return null;}
node.removeAttribute("t-translation");return{type:16,content:parseNode(node,ctx),};}
function parseTPortal(node,ctx){if(!node.hasAttribute("t-portal")){return null;}
const target=node.getAttribute("t-portal");node.removeAttribute("t-portal");const content=parseNode(node,ctx);if(!content){return{type:0,value:"",};}
return{type:17,target,content,};}
function parseChildren(node,ctx){const children=[];for(let child of node.childNodes){const childAst=parseNode(child,ctx);if(childAst){if(childAst.type===3){children.push(...childAst.content);}
else{children.push(childAst);}}}
return children;}
function parseChildNodes(node,ctx){const children=parseChildren(node,ctx);switch(children.length){case 0:return null;case 1:return children[0];default:return{type:3,content:children};}}
function normalizeTIf(el){let tbranch=el.querySelectorAll("[t-elif], [t-else]");for(let i=0,ilen=tbranch.length;i<ilen;i++){let node=tbranch[i];let prevElem=node.previousElementSibling;let pattr=(name)=>prevElem.getAttribute(name);let nattr=(name)=>+!!node.getAttribute(name);if(prevElem&&(pattr("t-if")||pattr("t-elif"))){if(pattr("t-foreach")){throw new OwlError("t-if cannot stay at the same level as t-foreach when using t-elif or t-else");}
if(["t-if","t-elif","t-else"].map(nattr).reduce(function(a,b){return a+b;})>1){throw new OwlError("Only one conditional branching directive is allowed per node");}
let textNode;while((textNode=node.previousSibling)!==prevElem){if(textNode.nodeValue.trim().length&&textNode.nodeType!==8){throw new OwlError("text is not allowed between branching directives");}
textNode.remove();}}
else{throw new OwlError("t-elif and t-else directives must be preceded by a t-if or t-elif directive");}}}
function normalizeTEscTOut(el){for(const d of["t-esc","t-out"]){const elements=[...el.querySelectorAll(`[${d}]`)].filter((el)=>el.tagName[0]===el.tagName[0].toUpperCase()||el.hasAttribute("t-component"));for(const el of elements){if(el.childNodes.length){throw new OwlError(`Cannot have ${d} on a component that already has content`);}
const value=el.getAttribute(d);el.removeAttribute(d);const t=el.ownerDocument.createElement("t");if(value!=null){t.setAttribute(d,value);}
el.appendChild(t);}}}
function normalizeXML(el){normalizeTIf(el);normalizeTEscTOut(el);}
function compile(template,options={}){const ast=parse(template);const hasSafeContext=template instanceof Node?!(template instanceof Element)||template.querySelector("[t-set], [t-call]")===null:!template.includes("t-set")&&!template.includes("t-call");const codeGenerator=new CodeGenerator(ast,{...options,hasSafeContext});const code=codeGenerator.generateCode();try{return new Function("app, bdom, helpers",code);}
catch(originalError){const{name}=options;const nameStr=name?`template "${name}"`:"anonymous template";const err=new OwlError(`Failed to compile ${nameStr}: ${originalError.message}\n\ngenerated code:\nfunction(app, bdom, helpers) {\n${code}\n}`);err.cause=originalError;throw err;}}
const version="2.2.9";class Scheduler{constructor(){this.tasks=new Set();this.frame=0;this.delayedRenders=[];this.cancelledNodes=new Set();this.requestAnimationFrame=Scheduler.requestAnimationFrame;}
addFiber(fiber){this.tasks.add(fiber.root);}
scheduleDestroy(node){this.cancelledNodes.add(node);if(this.frame===0){this.frame=this.requestAnimationFrame(()=>this.processTasks());}}
flush(){if(this.delayedRenders.length){let renders=this.delayedRenders;this.delayedRenders=[];for(let f of renders){if(f.root&&f.node.status!==3&&f.node.fiber===f){f.render();}}}
if(this.frame===0){this.frame=this.requestAnimationFrame(()=>this.processTasks());}}
processTasks(){this.frame=0;for(let node of this.cancelledNodes){node._destroy();}
this.cancelledNodes.clear();for(let task of this.tasks){this.processFiber(task);}
for(let task of this.tasks){if(task.node.status===3){this.tasks.delete(task);}}}
processFiber(fiber){if(fiber.root!==fiber){this.tasks.delete(fiber);return;}
const hasError=fibersInError.has(fiber);if(hasError&&fiber.counter!==0){this.tasks.delete(fiber);return;}
if(fiber.node.status===3){this.tasks.delete(fiber);return;}
if(fiber.counter===0){if(!hasError){fiber.complete();}
this.tasks.delete(fiber);}}}
Scheduler.requestAnimationFrame=window.requestAnimationFrame.bind(window);let hasBeenLogged=false;const DEV_MSG=()=>{const hash=window.owl?window.owl.__info__.hash:"master";return`Owl is running in 'dev' mode.

This is not suitable for production use.
See https://github.com/odoo/owl/blob/${hash}/doc/reference/app.md#configuration for more information.`;};const apps=new Set();window.__OWL_DEVTOOLS__||(window.__OWL_DEVTOOLS__={apps,Fiber,RootFiber,toRaw,reactive});class App extends TemplateSet{constructor(Root,config={}){super(config);this.scheduler=new Scheduler();this.root=null;this.name=config.name||"";this.Root=Root;apps.add(this);if(config.test){this.dev=true;}
this.warnIfNoStaticProps=config.warnIfNoStaticProps||false;if(this.dev&&!config.test&&!hasBeenLogged){console.info(DEV_MSG());hasBeenLogged=true;}
const env=config.env||{};const descrs=Object.getOwnPropertyDescriptors(env);this.env=Object.freeze(Object.create(Object.getPrototypeOf(env),descrs));this.props=config.props||{};}
mount(target,options){App.validateTarget(target);if(this.dev){validateProps(this.Root,this.props,{__owl__:{app:this}});}
const node=this.makeNode(this.Root,this.props);const prom=this.mountNode(node,target,options);this.root=node;return prom;}
makeNode(Component,props){return new ComponentNode(Component,props,this,null,null);}
mountNode(node,target,options){const promise=new Promise((resolve,reject)=>{let isResolved=false;node.mounted.push(()=>{resolve(node.component);isResolved=true;});let handlers=nodeErrorHandlers.get(node);if(!handlers){handlers=[];nodeErrorHandlers.set(node,handlers);}
handlers.unshift((e)=>{if(!isResolved){reject(e);}
throw e;});});node.mountComponent(target,options);return promise;}
destroy(){if(this.root){this.root.destroy();this.scheduler.processTasks();}
apps.delete(this);}
createComponent(name,isStatic,hasSlotsProp,hasDynamicPropList,propList){const isDynamic=!isStatic;let arePropsDifferent;const hasNoProp=propList.length===0;if(hasSlotsProp){arePropsDifferent=(_1,_2)=>true;}
else if(hasDynamicPropList){arePropsDifferent=function(props1,props2){for(let k in props1){if(props1[k]!==props2[k]){return true;}}
return Object.keys(props1).length!==Object.keys(props2).length;};}
else if(hasNoProp){arePropsDifferent=(_1,_2)=>false;}
else{arePropsDifferent=function(props1,props2){for(let p of propList){if(props1[p]!==props2[p]){return true;}}
return false;};}
const updateAndRender=ComponentNode.prototype.updateAndRender;const initiateRender=ComponentNode.prototype.initiateRender;return(props,key,ctx,parent,C)=>{let children=ctx.children;let node=children[key];if(isDynamic&&node&&node.component.constructor!==C){node=undefined;}
const parentFiber=ctx.fiber;if(node){if(arePropsDifferent(node.props,props)||parentFiber.deep||node.forceNextRender){node.forceNextRender=false;updateAndRender.call(node,props,parentFiber);}}
else{if(isStatic){const components=parent.constructor.components;if(!components){throw new OwlError(`Cannot find the definition of component "${name}", missing static components key in parent`);}
C=components[name];if(!C){throw new OwlError(`Cannot find the definition of component "${name}"`);}
else if(!(C.prototype instanceof Component)){throw new OwlError(`"${name}" is not a Component. It must inherit from the Component class`);}}
node=new ComponentNode(C,props,this,ctx,key);children[key]=node;initiateRender.call(node,new Fiber(node,parentFiber));}
parentFiber.childrenMap[key]=node;return node;};}
handleError(...args){return handleError(...args);}}
App.validateTarget=validateTarget;App.apps=apps;App.version=version;async function mount(C,target,config={}){return new App(C,config).mount(target,config);}
const mainEventHandler=(data,ev,currentTarget)=>{const{data:_data,modifiers}=filterOutModifiersFromData(data);data=_data;let stopped=false;if(modifiers.length){let selfMode=false;const isSelf=ev.target===currentTarget;for(const mod of modifiers){switch(mod){case"self":selfMode=true;if(isSelf){continue;}
else{return stopped;}
case"prevent":if((selfMode&&isSelf)||!selfMode)
ev.preventDefault();continue;case"stop":if((selfMode&&isSelf)||!selfMode)
ev.stopPropagation();stopped=true;continue;}}}
if(Object.hasOwnProperty.call(data,0)){const handler=data[0];if(typeof handler!=="function"){throw new OwlError(`Invalid handler (expected a function, received: '${handler}')`);}
let node=data[1]?data[1].__owl__:null;if(node?node.status===1:true){handler.call(node?node.component:null,ev);}}
return stopped;};function status(component){switch(component.__owl__.status){case 0:return"new";case 2:return"cancelled";case 1:return"mounted";case 3:return"destroyed";}}
function useRef(name){const node=getCurrent();const refs=node.refs;return{get el(){const el=refs[name];return inOwnerDocument(el)?el:null;},};}
function useEnv(){return getCurrent().component.env;}
function extendEnv(currentEnv,extension){const env=Object.create(currentEnv);const descrs=Object.getOwnPropertyDescriptors(extension);return Object.freeze(Object.defineProperties(env,descrs));}
function useSubEnv(envExtension){const node=getCurrent();node.component.env=extendEnv(node.component.env,envExtension);useChildSubEnv(envExtension);}
function useChildSubEnv(envExtension){const node=getCurrent();node.childEnv=extendEnv(node.childEnv,envExtension);}
function useEffect(effect,computeDependencies=()=>[NaN]){let cleanup;let dependencies;onMounted(()=>{dependencies=computeDependencies();cleanup=effect(...dependencies);});onPatched(()=>{const newDeps=computeDependencies();const shouldReapply=newDeps.some((val,i)=>val!==dependencies[i]);if(shouldReapply){dependencies=newDeps;if(cleanup){cleanup();}
cleanup=effect(...dependencies);}});onWillUnmount(()=>cleanup&&cleanup());}
function useExternalListener(target,eventName,handler,eventParams){const node=getCurrent();const boundHandler=handler.bind(node.component);onMounted(()=>target.addEventListener(eventName,boundHandler,eventParams));onWillUnmount(()=>target.removeEventListener(eventName,boundHandler,eventParams));}
config.shouldNormalizeDom=false;config.mainEventHandler=mainEventHandler;const blockDom={config,mount:mount$1,patch,remove,list,multi,text,toggler,createBlock,html,comment,};const __info__={version:App.version,};TemplateSet.prototype._compileTemplate=function _compileTemplate(name,template){return compile(template,{name,dev:this.dev,translateFn:this.translateFn,translatableAttributes:this.translatableAttributes,});};exports.App=App;exports.Component=Component;exports.EventBus=EventBus;exports.OwlError=OwlError;exports.__info__=__info__;exports.blockDom=blockDom;exports.loadFile=loadFile;exports.markRaw=markRaw;exports.markup=markup;exports.mount=mount;exports.onError=onError;exports.onMounted=onMounted;exports.onPatched=onPatched;exports.onRendered=onRendered;exports.onWillDestroy=onWillDestroy;exports.onWillPatch=onWillPatch;exports.onWillRender=onWillRender;exports.onWillStart=onWillStart;exports.onWillUnmount=onWillUnmount;exports.onWillUpdateProps=onWillUpdateProps;exports.reactive=reactive;exports.status=status;exports.toRaw=toRaw;exports.useChildSubEnv=useChildSubEnv;exports.useComponent=useComponent;exports.useEffect=useEffect;exports.useEnv=useEnv;exports.useExternalListener=useExternalListener;exports.useRef=useRef;exports.useState=useState;exports.useSubEnv=useSubEnv;exports.validate=validate;exports.validateType=validateType;exports.whenReady=whenReady;exports.xml=xml;Object.defineProperty(exports,'__esModule',{value:true});__info__.date='2024-01-12T14:43:56.804Z';__info__.hash='7b3e39b';__info__.url='https://github.com/odoo/owl';})(this.owl=this.owl||{});;

/* /web/static/lib/luxon/luxon.js */
var luxon=(function(exports){'use strict';class LuxonError extends Error{}
class InvalidDateTimeError extends LuxonError{constructor(reason){super(`Invalid DateTime: ${reason.toMessage()}`);}}
class InvalidIntervalError extends LuxonError{constructor(reason){super(`Invalid Interval: ${reason.toMessage()}`);}}
class InvalidDurationError extends LuxonError{constructor(reason){super(`Invalid Duration: ${reason.toMessage()}`);}}
class ConflictingSpecificationError extends LuxonError{}
class InvalidUnitError extends LuxonError{constructor(unit){super(`Invalid unit ${unit}`);}}
class InvalidArgumentError extends LuxonError{}
class ZoneIsAbstractError extends LuxonError{constructor(){super("Zone is an abstract class");}}
const n="numeric",s="short",l="long";const DATE_SHORT={year:n,month:n,day:n,};const DATE_MED={year:n,month:s,day:n,};const DATE_MED_WITH_WEEKDAY={year:n,month:s,day:n,weekday:s,};const DATE_FULL={year:n,month:l,day:n,};const DATE_HUGE={year:n,month:l,day:n,weekday:l,};const TIME_SIMPLE={hour:n,minute:n,};const TIME_WITH_SECONDS={hour:n,minute:n,second:n,};const TIME_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,timeZoneName:s,};const TIME_WITH_LONG_OFFSET={hour:n,minute:n,second:n,timeZoneName:l,};const TIME_24_SIMPLE={hour:n,minute:n,hourCycle:"h23",};const TIME_24_WITH_SECONDS={hour:n,minute:n,second:n,hourCycle:"h23",};const TIME_24_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,hourCycle:"h23",timeZoneName:s,};const TIME_24_WITH_LONG_OFFSET={hour:n,minute:n,second:n,hourCycle:"h23",timeZoneName:l,};const DATETIME_SHORT={year:n,month:n,day:n,hour:n,minute:n,};const DATETIME_SHORT_WITH_SECONDS={year:n,month:n,day:n,hour:n,minute:n,second:n,};const DATETIME_MED={year:n,month:s,day:n,hour:n,minute:n,};const DATETIME_MED_WITH_SECONDS={year:n,month:s,day:n,hour:n,minute:n,second:n,};const DATETIME_MED_WITH_WEEKDAY={year:n,month:s,day:n,weekday:s,hour:n,minute:n,};const DATETIME_FULL={year:n,month:l,day:n,hour:n,minute:n,timeZoneName:s,};const DATETIME_FULL_WITH_SECONDS={year:n,month:l,day:n,hour:n,minute:n,second:n,timeZoneName:s,};const DATETIME_HUGE={year:n,month:l,day:n,weekday:l,hour:n,minute:n,timeZoneName:l,};const DATETIME_HUGE_WITH_SECONDS={year:n,month:l,day:n,weekday:l,hour:n,minute:n,second:n,timeZoneName:l,};class Zone{get type(){throw new ZoneIsAbstractError();}
get name(){throw new ZoneIsAbstractError();}
get ianaName(){return this.name;}
get isUniversal(){throw new ZoneIsAbstractError();}
offsetName(ts,opts){throw new ZoneIsAbstractError();}
formatOffset(ts,format){throw new ZoneIsAbstractError();}
offset(ts){throw new ZoneIsAbstractError();}
equals(otherZone){throw new ZoneIsAbstractError();}
get isValid(){throw new ZoneIsAbstractError();}}
let singleton$1=null;class SystemZone extends Zone{static get instance(){if(singleton$1===null){singleton$1=new SystemZone();}
return singleton$1;}
get type(){return"system";}
get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone;}
get isUniversal(){return false;}
offsetName(ts,{format,locale}){return parseZoneInfo(ts,format,locale);}
formatOffset(ts,format){return formatOffset(this.offset(ts),format);}
offset(ts){return-new Date(ts).getTimezoneOffset();}
equals(otherZone){return otherZone.type==="system";}
get isValid(){return true;}}
let dtfCache={};function makeDTF(zone){if(!dtfCache[zone]){dtfCache[zone]=new Intl.DateTimeFormat("en-US",{hour12:false,timeZone:zone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short",});}
return dtfCache[zone];}
const typeToPos={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6,};function hackyOffset(dtf,date){const formatted=dtf.format(date).replace(/\u200E/g,""),parsed=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(formatted),[,fMonth,fDay,fYear,fadOrBc,fHour,fMinute,fSecond]=parsed;return[fYear,fMonth,fDay,fadOrBc,fHour,fMinute,fSecond];}
function partsOffset(dtf,date){const formatted=dtf.formatToParts(date);const filled=[];for(let i=0;i<formatted.length;i++){const{type,value}=formatted[i];const pos=typeToPos[type];if(type==="era"){filled[pos]=value;}else if(!isUndefined(pos)){filled[pos]=parseInt(value,10);}}
return filled;}
let ianaZoneCache={};class IANAZone extends Zone{static create(name){if(!ianaZoneCache[name]){ianaZoneCache[name]=new IANAZone(name);}
return ianaZoneCache[name];}
static resetCache(){ianaZoneCache={};dtfCache={};}
static isValidSpecifier(s){return this.isValidZone(s);}
static isValidZone(zone){if(!zone){return false;}
try{new Intl.DateTimeFormat("en-US",{timeZone:zone}).format();return true;}catch(e){return false;}}
constructor(name){super();this.zoneName=name;this.valid=IANAZone.isValidZone(name);}
get type(){return"iana";}
get name(){return this.zoneName;}
get isUniversal(){return false;}
offsetName(ts,{format,locale}){return parseZoneInfo(ts,format,locale,this.name);}
formatOffset(ts,format){return formatOffset(this.offset(ts),format);}
offset(ts){const date=new Date(ts);if(isNaN(date))return NaN;const dtf=makeDTF(this.name);let[year,month,day,adOrBc,hour,minute,second]=dtf.formatToParts?partsOffset(dtf,date):hackyOffset(dtf,date);if(adOrBc==="BC"){year=-Math.abs(year)+1;}
const adjustedHour=hour===24?0:hour;const asUTC=objToLocalTS({year,month,day,hour:adjustedHour,minute,second,millisecond:0,});let asTS=+date;const over=asTS%1000;asTS-=over>=0?over:1000+over;return(asUTC-asTS)/(60*1000);}
equals(otherZone){return otherZone.type==="iana"&&otherZone.name===this.name;}
get isValid(){return this.valid;}}
let intlLFCache={};function getCachedLF(locString,opts={}){const key=JSON.stringify([locString,opts]);let dtf=intlLFCache[key];if(!dtf){dtf=new Intl.ListFormat(locString,opts);intlLFCache[key]=dtf;}
return dtf;}
let intlDTCache={};function getCachedDTF(locString,opts={}){const key=JSON.stringify([locString,opts]);let dtf=intlDTCache[key];if(!dtf){dtf=new Intl.DateTimeFormat(locString,opts);intlDTCache[key]=dtf;}
return dtf;}
let intlNumCache={};function getCachedINF(locString,opts={}){const key=JSON.stringify([locString,opts]);let inf=intlNumCache[key];if(!inf){inf=new Intl.NumberFormat(locString,opts);intlNumCache[key]=inf;}
return inf;}
let intlRelCache={};function getCachedRTF(locString,opts={}){const{base,...cacheKeyOpts}=opts;const key=JSON.stringify([locString,cacheKeyOpts]);let inf=intlRelCache[key];if(!inf){inf=new Intl.RelativeTimeFormat(locString,opts);intlRelCache[key]=inf;}
return inf;}
let sysLocaleCache=null;function systemLocale(){if(sysLocaleCache){return sysLocaleCache;}else{sysLocaleCache=new Intl.DateTimeFormat().resolvedOptions().locale;return sysLocaleCache;}}
function parseLocaleString(localeStr){const xIndex=localeStr.indexOf("-x-");if(xIndex!==-1){localeStr=localeStr.substring(0,xIndex);}
const uIndex=localeStr.indexOf("-u-");if(uIndex===-1){return[localeStr];}else{let options;let selectedStr;try{options=getCachedDTF(localeStr).resolvedOptions();selectedStr=localeStr;}catch(e){const smaller=localeStr.substring(0,uIndex);options=getCachedDTF(smaller).resolvedOptions();selectedStr=smaller;}
const{numberingSystem,calendar}=options;return[selectedStr,numberingSystem,calendar];}}
function intlConfigString(localeStr,numberingSystem,outputCalendar){if(outputCalendar||numberingSystem){if(!localeStr.includes("-u-")){localeStr+="-u";}
if(outputCalendar){localeStr+=`-ca-${outputCalendar}`;}
if(numberingSystem){localeStr+=`-nu-${numberingSystem}`;}
return localeStr;}else{return localeStr;}}
function mapMonths(f){const ms=[];for(let i=1;i<=12;i++){const dt=DateTime.utc(2009,i,1);ms.push(f(dt));}
return ms;}
function mapWeekdays(f){const ms=[];for(let i=1;i<=7;i++){const dt=DateTime.utc(2016,11,13+i);ms.push(f(dt));}
return ms;}
function listStuff(loc,length,englishFn,intlFn){const mode=loc.listingMode();if(mode==="error"){return null;}else if(mode==="en"){return englishFn(length);}else{return intlFn(length);}}
function supportsFastNumbers(loc){if(loc.numberingSystem&&loc.numberingSystem!=="latn"){return false;}else{return(loc.numberingSystem==="latn"||!loc.locale||loc.locale.startsWith("en")||new Intl.DateTimeFormat(loc.intl).resolvedOptions().numberingSystem==="latn");}}
class PolyNumberFormatter{constructor(intl,forceSimple,opts){this.padTo=opts.padTo||0;this.floor=opts.floor||false;const{padTo,floor,...otherOpts}=opts;if(!forceSimple||Object.keys(otherOpts).length>0){const intlOpts={useGrouping:false,...opts};if(opts.padTo>0)intlOpts.minimumIntegerDigits=opts.padTo;this.inf=getCachedINF(intl,intlOpts);}}
format(i){if(this.inf){const fixed=this.floor?Math.floor(i):i;return this.inf.format(fixed);}else{const fixed=this.floor?Math.floor(i):roundTo(i,3);return padStart(fixed,this.padTo);}}}
class PolyDateFormatter{constructor(dt,intl,opts){this.opts=opts;this.originalZone=undefined;let z=undefined;if(this.opts.timeZone){this.dt=dt;}else if(dt.zone.type==="fixed"){const gmtOffset=-1*(dt.offset/60);const offsetZ=gmtOffset>=0?`Etc/GMT+${gmtOffset}`:`Etc/GMT${gmtOffset}`;if(dt.offset!==0&&IANAZone.create(offsetZ).valid){z=offsetZ;this.dt=dt;}else{z="UTC";this.dt=dt.offset===0?dt:dt.setZone("UTC").plus({minutes:dt.offset});this.originalZone=dt.zone;}}else if(dt.zone.type==="system"){this.dt=dt;}else if(dt.zone.type==="iana"){this.dt=dt;z=dt.zone.name;}else{z="UTC";this.dt=dt.setZone("UTC").plus({minutes:dt.offset});this.originalZone=dt.zone;}
const intlOpts={...this.opts};intlOpts.timeZone=intlOpts.timeZone||z;this.dtf=getCachedDTF(intl,intlOpts);}
format(){if(this.originalZone){return this.formatToParts().map(({value})=>value).join("");}
return this.dtf.format(this.dt.toJSDate());}
formatToParts(){const parts=this.dtf.formatToParts(this.dt.toJSDate());if(this.originalZone){return parts.map((part)=>{if(part.type==="timeZoneName"){const offsetName=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName,});return{...part,value:offsetName,};}else{return part;}});}
return parts;}
resolvedOptions(){return this.dtf.resolvedOptions();}}
class PolyRelFormatter{constructor(intl,isEnglish,opts){this.opts={style:"long",...opts};if(!isEnglish&&hasRelative()){this.rtf=getCachedRTF(intl,opts);}}
format(count,unit){if(this.rtf){return this.rtf.format(count,unit);}else{return formatRelativeTime(unit,count,this.opts.numeric,this.opts.style!=="long");}}
formatToParts(count,unit){if(this.rtf){return this.rtf.formatToParts(count,unit);}else{return[];}}}
class Locale{static fromOpts(opts){return Locale.create(opts.locale,opts.numberingSystem,opts.outputCalendar,opts.defaultToEN);}
static create(locale,numberingSystem,outputCalendar,defaultToEN=false){const specifiedLocale=locale||Settings.defaultLocale;const localeR=specifiedLocale||(defaultToEN?"en-US":systemLocale());const numberingSystemR=numberingSystem||Settings.defaultNumberingSystem;const outputCalendarR=outputCalendar||Settings.defaultOutputCalendar;return new Locale(localeR,numberingSystemR,outputCalendarR,specifiedLocale);}
static resetCache(){sysLocaleCache=null;intlDTCache={};intlNumCache={};intlRelCache={};}
static fromObject({locale,numberingSystem,outputCalendar}={}){return Locale.create(locale,numberingSystem,outputCalendar);}
constructor(locale,numbering,outputCalendar,specifiedLocale){const[parsedLocale,parsedNumberingSystem,parsedOutputCalendar]=parseLocaleString(locale);this.locale=parsedLocale;this.numberingSystem=numbering||parsedNumberingSystem||null;this.outputCalendar=outputCalendar||parsedOutputCalendar||null;this.intl=intlConfigString(this.locale,this.numberingSystem,this.outputCalendar);this.weekdaysCache={format:{},standalone:{}};this.monthsCache={format:{},standalone:{}};this.meridiemCache=null;this.eraCache={};this.specifiedLocale=specifiedLocale;this.fastNumbersCached=null;}
get fastNumbers(){if(this.fastNumbersCached==null){this.fastNumbersCached=supportsFastNumbers(this);}
return this.fastNumbersCached;}
listingMode(){const isActuallyEn=this.isEnglish();const hasNoWeirdness=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return isActuallyEn&&hasNoWeirdness?"en":"intl";}
clone(alts){if(!alts||Object.getOwnPropertyNames(alts).length===0){return this;}else{return Locale.create(alts.locale||this.specifiedLocale,alts.numberingSystem||this.numberingSystem,alts.outputCalendar||this.outputCalendar,alts.defaultToEN||false);}}
redefaultToEN(alts={}){return this.clone({...alts,defaultToEN:true});}
redefaultToSystem(alts={}){return this.clone({...alts,defaultToEN:false});}
months(length,format=false){return listStuff(this,length,months,()=>{const intl=format?{month:length,day:"numeric"}:{month:length},formatStr=format?"format":"standalone";if(!this.monthsCache[formatStr][length]){this.monthsCache[formatStr][length]=mapMonths((dt)=>this.extract(dt,intl,"month"));}
return this.monthsCache[formatStr][length];});}
weekdays(length,format=false){return listStuff(this,length,weekdays,()=>{const intl=format?{weekday:length,year:"numeric",month:"long",day:"numeric"}:{weekday:length},formatStr=format?"format":"standalone";if(!this.weekdaysCache[formatStr][length]){this.weekdaysCache[formatStr][length]=mapWeekdays((dt)=>this.extract(dt,intl,"weekday"));}
return this.weekdaysCache[formatStr][length];});}
meridiems(){return listStuff(this,undefined,()=>meridiems,()=>{if(!this.meridiemCache){const intl={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[DateTime.utc(2016,11,13,9),DateTime.utc(2016,11,13,19)].map((dt)=>this.extract(dt,intl,"dayperiod"));}
return this.meridiemCache;});}
eras(length){return listStuff(this,length,eras,()=>{const intl={era:length};if(!this.eraCache[length]){this.eraCache[length]=[DateTime.utc(-40,1,1),DateTime.utc(2017,1,1)].map((dt)=>this.extract(dt,intl,"era"));}
return this.eraCache[length];});}
extract(dt,intlOpts,field){const df=this.dtFormatter(dt,intlOpts),results=df.formatToParts(),matching=results.find((m)=>m.type.toLowerCase()===field);return matching?matching.value:null;}
numberFormatter(opts={}){return new PolyNumberFormatter(this.intl,opts.forceSimple||this.fastNumbers,opts);}
dtFormatter(dt,intlOpts={}){return new PolyDateFormatter(dt,this.intl,intlOpts);}
relFormatter(opts={}){return new PolyRelFormatter(this.intl,this.isEnglish(),opts);}
listFormatter(opts={}){return getCachedLF(this.intl,opts);}
isEnglish(){return(this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us"));}
equals(other){return(this.locale===other.locale&&this.numberingSystem===other.numberingSystem&&this.outputCalendar===other.outputCalendar);}}
let singleton=null;class FixedOffsetZone extends Zone{static get utcInstance(){if(singleton===null){singleton=new FixedOffsetZone(0);}
return singleton;}
static instance(offset){return offset===0?FixedOffsetZone.utcInstance:new FixedOffsetZone(offset);}
static parseSpecifier(s){if(s){const r=s.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r){return new FixedOffsetZone(signedOffset(r[1],r[2]));}}
return null;}
constructor(offset){super();this.fixed=offset;}
get type(){return"fixed";}
get name(){return this.fixed===0?"UTC":`UTC${formatOffset(this.fixed, "narrow")}`;}
get ianaName(){if(this.fixed===0){return"Etc/UTC";}else{return`Etc/GMT${formatOffset(-this.fixed, "narrow")}`;}}
offsetName(){return this.name;}
formatOffset(ts,format){return formatOffset(this.fixed,format);}
get isUniversal(){return true;}
offset(){return this.fixed;}
equals(otherZone){return otherZone.type==="fixed"&&otherZone.fixed===this.fixed;}
get isValid(){return true;}}
class InvalidZone extends Zone{constructor(zoneName){super();this.zoneName=zoneName;}
get type(){return"invalid";}
get name(){return this.zoneName;}
get isUniversal(){return false;}
offsetName(){return null;}
formatOffset(){return"";}
offset(){return NaN;}
equals(){return false;}
get isValid(){return false;}}
function normalizeZone(input,defaultZone){if(isUndefined(input)||input===null){return defaultZone;}else if(input instanceof Zone){return input;}else if(isString(input)){const lowered=input.toLowerCase();if(lowered==="default")return defaultZone;else if(lowered==="local"||lowered==="system")return SystemZone.instance;else if(lowered==="utc"||lowered==="gmt")return FixedOffsetZone.utcInstance;else return FixedOffsetZone.parseSpecifier(lowered)||IANAZone.create(input);}else if(isNumber(input)){return FixedOffsetZone.instance(input);}else if(typeof input==="object"&&"offset"in input&&typeof input.offset==="function"){return input;}else{return new InvalidZone(input);}}
let now=()=>Date.now(),defaultZone="system",defaultLocale=null,defaultNumberingSystem=null,defaultOutputCalendar=null,twoDigitCutoffYear=60,throwOnInvalid;class Settings{static get now(){return now;}
static set now(n){now=n;}
static set defaultZone(zone){defaultZone=zone;}
static get defaultZone(){return normalizeZone(defaultZone,SystemZone.instance);}
static get defaultLocale(){return defaultLocale;}
static set defaultLocale(locale){defaultLocale=locale;}
static get defaultNumberingSystem(){return defaultNumberingSystem;}
static set defaultNumberingSystem(numberingSystem){defaultNumberingSystem=numberingSystem;}
static get defaultOutputCalendar(){return defaultOutputCalendar;}
static set defaultOutputCalendar(outputCalendar){defaultOutputCalendar=outputCalendar;}
static get twoDigitCutoffYear(){return twoDigitCutoffYear;}
static set twoDigitCutoffYear(cutoffYear){twoDigitCutoffYear=cutoffYear%100;}
static get throwOnInvalid(){return throwOnInvalid;}
static set throwOnInvalid(t){throwOnInvalid=t;}
static resetCaches(){Locale.resetCache();IANAZone.resetCache();}}
function isUndefined(o){return typeof o==="undefined";}
function isNumber(o){return typeof o==="number";}
function isInteger(o){return typeof o==="number"&&o%1===0;}
function isString(o){return typeof o==="string";}
function isDate(o){return Object.prototype.toString.call(o)==="[object Date]";}
function hasRelative(){try{return typeof Intl!=="undefined"&&!!Intl.RelativeTimeFormat;}catch(e){return false;}}
function maybeArray(thing){return Array.isArray(thing)?thing:[thing];}
function bestBy(arr,by,compare){if(arr.length===0){return undefined;}
return arr.reduce((best,next)=>{const pair=[by(next),next];if(!best){return pair;}else if(compare(best[0],pair[0])===best[0]){return best;}else{return pair;}},null)[1];}
function pick(obj,keys){return keys.reduce((a,k)=>{a[k]=obj[k];return a;},{});}
function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}
function integerBetween(thing,bottom,top){return isInteger(thing)&&thing>=bottom&&thing<=top;}
function floorMod(x,n){return x-n*Math.floor(x/n);}
function padStart(input,n=2){const isNeg=input<0;let padded;if(isNeg){padded="-"+(""+-input).padStart(n,"0");}else{padded=(""+input).padStart(n,"0");}
return padded;}
function parseInteger(string){if(isUndefined(string)||string===null||string===""){return undefined;}else{return parseInt(string,10);}}
function parseFloating(string){if(isUndefined(string)||string===null||string===""){return undefined;}else{return parseFloat(string);}}
function parseMillis(fraction){if(isUndefined(fraction)||fraction===null||fraction===""){return undefined;}else{const f=parseFloat("0."+fraction)*1000;return Math.floor(f);}}
function roundTo(number,digits,towardZero=false){const factor=10**digits,rounder=towardZero?Math.trunc:Math.round;return rounder(number*factor)/factor;}
function isLeapYear(year){return year%4===0&&(year%100!==0||year%400===0);}
function daysInYear(year){return isLeapYear(year)?366:365;}
function daysInMonth(year,month){const modMonth=floorMod(month-1,12)+1,modYear=year+(month-modMonth)/12;if(modMonth===2){return isLeapYear(modYear)?29:28;}else{return[31,null,31,30,31,30,31,31,30,31,30,31][modMonth-1];}}
function objToLocalTS(obj){let d=Date.UTC(obj.year,obj.month-1,obj.day,obj.hour,obj.minute,obj.second,obj.millisecond);if(obj.year<100&&obj.year>=0){d=new Date(d);d.setUTCFullYear(obj.year,obj.month-1,obj.day);}
return+d;}
function weeksInWeekYear(weekYear){const p1=(weekYear+
Math.floor(weekYear/4)-
Math.floor(weekYear/100)+
Math.floor(weekYear/400))%7,last=weekYear-1,p2=(last+Math.floor(last/4)-Math.floor(last/100)+Math.floor(last/400))%7;return p1===4||p2===3?53:52;}
function untruncateYear(year){if(year>99){return year;}else return year>Settings.twoDigitCutoffYear?1900+year:2000+year;}
function parseZoneInfo(ts,offsetFormat,locale,timeZone=null){const date=new Date(ts),intlOpts={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",};if(timeZone){intlOpts.timeZone=timeZone;}
const modified={timeZoneName:offsetFormat,...intlOpts};const parsed=new Intl.DateTimeFormat(locale,modified).formatToParts(date).find((m)=>m.type.toLowerCase()==="timezonename");return parsed?parsed.value:null;}
function signedOffset(offHourStr,offMinuteStr){let offHour=parseInt(offHourStr,10);if(Number.isNaN(offHour)){offHour=0;}
const offMin=parseInt(offMinuteStr,10)||0,offMinSigned=offHour<0||Object.is(offHour,-0)?-offMin:offMin;return offHour*60+offMinSigned;}
function asNumber(value){const numericValue=Number(value);if(typeof value==="boolean"||value===""||Number.isNaN(numericValue))
throw new InvalidArgumentError(`Invalid unit value ${value}`);return numericValue;}
function normalizeObject(obj,normalizer){const normalized={};for(const u in obj){if(hasOwnProperty(obj,u)){const v=obj[u];if(v===undefined||v===null)continue;normalized[normalizer(u)]=asNumber(v);}}
return normalized;}
function formatOffset(offset,format){const hours=Math.trunc(Math.abs(offset/60)),minutes=Math.trunc(Math.abs(offset%60)),sign=offset>=0?"+":"-";switch(format){case"short":return`${sign}${padStart(hours, 2)}:${padStart(minutes, 2)}`;case"narrow":return`${sign}${hours}${minutes > 0 ? `:${minutes}` : ""}`;case"techie":return`${sign}${padStart(hours, 2)}${padStart(minutes, 2)}`;default:throw new RangeError(`Value format ${format} is out of range for property format`);}}
function timeObject(obj){return pick(obj,["hour","minute","second","millisecond"]);}
const monthsLong=["January","February","March","April","May","June","July","August","September","October","November","December",];const monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec",];const monthsNarrow=["J","F","M","A","M","J","J","A","S","O","N","D"];function months(length){switch(length){case"narrow":return[...monthsNarrow];case"short":return[...monthsShort];case"long":return[...monthsLong];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null;}}
const weekdaysLong=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday",];const weekdaysShort=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];const weekdaysNarrow=["M","T","W","T","F","S","S"];function weekdays(length){switch(length){case"narrow":return[...weekdaysNarrow];case"short":return[...weekdaysShort];case"long":return[...weekdaysLong];case"numeric":return["1","2","3","4","5","6","7"];default:return null;}}
const meridiems=["AM","PM"];const erasLong=["Before Christ","Anno Domini"];const erasShort=["BC","AD"];const erasNarrow=["B","A"];function eras(length){switch(length){case"narrow":return[...erasNarrow];case"short":return[...erasShort];case"long":return[...erasLong];default:return null;}}
function meridiemForDateTime(dt){return meridiems[dt.hour<12?0:1];}
function weekdayForDateTime(dt,length){return weekdays(length)[dt.weekday-1];}
function monthForDateTime(dt,length){return months(length)[dt.month-1];}
function eraForDateTime(dt,length){return eras(length)[dt.year<0?0:1];}
function formatRelativeTime(unit,count,numeric="always",narrow=false){const units={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."],};const lastable=["hours","minutes","seconds"].indexOf(unit)===-1;if(numeric==="auto"&&lastable){const isDay=unit==="days";switch(count){case 1:return isDay?"tomorrow":`next ${units[unit][0]}`;case-1:return isDay?"yesterday":`last ${units[unit][0]}`;case 0:return isDay?"today":`this ${units[unit][0]}`;}}
const isInPast=Object.is(count,-0)||count<0,fmtValue=Math.abs(count),singular=fmtValue===1,lilUnits=units[unit],fmtUnit=narrow?singular?lilUnits[1]:lilUnits[2]||lilUnits[1]:singular?units[unit][0]:unit;return isInPast?`${fmtValue} ${fmtUnit} ago`:`in ${fmtValue} ${fmtUnit}`;}
function stringifyTokens(splits,tokenToString){let s="";for(const token of splits){if(token.literal){s+=token.val;}else{s+=tokenToString(token.val);}}
return s;}
const macroTokenToFormatOpts={D:DATE_SHORT,DD:DATE_MED,DDD:DATE_FULL,DDDD:DATE_HUGE,t:TIME_SIMPLE,tt:TIME_WITH_SECONDS,ttt:TIME_WITH_SHORT_OFFSET,tttt:TIME_WITH_LONG_OFFSET,T:TIME_24_SIMPLE,TT:TIME_24_WITH_SECONDS,TTT:TIME_24_WITH_SHORT_OFFSET,TTTT:TIME_24_WITH_LONG_OFFSET,f:DATETIME_SHORT,ff:DATETIME_MED,fff:DATETIME_FULL,ffff:DATETIME_HUGE,F:DATETIME_SHORT_WITH_SECONDS,FF:DATETIME_MED_WITH_SECONDS,FFF:DATETIME_FULL_WITH_SECONDS,FFFF:DATETIME_HUGE_WITH_SECONDS,};class Formatter{static create(locale,opts={}){return new Formatter(locale,opts);}
static parseFormat(fmt){let current=null,currentFull="",bracketed=false;const splits=[];for(let i=0;i<fmt.length;i++){const c=fmt.charAt(i);if(c==="'"){if(currentFull.length>0){splits.push({literal:bracketed||/^\s+$/.test(currentFull),val:currentFull});}
current=null;currentFull="";bracketed=!bracketed;}else if(bracketed){currentFull+=c;}else if(c===current){currentFull+=c;}else{if(currentFull.length>0){splits.push({literal:/^\s+$/.test(currentFull),val:currentFull});}
currentFull=c;current=c;}}
if(currentFull.length>0){splits.push({literal:bracketed||/^\s+$/.test(currentFull),val:currentFull});}
return splits;}
static macroTokenToFormatOpts(token){return macroTokenToFormatOpts[token];}
constructor(locale,formatOpts){this.opts=formatOpts;this.loc=locale;this.systemLoc=null;}
formatWithSystemDefault(dt,opts){if(this.systemLoc===null){this.systemLoc=this.loc.redefaultToSystem();}
const df=this.systemLoc.dtFormatter(dt,{...this.opts,...opts});return df.format();}
dtFormatter(dt,opts={}){return this.loc.dtFormatter(dt,{...this.opts,...opts});}
formatDateTime(dt,opts){return this.dtFormatter(dt,opts).format();}
formatDateTimeParts(dt,opts){return this.dtFormatter(dt,opts).formatToParts();}
formatInterval(interval,opts){const df=this.dtFormatter(interval.start,opts);return df.dtf.formatRange(interval.start.toJSDate(),interval.end.toJSDate());}
resolvedOptions(dt,opts){return this.dtFormatter(dt,opts).resolvedOptions();}
num(n,p=0){if(this.opts.forceSimple){return padStart(n,p);}
const opts={...this.opts};if(p>0){opts.padTo=p;}
return this.loc.numberFormatter(opts).format(n);}
formatDateTimeFromString(dt,fmt){const knownEnglish=this.loc.listingMode()==="en",useDateTimeFormatter=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",string=(opts,extract)=>this.loc.extract(dt,opts,extract),formatOffset=(opts)=>{if(dt.isOffsetFixed&&dt.offset===0&&opts.allowZ){return"Z";}
return dt.isValid?dt.zone.formatOffset(dt.ts,opts.format):"";},meridiem=()=>knownEnglish?meridiemForDateTime(dt):string({hour:"numeric",hourCycle:"h12"},"dayperiod"),month=(length,standalone)=>knownEnglish?monthForDateTime(dt,length):string(standalone?{month:length}:{month:length,day:"numeric"},"month"),weekday=(length,standalone)=>knownEnglish?weekdayForDateTime(dt,length):string(standalone?{weekday:length}:{weekday:length,month:"long",day:"numeric"},"weekday"),maybeMacro=(token)=>{const formatOpts=Formatter.macroTokenToFormatOpts(token);if(formatOpts){return this.formatWithSystemDefault(dt,formatOpts);}else{return token;}},era=(length)=>knownEnglish?eraForDateTime(dt,length):string({era:length},"era"),tokenToString=(token)=>{switch(token){case"S":return this.num(dt.millisecond);case"u":case"SSS":return this.num(dt.millisecond,3);case"s":return this.num(dt.second);case"ss":return this.num(dt.second,2);case"uu":return this.num(Math.floor(dt.millisecond/10),2);case"uuu":return this.num(Math.floor(dt.millisecond/100));case"m":return this.num(dt.minute);case"mm":return this.num(dt.minute,2);case"h":return this.num(dt.hour%12===0?12:dt.hour%12);case"hh":return this.num(dt.hour%12===0?12:dt.hour%12,2);case"H":return this.num(dt.hour);case"HH":return this.num(dt.hour,2);case"Z":return formatOffset({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return formatOffset({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return formatOffset({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return dt.zone.offsetName(dt.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return dt.zone.offsetName(dt.ts,{format:"long",locale:this.loc.locale});case"z":return dt.zoneName;case"a":return meridiem();case"d":return useDateTimeFormatter?string({day:"numeric"},"day"):this.num(dt.day);case"dd":return useDateTimeFormatter?string({day:"2-digit"},"day"):this.num(dt.day,2);case"c":return this.num(dt.weekday);case"ccc":return weekday("short",true);case"cccc":return weekday("long",true);case"ccccc":return weekday("narrow",true);case"E":return this.num(dt.weekday);case"EEE":return weekday("short",false);case"EEEE":return weekday("long",false);case"EEEEE":return weekday("narrow",false);case"L":return useDateTimeFormatter?string({month:"numeric",day:"numeric"},"month"):this.num(dt.month);case"LL":return useDateTimeFormatter?string({month:"2-digit",day:"numeric"},"month"):this.num(dt.month,2);case"LLL":return month("short",true);case"LLLL":return month("long",true);case"LLLLL":return month("narrow",true);case"M":return useDateTimeFormatter?string({month:"numeric"},"month"):this.num(dt.month);case"MM":return useDateTimeFormatter?string({month:"2-digit"},"month"):this.num(dt.month,2);case"MMM":return month("short",false);case"MMMM":return month("long",false);case"MMMMM":return month("narrow",false);case"y":return useDateTimeFormatter?string({year:"numeric"},"year"):this.num(dt.year);case"yy":return useDateTimeFormatter?string({year:"2-digit"},"year"):this.num(dt.year.toString().slice(-2),2);case"yyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):this.num(dt.year,4);case"yyyyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):this.num(dt.year,6);case"G":return era("short");case"GG":return era("long");case"GGGGG":return era("narrow");case"kk":return this.num(dt.weekYear.toString().slice(-2),2);case"kkkk":return this.num(dt.weekYear,4);case"W":return this.num(dt.weekNumber);case"WW":return this.num(dt.weekNumber,2);case"o":return this.num(dt.ordinal);case"ooo":return this.num(dt.ordinal,3);case"q":return this.num(dt.quarter);case"qq":return this.num(dt.quarter,2);case"X":return this.num(Math.floor(dt.ts/1000));case"x":return this.num(dt.ts);default:return maybeMacro(token);}};return stringifyTokens(Formatter.parseFormat(fmt),tokenToString);}
formatDurationFromString(dur,fmt){const tokenToField=(token)=>{switch(token[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null;}},tokenToString=(lildur)=>(token)=>{const mapped=tokenToField(token);if(mapped){return this.num(lildur.get(mapped),token.length);}else{return token;}},tokens=Formatter.parseFormat(fmt),realTokens=tokens.reduce((found,{literal,val})=>(literal?found:found.concat(val)),[]),collapsed=dur.shiftTo(...realTokens.map(tokenToField).filter((t)=>t));return stringifyTokens(tokens,tokenToString(collapsed));}}
class Invalid{constructor(reason,explanation){this.reason=reason;this.explanation=explanation;}
toMessage(){if(this.explanation){return`${this.reason}: ${this.explanation}`;}else{return this.reason;}}}
const ianaRegex=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function combineRegexes(...regexes){const full=regexes.reduce((f,r)=>f+r.source,"");return RegExp(`^${full}$`);}
function combineExtractors(...extractors){return(m)=>extractors.reduce(([mergedVals,mergedZone,cursor],ex)=>{const[val,zone,next]=ex(m,cursor);return[{...mergedVals,...val},zone||mergedZone,next];},[{},null,1]).slice(0,2);}
function parse(s,...patterns){if(s==null){return[null,null];}
for(const[regex,extractor]of patterns){const m=regex.exec(s);if(m){return extractor(m);}}
return[null,null];}
function simpleParse(...keys){return(match,cursor)=>{const ret={};let i;for(i=0;i<keys.length;i++){ret[keys[i]]=parseInteger(match[cursor+i]);}
return[ret,null,cursor+i];};}
const offsetRegex=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/;const isoExtendedZone=`(?:${offsetRegex.source}?(?:\\[(${ianaRegex.source})\\])?)?`;const isoTimeBaseRegex=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/;const isoTimeRegex=RegExp(`${isoTimeBaseRegex.source}${isoExtendedZone}`);const isoTimeExtensionRegex=RegExp(`(?:T${isoTimeRegex.source})?`);const isoYmdRegex=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/;const isoWeekRegex=/(\d{4})-?W(\d\d)(?:-?(\d))?/;const isoOrdinalRegex=/(\d{4})-?(\d{3})/;const extractISOWeekData=simpleParse("weekYear","weekNumber","weekDay");const extractISOOrdinalData=simpleParse("year","ordinal");const sqlYmdRegex=/(\d{4})-(\d\d)-(\d\d)/;const sqlTimeRegex=RegExp(`${isoTimeBaseRegex.source} ?(?:${offsetRegex.source}|(${ianaRegex.source}))?`);const sqlTimeExtensionRegex=RegExp(`(?: ${sqlTimeRegex.source})?`);function int(match,pos,fallback){const m=match[pos];return isUndefined(m)?fallback:parseInteger(m);}
function extractISOYmd(match,cursor){const item={year:int(match,cursor),month:int(match,cursor+1,1),day:int(match,cursor+2,1),};return[item,null,cursor+3];}
function extractISOTime(match,cursor){const item={hours:int(match,cursor,0),minutes:int(match,cursor+1,0),seconds:int(match,cursor+2,0),milliseconds:parseMillis(match[cursor+3]),};return[item,null,cursor+4];}
function extractISOOffset(match,cursor){const local=!match[cursor]&&!match[cursor+1],fullOffset=signedOffset(match[cursor+1],match[cursor+2]),zone=local?null:FixedOffsetZone.instance(fullOffset);return[{},zone,cursor+3];}
function extractIANAZone(match,cursor){const zone=match[cursor]?IANAZone.create(match[cursor]):null;return[{},zone,cursor+1];}
const isoTimeOnly=RegExp(`^T?${isoTimeBaseRegex.source}$`);const isoDuration=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function extractISODuration(match){const[s,yearStr,monthStr,weekStr,dayStr,hourStr,minuteStr,secondStr,millisecondsStr]=match;const hasNegativePrefix=s[0]==="-";const negativeSeconds=secondStr&&secondStr[0]==="-";const maybeNegate=(num,force=false)=>num!==undefined&&(force||(num&&hasNegativePrefix))?-num:num;return[{years:maybeNegate(parseFloating(yearStr)),months:maybeNegate(parseFloating(monthStr)),weeks:maybeNegate(parseFloating(weekStr)),days:maybeNegate(parseFloating(dayStr)),hours:maybeNegate(parseFloating(hourStr)),minutes:maybeNegate(parseFloating(minuteStr)),seconds:maybeNegate(parseFloating(secondStr),secondStr==="-0"),milliseconds:maybeNegate(parseMillis(millisecondsStr),negativeSeconds),},];}
const obsOffsets={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60,};function fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr){const result={year:yearStr.length===2?untruncateYear(parseInteger(yearStr)):parseInteger(yearStr),month:monthsShort.indexOf(monthStr)+1,day:parseInteger(dayStr),hour:parseInteger(hourStr),minute:parseInteger(minuteStr),};if(secondStr)result.second=parseInteger(secondStr);if(weekdayStr){result.weekday=weekdayStr.length>3?weekdaysLong.indexOf(weekdayStr)+1:weekdaysShort.indexOf(weekdayStr)+1;}
return result;}
const rfc2822=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function extractRFC2822(match){const[,weekdayStr,dayStr,monthStr,yearStr,hourStr,minuteStr,secondStr,obsOffset,milOffset,offHourStr,offMinuteStr,]=match,result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);let offset;if(obsOffset){offset=obsOffsets[obsOffset];}else if(milOffset){offset=0;}else{offset=signedOffset(offHourStr,offMinuteStr);}
return[result,new FixedOffsetZone(offset)];}
function preprocessRFC2822(s){return s.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim();}
const rfc1123=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,rfc850=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,ascii=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function extractRFC1123Or850(match){const[,weekdayStr,dayStr,monthStr,yearStr,hourStr,minuteStr,secondStr]=match,result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);return[result,FixedOffsetZone.utcInstance];}
function extractASCII(match){const[,weekdayStr,monthStr,dayStr,hourStr,minuteStr,secondStr,yearStr]=match,result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);return[result,FixedOffsetZone.utcInstance];}
const isoYmdWithTimeExtensionRegex=combineRegexes(isoYmdRegex,isoTimeExtensionRegex);const isoWeekWithTimeExtensionRegex=combineRegexes(isoWeekRegex,isoTimeExtensionRegex);const isoOrdinalWithTimeExtensionRegex=combineRegexes(isoOrdinalRegex,isoTimeExtensionRegex);const isoTimeCombinedRegex=combineRegexes(isoTimeRegex);const extractISOYmdTimeAndOffset=combineExtractors(extractISOYmd,extractISOTime,extractISOOffset,extractIANAZone);const extractISOWeekTimeAndOffset=combineExtractors(extractISOWeekData,extractISOTime,extractISOOffset,extractIANAZone);const extractISOOrdinalDateAndTime=combineExtractors(extractISOOrdinalData,extractISOTime,extractISOOffset,extractIANAZone);const extractISOTimeAndOffset=combineExtractors(extractISOTime,extractISOOffset,extractIANAZone);function parseISODate(s){return parse(s,[isoYmdWithTimeExtensionRegex,extractISOYmdTimeAndOffset],[isoWeekWithTimeExtensionRegex,extractISOWeekTimeAndOffset],[isoOrdinalWithTimeExtensionRegex,extractISOOrdinalDateAndTime],[isoTimeCombinedRegex,extractISOTimeAndOffset]);}
function parseRFC2822Date(s){return parse(preprocessRFC2822(s),[rfc2822,extractRFC2822]);}
function parseHTTPDate(s){return parse(s,[rfc1123,extractRFC1123Or850],[rfc850,extractRFC1123Or850],[ascii,extractASCII]);}
function parseISODuration(s){return parse(s,[isoDuration,extractISODuration]);}
const extractISOTimeOnly=combineExtractors(extractISOTime);function parseISOTimeOnly(s){return parse(s,[isoTimeOnly,extractISOTimeOnly]);}
const sqlYmdWithTimeExtensionRegex=combineRegexes(sqlYmdRegex,sqlTimeExtensionRegex);const sqlTimeCombinedRegex=combineRegexes(sqlTimeRegex);const extractISOTimeOffsetAndIANAZone=combineExtractors(extractISOTime,extractISOOffset,extractIANAZone);function parseSQL(s){return parse(s,[sqlYmdWithTimeExtensionRegex,extractISOYmdTimeAndOffset],[sqlTimeCombinedRegex,extractISOTimeOffsetAndIANAZone]);}
const INVALID$2="Invalid Duration";const lowOrderMatrix={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1000,},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1000,},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1000},minutes:{seconds:60,milliseconds:60*1000},seconds:{milliseconds:1000},},casualMatrix={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1000,},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1000,},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1000,},...lowOrderMatrix,},daysInYearAccurate=146097.0/400,daysInMonthAccurate=146097.0/4800,accurateMatrix={years:{quarters:4,months:12,weeks:daysInYearAccurate/7,days:daysInYearAccurate,hours:daysInYearAccurate*24,minutes:daysInYearAccurate*24*60,seconds:daysInYearAccurate*24*60*60,milliseconds:daysInYearAccurate*24*60*60*1000,},quarters:{months:3,weeks:daysInYearAccurate/28,days:daysInYearAccurate/4,hours:(daysInYearAccurate*24)/4,minutes:(daysInYearAccurate*24*60)/4,seconds:(daysInYearAccurate*24*60*60)/4,milliseconds:(daysInYearAccurate*24*60*60*1000)/4,},months:{weeks:daysInMonthAccurate/7,days:daysInMonthAccurate,hours:daysInMonthAccurate*24,minutes:daysInMonthAccurate*24*60,seconds:daysInMonthAccurate*24*60*60,milliseconds:daysInMonthAccurate*24*60*60*1000,},...lowOrderMatrix,};const orderedUnits$1=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds",];const reverseUnits=orderedUnits$1.slice(0).reverse();function clone$1(dur,alts,clear=false){const conf={values:clear?alts.values:{...dur.values,...(alts.values||{})},loc:dur.loc.clone(alts.loc),conversionAccuracy:alts.conversionAccuracy||dur.conversionAccuracy,matrix:alts.matrix||dur.matrix,};return new Duration(conf);}
function durationToMillis(matrix,vals){let sum=vals.milliseconds??0;for(const unit of reverseUnits.slice(1)){if(vals[unit]){sum+=vals[unit]*matrix[unit]["milliseconds"];}}
return sum;}
function normalizeValues(matrix,vals){const factor=durationToMillis(matrix,vals)<0?-1:1;reverseUnits.reduce((previous,current)=>{if(!isUndefined(vals[current])){if(previous){const previousVal=vals[previous]*factor;const conv=matrix[current][previous];const rollUp=Math.floor(previousVal/conv);vals[current]+=rollUp*factor;vals[previous]-=rollUp*conv*factor;}
return current;}else{return previous;}},null);}
function removeZeroes(vals){const newVals={};for(const[key,value]of Object.entries(vals)){if(value!==0){newVals[key]=value;}}
return newVals;}
class Duration{constructor(config){const accurate=config.conversionAccuracy==="longterm"||false;let matrix=accurate?accurateMatrix:casualMatrix;if(config.matrix){matrix=config.matrix;}
this.values=config.values;this.loc=config.loc||Locale.create();this.conversionAccuracy=accurate?"longterm":"casual";this.invalid=config.invalid||null;this.matrix=matrix;this.isLuxonDuration=true;}
static fromMillis(count,opts){return Duration.fromObject({milliseconds:count},opts);}
static fromObject(obj,opts={}){if(obj==null||typeof obj!=="object"){throw new InvalidArgumentError(`Duration.fromObject: argument expected to be an object, got ${obj === null ? "null" : typeof obj
          }`);}
return new Duration({values:normalizeObject(obj,Duration.normalizeUnit),loc:Locale.fromObject(opts),conversionAccuracy:opts.conversionAccuracy,matrix:opts.matrix,});}
static fromDurationLike(durationLike){if(isNumber(durationLike)){return Duration.fromMillis(durationLike);}else if(Duration.isDuration(durationLike)){return durationLike;}else if(typeof durationLike==="object"){return Duration.fromObject(durationLike);}else{throw new InvalidArgumentError(`Unknown duration argument ${durationLike} of type ${typeof durationLike}`);}}
static fromISO(text,opts){const[parsed]=parseISODuration(text);if(parsed){return Duration.fromObject(parsed,opts);}else{return Duration.invalid("unparsable",`the input "${text}" can't be parsed as ISO 8601`);}}
static fromISOTime(text,opts){const[parsed]=parseISOTimeOnly(text);if(parsed){return Duration.fromObject(parsed,opts);}else{return Duration.invalid("unparsable",`the input "${text}" can't be parsed as ISO 8601`);}}
static invalid(reason,explanation=null){if(!reason){throw new InvalidArgumentError("need to specify a reason the Duration is invalid");}
const invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidDurationError(invalid);}else{return new Duration({invalid});}}
static normalizeUnit(unit){const normalized={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds",}[unit?unit.toLowerCase():unit];if(!normalized)throw new InvalidUnitError(unit);return normalized;}
static isDuration(o){return(o&&o.isLuxonDuration)||false;}
get locale(){return this.isValid?this.loc.locale:null;}
get numberingSystem(){return this.isValid?this.loc.numberingSystem:null;}
toFormat(fmt,opts={}){const fmtOpts={...opts,floor:opts.round!==false&&opts.floor!==false,};return this.isValid?Formatter.create(this.loc,fmtOpts).formatDurationFromString(this,fmt):INVALID$2;}
toHuman(opts={}){if(!this.isValid)return INVALID$2;const l=orderedUnits$1.map((unit)=>{const val=this.values[unit];if(isUndefined(val)){return null;}
return this.loc.numberFormatter({style:"unit",unitDisplay:"long",...opts,unit:unit.slice(0,-1)}).format(val);}).filter((n)=>n);return this.loc.listFormatter({type:"conjunction",style:opts.listStyle||"narrow",...opts}).format(l);}
toObject(){if(!this.isValid)return{};return{...this.values};}
toISO(){if(!this.isValid)return null;let s="P";if(this.years!==0)s+=this.years+"Y";if(this.months!==0||this.quarters!==0)s+=this.months+this.quarters*3+"M";if(this.weeks!==0)s+=this.weeks+"W";if(this.days!==0)s+=this.days+"D";if(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)
s+="T";if(this.hours!==0)s+=this.hours+"H";if(this.minutes!==0)s+=this.minutes+"M";if(this.seconds!==0||this.milliseconds!==0)
s+=roundTo(this.seconds+this.milliseconds/1000,3)+"S";if(s==="P")s+="T0S";return s;}
toISOTime(opts={}){if(!this.isValid)return null;const millis=this.toMillis();if(millis<0||millis>=86400000)return null;opts={suppressMilliseconds:false,suppressSeconds:false,includePrefix:false,format:"extended",...opts,includeOffset:false,};const dateTime=DateTime.fromMillis(millis,{zone:"UTC"});return dateTime.toISOTime(opts);}
toJSON(){return this.toISO();}
toString(){return this.toISO();}
toMillis(){if(!this.isValid)return NaN;return durationToMillis(this.matrix,this.values);}
valueOf(){return this.toMillis();}
plus(duration){if(!this.isValid)return this;const dur=Duration.fromDurationLike(duration),result={};for(const k of orderedUnits$1){if(hasOwnProperty(dur.values,k)||hasOwnProperty(this.values,k)){result[k]=dur.get(k)+this.get(k);}}
return clone$1(this,{values:result},true);}
minus(duration){if(!this.isValid)return this;const dur=Duration.fromDurationLike(duration);return this.plus(dur.negate());}
mapUnits(fn){if(!this.isValid)return this;const result={};for(const k of Object.keys(this.values)){result[k]=asNumber(fn(this.values[k],k));}
return clone$1(this,{values:result},true);}
get(unit){return this[Duration.normalizeUnit(unit)];}
set(values){if(!this.isValid)return this;const mixed={...this.values,...normalizeObject(values,Duration.normalizeUnit)};return clone$1(this,{values:mixed});}
reconfigure({locale,numberingSystem,conversionAccuracy,matrix}={}){const loc=this.loc.clone({locale,numberingSystem});const opts={loc,matrix,conversionAccuracy};return clone$1(this,opts);}
as(unit){return this.isValid?this.shiftTo(unit).get(unit):NaN;}
normalize(){if(!this.isValid)return this;const vals=this.toObject();normalizeValues(this.matrix,vals);return clone$1(this,{values:vals},true);}
rescale(){if(!this.isValid)return this;const vals=removeZeroes(this.normalize().shiftToAll().toObject());return clone$1(this,{values:vals},true);}
shiftTo(...units){if(!this.isValid)return this;if(units.length===0){return this;}
units=units.map((u)=>Duration.normalizeUnit(u));const built={},accumulated={},vals=this.toObject();let lastUnit;for(const k of orderedUnits$1){if(units.indexOf(k)>=0){lastUnit=k;let own=0;for(const ak in accumulated){own+=this.matrix[ak][k]*accumulated[ak];accumulated[ak]=0;}
if(isNumber(vals[k])){own+=vals[k];}
const i=Math.trunc(own);built[k]=i;accumulated[k]=(own*1000-i*1000)/1000;}else if(isNumber(vals[k])){accumulated[k]=vals[k];}}
for(const key in accumulated){if(accumulated[key]!==0){built[lastUnit]+=key===lastUnit?accumulated[key]:accumulated[key]/this.matrix[lastUnit][key];}}
normalizeValues(this.matrix,built);return clone$1(this,{values:built},true);}
shiftToAll(){if(!this.isValid)return this;return this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds");}
negate(){if(!this.isValid)return this;const negated={};for(const k of Object.keys(this.values)){negated[k]=this.values[k]===0?0:-this.values[k];}
return clone$1(this,{values:negated},true);}
get years(){return this.isValid?this.values.years||0:NaN;}
get quarters(){return this.isValid?this.values.quarters||0:NaN;}
get months(){return this.isValid?this.values.months||0:NaN;}
get weeks(){return this.isValid?this.values.weeks||0:NaN;}
get days(){return this.isValid?this.values.days||0:NaN;}
get hours(){return this.isValid?this.values.hours||0:NaN;}
get minutes(){return this.isValid?this.values.minutes||0:NaN;}
get seconds(){return this.isValid?this.values.seconds||0:NaN;}
get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN;}
get isValid(){return this.invalid===null;}
get invalidReason(){return this.invalid?this.invalid.reason:null;}
get invalidExplanation(){return this.invalid?this.invalid.explanation:null;}
equals(other){if(!this.isValid||!other.isValid){return false;}
if(!this.loc.equals(other.loc)){return false;}
function eq(v1,v2){if(v1===undefined||v1===0)return v2===undefined||v2===0;return v1===v2;}
for(const u of orderedUnits$1){if(!eq(this.values[u],other.values[u])){return false;}}
return true;}}
const INVALID$1="Invalid Interval";function validateStartEnd(start,end){if(!start||!start.isValid){return Interval.invalid("missing or invalid start");}else if(!end||!end.isValid){return Interval.invalid("missing or invalid end");}else if(end<start){return Interval.invalid("end before start",`The end of an interval must be after its start, but you had start=${start.toISO()} and end=${end.toISO()}`);}else{return null;}}
class Interval{constructor(config){this.s=config.start;this.e=config.end;this.invalid=config.invalid||null;this.isLuxonInterval=true;}
static invalid(reason,explanation=null){if(!reason){throw new InvalidArgumentError("need to specify a reason the Interval is invalid");}
const invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidIntervalError(invalid);}else{return new Interval({invalid});}}
static fromDateTimes(start,end){const builtStart=friendlyDateTime(start),builtEnd=friendlyDateTime(end);const validateError=validateStartEnd(builtStart,builtEnd);if(validateError==null){return new Interval({start:builtStart,end:builtEnd,});}else{return validateError;}}
static after(start,duration){const dur=Duration.fromDurationLike(duration),dt=friendlyDateTime(start);return Interval.fromDateTimes(dt,dt.plus(dur));}
static before(end,duration){const dur=Duration.fromDurationLike(duration),dt=friendlyDateTime(end);return Interval.fromDateTimes(dt.minus(dur),dt);}
static fromISO(text,opts){const[s,e]=(text||"").split("/",2);if(s&&e){let start,startIsValid;try{start=DateTime.fromISO(s,opts);startIsValid=start.isValid;}catch(e){startIsValid=false;}
let end,endIsValid;try{end=DateTime.fromISO(e,opts);endIsValid=end.isValid;}catch(e){endIsValid=false;}
if(startIsValid&&endIsValid){return Interval.fromDateTimes(start,end);}
if(startIsValid){const dur=Duration.fromISO(e,opts);if(dur.isValid){return Interval.after(start,dur);}}else if(endIsValid){const dur=Duration.fromISO(s,opts);if(dur.isValid){return Interval.before(end,dur);}}}
return Interval.invalid("unparsable",`the input "${text}" can't be parsed as ISO 8601`);}
static isInterval(o){return(o&&o.isLuxonInterval)||false;}
get start(){return this.isValid?this.s:null;}
get end(){return this.isValid?this.e:null;}
get isValid(){return this.invalidReason===null;}
get invalidReason(){return this.invalid?this.invalid.reason:null;}
get invalidExplanation(){return this.invalid?this.invalid.explanation:null;}
length(unit="milliseconds"){return this.isValid?this.toDuration(...[unit]).get(unit):NaN;}
count(unit="milliseconds"){if(!this.isValid)return NaN;const start=this.start.startOf(unit),end=this.end.startOf(unit);return Math.floor(end.diff(start,unit).get(unit))+(end.valueOf()!==this.end.valueOf());}
hasSame(unit){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,unit):false;}
isEmpty(){return this.s.valueOf()===this.e.valueOf();}
isAfter(dateTime){if(!this.isValid)return false;return this.s>dateTime;}
isBefore(dateTime){if(!this.isValid)return false;return this.e<=dateTime;}
contains(dateTime){if(!this.isValid)return false;return this.s<=dateTime&&this.e>dateTime;}
set({start,end}={}){if(!this.isValid)return this;return Interval.fromDateTimes(start||this.s,end||this.e);}
splitAt(...dateTimes){if(!this.isValid)return[];const sorted=dateTimes.map(friendlyDateTime).filter((d)=>this.contains(d)).sort(),results=[];let{s}=this,i=0;while(s<this.e){const added=sorted[i]||this.e,next=+added>+this.e?this.e:added;results.push(Interval.fromDateTimes(s,next));s=next;i+=1;}
return results;}
splitBy(duration){const dur=Duration.fromDurationLike(duration);if(!this.isValid||!dur.isValid||dur.as("milliseconds")===0){return[];}
let{s}=this,idx=1,next;const results=[];while(s<this.e){const added=this.start.plus(dur.mapUnits((x)=>x*idx));next=+added>+this.e?this.e:added;results.push(Interval.fromDateTimes(s,next));s=next;idx+=1;}
return results;}
divideEqually(numberOfParts){if(!this.isValid)return[];return this.splitBy(this.length()/numberOfParts).slice(0,numberOfParts);}
overlaps(other){return this.e>other.s&&this.s<other.e;}
abutsStart(other){if(!this.isValid)return false;return+this.e===+other.s;}
abutsEnd(other){if(!this.isValid)return false;return+other.e===+this.s;}
engulfs(other){if(!this.isValid)return false;return this.s<=other.s&&this.e>=other.e;}
equals(other){if(!this.isValid||!other.isValid){return false;}
return this.s.equals(other.s)&&this.e.equals(other.e);}
intersection(other){if(!this.isValid)return this;const s=this.s>other.s?this.s:other.s,e=this.e<other.e?this.e:other.e;if(s>=e){return null;}else{return Interval.fromDateTimes(s,e);}}
union(other){if(!this.isValid)return this;const s=this.s<other.s?this.s:other.s,e=this.e>other.e?this.e:other.e;return Interval.fromDateTimes(s,e);}
static merge(intervals){const[found,final]=intervals.sort((a,b)=>a.s-b.s).reduce(([sofar,current],item)=>{if(!current){return[sofar,item];}else if(current.overlaps(item)||current.abutsStart(item)){return[sofar,current.union(item)];}else{return[sofar.concat([current]),item];}},[[],null]);if(final){found.push(final);}
return found;}
static xor(intervals){let start=null,currentCount=0;const results=[],ends=intervals.map((i)=>[{time:i.s,type:"s"},{time:i.e,type:"e"},]),flattened=Array.prototype.concat(...ends),arr=flattened.sort((a,b)=>a.time-b.time);for(const i of arr){currentCount+=i.type==="s"?1:-1;if(currentCount===1){start=i.time;}else{if(start&&+start!==+i.time){results.push(Interval.fromDateTimes(start,i.time));}
start=null;}}
return Interval.merge(results);}
difference(...intervals){return Interval.xor([this].concat(intervals)).map((i)=>this.intersection(i)).filter((i)=>i&&!i.isEmpty());}
toString(){if(!this.isValid)return INVALID$1;return`[${this.s.toISO()} – ${this.e.toISO()})`;}
toLocaleString(formatOpts=DATE_SHORT,opts={}){return this.isValid?Formatter.create(this.s.loc.clone(opts),formatOpts).formatInterval(this):INVALID$1;}
toISO(opts){if(!this.isValid)return INVALID$1;return`${this.s.toISO(opts)}/${this.e.toISO(opts)}`;}
toISODate(){if(!this.isValid)return INVALID$1;return`${this.s.toISODate()}/${this.e.toISODate()}`;}
toISOTime(opts){if(!this.isValid)return INVALID$1;return`${this.s.toISOTime(opts)}/${this.e.toISOTime(opts)}`;}
toFormat(dateFormat,{separator=" – "}={}){if(!this.isValid)return INVALID$1;return`${this.s.toFormat(dateFormat)}${separator}${this.e.toFormat(dateFormat)}`;}
toDuration(unit,opts){if(!this.isValid){return Duration.invalid(this.invalidReason);}
return this.e.diff(this.s,unit,opts);}
mapEndpoints(mapFn){return Interval.fromDateTimes(mapFn(this.s),mapFn(this.e));}}
class Info{static hasDST(zone=Settings.defaultZone){const proto=DateTime.now().setZone(zone).set({month:12});return!zone.isUniversal&&proto.offset!==proto.set({month:6}).offset;}
static isValidIANAZone(zone){return IANAZone.isValidZone(zone);}
static normalizeZone(input){return normalizeZone(input,Settings.defaultZone);}
static months(length="long",{locale=null,numberingSystem=null,locObj=null,outputCalendar="gregory"}={}){return(locObj||Locale.create(locale,numberingSystem,outputCalendar)).months(length);}
static monthsFormat(length="long",{locale=null,numberingSystem=null,locObj=null,outputCalendar="gregory"}={}){return(locObj||Locale.create(locale,numberingSystem,outputCalendar)).months(length,true);}
static weekdays(length="long",{locale=null,numberingSystem=null,locObj=null}={}){return(locObj||Locale.create(locale,numberingSystem,null)).weekdays(length);}
static weekdaysFormat(length="long",{locale=null,numberingSystem=null,locObj=null}={}){return(locObj||Locale.create(locale,numberingSystem,null)).weekdays(length,true);}
static meridiems({locale=null}={}){return Locale.create(locale).meridiems();}
static eras(length="short",{locale=null}={}){return Locale.create(locale,null,"gregory").eras(length);}
static features(){return{relative:hasRelative()};}}
function dayDiff(earlier,later){const utcDayStart=(dt)=>dt.toUTC(0,{keepLocalTime:true}).startOf("day").valueOf(),ms=utcDayStart(later)-utcDayStart(earlier);return Math.floor(Duration.fromMillis(ms).as("days"));}
function highOrderDiffs(cursor,later,units){const differs=[["years",(a,b)=>b.year-a.year],["quarters",(a,b)=>b.quarter-a.quarter+(b.year-a.year)*4],["months",(a,b)=>b.month-a.month+(b.year-a.year)*12],["weeks",(a,b)=>{const days=dayDiff(a,b);return(days-(days%7))/7;},],["days",dayDiff],];const results={};const earlier=cursor;let lowestOrder,highWater;for(const[unit,differ]of differs){if(units.indexOf(unit)>=0){lowestOrder=unit;results[unit]=differ(cursor,later);highWater=earlier.plus(results);if(highWater>later){results[unit]--;cursor=earlier.plus(results);if(cursor>later){highWater=cursor;results[unit]--;cursor=earlier.plus(results);}}else{cursor=highWater;}}}
return[cursor,results,highWater,lowestOrder];}
function diff(earlier,later,units,opts){let[cursor,results,highWater,lowestOrder]=highOrderDiffs(earlier,later,units);const remainingMillis=later-cursor;const lowerOrderUnits=units.filter((u)=>["hours","minutes","seconds","milliseconds"].indexOf(u)>=0);if(lowerOrderUnits.length===0){if(highWater<later){highWater=cursor.plus({[lowestOrder]:1});}
if(highWater!==cursor){results[lowestOrder]=(results[lowestOrder]||0)+remainingMillis/(highWater-cursor);}}
const duration=Duration.fromObject(results,opts);if(lowerOrderUnits.length>0){return Duration.fromMillis(remainingMillis,opts).shiftTo(...lowerOrderUnits).plus(duration);}else{return duration;}}
const numberingSystems={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d",};const numberingSystemsUTF16={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881],};const hanidecChars=numberingSystems.hanidec.replace(/[\[|\]]/g,"").split("");function parseDigits(str){let value=parseInt(str,10);if(isNaN(value)){value="";for(let i=0;i<str.length;i++){const code=str.charCodeAt(i);if(str[i].search(numberingSystems.hanidec)!==-1){value+=hanidecChars.indexOf(str[i]);}else{for(const key in numberingSystemsUTF16){const[min,max]=numberingSystemsUTF16[key];if(code>=min&&code<=max){value+=code-min;}}}}
return parseInt(value,10);}else{return value;}}
function digitRegex({numberingSystem},append=""){return new RegExp(`${numberingSystems[numberingSystem || "latn"]}${append}`);}
const MISSING_FTP="missing Intl.DateTimeFormat.formatToParts support";function intUnit(regex,post=(i)=>i){return{regex,deser:([s])=>post(parseDigits(s))};}
const NBSP=String.fromCharCode(160);const spaceOrNBSP=`[ ${NBSP}]`;const spaceOrNBSPRegExp=new RegExp(spaceOrNBSP,"g");function fixListRegex(s){return s.replace(/\./g,"\\.?").replace(spaceOrNBSPRegExp,spaceOrNBSP);}
function stripInsensitivities(s){return s.replace(/\./g,"").replace(spaceOrNBSPRegExp," ").toLowerCase();}
function oneOf(strings,startIndex){if(strings===null){return null;}else{return{regex:RegExp(strings.map(fixListRegex).join("|")),deser:([s])=>strings.findIndex((i)=>stripInsensitivities(s)===stripInsensitivities(i))+startIndex,};}}
function offset(regex,groups){return{regex,deser:([,h,m])=>signedOffset(h,m),groups};}
function simple(regex){return{regex,deser:([s])=>s};}
function escapeToken(value){return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");}
function unitForToken(token,loc){const one=digitRegex(loc),two=digitRegex(loc,"{2}"),three=digitRegex(loc,"{3}"),four=digitRegex(loc,"{4}"),six=digitRegex(loc,"{6}"),oneOrTwo=digitRegex(loc,"{1,2}"),oneToThree=digitRegex(loc,"{1,3}"),oneToSix=digitRegex(loc,"{1,6}"),oneToNine=digitRegex(loc,"{1,9}"),twoToFour=digitRegex(loc,"{2,4}"),fourToSix=digitRegex(loc,"{4,6}"),literal=(t)=>({regex:RegExp(escapeToken(t.val)),deser:([s])=>s,literal:true}),unitate=(t)=>{if(token.literal){return literal(t);}
switch(t.val){case"G":return oneOf(loc.eras("short"),0);case"GG":return oneOf(loc.eras("long"),0);case"y":return intUnit(oneToSix);case"yy":return intUnit(twoToFour,untruncateYear);case"yyyy":return intUnit(four);case"yyyyy":return intUnit(fourToSix);case"yyyyyy":return intUnit(six);case"M":return intUnit(oneOrTwo);case"MM":return intUnit(two);case"MMM":return oneOf(loc.months("short",true),1);case"MMMM":return oneOf(loc.months("long",true),1);case"L":return intUnit(oneOrTwo);case"LL":return intUnit(two);case"LLL":return oneOf(loc.months("short",false),1);case"LLLL":return oneOf(loc.months("long",false),1);case"d":return intUnit(oneOrTwo);case"dd":return intUnit(two);case"o":return intUnit(oneToThree);case"ooo":return intUnit(three);case"HH":return intUnit(two);case"H":return intUnit(oneOrTwo);case"hh":return intUnit(two);case"h":return intUnit(oneOrTwo);case"mm":return intUnit(two);case"m":return intUnit(oneOrTwo);case"q":return intUnit(oneOrTwo);case"qq":return intUnit(two);case"s":return intUnit(oneOrTwo);case"ss":return intUnit(two);case"S":return intUnit(oneToThree);case"SSS":return intUnit(three);case"u":return simple(oneToNine);case"uu":return simple(oneOrTwo);case"uuu":return intUnit(one);case"a":return oneOf(loc.meridiems(),0);case"kkkk":return intUnit(four);case"kk":return intUnit(twoToFour,untruncateYear);case"W":return intUnit(oneOrTwo);case"WW":return intUnit(two);case"E":case"c":return intUnit(one);case"EEE":return oneOf(loc.weekdays("short",false),1);case"EEEE":return oneOf(loc.weekdays("long",false),1);case"ccc":return oneOf(loc.weekdays("short",true),1);case"cccc":return oneOf(loc.weekdays("long",true),1);case"Z":case"ZZ":return offset(new RegExp(`([+-]${oneOrTwo.source})(?::(${two.source}))?`),2);case"ZZZ":return offset(new RegExp(`([+-]${oneOrTwo.source})(${two.source})?`),2);case"z":return simple(/[a-z_+-/]{1,256}?/i);case" ":return simple(/[^\S\n\r]/);default:return literal(t);}};const unit=unitate(token)||{invalidReason:MISSING_FTP,};unit.token=token;return unit;}
const partTypeStyleToTokenVal={year:{"2-digit":"yy",numeric:"yyyyy",},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM",},day:{numeric:"d","2-digit":"dd",},weekday:{short:"EEE",long:"EEEE",},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh",},hour24:{numeric:"H","2-digit":"HH",},minute:{numeric:"m","2-digit":"mm",},second:{numeric:"s","2-digit":"ss",},timeZoneName:{long:"ZZZZZ",short:"ZZZ",},};function tokenForPart(part,formatOpts,resolvedOpts){const{type,value}=part;if(type==="literal"){const isSpace=/^\s+$/.test(value);return{literal:!isSpace,val:isSpace?" ":value,};}
const style=formatOpts[type];let actualType=type;if(type==="hour"){if(formatOpts.hour12!=null){actualType=formatOpts.hour12?"hour12":"hour24";}else if(formatOpts.hourCycle!=null){if(formatOpts.hourCycle==="h11"||formatOpts.hourCycle==="h12"){actualType="hour12";}else{actualType="hour24";}}else{actualType=resolvedOpts.hour12?"hour12":"hour24";}}
let val=partTypeStyleToTokenVal[actualType];if(typeof val==="object"){val=val[style];}
if(val){return{literal:false,val,};}
return undefined;}
function buildRegex(units){const re=units.map((u)=>u.regex).reduce((f,r)=>`${f}(${r.source})`,"");return[`^${re}$`,units];}
function match(input,regex,handlers){const matches=input.match(regex);if(matches){const all={};let matchIndex=1;for(const i in handlers){if(hasOwnProperty(handlers,i)){const h=handlers[i],groups=h.groups?h.groups+1:1;if(!h.literal&&h.token){all[h.token.val[0]]=h.deser(matches.slice(matchIndex,matchIndex+groups));}
matchIndex+=groups;}}
return[matches,all];}else{return[matches,{}];}}
function dateTimeFromMatches(matches){const toField=(token)=>{switch(token){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null;}};let zone=null;let specificOffset;if(!isUndefined(matches.z)){zone=IANAZone.create(matches.z);}
if(!isUndefined(matches.Z)){if(!zone){zone=new FixedOffsetZone(matches.Z);}
specificOffset=matches.Z;}
if(!isUndefined(matches.q)){matches.M=(matches.q-1)*3+1;}
if(!isUndefined(matches.h)){if(matches.h<12&&matches.a===1){matches.h+=12;}else if(matches.h===12&&matches.a===0){matches.h=0;}}
if(matches.G===0&&matches.y){matches.y=-matches.y;}
if(!isUndefined(matches.u)){matches.S=parseMillis(matches.u);}
const vals=Object.keys(matches).reduce((r,k)=>{const f=toField(k);if(f){r[f]=matches[k];}
return r;},{});return[vals,zone,specificOffset];}
let dummyDateTimeCache=null;function getDummyDateTime(){if(!dummyDateTimeCache){dummyDateTimeCache=DateTime.fromMillis(1555555555555);}
return dummyDateTimeCache;}
function maybeExpandMacroToken(token,locale){if(token.literal){return token;}
const formatOpts=Formatter.macroTokenToFormatOpts(token.val);const tokens=formatOptsToTokens(formatOpts,locale);if(tokens==null||tokens.includes(undefined)){return token;}
return tokens;}
function expandMacroTokens(tokens,locale){return Array.prototype.concat(...tokens.map((t)=>maybeExpandMacroToken(t,locale)));}
function explainFromTokens(locale,input,format){const tokens=expandMacroTokens(Formatter.parseFormat(format),locale),units=tokens.map((t)=>unitForToken(t,locale)),disqualifyingUnit=units.find((t)=>t.invalidReason);if(disqualifyingUnit){return{input,tokens,invalidReason:disqualifyingUnit.invalidReason};}else{const[regexString,handlers]=buildRegex(units),regex=RegExp(regexString,"i"),[rawMatches,matches]=match(input,regex,handlers),[result,zone,specificOffset]=matches?dateTimeFromMatches(matches):[null,null,undefined];if(hasOwnProperty(matches,"a")&&hasOwnProperty(matches,"H")){throw new ConflictingSpecificationError("Can't include meridiem when specifying 24-hour format");}
return{input,tokens,regex,rawMatches,matches,result,zone,specificOffset};}}
function parseFromTokens(locale,input,format){const{result,zone,specificOffset,invalidReason}=explainFromTokens(locale,input,format);return[result,zone,specificOffset,invalidReason];}
function formatOptsToTokens(formatOpts,locale){if(!formatOpts){return null;}
const formatter=Formatter.create(locale,formatOpts);const df=formatter.dtFormatter(getDummyDateTime());const parts=df.formatToParts();const resolvedOpts=df.resolvedOptions();return parts.map((p)=>tokenForPart(p,formatOpts,resolvedOpts));}
const nonLeapLadder=[0,31,59,90,120,151,181,212,243,273,304,334],leapLadder=[0,31,60,91,121,152,182,213,244,274,305,335];function unitOutOfRange(unit,value){return new Invalid("unit out of range",`you specified ${value} (of type ${typeof value}) as a ${unit}, which is invalid`);}
function dayOfWeek(year,month,day){const d=new Date(Date.UTC(year,month-1,day));if(year<100&&year>=0){d.setUTCFullYear(d.getUTCFullYear()-1900);}
const js=d.getUTCDay();return js===0?7:js;}
function computeOrdinal(year,month,day){return day+(isLeapYear(year)?leapLadder:nonLeapLadder)[month-1];}
function uncomputeOrdinal(year,ordinal){const table=isLeapYear(year)?leapLadder:nonLeapLadder,month0=table.findIndex((i)=>i<ordinal),day=ordinal-table[month0];return{month:month0+1,day};}
function gregorianToWeek(gregObj){const{year,month,day}=gregObj,ordinal=computeOrdinal(year,month,day),weekday=dayOfWeek(year,month,day);let weekNumber=Math.floor((ordinal-weekday+10)/7),weekYear;if(weekNumber<1){weekYear=year-1;weekNumber=weeksInWeekYear(weekYear);}else if(weekNumber>weeksInWeekYear(year)){weekYear=year+1;weekNumber=1;}else{weekYear=year;}
return{weekYear,weekNumber,weekday,...timeObject(gregObj)};}
function weekToGregorian(weekData){const{weekYear,weekNumber,weekday}=weekData,weekdayOfJan4=dayOfWeek(weekYear,1,4),yearInDays=daysInYear(weekYear);let ordinal=weekNumber*7+weekday-weekdayOfJan4-3,year;if(ordinal<1){year=weekYear-1;ordinal+=daysInYear(year);}else if(ordinal>yearInDays){year=weekYear+1;ordinal-=daysInYear(weekYear);}else{year=weekYear;}
const{month,day}=uncomputeOrdinal(year,ordinal);return{year,month,day,...timeObject(weekData)};}
function gregorianToOrdinal(gregData){const{year,month,day}=gregData;const ordinal=computeOrdinal(year,month,day);return{year,ordinal,...timeObject(gregData)};}
function ordinalToGregorian(ordinalData){const{year,ordinal}=ordinalData;const{month,day}=uncomputeOrdinal(year,ordinal);return{year,month,day,...timeObject(ordinalData)};}
function hasInvalidWeekData(obj){const validYear=isInteger(obj.weekYear),validWeek=integerBetween(obj.weekNumber,1,weeksInWeekYear(obj.weekYear)),validWeekday=integerBetween(obj.weekday,1,7);if(!validYear){return unitOutOfRange("weekYear",obj.weekYear);}else if(!validWeek){return unitOutOfRange("week",obj.week);}else if(!validWeekday){return unitOutOfRange("weekday",obj.weekday);}else return false;}
function hasInvalidOrdinalData(obj){const validYear=isInteger(obj.year),validOrdinal=integerBetween(obj.ordinal,1,daysInYear(obj.year));if(!validYear){return unitOutOfRange("year",obj.year);}else if(!validOrdinal){return unitOutOfRange("ordinal",obj.ordinal);}else return false;}
function hasInvalidGregorianData(obj){const validYear=isInteger(obj.year),validMonth=integerBetween(obj.month,1,12),validDay=integerBetween(obj.day,1,daysInMonth(obj.year,obj.month));if(!validYear){return unitOutOfRange("year",obj.year);}else if(!validMonth){return unitOutOfRange("month",obj.month);}else if(!validDay){return unitOutOfRange("day",obj.day);}else return false;}
function hasInvalidTimeData(obj){const{hour,minute,second,millisecond}=obj;const validHour=integerBetween(hour,0,23)||(hour===24&&minute===0&&second===0&&millisecond===0),validMinute=integerBetween(minute,0,59),validSecond=integerBetween(second,0,59),validMillisecond=integerBetween(millisecond,0,999);if(!validHour){return unitOutOfRange("hour",hour);}else if(!validMinute){return unitOutOfRange("minute",minute);}else if(!validSecond){return unitOutOfRange("second",second);}else if(!validMillisecond){return unitOutOfRange("millisecond",millisecond);}else return false;}
const INVALID="Invalid DateTime";const MAX_DATE=8.64e15;function unsupportedZone(zone){return new Invalid("unsupported zone",`the zone "${zone.name}" is not supported`);}
function possiblyCachedWeekData(dt){if(dt.weekData===null){dt.weekData=gregorianToWeek(dt.c);}
return dt.weekData;}
function clone(inst,alts){const current={ts:inst.ts,zone:inst.zone,c:inst.c,o:inst.o,loc:inst.loc,invalid:inst.invalid,};return new DateTime({...current,...alts,old:current});}
function fixOffset(localTS,o,tz){let utcGuess=localTS-o*60*1000;const o2=tz.offset(utcGuess);if(o===o2){return[utcGuess,o];}
utcGuess-=(o2-o)*60*1000;const o3=tz.offset(utcGuess);if(o2===o3){return[utcGuess,o2];}
return[localTS-Math.min(o2,o3)*60*1000,Math.max(o2,o3)];}
function tsToObj(ts,offset){ts+=offset*60*1000;const d=new Date(ts);return{year:d.getUTCFullYear(),month:d.getUTCMonth()+1,day:d.getUTCDate(),hour:d.getUTCHours(),minute:d.getUTCMinutes(),second:d.getUTCSeconds(),millisecond:d.getUTCMilliseconds(),};}
function objToTS(obj,offset,zone){return fixOffset(objToLocalTS(obj),offset,zone);}
function adjustTime(inst,dur){const oPre=inst.o,year=inst.c.year+Math.trunc(dur.years),month=inst.c.month+Math.trunc(dur.months)+Math.trunc(dur.quarters)*3,c={...inst.c,year,month,day:Math.min(inst.c.day,daysInMonth(year,month))+
Math.trunc(dur.days)+
Math.trunc(dur.weeks)*7,},millisToAdd=Duration.fromObject({years:dur.years-Math.trunc(dur.years),quarters:dur.quarters-Math.trunc(dur.quarters),months:dur.months-Math.trunc(dur.months),weeks:dur.weeks-Math.trunc(dur.weeks),days:dur.days-Math.trunc(dur.days),hours:dur.hours,minutes:dur.minutes,seconds:dur.seconds,milliseconds:dur.milliseconds,}).as("milliseconds"),localTS=objToLocalTS(c);let[ts,o]=fixOffset(localTS,oPre,inst.zone);if(millisToAdd!==0){ts+=millisToAdd;o=inst.zone.offset(ts);}
return{ts,o};}
function parseDataToDateTime(parsed,parsedZone,opts,format,text,specificOffset){const{setZone,zone}=opts;if((parsed&&Object.keys(parsed).length!==0)||parsedZone){const interpretationZone=parsedZone||zone,inst=DateTime.fromObject(parsed,{...opts,zone:interpretationZone,specificOffset,});return setZone?inst:inst.setZone(zone);}else{return DateTime.invalid(new Invalid("unparsable",`the input "${text}" can't be parsed as ${format}`));}}
function toTechFormat(dt,format,allowZ=true){return dt.isValid?Formatter.create(Locale.create("en-US"),{allowZ,forceSimple:true,}).formatDateTimeFromString(dt,format):null;}
function toISODate(o,extended){const longFormat=o.c.year>9999||o.c.year<0;let c="";if(longFormat&&o.c.year>=0)c+="+";c+=padStart(o.c.year,longFormat?6:4);if(extended){c+="-";c+=padStart(o.c.month);c+="-";c+=padStart(o.c.day);}else{c+=padStart(o.c.month);c+=padStart(o.c.day);}
return c;}
function toISOTime(o,extended,suppressSeconds,suppressMilliseconds,includeOffset,extendedZone){let c=padStart(o.c.hour);if(extended){c+=":";c+=padStart(o.c.minute);if(o.c.millisecond!==0||o.c.second!==0||!suppressSeconds){c+=":";}}else{c+=padStart(o.c.minute);}
if(o.c.millisecond!==0||o.c.second!==0||!suppressSeconds){c+=padStart(o.c.second);if(o.c.millisecond!==0||!suppressMilliseconds){c+=".";c+=padStart(o.c.millisecond,3);}}
if(includeOffset){if(o.isOffsetFixed&&o.offset===0&&!extendedZone){c+="Z";}else if(o.o<0){c+="-";c+=padStart(Math.trunc(-o.o/60));c+=":";c+=padStart(Math.trunc(-o.o%60));}else{c+="+";c+=padStart(Math.trunc(o.o/60));c+=":";c+=padStart(Math.trunc(o.o%60));}}
if(extendedZone){c+="["+o.zone.ianaName+"]";}
return c;}
const defaultUnitValues={month:1,day:1,hour:0,minute:0,second:0,millisecond:0,},defaultWeekUnitValues={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0,},defaultOrdinalUnitValues={ordinal:1,hour:0,minute:0,second:0,millisecond:0,};const orderedUnits=["year","month","day","hour","minute","second","millisecond"],orderedWeekUnits=["weekYear","weekNumber","weekday","hour","minute","second","millisecond",],orderedOrdinalUnits=["year","ordinal","hour","minute","second","millisecond"];function normalizeUnit(unit){const normalized={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal",}[unit.toLowerCase()];if(!normalized)throw new InvalidUnitError(unit);return normalized;}
function quickDT(obj,opts){const zone=normalizeZone(opts.zone,Settings.defaultZone),loc=Locale.fromObject(opts),tsNow=Settings.now();let ts,o;if(!isUndefined(obj.year)){for(const u of orderedUnits){if(isUndefined(obj[u])){obj[u]=defaultUnitValues[u];}}
const invalid=hasInvalidGregorianData(obj)||hasInvalidTimeData(obj);if(invalid){return DateTime.invalid(invalid);}
const offsetProvis=zone.offset(tsNow);[ts,o]=objToTS(obj,offsetProvis,zone);}else{ts=tsNow;}
return new DateTime({ts,zone,loc,o});}
function diffRelative(start,end,opts){const round=isUndefined(opts.round)?true:opts.round,format=(c,unit)=>{c=roundTo(c,round||opts.calendary?0:2,true);const formatter=end.loc.clone(opts).relFormatter(opts);return formatter.format(c,unit);},differ=(unit)=>{if(opts.calendary){if(!end.hasSame(start,unit)){return end.startOf(unit).diff(start.startOf(unit),unit).get(unit);}else return 0;}else{return end.diff(start,unit).get(unit);}};if(opts.unit){return format(differ(opts.unit),opts.unit);}
for(const unit of opts.units){const count=differ(unit);if(Math.abs(count)>=1){return format(count,unit);}}
return format(start>end?-0:0,opts.units[opts.units.length-1]);}
function lastOpts(argList){let opts={},args;if(argList.length>0&&typeof argList[argList.length-1]==="object"){opts=argList[argList.length-1];args=Array.from(argList).slice(0,argList.length-1);}else{args=Array.from(argList);}
return[opts,args];}
class DateTime{constructor(config){const zone=config.zone||Settings.defaultZone;let invalid=config.invalid||(Number.isNaN(config.ts)?new Invalid("invalid input"):null)||(!zone.isValid?unsupportedZone(zone):null);this.ts=isUndefined(config.ts)?Settings.now():config.ts;let c=null,o=null;if(!invalid){const unchanged=config.old&&config.old.ts===this.ts&&config.old.zone.equals(zone);if(unchanged){[c,o]=[config.old.c,config.old.o];}else{const ot=zone.offset(this.ts);c=tsToObj(this.ts,ot);invalid=Number.isNaN(c.year)?new Invalid("invalid input"):null;c=invalid?null:c;o=invalid?null:ot;}}
this._zone=zone;this.loc=config.loc||Locale.create();this.invalid=invalid;this.weekData=null;this.c=c;this.o=o;this.isLuxonDateTime=true;}
static now(){return new DateTime({});}
static local(){const[opts,args]=lastOpts(arguments),[year,month,day,hour,minute,second,millisecond]=args;return quickDT({year,month,day,hour,minute,second,millisecond},opts);}
static utc(){const[opts,args]=lastOpts(arguments),[year,month,day,hour,minute,second,millisecond]=args;opts.zone=FixedOffsetZone.utcInstance;return quickDT({year,month,day,hour,minute,second,millisecond},opts);}
static fromJSDate(date,options={}){const ts=isDate(date)?date.valueOf():NaN;if(Number.isNaN(ts)){return DateTime.invalid("invalid input");}
const zoneToUse=normalizeZone(options.zone,Settings.defaultZone);if(!zoneToUse.isValid){return DateTime.invalid(unsupportedZone(zoneToUse));}
return new DateTime({ts:ts,zone:zoneToUse,loc:Locale.fromObject(options),});}
static fromMillis(milliseconds,options={}){if(!isNumber(milliseconds)){throw new InvalidArgumentError(`fromMillis requires a numerical input, but received a ${typeof milliseconds} with value ${milliseconds}`);}else if(milliseconds<-MAX_DATE||milliseconds>MAX_DATE){return DateTime.invalid("Timestamp out of range");}else{return new DateTime({ts:milliseconds,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options),});}}
static fromSeconds(seconds,options={}){if(!isNumber(seconds)){throw new InvalidArgumentError("fromSeconds requires a numerical input");}else{return new DateTime({ts:seconds*1000,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options),});}}
static fromObject(obj,opts={}){obj=obj||{};const zoneToUse=normalizeZone(opts.zone,Settings.defaultZone);if(!zoneToUse.isValid){return DateTime.invalid(unsupportedZone(zoneToUse));}
const tsNow=Settings.now(),offsetProvis=!isUndefined(opts.specificOffset)?opts.specificOffset:zoneToUse.offset(tsNow),normalized=normalizeObject(obj,normalizeUnit),containsOrdinal=!isUndefined(normalized.ordinal),containsGregorYear=!isUndefined(normalized.year),containsGregorMD=!isUndefined(normalized.month)||!isUndefined(normalized.day),containsGregor=containsGregorYear||containsGregorMD,definiteWeekDef=normalized.weekYear||normalized.weekNumber,loc=Locale.fromObject(opts);if((containsGregor||containsOrdinal)&&definiteWeekDef){throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");}
if(containsGregorMD&&containsOrdinal){throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");}
const useWeekData=definiteWeekDef||(normalized.weekday&&!containsGregor);let units,defaultValues,objNow=tsToObj(tsNow,offsetProvis);if(useWeekData){units=orderedWeekUnits;defaultValues=defaultWeekUnitValues;objNow=gregorianToWeek(objNow);}else if(containsOrdinal){units=orderedOrdinalUnits;defaultValues=defaultOrdinalUnitValues;objNow=gregorianToOrdinal(objNow);}else{units=orderedUnits;defaultValues=defaultUnitValues;}
let foundFirst=false;for(const u of units){const v=normalized[u];if(!isUndefined(v)){foundFirst=true;}else if(foundFirst){normalized[u]=defaultValues[u];}else{normalized[u]=objNow[u];}}
const higherOrderInvalid=useWeekData?hasInvalidWeekData(normalized):containsOrdinal?hasInvalidOrdinalData(normalized):hasInvalidGregorianData(normalized),invalid=higherOrderInvalid||hasInvalidTimeData(normalized);if(invalid){return DateTime.invalid(invalid);}
const gregorian=useWeekData?weekToGregorian(normalized):containsOrdinal?ordinalToGregorian(normalized):normalized,[tsFinal,offsetFinal]=objToTS(gregorian,offsetProvis,zoneToUse),inst=new DateTime({ts:tsFinal,zone:zoneToUse,o:offsetFinal,loc,});if(normalized.weekday&&containsGregor&&obj.weekday!==inst.weekday){return DateTime.invalid("mismatched weekday",`you can't specify both a weekday of ${normalized.weekday} and a date of ${inst.toISO()}`);}
return inst;}
static fromISO(text,opts={}){const[vals,parsedZone]=parseISODate(text);return parseDataToDateTime(vals,parsedZone,opts,"ISO 8601",text);}
static fromRFC2822(text,opts={}){const[vals,parsedZone]=parseRFC2822Date(text);return parseDataToDateTime(vals,parsedZone,opts,"RFC 2822",text);}
static fromHTTP(text,opts={}){const[vals,parsedZone]=parseHTTPDate(text);return parseDataToDateTime(vals,parsedZone,opts,"HTTP",opts);}
static fromFormat(text,fmt,opts={}){if(isUndefined(text)||isUndefined(fmt)){throw new InvalidArgumentError("fromFormat requires an input string and a format");}
const{locale=null,numberingSystem=null}=opts,localeToUse=Locale.fromOpts({locale,numberingSystem,defaultToEN:true,}),[vals,parsedZone,specificOffset,invalid]=parseFromTokens(localeToUse,text,fmt);if(invalid){return DateTime.invalid(invalid);}else{return parseDataToDateTime(vals,parsedZone,opts,`format ${fmt}`,text,specificOffset);}}
static fromString(text,fmt,opts={}){return DateTime.fromFormat(text,fmt,opts);}
static fromSQL(text,opts={}){const[vals,parsedZone]=parseSQL(text);return parseDataToDateTime(vals,parsedZone,opts,"SQL",text);}
static invalid(reason,explanation=null){if(!reason){throw new InvalidArgumentError("need to specify a reason the DateTime is invalid");}
const invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidDateTimeError(invalid);}else{return new DateTime({invalid});}}
static isDateTime(o){return(o&&o.isLuxonDateTime)||false;}
static parseFormatForOpts(formatOpts,localeOpts={}){const tokenList=formatOptsToTokens(formatOpts,Locale.fromObject(localeOpts));return!tokenList?null:tokenList.map((t)=>(t?t.val:null)).join("");}
static expandFormat(fmt,localeOpts={}){const expanded=expandMacroTokens(Formatter.parseFormat(fmt),Locale.fromObject(localeOpts));return expanded.map((t)=>t.val).join("");}
get(unit){return this[unit];}
get isValid(){return this.invalid===null;}
get invalidReason(){return this.invalid?this.invalid.reason:null;}
get invalidExplanation(){return this.invalid?this.invalid.explanation:null;}
get locale(){return this.isValid?this.loc.locale:null;}
get numberingSystem(){return this.isValid?this.loc.numberingSystem:null;}
get outputCalendar(){return this.isValid?this.loc.outputCalendar:null;}
get zone(){return this._zone;}
get zoneName(){return this.isValid?this.zone.name:null;}
get year(){return this.isValid?this.c.year:NaN;}
get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN;}
get month(){return this.isValid?this.c.month:NaN;}
get day(){return this.isValid?this.c.day:NaN;}
get hour(){return this.isValid?this.c.hour:NaN;}
get minute(){return this.isValid?this.c.minute:NaN;}
get second(){return this.isValid?this.c.second:NaN;}
get millisecond(){return this.isValid?this.c.millisecond:NaN;}
get weekYear(){return this.isValid?possiblyCachedWeekData(this).weekYear:NaN;}
get weekNumber(){return this.isValid?possiblyCachedWeekData(this).weekNumber:NaN;}
get weekday(){return this.isValid?possiblyCachedWeekData(this).weekday:NaN;}
get ordinal(){return this.isValid?gregorianToOrdinal(this.c).ordinal:NaN;}
get monthShort(){return this.isValid?Info.months("short",{locObj:this.loc})[this.month-1]:null;}
get monthLong(){return this.isValid?Info.months("long",{locObj:this.loc})[this.month-1]:null;}
get weekdayShort(){return this.isValid?Info.weekdays("short",{locObj:this.loc})[this.weekday-1]:null;}
get weekdayLong(){return this.isValid?Info.weekdays("long",{locObj:this.loc})[this.weekday-1]:null;}
get offset(){return this.isValid?+this.o:NaN;}
get offsetNameShort(){if(this.isValid){return this.zone.offsetName(this.ts,{format:"short",locale:this.locale,});}else{return null;}}
get offsetNameLong(){if(this.isValid){return this.zone.offsetName(this.ts,{format:"long",locale:this.locale,});}else{return null;}}
get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null;}
get isInDST(){if(this.isOffsetFixed){return false;}else{return(this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset);}}
getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed){return[this];}
const dayMs=86400000;const minuteMs=60000;const localTS=objToLocalTS(this.c);const oEarlier=this.zone.offset(localTS-dayMs);const oLater=this.zone.offset(localTS+dayMs);const o1=this.zone.offset(localTS-oEarlier*minuteMs);const o2=this.zone.offset(localTS-oLater*minuteMs);if(o1===o2){return[this];}
const ts1=localTS-o1*minuteMs;const ts2=localTS-o2*minuteMs;const c1=tsToObj(ts1,o1);const c2=tsToObj(ts2,o2);if(c1.hour===c2.hour&&c1.minute===c2.minute&&c1.second===c2.second&&c1.millisecond===c2.millisecond){return[clone(this,{ts:ts1}),clone(this,{ts:ts2})];}
return[this];}
get isInLeapYear(){return isLeapYear(this.year);}
get daysInMonth(){return daysInMonth(this.year,this.month);}
get daysInYear(){return this.isValid?daysInYear(this.year):NaN;}
get weeksInWeekYear(){return this.isValid?weeksInWeekYear(this.weekYear):NaN;}
resolvedLocaleOptions(opts={}){const{locale,numberingSystem,calendar}=Formatter.create(this.loc.clone(opts),opts).resolvedOptions(this);return{locale,numberingSystem,outputCalendar:calendar};}
toUTC(offset=0,opts={}){return this.setZone(FixedOffsetZone.instance(offset),opts);}
toLocal(){return this.setZone(Settings.defaultZone);}
setZone(zone,{keepLocalTime=false,keepCalendarTime=false}={}){zone=normalizeZone(zone,Settings.defaultZone);if(zone.equals(this.zone)){return this;}else if(!zone.isValid){return DateTime.invalid(unsupportedZone(zone));}else{let newTS=this.ts;if(keepLocalTime||keepCalendarTime){const offsetGuess=zone.offset(this.ts);const asObj=this.toObject();[newTS]=objToTS(asObj,offsetGuess,zone);}
return clone(this,{ts:newTS,zone});}}
reconfigure({locale,numberingSystem,outputCalendar}={}){const loc=this.loc.clone({locale,numberingSystem,outputCalendar});return clone(this,{loc});}
setLocale(locale){return this.reconfigure({locale});}
set(values){if(!this.isValid)return this;const normalized=normalizeObject(values,normalizeUnit),settingWeekStuff=!isUndefined(normalized.weekYear)||!isUndefined(normalized.weekNumber)||!isUndefined(normalized.weekday),containsOrdinal=!isUndefined(normalized.ordinal),containsGregorYear=!isUndefined(normalized.year),containsGregorMD=!isUndefined(normalized.month)||!isUndefined(normalized.day),containsGregor=containsGregorYear||containsGregorMD,definiteWeekDef=normalized.weekYear||normalized.weekNumber;if((containsGregor||containsOrdinal)&&definiteWeekDef){throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");}
if(containsGregorMD&&containsOrdinal){throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");}
let mixed;if(settingWeekStuff){mixed=weekToGregorian({...gregorianToWeek(this.c),...normalized});}else if(!isUndefined(normalized.ordinal)){mixed=ordinalToGregorian({...gregorianToOrdinal(this.c),...normalized});}else{mixed={...this.toObject(),...normalized};if(isUndefined(normalized.day)){mixed.day=Math.min(daysInMonth(mixed.year,mixed.month),mixed.day);}}
const[ts,o]=objToTS(mixed,this.o,this.zone);return clone(this,{ts,o});}
plus(duration){if(!this.isValid)return this;const dur=Duration.fromDurationLike(duration);return clone(this,adjustTime(this,dur));}
minus(duration){if(!this.isValid)return this;const dur=Duration.fromDurationLike(duration).negate();return clone(this,adjustTime(this,dur));}
startOf(unit){if(!this.isValid)return this;const o={},normalizedUnit=Duration.normalizeUnit(unit);switch(normalizedUnit){case"years":o.month=1;case"quarters":case"months":o.day=1;case"weeks":case"days":o.hour=0;case"hours":o.minute=0;case"minutes":o.second=0;case"seconds":o.millisecond=0;break;}
if(normalizedUnit==="weeks"){o.weekday=1;}
if(normalizedUnit==="quarters"){const q=Math.ceil(this.month/3);o.month=(q-1)*3+1;}
return this.set(o);}
endOf(unit){return this.isValid?this.plus({[unit]:1}).startOf(unit).minus(1):this;}
toFormat(fmt,opts={}){return this.isValid?Formatter.create(this.loc.redefaultToEN(opts)).formatDateTimeFromString(this,fmt):INVALID;}
toLocaleString(formatOpts=DATE_SHORT,opts={}){return this.isValid?Formatter.create(this.loc.clone(opts),formatOpts).formatDateTime(this):INVALID;}
toLocaleParts(opts={}){return this.isValid?Formatter.create(this.loc.clone(opts),opts).formatDateTimeParts(this):[];}
toISO({format="extended",suppressSeconds=false,suppressMilliseconds=false,includeOffset=true,extendedZone=false,}={}){if(!this.isValid){return null;}
const ext=format==="extended";let c=toISODate(this,ext);c+="T";c+=toISOTime(this,ext,suppressSeconds,suppressMilliseconds,includeOffset,extendedZone);return c;}
toISODate({format="extended"}={}){if(!this.isValid){return null;}
return toISODate(this,format==="extended");}
toISOWeekDate(){return toTechFormat(this,"kkkk-'W'WW-c");}
toISOTime({suppressMilliseconds=false,suppressSeconds=false,includeOffset=true,includePrefix=false,extendedZone=false,format="extended",}={}){if(!this.isValid){return null;}
let c=includePrefix?"T":"";return(c+
toISOTime(this,format==="extended",suppressSeconds,suppressMilliseconds,includeOffset,extendedZone));}
toRFC2822(){return toTechFormat(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",false);}
toHTTP(){return toTechFormat(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'");}
toSQLDate(){if(!this.isValid){return null;}
return toISODate(this,true);}
toSQLTime({includeOffset=true,includeZone=false,includeOffsetSpace=true}={}){let fmt="HH:mm:ss.SSS";if(includeZone||includeOffset){if(includeOffsetSpace){fmt+=" ";}
if(includeZone){fmt+="z";}else if(includeOffset){fmt+="ZZ";}}
return toTechFormat(this,fmt,true);}
toSQL(opts={}){if(!this.isValid){return null;}
return`${this.toSQLDate()} ${this.toSQLTime(opts)}`;}
toString(){return this.isValid?this.toISO():INVALID;}
valueOf(){return this.toMillis();}
toMillis(){return this.isValid?this.ts:NaN;}
toSeconds(){return this.isValid?this.ts/1000:NaN;}
toUnixInteger(){return this.isValid?Math.floor(this.ts/1000):NaN;}
toJSON(){return this.toISO();}
toBSON(){return this.toJSDate();}
toObject(opts={}){if(!this.isValid)return{};const base={...this.c};if(opts.includeConfig){base.outputCalendar=this.outputCalendar;base.numberingSystem=this.loc.numberingSystem;base.locale=this.loc.locale;}
return base;}
toJSDate(){return new Date(this.isValid?this.ts:NaN);}
diff(otherDateTime,unit="milliseconds",opts={}){if(!this.isValid||!otherDateTime.isValid){return Duration.invalid("created by diffing an invalid DateTime");}
const durOpts={locale:this.locale,numberingSystem:this.numberingSystem,...opts};const units=maybeArray(unit).map(Duration.normalizeUnit),otherIsLater=otherDateTime.valueOf()>this.valueOf(),earlier=otherIsLater?this:otherDateTime,later=otherIsLater?otherDateTime:this,diffed=diff(earlier,later,units,durOpts);return otherIsLater?diffed.negate():diffed;}
diffNow(unit="milliseconds",opts={}){return this.diff(DateTime.now(),unit,opts);}
until(otherDateTime){return this.isValid?Interval.fromDateTimes(this,otherDateTime):this;}
hasSame(otherDateTime,unit){if(!this.isValid)return false;const inputMs=otherDateTime.valueOf();const adjustedToZone=this.setZone(otherDateTime.zone,{keepLocalTime:true});return adjustedToZone.startOf(unit)<=inputMs&&inputMs<=adjustedToZone.endOf(unit);}
equals(other){return(this.isValid&&other.isValid&&this.valueOf()===other.valueOf()&&this.zone.equals(other.zone)&&this.loc.equals(other.loc));}
toRelative(options={}){if(!this.isValid)return null;const base=options.base||DateTime.fromObject({},{zone:this.zone}),padding=options.padding?(this<base?-options.padding:options.padding):0;let units=["years","months","days","hours","minutes","seconds"];let unit=options.unit;if(Array.isArray(options.unit)){units=options.unit;unit=undefined;}
return diffRelative(base,this.plus(padding),{...options,numeric:"always",units,unit,});}
toRelativeCalendar(options={}){if(!this.isValid)return null;return diffRelative(options.base||DateTime.fromObject({},{zone:this.zone}),this,{...options,numeric:"auto",units:["years","months","days"],calendary:true,});}
static min(...dateTimes){if(!dateTimes.every(DateTime.isDateTime)){throw new InvalidArgumentError("min requires all arguments be DateTimes");}
return bestBy(dateTimes,(i)=>i.valueOf(),Math.min);}
static max(...dateTimes){if(!dateTimes.every(DateTime.isDateTime)){throw new InvalidArgumentError("max requires all arguments be DateTimes");}
return bestBy(dateTimes,(i)=>i.valueOf(),Math.max);}
static fromFormatExplain(text,fmt,options={}){const{locale=null,numberingSystem=null}=options,localeToUse=Locale.fromOpts({locale,numberingSystem,defaultToEN:true,});return explainFromTokens(localeToUse,text,fmt);}
static fromStringExplain(text,fmt,options={}){return DateTime.fromFormatExplain(text,fmt,options);}
static get DATE_SHORT(){return DATE_SHORT;}
static get DATE_MED(){return DATE_MED;}
static get DATE_MED_WITH_WEEKDAY(){return DATE_MED_WITH_WEEKDAY;}
static get DATE_FULL(){return DATE_FULL;}
static get DATE_HUGE(){return DATE_HUGE;}
static get TIME_SIMPLE(){return TIME_SIMPLE;}
static get TIME_WITH_SECONDS(){return TIME_WITH_SECONDS;}
static get TIME_WITH_SHORT_OFFSET(){return TIME_WITH_SHORT_OFFSET;}
static get TIME_WITH_LONG_OFFSET(){return TIME_WITH_LONG_OFFSET;}
static get TIME_24_SIMPLE(){return TIME_24_SIMPLE;}
static get TIME_24_WITH_SECONDS(){return TIME_24_WITH_SECONDS;}
static get TIME_24_WITH_SHORT_OFFSET(){return TIME_24_WITH_SHORT_OFFSET;}
static get TIME_24_WITH_LONG_OFFSET(){return TIME_24_WITH_LONG_OFFSET;}
static get DATETIME_SHORT(){return DATETIME_SHORT;}
static get DATETIME_SHORT_WITH_SECONDS(){return DATETIME_SHORT_WITH_SECONDS;}
static get DATETIME_MED(){return DATETIME_MED;}
static get DATETIME_MED_WITH_SECONDS(){return DATETIME_MED_WITH_SECONDS;}
static get DATETIME_MED_WITH_WEEKDAY(){return DATETIME_MED_WITH_WEEKDAY;}
static get DATETIME_FULL(){return DATETIME_FULL;}
static get DATETIME_FULL_WITH_SECONDS(){return DATETIME_FULL_WITH_SECONDS;}
static get DATETIME_HUGE(){return DATETIME_HUGE;}
static get DATETIME_HUGE_WITH_SECONDS(){return DATETIME_HUGE_WITH_SECONDS;}}
function friendlyDateTime(dateTimeish){if(DateTime.isDateTime(dateTimeish)){return dateTimeish;}else if(dateTimeish&&dateTimeish.valueOf&&isNumber(dateTimeish.valueOf())){return DateTime.fromJSDate(dateTimeish);}else if(dateTimeish&&typeof dateTimeish==="object"){return DateTime.fromObject(dateTimeish);}else{throw new InvalidArgumentError(`Unknown datetime argument: ${dateTimeish}, of type ${typeof dateTimeish}`);}}
const VERSION="3.4.2";exports.DateTime=DateTime;exports.Duration=Duration;exports.FixedOffsetZone=FixedOffsetZone;exports.IANAZone=IANAZone;exports.Info=Info;exports.Interval=Interval;exports.InvalidZone=InvalidZone;exports.Settings=Settings;exports.SystemZone=SystemZone;exports.VERSION=VERSION;exports.Zone=Zone;Object.defineProperty(exports,'__esModule',{value:true});return exports;})({});luxon.DateTime.prototype[Symbol.toStringTag]="LuxonDateTime";luxon.Duration.prototype[Symbol.toStringTag]="LuxonDuration";luxon.Interval.prototype[Symbol.toStringTag]="LuxonInterval";luxon.Settings.prototype[Symbol.toStringTag]="LuxonSettings";luxon.Info.prototype[Symbol.toStringTag]="LuxonInfo";luxon.Zone.prototype[Symbol.toStringTag]="LuxonZone";;

/* /web/static/lib/owl/odoo_module.js */
odoo.define("@odoo/owl",[],function(){"use strict";return owl;});;

/* /web/static/src/core/utils/arrays.js */
odoo.define('@web/core/utils/arrays',['@web/core/utils/objects'],function(require){'use strict';let __exports={};const{shallowEqual:_shallowEqual}=require("@web/core/utils/objects");function _cartesian(){const args=Array.prototype.slice.call(arguments);if(args.length===0){return[undefined];}
const firstArray=args[0].map(function(elem){return[elem];});if(args.length===1){return firstArray;}
const productOfOtherArrays=_cartesian.apply(null,args.slice(1));return firstArray.reduce(function(acc,elem){return acc.concat(productOfOtherArrays.map(function(tuple){return elem.concat(tuple);}));},[]);}
function _getExtractorFrom(criterion){if(criterion){switch(typeof criterion){case"string":return(element)=>element[criterion];case"function":return criterion;default:throw new Error(`Expected criterion of type 'string' or 'function' and got '${typeof criterion}'`);}}else{return(element)=>element;}}
__exports.ensureArray=ensureArray;function ensureArray(value){return value&&typeof value==="object"&&value[Symbol.iterator]?[...value]:[value];}
__exports.intersection=intersection;function intersection(array1,array2){return array1.filter((v)=>array2.includes(v));}
__exports.groupBy=groupBy;function groupBy(array,criterion){const extract=_getExtractorFrom(criterion);const groups={};for(const element of array){const group=String(extract(element));if(!(group in groups)){groups[group]=[];}
groups[group].push(element);}
return groups;}
__exports.sortBy=sortBy;function sortBy(array,criterion,order="asc"){const extract=_getExtractorFrom(criterion);return array.slice().sort((elA,elB)=>{const a=extract(elA);const b=extract(elB);let result;if(isNaN(a)&&isNaN(b)){result=a>b?1:a<b?-1:0;}else{result=a-b;}
return order==="asc"?result:-result;});}
__exports.symmetricalDifference=symmetricalDifference;function symmetricalDifference(arrayA,arrayB){return arrayA.filter((id)=>!arrayB.includes(id)).concat(arrayB.filter((id)=>!arrayA.includes(id)));}
__exports.cartesian=cartesian;function cartesian(){const args=Array.prototype.slice.call(arguments);if(args.length===0){return[undefined];}else if(args.length===1){return args[0];}else{return _cartesian.apply(null,args);}}
const shallowEqual=__exports.shallowEqual=_shallowEqual;__exports.sections=sections;function sections(array){const sections=[];for(let i=0;i<array.length+1;i++){sections.push(array.slice(0,i));}
return sections;}
__exports.unique=unique;function unique(array){return Array.from(new Set(array));}
__exports.zip=zip;function zip(array1,array2,fill=false){const result=[];const getLength=fill?Math.max:Math.min;for(let i=0;i<getLength(array1.length,array2.length);i++){result.push([array1[i],array2[i]]);}
return result;}
__exports.zipWith=zipWith;function zipWith(array1,array2,func){return zip(array1,array2).map(([e1,e2])=>func(e1,e2));}
return __exports;});;

/* /web/static/src/core/utils/autoresize.js */
odoo.define('@web/core/utils/autoresize',['@odoo/owl','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{useEffect}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");__exports.useAutoresize=useAutoresize;function useAutoresize(ref,options={}){let resize=null;useEffect((el)=>{if(el){resize=(el instanceof HTMLInputElement?resizeInput:resizeTextArea).bind(null,el,options);el.addEventListener("input",resize);return()=>{el.removeEventListener("input",resize);resize=null;};}},()=>[ref.el]);useEffect(()=>{if(resize){resize(ref.el,options);}});}
function resizeInput(input){input.style.width="100%";const maxWidth=input.clientWidth;const isSafari16=/Version\/16.+Safari/i.test(browser.navigator.userAgent);input.style.width="10px";if(input.value===""&&input.placeholder!==""){input.style.width="auto";return;}
if(input.scrollWidth+5+(isSafari16?8:0)>maxWidth){input.style.width="100%";return;}
input.style.width=input.scrollWidth+5+(isSafari16?8:0)+"px";}
__exports.resizeTextArea=resizeTextArea;function resizeTextArea(textarea,options={}){const minimumHeight=options.minimumHeight||0;let heightOffset=0;const style=window.getComputedStyle(textarea);if(style.boxSizing==="border-box"){const paddingHeight=parseFloat(style.paddingTop)+parseFloat(style.paddingBottom);const borderHeight=parseFloat(style.borderTopWidth)+parseFloat(style.borderBottomWidth);heightOffset=borderHeight+paddingHeight;}
const previousStyle={borderTopWidth:style.borderTopWidth,borderBottomWidth:style.borderBottomWidth,padding:style.padding,};Object.assign(textarea.style,{height:"auto",borderTopWidth:0,borderBottomWidth:0,paddingTop:0,paddingRight:style.paddingRight,paddingBottom:0,paddingLeft:style.paddingLeft,});textarea.style.height="auto";const height=Math.max(minimumHeight,textarea.scrollHeight+heightOffset);Object.assign(textarea.style,previousStyle,{height:`${height}px`});textarea.parentElement.style.height=`${height}px`;}
return __exports;});;

/* /web/static/src/core/utils/binary.js */
odoo.define('@web/core/utils/binary',['@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");__exports.isBinarySize=isBinarySize;function isBinarySize(value){return/^\d+(\.\d*)? [^0-9]+$/.test(value);}
__exports.toBase64Length=toBase64Length;function toBase64Length(maxBytes){return Math.ceil(maxBytes*4/3);}
__exports.humanSize=humanSize;function humanSize(size){const units=_t("Bytes|Kb|Mb|Gb|Tb|Pb|Eb|Zb|Yb").split("|");let i=0;while(size>=1024){size/=1024;++i;}
return`${size.toFixed(2)} ${units[i].trim()}`;}
return __exports;});;

/* /web/static/src/core/utils/cache.js */
odoo.define('@web/core/utils/cache',[],function(require){'use strict';let __exports={};const Cache=__exports.Cache=class Cache{constructor(getValue,getKey){this.cache={};this.getKey=getKey;this.getValue=getValue;}
_getCacheAndKey(...path){let cache=this.cache;let key;if(this.getKey){key=this.getKey(...path);}else{for(let i=0;i<path.length-1;i++){cache=cache[path[i]]=cache[path[i]]||{};}
key=path[path.length-1];}
return{cache,key};}
clear(...path){const{cache,key}=this._getCacheAndKey(...path);delete cache[key];}
invalidate(){this.cache={};}
read(...path){const{cache,key}=this._getCacheAndKey(...path);if(!(key in cache)){cache[key]=this.getValue(...path);}
return cache[key];}}
return __exports;});;

/* /web/static/src/core/utils/colors.js */
odoo.define('@web/core/utils/colors',[],function(require){'use strict';let __exports={};__exports.convertRgbToHsl=convertRgbToHsl;function convertRgbToHsl(r,g,b){if(typeof(r)!=='number'||isNaN(r)||r<0||r>255||typeof(g)!=='number'||isNaN(g)||g<0||g>255||typeof(b)!=='number'||isNaN(b)||b<0||b>255){return false;}
var red=r/255;var green=g/255;var blue=b/255;var maxColor=Math.max(red,green,blue);var minColor=Math.min(red,green,blue);var delta=maxColor-minColor;var hue=0;var saturation=0;var lightness=(maxColor+minColor)/2;if(delta){if(maxColor===red){hue=(green-blue)/delta;}
if(maxColor===green){hue=2+(blue-red)/delta;}
if(maxColor===blue){hue=4+(red-green)/delta;}
if(maxColor){saturation=delta/(1-Math.abs(2*lightness-1));}}
hue=60*hue;return{hue:hue<0?hue+360:hue,saturation:saturation*100,lightness:lightness*100,};};__exports.convertHslToRgb=convertHslToRgb;function convertHslToRgb(h,s,l){if(typeof(h)!=='number'||isNaN(h)||h<0||h>360||typeof(s)!=='number'||isNaN(s)||s<0||s>100||typeof(l)!=='number'||isNaN(l)||l<0||l>100){return false;}
var huePrime=h/60;var saturation=s/100;var lightness=l/100;var chroma=saturation*(1-Math.abs(2*lightness-1));var secondComponent=chroma*(1-Math.abs(huePrime%2-1));var lightnessAdjustment=lightness-chroma/2;var precision=255;chroma=Math.round((chroma+lightnessAdjustment)*precision);secondComponent=Math.round((secondComponent+lightnessAdjustment)*precision);lightnessAdjustment=Math.round((lightnessAdjustment)*precision);if(huePrime>=0&&huePrime<1){return{red:chroma,green:secondComponent,blue:lightnessAdjustment,};}
if(huePrime>=1&&huePrime<2){return{red:secondComponent,green:chroma,blue:lightnessAdjustment,};}
if(huePrime>=2&&huePrime<3){return{red:lightnessAdjustment,green:chroma,blue:secondComponent,};}
if(huePrime>=3&&huePrime<4){return{red:lightnessAdjustment,green:secondComponent,blue:chroma,};}
if(huePrime>=4&&huePrime<5){return{red:secondComponent,green:lightnessAdjustment,blue:chroma,};}
if(huePrime>=5&&huePrime<=6){return{red:chroma,green:lightnessAdjustment,blue:secondComponent,};}
return false;};__exports.convertRgbaToCSSColor=convertRgbaToCSSColor;function convertRgbaToCSSColor(r,g,b,a){if(typeof(r)!=='number'||isNaN(r)||r<0||r>255||typeof(g)!=='number'||isNaN(g)||g<0||g>255||typeof(b)!=='number'||isNaN(b)||b<0||b>255){return false;}
if(typeof(a)!=='number'||isNaN(a)||a<0||Math.abs(a-100)<Number.EPSILON){const rr=r<16?'0'+r.toString(16):r.toString(16);const gg=g<16?'0'+g.toString(16):g.toString(16);const bb=b<16?'0'+b.toString(16):b.toString(16);return(`#${rr}${gg}${bb}`).toUpperCase();}
return`rgba(${r}, ${g}, ${b}, ${parseFloat((a / 100.0).toFixed(3))})`;};__exports.convertCSSColorToRgba=convertCSSColorToRgba;function convertCSSColorToRgba(cssColor){const rgba=cssColor.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/);if(rgba){if(rgba[4]===undefined){rgba[4]=1;}
return{red:parseInt(rgba[1]),green:parseInt(rgba[2]),blue:parseInt(rgba[3]),opacity:Math.round(parseFloat(rgba[4])*100),};}
if(/^#([0-9A-F]{6}|[0-9A-F]{8})$/i.test(cssColor)){return{red:parseInt(cssColor.substr(1,2),16),green:parseInt(cssColor.substr(3,2),16),blue:parseInt(cssColor.substr(5,2),16),opacity:(cssColor.length===9?(parseInt(cssColor.substr(7,2),16)/255):1)*100,};}
if(/color\(.+\)/.test(cssColor)){const canvasEl=document.createElement("canvas");canvasEl.height=1;canvasEl.width=1;const ctx=canvasEl.getContext("2d");ctx.fillStyle=cssColor;ctx.fillRect(0,0,1,1);const data=ctx.getImageData(0,0,1,1).data;return{red:data[0],green:data[1],blue:data[2],opacity:data[3]/2.55,};}
return false;};__exports.normalizeCSSColor=normalizeCSSColor;function normalizeCSSColor(cssColor){const rgba=convertCSSColorToRgba(cssColor);if(!rgba){return cssColor;}
return convertRgbaToCSSColor(rgba.red,rgba.green,rgba.blue,rgba.opacity);};__exports.isCSSColor=isCSSColor;function isCSSColor(cssColor){return convertCSSColorToRgba(cssColor)!==false;};__exports.mixCssColors=mixCssColors;function mixCssColors(cssColor1,cssColor2,weight){const rgba1=convertCSSColorToRgba(cssColor1);const rgba2=convertCSSColorToRgba(cssColor2);const rgb1=[rgba1.red,rgba1.green,rgba1.blue];const rgb2=[rgba2.red,rgba2.green,rgba2.blue];const[r,g,b]=rgb1.map((_,idx)=>Math.round(rgb2[idx]+(rgb1[idx]-rgb2[idx])*weight));return convertRgbaToCSSColor(r,g,b);};return __exports;});;

/* /web/static/src/core/utils/components.js */
odoo.define('@web/core/utils/components',['@odoo/owl'],function(require){'use strict';let __exports={};const{Component,onError,xml,useSubEnv}=require("@odoo/owl");const ErrorHandler=__exports.ErrorHandler=class ErrorHandler extends Component{setup(){onError((error)=>{this.props.onError(error);});}}
ErrorHandler.template=xml`<t t-slot="default" />`;ErrorHandler.props=["onError","slots"];const WithEnv=__exports.WithEnv=class WithEnv extends Component{setup(){useSubEnv(this.props.env);}}
WithEnv.template=xml`<t t-slot="default"/>`;WithEnv.props=["env","slots"];return __exports;});;

/* /web/static/src/core/utils/concurrency.js */
odoo.define('@web/core/utils/concurrency',[],function(require){'use strict';let __exports={};__exports.delay=delay;function delay(wait){return new Promise(function(resolve){setTimeout(resolve,wait);});}
const KeepLast=__exports.KeepLast=class KeepLast{constructor(){this._id=0;}
add(promise){this._id++;const currentId=this._id;return new Promise((resolve,reject)=>{promise.then((value)=>{if(this._id===currentId){resolve(value);}}).catch((reason)=>{if(this._id===currentId){reject(reason);}});});}}
const Mutex=__exports.Mutex=class Mutex{constructor(){this._lock=Promise.resolve();this._queueSize=0;this._unlockedProm=undefined;this._unlock=undefined;}
async exec(action){this._queueSize++;if(!this._unlockedProm){this._unlockedProm=new Promise((resolve)=>{this._unlock=()=>{resolve();this._unlockedProm=undefined;};});}
const always=()=>{return Promise.resolve(action()).finally(()=>{if(--this._queueSize===0){this._unlock();}});};this._lock=this._lock.then(always,always);return this._lock;}
getUnlockedDef(){return this._unlockedProm||Promise.resolve();}}
const Race=__exports.Race=class Race{constructor(){this.currentProm=null;this.currentPromResolver=null;this.currentPromRejecter=null;}
add(promise){if(!this.currentProm){this.currentProm=new Promise((resolve,reject)=>{this.currentPromResolver=(value)=>{this.currentProm=null;this.currentPromResolver=null;this.currentPromRejecter=null;resolve(value);};this.currentPromRejecter=(error)=>{this.currentProm=null;this.currentPromResolver=null;this.currentPromRejecter=null;reject(error);};});}
promise.then(this.currentPromResolver).catch(this.currentPromRejecter);return this.currentProm;}
getCurrentProm(){return this.currentProm;}}
const Deferred=__exports.Deferred=class Deferred extends Promise{constructor(){let resolve;let reject;const prom=new Promise((res,rej)=>{resolve=res;reject=rej;});return Object.assign(prom,{resolve,reject});}}
return __exports;});;

/* /web/static/src/core/utils/draggable.js */
odoo.define('@web/core/utils/draggable',['@web/core/utils/draggable_hook_builder_owl','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{makeDraggableHook}=require("@web/core/utils/draggable_hook_builder_owl");const{pick}=require("@web/core/utils/objects");const useDraggable=__exports.useDraggable=makeDraggableHook({name:"useDraggable",onWillStartDrag:({ctx})=>pick(ctx.current,"element"),onDragStart:({ctx})=>pick(ctx.current,"element"),onDrag:({ctx})=>pick(ctx.current,"element"),onDragEnd:({ctx})=>pick(ctx.current,"element"),onDrop:({ctx})=>pick(ctx.current,"element"),});return __exports;});;

/* /web/static/src/core/utils/draggable_hook_builder.js */
odoo.define('@web/core/utils/draggable_hook_builder',['@web/core/utils/numbers','@web/core/utils/scrolling','@web/core/utils/timing','@web/core/browser/browser','@web/core/browser/feature_detection'],function(require){'use strict';let __exports={};const{clamp}=require("@web/core/utils/numbers");const{closestScrollableX,closestScrollableY}=require("@web/core/utils/scrolling");const{setRecurringAnimationFrame}=require("@web/core/utils/timing");const{browser}=require("@web/core/browser/browser");const{hasTouch,isBrowserFirefox,isIOS}=require("@web/core/browser/feature_detection");const DRAGGABLE_CLASS="o_draggable";const DRAGGED_CLASS=__exports.DRAGGED_CLASS="o_dragged";const DEFAULT_ACCEPTED_PARAMS={enable:[Boolean,Function],preventDrag:[Function],ref:[Object],elements:[String],handle:[String,Function],ignore:[String,Function],cursor:[String],edgeScrolling:[Object,Function],delay:[Number],tolerance:[Number],iframeWindow:[Object,Function],};const DEFAULT_DEFAULT_PARAMS={elements:`.${DRAGGABLE_CLASS}`,enable:true,preventDrag:()=>false,edgeScrolling:{speed:10,threshold:30,},delay:0,tolerance:10,touch_delay:300,};const LEFT_CLICK=0;const MANDATORY_PARAMS=["ref"];const WHITE_LISTED_KEYS=["Alt","Control","Meta","Shift"];const elCache={};function camelToKebab(str){return str.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();}
function getReturnValue(valueOrFn){if(typeof valueOrFn==="function"){return valueOrFn();}
return valueOrFn;}
function getScrollParents(el){return[closestScrollableX(el),closestScrollableY(el)];}
function makeCleanupManager(defaultCleanupFn){const add=(cleanupFn)=>typeof cleanupFn==="function"&&cleanups.push(cleanupFn);const cleanup=()=>{while(cleanups.length){cleanups.pop()();}
add(defaultCleanupFn);};const cleanups=[];add(defaultCleanupFn);return{add,cleanup};}
function makeDOMHelpers(cleanup){const addClass=(el,...classNames)=>{if(!el||!classNames.length){return;}
cleanup.add(()=>el.classList.remove(...classNames));el.classList.add(...classNames);};const addListener=(el,event,callback,options={})=>{if(!el||!event||!callback){return;}
const{noAddedStyle}=options;delete options.noAddedStyle;el.addEventListener(event,callback,options);if(!noAddedStyle&&/mouse|pointer|touch/.test(event)){addStyle(el,{pointerEvents:"auto"});}
cleanup.add(()=>el.removeEventListener(event,callback,options));};const addStyle=(el,style)=>{if(!el||!style||!Object.keys(style).length){return;}
cleanup.add(saveAttribute(el,"style"));for(const key in style){const[value,priority]=String(style[key]).split(/\s*!\s*/);el.style.setProperty(camelToKebab(key),value,priority);}};const getRect=(el,options={})=>{if(!el){return{};}
const rect=el.getBoundingClientRect();if(options.adjust){const style=getComputedStyle(el);const[pl,pr,pt,pb]=["padding-left","padding-right","padding-top","padding-bottom",].map((prop)=>pixelValueToNumber(style.getPropertyValue(prop)));rect.x+=pl;rect.y+=pt;rect.width-=pl+pr;rect.height-=pt+pb;}
return rect;};const removeAttribute=(el,attribute)=>{if(!el||!attribute){return;}
cleanup.add(saveAttribute(el,attribute));el.removeAttribute(attribute);};const removeClass=(el,...classNames)=>{if(!el||!classNames.length){return;}
cleanup.add(saveAttribute(el,"class"));el.classList.remove(...classNames);};const removeStyle=(el,...properties)=>{if(!el||!properties.length){return;}
cleanup.add(saveAttribute(el,"style"));for(const key of properties){el.style.removeProperty(camelToKebab(key));}};const setAttribute=(el,attribute,value)=>{if(!el||!attribute){return;}
cleanup.add(saveAttribute(el,attribute));el.setAttribute(attribute,String(value));};return{addClass,addListener,addStyle,getRect,removeAttribute,removeClass,removeStyle,setAttribute,};}
function pixelValueToNumber(val){return Number(val.endsWith("px")?val.slice(0,-2):val);}
function safePrevent(ev,{stop}={}){if(ev.cancelable){ev.preventDefault();if(stop){ev.stopPropagation();}}}
function saveAttribute(el,attribute){const restoreAttribute=()=>{cache.delete(el);if(hasAttribute){el.setAttribute(attribute,originalValue);}else{el.removeAttribute(attribute);}};if(!(attribute in elCache)){elCache[attribute]=new Set();}
const cache=elCache[attribute];if(cache.has(el)){return;}
cache.add(el);const hasAttribute=el.hasAttribute(attribute);const originalValue=el.getAttribute(attribute);return restoreAttribute;}
function toFunction(value){return typeof value==="function"?value:()=>value;}
__exports.makeDraggableHook=makeDraggableHook;function makeDraggableHook(hookParams){hookParams=getReturnValue(hookParams);const hookName=hookParams.name||"useAnonymousDraggable";const{setupHooks}=hookParams;const allAcceptedParams={...DEFAULT_ACCEPTED_PARAMS,...hookParams.acceptedParams};const defaultParams={...DEFAULT_DEFAULT_PARAMS,...hookParams.defaultParams};const computeParams=(params)=>{const computedParams={enable:()=>true};for(const prop in allAcceptedParams){if(prop in params){if(prop==="enable"){computedParams[prop]=toFunction(params[prop]);}else if(allAcceptedParams[prop].length===1&&allAcceptedParams[prop][0]===Function){computedParams[prop]=params[prop];}else{computedParams[prop]=getReturnValue(params[prop]);}}}
return Object.entries(computedParams);};const makeError=(reason)=>new Error(`Error in hook ${hookName}: ${reason}.`);return{[hookName](params){const callBuildHandler=(hookHandlerName,arg)=>{if(typeof hookParams[hookHandlerName]!=="function"){return;}
const returnValue=hookParams[hookHandlerName]({ctx,...helpers,...arg});if(returnValue){callHandler(hookHandlerName,returnValue);}};const callHandler=(handlerName,arg)=>{if(typeof params[handlerName]!=="function"){return;}
try{params[handlerName]({...dom,...ctx.pointer,...arg});}catch(err){dragEnd(null,true);throw err;}};const canStartDrag=()=>{const{pointer,current:{initialPosition},}=ctx;return(!ctx.tolerance||Math.hypot(pointer.x-initialPosition.x,pointer.y-initialPosition.y)>=ctx.tolerance);};const dragStart=()=>{state.dragging=true;state.willDrag=false;[ctx.current.scrollParentX,ctx.current.scrollParentY]=getScrollParents(ctx.current.container);updateRects();const{x,y,width,height}=ctx.current.elementRect;ctx.current.offset={x:ctx.current.initialPosition.x-x,y:ctx.current.initialPosition.y-y,};if(ctx.followCursor){dom.addStyle(ctx.current.element,{width:`${width}px`,height:`${height}px`,position:"fixed !important",});updateElementPosition();}
dom.addClass(document.body,"pe-none","user-select-none");if(params.iframeWindow){dom.addClass(params.iframeWindow.body,"pe-none","user-select-none");}
if(ctx.cursor){dom.addStyle(document.body,{cursor:ctx.cursor});}
if((ctx.current.scrollParentX||ctx.current.scrollParentY)&&ctx.edgeScrolling.enabled){const cleanupFn=setRecurringAnimationFrame(handleEdgeScrolling);cleanup.add(cleanupFn);}
dom.addClass(ctx.current.element,DRAGGED_CLASS);callBuildHandler("onDragStart");};const dragEnd=(target,inErrorState)=>{if(state.dragging){if(!inErrorState){if(target){callBuildHandler("onDrop",{target});}
callBuildHandler("onDragEnd");}}
cleanup.cleanup();};const handleEdgeScrolling=(deltaTime)=>{updateRects();const eRect=ctx.current.elementRect;const xRect=ctx.current.scrollParentXRect;const yRect=ctx.current.scrollParentYRect;const{speed,threshold}=ctx.edgeScrolling;const correctedSpeed=(speed/16)*deltaTime;const diff={};if(xRect){const maxWidth=xRect.x+xRect.width;if(eRect.x-xRect.x<threshold){diff.x=[eRect.x-xRect.x,-1];}else if(maxWidth-eRect.x-eRect.width<threshold){diff.x=[maxWidth-eRect.x-eRect.width,1];}}
if(yRect){const maxHeight=yRect.y+yRect.height;if(eRect.y-yRect.y<threshold){diff.y=[eRect.y-yRect.y,-1];}else if(maxHeight-eRect.y-eRect.height<threshold){diff.y=[maxHeight-eRect.y-eRect.height,1];}}
const diffToScroll=([delta,sign])=>(1-clamp(delta,0,threshold)/threshold)*correctedSpeed*sign;if(diff.y){ctx.current.scrollParentY.scrollBy({top:diffToScroll(diff.y)});}
if(diff.x){ctx.current.scrollParentX.scrollBy({left:diffToScroll(diff.x)});}};const onKeyDown=(ev)=>{if(!state.dragging||!ctx.enable()){return;}
if(!WHITE_LISTED_KEYS.includes(ev.key)){safePrevent(ev,{stop:true});dragEnd(null);}};const onPointerCancel=()=>{dragEnd(null);};const onPointerDown=(ev)=>{updatePointerPosition(ev);const initiationDelay=ev.pointerType==="touch"?ctx.touch_delay:ctx.delay;dragEnd(null);const fullSelectorEl=ev.target.closest(ctx.fullSelector);if(ev.button!==LEFT_CLICK||!ctx.enable()||!fullSelectorEl||(ctx.ignoreSelector&&ev.target.closest(ctx.ignoreSelector))||ctx.preventDrag(fullSelectorEl)){return;}
safePrevent(ev);if(document.activeElement&&!document.activeElement.contains(ev.target)){document.activeElement.blur();}
const{currentTarget,pointerId,target}=ev;ctx.current.initialPosition={...ctx.pointer};if(target.hasPointerCapture(pointerId)){target.releasePointerCapture(pointerId);}
if(initiationDelay){if(hasTouch()){if(ev.pointerType==="touch"){dom.addClass(target.closest(ctx.elementSelector),"o_touch_bounce");}
if(isBrowserFirefox()){const links=[...currentTarget.querySelectorAll("[href")];if(currentTarget.hasAttribute("href")){links.unshift(currentTarget);}
for(const link of links){dom.removeAttribute(link,"href");}}
if(isIOS()){for(const image of currentTarget.getElementsByTagName("img")){dom.setAttribute(image,"draggable",false);}}}
ctx.current.timeout=browser.setTimeout(()=>{ctx.current.initialPosition={...ctx.pointer};willStartDrag(target);const{x:px,y:py}=ctx.pointer;const{x,y,width,height}=dom.getRect(ctx.current.element);if(px<x||x+width<px||py<y||y+height<py){dragEnd(null);}},initiationDelay);cleanup.add(()=>browser.clearTimeout(ctx.current.timeout));}else{willStartDrag(target);}};const onPointerMove=(ev)=>{updatePointerPosition(ev);if(!ctx.current.element||!ctx.enable()){return;}
safePrevent(ev);if(!state.dragging){if(!canStartDrag()){return;}
dragStart();}
if(ctx.followCursor){updateElementPosition();}
callBuildHandler("onDrag");};const onPointerUp=(ev)=>{updatePointerPosition(ev);dragEnd(ev.target);};const updateElementPosition=()=>{const{containerRect,element,elementRect,offset}=ctx.current;const{width:ew}=elementRect;const{x:cx,y:cy,width:cw,height:ch}=containerRect;dom.addStyle(element,{left:`${clamp(ctx.pointer.x - offset.x, cx, cx + cw - ew)}px`,top:`${clamp(ctx.pointer.y - offset.y, cy, cy + ch)}px`,});};const updatePointerPosition=(ev)=>{ctx.pointer.x=ev.clientX;ctx.pointer.y=ev.clientY;};const updateRects=()=>{const{current}=ctx;const{container,element,scrollParentX,scrollParentY}=current;current.containerRect=dom.getRect(container,{adjust:true});current.containerRect.width=container.scrollWidth;current.containerRect.height=container.scrollHeight;current.scrollParentXRect=null;current.scrollParentYRect=null;if(ctx.edgeScrolling.enabled){if(scrollParentX){current.scrollParentXRect=dom.getRect(scrollParentX,{adjust:true});const right=Math.min(current.containerRect.left+container.scrollWidth,current.scrollParentXRect.right);current.containerRect.x=Math.max(current.containerRect.x,current.scrollParentXRect.x);current.containerRect.width=right-current.containerRect.x;}
if(scrollParentY){current.scrollParentYRect=dom.getRect(scrollParentY,{adjust:true});const bottom=Math.min(current.containerRect.top+container.scrollHeight,current.scrollParentYRect.bottom);current.containerRect.y=Math.max(current.containerRect.y,current.scrollParentYRect.y);current.containerRect.height=bottom-current.containerRect.y;}}
ctx.current.elementRect=dom.getRect(element);};const willStartDrag=(target)=>{ctx.current.element=target.closest(ctx.elementSelector);ctx.current.container=ctx.ref.el;cleanup.add(()=>(ctx.current={}));state.willDrag=true;callBuildHandler("onWillStartDrag");if(hasTouch()){dom.addListener(window,"touchmove",safePrevent,{passive:false,noAddedStyle:true,});if(params.iframeWindow){dom.addListener(params.iframeWindow,"touchmove",safePrevent,{passive:false,noAddedStyle:true,});}}};const cleanup=makeCleanupManager(()=>(state.dragging=false));const effectCleanup=makeCleanupManager();const dom=makeDOMHelpers(cleanup);const helpers={...dom,addCleanup:cleanup.add,addEffectCleanup:effectCleanup.add,callHandler,};const state=setupHooks.wrapState({dragging:false});for(const prop in allAcceptedParams){const type=typeof params[prop];const acceptedTypes=allAcceptedParams[prop].map((t)=>t.name.toLowerCase());if(params[prop]){if(!acceptedTypes.includes(type)){throw makeError(`invalid type for property "${prop}" in parameters: expected { ${acceptedTypes.join(
                                ", "
                            )} } and got ${type}`);}}else if(MANDATORY_PARAMS.includes(prop)&&!defaultParams[prop]){throw makeError(`missing required property "${prop}" in parameters`);}}
const ctx={enable:()=>false,preventDrag:()=>false,ref:params.ref,ignoreSelector:null,fullSelector:null,followCursor:true,cursor:null,pointer:{x:0,y:0},edgeScrolling:{enabled:true},get dragging(){return state.dragging;},get willDrag(){return state.willDrag;},current:{},};setupHooks.setup((...deps)=>{const actualParams={...defaultParams,...Object.fromEntries(deps)};if(!ctx.ref.el){return;}
ctx.enable=actualParams.enable;if(actualParams.preventDrag){ctx.preventDrag=actualParams.preventDrag;}
ctx.elementSelector=actualParams.elements;if(!ctx.elementSelector){throw makeError(`no value found by "elements" selector: ${ctx.elementSelector}`);}
const allSelectors=[ctx.elementSelector];ctx.cursor=actualParams.cursor||null;if(actualParams.handle){allSelectors.push(actualParams.handle);}
if(actualParams.ignore){ctx.ignoreSelector=actualParams.ignore;}
ctx.fullSelector=allSelectors.join(" ");Object.assign(ctx.edgeScrolling,actualParams.edgeScrolling);ctx.delay=actualParams.delay;ctx.touch_delay=actualParams.delay||actualParams.touch_delay;ctx.tolerance=actualParams.tolerance;callBuildHandler("onComputeParams",{params:actualParams});return effectCleanup.cleanup;},()=>computeParams(params));const useMouseEvents=isBrowserFirefox()&&!hasTouch()&&params.iframeWindow;setupHooks.setup((el)=>{if(el){const{add,cleanup}=makeCleanupManager();const{addListener}=makeDOMHelpers({add});const event=useMouseEvents?"mousedown":"pointerdown";addListener(el,event,onPointerDown,{noAddedStyle:true});if(hasTouch()){addListener(el,"contextmenu",safePrevent);addListener(el,"touchstart",()=>{},{passive:false,noAddedStyle:true,});}
return cleanup;}},()=>[ctx.ref.el]);const addWindowListener=(type,listener,options)=>{if(params.iframeWindow){setupHooks.addListener(params.iframeWindow,type,listener,options);}
setupHooks.addListener(window,type,listener,options);};const throttledOnPointerMove=setupHooks.throttle(onPointerMove);addWindowListener(useMouseEvents?"mousemove":"pointermove",throttledOnPointerMove,{passive:false,});addWindowListener(useMouseEvents?"mouseup":"pointerup",onPointerUp);addWindowListener("pointercancel",onPointerCancel);addWindowListener("keydown",onKeyDown,{capture:true});setupHooks.teardown(()=>dragEnd(null));return state;},}[hookName];}
return __exports;});;

/* /web/static/src/core/utils/draggable_hook_builder_owl.js */
odoo.define('@web/core/utils/draggable_hook_builder_owl',['@odoo/owl','@web/core/utils/timing','@web/core/utils/draggable_hook_builder'],function(require){'use strict';let __exports={};const{onWillUnmount,reactive,useEffect,useExternalListener}=require("@odoo/owl");const{useThrottleForAnimation}=require("@web/core/utils/timing");const{makeDraggableHook:nativeMakeDraggableHook}=require("@web/core/utils/draggable_hook_builder");__exports.makeDraggableHook=makeDraggableHook;function makeDraggableHook(params){return nativeMakeDraggableHook({...params,setupHooks:{addListener:useExternalListener,setup:useEffect,teardown:onWillUnmount,throttle:useThrottleForAnimation,wrapState:reactive,},});}
return __exports;});;

/* /web/static/src/core/utils/files.js */
odoo.define('@web/core/utils/files',['@web/core/utils/numbers','@web/session','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{humanNumber}=require("@web/core/utils/numbers");const{session}=require("@web/session");const{_t}=require("@web/core/l10n/translation");const DEFAULT_MAX_FILE_SIZE=128*1024*1024;__exports.checkFileSize=checkFileSize;function checkFileSize(fileSize,notificationService){const maxUploadSize=session.max_file_upload_size||DEFAULT_MAX_FILE_SIZE;if(fileSize>maxUploadSize){notificationService.add(_t("The selected file (%sB) is over the maximum allowed file size (%sB).",humanNumber(fileSize),humanNumber(maxUploadSize)),{type:"danger",});return false;}
return true;}
return __exports;});;

/* /web/static/src/core/utils/functions.js */
odoo.define('@web/core/utils/functions',[],function(require){'use strict';let __exports={};__exports.memoize=memoize;function memoize(func){const cache=new Map();const funcName=func.name?func.name+" (memoized)":"memoized";return{[funcName](...args){if(!cache.has(args[0])){cache.set(args[0],func(...args));}
return cache.get(...args);},}[funcName];}
__exports.uniqueId=uniqueId;function uniqueId(prefix=""){return`${prefix}${++uniqueId.nextId}`;}
uniqueId.nextId=0;return __exports;});;

/* /web/static/src/core/utils/hooks.js */
odoo.define('@web/core/utils/hooks',['@web/env','@web/core/browser/feature_detection','@odoo/owl'],function(require){'use strict';let __exports={};const{SERVICES_METADATA}=require("@web/env");const{hasTouch,isMobileOS}=require("@web/core/browser/feature_detection");const{status,useComponent,useEffect,useRef,onWillUnmount}=require("@odoo/owl");__exports.useAutofocus=useAutofocus;function useAutofocus({refName,selectAll,mobile}={}){const ref=useRef(refName||"autofocus");const uiService=useService("ui");if(!mobile&&hasTouch()){return ref;}
if(!mobile&&isMobileOS()){return ref;}
useEffect((el)=>{if(el&&(!uiService.activeElement||uiService.activeElement.contains(el))){el.focus();if(["INPUT","TEXTAREA"].includes(el.tagName)&&el.type!=="number"){el.selectionEnd=el.value.length;el.selectionStart=selectAll?0:el.value.length;}}},()=>[ref.el]);return ref;}
__exports.useBus=useBus;function useBus(bus,eventName,callback){const component=useComponent();useEffect(()=>{const listener=callback.bind(component);bus.addEventListener(eventName,listener);return()=>bus.removeEventListener(eventName,listener);},()=>[]);}
function _protectMethod(component,fn){return function(...args){if(status(component)==="destroyed"){return Promise.reject(new Error("Component is destroyed"));}
const prom=Promise.resolve(fn.call(this,...args));const protectedProm=prom.then((result)=>status(component)==="destroyed"?new Promise(()=>{}):result);return Object.assign(protectedProm,{abort:prom.abort,cancel:prom.cancel,});};}
__exports.useService=useService;function useService(serviceName){const component=useComponent();const{services}=component.env;if(!(serviceName in services)){throw new Error(`Service ${serviceName} is not available`);}
const service=services[serviceName];if(serviceName in SERVICES_METADATA){if(service instanceof Function){return _protectMethod(component,service);}else{const methods=SERVICES_METADATA[serviceName];const result=Object.create(service);for(const method of methods){result[method]=_protectMethod(component,service[method]);}
return result;}}
return service;}
__exports.useSpellCheck=useSpellCheck;function useSpellCheck({refName}={}){const elements=[];const ref=useRef(refName||"spellcheck");function toggleSpellcheck(ev){ev.target.spellcheck=document.activeElement===ev.target;}
useEffect((el)=>{if(el){const inputs=["INPUT","TEXTAREA"].includes(el.nodeName)||el.contenteditable?[el]:el.querySelectorAll("input, textarea, [contenteditable=true]");inputs.forEach((input)=>{if(input.spellcheck!==false){elements.push(input);input.addEventListener("focus",toggleSpellcheck);input.addEventListener("blur",toggleSpellcheck);}});}
return()=>{elements.forEach((input)=>{input.removeEventListener("focus",toggleSpellcheck);input.removeEventListener("blur",toggleSpellcheck);});};},()=>[ref.el]);}
__exports.useChildRef=useChildRef;function useChildRef(){let defined=false;let value;return function ref(v){value=v;if(defined){return;}
Object.defineProperty(ref,"el",{get(){return value.el;},});defined=true;};}
__exports.useForwardRefToParent=useForwardRefToParent;function useForwardRefToParent(refName){const component=useComponent();const ref=useRef(refName);if(component.props[refName]){component.props[refName](ref);}
return ref;}
__exports.useOwnedDialogs=useOwnedDialogs;function useOwnedDialogs(){const dialogService=useService("dialog");const cbs=[];onWillUnmount(()=>{cbs.forEach((cb)=>cb());});const addDialog=(...args)=>{const close=dialogService.add(...args);cbs.push(close);return close;};return addDialog;}
__exports.useRefListener=useRefListener;function useRefListener(ref,...listener){useEffect((el)=>{el?.addEventListener(...listener);return()=>el?.removeEventListener(...listener);},()=>[ref.el]);}
return __exports;});;

/* /web/static/src/core/utils/misc.js */
odoo.define('@web/core/utils/misc',[],function(require){'use strict';let __exports={};const eventHandledWeakMap=new WeakMap();__exports.isEventHandled=isEventHandled;function isEventHandled(ev,markName){if(!eventHandledWeakMap.get(ev)){return false;}
return eventHandledWeakMap.get(ev).includes(markName);}
__exports.markEventHandled=markEventHandled;function markEventHandled(ev,markName){if(!eventHandledWeakMap.get(ev)){eventHandledWeakMap.set(ev,[]);}
eventHandledWeakMap.get(ev).push(markName);}
return __exports;});;

/* /web/static/src/core/utils/nested_sortable.js */
odoo.define('@web/core/utils/nested_sortable',['@web/core/l10n/localization','@web/core/utils/draggable_hook_builder_owl'],function(require){'use strict';let __exports={};const{localization}=require("@web/core/l10n/localization");const{makeDraggableHook}=require("@web/core/utils/draggable_hook_builder_owl");const useNestedSortable=__exports.useNestedSortable=makeDraggableHook({name:"useNestedSortable",acceptedParams:{groups:[String,Function],connectGroups:[Boolean,Function],nest:[Boolean],listTagName:[String],nestInterval:[Number],maxLevels:[Number],isAllowed:[Function],useElementSize:[Boolean],},defaultParams:{connectGroups:false,currentGroup:null,cursor:"grabbing",edgeScrolling:{speed:20,threshold:60},elements:"li",groupSelector:null,nest:false,listTagName:"ul",nestInterval:15,maxLevels:0,isAllowed:(ctx)=>true,useElementSize:false,},onComputeParams({ctx,params}){ctx.groupSelector=params.groups||null;if(ctx.groupSelector){ctx.fullSelector=[ctx.groupSelector,ctx.fullSelector].join(" ");}
ctx.connectGroups=params.connectGroups;ctx.nest=params.nest;ctx.listTagName=params.listTagName;ctx.nestInterval=params.nestInterval;ctx.isRTL=localization.direction==="rtl";ctx.maxLevels=params.maxLevels||0;ctx.isAllowed=params.isAllowed??(()=>true);ctx.useElementSize=params.useElementSize;},onWillStartDrag({ctx,addCleanup}){if(ctx.groupSelector){ctx.currentGroup=ctx.current.element.closest(ctx.groupSelector);if(!ctx.connectGroups){ctx.current.container=ctx.currentGroup;}}
if(ctx.nest){ctx.prevNestX=ctx.pointer.x;}
ctx.current.placeHolder=ctx.current.element.cloneNode(false);ctx.current.placeHolder.classList.add("w-100","d-block","py-0");if(ctx.useElementSize){ctx.current.placeHolder.style.height=getComputedStyle(ctx.current.element).height;ctx.current.placeHolder.classList.add("o_nested_sortable_placeholder_realsize");}else{ctx.current.placeHolder.classList.add("o_nested_sortable_placeholder");}
addCleanup(()=>ctx.current.placeHolder.remove());},onDragStart({ctx,addStyle}){ctx.selectorX=ctx.isRTL?ctx.current.elementRect.left+1:ctx.current.elementRect.right-1;ctx.current.element.after(ctx.current.placeHolder);addStyle(ctx.current.element,{opacity:0.5});addStyle(document.body,{"pointer-events":"auto"});addStyle(document.querySelector(".o_navbar"),{"pointer-events":"none"});addStyle(document.querySelector(".o_action_manager"),{"pointer-events":"none"});addStyle(ctx.current.container,{"pointer-events":"auto"});return{element:ctx.current.element,group:ctx.currentGroup,};},_getDeepestChildLevel(ctx,node,depth=0){let result=0;const childSelector=`${ctx.listTagName} ${ctx.elementSelector}`;for(const childNode of node.querySelectorAll(childSelector)){result=Math.max(this._getDeepestChildLevel(ctx,childNode,depth+1),result);}
return depth?result+1:result;},_hasReachMaxAllowedLevel(ctx){if(!ctx.nest||ctx.maxLevels<1){return false;}
let level=this._getDeepestChildLevel(ctx,ctx.current.element);let list=ctx.current.placeHolder.closest(ctx.listTagName);while(list){level++;list=list.parentNode.closest(ctx.listTagName);}
return level>ctx.maxLevels;},_isAllowedNodeMove(ctx){return(!this._hasReachMaxAllowedLevel(ctx)&&ctx.isAllowed(ctx.current,ctx.elementSelector));},onDrag({ctx,callHandler}){const onMove=(prevPos)=>{if(!this._isAllowedNodeMove(ctx)){ctx.current.placeHolder.classList.add("d-none");return;}
ctx.current.placeHolder.classList.remove("d-none");callHandler("onMove",{element:ctx.current.element,previous:ctx.current.placeHolder.previousElementSibling,next:ctx.current.placeHolder.nextElementSibling,parent:ctx.nest?ctx.current.placeHolder.parentElement.closest(ctx.elementSelector):false,group:ctx.currentGroup,newGroup:ctx.connectGroups?ctx.current.placeHolder.closest(ctx.groupSelector):ctx.currentGroup,prevPos,placeholder:ctx.current.placeHolder,});};const getChildList=(el)=>{let list=el.querySelector(ctx.listTagName);if(!list){list=document.createElement(ctx.listTagName);el.appendChild(list);}
return list;};const position={previous:ctx.current.placeHolder.previousElementSibling,next:ctx.current.placeHolder.nextElementSibling,parent:ctx.nest?ctx.current.placeHolder.parentElement.closest(ctx.elementSelector):false,group:ctx.groupSelector?ctx.current.placeHolder.closest(ctx.groupSelector):false,};if(ctx.nest){const xInterval=ctx.prevNestX-ctx.pointer.x;if(ctx.nestInterval-(-1)**ctx.isRTL*xInterval<1){let nextElement=position.next;if(nextElement===ctx.current.element){nextElement=nextElement.nextElementSibling;}
if(!nextElement){const newSibling=position.parent;if(newSibling){newSibling.after(ctx.current.placeHolder);onMove(position);}}
ctx.prevNestX=ctx.pointer.x;return;}else if(ctx.nestInterval+(-1)**ctx.isRTL*xInterval<1){let parent=position.previous;if(parent===ctx.current.element){parent=parent.previousElementSibling;}
if(parent&&parent.matches(ctx.elementSelector)){getChildList(parent).appendChild(ctx.current.placeHolder);onMove(position);}
ctx.prevNestX=ctx.pointer.x;return;}}
const currentTop=ctx.pointer.y-ctx.current.offset.y;const closestEl=document.elementFromPoint(ctx.selectorX,currentTop);if(!closestEl){return;}
const element=closestEl.closest(ctx.elementSelector);if(element&&element!==ctx.current.placeHolder){const eRect=element.getBoundingClientRect();const pos=ctx.current.placeHolder.compareDocumentPosition(element);if(currentTop-eRect.y<10){if(pos===Node.DOCUMENT_POSITION_PRECEDING||pos===(Node.DOCUMENT_POSITION_PRECEDING|Node.DOCUMENT_POSITION_CONTAINS)){element.before(ctx.current.placeHolder);onMove(position);ctx.prevNestX=ctx.pointer.x;}}else if(currentTop-eRect.y>15&&pos===Node.DOCUMENT_POSITION_FOLLOWING){if(ctx.nest){const elementChildList=getChildList(element);if(elementChildList.querySelector(ctx.elementSelector)){elementChildList.prepend(ctx.current.placeHolder);onMove(position);}else{element.after(ctx.current.placeHolder);onMove(position);}
ctx.prevNestX=ctx.pointer.x;}else{element.after(ctx.current.placeHolder);onMove(position);}}}else{const group=closestEl.closest(ctx.groupSelector);if(group&&group!==position.group){if(group.compareDocumentPosition(position.group)===Node.DOCUMENT_POSITION_PRECEDING){getChildList(group).prepend(ctx.current.placeHolder);onMove(position);}else{getChildList(group).appendChild(ctx.current.placeHolder);onMove(position);}
ctx.prevNestX=ctx.pointer.x;callHandler("onGroupEnter",{group,element:ctx.current.placeHolder});callHandler("onGroupLeave",{group:position.group,element:ctx.current.placeHolder,});}}},onDrop({ctx}){if(!this._isAllowedNodeMove(ctx)){return;}
const previous=ctx.current.placeHolder.previousElementSibling;const next=ctx.current.placeHolder.nextElementSibling;if(previous!==ctx.current.element&&next!==ctx.current.element){return{element:ctx.current.element,group:ctx.currentGroup,previous,next,newGroup:ctx.groupSelector&&ctx.current.placeHolder.closest(ctx.groupSelector),parent:ctx.current.placeHolder.parentElement.closest(ctx.elementSelector),placeholder:ctx.current.placeHolder,};}},onDragEnd({ctx}){return{element:ctx.current.element,group:ctx.currentGroup,};},});return __exports;});;

/* /web/static/src/core/utils/numbers.js */
odoo.define('@web/core/utils/numbers',['@web/core/l10n/localization','@web/core/l10n/translation','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{localization:l10n}=require("@web/core/l10n/localization");const{_t}=require("@web/core/l10n/translation");const{intersperse}=require("@web/core/utils/strings");__exports.clamp=clamp;function clamp(num,min,max){return Math.max(Math.min(num,max),min);}
__exports.range=range;function range(start,stop,step=1){const array=[];const nsteps=Math.floor((stop-start)/step);for(let i=0;i<nsteps;i++){array.push(start+step*i);}
return array;}
__exports.roundPrecision=roundPrecision;function roundPrecision(value,precision){if(!value){return 0;}else if(!precision||precision<0){precision=1;}
let normalizedValue=value/precision;const epsilonMagnitude=Math.log2(Math.abs(normalizedValue));const epsilon=Math.pow(2,epsilonMagnitude-52);normalizedValue+=normalizedValue>=0?epsilon:-epsilon;const sign=normalizedValue<0?-1.0:1.0;const roundedValue=sign*Math.round(Math.abs(normalizedValue));return roundedValue*precision;}
__exports.roundDecimals=roundDecimals;function roundDecimals(value,decimals){return roundPrecision(value,parseFloat("1e"+-decimals));}
__exports.floatIsZero=floatIsZero;function floatIsZero(value,decimals){return roundDecimals(value,decimals)===0;}
__exports.insertThousandsSep=insertThousandsSep;function insertThousandsSep(number,thousandsSep=",",grouping=[]){const negative=number[0]==="-";number=negative?number.slice(1):number;return(negative?"-":"")+intersperse(number,grouping,thousandsSep);}
__exports.humanNumber=humanNumber;function humanNumber(number,options={decimals:0,minDigits:1}){const decimals=options.decimals||0;const minDigits=options.minDigits||1;const d2=Math.pow(10,decimals);const numberMagnitude=+number.toExponential().split("e+")[1];number=Math.round(number*d2)/d2;if(numberMagnitude>=21){number=Math.round(number*Math.pow(10,decimals-numberMagnitude))/d2;return`${number}e+${numberMagnitude}`;}
const unitSymbols=_t("kMGTPE").toString();const sign=Math.sign(number);number=Math.abs(number);let symbol="";for(let i=unitSymbols.length;i>0;i--){const s=Math.pow(10,i*3);if(s<=number/Math.pow(10,minDigits-1)){number=Math.round((number*d2)/s)/d2;symbol=unitSymbols[i-1];break;}}
const{decimalPoint,grouping,thousandsSep}=l10n;const decimalsToKeep=number>=1000?0:decimals;number=sign*number;const[integerPart,decimalPart]=number.toFixed(decimalsToKeep).split(".");const int=insertThousandsSep(integerPart,thousandsSep,grouping);if(!decimalPart){return int+symbol;}
return int+decimalPoint+decimalPart+symbol;}
__exports.formatFloat=formatFloat;function formatFloat(value,options={}){if(options.humanReadable){return humanNumber(value,options);}
const grouping=options.grouping||l10n.grouping;const thousandsSep="thousandsSep"in options?options.thousandsSep:l10n.thousandsSep;const decimalPoint="decimalPoint"in options?options.decimalPoint:l10n.decimalPoint;let precision;if(options.digits&&options.digits[1]!==undefined){precision=options.digits[1];}else{precision=2;}
const formatted=value.toFixed(precision).split(".");formatted[0]=insertThousandsSep(formatted[0],thousandsSep,grouping);if(options.trailingZeros===false&&formatted[1]){formatted[1]=formatted[1].replace(/0+$/,"");}
return formatted[1]?formatted.join(decimalPoint):formatted[0];}
return __exports;});;

/* /web/static/src/core/utils/objects.js */
odoo.define('@web/core/utils/objects',[],function(require){'use strict';let __exports={};__exports.shallowEqual=shallowEqual;function shallowEqual(obj1,obj2,comparisonFn=(a,b)=>a===b){if(!obj1||!obj2||typeof obj1!=="object"||typeof obj2!=="object"){return obj1===obj2;}
const obj1Keys=Object.keys(obj1);return(obj1Keys.length===Object.keys(obj2).length&&obj1Keys.every((key)=>comparisonFn(obj1[key],obj2[key])));}
const deepEqual=__exports.deepEqual=(obj1,obj2)=>shallowEqual(obj1,obj2,deepEqual);__exports.deepCopy=deepCopy;function deepCopy(obj){return JSON.parse(JSON.stringify(obj));}
__exports.omit=omit;function omit(object,...properties){const result={};const propertiesSet=new Set(properties);for(const key in object){if(!propertiesSet.has(key)){result[key]=object[key];}}
return result;}
__exports.pick=pick;function pick(object,...properties){return Object.fromEntries(properties.filter((prop)=>prop in object).map((prop)=>[prop,object[prop]]));}
return __exports;});;

/* /web/static/src/core/utils/patch.js */
odoo.define('@web/core/utils/patch',[],function(require){'use strict';let __exports={};const patchDescriptions=new WeakMap();function getPatchDescription(objToPatch){if(!patchDescriptions.has(objToPatch)){patchDescriptions.set(objToPatch,{originalProperties:new Map(),skeleton:Object.create(Object.getPrototypeOf(objToPatch)),extensions:new Set(),});}
return patchDescriptions.get(objToPatch);}
function isClassPrototype(objToPatch){return Object.hasOwn(objToPatch,"constructor")&&objToPatch.constructor?.prototype===objToPatch;}
function findAncestorPropertyDescriptor(objToPatch,key){let descriptor=null;let prototype=objToPatch;do{descriptor=Object.getOwnPropertyDescriptor(prototype,key);prototype=Object.getPrototypeOf(prototype);}while(!descriptor&&prototype);return descriptor;}
__exports.patch=patch;function patch(objToPatch,extension){if(typeof extension==="string"){throw new Error(`Patch "${extension}": Second argument is not the patch name anymore, it should be the object containing the patched properties`);}
const description=getPatchDescription(objToPatch);description.extensions.add(extension);const properties=Object.getOwnPropertyDescriptors(extension);for(const[key,newProperty]of Object.entries(properties)){const oldProperty=Object.getOwnPropertyDescriptor(objToPatch,key);if(oldProperty){Object.defineProperty(description.skeleton,key,oldProperty);}
if(!description.originalProperties.has(key)){description.originalProperties.set(key,oldProperty);}
if(isClassPrototype(objToPatch)){newProperty.enumerable=false;}
if((newProperty.get&&1)^(newProperty.set&&1)){const ancestorProperty=findAncestorPropertyDescriptor(objToPatch,key);newProperty.get=newProperty.get??ancestorProperty?.get;newProperty.set=newProperty.set??ancestorProperty?.set;}
Object.defineProperty(objToPatch,key,newProperty);}
description.skeleton=Object.setPrototypeOf(extension,description.skeleton);return()=>{patchDescriptions.delete(objToPatch);for(const[key,property]of description.originalProperties){if(property){Object.defineProperty(objToPatch,key,property);}else{delete objToPatch[key];}}
description.extensions.delete(extension);for(const extension of description.extensions){patch(objToPatch,extension);}};}
return __exports;});;

/* /web/static/src/core/utils/reactive.js */
odoo.define('@web/core/utils/reactive',['@odoo/owl'],function(require){'use strict';let __exports={};const{reactive}=require("@odoo/owl");const Reactive=__exports.Reactive=class Reactive{constructor(){return reactive(this);}}
__exports.effect=effect;function effect(cb,deps){const reactiveDeps=reactive(deps,()=>{cb(...reactiveDeps);});cb(...reactiveDeps);}
__exports.withComputedProperties=withComputedProperties;function withComputedProperties(obj,sources,descriptor){for(const[key,compute]of Object.entries(descriptor)){effect((obj,sources)=>{obj[key]=compute.call(obj,...sources);},[obj,sources]);}
return obj;}
return __exports;});;

/* /web/static/src/core/utils/render.js */
odoo.define('@web/core/utils/render',['@odoo/owl','@web/core/assets','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{App,blockDom,Component,markup}=require("@odoo/owl");const{templates}=require("@web/core/assets");const{_t}=require("@web/core/l10n/translation");__exports.renderToElement=renderToElement;function renderToElement(template,context={}){const el=render(template,context).firstElementChild;if(el?.nextElementSibling){throw new Error(`The rendered template '${template}' contains multiple root `+`nodes that will be ignored using renderToElement, you should `+`consider using renderToFragment or refactoring the template.`);}
el?.remove();return el;}
__exports.renderToFragment=renderToFragment;function renderToFragment(template,context={}){const frag=document.createDocumentFragment();for(const el of[...render(template,context).children]){frag.appendChild(el);}
return frag;}
__exports.renderToString=renderToString;function renderToString(template,context={}){return render(template,context).innerHTML;}
let app;Object.defineProperty(renderToString,"app",{get:()=>{if(!app){app=new App(Component,{name:"renderToString",templates,translatableAttributes:["data-tooltip"],translateFn:_t,});}
return app;},});function render(template,context={}){const app=renderToString.app;const templateFn=app.getTemplate(template);const bdom=templateFn(context,{});const div=document.createElement("div");blockDom.mount(bdom,div);return div;}
__exports.renderToMarkup=renderToMarkup;function renderToMarkup(template,context={}){return markup(renderToString(template,context));}
return __exports;});;

/* /web/static/src/core/utils/scrolling.js */
odoo.define('@web/core/utils/scrolling',[],function(require){'use strict';let __exports={};__exports.closestScrollableX=closestScrollableX;function closestScrollableX(el){if(!el){return null;}
if(el.scrollWidth>el.clientWidth&&el.clientWidth>0){const overflow=getComputedStyle(el).getPropertyValue("overflow-x");if(/\bauto\b|\bscroll\b/.test(overflow)){return el;}}
return closestScrollableX(el.parentElement);}
__exports.closestScrollableY=closestScrollableY;function closestScrollableY(el){if(!el){return null;}
if(el.scrollHeight>el.clientHeight&&el.clientHeight>0){const overflow=getComputedStyle(el).getPropertyValue("overflow-y");if(/\bauto\b|\bscroll\b/.test(overflow)){return el;}}
return closestScrollableY(el.parentElement);}
__exports.scrollTo=scrollTo;function scrollTo(element,options={behavior:"auto",scrollable:null,isAnchor:false}){const scrollable=closestScrollableY(options.scrollable||element.parentElement);if(scrollable){const scrollBottom=scrollable.getBoundingClientRect().bottom;const scrollTop=scrollable.getBoundingClientRect().top;const elementBottom=element.getBoundingClientRect().bottom;const elementTop=element.getBoundingClientRect().top;if(elementBottom>scrollBottom&&!options.isAnchor){scrollable.scrollTo({top:scrollable.scrollTop+
elementTop-
scrollBottom+
Math.ceil(element.getBoundingClientRect().height),behavior:options.behavior,});}else if(elementTop<scrollTop||options.isAnchor){scrollable.scrollTo({top:scrollable.scrollTop-scrollTop+elementTop,behavior:options.behavior,});if(options.isAnchor){const parentScrollable=closestScrollableY(scrollable.parentElement);if(parentScrollable){scrollTo(scrollable,{behavior:options.behavior,isAnchor:true,scrollable:parentScrollable,});}}}}}
return __exports;});;

/* /web/static/src/core/utils/search.js */
odoo.define('@web/core/utils/search',['@web/core/utils/strings'],function(require){'use strict';let __exports={};const{unaccent}=require("@web/core/utils/strings");function match(pattern,strs){if(!Array.isArray(strs)){strs=[strs];}
let globalScore=0;for(const str of strs){globalScore=Math.max(globalScore,_match(pattern,str));}
return globalScore;}
function _match(pattern,str){let totalScore=0;let currentScore=0;const len=str.length;let patternIndex=0;pattern=unaccent(pattern,false);str=unaccent(str,false);for(let i=0;i<len;i++){if(str[i]===pattern[patternIndex]){patternIndex++;currentScore+=100+currentScore-i/200;}else{currentScore=0;}
totalScore=totalScore+currentScore;}
return patternIndex===pattern.length?totalScore:0;}
__exports.fuzzyLookup=fuzzyLookup;function fuzzyLookup(pattern,list,fn){const results=[];list.forEach((data)=>{const score=match(pattern,fn(data));if(score>0){results.push({score,elem:data});}});results.sort((a,b)=>b.score-a.score);return results.map((r)=>r.elem);}
__exports.fuzzyTest=fuzzyTest;function fuzzyTest(pattern,string){return _match(pattern,string)!==0;}
return __exports;});;

/* /web/static/src/core/utils/sortable.js */
odoo.define('@web/core/utils/sortable',['@web/core/utils/draggable_hook_builder','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{DRAGGED_CLASS,makeDraggableHook:nativeMakeDraggableHook,}=require("@web/core/utils/draggable_hook_builder");const{pick}=require("@web/core/utils/objects");const hookParams={name:"useSortable",acceptedParams:{groups:[String,Function],connectGroups:[Boolean,Function],clone:[Boolean],placeholderClasses:[Object],applyChangeOnDrop:[Boolean],followingElementClasses:[Object],},defaultParams:{connectGroups:false,edgeScrolling:{speed:20,threshold:60},groupSelector:null,clone:true,placeholderClasses:[],applyChangeOnDrop:false,followingElementClasses:[],},onComputeParams({ctx,params}){ctx.groupSelector=params.groups||null;if(ctx.groupSelector){ctx.fullSelector=[ctx.groupSelector,ctx.fullSelector].join(" ");}
ctx.connectGroups=params.connectGroups;ctx.placeholderClone=params.clone;ctx.placeholderClasses=params.placeholderClasses;ctx.applyChangeOnDrop=params.applyChangeOnDrop;ctx.followingElementClasses=params.followingElementClasses;},onDragStart({ctx,addListener,addStyle,callHandler}){const onElementPointerEnter=(ev)=>{const element=ev.currentTarget;if(connectGroups||!groupSelector||current.group===element.closest(groupSelector)){const pos=current.placeHolder.compareDocumentPosition(element);if(pos===Node.DOCUMENT_POSITION_PRECEDING){element.before(current.placeHolder);}else if(pos===Node.DOCUMENT_POSITION_FOLLOWING){element.after(current.placeHolder);}}
callHandler("onElementEnter",{element});};const onElementPointerLeave=(ev)=>{const element=ev.currentTarget;callHandler("onElementLeave",{element});};const onElementComplexPointerEnter=(ev)=>{if(ctx.haveAlreadyChanged){return;}
const element=ev.currentTarget;const siblingArray=[...element.parentElement.children].filter((el)=>el===current.placeHolder||(el.matches(elementSelector)&&!el.classList.contains(DRAGGED_CLASS)));const elementIndex=siblingArray.indexOf(element);const placeholderIndex=siblingArray.indexOf(current.placeHolder);const isDirectSibling=Math.abs(elementIndex-placeholderIndex)===1;if(connectGroups||!groupSelector||current.group===element.closest(groupSelector)){const pos=current.placeHolder.compareDocumentPosition(element);if(isDirectSibling){if(pos===Node.DOCUMENT_POSITION_PRECEDING){element.before(current.placeHolder);ctx.haveAlreadyChanged=true;}else if(pos===Node.DOCUMENT_POSITION_FOLLOWING){element.after(current.placeHolder);ctx.haveAlreadyChanged=true;}}else{if(pos===Node.DOCUMENT_POSITION_FOLLOWING){element.before(current.placeHolder);ctx.haveAlreadyChanged=true;}else if(pos===Node.DOCUMENT_POSITION_PRECEDING){element.after(current.placeHolder);ctx.haveAlreadyChanged=true;}}}
callHandler("onElementEnter",{element});};const onElementComplexPointerLeave=(ev)=>{if(ctx.haveAlreadyChanged){return;}
const element=ev.currentTarget;const elementRect=element.getBoundingClientRect();const relatedElement=ev.relatedTarget;const relatedElementRect=element.getBoundingClientRect();const siblingArray=[...element.parentElement.children].filter((el)=>el===current.placeHolder||(el.matches(elementSelector)&&!el.classList.contains(DRAGGED_CLASS)));const pointerOnSiblings=siblingArray.indexOf(relatedElement)>-1;const elementIndex=siblingArray.indexOf(element);const isFirst=elementIndex===0;const isAbove=relatedElementRect.top<=elementRect.top;const isLast=elementIndex===siblingArray.length-1;const isBelow=relatedElementRect.bottom>=elementRect.bottom;const pos=current.placeHolder.compareDocumentPosition(element);if(!pointerOnSiblings){if(isFirst&&isAbove&&pos===Node.DOCUMENT_POSITION_PRECEDING){element.before(current.placeHolder);ctx.haveAlreadyChanged=true;}else if(isLast&&isBelow&&pos===Node.DOCUMENT_POSITION_FOLLOWING){element.after(current.placeHolder);ctx.haveAlreadyChanged=true;}}
callHandler("onElementLeave",{element});};const onGroupPointerEnter=(ev)=>{const group=ev.currentTarget;group.appendChild(current.placeHolder);callHandler("onGroupEnter",{group});};const onGroupPointerLeave=(ev)=>{const group=ev.currentTarget;callHandler("onGroupLeave",{group});};const{connectGroups,current,elementSelector,groupSelector,ref}=ctx;if(ctx.placeholderClone){const{width,height}=current.elementRect;addStyle(current.placeHolder,{visibility:"hidden",display:"block",width:`${width}px`,height:`${height}px`,});}
if(connectGroups&&groupSelector){for(const siblingGroup of ref.el.querySelectorAll(groupSelector)){addListener(siblingGroup,"pointerenter",onGroupPointerEnter);addListener(siblingGroup,"pointerleave",onGroupPointerLeave);}}
for(const siblingEl of ref.el.querySelectorAll(elementSelector)){if(siblingEl!==current.element&&siblingEl!==current.placeHolder){if(ctx.placeholderClone){addListener(siblingEl,"pointerenter",onElementPointerEnter);addListener(siblingEl,"pointerleave",onElementPointerLeave);}else{addListener(siblingEl,"pointerenter",onElementComplexPointerEnter);addListener(siblingEl,"pointerleave",onElementComplexPointerLeave);}}}
current.element.after(current.placeHolder);return pick(current,"element","group");},onDrag({ctx}){ctx.haveAlreadyChanged=false;},onDragEnd({ctx}){return pick(ctx.current,"element","group");},onDrop({ctx}){const{current,groupSelector}=ctx;const previous=current.placeHolder.previousElementSibling;const next=current.placeHolder.nextElementSibling;if(previous!==current.element&&next!==current.element){const element=current.element;if(ctx.applyChangeOnDrop){if(previous){previous.after(element);}else if(next){next.before(element);}}
return{element,group:current.group,previous,next,parent:groupSelector&&current.placeHolder.closest(groupSelector),};}},onWillStartDrag({ctx,addCleanup}){const{connectGroups,current,groupSelector}=ctx;if(groupSelector){current.group=current.element.closest(groupSelector);if(!connectGroups){current.container=current.group;}}
if(ctx.placeholderClone){current.placeHolder=current.element.cloneNode(false);}else{current.placeHolder=document.createElement("div");}
current.placeHolder.classList.add(...ctx.placeholderClasses);current.element.classList.add(...ctx.followingElementClasses);addCleanup(()=>current.element.classList.remove(...ctx.followingElementClasses));addCleanup(()=>current.placeHolder.remove());return pick(current,"element","group");},};const useSortable=__exports.useSortable=(sortableParams)=>{const{setupHooks}=sortableParams;delete sortableParams.setupHooks;return nativeMakeDraggableHook({...hookParams,setupHooks})(sortableParams);};return __exports;});;

/* /web/static/src/core/utils/sortable_owl.js */
odoo.define('@web/core/utils/sortable_owl',['@odoo/owl','@web/core/utils/timing','@web/core/utils/sortable'],function(require){'use strict';let __exports={};const{onWillUnmount,reactive,useEffect,useExternalListener}=require("@odoo/owl");const{useThrottleForAnimation}=require("@web/core/utils/timing");const{useSortable:nativeUseSortable}=require("@web/core/utils/sortable");__exports.useSortable=useSortable;function useSortable(params){return nativeUseSortable({...params,setupHooks:{addListener:useExternalListener,setup:useEffect,teardown:onWillUnmount,throttle:useThrottleForAnimation,wrapState:reactive,},});}
return __exports;});;

/* /web/static/src/core/utils/sortable_service.js */
odoo.define('@web/core/utils/sortable_service',['@web/core/registry','@web/core/utils/sortable','@web/core/utils/timing','@odoo/owl'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{useSortable}=require("@web/core/utils/sortable");const{throttleForAnimation}=require("@web/core/utils/timing");const{reactive}=require("@odoo/owl");const DEFAULT_SORTABLE_ID=Symbol.for("defaultSortable");const sortableService=__exports.sortableService={start(){const boundElements=new Map();return{create:(hookParams)=>{const element=hookParams.ref.el;const sortableId=hookParams.sortableId??DEFAULT_SORTABLE_ID;if(boundElements.has(element)){const boundElement=boundElements.get(element);if(sortableId in boundElement){return{enable(){return{cleanup:boundElement[sortableId],};},};}}
const setupFunctions=new Map();const cleanupFunctions=[];const cleanup=()=>{const boundElement=boundElements.get(element);if(sortableId in boundElement){delete boundElement[sortableId];if(boundElement.length===0){boundElements.delete(element);}}
cleanupFunctions.forEach((fn)=>fn());};const setupHooks={wrapState:reactive,throttle:throttleForAnimation,addListener:(el,type,listener)=>{el.addEventListener(type,listener);cleanupFunctions.push(()=>el.removeEventListener(type,listener));},setup:(setupFn,dependenciesFn)=>setupFunctions.set(setupFn,dependenciesFn),teardown:(fn)=>cleanupFunctions.push(fn),};useSortable({setupHooks,...hookParams});const boundElement=boundElements.get(element);if(boundElement){boundElement[sortableId]=cleanup;}else{boundElements.set(element,{[sortableId]:cleanup});}
return{enable(){setupFunctions.forEach((dependenciesFn,setupFn)=>setupFn(...dependenciesFn()));return{cleanup,};},};},};},};registry.category("services").add("sortable",sortableService);return __exports;});;

/* /web/static/src/core/utils/strings.js */
odoo.define('@web/core/utils/strings',[],function(require){'use strict';let __exports={};const nbsp=__exports.nbsp="\u00a0";const escapeMethod=__exports.escapeMethod=Symbol("html");__exports.escape=escape;function escape(str){if(typeof str==="object"&&str[escapeMethod]){return str[escapeMethod]();}else{if(str===undefined){return"";}
if(typeof str==="number"){return String(str);}
[["&","&amp;"],["<","&lt;"],[">","&gt;"],["'","&#x27;"],['"',"&quot;"],["`","&#x60;"],].forEach((pairs)=>{str=String(str).replaceAll(pairs[0],pairs[1]);});return str;}}
__exports.escapeRegExp=escapeRegExp;function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}
__exports.intersperse=intersperse;function intersperse(str,indices,separator=""){separator=separator||"";const result=[];let last=str.length;for(let i=0;i<indices.length;++i){let section=indices[i];if(section===-1||last<=0){break;}else if(section===0&&i===0){break;}else if(section===0){section=indices[--i];}
result.push(str.substring(last-section,last));last-=section;}
const s=str.substring(0,last);if(s){result.push(s);}
return result.reverse().join(separator);}
__exports.sprintf=sprintf;function sprintf(s,...values){if(values.length===1&&Object.prototype.toString.call(values[0])==="[object Object]"){const valuesDict=values[0];s=s.replace(/%\(([^)]+)\)s/g,(match,value)=>valuesDict[value]);}else if(values.length>0){s=s.replace(/%s/g,()=>values.shift());}
return s;}
__exports.capitalize=capitalize;function capitalize(s){return s?s[0].toUpperCase()+s.slice(1):"";}
const diacriticsMap={'\u0041':'A','\u24B6':'A','\uFF21':'A','\u00C0':'A','\u00C1':'A','\u00C2':'A','\u1EA6':'A','\u1EA4':'A','\u1EAA':'A','\u1EA8':'A','\u00C3':'A','\u0100':'A','\u0102':'A','\u1EB0':'A','\u1EAE':'A','\u1EB4':'A','\u1EB2':'A','\u0226':'A','\u01E0':'A','\u00C4':'A','\u01DE':'A','\u1EA2':'A','\u00C5':'A','\u01FA':'A','\u01CD':'A','\u0200':'A','\u0202':'A','\u1EA0':'A','\u1EAC':'A','\u1EB6':'A','\u1E00':'A','\u0104':'A','\u023A':'A','\u2C6F':'A','\uA732':'AA','\u00C6':'AE','\u01FC':'AE','\u01E2':'AE','\uA734':'AO','\uA736':'AU','\uA738':'AV','\uA73A':'AV','\uA73C':'AY','\u0042':'B','\u24B7':'B','\uFF22':'B','\u1E02':'B','\u1E04':'B','\u1E06':'B','\u0243':'B','\u0182':'B','\u0181':'B','\u0043':'C','\u24B8':'C','\uFF23':'C','\u0106':'C','\u0108':'C','\u010A':'C','\u010C':'C','\u00C7':'C','\u1E08':'C','\u0187':'C','\u023B':'C','\uA73E':'C','\u0044':'D','\u24B9':'D','\uFF24':'D','\u1E0A':'D','\u010E':'D','\u1E0C':'D','\u1E10':'D','\u1E12':'D','\u1E0E':'D','\u0110':'D','\u018B':'D','\u018A':'D','\u0189':'D','\uA779':'D','\u01F1':'DZ','\u01C4':'DZ','\u01F2':'Dz','\u01C5':'Dz','\u0045':'E','\u24BA':'E','\uFF25':'E','\u00C8':'E','\u00C9':'E','\u00CA':'E','\u1EC0':'E','\u1EBE':'E','\u1EC4':'E','\u1EC2':'E','\u1EBC':'E','\u0112':'E','\u1E14':'E','\u1E16':'E','\u0114':'E','\u0116':'E','\u00CB':'E','\u1EBA':'E','\u011A':'E','\u0204':'E','\u0206':'E','\u1EB8':'E','\u1EC6':'E','\u0228':'E','\u1E1C':'E','\u0118':'E','\u1E18':'E','\u1E1A':'E','\u0190':'E','\u018E':'E','\u0046':'F','\u24BB':'F','\uFF26':'F','\u1E1E':'F','\u0191':'F','\uA77B':'F','\u0047':'G','\u24BC':'G','\uFF27':'G','\u01F4':'G','\u011C':'G','\u1E20':'G','\u011E':'G','\u0120':'G','\u01E6':'G','\u0122':'G','\u01E4':'G','\u0193':'G','\uA7A0':'G','\uA77D':'G','\uA77E':'G','\u0048':'H','\u24BD':'H','\uFF28':'H','\u0124':'H','\u1E22':'H','\u1E26':'H','\u021E':'H','\u1E24':'H','\u1E28':'H','\u1E2A':'H','\u0126':'H','\u2C67':'H','\u2C75':'H','\uA78D':'H','\u0049':'I','\u24BE':'I','\uFF29':'I','\u00CC':'I','\u00CD':'I','\u00CE':'I','\u0128':'I','\u012A':'I','\u012C':'I','\u0130':'I','\u00CF':'I','\u1E2E':'I','\u1EC8':'I','\u01CF':'I','\u0208':'I','\u020A':'I','\u1ECA':'I','\u012E':'I','\u1E2C':'I','\u0197':'I','\u004A':'J','\u24BF':'J','\uFF2A':'J','\u0134':'J','\u0248':'J','\u004B':'K','\u24C0':'K','\uFF2B':'K','\u1E30':'K','\u01E8':'K','\u1E32':'K','\u0136':'K','\u1E34':'K','\u0198':'K','\u2C69':'K','\uA740':'K','\uA742':'K','\uA744':'K','\uA7A2':'K','\u004C':'L','\u24C1':'L','\uFF2C':'L','\u013F':'L','\u0139':'L','\u013D':'L','\u1E36':'L','\u1E38':'L','\u013B':'L','\u1E3C':'L','\u1E3A':'L','\u0141':'L','\u023D':'L','\u2C62':'L','\u2C60':'L','\uA748':'L','\uA746':'L','\uA780':'L','\u01C7':'LJ','\u01C8':'Lj','\u004D':'M','\u24C2':'M','\uFF2D':'M','\u1E3E':'M','\u1E40':'M','\u1E42':'M','\u2C6E':'M','\u019C':'M','\u004E':'N','\u24C3':'N','\uFF2E':'N','\u01F8':'N','\u0143':'N','\u00D1':'N','\u1E44':'N','\u0147':'N','\u1E46':'N','\u0145':'N','\u1E4A':'N','\u1E48':'N','\u0220':'N','\u019D':'N','\uA790':'N','\uA7A4':'N','\u01CA':'NJ','\u01CB':'Nj','\u004F':'O','\u24C4':'O','\uFF2F':'O','\u00D2':'O','\u00D3':'O','\u00D4':'O','\u1ED2':'O','\u1ED0':'O','\u1ED6':'O','\u1ED4':'O','\u00D5':'O','\u1E4C':'O','\u022C':'O','\u1E4E':'O','\u014C':'O','\u1E50':'O','\u1E52':'O','\u014E':'O','\u022E':'O','\u0230':'O','\u00D6':'O','\u022A':'O','\u1ECE':'O','\u0150':'O','\u01D1':'O','\u020C':'O','\u020E':'O','\u01A0':'O','\u1EDC':'O','\u1EDA':'O','\u1EE0':'O','\u1EDE':'O','\u1EE2':'O','\u1ECC':'O','\u1ED8':'O','\u01EA':'O','\u01EC':'O','\u00D8':'O','\u01FE':'O','\u0186':'O','\u019F':'O','\uA74A':'O','\uA74C':'O','\u01A2':'OI','\uA74E':'OO','\u0222':'OU','\u0050':'P','\u24C5':'P','\uFF30':'P','\u1E54':'P','\u1E56':'P','\u01A4':'P','\u2C63':'P','\uA750':'P','\uA752':'P','\uA754':'P','\u0051':'Q','\u24C6':'Q','\uFF31':'Q','\uA756':'Q','\uA758':'Q','\u024A':'Q','\u0052':'R','\u24C7':'R','\uFF32':'R','\u0154':'R','\u1E58':'R','\u0158':'R','\u0210':'R','\u0212':'R','\u1E5A':'R','\u1E5C':'R','\u0156':'R','\u1E5E':'R','\u024C':'R','\u2C64':'R','\uA75A':'R','\uA7A6':'R','\uA782':'R','\u0053':'S','\u24C8':'S','\uFF33':'S','\u1E9E':'S','\u015A':'S','\u1E64':'S','\u015C':'S','\u1E60':'S','\u0160':'S','\u1E66':'S','\u1E62':'S','\u1E68':'S','\u0218':'S','\u015E':'S','\u2C7E':'S','\uA7A8':'S','\uA784':'S','\u0054':'T','\u24C9':'T','\uFF34':'T','\u1E6A':'T','\u0164':'T','\u1E6C':'T','\u021A':'T','\u0162':'T','\u1E70':'T','\u1E6E':'T','\u0166':'T','\u01AC':'T','\u01AE':'T','\u023E':'T','\uA786':'T','\uA728':'TZ','\u0055':'U','\u24CA':'U','\uFF35':'U','\u00D9':'U','\u00DA':'U','\u00DB':'U','\u0168':'U','\u1E78':'U','\u016A':'U','\u1E7A':'U','\u016C':'U','\u00DC':'U','\u01DB':'U','\u01D7':'U','\u01D5':'U','\u01D9':'U','\u1EE6':'U','\u016E':'U','\u0170':'U','\u01D3':'U','\u0214':'U','\u0216':'U','\u01AF':'U','\u1EEA':'U','\u1EE8':'U','\u1EEE':'U','\u1EEC':'U','\u1EF0':'U','\u1EE4':'U','\u1E72':'U','\u0172':'U','\u1E76':'U','\u1E74':'U','\u0244':'U','\u0056':'V','\u24CB':'V','\uFF36':'V','\u1E7C':'V','\u1E7E':'V','\u01B2':'V','\uA75E':'V','\u0245':'V','\uA760':'VY','\u0057':'W','\u24CC':'W','\uFF37':'W','\u1E80':'W','\u1E82':'W','\u0174':'W','\u1E86':'W','\u1E84':'W','\u1E88':'W','\u2C72':'W','\u0058':'X','\u24CD':'X','\uFF38':'X','\u1E8A':'X','\u1E8C':'X','\u0059':'Y','\u24CE':'Y','\uFF39':'Y','\u1EF2':'Y','\u00DD':'Y','\u0176':'Y','\u1EF8':'Y','\u0232':'Y','\u1E8E':'Y','\u0178':'Y','\u1EF6':'Y','\u1EF4':'Y','\u01B3':'Y','\u024E':'Y','\u1EFE':'Y','\u005A':'Z','\u24CF':'Z','\uFF3A':'Z','\u0179':'Z','\u1E90':'Z','\u017B':'Z','\u017D':'Z','\u1E92':'Z','\u1E94':'Z','\u01B5':'Z','\u0224':'Z','\u2C7F':'Z','\u2C6B':'Z','\uA762':'Z','\u0061':'a','\u24D0':'a','\uFF41':'a','\u1E9A':'a','\u00E0':'a','\u00E1':'a','\u00E2':'a','\u1EA7':'a','\u1EA5':'a','\u1EAB':'a','\u1EA9':'a','\u00E3':'a','\u0101':'a','\u0103':'a','\u1EB1':'a','\u1EAF':'a','\u1EB5':'a','\u1EB3':'a','\u0227':'a','\u01E1':'a','\u00E4':'a','\u01DF':'a','\u1EA3':'a','\u00E5':'a','\u01FB':'a','\u01CE':'a','\u0201':'a','\u0203':'a','\u1EA1':'a','\u1EAD':'a','\u1EB7':'a','\u1E01':'a','\u0105':'a','\u2C65':'a','\u0250':'a','\uA733':'aa','\u00E6':'ae','\u01FD':'ae','\u01E3':'ae','\uA735':'ao','\uA737':'au','\uA739':'av','\uA73B':'av','\uA73D':'ay','\u0062':'b','\u24D1':'b','\uFF42':'b','\u1E03':'b','\u1E05':'b','\u1E07':'b','\u0180':'b','\u0183':'b','\u0253':'b','\u0063':'c','\u24D2':'c','\uFF43':'c','\u0107':'c','\u0109':'c','\u010B':'c','\u010D':'c','\u00E7':'c','\u1E09':'c','\u0188':'c','\u023C':'c','\uA73F':'c','\u2184':'c','\u0064':'d','\u24D3':'d','\uFF44':'d','\u1E0B':'d','\u010F':'d','\u1E0D':'d','\u1E11':'d','\u1E13':'d','\u1E0F':'d','\u0111':'d','\u018C':'d','\u0256':'d','\u0257':'d','\uA77A':'d','\u01F3':'dz','\u01C6':'dz','\u0065':'e','\u24D4':'e','\uFF45':'e','\u00E8':'e','\u00E9':'e','\u00EA':'e','\u1EC1':'e','\u1EBF':'e','\u1EC5':'e','\u1EC3':'e','\u1EBD':'e','\u0113':'e','\u1E15':'e','\u1E17':'e','\u0115':'e','\u0117':'e','\u00EB':'e','\u1EBB':'e','\u011B':'e','\u0205':'e','\u0207':'e','\u1EB9':'e','\u1EC7':'e','\u0229':'e','\u1E1D':'e','\u0119':'e','\u1E19':'e','\u1E1B':'e','\u0247':'e','\u025B':'e','\u01DD':'e','\u0066':'f','\u24D5':'f','\uFF46':'f','\u1E1F':'f','\u0192':'f','\uA77C':'f','\u0067':'g','\u24D6':'g','\uFF47':'g','\u01F5':'g','\u011D':'g','\u1E21':'g','\u011F':'g','\u0121':'g','\u01E7':'g','\u0123':'g','\u01E5':'g','\u0260':'g','\uA7A1':'g','\u1D79':'g','\uA77F':'g','\u0068':'h','\u24D7':'h','\uFF48':'h','\u0125':'h','\u1E23':'h','\u1E27':'h','\u021F':'h','\u1E25':'h','\u1E29':'h','\u1E2B':'h','\u1E96':'h','\u0127':'h','\u2C68':'h','\u2C76':'h','\u0265':'h','\u0195':'hv','\u0069':'i','\u24D8':'i','\uFF49':'i','\u00EC':'i','\u00ED':'i','\u00EE':'i','\u0129':'i','\u012B':'i','\u012D':'i','\u00EF':'i','\u1E2F':'i','\u1EC9':'i','\u01D0':'i','\u0209':'i','\u020B':'i','\u1ECB':'i','\u012F':'i','\u1E2D':'i','\u0268':'i','\u0131':'i','\u006A':'j','\u24D9':'j','\uFF4A':'j','\u0135':'j','\u01F0':'j','\u0249':'j','\u006B':'k','\u24DA':'k','\uFF4B':'k','\u1E31':'k','\u01E9':'k','\u1E33':'k','\u0137':'k','\u1E35':'k','\u0199':'k','\u2C6A':'k','\uA741':'k','\uA743':'k','\uA745':'k','\uA7A3':'k','\u006C':'l','\u24DB':'l','\uFF4C':'l','\u0140':'l','\u013A':'l','\u013E':'l','\u1E37':'l','\u1E39':'l','\u013C':'l','\u1E3D':'l','\u1E3B':'l','\u017F':'l','\u0142':'l','\u019A':'l','\u026B':'l','\u2C61':'l','\uA749':'l','\uA781':'l','\uA747':'l','\u01C9':'lj','\u006D':'m','\u24DC':'m','\uFF4D':'m','\u1E3F':'m','\u1E41':'m','\u1E43':'m','\u0271':'m','\u026F':'m','\u006E':'n','\u24DD':'n','\uFF4E':'n','\u01F9':'n','\u0144':'n','\u00F1':'n','\u1E45':'n','\u0148':'n','\u1E47':'n','\u0146':'n','\u1E4B':'n','\u1E49':'n','\u019E':'n','\u0272':'n','\u0149':'n','\uA791':'n','\uA7A5':'n','\u01CC':'nj','\u006F':'o','\u24DE':'o','\uFF4F':'o','\u00F2':'o','\u00F3':'o','\u00F4':'o','\u1ED3':'o','\u1ED1':'o','\u1ED7':'o','\u1ED5':'o','\u00F5':'o','\u1E4D':'o','\u022D':'o','\u1E4F':'o','\u014D':'o','\u1E51':'o','\u1E53':'o','\u014F':'o','\u022F':'o','\u0231':'o','\u00F6':'o','\u022B':'o','\u1ECF':'o','\u0151':'o','\u01D2':'o','\u020D':'o','\u020F':'o','\u01A1':'o','\u1EDD':'o','\u1EDB':'o','\u1EE1':'o','\u1EDF':'o','\u1EE3':'o','\u1ECD':'o','\u1ED9':'o','\u01EB':'o','\u01ED':'o','\u00F8':'o','\u01FF':'o','\u0254':'o','\uA74B':'o','\uA74D':'o','\u0275':'o','\u01A3':'oi','\u0223':'ou','\uA74F':'oo','\u0070':'p','\u24DF':'p','\uFF50':'p','\u1E55':'p','\u1E57':'p','\u01A5':'p','\u1D7D':'p','\uA751':'p','\uA753':'p','\uA755':'p','\u0071':'q','\u24E0':'q','\uFF51':'q','\u024B':'q','\uA757':'q','\uA759':'q','\u0072':'r','\u24E1':'r','\uFF52':'r','\u0155':'r','\u1E59':'r','\u0159':'r','\u0211':'r','\u0213':'r','\u1E5B':'r','\u1E5D':'r','\u0157':'r','\u1E5F':'r','\u024D':'r','\u027D':'r','\uA75B':'r','\uA7A7':'r','\uA783':'r','\u0073':'s','\u24E2':'s','\uFF53':'s','\u00DF':'s','\u015B':'s','\u1E65':'s','\u015D':'s','\u1E61':'s','\u0161':'s','\u1E67':'s','\u1E63':'s','\u1E69':'s','\u0219':'s','\u015F':'s','\u023F':'s','\uA7A9':'s','\uA785':'s','\u1E9B':'s','\u0074':'t','\u24E3':'t','\uFF54':'t','\u1E6B':'t','\u1E97':'t','\u0165':'t','\u1E6D':'t','\u021B':'t','\u0163':'t','\u1E71':'t','\u1E6F':'t','\u0167':'t','\u01AD':'t','\u0288':'t','\u2C66':'t','\uA787':'t','\uA729':'tz','\u0075':'u','\u24E4':'u','\uFF55':'u','\u00F9':'u','\u00FA':'u','\u00FB':'u','\u0169':'u','\u1E79':'u','\u016B':'u','\u1E7B':'u','\u016D':'u','\u00FC':'u','\u01DC':'u','\u01D8':'u','\u01D6':'u','\u01DA':'u','\u1EE7':'u','\u016F':'u','\u0171':'u','\u01D4':'u','\u0215':'u','\u0217':'u','\u01B0':'u','\u1EEB':'u','\u1EE9':'u','\u1EEF':'u','\u1EED':'u','\u1EF1':'u','\u1EE5':'u','\u1E73':'u','\u0173':'u','\u1E77':'u','\u1E75':'u','\u0289':'u','\u0076':'v','\u24E5':'v','\uFF56':'v','\u1E7D':'v','\u1E7F':'v','\u028B':'v','\uA75F':'v','\u028C':'v','\uA761':'vy','\u0077':'w','\u24E6':'w','\uFF57':'w','\u1E81':'w','\u1E83':'w','\u0175':'w','\u1E87':'w','\u1E85':'w','\u1E98':'w','\u1E89':'w','\u2C73':'w','\u0078':'x','\u24E7':'x','\uFF58':'x','\u1E8B':'x','\u1E8D':'x','\u0079':'y','\u24E8':'y','\uFF59':'y','\u1EF3':'y','\u00FD':'y','\u0177':'y','\u1EF9':'y','\u0233':'y','\u1E8F':'y','\u00FF':'y','\u1EF7':'y','\u1E99':'y','\u1EF5':'y','\u01B4':'y','\u024F':'y','\u1EFF':'y','\u007A':'z','\u24E9':'z','\uFF5A':'z','\u017A':'z','\u1E91':'z','\u017C':'z','\u017E':'z','\u1E93':'z','\u1E95':'z','\u01B6':'z','\u0225':'z','\u0240':'z','\u2C6C':'z','\uA763':'z',};__exports.unaccent=unaccent;function unaccent(str,caseSensitive){str=str.replace(/[^\u0000-\u007E]/g,function(accented){return diacriticsMap[accented]||accented;});return caseSensitive?str:str.toLowerCase();}
__exports.isEmail=isEmail;function isEmail(value){const re=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;return re.test(value);}
return __exports;});;

/* /web/static/src/core/utils/timing.js */
odoo.define('@web/core/utils/timing',['@web/core/browser/browser','@odoo/owl'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{onWillUnmount,useComponent}=require("@odoo/owl");__exports.batched=batched;function batched(callback,synchronize=()=>Promise.resolve()){let scheduled=false;return async(...args)=>{if(!scheduled){scheduled=true;await synchronize();scheduled=false;callback(...args);}};}
__exports.debounce=debounce;function debounce(func,delay,immediate=false){let handle;const funcName=func.name?func.name+" (debounce)":"debounce";const useAnimationFrame=delay==="animationFrame";const setFnName=useAnimationFrame?"requestAnimationFrame":"setTimeout";const clearFnName=useAnimationFrame?"cancelAnimationFrame":"clearTimeout";let lastArgs;return Object.assign({[funcName](...args){lastArgs=args;return new Promise((resolve)=>{const callNow=immediate&&!handle;browser[clearFnName](handle);handle=browser[setFnName](()=>{handle=null;if(!immediate){lastArgs=undefined;Promise.resolve(func.apply(this,args)).then(resolve);}},delay);if(callNow){lastArgs=undefined;Promise.resolve(func.apply(this,args)).then(resolve);}});},}[funcName],{cancel(execNow=false){browser[clearFnName](handle);if(execNow&&lastArgs){func.apply(this,lastArgs);}},});}
__exports.setRecurringAnimationFrame=setRecurringAnimationFrame;function setRecurringAnimationFrame(callback){const handler=(timestamp)=>{callback(timestamp-lastTimestamp);lastTimestamp=timestamp;handle=browser.requestAnimationFrame(handler);};const stop=()=>{browser.cancelAnimationFrame(handle);};let lastTimestamp=browser.performance.now();let handle=browser.requestAnimationFrame(handler);return stop;}
__exports.throttleForAnimation=throttleForAnimation;function throttleForAnimation(func){let handle=null;const calls=new Set();const funcName=func.name?`${func.name} (throttleForAnimation)`:"throttleForAnimation";const pending=()=>{if(calls.size){handle=browser.requestAnimationFrame(pending);const{args,resolve}=[...calls].pop();calls.clear();Promise.resolve(func.apply(this,args)).then(resolve);}else{handle=null;}};return Object.assign({[funcName](...args){return new Promise((resolve)=>{const isNew=handle===null;if(isNew){handle=browser.requestAnimationFrame(pending);Promise.resolve(func.apply(this,args)).then(resolve);}else{calls.add({args,resolve});}});},}[funcName],{cancel(){browser.cancelAnimationFrame(handle);calls.clear();handle=null;},});}
__exports.useDebounced=useDebounced;function useDebounced(callback,delay,{execBeforeUnmount=false,immediate=false}={}){const component=useComponent();const debounced=debounce(callback.bind(component),delay,immediate);onWillUnmount(()=>debounced.cancel(execBeforeUnmount));return debounced;}
__exports.useThrottleForAnimation=useThrottleForAnimation;function useThrottleForAnimation(func){const component=useComponent();const throttledForAnimation=throttleForAnimation(func.bind(component));onWillUnmount(()=>throttledForAnimation.cancel());return throttledForAnimation;}
return __exports;});;

/* /web/static/src/core/utils/ui.js */
odoo.define('@web/core/utils/ui',[],function(require){'use strict';let __exports={};__exports.closest=closest;function closest(elements,targetPos){let closestEl=null;let closestDistance=Infinity;for(const el of elements){const rect=el.getBoundingClientRect();const distance=getQuadrance(rect,targetPos);if(!closestEl||distance<closestDistance){closestEl=el;closestDistance=distance;}}
return closestEl;}
__exports.isVisible=isVisible;function isVisible(el){if(el===document||el===window){return true;}
if(!el){return false;}
let _isVisible=false;if("offsetWidth"in el&&"offsetHeight"in el){_isVisible=el.offsetWidth>0&&el.offsetHeight>0;}else if("getBoundingClientRect"in el){const rect=el.getBoundingClientRect();_isVisible=rect.width>0&&rect.height>0;}
if(!_isVisible&&getComputedStyle(el).display==="contents"){for(const child of el.children){if(isVisible(child)){return true;}}}
return _isVisible;}
__exports._legacyIsVisible=_legacyIsVisible;function _legacyIsVisible(el){if(el===document||el===window){return true;}
if(!el){return false;}
let _isVisible=false;if("offsetWidth"in el&&"offsetHeight"in el){_isVisible=el.offsetWidth>0||el.offsetHeight>0;}else if("getBoundingClientRect"in el){const rect=el.getBoundingClientRect();_isVisible=rect.width>0||rect.height>0;}
if(!_isVisible&&getComputedStyle(el).display==="contents"){for(const child of el.children){if(isVisible(child)){return true;}}}
return _isVisible;}
__exports.getQuadrance=getQuadrance;function getQuadrance(rect,pos){let q=0;if(pos.x<rect.x){q+=(rect.x-pos.x)**2;}else if(rect.x+rect.width<pos.x){q+=(pos.x-(rect.x+rect.width))**2;}
if(pos.y<rect.y){q+=(rect.y-pos.y)**2;}else if(rect.y+rect.height<pos.y){q+=(pos.y-(rect.y+rect.height))**2;}
return q;}
__exports.getVisibleElements=getVisibleElements;function getVisibleElements(activeElement,selector){const visibleElements=[];const elements=activeElement.querySelectorAll(selector);for(const el of elements){if(isVisible(el)){visibleElements.push(el);}}
return visibleElements;}
__exports.touching=touching;function touching(elements,targetRect){const r1={x:0,y:0,width:0,height:0,...targetRect};return[...elements].filter((el)=>{const r2=el.getBoundingClientRect();return(r2.x+r2.width>=r1.x&&r2.x<=r1.x+r1.width&&r2.y+r2.height>=r1.y&&r2.y<=r1.y+r1.height);});}
const TABABLE_SELECTOR=["[tabindex]","a","area","button","frame","iframe","input","object","select","textarea","details > summary:nth-child(1)",].map((sel)=>`${sel}:not([tabindex="-1"]):not(:disabled)`).join(",");__exports.getTabableElements=getTabableElements;function getTabableElements(container=document.body){const elements=[...container.querySelectorAll(TABABLE_SELECTOR)].filter(isVisible);const byTabIndex={};for(const el of[...elements]){if(!byTabIndex[el.tabIndex]){byTabIndex[el.tabIndex]=[];}
byTabIndex[el.tabIndex].push(el);}
const withTabIndexZero=byTabIndex[0]||[];delete byTabIndex[0];return[...Object.values(byTabIndex).flat(),...withTabIndexZero];}
__exports.getNextTabableElement=getNextTabableElement;function getNextTabableElement(container=document.body){const tabableElements=getTabableElements(container);const index=tabableElements.indexOf(document.activeElement);return index===-1?tabableElements[0]:tabableElements[index+1]||null;}
__exports.getPreviousTabableElement=getPreviousTabableElement;function getPreviousTabableElement(container=document.body){const tabableElements=getTabableElements(container);const index=tabableElements.indexOf(document.activeElement);return index===-1?tabableElements[tabableElements.length-1]:tabableElements[index-1]||null;}
return __exports;});;

/* /web/static/src/core/utils/urls.js */
odoo.define('@web/core/utils/urls',['@web/session','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{session}=require("@web/session");const{browser}=require("@web/core/browser/browser");const RedirectionError=__exports.RedirectionError=class RedirectionError extends Error{}
__exports.objectToUrlEncodedString=objectToUrlEncodedString;function objectToUrlEncodedString(obj){return Object.entries(obj).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v || "")}`).join("&");}
__exports.getOrigin=getOrigin;function getOrigin(origin){if(origin){origin=origin.replace(/\/+$/,"");}else{const{host,protocol}=browser.location;origin=`${protocol}//${host}`;}
return origin;}
__exports.url=url;function url(route,queryParams,options={}){const origin=getOrigin(options.origin??session.origin);if(!route){return origin;}
let queryString=objectToUrlEncodedString(queryParams||{});queryString=queryString.length>0?`?${queryString}`:queryString;let prefix=["http://","https://","//"].some((el)=>route.length>=el.length&&route.slice(0,el.length)===el);prefix=prefix?"":origin;return`${prefix}${route}${queryString}`;}
__exports.getDataURLFromFile=getDataURLFromFile;function getDataURLFromFile(file){if(!file){return Promise.reject();}
return new Promise((resolve,reject)=>{const reader=new FileReader();reader.addEventListener("load",()=>{if(reader.result==="data:"){resolve(`data:${file.type};base64,`);}else{resolve(reader.result);}});reader.addEventListener("abort",reject);reader.addEventListener("error",reject);reader.readAsDataURL(file);});}
__exports.redirect=redirect;function redirect(url){const{origin,pathname}=browser.location;const _url=new URL(url,`${origin}${pathname}`);if(_url.origin!==origin){throw new RedirectionError("Can't redirect to another origin");}
browser.location=_url.href;}
return __exports;});;

/* /web/static/src/core/utils/xml.js */
odoo.define('@web/core/utils/xml',[],function(require){'use strict';let __exports={};const serializer=new XMLSerializer();const parser=new DOMParser();const xmlDocument=parser.parseFromString("<templates/>","text/xml");function hasParsingError(parsedDocument){return parsedDocument.getElementsByTagName("parsererror").length>0;}
__exports.parseXML=parseXML;function parseXML(str){const xml=parser.parseFromString(str,"text/xml");if(hasParsingError(xml)){throw new Error(`An error occured while parsing ${str}: ${xml.getElementsByTagName("parsererror")}`);}
return xml.documentElement;}
__exports.serializeXML=serializeXML;function serializeXML(xml){return serializer.serializeToString(xml);}
__exports.visitXML=visitXML;function visitXML(xml,callback){const visit=(el)=>{if(el){let didVisitChildren=false;const visitChildren=()=>{for(const child of el.children){visit(child);}
didVisitChildren=true;};const shouldVisitChildren=callback(el,visitChildren);if(shouldVisitChildren!==false&&!didVisitChildren){visitChildren();}}};const xmlDoc=typeof xml==="string"?parseXML(xml):xml;visit(xmlDoc);}
__exports.append=append;function append(parent,node){const nodes=Array.isArray(node)?node:[node];parent.append(...nodes.filter(Boolean));return parent;}
__exports.combineAttributes=combineAttributes;function combineAttributes(el,attr,parts,glue=" "){const allValues=[];if(el.hasAttribute(attr)){allValues.push(el.getAttribute(attr));}
parts=Array.isArray(parts)?parts:[parts];parts=parts.filter((part)=>!!part);allValues.push(...parts);el.setAttribute(attr,allValues.join(glue));}
__exports.createElement=createElement;function createElement(tagName,...args){const el=xmlDocument.createElement(tagName);for(const arg of args){if(!arg){continue;}
if(Symbol.iterator in arg){el.append(...arg);}else if(typeof arg==="object"){for(const name in arg){el.setAttribute(name,arg[name]);}}}
return el;}
__exports.createTextNode=createTextNode;function createTextNode(data){return xmlDocument.createTextNode(data);}
__exports.extractAttributes=extractAttributes;function extractAttributes(el,attributes){const attrs=Object.create(null);for(const attr of attributes){attrs[attr]=el.getAttribute(attr)||"";el.removeAttribute(attr);}
return attrs;}
__exports.getTag=getTag;function getTag(node,lower=false){const tag=(node&&node.nodeName)||"";return lower?tag.toLowerCase():tag;}
__exports.setAttributes=setAttributes;function setAttributes(node,attributes){for(const[name,value]of Object.entries(attributes)){node.setAttribute(name,value);}}
return __exports;});;

/* /web/static/src/core/browser/browser.js */
odoo.define('@web/core/browser/browser',[],function(require){'use strict';let __exports={};let sessionStorage=window.sessionStorage;let localStorage=window.localStorage;try{localStorage.setItem("__localStorage__","true");localStorage.removeItem("__localStorage__");}catch{localStorage=makeRAMLocalStorage();sessionStorage=makeRAMLocalStorage();}
const browser=__exports.browser={addEventListener:window.addEventListener.bind(window),dispatchEvent:window.dispatchEvent.bind(window),AnalyserNode:window.AnalyserNode,Audio:window.Audio,AudioBufferSourceNode:window.AudioBufferSourceNode,AudioContext:window.AudioContext,AudioWorkletNode:window.AudioWorkletNode,BeforeInstallPromptEvent:window.BeforeInstallPromptEvent?.bind(window),GainNode:window.GainNode,MediaStreamAudioSourceNode:window.MediaStreamAudioSourceNode,removeEventListener:window.removeEventListener.bind(window),setTimeout:window.setTimeout.bind(window),clearTimeout:window.clearTimeout.bind(window),setInterval:window.setInterval.bind(window),clearInterval:window.clearInterval.bind(window),performance:window.performance,requestAnimationFrame:window.requestAnimationFrame.bind(window),cancelAnimationFrame:window.cancelAnimationFrame.bind(window),console:window.console,history:window.history,matchMedia:window.matchMedia.bind(window),navigator,Notification:window.Notification,open:window.open.bind(window),SharedWorker:window.SharedWorker,Worker:window.Worker,XMLHttpRequest:window.XMLHttpRequest,localStorage,sessionStorage,fetch:window.fetch.bind(window),innerHeight:window.innerHeight,innerWidth:window.innerWidth,ontouchstart:window.ontouchstart,BroadcastChannel:window.BroadcastChannel,};Object.defineProperty(browser,"location",{set(val){window.location=val;},get(){return window.location;},configurable:true,});Object.defineProperty(browser,"innerHeight",{get:()=>window.innerHeight,configurable:true,});Object.defineProperty(browser,"innerWidth",{get:()=>window.innerWidth,configurable:true,});__exports.makeRAMLocalStorage=makeRAMLocalStorage;function makeRAMLocalStorage(){let store={};return{setItem(key,value){const newValue=String(value);store[key]=newValue;window.dispatchEvent(new StorageEvent("storage",{key,newValue}));},getItem(key){return store[key];},clear(){store={};},removeItem(key){delete store[key];window.dispatchEvent(new StorageEvent("storage",{key,newValue:null}));},get length(){return Object.keys(store).length;},key(){return"";},};}
return __exports;});;

/* /web/static/src/core/browser/feature_detection.js */
odoo.define('@web/core/browser/feature_detection',['@web/core/browser/browser'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");__exports.isBrowserChrome=isBrowserChrome;function isBrowserChrome(){return/Chrome/i.test(browser.navigator.userAgent);}
__exports.isBrowserFirefox=isBrowserFirefox;function isBrowserFirefox(){return/Firefox/i.test(browser.navigator.userAgent);}
__exports.isBrowserSafari=isBrowserSafari;function isBrowserSafari(){return!isBrowserChrome()&&browser.navigator.userAgent.includes("Safari");}
__exports.isAndroid=isAndroid;function isAndroid(){return/Android/i.test(browser.navigator.userAgent);}
__exports.isIOS=isIOS;function isIOS(){return(/(iPad|iPhone|iPod)/i.test(browser.navigator.userAgent)||(browser.navigator.platform==="MacIntel"&&maxTouchPoints()>1));}
__exports.isOtherMobileOS=isOtherMobileOS;function isOtherMobileOS(){return/(webOS|BlackBerry|Windows Phone)/i.test(browser.navigator.userAgent);}
__exports.isMacOS=isMacOS;function isMacOS(){return/Mac/i.test(browser.navigator.userAgent);}
__exports.isMobileOS=isMobileOS;function isMobileOS(){return isAndroid()||isIOS()||isOtherMobileOS();}
__exports.isIosApp=isIosApp;function isIosApp(){return/OdooMobile \(iOS\)/i.test(browser.navigator.userAgent);}
__exports.isAndroidApp=isAndroidApp;function isAndroidApp(){return/OdooMobile.+Android/i.test(browser.navigator.userAgent);}
__exports.isDisplayStandalone=isDisplayStandalone;function isDisplayStandalone(){return browser.matchMedia("(display-mode: standalone)").matches;}
__exports.hasTouch=hasTouch;function hasTouch(){return browser.ontouchstart!==undefined||browser.matchMedia("(pointer:coarse)").matches;}
__exports.maxTouchPoints=maxTouchPoints;function maxTouchPoints(){return browser.navigator.maxTouchPoints||1;}
return __exports;});;

/* /web/static/src/core/registry.js */
odoo.define('@web/core/registry',['@odoo/owl'],function(require){'use strict';let __exports={};const{EventBus}=require("@odoo/owl");const KeyNotFoundError=__exports.KeyNotFoundError=class KeyNotFoundError extends Error{}
const DuplicatedKeyError=__exports.DuplicatedKeyError=class DuplicatedKeyError extends Error{}
const Registry=__exports.Registry=class Registry extends EventBus{constructor(){super();this.content={};this.subRegistries={};this.elements=null;this.entries=null;this.addEventListener("UPDATE",()=>{this.elements=null;this.entries=null;});}
add(key,value,{force,sequence}={}){if(!force&&key in this.content){throw new DuplicatedKeyError(`Cannot add '${key}' in this registry: it already exists`);}
let previousSequence;if(force){const elem=this.content[key];previousSequence=elem&&elem[0];}
sequence=sequence===undefined?previousSequence||50:sequence;this.content[key]=[sequence,value];const payload={operation:"add",key,value};this.trigger("UPDATE",payload);return this;}
get(key,defaultValue){if(arguments.length<2&&!(key in this.content)){throw new KeyNotFoundError(`Cannot find ${key} in this registry!`);}
const info=this.content[key];return info?info[1]:defaultValue;}
contains(key){return key in this.content;}
getAll(){if(!this.elements){const content=Object.values(this.content).sort((el1,el2)=>el1[0]-el2[0]);this.elements=content.map((elem)=>elem[1]);}
return this.elements.slice();}
getEntries(){if(!this.entries){const entries=Object.entries(this.content).sort((el1,el2)=>el1[1][0]-el2[1][0]);this.entries=entries.map(([str,elem])=>[str,elem[1]]);}
return this.entries.slice();}
remove(key){const value=this.content[key];delete this.content[key];const payload={operation:"delete",key,value};this.trigger("UPDATE",payload);}
category(subcategory){if(!(subcategory in this.subRegistries)){this.subRegistries[subcategory]=new Registry();}
return this.subRegistries[subcategory];}}
const registry=__exports.registry=new Registry();return __exports;});;

/* /web/static/src/core/assets.js */
odoo.define('@web/core/assets',['@web/core/utils/functions','@web/core/browser/browser','@web/core/registry','@web/session','@odoo/owl'],function(require){'use strict';let __exports={};const{memoize}=require("@web/core/utils/functions");const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const{session}=require("@web/session");const{Component,xml,onWillStart,App}=require("@odoo/owl");const assets=__exports.assets={retries:{count:3,delay:5000,extraDelay:2500,},};class AssetsLoadingError extends Error{}
assets.loadJS=memoize(function loadJS(url){if(document.querySelector(`script[src="${url}"]`)){return Promise.resolve();}
const scriptEl=document.createElement("script");scriptEl.type="text/javascript";scriptEl.src=url;document.head.appendChild(scriptEl);return new Promise((resolve,reject)=>{scriptEl.addEventListener("load",()=>resolve(true));scriptEl.addEventListener("error",()=>{reject(new AssetsLoadingError(`The loading of ${url} failed`));});});});assets.loadCSS=memoize(function loadCSS(url,retryCount=0){if(document.querySelector(`link[href="${url}"]`)){return Promise.resolve();}
const linkEl=document.createElement("link");linkEl.type="text/css";linkEl.rel="stylesheet";linkEl.href=url;const promise=new Promise((resolve,reject)=>{linkEl.addEventListener("load",()=>resolve(true));linkEl.addEventListener("error",async()=>{if(retryCount<assets.retries.count){await new Promise((resolve)=>setTimeout(resolve,assets.retries.delay+assets.retries.extraDelay*retryCount));linkEl.remove();loadCSS(url,retryCount+1).then(resolve).catch(reject);}else{reject(new AssetsLoadingError(`The loading of ${url} failed`));}});});document.head.appendChild(linkEl);return promise;});assets.getBundle=memoize(async function getBundle(bundleName){const url=new URL(`/web/bundle/${bundleName}`,location.origin);for(const[key,value]of Object.entries(session.bundle_params||{})){url.searchParams.set(key,value);}
const response=await browser.fetch(url.href);const json=await response.json();const assets={cssLibs:[],cssContents:[],jsLibs:[],jsContents:[],};for(const key in json){const file=json[key];if(file.type==="link"){assets.cssLibs.push(file.src);}else if(file.type==="style"){assets.cssContents.push(file.content);}else{if(file.src){assets.jsLibs.push(file.src);}else{assets.jsContents.push(file.content);}}}
return assets;});assets.loadBundle=async function loadBundle(desc){if(typeof desc==="string"){desc=await assets.getBundle(desc);}
const promiseCSS=Promise.all((desc.cssLibs||[]).map(assets.loadCSS)).then(()=>{if(desc.cssContents&&desc.cssContents.length){const style=document.createElement("style");style.textContent=desc.cssContents.join("\n");document.head.appendChild(style);}});for(const urlData of desc.jsLibs||[]){if(typeof urlData==="string"){await assets.loadJS(urlData);}else{await Promise.all(urlData.map(loadJS));}}
if(desc.jsContents&&desc.jsContents.length){const script=document.createElement("script");script.type="text/javascript";script.textContent=desc.jsContents.join("\n");document.head.appendChild(script);}
await promiseCSS;for(const bundleName of desc.assetLibs||[]){if(typeof bundleName==="string"){await assets.loadBundle(bundleName);}else{await Promise.all(bundleName.map(async(bundleName)=>{return assets.loadBundle(bundleName);}));}}
odoo.loader.checkAndReportErrors();};const loadJS=__exports.loadJS=function(url){return assets.loadJS(url);};const loadCSS=__exports.loadCSS=function(url){return assets.loadCSS(url);};const getBundle=__exports.getBundle=function(bundleName){return assets.getBundle(bundleName);};const loadBundle=__exports.loadBundle=function(desc){return assets.loadBundle(desc);};const templates=__exports.templates=new DOMParser().parseFromString("<odoo/>","text/xml");registry.category("xml_templates").addEventListener("UPDATE",(ev)=>{const{operation,value}=ev.detail;if(operation==="add"){const doc=new DOMParser().parseFromString(value,"text/xml");if(doc.querySelector("parsererror")){let strError="";const nodes=doc.querySelectorAll("parsererror");for(const node of nodes){strError+=node.textContent.trim()+"\n";}
throw new Error(strError);}
for(const element of doc.querySelectorAll("templates > [t-name]")){templates.documentElement.appendChild(element);}
for(const app of App.apps){app.addTemplates(templates,app);}}});const LazyComponent=__exports.LazyComponent=class LazyComponent extends Component{setup(){onWillStart(async()=>{await loadBundle(this.props.bundle);this.Component=registry.category("lazy_components").get(this.props.Component);});}}
LazyComponent.template=xml`<t t-component="Component" t-props="props.props"/>`;LazyComponent.props={Component:String,bundle:String,props:{type:Object,optional:true},};return __exports;});;

/* /web/static/src/env.js */
odoo.define('@web/env',['@web/core/registry','@web/core/assets','@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{templates}=require("@web/core/assets");const{App,EventBus}=require("@odoo/owl");const{_t}=require("@web/core/l10n/translation");__exports.makeEnv=makeEnv;function makeEnv(){return{bus:new EventBus(),services:{},debug:odoo.debug,get isSmall(){throw new Error("UI service not initialized!");},};}
const serviceRegistry=registry.category("services");const SERVICES_METADATA=__exports.SERVICES_METADATA={};let startServicesPromise=null;__exports.startServices=startServices;async function startServices(env){await Promise.resolve();const toStart=new Set();serviceRegistry.addEventListener("UPDATE",async(ev)=>{await Promise.resolve();const{operation,key:name,value:service}=ev.detail;if(operation==="delete"){return;}
if(toStart.size){const namedService=Object.assign(Object.create(service),{name});toStart.add(namedService);}else{await _startServices(env,toStart);}});await _startServices(env,toStart);}
async function _startServices(env,toStart){if(startServicesPromise){return startServicesPromise.then(()=>_startServices(env,toStart));}
const services=env.services;for(const[name,service]of serviceRegistry.getEntries()){if(!(name in services)){const namedService=Object.assign(Object.create(service),{name});toStart.add(namedService);}}
async function start(){let service=null;const proms=[];while((service=findNext())){const name=service.name;toStart.delete(service);const entries=(service.dependencies||[]).map((dep)=>[dep,services[dep]]);const dependencies=Object.fromEntries(entries);let value;try{value=service.start(env,dependencies);}catch(e){value=e;console.error(e);}
if("async"in service){SERVICES_METADATA[name]=service.async;}
if(value instanceof Promise){proms.push(new Promise((resolve)=>{value.then((val)=>{services[name]=val||null;}).catch((error)=>{services[name]=error;console.error("Can't load service '"+name+"' because:",error);}).finally(resolve);}));}else{services[service.name]=value||null;}}
await Promise.all(proms);if(proms.length){return start();}}
startServicesPromise=start();await startServicesPromise;startServicesPromise=null;if(toStart.size){const names=[...toStart].map((s)=>s.name);const missingDeps=new Set();[...toStart].forEach((s)=>s.dependencies.forEach((dep)=>{if(!(dep in services)&&!names.includes(dep)){missingDeps.add(dep);}}));const depNames=[...missingDeps].join(", ");throw new Error(`Some services could not be started: ${names}. Missing dependencies: ${depNames}`);}
function findNext(){for(const s of toStart){if(s.dependencies){if(s.dependencies.every((d)=>d in services)){return s;}}else{return s;}}
return null;}}
__exports.mountComponent=mountComponent;async function mountComponent(component,target,appConfig={}){let{env}=appConfig;const isRoot=!env;if(isRoot){env=await makeEnv();await startServices(env);}
const app=new App(component,{env,templates,dev:env.debug,warnIfNoStaticProps:true,name:component.constructor.name,translatableAttributes:["data-tooltip"],translateFn:_t,...appConfig,});const root=await app.mount(target);if(isRoot){odoo.__WOWL_DEBUG__={root};}
return app;}
return __exports;});;

/* /web/static/src/core/network/http_service.js */
odoo.define('@web/core/network/http_service',['@web/core/browser/browser','@web/core/registry'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");function checkResponseStatus(response){if(response.status===502){throw new Error("Failed to fetch");}}
__exports.get=get;async function get(route,readMethod="json"){const response=await browser.fetch(route,{method:"GET"});checkResponseStatus(response);return response[readMethod]();}
__exports.post=post;async function post(route,params={},readMethod="json"){let formData=params;if(!(formData instanceof FormData)){formData=new FormData();for(const key in params){const value=params[key];if(Array.isArray(value)&&value.length){for(const val of value){formData.append(key,val);}}else{formData.append(key,value);}}}
const response=await browser.fetch(route,{body:formData,method:"POST",});checkResponseStatus(response);return response[readMethod]();}
const httpService=__exports.httpService={start(){return{get,post};},};registry.category("services").add("http",httpService);return __exports;});;

/* /web/static/src/core/network/rpc_service.js */
odoo.define('@web/core/network/rpc_service',['@web/core/browser/browser','@web/core/registry'],function(require){'use strict';let __exports={};const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const RPCError=__exports.RPCError=class RPCError extends Error{constructor(){super(...arguments);this.name="RPC_ERROR";this.type="server";this.code=null;this.data=null;this.exceptionName=null;this.subType=null;}}
const ConnectionLostError=__exports.ConnectionLostError=class ConnectionLostError extends Error{constructor(url,...args){super(`Connection to "${url}" couldn't be established or was interrupted`,...args);this.url=url;}}
const ConnectionAbortedError=__exports.ConnectionAbortedError=class ConnectionAbortedError extends Error{}
__exports.makeErrorFromResponse=makeErrorFromResponse;function makeErrorFromResponse(reponse){const{code,data:errorData,message,type:subType}=reponse;const error=new RPCError();error.exceptionName=errorData.name;error.subType=subType;error.data=errorData;error.message=message;error.code=code;return error;}
let rpcId=0;__exports.jsonrpc=jsonrpc;function jsonrpc(url,params={},settings={}){const bus=settings.bus;const XHR=browser.XMLHttpRequest;const data={id:rpcId++,jsonrpc:"2.0",method:"call",params:params,};const request=settings.xhr||new XHR();let rejectFn;const promise=new Promise((resolve,reject)=>{rejectFn=reject;bus?.trigger("RPC:REQUEST",{data,url,settings});request.addEventListener("load",()=>{if(request.status===502){const error=new ConnectionLostError(url);bus?.trigger("RPC:RESPONSE",{data,settings,error});reject(error);return;}
let params;try{params=JSON.parse(request.response);}catch{const error=new ConnectionLostError(url);bus?.trigger("RPC:RESPONSE",{data,settings,error});return reject(error);}
const{error:responseError,result:responseResult}=params;if(!params.error){bus?.trigger("RPC:RESPONSE",{data,settings,result:params.result});return resolve(responseResult);}
const error=makeErrorFromResponse(responseError);bus?.trigger("RPC:RESPONSE",{data,settings,error});reject(error);});request.addEventListener("error",()=>{const error=new ConnectionLostError(url);bus?.trigger("RPC:RESPONSE",{data,settings,error});reject(error);});request.open("POST",url);request.setRequestHeader("Content-Type","application/json");request.send(JSON.stringify(data));});promise.abort=function(rejectError=true){if(request.abort){request.abort();}
const error=new ConnectionAbortedError("XmlHttpRequestError abort");bus?.trigger("RPC:RESPONSE",{data,settings,error});if(rejectError){rejectFn(error);}};return promise;}
const rpcService=__exports.rpcService={async:true,start(env){return function rpc(route,params={},settings={}){return jsonrpc(route,params,{bus:env.bus,...settings});};},};registry.category("services").add("rpc",rpcService);return __exports;});;

/* /web/static/src/core/user_service.js */
odoo.define('@web/core/user_service',['@web/core/registry','@web/session','@web/core/utils/cache'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{session}=require("@web/session");const{Cache}=require("@web/core/utils/cache");const userService=__exports.userService={dependencies:["rpc"],async:["hasGroup"],start(env,{rpc}){const groupCache=new Cache((group)=>{if(!context.uid){return Promise.resolve(false);}
return rpc("/web/dataset/call_kw/res.users/has_group",{model:"res.users",method:"has_group",args:[group],kwargs:{context},});});groupCache.cache["base.group_user"]=session.is_internal_user;groupCache.cache["base.group_system"]=session.is_system;const accessRightCache=new Cache((model,operation)=>{const url=`/web/dataset/call_kw/${model}/check_access_rights`;return rpc(url,{model,method:"check_access_rights",args:[operation,false],kwargs:{context},});});const context={...session.user_context,uid:session.uid,};let settings=session.user_settings;delete session.user_settings;return{get context(){return Object.assign({},context);},removeFromContext(key){delete context[key];},updateContext(update){Object.assign(context,update);},hasGroup(group){return groupCache.read(group);},async checkAccessRight(model,operation){return accessRightCache.read(model,operation);},get settings(){return settings;},async setUserSettings(key,value){const changedSettings=await env.services.orm.call("res.users.settings","set_res_users_settings",[[this.settings.id]],{new_settings:{[key]:value,},});Object.assign(settings,changedSettings);},name:session.name,userName:session.username,isAdmin:session.is_admin,isSystem:session.is_system,partnerId:session.partner_id,home_action_id:session.home_action_id,showEffect:session.show_effect,get userId(){return context.uid;},get lang(){return context.lang;},get tz(){return context.tz;},get db(){const res={name:session.db,};if("dbuuid"in session){res.uuid=session.dbuuid;}
return res;},};},};registry.category("services").add("user",userService);return __exports;});;

/* /web/static/src/core/l10n/dates.js */
odoo.define('@web/core/l10n/dates',['@web/core/l10n/localization','@web/core/l10n/translation','@web/core/utils/functions','@web/core/utils/arrays'],function(require){'use strict';let __exports={};const{localization}=require("@web/core/l10n/localization");const{_t}=require("@web/core/l10n/translation");const{memoize}=require("@web/core/utils/functions");const{ensureArray}=require("@web/core/utils/arrays");const{DateTime,Settings}=luxon;const MIN_VALID_DATE=__exports.MIN_VALID_DATE=DateTime.fromObject({year:1000});const MAX_VALID_DATE=__exports.MAX_VALID_DATE=DateTime.fromObject({year:9999}).endOf("year");const SERVER_DATE_FORMAT="yyyy-MM-dd";const SERVER_TIME_FORMAT="HH:mm:ss";const SERVER_DATETIME_FORMAT=`${SERVER_DATE_FORMAT} ${SERVER_TIME_FORMAT}`;const nonAlphaRegex=/[^a-z]/gi;const nonDigitRegex=/[^\d]/g;const normalizeFormatTable={a:"ccc",A:"cccc",b:"MMM",B:"MMMM",d:"dd",H:"HH",I:"hh",j:"o",m:"MM",M:"mm",p:"a",S:"ss",W:"WW",w:"c",y:"yy",Y:"yyyy",c:"ccc MMM d HH:mm:ss yyyy",x:"MM/dd/yy",X:"HH:mm:ss",};const smartDateUnits={d:"days",m:"months",w:"weeks",y:"years",};const smartDateRegex=new RegExp(["^","([+-])","(\\d+)",`([${Object.keys(smartDateUnits).join("")}]?)`,"$"].join("\\s*"),"i");const dateCache=new WeakMap();const dateTimeCache=new WeakMap();const ConversionError=__exports.ConversionError=class ConversionError extends Error{name="ConversionError";}
__exports.areDatesEqual=areDatesEqual;function areDatesEqual(d1,d2){if(Array.isArray(d1)||Array.isArray(d2)){d1=ensureArray(d1);d2=ensureArray(d2);return d1.length===d2.length&&d1.every((d1Val,i)=>areDatesEqual(d1Val,d2[i]));}
if(d1 instanceof DateTime&&d2 instanceof DateTime&&d1!==d2){return d1.equals(d2);}else{return d1===d2;}}
__exports.clampDate=clampDate;function clampDate(desired,minDate,maxDate){if(maxDate<desired){return maxDate;}
if(minDate>desired){return minDate;}
return desired;}
__exports.is24HourFormat=is24HourFormat;function is24HourFormat(format){return/H/.test(format||localization.timeFormat);}
__exports.isInRange=isInRange;function isInRange(value,range){if(!value||!range){return false;}
if(Array.isArray(value)){const actualValues=value.filter(Boolean);if(actualValues.length<2){return isInRange(actualValues[0],range);}
return((value[0]<=range[0]&&range[0]<=value[1])||(range[0]<=value[0]&&value[0]<=range[1]));}else{return range[0]<=value&&value<=range[1];}}
__exports.isMeridiemFormat=isMeridiemFormat;function isMeridiemFormat(format){return/a/.test(format||localization.timeFormat);}
function isValidDate(date){return date&&date.isValid&&isInRange(date,[MIN_VALID_DATE,MAX_VALID_DATE]);}
function parseSmartDateInput(value){const match=value.match(smartDateRegex);if(match){let date=DateTime.local();const offset=parseInt(match[2],10);const unit=smartDateUnits[(match[3]||"d").toLowerCase()];if(match[1]==="+"){date=date.plus({[unit]:offset});}else{date=date.minus({[unit]:offset});}
return date;}
return false;}
const stripAlphaDupes=memoize(function stripAlphaDupes(str){return str.replace(/[a-z]/gi,(letter,index,str)=>letter===str[index-1]?"":letter);});const strftimeToLuxonFormat=__exports.strftimeToLuxonFormat=memoize(function strftimeToLuxonFormat(format){const output=[];let inToken=false;for(let index=0;index<format.length;++index){let character=format[index];if(character==="%"&&!inToken){inToken=true;continue;}
if(/[a-z]/gi.test(character)){if(inToken&&normalizeFormatTable[character]!==undefined){character=normalizeFormatTable[character];}else{character=`'${character}'`;}}
output.push(character);inToken=false;}
return output.join("");});__exports.today=today;function today(){return DateTime.local().startOf("day");}
__exports.formatDate=formatDate;function formatDate(value,options={}){if(!value){return"";}
const format=options.format||localization.dateFormat;return value.toFormat(format);}
__exports.formatDateTime=formatDateTime;function formatDateTime(value,options={}){if(!value){return"";}
const format=options.format||localization.dateTimeFormat;return value.setZone("default").toFormat(format);}
__exports.formatDuration=formatDuration;function formatDuration(seconds,showFullDuration){const displayStyle=showFullDuration?"long":"narrow";const numberOfValuesToDisplay=showFullDuration?2:1;const durationKeys=["years","months","days","hours","minutes"];if(seconds<60){seconds=60;}
seconds-=seconds%60;let duration=luxon.Duration.fromObject({seconds:seconds}).shiftTo(...durationKeys);duration=duration.shiftTo(...durationKeys.filter((key)=>duration.get(key)));const durationSplit=duration.toHuman({unitDisplay:displayStyle}).split(",");if(!showFullDuration&&duration.loc.locale.includes("en")&&duration.months>0){durationSplit[0]=durationSplit[0].replace("m","M");}
return durationSplit.slice(0,numberOfValuesToDisplay).join(",");}
__exports.serializeDate=serializeDate;function serializeDate(value){if(!dateCache.has(value)){dateCache.set(value,value.toFormat(SERVER_DATE_FORMAT,{numberingSystem:"latn"}));}
return dateCache.get(value);}
__exports.serializeDateTime=serializeDateTime;function serializeDateTime(value){if(!dateTimeCache.has(value)){dateTimeCache.set(value,value.setZone("utc").toFormat(SERVER_DATETIME_FORMAT,{numberingSystem:"latn"}));}
return dateTimeCache.get(value);}
__exports.parseDate=parseDate;function parseDate(value,options={}){const parsed=parseDateTime(value,{...options,format:options.format||localization.dateFormat});return parsed&&parsed.startOf("day");}
__exports.parseDateTime=parseDateTime;function parseDateTime(value,options={}){if(!value){return false;}
const fmt=options.format||localization.dateTimeFormat;const parseOpts={setZone:true,zone:"default",};const switchToLatin=Settings.defaultNumberingSystem!=="latn"&&/[0-9]/.test(value);if(switchToLatin){parseOpts.numberingSystem="latn";}
let result=DateTime.fromFormat(value,fmt,parseOpts);if(!isValidDate(result)){result=parseSmartDateInput(value);}
if(!isValidDate(result)){const fmtWoZero=stripAlphaDupes(fmt);result=DateTime.fromFormat(value,fmtWoZero,parseOpts);}
if(!isValidDate(result)){const digitList=value.split(nonDigitRegex).filter(Boolean);const fmtList=fmt.split(nonAlphaRegex).filter(Boolean);const valWoSeps=digitList.join("");let carry=0;const fmtWoSeps=fmtList.map((part,i)=>{const digitLength=(digitList[i]||"").length;const actualPart=part.slice(0,digitLength+carry);carry+=digitLength-actualPart.length;return actualPart;}).join("");result=DateTime.fromFormat(valWoSeps,fmtWoSeps,parseOpts);}
if(!isValidDate(result)){const valueDigits=value.replace(nonDigitRegex,"");if(valueDigits.length>4){result=DateTime.fromISO(value,parseOpts);if(!isValidDate(result)){result=DateTime.fromSQL(value,parseOpts);}}}
if(!isValidDate(result)){throw new ConversionError(_t("'%s' is not a correct date or datetime",value));}
if(switchToLatin){result=result.reconfigure({numberingSystem:Settings.defaultNumberingSystem,});}
return result.setZone("default");}
__exports.deserializeDate=deserializeDate;function deserializeDate(value){return DateTime.fromSQL(value,{numberingSystem:"latn",zone:"default"}).reconfigure({numberingSystem:Settings.defaultNumberingSystem,});}
__exports.deserializeDateTime=deserializeDateTime;function deserializeDateTime(value){return DateTime.fromSQL(value,{numberingSystem:"latn",zone:"utc"}).setZone("default").reconfigure({numberingSystem:Settings.defaultNumberingSystem,});}
return __exports;});;

/* /web/static/src/core/l10n/localization.js */
odoo.define('@web/core/l10n/localization',[],function(require){'use strict';let __exports={};const notReadyError=new Error("Localization parameters not ready yet. Maybe add 'localization' to your dependencies?");const localization=__exports.localization={dateFormat:notReadyError,dateTimeFormat:notReadyError,timeFormat:notReadyError,decimalPoint:notReadyError,direction:notReadyError,grouping:notReadyError,multiLang:notReadyError,thousandsSep:notReadyError,weekStart:notReadyError,code:notReadyError,};return __exports;});;

/* /web/static/src/core/l10n/localization_service.js */
odoo.define('@web/core/l10n/localization_service',['@web/session','@web/core/browser/browser','@web/core/registry','@web/core/l10n/dates','@web/core/l10n/localization','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{session}=require("@web/session");const{browser}=require("@web/core/browser/browser");const{registry}=require("@web/core/registry");const{strftimeToLuxonFormat}=require("@web/core/l10n/dates");const{localization}=require("@web/core/l10n/localization");const{translatedTerms,translationLoaded,translationIsReady}=require("@web/core/l10n/translation");const{Settings}=luxon;const NUMBERING_SYSTEMS=[[/^ar-(sa|sy|001)$/i,"arab"],[/^bn/i,"beng"],[/^bo/i,"tibt"],[/^pa-in/i,"guru"],[/^ta/i,"tamldec"],[/.*/i,"latn"],];const localizationService=__exports.localizationService={dependencies:["user"],start:async(env,{user})=>{const cacheHashes=session.cache_hashes||{};const translationsHash=cacheHashes.translations||new Date().getTime().toString();const lang=user.lang||document.documentElement.getAttribute("lang")?.replace(/-/g,"_");const translationURL=session.translationURL||"/web/webclient/translations";let url=`${translationURL}/${translationsHash}`;if(lang){url+=`?lang=${lang}`;}
const response=await browser.fetch(url);if(!response.ok){throw new Error("Error while fetching translations");}
const{lang_parameters:userLocalization,modules:modules,multi_lang:multiLang,}=await response.json();const terms={};for(const addon of Object.keys(modules)){for(const message of modules[addon].messages){terms[message.id]=message.string;}}
Object.assign(translatedTerms,terms);translatedTerms[translationLoaded]=true;translationIsReady.resolve(true);const language=lang||browser.navigator.language;const locale=language==="sr@latin"?"sr-Latn-RS":language.replace(/_/g,"-");Settings.defaultLocale=locale;for(const[re,numberingSystem]of NUMBERING_SYSTEMS){if(re.test(locale)){Settings.defaultNumberingSystem=numberingSystem;break;}}
const dateFormat=strftimeToLuxonFormat(userLocalization.date_format);const timeFormat=strftimeToLuxonFormat(userLocalization.time_format);const dateTimeFormat=`${dateFormat} ${timeFormat}`;const grouping=JSON.parse(userLocalization.grouping);Object.assign(localization,{dateFormat,timeFormat,dateTimeFormat,decimalPoint:userLocalization.decimal_point,direction:userLocalization.direction,grouping,multiLang,thousandsSep:userLocalization.thousands_sep,weekStart:userLocalization.week_start,code:language,});return localization;},};registry.category("services").add("localization",localizationService);return __exports;});;

/* /web/static/src/core/l10n/translation.js */
odoo.define('@web/core/l10n/translation',['@web/core/utils/concurrency','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{Deferred}=require("@web/core/utils/concurrency");const{sprintf}=require("@web/core/utils/strings");const translationLoaded=__exports.translationLoaded=Symbol("translationLoaded");const translatedTerms=__exports.translatedTerms={[translationLoaded]:false,};const translationIsReady=__exports.translationIsReady=new Deferred();__exports._t=_t;function _t(term,...values){if(translatedTerms[translationLoaded]){const translation=translatedTerms[term]??term;if(values.length===0){return translation;}
return sprintf(translation,...values);}else{return new LazyTranslatedString(term,...values);}}
const _lt=__exports._lt=(term,...values)=>_t(term,...values);class LazyTranslatedString extends String{constructor(term,...values){super(term);this.values=values;}
valueOf(){const term=super.valueOf();if(translatedTerms[translationLoaded]){const translation=translatedTerms[term]??term;if(this.values.length===0){return translation;}
return sprintf(translation,...this.values);}else{throw new Error(`translation error`);}}
toString(){return this.valueOf();}}
_t("less than a minute ago");_t("about a minute ago");_t("%d minutes ago");_t("about an hour ago");_t("%d hours ago");_t("a day ago");_t("%d days ago");_t("about a month ago");_t("%d months ago");_t("about a year ago");_t("%d years ago");__exports.loadLanguages=loadLanguages;async function loadLanguages(orm){if(!loadLanguages.installedLanguages){loadLanguages.installedLanguages=await orm.call("res.lang","get_installed");}
return loadLanguages.installedLanguages;}
return __exports;});;

/* /web/static/src/core/network/download.js */
odoo.define('@web/core/network/download',['@web/core/l10n/translation','@web/core/network/rpc_service','@web/core/browser/browser'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{makeErrorFromResponse,ConnectionLostError}=require("@web/core/network/rpc_service");const{browser}=require("@web/core/browser/browser");const HEX_ESCAPE_REPLACE_REGEXP=/%([0-9A-Fa-f]{2})/g;const NON_LATIN1_REGEXP=/[^\x20-\x7e\xa0-\xff]/g;const QESC_REGEXP=/\\([\u0000-\u007f])/g;const PARAM_REGEXP=/;[\x09\x20]*([!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*=[\x09\x20]*("(?:[\x20!\x23-\x5b\x5d-\x7e\x80-\xff]|\\[\x20-\x7e])*"|[!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*/g;const EXT_VALUE_REGEXP=/^([A-Za-z0-9!#$%&+\-^_`{}~]+)'(?:[A-Za-z]{2,3}(?:-[A-Za-z]{3}){0,3}|[A-Za-z]{4,8}|)'((?:%[0-9A-Fa-f]{2}|[A-Za-z0-9!#$&+.^_`|~-])+)$/;const DISPOSITION_TYPE_REGEXP=/^([!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*(?:$|;)/;function decodefield(str){const match=EXT_VALUE_REGEXP.exec(str);if(!match){throw new TypeError("invalid extended field value");}
const charset=match[1].toLowerCase();const encoded=match[2];switch(charset){case"iso-8859-1":return encoded.replace(HEX_ESCAPE_REPLACE_REGEXP,pdecode).replace(NON_LATIN1_REGEXP,"?");case"utf-8":return decodeURIComponent(encoded);default:throw new TypeError("unsupported charset in extended field");}}
function parse(string){if(!string||typeof string!=="string"){throw new TypeError("argument string is required");}
let match=DISPOSITION_TYPE_REGEXP.exec(string);if(!match){throw new TypeError("invalid type format");}
let index=match[0].length;const type=match[1].toLowerCase();let key;const names=[];const params={};let value;index=PARAM_REGEXP.lastIndex=match[0].substr(-1)===";"?index-1:index;while((match=PARAM_REGEXP.exec(string))){if(match.index!==index){throw new TypeError("invalid parameter format");}
index+=match[0].length;key=match[1].toLowerCase();value=match[2];if(names.indexOf(key)!==-1){throw new TypeError("invalid duplicate parameter");}
names.push(key);if(key.indexOf("*")+1===key.length){key=key.slice(0,-1);value=decodefield(value);params[key]=value;continue;}
if(typeof params[key]==="string"){continue;}
if(value[0]==='"'){value=value.substr(1,value.length-2).replace(QESC_REGEXP,"$1");}
params[key]=value;}
if(index!==-1&&index!==string.length){throw new TypeError("invalid parameter format");}
return new ContentDisposition(type,params);}
function pdecode(str,hex){return String.fromCharCode(parseInt(hex,16));}
function ContentDisposition(type,parameters){this.type=type;this.parameters=parameters;}
function _download(data,filename,mimetype){let self=window,defaultMime="application/octet-stream",mimeType=mimetype||defaultMime,payload=data,url=!filename&&!mimetype&&payload,anchor=document.createElement("a"),toString=function(a){return String(a);},myBlob=self.Blob||self.MozBlob||self.WebKitBlob||toString,fileName=filename||"download",blob,reader;myBlob=myBlob.call?myBlob.bind(self):Blob;if(String(this)==="true"){payload=[payload,mimeType];mimeType=payload[0];payload=payload[1];}
if(url&&url.length<2048){fileName=url.split("/").pop().split("?")[0];anchor.href=url;if(anchor.href.indexOf(url)!==-1){return new Promise((resolve,reject)=>{let xhr=new browser.XMLHttpRequest();xhr.open("GET",url,true);configureBlobDownloadXHR(xhr,{onSuccess:resolve,onFailure:reject,url});xhr.send();});}}
if(/^data:[\w+\-]+\/[\w+\-]+[,;]/.test(payload)){if(payload.length>1024*1024*1.999&&myBlob!==toString){payload=dataUrlToBlob(payload);mimeType=payload.type||defaultMime;}else{return navigator.msSaveBlob?navigator.msSaveBlob(dataUrlToBlob(payload),fileName):saver(payload);}}
blob=payload instanceof myBlob?payload:new myBlob([payload],{type:mimeType});function dataUrlToBlob(strUrl){let parts=strUrl.split(/[:;,]/),type=parts[1],decoder=parts[2]==="base64"?atob:decodeURIComponent,binData=decoder(parts.pop()),mx=binData.length,i=0,uiArr=new Uint8Array(mx);for(i;i<mx;++i){uiArr[i]=binData.charCodeAt(i);}
return new myBlob([uiArr],{type});}
function saver(url,winMode){if("download"in anchor){anchor.href=url;anchor.setAttribute("download",fileName);anchor.className="download-js-link";anchor.innerText=_t("downloading...");anchor.style.display="none";document.body.appendChild(anchor);setTimeout(()=>{anchor.click();document.body.removeChild(anchor);if(winMode===true){setTimeout(()=>{self.URL.revokeObjectURL(anchor.href);},250);}},66);return true;}
if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent)){url=url.replace(/^data:([\w\/\-+]+)/,defaultMime);if(!window.open(url)){if(confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")){location.href=url;}}
return true;}
let f=document.createElement("iframe");document.body.appendChild(f);if(!winMode){url=`data:${url.replace(/^data:([\w\/\-+]+)/, defaultMime)}`;}
f.src=url;setTimeout(()=>{document.body.removeChild(f);},333);}
if(navigator.msSaveBlob){return navigator.msSaveBlob(blob,fileName);}
if(self.URL){saver(self.URL.createObjectURL(blob),true);}else{if(typeof blob==="string"||blob.constructor===toString){try{return saver(`data:${mimeType};base64,${self.btoa(blob)}`);}catch{return saver(`data:${mimeType},${encodeURIComponent(blob)}`);}}
reader=new FileReader();reader.onload=function(){saver(this.result);};reader.readAsDataURL(blob);}
return true;}
__exports.downloadFile=downloadFile;function downloadFile(data,filename,mimetype){return downloadFile._download(data,filename,mimetype)}
downloadFile._download=_download;__exports.download=download;function download(options){return download._download(options);}
download._download=(options)=>{return new Promise((resolve,reject)=>{const xhr=new browser.XMLHttpRequest();let data;if(Object.prototype.hasOwnProperty.call(options,"form")){xhr.open(options.form.method,options.form.action);data=new FormData(options.form);}else{xhr.open("POST",options.url);data=new FormData();Object.entries(options.data).forEach((entry)=>{const[key,value]=entry;data.append(key,value);});}
data.append("token","dummy-because-api-expects-one");if(odoo.csrf_token){data.append("csrf_token",odoo.csrf_token);}
configureBlobDownloadXHR(xhr,{onSuccess:resolve,onFailure:reject,url:options.url,});xhr.send(data);});};__exports.configureBlobDownloadXHR=configureBlobDownloadXHR;function configureBlobDownloadXHR(xhr,{onSuccess=()=>{},onFailure=()=>{},url}={}){xhr.responseType="blob";xhr.onload=()=>{const mimetype=xhr.response.type;const header=(xhr.getResponseHeader("Content-Disposition")||"").replace(/;$/,"");const filename=header?parse(header).parameters.filename:null;if(xhr.status===200&&(mimetype!=="text/html"||filename)){_download(xhr.response,filename,mimetype);onSuccess(filename);}else if(xhr.status===502){onFailure(new ConnectionLostError(url));}else{const decoder=new FileReader();decoder.onload=()=>{const contents=decoder.result;const doc=new DOMParser().parseFromString(contents,"text/html");const nodes=doc.body.children.length===0?[doc.body]:doc.body.children;let error;try{const node=nodes[1]||nodes[0];error=JSON.parse(node.textContent);}catch{error={message:"Arbitrary Uncaught Python Exception",data:{debug:`${xhr.status}`+`\n`+`${nodes.length > 0 ? nodes[0].textContent : ""}
                                ${nodes.length > 1 ? nodes[1].textContent : ""}`,},};}
error=makeErrorFromResponse(error);onFailure(error);};decoder.readAsText(xhr.response);}};xhr.onerror=()=>{onFailure(new ConnectionLostError(url));};}
return __exports;});;

/* /web/static/lib/Chart/Chart.js */
(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Chart=factory());})(this,(function(){'use strict';var plugins=Object.freeze({__proto__:null,get Colors(){return plugin_colors;},get Decimation(){return plugin_decimation;},get Filler(){return index;},get Legend(){return plugin_legend;},get SubTitle(){return plugin_subtitle;},get Title(){return plugin_title;},get Tooltip(){return plugin_tooltip;}});function noop(){}
const uid=(()=>{let id=0;return()=>id++;})();function isNullOrUndef(value){return value===null||typeof value==='undefined';}
function isArray(value){if(Array.isArray&&Array.isArray(value)){return true;}
const type=Object.prototype.toString.call(value);if(type.slice(0,7)==='[object'&&type.slice(-6)==='Array]'){return true;}
return false;}
function isObject(value){return value!==null&&Object.prototype.toString.call(value)==='[object Object]';}
function isNumberFinite(value){return(typeof value==='number'||value instanceof Number)&&isFinite(+value);}
function finiteOrDefault(value,defaultValue){return isNumberFinite(value)?value:defaultValue;}
function valueOrDefault(value,defaultValue){return typeof value==='undefined'?defaultValue:value;}
const toPercentage=(value,dimension)=>typeof value==='string'&&value.endsWith('%')?parseFloat(value)/100:+value/dimension;const toDimension=(value,dimension)=>typeof value==='string'&&value.endsWith('%')?parseFloat(value)/100*dimension:+value;function callback(fn,args,thisArg){if(fn&&typeof fn.call==='function'){return fn.apply(thisArg,args);}}
function each(loopable,fn,thisArg,reverse){let i,len,keys;if(isArray(loopable)){len=loopable.length;if(reverse){for(i=len-1;i>=0;i--){fn.call(thisArg,loopable[i],i);}}else{for(i=0;i<len;i++){fn.call(thisArg,loopable[i],i);}}}else if(isObject(loopable)){keys=Object.keys(loopable);len=keys.length;for(i=0;i<len;i++){fn.call(thisArg,loopable[keys[i]],keys[i]);}}}
function _elementsEqual(a0,a1){let i,ilen,v0,v1;if(!a0||!a1||a0.length!==a1.length){return false;}
for(i=0,ilen=a0.length;i<ilen;++i){v0=a0[i];v1=a1[i];if(v0.datasetIndex!==v1.datasetIndex||v0.index!==v1.index){return false;}}
return true;}
function clone$1(source){if(isArray(source)){return source.map(clone$1);}
if(isObject(source)){const target=Object.create(null);const keys=Object.keys(source);const klen=keys.length;let k=0;for(;k<klen;++k){target[keys[k]]=clone$1(source[keys[k]]);}
return target;}
return source;}
function isValidKey(key){return['__proto__','prototype','constructor'].indexOf(key)===-1;}
function _merger(key,target,source,options){if(!isValidKey(key)){return;}
const tval=target[key];const sval=source[key];if(isObject(tval)&&isObject(sval)){merge(tval,sval,options);}else{target[key]=clone$1(sval);}}
function merge(target,source,options){const sources=isArray(source)?source:[source];const ilen=sources.length;if(!isObject(target)){return target;}
options=options||{};const merger=options.merger||_merger;let current;for(let i=0;i<ilen;++i){current=sources[i];if(!isObject(current)){continue;}
const keys=Object.keys(current);for(let k=0,klen=keys.length;k<klen;++k){merger(keys[k],target,current,options);}}
return target;}
function mergeIf(target,source){return merge(target,source,{merger:_mergerIf});}
function _mergerIf(key,target,source){if(!isValidKey(key)){return;}
const tval=target[key];const sval=source[key];if(isObject(tval)&&isObject(sval)){mergeIf(tval,sval);}else if(!Object.prototype.hasOwnProperty.call(target,key)){target[key]=clone$1(sval);}}
function _deprecated(scope,value,previous,current){if(value!==undefined){console.warn(scope+': "'+previous+'" is deprecated. Please use "'+current+'" instead');}}
const keyResolvers={'':(v)=>v,x:(o)=>o.x,y:(o)=>o.y};function _splitKey(key){const parts=key.split('.');const keys=[];let tmp='';for(const part of parts){tmp+=part;if(tmp.endsWith('\\')){tmp=tmp.slice(0,-1)+'.';}else{keys.push(tmp);tmp='';}}
return keys;}
function _getKeyResolver(key){const keys=_splitKey(key);return(obj)=>{for(const k of keys){if(k===''){break;}
obj=obj&&obj[k];}
return obj;};}
function resolveObjectKey(obj,key){const resolver=keyResolvers[key]||(keyResolvers[key]=_getKeyResolver(key));return resolver(obj);}
function _capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}
const defined=(value)=>typeof value!=='undefined';const isFunction=(value)=>typeof value==='function';const setsEqual=(a,b)=>{if(a.size!==b.size){return false;}
for(const item of a){if(!b.has(item)){return false;}}
return true;};function _isClickEvent(e){return e.type==='mouseup'||e.type==='click'||e.type==='contextmenu';}
const PI=Math.PI;const TAU=2*PI;const PITAU=TAU+PI;const INFINITY=Number.POSITIVE_INFINITY;const RAD_PER_DEG=PI/180;const HALF_PI=PI/2;const QUARTER_PI=PI/4;const TWO_THIRDS_PI=PI*2/3;const log10=Math.log10;const sign=Math.sign;function almostEquals(x,y,epsilon){return Math.abs(x-y)<epsilon;}
function niceNum(range){const roundedRange=Math.round(range);range=almostEquals(range,roundedRange,range/1000)?roundedRange:range;const niceRange=Math.pow(10,Math.floor(log10(range)));const fraction=range/niceRange;const niceFraction=fraction<=1?1:fraction<=2?2:fraction<=5?5:10;return niceFraction*niceRange;}
function _factorize(value){const result=[];const sqrt=Math.sqrt(value);let i;for(i=1;i<sqrt;i++){if(value%i===0){result.push(i);result.push(value/i);}}
if(sqrt===(sqrt|0)){result.push(sqrt);}
result.sort((a,b)=>a-b).pop();return result;}
function isNumber(n){return!isNaN(parseFloat(n))&&isFinite(n);}
function almostWhole(x,epsilon){const rounded=Math.round(x);return rounded-epsilon<=x&&rounded+epsilon>=x;}
function _setMinAndMaxByKey(array,target,property){let i,ilen,value;for(i=0,ilen=array.length;i<ilen;i++){value=array[i][property];if(!isNaN(value)){target.min=Math.min(target.min,value);target.max=Math.max(target.max,value);}}}
function toRadians(degrees){return degrees*(PI/180);}
function toDegrees(radians){return radians*(180/PI);}
function _decimalPlaces(x){if(!isNumberFinite(x)){return;}
let e=1;let p=0;while(Math.round(x*e)/e!==x){e*=10;p++;}
return p;}
function getAngleFromPoint(centrePoint,anglePoint){const distanceFromXCenter=anglePoint.x-centrePoint.x;const distanceFromYCenter=anglePoint.y-centrePoint.y;const radialDistanceFromCenter=Math.sqrt(distanceFromXCenter*distanceFromXCenter+distanceFromYCenter*distanceFromYCenter);let angle=Math.atan2(distanceFromYCenter,distanceFromXCenter);if(angle<-0.5*PI){angle+=TAU;}
return{angle,distance:radialDistanceFromCenter};}
function distanceBetweenPoints(pt1,pt2){return Math.sqrt(Math.pow(pt2.x-pt1.x,2)+Math.pow(pt2.y-pt1.y,2));}
function _angleDiff(a,b){return(a-b+PITAU)%TAU-PI;}
function _normalizeAngle(a){return(a%TAU+TAU)%TAU;}
function _angleBetween(angle,start,end,sameAngleIsFullCircle){const a=_normalizeAngle(angle);const s=_normalizeAngle(start);const e=_normalizeAngle(end);const angleToStart=_normalizeAngle(s-a);const angleToEnd=_normalizeAngle(e-a);const startToAngle=_normalizeAngle(a-s);const endToAngle=_normalizeAngle(a-e);return a===s||a===e||sameAngleIsFullCircle&&s===e||angleToStart>angleToEnd&&startToAngle<endToAngle;}
function _limitValue(value,min,max){return Math.max(min,Math.min(max,value));}
function _int16Range(value){return _limitValue(value,-32768,32767);}
function _isBetween(value,start,end,epsilon=1e-6){return value>=Math.min(start,end)-epsilon&&value<=Math.max(start,end)+epsilon;}
function _lookup(table,value,cmp){cmp=cmp||((index)=>table[index]<value);let hi=table.length-1;let lo=0;let mid;while(hi-lo>1){mid=lo+hi>>1;if(cmp(mid)){lo=mid;}else{hi=mid;}}
return{lo,hi};}
const _lookupByKey=(table,key,value,last)=>_lookup(table,value,last?(index)=>{const ti=table[index][key];return ti<value||ti===value&&table[index+1][key]===value;}:(index)=>table[index][key]<value);const _rlookupByKey=(table,key,value)=>_lookup(table,value,(index)=>table[index][key]>=value);function _filterBetween(values,min,max){let start=0;let end=values.length;while(start<end&&values[start]<min){start++;}
while(end>start&&values[end-1]>max){end--;}
return start>0||end<values.length?values.slice(start,end):values;}
const arrayEvents=['push','pop','shift','splice','unshift'];function listenArrayEvents(array,listener){if(array._chartjs){array._chartjs.listeners.push(listener);return;}
Object.defineProperty(array,'_chartjs',{configurable:true,enumerable:false,value:{listeners:[listener]}});arrayEvents.forEach((key)=>{const method='_onData'+_capitalize(key);const base=array[key];Object.defineProperty(array,key,{configurable:true,enumerable:false,value(...args){const res=base.apply(this,args);array._chartjs.listeners.forEach((object)=>{if(typeof object[method]==='function'){object[method](...args);}});return res;}});});}
function unlistenArrayEvents(array,listener){const stub=array._chartjs;if(!stub){return;}
const listeners=stub.listeners;const index=listeners.indexOf(listener);if(index!==-1){listeners.splice(index,1);}
if(listeners.length>0){return;}
arrayEvents.forEach((key)=>{delete array[key];});delete array._chartjs;}
function _arrayUnique(items){const set=new Set(items);if(set.size===items.length){return items;}
return Array.from(set);}
function fontString(pixelSize,fontStyle,fontFamily){return fontStyle+' '+pixelSize+'px '+fontFamily;}
const requestAnimFrame=function(){if(typeof window==='undefined'){return function(callback){return callback();};}
return window.requestAnimationFrame;}();function throttled(fn,thisArg){let argsToUse=[];let ticking=false;return function(...args){argsToUse=args;if(!ticking){ticking=true;requestAnimFrame.call(window,()=>{ticking=false;fn.apply(thisArg,argsToUse);});}};}
function debounce(fn,delay){let timeout;return function(...args){if(delay){clearTimeout(timeout);timeout=setTimeout(fn,delay,args);}else{fn.apply(this,args);}
return delay;};}
const _toLeftRightCenter=(align)=>align==='start'?'left':align==='end'?'right':'center';const _alignStartEnd=(align,start,end)=>align==='start'?start:align==='end'?end:(start+end)/2;const _textX=(align,left,right,rtl)=>{const check=rtl?'left':'right';return align===check?right:align==='center'?(left+right)/2:left;};function _getStartAndCountOfVisiblePoints(meta,points,animationsDisabled){const pointCount=points.length;let start=0;let count=pointCount;if(meta._sorted){const{iScale,_parsed}=meta;const axis=iScale.axis;const{min,max,minDefined,maxDefined}=iScale.getUserBounds();if(minDefined){start=_limitValue(Math.min(_lookupByKey(_parsed,iScale.axis,min).lo,animationsDisabled?pointCount:_lookupByKey(points,axis,iScale.getPixelForValue(min)).lo),0,pointCount-1);}
if(maxDefined){count=_limitValue(Math.max(_lookupByKey(_parsed,iScale.axis,max,true).hi+1,animationsDisabled?0:_lookupByKey(points,axis,iScale.getPixelForValue(max),true).hi+1),start,pointCount)-start;}else{count=pointCount-start;}}
return{start,count};}
function _scaleRangesChanged(meta){const{xScale,yScale,_scaleRanges}=meta;const newRanges={xmin:xScale.min,xmax:xScale.max,ymin:yScale.min,ymax:yScale.max};if(!_scaleRanges){meta._scaleRanges=newRanges;return true;}
const changed=_scaleRanges.xmin!==xScale.min||_scaleRanges.xmax!==xScale.max||_scaleRanges.ymin!==yScale.min||_scaleRanges.ymax!==yScale.max;Object.assign(_scaleRanges,newRanges);return changed;}
class Animator{constructor(){this._request=null;this._charts=new Map();this._running=false;this._lastDate=undefined;}
_notify(chart,anims,date,type){const callbacks=anims.listeners[type];const numSteps=anims.duration;callbacks.forEach((fn)=>fn({chart,initial:anims.initial,numSteps,currentStep:Math.min(date-anims.start,numSteps)}));}
_refresh(){if(this._request){return;}
this._running=true;this._request=requestAnimFrame.call(window,()=>{this._update();this._request=null;if(this._running){this._refresh();}});}
_update(date=Date.now()){let remaining=0;this._charts.forEach((anims,chart)=>{if(!anims.running||!anims.items.length){return;}
const items=anims.items;let i=items.length-1;let draw=false;let item;for(;i>=0;--i){item=items[i];if(item._active){if(item._total>anims.duration){anims.duration=item._total;}
item.tick(date);draw=true;}else{items[i]=items[items.length-1];items.pop();}}
if(draw){chart.draw();this._notify(chart,anims,date,'progress');}
if(!items.length){anims.running=false;this._notify(chart,anims,date,'complete');anims.initial=false;}
remaining+=items.length;});this._lastDate=date;if(remaining===0){this._running=false;}}
_getAnims(chart){const charts=this._charts;let anims=charts.get(chart);if(!anims){anims={running:false,initial:true,items:[],listeners:{complete:[],progress:[]}};charts.set(chart,anims);}
return anims;}
listen(chart,event,cb){this._getAnims(chart).listeners[event].push(cb);}
add(chart,items){if(!items||!items.length){return;}
this._getAnims(chart).items.push(...items);}
has(chart){return this._getAnims(chart).items.length>0;}
start(chart){const anims=this._charts.get(chart);if(!anims){return;}
anims.running=true;anims.start=Date.now();anims.duration=anims.items.reduce((acc,cur)=>Math.max(acc,cur._duration),0);this._refresh();}
running(chart){if(!this._running){return false;}
const anims=this._charts.get(chart);if(!anims||!anims.running||!anims.items.length){return false;}
return true;}
stop(chart){const anims=this._charts.get(chart);if(!anims||!anims.items.length){return;}
const items=anims.items;let i=items.length-1;for(;i>=0;--i){items[i].cancel();}
anims.items=[];this._notify(chart,anims,Date.now(),'complete');}
remove(chart){return this._charts.delete(chart);}}
var animator=new Animator();function round(v){return v+0.5|0;}
const lim=(v,l,h)=>Math.max(Math.min(v,h),l);function p2b(v){return lim(round(v*2.55),0,255);}
function n2b(v){return lim(round(v*255),0,255);}
function b2n(v){return lim(round(v/2.55)/100,0,1);}
function n2p(v){return lim(round(v*100),0,100);}
const map$1={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15};const hex=[...'0123456789ABCDEF'];const h1=b=>hex[b&0xF];const h2=b=>hex[(b&0xF0)>>4]+hex[b&0xF];const eq=b=>((b&0xF0)>>4)===(b&0xF);const isShort=v=>eq(v.r)&&eq(v.g)&&eq(v.b)&&eq(v.a);function hexParse(str){var len=str.length;var ret;if(str[0]==='#'){if(len===4||len===5){ret={r:255&map$1[str[1]]*17,g:255&map$1[str[2]]*17,b:255&map$1[str[3]]*17,a:len===5?map$1[str[4]]*17:255};}else if(len===7||len===9){ret={r:map$1[str[1]]<<4|map$1[str[2]],g:map$1[str[3]]<<4|map$1[str[4]],b:map$1[str[5]]<<4|map$1[str[6]],a:len===9?(map$1[str[7]]<<4|map$1[str[8]]):255};}}
return ret;}
const alpha=(a,f)=>a<255?f(a):'';function hexString(v){var f=isShort(v)?h1:h2;return v?'#'+f(v.r)+f(v.g)+f(v.b)+alpha(v.a,f):undefined;}
const HUE_RE=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function hsl2rgbn(h,s,l){const a=s*Math.min(l,1-l);const f=(n,k=(n+h/30)%12)=>l-a*Math.max(Math.min(k-3,9-k,1),-1);return[f(0),f(8),f(4)];}
function hsv2rgbn(h,s,v){const f=(n,k=(n+h/60)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0);return[f(5),f(3),f(1)];}
function hwb2rgbn(h,w,b){const rgb=hsl2rgbn(h,1,0.5);let i;if(w+b>1){i=1/(w+b);w*=i;b*=i;}
for(i=0;i<3;i++){rgb[i]*=1-w-b;rgb[i]+=w;}
return rgb;}
function hueValue(r,g,b,d,max){if(r===max){return((g-b)/d)+(g<b?6:0);}
if(g===max){return(b-r)/d+2;}
return(r-g)/d+4;}
function rgb2hsl(v){const range=255;const r=v.r/range;const g=v.g/range;const b=v.b/range;const max=Math.max(r,g,b);const min=Math.min(r,g,b);const l=(max+min)/2;let h,s,d;if(max!==min){d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);h=hueValue(r,g,b,d,max);h=h*60+0.5;}
return[h|0,s||0,l];}
function calln(f,a,b,c){return(Array.isArray(a)?f(a[0],a[1],a[2]):f(a,b,c)).map(n2b);}
function hsl2rgb(h,s,l){return calln(hsl2rgbn,h,s,l);}
function hwb2rgb(h,w,b){return calln(hwb2rgbn,h,w,b);}
function hsv2rgb(h,s,v){return calln(hsv2rgbn,h,s,v);}
function hue(h){return(h%360+360)%360;}
function hueParse(str){const m=HUE_RE.exec(str);let a=255;let v;if(!m){return;}
if(m[5]!==v){a=m[6]?p2b(+m[5]):n2b(+m[5]);}
const h=hue(+m[2]);const p1=+m[3]/100;const p2=+m[4]/100;if(m[1]==='hwb'){v=hwb2rgb(h,p1,p2);}else if(m[1]==='hsv'){v=hsv2rgb(h,p1,p2);}else{v=hsl2rgb(h,p1,p2);}
return{r:v[0],g:v[1],b:v[2],a:a};}
function rotate(v,deg){var h=rgb2hsl(v);h[0]=hue(h[0]+deg);h=hsl2rgb(h);v.r=h[0];v.g=h[1];v.b=h[2];}
function hslString(v){if(!v){return;}
const a=rgb2hsl(v);const h=a[0];const s=n2p(a[1]);const l=n2p(a[2]);return v.a<255?`hsla(${h}, ${s}%, ${l}%, ${b2n(v.a)})`:`hsl(${h}, ${s}%, ${l}%)`;}
const map$2={x:'dark',Z:'light',Y:'re',X:'blu',W:'gr',V:'medium',U:'slate',A:'ee',T:'ol',S:'or',B:'ra',C:'lateg',D:'ights',R:'in',Q:'turquois',E:'hi',P:'ro',O:'al',N:'le',M:'de',L:'yello',F:'en',K:'ch',G:'arks',H:'ea',I:'ightg',J:'wh'};const names$1={OiceXe:'f0f8ff',antiquewEte:'faebd7',aqua:'ffff',aquamarRe:'7fffd4',azuY:'f0ffff',beige:'f5f5dc',bisque:'ffe4c4',black:'0',blanKedOmond:'ffebcd',Xe:'ff',XeviTet:'8a2be2',bPwn:'a52a2a',burlywood:'deb887',caMtXe:'5f9ea0',KartYuse:'7fff00',KocTate:'d2691e',cSO:'ff7f50',cSnflowerXe:'6495ed',cSnsilk:'fff8dc',crimson:'dc143c',cyan:'ffff',xXe:'8b',xcyan:'8b8b',xgTMnPd:'b8860b',xWay:'a9a9a9',xgYF:'6400',xgYy:'a9a9a9',xkhaki:'bdb76b',xmagFta:'8b008b',xTivegYF:'556b2f',xSange:'ff8c00',xScEd:'9932cc',xYd:'8b0000',xsOmon:'e9967a',xsHgYF:'8fbc8f',xUXe:'483d8b',xUWay:'2f4f4f',xUgYy:'2f4f4f',xQe:'ced1',xviTet:'9400d3',dAppRk:'ff1493',dApskyXe:'bfff',dimWay:'696969',dimgYy:'696969',dodgerXe:'1e90ff',fiYbrick:'b22222',flSOwEte:'fffaf0',foYstWAn:'228b22',fuKsia:'ff00ff',gaRsbSo:'dcdcdc',ghostwEte:'f8f8ff',gTd:'ffd700',gTMnPd:'daa520',Way:'808080',gYF:'8000',gYFLw:'adff2f',gYy:'808080',honeyMw:'f0fff0',hotpRk:'ff69b4',RdianYd:'cd5c5c',Rdigo:'4b0082',ivSy:'fffff0',khaki:'f0e68c',lavFMr:'e6e6fa',lavFMrXsh:'fff0f5',lawngYF:'7cfc00',NmoncEffon:'fffacd',ZXe:'add8e6',ZcSO:'f08080',Zcyan:'e0ffff',ZgTMnPdLw:'fafad2',ZWay:'d3d3d3',ZgYF:'90ee90',ZgYy:'d3d3d3',ZpRk:'ffb6c1',ZsOmon:'ffa07a',ZsHgYF:'20b2aa',ZskyXe:'87cefa',ZUWay:'778899',ZUgYy:'778899',ZstAlXe:'b0c4de',ZLw:'ffffe0',lime:'ff00',limegYF:'32cd32',lRF:'faf0e6',magFta:'ff00ff',maPon:'800000',VaquamarRe:'66cdaa',VXe:'cd',VScEd:'ba55d3',VpurpN:'9370db',VsHgYF:'3cb371',VUXe:'7b68ee',VsprRggYF:'fa9a',VQe:'48d1cc',VviTetYd:'c71585',midnightXe:'191970',mRtcYam:'f5fffa',mistyPse:'ffe4e1',moccasR:'ffe4b5',navajowEte:'ffdead',navy:'80',Tdlace:'fdf5e6',Tive:'808000',TivedBb:'6b8e23',Sange:'ffa500',SangeYd:'ff4500',ScEd:'da70d6',pOegTMnPd:'eee8aa',pOegYF:'98fb98',pOeQe:'afeeee',pOeviTetYd:'db7093',papayawEp:'ffefd5',pHKpuff:'ffdab9',peru:'cd853f',pRk:'ffc0cb',plum:'dda0dd',powMrXe:'b0e0e6',purpN:'800080',YbeccapurpN:'663399',Yd:'ff0000',Psybrown:'bc8f8f',PyOXe:'4169e1',saddNbPwn:'8b4513',sOmon:'fa8072',sandybPwn:'f4a460',sHgYF:'2e8b57',sHshell:'fff5ee',siFna:'a0522d',silver:'c0c0c0',skyXe:'87ceeb',UXe:'6a5acd',UWay:'708090',UgYy:'708090',snow:'fffafa',sprRggYF:'ff7f',stAlXe:'4682b4',tan:'d2b48c',teO:'8080',tEstN:'d8bfd8',tomato:'ff6347',Qe:'40e0d0',viTet:'ee82ee',JHt:'f5deb3',wEte:'ffffff',wEtesmoke:'f5f5f5',Lw:'ffff00',LwgYF:'9acd32'};function unpack(){const unpacked={};const keys=Object.keys(names$1);const tkeys=Object.keys(map$2);let i,j,k,ok,nk;for(i=0;i<keys.length;i++){ok=nk=keys[i];for(j=0;j<tkeys.length;j++){k=tkeys[j];nk=nk.replace(k,map$2[k]);}
k=parseInt(names$1[ok],16);unpacked[nk]=[k>>16&0xFF,k>>8&0xFF,k&0xFF];}
return unpacked;}
let names;function nameParse(str){if(!names){names=unpack();names.transparent=[0,0,0,0];}
const a=names[str.toLowerCase()];return a&&{r:a[0],g:a[1],b:a[2],a:a.length===4?a[3]:255};}
const RGB_RE=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/;function rgbParse(str){const m=RGB_RE.exec(str);let a=255;let r,g,b;if(!m){return;}
if(m[7]!==r){const v=+m[7];a=m[8]?p2b(v):lim(v*255,0,255);}
r=+m[1];g=+m[3];b=+m[5];r=255&(m[2]?p2b(r):lim(r,0,255));g=255&(m[4]?p2b(g):lim(g,0,255));b=255&(m[6]?p2b(b):lim(b,0,255));return{r:r,g:g,b:b,a:a};}
function rgbString(v){return v&&(v.a<255?`rgba(${v.r}, ${v.g}, ${v.b}, ${b2n(v.a)})`:`rgb(${v.r}, ${v.g}, ${v.b})`);}
const to=v=>v<=0.0031308?v*12.92:Math.pow(v,1.0/2.4)*1.055-0.055;const from=v=>v<=0.04045?v/12.92:Math.pow((v+0.055)/1.055,2.4);function interpolate$1(rgb1,rgb2,t){const r=from(b2n(rgb1.r));const g=from(b2n(rgb1.g));const b=from(b2n(rgb1.b));return{r:n2b(to(r+t*(from(b2n(rgb2.r))-r))),g:n2b(to(g+t*(from(b2n(rgb2.g))-g))),b:n2b(to(b+t*(from(b2n(rgb2.b))-b))),a:rgb1.a+t*(rgb2.a-rgb1.a)};}
function modHSL(v,i,ratio){if(v){let tmp=rgb2hsl(v);tmp[i]=Math.max(0,Math.min(tmp[i]+tmp[i]*ratio,i===0?360:1));tmp=hsl2rgb(tmp);v.r=tmp[0];v.g=tmp[1];v.b=tmp[2];}}
function clone(v,proto){return v?Object.assign(proto||{},v):v;}
function fromObject(input){var v={r:0,g:0,b:0,a:255};if(Array.isArray(input)){if(input.length>=3){v={r:input[0],g:input[1],b:input[2],a:255};if(input.length>3){v.a=n2b(input[3]);}}}else{v=clone(input,{r:0,g:0,b:0,a:1});v.a=n2b(v.a);}
return v;}
function functionParse(str){if(str.charAt(0)==='r'){return rgbParse(str);}
return hueParse(str);}
class Color{constructor(input){if(input instanceof Color){return input;}
const type=typeof input;let v;if(type==='object'){v=fromObject(input);}else if(type==='string'){v=hexParse(input)||nameParse(input)||functionParse(input);}
this._rgb=v;this._valid=!!v;}
get valid(){return this._valid;}
get rgb(){var v=clone(this._rgb);if(v){v.a=b2n(v.a);}
return v;}
set rgb(obj){this._rgb=fromObject(obj);}
rgbString(){return this._valid?rgbString(this._rgb):undefined;}
hexString(){return this._valid?hexString(this._rgb):undefined;}
hslString(){return this._valid?hslString(this._rgb):undefined;}
mix(color,weight){if(color){const c1=this.rgb;const c2=color.rgb;let w2;const p=weight===w2?0.5:weight;const w=2*p-1;const a=c1.a-c2.a;const w1=((w*a===-1?w:(w+a)/(1+w*a))+1)/2.0;w2=1-w1;c1.r=0xFF&w1*c1.r+w2*c2.r+0.5;c1.g=0xFF&w1*c1.g+w2*c2.g+0.5;c1.b=0xFF&w1*c1.b+w2*c2.b+0.5;c1.a=p*c1.a+(1-p)*c2.a;this.rgb=c1;}
return this;}
interpolate(color,t){if(color){this._rgb=interpolate$1(this._rgb,color._rgb,t);}
return this;}
clone(){return new Color(this.rgb);}
alpha(a){this._rgb.a=n2b(a);return this;}
clearer(ratio){const rgb=this._rgb;rgb.a*=1-ratio;return this;}
greyscale(){const rgb=this._rgb;const val=round(rgb.r*0.3+rgb.g*0.59+rgb.b*0.11);rgb.r=rgb.g=rgb.b=val;return this;}
opaquer(ratio){const rgb=this._rgb;rgb.a*=1+ratio;return this;}
negate(){const v=this._rgb;v.r=255-v.r;v.g=255-v.g;v.b=255-v.b;return this;}
lighten(ratio){modHSL(this._rgb,2,ratio);return this;}
darken(ratio){modHSL(this._rgb,2,-ratio);return this;}
saturate(ratio){modHSL(this._rgb,1,ratio);return this;}
desaturate(ratio){modHSL(this._rgb,1,-ratio);return this;}
rotate(deg){rotate(this._rgb,deg);return this;}}
function isPatternOrGradient(value){if(value&&typeof value==='object'){const type=value.toString();return type==='[object CanvasPattern]'||type==='[object CanvasGradient]';}
return false;}
function color(value){return isPatternOrGradient(value)?value:new Color(value);}
function getHoverColor(value){return isPatternOrGradient(value)?value:new Color(value).saturate(0.5).darken(0.1).hexString();}
const numbers=['x','y','borderWidth','radius','tension'];const colors=['color','borderColor','backgroundColor'];function applyAnimationsDefaults(defaults){defaults.set('animation',{delay:undefined,duration:1000,easing:'easeOutQuart',fn:undefined,from:undefined,loop:undefined,to:undefined,type:undefined});defaults.describe('animation',{_fallback:false,_indexable:false,_scriptable:(name)=>name!=='onProgress'&&name!=='onComplete'&&name!=='fn'});defaults.set('animations',{colors:{type:'color',properties:colors},numbers:{type:'number',properties:numbers}});defaults.describe('animations',{_fallback:'animation'});defaults.set('transitions',{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:'transparent'},visible:{type:'boolean',duration:0}}},hide:{animations:{colors:{to:'transparent'},visible:{type:'boolean',easing:'linear',fn:(v)=>v|0}}}});}
function applyLayoutsDefaults(defaults){defaults.set('layout',{autoPadding:true,padding:{top:0,right:0,bottom:0,left:0}});}
const intlCache=new Map();function getNumberFormat(locale,options){options=options||{};const cacheKey=locale+JSON.stringify(options);let formatter=intlCache.get(cacheKey);if(!formatter){formatter=new Intl.NumberFormat(locale,options);intlCache.set(cacheKey,formatter);}
return formatter;}
function formatNumber(num,locale,options){return getNumberFormat(locale,options).format(num);}
const formatters={values(value){return isArray(value)?value:''+value;},numeric(tickValue,index,ticks){if(tickValue===0){return'0';}
const locale=this.chart.options.locale;let notation;let delta=tickValue;if(ticks.length>1){const maxTick=Math.max(Math.abs(ticks[0].value),Math.abs(ticks[ticks.length-1].value));if(maxTick<1e-4||maxTick>1e+15){notation='scientific';}
delta=calculateDelta(tickValue,ticks);}
const logDelta=log10(Math.abs(delta));const numDecimal=isNaN(logDelta)?1:Math.max(Math.min(-1*Math.floor(logDelta),20),0);const options={notation,minimumFractionDigits:numDecimal,maximumFractionDigits:numDecimal};Object.assign(options,this.options.ticks.format);return formatNumber(tickValue,locale,options);},logarithmic(tickValue,index,ticks){if(tickValue===0){return'0';}
const remain=ticks[index].significand||tickValue/Math.pow(10,Math.floor(log10(tickValue)));if([1,2,3,5,10,15].includes(remain)||index>0.8*ticks.length){return formatters.numeric.call(this,tickValue,index,ticks);}
return'';}};function calculateDelta(tickValue,ticks){let delta=ticks.length>3?ticks[2].value-ticks[1].value:ticks[1].value-ticks[0].value;if(Math.abs(delta)>=1&&tickValue!==Math.floor(tickValue)){delta=tickValue-Math.floor(tickValue);}
return delta;}
var Ticks={formatters};function applyScaleDefaults(defaults){defaults.set('scale',{display:true,offset:false,reverse:false,beginAtZero:false,bounds:'ticks',grace:0,grid:{display:true,lineWidth:1,drawOnChartArea:true,drawTicks:true,tickLength:8,tickWidth:(_ctx,options)=>options.lineWidth,tickColor:(_ctx,options)=>options.color,offset:false},border:{display:true,dash:[],dashOffset:0.0,width:1},title:{display:false,text:'',padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:false,textStrokeWidth:0,textStrokeColor:'',padding:3,display:true,autoSkip:true,autoSkipPadding:3,labelOffset:0,callback:Ticks.formatters.values,minor:{},major:{},align:'center',crossAlign:'near',showLabelBackdrop:false,backdropColor:'rgba(255, 255, 255, 0.75)',backdropPadding:2}});defaults.route('scale.ticks','color','','color');defaults.route('scale.grid','color','','borderColor');defaults.route('scale.border','color','','borderColor');defaults.route('scale.title','color','','color');defaults.describe('scale',{_fallback:false,_scriptable:(name)=>!name.startsWith('before')&&!name.startsWith('after')&&name!=='callback'&&name!=='parser',_indexable:(name)=>name!=='borderDash'&&name!=='tickBorderDash'&&name!=='dash'});defaults.describe('scales',{_fallback:'scale'});defaults.describe('scale.ticks',{_scriptable:(name)=>name!=='backdropPadding'&&name!=='callback',_indexable:(name)=>name!=='backdropPadding'});}
const overrides=Object.create(null);const descriptors=Object.create(null);function getScope$1(node,key){if(!key){return node;}
const keys=key.split('.');for(let i=0,n=keys.length;i<n;++i){const k=keys[i];node=node[k]||(node[k]=Object.create(null));}
return node;}
function set(root,scope,values){if(typeof scope==='string'){return merge(getScope$1(root,scope),values);}
return merge(getScope$1(root,''),scope);}
class Defaults{constructor(_descriptors,_appliers){this.animation=undefined;this.backgroundColor='rgba(0,0,0,0.1)';this.borderColor='rgba(0,0,0,0.1)';this.color='#666';this.datasets={};this.devicePixelRatio=(context)=>context.chart.platform.getDevicePixelRatio();this.elements={};this.events=['mousemove','mouseout','click','touchstart','touchmove'];this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:'normal',lineHeight:1.2,weight:null};this.hover={};this.hoverBackgroundColor=(ctx,options)=>getHoverColor(options.backgroundColor);this.hoverBorderColor=(ctx,options)=>getHoverColor(options.borderColor);this.hoverColor=(ctx,options)=>getHoverColor(options.color);this.indexAxis='x';this.interaction={mode:'nearest',intersect:true,includeInvisible:false};this.maintainAspectRatio=true;this.onHover=null;this.onClick=null;this.parsing=true;this.plugins={};this.responsive=true;this.scale=undefined;this.scales={};this.showLine=true;this.drawActiveElementsOnTop=true;this.describe(_descriptors);this.apply(_appliers);}
set(scope,values){return set(this,scope,values);}
get(scope){return getScope$1(this,scope);}
describe(scope,values){return set(descriptors,scope,values);}
override(scope,values){return set(overrides,scope,values);}
route(scope,name,targetScope,targetName){const scopeObject=getScope$1(this,scope);const targetScopeObject=getScope$1(this,targetScope);const privateName='_'+name;Object.defineProperties(scopeObject,{[privateName]:{value:scopeObject[name],writable:true},[name]:{enumerable:true,get(){const local=this[privateName];const target=targetScopeObject[targetName];if(isObject(local)){return Object.assign({},target,local);}
return valueOrDefault(local,target);},set(value){this[privateName]=value;}}});}
apply(appliers){appliers.forEach((apply)=>apply(this));}}
var defaults=new Defaults({_scriptable:(name)=>!name.startsWith('on'),_indexable:(name)=>name!=='events',hover:{_fallback:'interaction'},interaction:{_scriptable:false,_indexable:false}},[applyAnimationsDefaults,applyLayoutsDefaults,applyScaleDefaults]);function _isDomSupported(){return typeof window!=='undefined'&&typeof document!=='undefined';}
function _getParentNode(domNode){let parent=domNode.parentNode;if(parent&&parent.toString()==='[object ShadowRoot]'){parent=parent.host;}
return parent;}
function parseMaxStyle(styleValue,node,parentProperty){let valueInPixels;if(typeof styleValue==='string'){valueInPixels=parseInt(styleValue,10);if(styleValue.indexOf('%')!==-1){valueInPixels=valueInPixels/100*node.parentNode[parentProperty];}}else{valueInPixels=styleValue;}
return valueInPixels;}
const getComputedStyle=(element)=>element.ownerDocument.defaultView.getComputedStyle(element,null);function getStyle(el,property){return getComputedStyle(el).getPropertyValue(property);}
const positions=['top','right','bottom','left'];function getPositionedStyle(styles,style,suffix){const result={};suffix=suffix?'-'+suffix:'';for(let i=0;i<4;i++){const pos=positions[i];result[pos]=parseFloat(styles[style+'-'+pos+suffix])||0;}
result.width=result.left+result.right;result.height=result.top+result.bottom;return result;}
const useOffsetPos=(x,y,target)=>(x>0||y>0)&&(!target||!target.shadowRoot);function getCanvasPosition(e,canvas){const touches=e.touches;const source=touches&&touches.length?touches[0]:e;const{offsetX,offsetY}=source;let box=false;let x,y;if(useOffsetPos(offsetX,offsetY,e.target)){x=offsetX;y=offsetY;}else{const rect=canvas.getBoundingClientRect();x=source.clientX-rect.left;y=source.clientY-rect.top;box=true;}
return{x,y,box};}
function getRelativePosition(event,chart){if('native'in event){return event;}
const{canvas,currentDevicePixelRatio}=chart;const style=getComputedStyle(canvas);const borderBox=style.boxSizing==='border-box';const paddings=getPositionedStyle(style,'padding');const borders=getPositionedStyle(style,'border','width');const{x,y,box}=getCanvasPosition(event,canvas);const xOffset=paddings.left+(box&&borders.left);const yOffset=paddings.top+(box&&borders.top);let{width,height}=chart;if(borderBox){width-=paddings.width+borders.width;height-=paddings.height+borders.height;}
return{x:Math.round((x-xOffset)/width*canvas.width/currentDevicePixelRatio),y:Math.round((y-yOffset)/height*canvas.height/currentDevicePixelRatio)};}
function getContainerSize(canvas,width,height){let maxWidth,maxHeight;if(width===undefined||height===undefined){const container=_getParentNode(canvas);if(!container){width=canvas.clientWidth;height=canvas.clientHeight;}else{const rect=container.getBoundingClientRect();const containerStyle=getComputedStyle(container);const containerBorder=getPositionedStyle(containerStyle,'border','width');const containerPadding=getPositionedStyle(containerStyle,'padding');width=rect.width-containerPadding.width-containerBorder.width;height=rect.height-containerPadding.height-containerBorder.height;maxWidth=parseMaxStyle(containerStyle.maxWidth,container,'clientWidth');maxHeight=parseMaxStyle(containerStyle.maxHeight,container,'clientHeight');}}
return{width,height,maxWidth:maxWidth||INFINITY,maxHeight:maxHeight||INFINITY};}
const round1=(v)=>Math.round(v*10)/10;function getMaximumSize(canvas,bbWidth,bbHeight,aspectRatio){const style=getComputedStyle(canvas);const margins=getPositionedStyle(style,'margin');const maxWidth=parseMaxStyle(style.maxWidth,canvas,'clientWidth')||INFINITY;const maxHeight=parseMaxStyle(style.maxHeight,canvas,'clientHeight')||INFINITY;const containerSize=getContainerSize(canvas,bbWidth,bbHeight);let{width,height}=containerSize;if(style.boxSizing==='content-box'){const borders=getPositionedStyle(style,'border','width');const paddings=getPositionedStyle(style,'padding');width-=paddings.width+borders.width;height-=paddings.height+borders.height;}
width=Math.max(0,width-margins.width);height=Math.max(0,aspectRatio?width/aspectRatio:height-margins.height);width=round1(Math.min(width,maxWidth,containerSize.maxWidth));height=round1(Math.min(height,maxHeight,containerSize.maxHeight));if(width&&!height){height=round1(width/2);}
const maintainHeight=bbWidth!==undefined||bbHeight!==undefined;if(maintainHeight&&aspectRatio&&containerSize.height&&height>containerSize.height){height=containerSize.height;width=round1(Math.floor(height*aspectRatio));}
return{width,height};}
function retinaScale(chart,forceRatio,forceStyle){const pixelRatio=forceRatio||1;const deviceHeight=Math.floor(chart.height*pixelRatio);const deviceWidth=Math.floor(chart.width*pixelRatio);chart.height=Math.floor(chart.height);chart.width=Math.floor(chart.width);const canvas=chart.canvas;if(canvas.style&&(forceStyle||!canvas.style.height&&!canvas.style.width)){canvas.style.height=`${chart.height}px`;canvas.style.width=`${chart.width}px`;}
if(chart.currentDevicePixelRatio!==pixelRatio||canvas.height!==deviceHeight||canvas.width!==deviceWidth){chart.currentDevicePixelRatio=pixelRatio;canvas.height=deviceHeight;canvas.width=deviceWidth;chart.ctx.setTransform(pixelRatio,0,0,pixelRatio,0,0);return true;}
return false;}
const supportsEventListenerOptions=function(){let passiveSupported=false;try{const options={get passive(){passiveSupported=true;return false;}};window.addEventListener('test',null,options);window.removeEventListener('test',null,options);}catch(e){}
return passiveSupported;}();function readUsedSize(element,property){const value=getStyle(element,property);const matches=value&&value.match(/^(\d+)(\.\d+)?px$/);return matches?+matches[1]:undefined;}
function toFontString(font){if(!font||isNullOrUndef(font.size)||isNullOrUndef(font.family)){return null;}
return(font.style?font.style+' ':'')+(font.weight?font.weight+' ':'')+font.size+'px '+font.family;}
function _measureText(ctx,data,gc,longest,string){let textWidth=data[string];if(!textWidth){textWidth=data[string]=ctx.measureText(string).width;gc.push(string);}
if(textWidth>longest){longest=textWidth;}
return longest;}
function _longestText(ctx,font,arrayOfThings,cache){cache=cache||{};let data=cache.data=cache.data||{};let gc=cache.garbageCollect=cache.garbageCollect||[];if(cache.font!==font){data=cache.data={};gc=cache.garbageCollect=[];cache.font=font;}
ctx.save();ctx.font=font;let longest=0;const ilen=arrayOfThings.length;let i,j,jlen,thing,nestedThing;for(i=0;i<ilen;i++){thing=arrayOfThings[i];if(thing!==undefined&&thing!==null&&!isArray(thing)){longest=_measureText(ctx,data,gc,longest,thing);}else if(isArray(thing)){for(j=0,jlen=thing.length;j<jlen;j++){nestedThing=thing[j];if(nestedThing!==undefined&&nestedThing!==null&&!isArray(nestedThing)){longest=_measureText(ctx,data,gc,longest,nestedThing);}}}}
ctx.restore();const gcLen=gc.length/2;if(gcLen>arrayOfThings.length){for(i=0;i<gcLen;i++){delete data[gc[i]];}
gc.splice(0,gcLen);}
return longest;}
function _alignPixel(chart,pixel,width){const devicePixelRatio=chart.currentDevicePixelRatio;const halfWidth=width!==0?Math.max(width/2,0.5):0;return Math.round((pixel-halfWidth)*devicePixelRatio)/devicePixelRatio+halfWidth;}
function clearCanvas(canvas,ctx){ctx=ctx||canvas.getContext('2d');ctx.save();ctx.resetTransform();ctx.clearRect(0,0,canvas.width,canvas.height);ctx.restore();}
function drawPoint(ctx,options,x,y){drawPointLegend(ctx,options,x,y,null);}
function drawPointLegend(ctx,options,x,y,w){let type,xOffset,yOffset,size,cornerRadius,width,xOffsetW,yOffsetW;const style=options.pointStyle;const rotation=options.rotation;const radius=options.radius;let rad=(rotation||0)*RAD_PER_DEG;if(style&&typeof style==='object'){type=style.toString();if(type==='[object HTMLImageElement]'||type==='[object HTMLCanvasElement]'){ctx.save();ctx.translate(x,y);ctx.rotate(rad);ctx.drawImage(style,-style.width/2,-style.height/2,style.width,style.height);ctx.restore();return;}}
if(isNaN(radius)||radius<=0){return;}
ctx.beginPath();switch(style){default:if(w){ctx.ellipse(x,y,w/2,radius,0,0,TAU);}else{ctx.arc(x,y,radius,0,TAU);}
ctx.closePath();break;case'triangle':width=w?w/2:radius;ctx.moveTo(x+Math.sin(rad)*width,y-Math.cos(rad)*radius);rad+=TWO_THIRDS_PI;ctx.lineTo(x+Math.sin(rad)*width,y-Math.cos(rad)*radius);rad+=TWO_THIRDS_PI;ctx.lineTo(x+Math.sin(rad)*width,y-Math.cos(rad)*radius);ctx.closePath();break;case'rectRounded':cornerRadius=radius*0.516;size=radius-cornerRadius;xOffset=Math.cos(rad+QUARTER_PI)*size;xOffsetW=Math.cos(rad+QUARTER_PI)*(w?w/2-cornerRadius:size);yOffset=Math.sin(rad+QUARTER_PI)*size;yOffsetW=Math.sin(rad+QUARTER_PI)*(w?w/2-cornerRadius:size);ctx.arc(x-xOffsetW,y-yOffset,cornerRadius,rad-PI,rad-HALF_PI);ctx.arc(x+yOffsetW,y-xOffset,cornerRadius,rad-HALF_PI,rad);ctx.arc(x+xOffsetW,y+yOffset,cornerRadius,rad,rad+HALF_PI);ctx.arc(x-yOffsetW,y+xOffset,cornerRadius,rad+HALF_PI,rad+PI);ctx.closePath();break;case'rect':if(!rotation){size=Math.SQRT1_2*radius;width=w?w/2:size;ctx.rect(x-width,y-size,2*width,2*size);break;}
rad+=QUARTER_PI;case'rectRot':xOffsetW=Math.cos(rad)*(w?w/2:radius);xOffset=Math.cos(rad)*radius;yOffset=Math.sin(rad)*radius;yOffsetW=Math.sin(rad)*(w?w/2:radius);ctx.moveTo(x-xOffsetW,y-yOffset);ctx.lineTo(x+yOffsetW,y-xOffset);ctx.lineTo(x+xOffsetW,y+yOffset);ctx.lineTo(x-yOffsetW,y+xOffset);ctx.closePath();break;case'crossRot':rad+=QUARTER_PI;case'cross':xOffsetW=Math.cos(rad)*(w?w/2:radius);xOffset=Math.cos(rad)*radius;yOffset=Math.sin(rad)*radius;yOffsetW=Math.sin(rad)*(w?w/2:radius);ctx.moveTo(x-xOffsetW,y-yOffset);ctx.lineTo(x+xOffsetW,y+yOffset);ctx.moveTo(x+yOffsetW,y-xOffset);ctx.lineTo(x-yOffsetW,y+xOffset);break;case'star':xOffsetW=Math.cos(rad)*(w?w/2:radius);xOffset=Math.cos(rad)*radius;yOffset=Math.sin(rad)*radius;yOffsetW=Math.sin(rad)*(w?w/2:radius);ctx.moveTo(x-xOffsetW,y-yOffset);ctx.lineTo(x+xOffsetW,y+yOffset);ctx.moveTo(x+yOffsetW,y-xOffset);ctx.lineTo(x-yOffsetW,y+xOffset);rad+=QUARTER_PI;xOffsetW=Math.cos(rad)*(w?w/2:radius);xOffset=Math.cos(rad)*radius;yOffset=Math.sin(rad)*radius;yOffsetW=Math.sin(rad)*(w?w/2:radius);ctx.moveTo(x-xOffsetW,y-yOffset);ctx.lineTo(x+xOffsetW,y+yOffset);ctx.moveTo(x+yOffsetW,y-xOffset);ctx.lineTo(x-yOffsetW,y+xOffset);break;case'line':xOffset=w?w/2:Math.cos(rad)*radius;yOffset=Math.sin(rad)*radius;ctx.moveTo(x-xOffset,y-yOffset);ctx.lineTo(x+xOffset,y+yOffset);break;case'dash':ctx.moveTo(x,y);ctx.lineTo(x+Math.cos(rad)*(w?w/2:radius),y+Math.sin(rad)*radius);break;case false:ctx.closePath();break;}
ctx.fill();if(options.borderWidth>0){ctx.stroke();}}
function _isPointInArea(point,area,margin){margin=margin||0.5;return!area||point&&point.x>area.left-margin&&point.x<area.right+margin&&point.y>area.top-margin&&point.y<area.bottom+margin;}
function clipArea(ctx,area){ctx.save();ctx.beginPath();ctx.rect(area.left,area.top,area.right-area.left,area.bottom-area.top);ctx.clip();}
function unclipArea(ctx){ctx.restore();}
function _steppedLineTo(ctx,previous,target,flip,mode){if(!previous){return ctx.lineTo(target.x,target.y);}
if(mode==='middle'){const midpoint=(previous.x+target.x)/2.0;ctx.lineTo(midpoint,previous.y);ctx.lineTo(midpoint,target.y);}else if(mode==='after'!==!!flip){ctx.lineTo(previous.x,target.y);}else{ctx.lineTo(target.x,previous.y);}
ctx.lineTo(target.x,target.y);}
function _bezierCurveTo(ctx,previous,target,flip){if(!previous){return ctx.lineTo(target.x,target.y);}
ctx.bezierCurveTo(flip?previous.cp1x:previous.cp2x,flip?previous.cp1y:previous.cp2y,flip?target.cp2x:target.cp1x,flip?target.cp2y:target.cp1y,target.x,target.y);}
function setRenderOpts(ctx,opts){if(opts.translation){ctx.translate(opts.translation[0],opts.translation[1]);}
if(!isNullOrUndef(opts.rotation)){ctx.rotate(opts.rotation);}
if(opts.color){ctx.fillStyle=opts.color;}
if(opts.textAlign){ctx.textAlign=opts.textAlign;}
if(opts.textBaseline){ctx.textBaseline=opts.textBaseline;}}
function decorateText(ctx,x,y,line,opts){if(opts.strikethrough||opts.underline){const metrics=ctx.measureText(line);const left=x-metrics.actualBoundingBoxLeft;const right=x+metrics.actualBoundingBoxRight;const top=y-metrics.actualBoundingBoxAscent;const bottom=y+metrics.actualBoundingBoxDescent;const yDecoration=opts.strikethrough?(top+bottom)/2:bottom;ctx.strokeStyle=ctx.fillStyle;ctx.beginPath();ctx.lineWidth=opts.decorationWidth||2;ctx.moveTo(left,yDecoration);ctx.lineTo(right,yDecoration);ctx.stroke();}}
function drawBackdrop(ctx,opts){const oldColor=ctx.fillStyle;ctx.fillStyle=opts.color;ctx.fillRect(opts.left,opts.top,opts.width,opts.height);ctx.fillStyle=oldColor;}
function renderText(ctx,text,x,y,font,opts={}){const lines=isArray(text)?text:[text];const stroke=opts.strokeWidth>0&&opts.strokeColor!=='';let i,line;ctx.save();ctx.font=font.string;setRenderOpts(ctx,opts);for(i=0;i<lines.length;++i){line=lines[i];if(opts.backdrop){drawBackdrop(ctx,opts.backdrop);}
if(stroke){if(opts.strokeColor){ctx.strokeStyle=opts.strokeColor;}
if(!isNullOrUndef(opts.strokeWidth)){ctx.lineWidth=opts.strokeWidth;}
ctx.strokeText(line,x,y,opts.maxWidth);}
ctx.fillText(line,x,y,opts.maxWidth);decorateText(ctx,x,y,line,opts);y+=Number(font.lineHeight);}
ctx.restore();}
function addRoundedRectPath(ctx,rect){const{x,y,w,h,radius}=rect;ctx.arc(x+radius.topLeft,y+radius.topLeft,radius.topLeft,-HALF_PI,PI,true);ctx.lineTo(x,y+h-radius.bottomLeft);ctx.arc(x+radius.bottomLeft,y+h-radius.bottomLeft,radius.bottomLeft,PI,HALF_PI,true);ctx.lineTo(x+w-radius.bottomRight,y+h);ctx.arc(x+w-radius.bottomRight,y+h-radius.bottomRight,radius.bottomRight,HALF_PI,0,true);ctx.lineTo(x+w,y+radius.topRight);ctx.arc(x+w-radius.topRight,y+radius.topRight,radius.topRight,0,-HALF_PI,true);ctx.lineTo(x+radius.topLeft,y);}
function _createResolver(scopes,prefixes=[''],rootScopes,fallback,getTarget=()=>scopes[0]){const finalRootScopes=rootScopes||scopes;if(typeof fallback==='undefined'){fallback=_resolve('_fallback',scopes);}
const cache={[Symbol.toStringTag]:'Object',_cacheable:true,_scopes:scopes,_rootScopes:finalRootScopes,_fallback:fallback,_getTarget:getTarget,override:(scope)=>_createResolver([scope,...scopes],prefixes,finalRootScopes,fallback)};return new Proxy(cache,{deleteProperty(target,prop){delete target[prop];delete target._keys;delete scopes[0][prop];return true;},get(target,prop){return _cached(target,prop,()=>_resolveWithPrefixes(prop,prefixes,scopes,target));},getOwnPropertyDescriptor(target,prop){return Reflect.getOwnPropertyDescriptor(target._scopes[0],prop);},getPrototypeOf(){return Reflect.getPrototypeOf(scopes[0]);},has(target,prop){return getKeysFromAllScopes(target).includes(prop);},ownKeys(target){return getKeysFromAllScopes(target);},set(target,prop,value){const storage=target._storage||(target._storage=getTarget());target[prop]=storage[prop]=value;delete target._keys;return true;}});}
function _attachContext(proxy,context,subProxy,descriptorDefaults){const cache={_cacheable:false,_proxy:proxy,_context:context,_subProxy:subProxy,_stack:new Set(),_descriptors:_descriptors(proxy,descriptorDefaults),setContext:(ctx)=>_attachContext(proxy,ctx,subProxy,descriptorDefaults),override:(scope)=>_attachContext(proxy.override(scope),context,subProxy,descriptorDefaults)};return new Proxy(cache,{deleteProperty(target,prop){delete target[prop];delete proxy[prop];return true;},get(target,prop,receiver){return _cached(target,prop,()=>_resolveWithContext(target,prop,receiver));},getOwnPropertyDescriptor(target,prop){return target._descriptors.allKeys?Reflect.has(proxy,prop)?{enumerable:true,configurable:true}:undefined:Reflect.getOwnPropertyDescriptor(proxy,prop);},getPrototypeOf(){return Reflect.getPrototypeOf(proxy);},has(target,prop){return Reflect.has(proxy,prop);},ownKeys(){return Reflect.ownKeys(proxy);},set(target,prop,value){proxy[prop]=value;delete target[prop];return true;}});}
function _descriptors(proxy,defaults={scriptable:true,indexable:true}){const{_scriptable=defaults.scriptable,_indexable=defaults.indexable,_allKeys=defaults.allKeys}=proxy;return{allKeys:_allKeys,scriptable:_scriptable,indexable:_indexable,isScriptable:isFunction(_scriptable)?_scriptable:()=>_scriptable,isIndexable:isFunction(_indexable)?_indexable:()=>_indexable};}
const readKey=(prefix,name)=>prefix?prefix+_capitalize(name):name;const needsSubResolver=(prop,value)=>isObject(value)&&prop!=='adapters'&&(Object.getPrototypeOf(value)===null||value.constructor===Object);function _cached(target,prop,resolve){if(Object.prototype.hasOwnProperty.call(target,prop)){return target[prop];}
const value=resolve();target[prop]=value;return value;}
function _resolveWithContext(target,prop,receiver){const{_proxy,_context,_subProxy,_descriptors:descriptors}=target;let value=_proxy[prop];if(isFunction(value)&&descriptors.isScriptable(prop)){value=_resolveScriptable(prop,value,target,receiver);}
if(isArray(value)&&value.length){value=_resolveArray(prop,value,target,descriptors.isIndexable);}
if(needsSubResolver(prop,value)){value=_attachContext(value,_context,_subProxy&&_subProxy[prop],descriptors);}
return value;}
function _resolveScriptable(prop,getValue,target,receiver){const{_proxy,_context,_subProxy,_stack}=target;if(_stack.has(prop)){throw new Error('Recursion detected: '+Array.from(_stack).join('->')+'->'+prop);}
_stack.add(prop);let value=getValue(_context,_subProxy||receiver);_stack.delete(prop);if(needsSubResolver(prop,value)){value=createSubResolver(_proxy._scopes,_proxy,prop,value);}
return value;}
function _resolveArray(prop,value,target,isIndexable){const{_proxy,_context,_subProxy,_descriptors:descriptors}=target;if(typeof _context.index!=='undefined'&&isIndexable(prop)){return value[_context.index%value.length];}else if(isObject(value[0])){const arr=value;const scopes=_proxy._scopes.filter((s)=>s!==arr);value=[];for(const item of arr){const resolver=createSubResolver(scopes,_proxy,prop,item);value.push(_attachContext(resolver,_context,_subProxy&&_subProxy[prop],descriptors));}}
return value;}
function resolveFallback(fallback,prop,value){return isFunction(fallback)?fallback(prop,value):fallback;}
const getScope=(key,parent)=>key===true?parent:typeof key==='string'?resolveObjectKey(parent,key):undefined;function addScopes(set,parentScopes,key,parentFallback,value){for(const parent of parentScopes){const scope=getScope(key,parent);if(scope){set.add(scope);const fallback=resolveFallback(scope._fallback,key,value);if(typeof fallback!=='undefined'&&fallback!==key&&fallback!==parentFallback){return fallback;}}else if(scope===false&&typeof parentFallback!=='undefined'&&key!==parentFallback){return null;}}
return false;}
function createSubResolver(parentScopes,resolver,prop,value){const rootScopes=resolver._rootScopes;const fallback=resolveFallback(resolver._fallback,prop,value);const allScopes=[...parentScopes,...rootScopes];const set=new Set();set.add(value);let key=addScopesFromKey(set,allScopes,prop,fallback||prop,value);if(key===null){return false;}
if(typeof fallback!=='undefined'&&fallback!==prop){key=addScopesFromKey(set,allScopes,fallback,key,value);if(key===null){return false;}}
return _createResolver(Array.from(set),[''],rootScopes,fallback,()=>subGetTarget(resolver,prop,value));}
function addScopesFromKey(set,allScopes,key,fallback,item){while(key){key=addScopes(set,allScopes,key,fallback,item);}
return key;}
function subGetTarget(resolver,prop,value){const parent=resolver._getTarget();if(!(prop in parent)){parent[prop]={};}
const target=parent[prop];if(isArray(target)&&isObject(value)){return value;}
return target||{};}
function _resolveWithPrefixes(prop,prefixes,scopes,proxy){let value;for(const prefix of prefixes){value=_resolve(readKey(prefix,prop),scopes);if(typeof value!=='undefined'){return needsSubResolver(prop,value)?createSubResolver(scopes,proxy,prop,value):value;}}}
function _resolve(key,scopes){for(const scope of scopes){if(!scope){continue;}
const value=scope[key];if(typeof value!=='undefined'){return value;}}}
function getKeysFromAllScopes(target){let keys=target._keys;if(!keys){keys=target._keys=resolveKeysFromAllScopes(target._scopes);}
return keys;}
function resolveKeysFromAllScopes(scopes){const set=new Set();for(const scope of scopes){for(const key of Object.keys(scope).filter((k)=>!k.startsWith('_'))){set.add(key);}}
return Array.from(set);}
function _parseObjectDataRadialScale(meta,data,start,count){const{iScale}=meta;const{key='r'}=this._parsing;const parsed=new Array(count);let i,ilen,index,item;for(i=0,ilen=count;i<ilen;++i){index=i+start;item=data[index];parsed[i]={r:iScale.parse(resolveObjectKey(item,key),index)};}
return parsed;}
const EPSILON=Number.EPSILON||1e-14;const getPoint=(points,i)=>i<points.length&&!points[i].skip&&points[i];const getValueAxis=(indexAxis)=>indexAxis==='x'?'y':'x';function splineCurve(firstPoint,middlePoint,afterPoint,t){const previous=firstPoint.skip?middlePoint:firstPoint;const current=middlePoint;const next=afterPoint.skip?middlePoint:afterPoint;const d01=distanceBetweenPoints(current,previous);const d12=distanceBetweenPoints(next,current);let s01=d01/(d01+d12);let s12=d12/(d01+d12);s01=isNaN(s01)?0:s01;s12=isNaN(s12)?0:s12;const fa=t*s01;const fb=t*s12;return{previous:{x:current.x-fa*(next.x-previous.x),y:current.y-fa*(next.y-previous.y)},next:{x:current.x+fb*(next.x-previous.x),y:current.y+fb*(next.y-previous.y)}};}
function monotoneAdjust(points,deltaK,mK){const pointsLen=points.length;let alphaK,betaK,tauK,squaredMagnitude,pointCurrent;let pointAfter=getPoint(points,0);for(let i=0;i<pointsLen-1;++i){pointCurrent=pointAfter;pointAfter=getPoint(points,i+1);if(!pointCurrent||!pointAfter){continue;}
if(almostEquals(deltaK[i],0,EPSILON)){mK[i]=mK[i+1]=0;continue;}
alphaK=mK[i]/deltaK[i];betaK=mK[i+1]/deltaK[i];squaredMagnitude=Math.pow(alphaK,2)+Math.pow(betaK,2);if(squaredMagnitude<=9){continue;}
tauK=3/Math.sqrt(squaredMagnitude);mK[i]=alphaK*tauK*deltaK[i];mK[i+1]=betaK*tauK*deltaK[i];}}
function monotoneCompute(points,mK,indexAxis='x'){const valueAxis=getValueAxis(indexAxis);const pointsLen=points.length;let delta,pointBefore,pointCurrent;let pointAfter=getPoint(points,0);for(let i=0;i<pointsLen;++i){pointBefore=pointCurrent;pointCurrent=pointAfter;pointAfter=getPoint(points,i+1);if(!pointCurrent){continue;}
const iPixel=pointCurrent[indexAxis];const vPixel=pointCurrent[valueAxis];if(pointBefore){delta=(iPixel-pointBefore[indexAxis])/3;pointCurrent[`cp1${indexAxis}`]=iPixel-delta;pointCurrent[`cp1${valueAxis}`]=vPixel-delta*mK[i];}
if(pointAfter){delta=(pointAfter[indexAxis]-iPixel)/3;pointCurrent[`cp2${indexAxis}`]=iPixel+delta;pointCurrent[`cp2${valueAxis}`]=vPixel+delta*mK[i];}}}
function splineCurveMonotone(points,indexAxis='x'){const valueAxis=getValueAxis(indexAxis);const pointsLen=points.length;const deltaK=Array(pointsLen).fill(0);const mK=Array(pointsLen);let i,pointBefore,pointCurrent;let pointAfter=getPoint(points,0);for(i=0;i<pointsLen;++i){pointBefore=pointCurrent;pointCurrent=pointAfter;pointAfter=getPoint(points,i+1);if(!pointCurrent){continue;}
if(pointAfter){const slopeDelta=pointAfter[indexAxis]-pointCurrent[indexAxis];deltaK[i]=slopeDelta!==0?(pointAfter[valueAxis]-pointCurrent[valueAxis])/slopeDelta:0;}
mK[i]=!pointBefore?deltaK[i]:!pointAfter?deltaK[i-1]:sign(deltaK[i-1])!==sign(deltaK[i])?0:(deltaK[i-1]+deltaK[i])/2;}
monotoneAdjust(points,deltaK,mK);monotoneCompute(points,mK,indexAxis);}
function capControlPoint(pt,min,max){return Math.max(Math.min(pt,max),min);}
function capBezierPoints(points,area){let i,ilen,point,inArea,inAreaPrev;let inAreaNext=_isPointInArea(points[0],area);for(i=0,ilen=points.length;i<ilen;++i){inAreaPrev=inArea;inArea=inAreaNext;inAreaNext=i<ilen-1&&_isPointInArea(points[i+1],area);if(!inArea){continue;}
point=points[i];if(inAreaPrev){point.cp1x=capControlPoint(point.cp1x,area.left,area.right);point.cp1y=capControlPoint(point.cp1y,area.top,area.bottom);}
if(inAreaNext){point.cp2x=capControlPoint(point.cp2x,area.left,area.right);point.cp2y=capControlPoint(point.cp2y,area.top,area.bottom);}}}
function _updateBezierControlPoints(points,options,area,loop,indexAxis){let i,ilen,point,controlPoints;if(options.spanGaps){points=points.filter((pt)=>!pt.skip);}
if(options.cubicInterpolationMode==='monotone'){splineCurveMonotone(points,indexAxis);}else{let prev=loop?points[points.length-1]:points[0];for(i=0,ilen=points.length;i<ilen;++i){point=points[i];controlPoints=splineCurve(prev,point,points[Math.min(i+1,ilen-(loop?0:1))%ilen],options.tension);point.cp1x=controlPoints.previous.x;point.cp1y=controlPoints.previous.y;point.cp2x=controlPoints.next.x;point.cp2y=controlPoints.next.y;prev=point;}}
if(options.capBezierPoints){capBezierPoints(points,area);}}
const atEdge=(t)=>t===0||t===1;const elasticIn=(t,s,p)=>-(Math.pow(2,10*(t-=1))*Math.sin((t-s)*TAU/p));const elasticOut=(t,s,p)=>Math.pow(2,-10*t)*Math.sin((t-s)*TAU/p)+1;const effects={linear:(t)=>t,easeInQuad:(t)=>t*t,easeOutQuad:(t)=>-t*(t-2),easeInOutQuad:(t)=>(t/=0.5)<1?0.5*t*t:-0.5*(--t*(t-2)-1),easeInCubic:(t)=>t*t*t,easeOutCubic:(t)=>(t-=1)*t*t+1,easeInOutCubic:(t)=>(t/=0.5)<1?0.5*t*t*t:0.5*((t-=2)*t*t+2),easeInQuart:(t)=>t*t*t*t,easeOutQuart:(t)=>-((t-=1)*t*t*t-1),easeInOutQuart:(t)=>(t/=0.5)<1?0.5*t*t*t*t:-0.5*((t-=2)*t*t*t-2),easeInQuint:(t)=>t*t*t*t*t,easeOutQuint:(t)=>(t-=1)*t*t*t*t+1,easeInOutQuint:(t)=>(t/=0.5)<1?0.5*t*t*t*t*t:0.5*((t-=2)*t*t*t*t+2),easeInSine:(t)=>-Math.cos(t*HALF_PI)+1,easeOutSine:(t)=>Math.sin(t*HALF_PI),easeInOutSine:(t)=>-0.5*(Math.cos(PI*t)-1),easeInExpo:(t)=>t===0?0:Math.pow(2,10*(t-1)),easeOutExpo:(t)=>t===1?1:-Math.pow(2,-10*t)+1,easeInOutExpo:(t)=>atEdge(t)?t:t<0.5?0.5*Math.pow(2,10*(t*2-1)):0.5*(-Math.pow(2,-10*(t*2-1))+2),easeInCirc:(t)=>t>=1?t:-(Math.sqrt(1-t*t)-1),easeOutCirc:(t)=>Math.sqrt(1-(t-=1)*t),easeInOutCirc:(t)=>(t/=0.5)<1?-0.5*(Math.sqrt(1-t*t)-1):0.5*(Math.sqrt(1-(t-=2)*t)+1),easeInElastic:(t)=>atEdge(t)?t:elasticIn(t,0.075,0.3),easeOutElastic:(t)=>atEdge(t)?t:elasticOut(t,0.075,0.3),easeInOutElastic(t){const s=0.1125;const p=0.45;return atEdge(t)?t:t<0.5?0.5*elasticIn(t*2,s,p):0.5+0.5*elasticOut(t*2-1,s,p);},easeInBack(t){const s=1.70158;return t*t*((s+1)*t-s);},easeOutBack(t){const s=1.70158;return(t-=1)*t*((s+1)*t+s)+1;},easeInOutBack(t){let s=1.70158;if((t/=0.5)<1){return 0.5*(t*t*(((s*=1.525)+1)*t-s));}
return 0.5*((t-=2)*t*(((s*=1.525)+1)*t+s)+2);},easeInBounce:(t)=>1-effects.easeOutBounce(1-t),easeOutBounce(t){const m=7.5625;const d=2.75;if(t<1/d){return m*t*t;}
if(t<2/d){return m*(t-=1.5/d)*t+0.75;}
if(t<2.5/d){return m*(t-=2.25/d)*t+0.9375;}
return m*(t-=2.625/d)*t+0.984375;},easeInOutBounce:(t)=>t<0.5?effects.easeInBounce(t*2)*0.5:effects.easeOutBounce(t*2-1)*0.5+0.5};function _pointInLine(p1,p2,t,mode){return{x:p1.x+t*(p2.x-p1.x),y:p1.y+t*(p2.y-p1.y)};}
function _steppedInterpolation(p1,p2,t,mode){return{x:p1.x+t*(p2.x-p1.x),y:mode==='middle'?t<0.5?p1.y:p2.y:mode==='after'?t<1?p1.y:p2.y:t>0?p2.y:p1.y};}
function _bezierInterpolation(p1,p2,t,mode){const cp1={x:p1.cp2x,y:p1.cp2y};const cp2={x:p2.cp1x,y:p2.cp1y};const a=_pointInLine(p1,cp1,t);const b=_pointInLine(cp1,cp2,t);const c=_pointInLine(cp2,p2,t);const d=_pointInLine(a,b,t);const e=_pointInLine(b,c,t);return _pointInLine(d,e,t);}
const LINE_HEIGHT=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/;const FONT_STYLE=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function toLineHeight(value,size){const matches=(''+value).match(LINE_HEIGHT);if(!matches||matches[1]==='normal'){return size*1.2;}
value=+matches[2];switch(matches[3]){case'px':return value;case'%':value/=100;break;}
return size*value;}
const numberOrZero=(v)=>+v||0;function _readValueToProps(value,props){const ret={};const objProps=isObject(props);const keys=objProps?Object.keys(props):props;const read=isObject(value)?objProps?(prop)=>valueOrDefault(value[prop],value[props[prop]]):(prop)=>value[prop]:()=>value;for(const prop of keys){ret[prop]=numberOrZero(read(prop));}
return ret;}
function toTRBL(value){return _readValueToProps(value,{top:'y',right:'x',bottom:'y',left:'x'});}
function toTRBLCorners(value){return _readValueToProps(value,['topLeft','topRight','bottomLeft','bottomRight']);}
function toPadding(value){const obj=toTRBL(value);obj.width=obj.left+obj.right;obj.height=obj.top+obj.bottom;return obj;}
function toFont(options,fallback){options=options||{};fallback=fallback||defaults.font;let size=valueOrDefault(options.size,fallback.size);if(typeof size==='string'){size=parseInt(size,10);}
let style=valueOrDefault(options.style,fallback.style);if(style&&!(''+style).match(FONT_STYLE)){console.warn('Invalid font style specified: "'+style+'"');style=undefined;}
const font={family:valueOrDefault(options.family,fallback.family),lineHeight:toLineHeight(valueOrDefault(options.lineHeight,fallback.lineHeight),size),size,style,weight:valueOrDefault(options.weight,fallback.weight),string:''};font.string=toFontString(font);return font;}
function resolve(inputs,context,index,info){let cacheable=true;let i,ilen,value;for(i=0,ilen=inputs.length;i<ilen;++i){value=inputs[i];if(value===undefined){continue;}
if(context!==undefined&&typeof value==='function'){value=value(context);cacheable=false;}
if(index!==undefined&&isArray(value)){value=value[index%value.length];cacheable=false;}
if(value!==undefined){if(info&&!cacheable){info.cacheable=false;}
return value;}}}
function _addGrace(minmax,grace,beginAtZero){const{min,max}=minmax;const change=toDimension(grace,(max-min)/2);const keepZero=(value,add)=>beginAtZero&&value===0?0:value+add;return{min:keepZero(min,-Math.abs(change)),max:keepZero(max,change)};}
function createContext(parentContext,context){return Object.assign(Object.create(parentContext),context);}
const getRightToLeftAdapter=function(rectX,width){return{x(x){return rectX+rectX+width-x;},setWidth(w){width=w;},textAlign(align){if(align==='center'){return align;}
return align==='right'?'left':'right';},xPlus(x,value){return x-value;},leftForLtr(x,itemWidth){return x-itemWidth;}};};const getLeftToRightAdapter=function(){return{x(x){return x;},setWidth(w){},textAlign(align){return align;},xPlus(x,value){return x+value;},leftForLtr(x,_itemWidth){return x;}};};function getRtlAdapter(rtl,rectX,width){return rtl?getRightToLeftAdapter(rectX,width):getLeftToRightAdapter();}
function overrideTextDirection(ctx,direction){let style,original;if(direction==='ltr'||direction==='rtl'){style=ctx.canvas.style;original=[style.getPropertyValue('direction'),style.getPropertyPriority('direction')];style.setProperty('direction',direction,'important');ctx.prevTextDirection=original;}}
function restoreTextDirection(ctx,original){if(original!==undefined){delete ctx.prevTextDirection;ctx.canvas.style.setProperty('direction',original[0],original[1]);}}
function propertyFn(property){if(property==='angle'){return{between:_angleBetween,compare:_angleDiff,normalize:_normalizeAngle};}
return{between:_isBetween,compare:(a,b)=>a-b,normalize:(x)=>x};}
function normalizeSegment({start,end,count,loop,style}){return{start:start%count,end:end%count,loop:loop&&(end-start+1)%count===0,style};}
function getSegment(segment,points,bounds){const{property,start:startBound,end:endBound}=bounds;const{between,normalize}=propertyFn(property);const count=points.length;let{start,end,loop}=segment;let i,ilen;if(loop){start+=count;end+=count;for(i=0,ilen=count;i<ilen;++i){if(!between(normalize(points[start%count][property]),startBound,endBound)){break;}
start--;end--;}
start%=count;end%=count;}
if(end<start){end+=count;}
return{start,end,loop,style:segment.style};}
function _boundSegment(segment,points,bounds){if(!bounds){return[segment];}
const{property,start:startBound,end:endBound}=bounds;const count=points.length;const{compare,between,normalize}=propertyFn(property);const{start,end,loop,style}=getSegment(segment,points,bounds);const result=[];let inside=false;let subStart=null;let value,point,prevValue;const startIsBefore=()=>between(startBound,prevValue,value)&&compare(startBound,prevValue)!==0;const endIsBefore=()=>compare(endBound,value)===0||between(endBound,prevValue,value);const shouldStart=()=>inside||startIsBefore();const shouldStop=()=>!inside||endIsBefore();for(let i=start,prev=start;i<=end;++i){point=points[i%count];if(point.skip){continue;}
value=normalize(point[property]);if(value===prevValue){continue;}
inside=between(value,startBound,endBound);if(subStart===null&&shouldStart()){subStart=compare(value,startBound)===0?i:prev;}
if(subStart!==null&&shouldStop()){result.push(normalizeSegment({start:subStart,end:i,loop,count,style}));subStart=null;}
prev=i;prevValue=value;}
if(subStart!==null){result.push(normalizeSegment({start:subStart,end,loop,count,style}));}
return result;}
function _boundSegments(line,bounds){const result=[];const segments=line.segments;for(let i=0;i<segments.length;i++){const sub=_boundSegment(segments[i],line.points,bounds);if(sub.length){result.push(...sub);}}
return result;}
function findStartAndEnd(points,count,loop,spanGaps){let start=0;let end=count-1;if(loop&&!spanGaps){while(start<count&&!points[start].skip){start++;}}
while(start<count&&points[start].skip){start++;}
start%=count;if(loop){end+=start;}
while(end>start&&points[end%count].skip){end--;}
end%=count;return{start,end};}
function solidSegments(points,start,max,loop){const count=points.length;const result=[];let last=start;let prev=points[start];let end;for(end=start+1;end<=max;++end){const cur=points[end%count];if(cur.skip||cur.stop){if(!prev.skip){loop=false;result.push({start:start%count,end:(end-1)%count,loop});start=last=cur.stop?end:null;}}else{last=end;if(prev.skip){start=end;}}
prev=cur;}
if(last!==null){result.push({start:start%count,end:last%count,loop});}
return result;}
function _computeSegments(line,segmentOptions){const points=line.points;const spanGaps=line.options.spanGaps;const count=points.length;if(!count){return[];}
const loop=!!line._loop;const{start,end}=findStartAndEnd(points,count,loop,spanGaps);if(spanGaps===true){return splitByStyles(line,[{start,end,loop}],points,segmentOptions);}
const max=end<start?end+count:end;const completeLoop=!!line._fullLoop&&start===0&&end===count-1;return splitByStyles(line,solidSegments(points,start,max,completeLoop),points,segmentOptions);}
function splitByStyles(line,segments,points,segmentOptions){if(!segmentOptions||!segmentOptions.setContext||!points){return segments;}
return doSplitByStyles(line,segments,points,segmentOptions);}
function doSplitByStyles(line,segments,points,segmentOptions){const chartContext=line._chart.getContext();const baseStyle=readStyle(line.options);const{_datasetIndex:datasetIndex,options:{spanGaps}}=line;const count=points.length;const result=[];let prevStyle=baseStyle;let start=segments[0].start;let i=start;function addStyle(s,e,l,st){const dir=spanGaps?-1:1;if(s===e){return;}
s+=count;while(points[s%count].skip){s-=dir;}
while(points[e%count].skip){e+=dir;}
if(s%count!==e%count){result.push({start:s%count,end:e%count,loop:l,style:st});prevStyle=st;start=e%count;}}
for(const segment of segments){start=spanGaps?start:segment.start;let prev=points[start%count];let style;for(i=start+1;i<=segment.end;i++){const pt=points[i%count];style=readStyle(segmentOptions.setContext(createContext(chartContext,{type:'segment',p0:prev,p1:pt,p0DataIndex:(i-1)%count,p1DataIndex:i%count,datasetIndex})));if(styleChanged(style,prevStyle)){addStyle(start,i-1,segment.loop,prevStyle);}
prev=pt;prevStyle=style;}
if(start<i-1){addStyle(start,i-1,segment.loop,prevStyle);}}
return result;}
function readStyle(options){return{backgroundColor:options.backgroundColor,borderCapStyle:options.borderCapStyle,borderDash:options.borderDash,borderDashOffset:options.borderDashOffset,borderJoinStyle:options.borderJoinStyle,borderWidth:options.borderWidth,borderColor:options.borderColor};}
function styleChanged(style,prevStyle){if(!prevStyle){return false;}
const cache=[];const replacer=function(key,value){if(!isPatternOrGradient(value)){return value;}
if(!cache.includes(value)){cache.push(value);}
return cache.indexOf(value);};return JSON.stringify(style,replacer)!==JSON.stringify(prevStyle,replacer);}
var helpers=Object.freeze({__proto__:null,HALF_PI:HALF_PI,INFINITY:INFINITY,PI:PI,PITAU:PITAU,QUARTER_PI:QUARTER_PI,RAD_PER_DEG:RAD_PER_DEG,TAU:TAU,TWO_THIRDS_PI:TWO_THIRDS_PI,_addGrace:_addGrace,_alignPixel:_alignPixel,_alignStartEnd:_alignStartEnd,_angleBetween:_angleBetween,_angleDiff:_angleDiff,_arrayUnique:_arrayUnique,_attachContext:_attachContext,_bezierCurveTo:_bezierCurveTo,_bezierInterpolation:_bezierInterpolation,_boundSegment:_boundSegment,_boundSegments:_boundSegments,_capitalize:_capitalize,_computeSegments:_computeSegments,_createResolver:_createResolver,_decimalPlaces:_decimalPlaces,_deprecated:_deprecated,_descriptors:_descriptors,_elementsEqual:_elementsEqual,_factorize:_factorize,_filterBetween:_filterBetween,_getParentNode:_getParentNode,_getStartAndCountOfVisiblePoints:_getStartAndCountOfVisiblePoints,_int16Range:_int16Range,_isBetween:_isBetween,_isClickEvent:_isClickEvent,_isDomSupported:_isDomSupported,_isPointInArea:_isPointInArea,_limitValue:_limitValue,_longestText:_longestText,_lookup:_lookup,_lookupByKey:_lookupByKey,_measureText:_measureText,_merger:_merger,_mergerIf:_mergerIf,_normalizeAngle:_normalizeAngle,_parseObjectDataRadialScale:_parseObjectDataRadialScale,_pointInLine:_pointInLine,_readValueToProps:_readValueToProps,_rlookupByKey:_rlookupByKey,_scaleRangesChanged:_scaleRangesChanged,_setMinAndMaxByKey:_setMinAndMaxByKey,_splitKey:_splitKey,_steppedInterpolation:_steppedInterpolation,_steppedLineTo:_steppedLineTo,_textX:_textX,_toLeftRightCenter:_toLeftRightCenter,_updateBezierControlPoints:_updateBezierControlPoints,addRoundedRectPath:addRoundedRectPath,almostEquals:almostEquals,almostWhole:almostWhole,callback:callback,clearCanvas:clearCanvas,clipArea:clipArea,clone:clone$1,color:color,createContext:createContext,debounce:debounce,defined:defined,distanceBetweenPoints:distanceBetweenPoints,drawPoint:drawPoint,drawPointLegend:drawPointLegend,each:each,easingEffects:effects,finiteOrDefault:finiteOrDefault,fontString:fontString,formatNumber:formatNumber,getAngleFromPoint:getAngleFromPoint,getHoverColor:getHoverColor,getMaximumSize:getMaximumSize,getRelativePosition:getRelativePosition,getRtlAdapter:getRtlAdapter,getStyle:getStyle,isArray:isArray,isFinite:isNumberFinite,isFunction:isFunction,isNullOrUndef:isNullOrUndef,isNumber:isNumber,isObject:isObject,isPatternOrGradient:isPatternOrGradient,listenArrayEvents:listenArrayEvents,log10:log10,merge:merge,mergeIf:mergeIf,niceNum:niceNum,noop:noop,overrideTextDirection:overrideTextDirection,readUsedSize:readUsedSize,renderText:renderText,requestAnimFrame:requestAnimFrame,resolve:resolve,resolveObjectKey:resolveObjectKey,restoreTextDirection:restoreTextDirection,retinaScale:retinaScale,setsEqual:setsEqual,sign:sign,splineCurve:splineCurve,splineCurveMonotone:splineCurveMonotone,supportsEventListenerOptions:supportsEventListenerOptions,throttled:throttled,toDegrees:toDegrees,toDimension:toDimension,toFont:toFont,toFontString:toFontString,toLineHeight:toLineHeight,toPadding:toPadding,toPercentage:toPercentage,toRadians:toRadians,toTRBL:toTRBL,toTRBLCorners:toTRBLCorners,uid:uid,unclipArea:unclipArea,unlistenArrayEvents:unlistenArrayEvents,valueOrDefault:valueOrDefault});function binarySearch(metaset,axis,value,intersect){const{controller,data,_sorted}=metaset;const iScale=controller._cachedMeta.iScale;if(iScale&&axis===iScale.axis&&axis!=='r'&&_sorted&&data.length){const lookupMethod=iScale._reversePixels?_rlookupByKey:_lookupByKey;if(!intersect){return lookupMethod(data,axis,value);}else if(controller._sharedOptions){const el=data[0];const range=typeof el.getRange==='function'&&el.getRange(axis);if(range){const start=lookupMethod(data,axis,value-range);const end=lookupMethod(data,axis,value+range);return{lo:start.lo,hi:end.hi};}}}
return{lo:0,hi:data.length-1};}
function evaluateInteractionItems(chart,axis,position,handler,intersect){const metasets=chart.getSortedVisibleDatasetMetas();const value=position[axis];for(let i=0,ilen=metasets.length;i<ilen;++i){const{index,data}=metasets[i];const{lo,hi}=binarySearch(metasets[i],axis,value,intersect);for(let j=lo;j<=hi;++j){const element=data[j];if(!element.skip){handler(element,index,j);}}}}
function getDistanceMetricForAxis(axis){const useX=axis.indexOf('x')!==-1;const useY=axis.indexOf('y')!==-1;return function(pt1,pt2){const deltaX=useX?Math.abs(pt1.x-pt2.x):0;const deltaY=useY?Math.abs(pt1.y-pt2.y):0;return Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2));};}
function getIntersectItems(chart,position,axis,useFinalPosition,includeInvisible){const items=[];if(!includeInvisible&&!chart.isPointInArea(position)){return items;}
const evaluationFunc=function(element,datasetIndex,index){if(!includeInvisible&&!_isPointInArea(element,chart.chartArea,0)){return;}
if(element.inRange(position.x,position.y,useFinalPosition)){items.push({element,datasetIndex,index});}};evaluateInteractionItems(chart,axis,position,evaluationFunc,true);return items;}
function getNearestRadialItems(chart,position,axis,useFinalPosition){let items=[];function evaluationFunc(element,datasetIndex,index){const{startAngle,endAngle}=element.getProps(['startAngle','endAngle'],useFinalPosition);const{angle}=getAngleFromPoint(element,{x:position.x,y:position.y});if(_angleBetween(angle,startAngle,endAngle)){items.push({element,datasetIndex,index});}}
evaluateInteractionItems(chart,axis,position,evaluationFunc);return items;}
function getNearestCartesianItems(chart,position,axis,intersect,useFinalPosition,includeInvisible){let items=[];const distanceMetric=getDistanceMetricForAxis(axis);let minDistance=Number.POSITIVE_INFINITY;function evaluationFunc(element,datasetIndex,index){const inRange=element.inRange(position.x,position.y,useFinalPosition);if(intersect&&!inRange){return;}
const center=element.getCenterPoint(useFinalPosition);const pointInArea=!!includeInvisible||chart.isPointInArea(center);if(!pointInArea&&!inRange){return;}
const distance=distanceMetric(position,center);if(distance<minDistance){items=[{element,datasetIndex,index}];minDistance=distance;}else if(distance===minDistance){items.push({element,datasetIndex,index});}}
evaluateInteractionItems(chart,axis,position,evaluationFunc);return items;}
function getNearestItems(chart,position,axis,intersect,useFinalPosition,includeInvisible){if(!includeInvisible&&!chart.isPointInArea(position)){return[];}
return axis==='r'&&!intersect?getNearestRadialItems(chart,position,axis,useFinalPosition):getNearestCartesianItems(chart,position,axis,intersect,useFinalPosition,includeInvisible);}
function getAxisItems(chart,position,axis,intersect,useFinalPosition){const items=[];const rangeMethod=axis==='x'?'inXRange':'inYRange';let intersectsItem=false;evaluateInteractionItems(chart,axis,position,(element,datasetIndex,index)=>{if(element[rangeMethod](position[axis],useFinalPosition)){items.push({element,datasetIndex,index});intersectsItem=intersectsItem||element.inRange(position.x,position.y,useFinalPosition);}});if(intersect&&!intersectsItem){return[];}
return items;}
var Interaction={evaluateInteractionItems,modes:{index(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);const axis=options.axis||'x';const includeInvisible=options.includeInvisible||false;const items=options.intersect?getIntersectItems(chart,position,axis,useFinalPosition,includeInvisible):getNearestItems(chart,position,axis,false,useFinalPosition,includeInvisible);const elements=[];if(!items.length){return[];}
chart.getSortedVisibleDatasetMetas().forEach((meta)=>{const index=items[0].index;const element=meta.data[index];if(element&&!element.skip){elements.push({element,datasetIndex:meta.index,index});}});return elements;},dataset(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);const axis=options.axis||'xy';const includeInvisible=options.includeInvisible||false;let items=options.intersect?getIntersectItems(chart,position,axis,useFinalPosition,includeInvisible):getNearestItems(chart,position,axis,false,useFinalPosition,includeInvisible);if(items.length>0){const datasetIndex=items[0].datasetIndex;const data=chart.getDatasetMeta(datasetIndex).data;items=[];for(let i=0;i<data.length;++i){items.push({element:data[i],datasetIndex,index:i});}}
return items;},point(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);const axis=options.axis||'xy';const includeInvisible=options.includeInvisible||false;return getIntersectItems(chart,position,axis,useFinalPosition,includeInvisible);},nearest(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);const axis=options.axis||'xy';const includeInvisible=options.includeInvisible||false;return getNearestItems(chart,position,axis,options.intersect,useFinalPosition,includeInvisible);},x(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);return getAxisItems(chart,position,'x',options.intersect,useFinalPosition);},y(chart,e,options,useFinalPosition){const position=getRelativePosition(e,chart);return getAxisItems(chart,position,'y',options.intersect,useFinalPosition);}}};const STATIC_POSITIONS=['left','top','right','bottom'];function filterByPosition(array,position){return array.filter((v)=>v.pos===position);}
function filterDynamicPositionByAxis(array,axis){return array.filter((v)=>STATIC_POSITIONS.indexOf(v.pos)===-1&&v.box.axis===axis);}
function sortByWeight(array,reverse){return array.sort((a,b)=>{const v0=reverse?b:a;const v1=reverse?a:b;return v0.weight===v1.weight?v0.index-v1.index:v0.weight-v1.weight;});}
function wrapBoxes(boxes){const layoutBoxes=[];let i,ilen,box,pos,stack,stackWeight;for(i=0,ilen=(boxes||[]).length;i<ilen;++i){box=boxes[i];({position:pos,options:{stack,stackWeight=1}}=box);layoutBoxes.push({index:i,box,pos,horizontal:box.isHorizontal(),weight:box.weight,stack:stack&&pos+stack,stackWeight});}
return layoutBoxes;}
function buildStacks(layouts){const stacks={};for(const wrap of layouts){const{stack,pos,stackWeight}=wrap;if(!stack||!STATIC_POSITIONS.includes(pos)){continue;}
const _stack=stacks[stack]||(stacks[stack]={count:0,placed:0,weight:0,size:0});_stack.count++;_stack.weight+=stackWeight;}
return stacks;}
function setLayoutDims(layouts,params){const stacks=buildStacks(layouts);const{vBoxMaxWidth,hBoxMaxHeight}=params;let i,ilen,layout;for(i=0,ilen=layouts.length;i<ilen;++i){layout=layouts[i];const{fullSize}=layout.box;const stack=stacks[layout.stack];const factor=stack&&layout.stackWeight/stack.weight;if(layout.horizontal){layout.width=factor?factor*vBoxMaxWidth:fullSize&&params.availableWidth;layout.height=hBoxMaxHeight;}else{layout.width=vBoxMaxWidth;layout.height=factor?factor*hBoxMaxHeight:fullSize&&params.availableHeight;}}
return stacks;}
function buildLayoutBoxes(boxes){const layoutBoxes=wrapBoxes(boxes);const fullSize=sortByWeight(layoutBoxes.filter((wrap)=>wrap.box.fullSize),true);const left=sortByWeight(filterByPosition(layoutBoxes,'left'),true);const right=sortByWeight(filterByPosition(layoutBoxes,'right'));const top=sortByWeight(filterByPosition(layoutBoxes,'top'),true);const bottom=sortByWeight(filterByPosition(layoutBoxes,'bottom'));const centerHorizontal=filterDynamicPositionByAxis(layoutBoxes,'x');const centerVertical=filterDynamicPositionByAxis(layoutBoxes,'y');return{fullSize,leftAndTop:left.concat(top),rightAndBottom:right.concat(centerVertical).concat(bottom).concat(centerHorizontal),chartArea:filterByPosition(layoutBoxes,'chartArea'),vertical:left.concat(right).concat(centerVertical),horizontal:top.concat(bottom).concat(centerHorizontal)};}
function getCombinedMax(maxPadding,chartArea,a,b){return Math.max(maxPadding[a],chartArea[a])+Math.max(maxPadding[b],chartArea[b]);}
function updateMaxPadding(maxPadding,boxPadding){maxPadding.top=Math.max(maxPadding.top,boxPadding.top);maxPadding.left=Math.max(maxPadding.left,boxPadding.left);maxPadding.bottom=Math.max(maxPadding.bottom,boxPadding.bottom);maxPadding.right=Math.max(maxPadding.right,boxPadding.right);}
function updateDims(chartArea,params,layout,stacks){const{pos,box}=layout;const maxPadding=chartArea.maxPadding;if(!isObject(pos)){if(layout.size){chartArea[pos]-=layout.size;}
const stack=stacks[layout.stack]||{size:0,count:1};stack.size=Math.max(stack.size,layout.horizontal?box.height:box.width);layout.size=stack.size/stack.count;chartArea[pos]+=layout.size;}
if(box.getPadding){updateMaxPadding(maxPadding,box.getPadding());}
const newWidth=Math.max(0,params.outerWidth-getCombinedMax(maxPadding,chartArea,'left','right'));const newHeight=Math.max(0,params.outerHeight-getCombinedMax(maxPadding,chartArea,'top','bottom'));const widthChanged=newWidth!==chartArea.w;const heightChanged=newHeight!==chartArea.h;chartArea.w=newWidth;chartArea.h=newHeight;return layout.horizontal?{same:widthChanged,other:heightChanged}:{same:heightChanged,other:widthChanged};}
function handleMaxPadding(chartArea){const maxPadding=chartArea.maxPadding;function updatePos(pos){const change=Math.max(maxPadding[pos]-chartArea[pos],0);chartArea[pos]+=change;return change;}
chartArea.y+=updatePos('top');chartArea.x+=updatePos('left');updatePos('right');updatePos('bottom');}
function getMargins(horizontal,chartArea){const maxPadding=chartArea.maxPadding;function marginForPositions(positions){const margin={left:0,top:0,right:0,bottom:0};positions.forEach((pos)=>{margin[pos]=Math.max(chartArea[pos],maxPadding[pos]);});return margin;}
return horizontal?marginForPositions(['left','right']):marginForPositions(['top','bottom']);}
function fitBoxes(boxes,chartArea,params,stacks){const refitBoxes=[];let i,ilen,layout,box,refit,changed;for(i=0,ilen=boxes.length,refit=0;i<ilen;++i){layout=boxes[i];box=layout.box;box.update(layout.width||chartArea.w,layout.height||chartArea.h,getMargins(layout.horizontal,chartArea));const{same,other}=updateDims(chartArea,params,layout,stacks);refit|=same&&refitBoxes.length;changed=changed||other;if(!box.fullSize){refitBoxes.push(layout);}}
return refit&&fitBoxes(refitBoxes,chartArea,params,stacks)||changed;}
function setBoxDims(box,left,top,width,height){box.top=top;box.left=left;box.right=left+width;box.bottom=top+height;box.width=width;box.height=height;}
function placeBoxes(boxes,chartArea,params,stacks){const userPadding=params.padding;let{x,y}=chartArea;for(const layout of boxes){const box=layout.box;const stack=stacks[layout.stack]||{count:1,placed:0,weight:1};const weight=layout.stackWeight/stack.weight||1;if(layout.horizontal){const width=chartArea.w*weight;const height=stack.size||box.height;if(defined(stack.start)){y=stack.start;}
if(box.fullSize){setBoxDims(box,userPadding.left,y,params.outerWidth-userPadding.right-userPadding.left,height);}else{setBoxDims(box,chartArea.left+stack.placed,y,width,height);}
stack.start=y;stack.placed+=width;y=box.bottom;}else{const height=chartArea.h*weight;const width=stack.size||box.width;if(defined(stack.start)){x=stack.start;}
if(box.fullSize){setBoxDims(box,x,userPadding.top,width,params.outerHeight-userPadding.bottom-userPadding.top);}else{setBoxDims(box,x,chartArea.top+stack.placed,width,height);}
stack.start=x;stack.placed+=height;x=box.right;}}
chartArea.x=x;chartArea.y=y;}
var layouts={addBox(chart,item){if(!chart.boxes){chart.boxes=[];}
item.fullSize=item.fullSize||false;item.position=item.position||'top';item.weight=item.weight||0;item._layers=item._layers||function(){return[{z:0,draw(chartArea){item.draw(chartArea);}}];};chart.boxes.push(item);},removeBox(chart,layoutItem){const index=chart.boxes?chart.boxes.indexOf(layoutItem):-1;if(index!==-1){chart.boxes.splice(index,1);}},configure(chart,item,options){item.fullSize=options.fullSize;item.position=options.position;item.weight=options.weight;},update(chart,width,height,minPadding){if(!chart){return;}
const padding=toPadding(chart.options.layout.padding);const availableWidth=Math.max(width-padding.width,0);const availableHeight=Math.max(height-padding.height,0);const boxes=buildLayoutBoxes(chart.boxes);const verticalBoxes=boxes.vertical;const horizontalBoxes=boxes.horizontal;each(chart.boxes,(box)=>{if(typeof box.beforeLayout==='function'){box.beforeLayout();}});const visibleVerticalBoxCount=verticalBoxes.reduce((total,wrap)=>wrap.box.options&&wrap.box.options.display===false?total:total+1,0)||1;const params=Object.freeze({outerWidth:width,outerHeight:height,padding,availableWidth,availableHeight,vBoxMaxWidth:availableWidth/2/visibleVerticalBoxCount,hBoxMaxHeight:availableHeight/2});const maxPadding=Object.assign({},padding);updateMaxPadding(maxPadding,toPadding(minPadding));const chartArea=Object.assign({maxPadding,w:availableWidth,h:availableHeight,x:padding.left,y:padding.top},padding);const stacks=setLayoutDims(verticalBoxes.concat(horizontalBoxes),params);fitBoxes(boxes.fullSize,chartArea,params,stacks);fitBoxes(verticalBoxes,chartArea,params,stacks);if(fitBoxes(horizontalBoxes,chartArea,params,stacks)){fitBoxes(verticalBoxes,chartArea,params,stacks);}
handleMaxPadding(chartArea);placeBoxes(boxes.leftAndTop,chartArea,params,stacks);chartArea.x+=chartArea.w;chartArea.y+=chartArea.h;placeBoxes(boxes.rightAndBottom,chartArea,params,stacks);chart.chartArea={left:chartArea.left,top:chartArea.top,right:chartArea.left+chartArea.w,bottom:chartArea.top+chartArea.h,height:chartArea.h,width:chartArea.w};each(boxes.chartArea,(layout)=>{const box=layout.box;Object.assign(box,chart.chartArea);box.update(chartArea.w,chartArea.h,{left:0,top:0,right:0,bottom:0});});}};class BasePlatform{acquireContext(canvas,aspectRatio){}
releaseContext(context){return false;}
addEventListener(chart,type,listener){}
removeEventListener(chart,type,listener){}
getDevicePixelRatio(){return 1;}
getMaximumSize(element,width,height,aspectRatio){width=Math.max(0,width||element.width);height=height||element.height;return{width,height:Math.max(0,aspectRatio?Math.floor(width/aspectRatio):height)};}
isAttached(canvas){return true;}
updateConfig(config){}}
class BasicPlatform extends BasePlatform{acquireContext(item){return item&&item.getContext&&item.getContext('2d')||null;}
updateConfig(config){config.options.animation=false;}}
const EXPANDO_KEY='$chartjs';const EVENT_TYPES={touchstart:'mousedown',touchmove:'mousemove',touchend:'mouseup',pointerenter:'mouseenter',pointerdown:'mousedown',pointermove:'mousemove',pointerup:'mouseup',pointerleave:'mouseout',pointerout:'mouseout'};const isNullOrEmpty=(value)=>value===null||value==='';function initCanvas(canvas,aspectRatio){const style=canvas.style;const renderHeight=canvas.getAttribute('height');const renderWidth=canvas.getAttribute('width');canvas[EXPANDO_KEY]={initial:{height:renderHeight,width:renderWidth,style:{display:style.display,height:style.height,width:style.width}}};style.display=style.display||'block';style.boxSizing=style.boxSizing||'border-box';if(isNullOrEmpty(renderWidth)){const displayWidth=readUsedSize(canvas,'width');if(displayWidth!==undefined){canvas.width=displayWidth;}}
if(isNullOrEmpty(renderHeight)){if(canvas.style.height===''){canvas.height=canvas.width/(aspectRatio||2);}else{const displayHeight=readUsedSize(canvas,'height');if(displayHeight!==undefined){canvas.height=displayHeight;}}}
return canvas;}
const eventListenerOptions=supportsEventListenerOptions?{passive:true}:false;function addListener(node,type,listener){node.addEventListener(type,listener,eventListenerOptions);}
function removeListener(chart,type,listener){chart.canvas.removeEventListener(type,listener,eventListenerOptions);}
function fromNativeEvent(event,chart){const type=EVENT_TYPES[event.type]||event.type;const{x,y}=getRelativePosition(event,chart);return{type,chart,native:event,x:x!==undefined?x:null,y:y!==undefined?y:null};}
function nodeListContains(nodeList,canvas){for(const node of nodeList){if(node===canvas||node.contains(canvas)){return true;}}}
function createAttachObserver(chart,type,listener){const canvas=chart.canvas;const observer=new MutationObserver((entries)=>{let trigger=false;for(const entry of entries){trigger=trigger||nodeListContains(entry.addedNodes,canvas);trigger=trigger&&!nodeListContains(entry.removedNodes,canvas);}
if(trigger){listener();}});observer.observe(document,{childList:true,subtree:true});return observer;}
function createDetachObserver(chart,type,listener){const canvas=chart.canvas;const observer=new MutationObserver((entries)=>{let trigger=false;for(const entry of entries){trigger=trigger||nodeListContains(entry.removedNodes,canvas);trigger=trigger&&!nodeListContains(entry.addedNodes,canvas);}
if(trigger){listener();}});observer.observe(document,{childList:true,subtree:true});return observer;}
const drpListeningCharts=new Map();let oldDevicePixelRatio=0;function onWindowResize(){const dpr=window.devicePixelRatio;if(dpr===oldDevicePixelRatio){return;}
oldDevicePixelRatio=dpr;drpListeningCharts.forEach((resize,chart)=>{if(chart.currentDevicePixelRatio!==dpr){resize();}});}
function listenDevicePixelRatioChanges(chart,resize){if(!drpListeningCharts.size){window.addEventListener('resize',onWindowResize);}
drpListeningCharts.set(chart,resize);}
function unlistenDevicePixelRatioChanges(chart){drpListeningCharts.delete(chart);if(!drpListeningCharts.size){window.removeEventListener('resize',onWindowResize);}}
function createResizeObserver(chart,type,listener){const canvas=chart.canvas;const container=canvas&&_getParentNode(canvas);if(!container){return;}
const resize=throttled((width,height)=>{const w=container.clientWidth;listener(width,height);if(w<container.clientWidth){listener();}},window);const observer=new ResizeObserver((entries)=>{const entry=entries[0];const width=entry.contentRect.width;const height=entry.contentRect.height;if(width===0&&height===0){return;}
resize(width,height);});observer.observe(container);listenDevicePixelRatioChanges(chart,resize);return observer;}
function releaseObserver(chart,type,observer){if(observer){observer.disconnect();}
if(type==='resize'){unlistenDevicePixelRatioChanges(chart);}}
function createProxyAndListen(chart,type,listener){const canvas=chart.canvas;const proxy=throttled((event)=>{if(chart.ctx!==null){listener(fromNativeEvent(event,chart));}},chart);addListener(canvas,type,proxy);return proxy;}
class DomPlatform extends BasePlatform{acquireContext(canvas,aspectRatio){const context=canvas&&canvas.getContext&&canvas.getContext('2d');if(context&&context.canvas===canvas){initCanvas(canvas,aspectRatio);return context;}
return null;}
releaseContext(context){const canvas=context.canvas;if(!canvas[EXPANDO_KEY]){return false;}
const initial=canvas[EXPANDO_KEY].initial;['height','width'].forEach((prop)=>{const value=initial[prop];if(isNullOrUndef(value)){canvas.removeAttribute(prop);}else{canvas.setAttribute(prop,value);}});const style=initial.style||{};Object.keys(style).forEach((key)=>{canvas.style[key]=style[key];});canvas.width=canvas.width;delete canvas[EXPANDO_KEY];return true;}
addEventListener(chart,type,listener){this.removeEventListener(chart,type);const proxies=chart.$proxies||(chart.$proxies={});const handlers={attach:createAttachObserver,detach:createDetachObserver,resize:createResizeObserver};const handler=handlers[type]||createProxyAndListen;proxies[type]=handler(chart,type,listener);}
removeEventListener(chart,type){const proxies=chart.$proxies||(chart.$proxies={});const proxy=proxies[type];if(!proxy){return;}
const handlers={attach:releaseObserver,detach:releaseObserver,resize:releaseObserver};const handler=handlers[type]||removeListener;handler(chart,type,proxy);proxies[type]=undefined;}
getDevicePixelRatio(){return window.devicePixelRatio;}
getMaximumSize(canvas,width,height,aspectRatio){return getMaximumSize(canvas,width,height,aspectRatio);}
isAttached(canvas){const container=_getParentNode(canvas);return!!(container&&container.isConnected);}}
function _detectPlatform(canvas){if(!_isDomSupported()||typeof OffscreenCanvas!=='undefined'&&canvas instanceof OffscreenCanvas){return BasicPlatform;}
return DomPlatform;}
var platforms=Object.freeze({__proto__:null,BasePlatform:BasePlatform,BasicPlatform:BasicPlatform,DomPlatform:DomPlatform,_detectPlatform:_detectPlatform});const transparent='transparent';const interpolators={boolean(from,to,factor){return factor>0.5?to:from;},color(from,to,factor){const c0=color(from||transparent);const c1=c0.valid&&color(to||transparent);return c1&&c1.valid?c1.mix(c0,factor).hexString():to;},number(from,to,factor){return from+(to-from)*factor;}};class Animation{constructor(cfg,target,prop,to){const currentValue=target[prop];to=resolve([cfg.to,to,currentValue,cfg.from]);const from=resolve([cfg.from,currentValue,to]);this._active=true;this._fn=cfg.fn||interpolators[cfg.type||typeof from];this._easing=effects[cfg.easing]||effects.linear;this._start=Math.floor(Date.now()+(cfg.delay||0));this._duration=this._total=Math.floor(cfg.duration);this._loop=!!cfg.loop;this._target=target;this._prop=prop;this._from=from;this._to=to;this._promises=undefined;}
active(){return this._active;}
update(cfg,to,date){if(this._active){this._notify(false);const currentValue=this._target[this._prop];const elapsed=date-this._start;const remain=this._duration-elapsed;this._start=date;this._duration=Math.floor(Math.max(remain,cfg.duration));this._total+=elapsed;this._loop=!!cfg.loop;this._to=resolve([cfg.to,to,currentValue,cfg.from]);this._from=resolve([cfg.from,currentValue,to]);}}
cancel(){if(this._active){this.tick(Date.now());this._active=false;this._notify(false);}}
tick(date){const elapsed=date-this._start;const duration=this._duration;const prop=this._prop;const from=this._from;const loop=this._loop;const to=this._to;let factor;this._active=from!==to&&(loop||elapsed<duration);if(!this._active){this._target[prop]=to;this._notify(true);return;}
if(elapsed<0){this._target[prop]=from;return;}
factor=elapsed/duration%2;factor=loop&&factor>1?2-factor:factor;factor=this._easing(Math.min(1,Math.max(0,factor)));this._target[prop]=this._fn(from,to,factor);}
wait(){const promises=this._promises||(this._promises=[]);return new Promise((res,rej)=>{promises.push({res,rej});});}
_notify(resolved){const method=resolved?'res':'rej';const promises=this._promises||[];for(let i=0;i<promises.length;i++){promises[i][method]();}}}
class Animations{constructor(chart,config){this._chart=chart;this._properties=new Map();this.configure(config);}
configure(config){if(!isObject(config)){return;}
const animationOptions=Object.keys(defaults.animation);const animatedProps=this._properties;Object.getOwnPropertyNames(config).forEach((key)=>{const cfg=config[key];if(!isObject(cfg)){return;}
const resolved={};for(const option of animationOptions){resolved[option]=cfg[option];}
(isArray(cfg.properties)&&cfg.properties||[key]).forEach((prop)=>{if(prop===key||!animatedProps.has(prop)){animatedProps.set(prop,resolved);}});});}
_animateOptions(target,values){const newOptions=values.options;const options=resolveTargetOptions(target,newOptions);if(!options){return[];}
const animations=this._createAnimations(options,newOptions);if(newOptions.$shared){awaitAll(target.options.$animations,newOptions).then(()=>{target.options=newOptions;},()=>{});}
return animations;}
_createAnimations(target,values){const animatedProps=this._properties;const animations=[];const running=target.$animations||(target.$animations={});const props=Object.keys(values);const date=Date.now();let i;for(i=props.length-1;i>=0;--i){const prop=props[i];if(prop.charAt(0)==='$'){continue;}
if(prop==='options'){animations.push(...this._animateOptions(target,values));continue;}
const value=values[prop];let animation=running[prop];const cfg=animatedProps.get(prop);if(animation){if(cfg&&animation.active()){animation.update(cfg,value,date);continue;}else{animation.cancel();}}
if(!cfg||!cfg.duration){target[prop]=value;continue;}
running[prop]=animation=new Animation(cfg,target,prop,value);animations.push(animation);}
return animations;}
update(target,values){if(this._properties.size===0){Object.assign(target,values);return;}
const animations=this._createAnimations(target,values);if(animations.length){animator.add(this._chart,animations);return true;}}}
function awaitAll(animations,properties){const running=[];const keys=Object.keys(properties);for(let i=0;i<keys.length;i++){const anim=animations[keys[i]];if(anim&&anim.active()){running.push(anim.wait());}}
return Promise.all(running);}
function resolveTargetOptions(target,newOptions){if(!newOptions){return;}
let options=target.options;if(!options){target.options=newOptions;return;}
if(options.$shared){target.options=options=Object.assign({},options,{$shared:false,$animations:{}});}
return options;}
function scaleClip(scale,allowedOverflow){const opts=scale&&scale.options||{};const reverse=opts.reverse;const min=opts.min===undefined?allowedOverflow:0;const max=opts.max===undefined?allowedOverflow:0;return{start:reverse?max:min,end:reverse?min:max};}
function defaultClip(xScale,yScale,allowedOverflow){if(allowedOverflow===false){return false;}
const x=scaleClip(xScale,allowedOverflow);const y=scaleClip(yScale,allowedOverflow);return{top:y.end,right:x.end,bottom:y.start,left:x.start};}
function toClip(value){let t,r,b,l;if(isObject(value)){t=value.top;r=value.right;b=value.bottom;l=value.left;}else{t=r=b=l=value;}
return{top:t,right:r,bottom:b,left:l,disabled:value===false};}
function getSortedDatasetIndices(chart,filterVisible){const keys=[];const metasets=chart._getSortedDatasetMetas(filterVisible);let i,ilen;for(i=0,ilen=metasets.length;i<ilen;++i){keys.push(metasets[i].index);}
return keys;}
function applyStack(stack,value,dsIndex,options={}){const keys=stack.keys;const singleMode=options.mode==='single';let i,ilen,datasetIndex,otherValue;if(value===null){return;}
for(i=0,ilen=keys.length;i<ilen;++i){datasetIndex=+keys[i];if(datasetIndex===dsIndex){if(options.all){continue;}
break;}
otherValue=stack.values[datasetIndex];if(isNumberFinite(otherValue)&&(singleMode||value===0||sign(value)===sign(otherValue))){value+=otherValue;}}
return value;}
function convertObjectDataToArray(data){const keys=Object.keys(data);const adata=new Array(keys.length);let i,ilen,key;for(i=0,ilen=keys.length;i<ilen;++i){key=keys[i];adata[i]={x:key,y:data[key]};}
return adata;}
function isStacked(scale,meta){const stacked=scale&&scale.options.stacked;return stacked||stacked===undefined&&meta.stack!==undefined;}
function getStackKey(indexScale,valueScale,meta){return`${indexScale.id}.${valueScale.id}.${meta.stack || meta.type}`;}
function getUserBounds(scale){const{min,max,minDefined,maxDefined}=scale.getUserBounds();return{min:minDefined?min:Number.NEGATIVE_INFINITY,max:maxDefined?max:Number.POSITIVE_INFINITY};}
function getOrCreateStack(stacks,stackKey,indexValue){const subStack=stacks[stackKey]||(stacks[stackKey]={});return subStack[indexValue]||(subStack[indexValue]={});}
function getLastIndexInStack(stack,vScale,positive,type){for(const meta of vScale.getMatchingVisibleMetas(type).reverse()){const value=stack[meta.index];if(positive&&value>0||!positive&&value<0){return meta.index;}}
return null;}
function updateStacks(controller,parsed){const{chart,_cachedMeta:meta}=controller;const stacks=chart._stacks||(chart._stacks={});const{iScale,vScale,index:datasetIndex}=meta;const iAxis=iScale.axis;const vAxis=vScale.axis;const key=getStackKey(iScale,vScale,meta);const ilen=parsed.length;let stack;for(let i=0;i<ilen;++i){const item=parsed[i];const{[iAxis]:index,[vAxis]:value}=item;const itemStacks=item._stacks||(item._stacks={});stack=itemStacks[vAxis]=getOrCreateStack(stacks,key,index);stack[datasetIndex]=value;stack._top=getLastIndexInStack(stack,vScale,true,meta.type);stack._bottom=getLastIndexInStack(stack,vScale,false,meta.type);const visualValues=stack._visualValues||(stack._visualValues={});visualValues[datasetIndex]=value;}}
function getFirstScaleId(chart,axis){const scales=chart.scales;return Object.keys(scales).filter((key)=>scales[key].axis===axis).shift();}
function createDatasetContext(parent,index){return createContext(parent,{active:false,dataset:undefined,datasetIndex:index,index,mode:'default',type:'dataset'});}
function createDataContext(parent,index,element){return createContext(parent,{active:false,dataIndex:index,parsed:undefined,raw:undefined,element,index,mode:'default',type:'data'});}
function clearStacks(meta,items){const datasetIndex=meta.controller.index;const axis=meta.vScale&&meta.vScale.axis;if(!axis){return;}
items=items||meta._parsed;for(const parsed of items){const stacks=parsed._stacks;if(!stacks||stacks[axis]===undefined||stacks[axis][datasetIndex]===undefined){return;}
delete stacks[axis][datasetIndex];if(stacks[axis]._visualValues!==undefined&&stacks[axis]._visualValues[datasetIndex]!==undefined){delete stacks[axis]._visualValues[datasetIndex];}}}
const isDirectUpdateMode=(mode)=>mode==='reset'||mode==='none';const cloneIfNotShared=(cached,shared)=>shared?cached:Object.assign({},cached);const createStack=(canStack,meta,chart)=>canStack&&!meta.hidden&&meta._stacked&&{keys:getSortedDatasetIndices(chart,true),values:null};class DatasetController{static defaults={};static datasetElementType=null;static dataElementType=null;constructor(chart,datasetIndex){this.chart=chart;this._ctx=chart.ctx;this.index=datasetIndex;this._cachedDataOpts={};this._cachedMeta=this.getMeta();this._type=this._cachedMeta.type;this.options=undefined;this._parsing=false;this._data=undefined;this._objectData=undefined;this._sharedOptions=undefined;this._drawStart=undefined;this._drawCount=undefined;this.enableOptionSharing=false;this.supportsDecimation=false;this.$context=undefined;this._syncList=[];this.datasetElementType=new.target.datasetElementType;this.dataElementType=new.target.dataElementType;this.initialize();}
initialize(){const meta=this._cachedMeta;this.configure();this.linkScales();meta._stacked=isStacked(meta.vScale,meta);this.addElements();if(this.options.fill&&!this.chart.isPluginEnabled('filler')){console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options");}}
updateIndex(datasetIndex){if(this.index!==datasetIndex){clearStacks(this._cachedMeta);}
this.index=datasetIndex;}
linkScales(){const chart=this.chart;const meta=this._cachedMeta;const dataset=this.getDataset();const chooseId=(axis,x,y,r)=>axis==='x'?x:axis==='r'?r:y;const xid=meta.xAxisID=valueOrDefault(dataset.xAxisID,getFirstScaleId(chart,'x'));const yid=meta.yAxisID=valueOrDefault(dataset.yAxisID,getFirstScaleId(chart,'y'));const rid=meta.rAxisID=valueOrDefault(dataset.rAxisID,getFirstScaleId(chart,'r'));const indexAxis=meta.indexAxis;const iid=meta.iAxisID=chooseId(indexAxis,xid,yid,rid);const vid=meta.vAxisID=chooseId(indexAxis,yid,xid,rid);meta.xScale=this.getScaleForId(xid);meta.yScale=this.getScaleForId(yid);meta.rScale=this.getScaleForId(rid);meta.iScale=this.getScaleForId(iid);meta.vScale=this.getScaleForId(vid);}
getDataset(){return this.chart.data.datasets[this.index];}
getMeta(){return this.chart.getDatasetMeta(this.index);}
getScaleForId(scaleID){return this.chart.scales[scaleID];}
_getOtherScale(scale){const meta=this._cachedMeta;return scale===meta.iScale?meta.vScale:meta.iScale;}
reset(){this._update('reset');}
_destroy(){const meta=this._cachedMeta;if(this._data){unlistenArrayEvents(this._data,this);}
if(meta._stacked){clearStacks(meta);}}
_dataCheck(){const dataset=this.getDataset();const data=dataset.data||(dataset.data=[]);const _data=this._data;if(isObject(data)){this._data=convertObjectDataToArray(data);}else if(_data!==data){if(_data){unlistenArrayEvents(_data,this);const meta=this._cachedMeta;clearStacks(meta);meta._parsed=[];}
if(data&&Object.isExtensible(data)){listenArrayEvents(data,this);}
this._syncList=[];this._data=data;}}
addElements(){const meta=this._cachedMeta;this._dataCheck();if(this.datasetElementType){meta.dataset=new this.datasetElementType();}}
buildOrUpdateElements(resetNewElements){const meta=this._cachedMeta;const dataset=this.getDataset();let stackChanged=false;this._dataCheck();const oldStacked=meta._stacked;meta._stacked=isStacked(meta.vScale,meta);if(meta.stack!==dataset.stack){stackChanged=true;clearStacks(meta);meta.stack=dataset.stack;}
this._resyncElements(resetNewElements);if(stackChanged||oldStacked!==meta._stacked){updateStacks(this,meta._parsed);}}
configure(){const config=this.chart.config;const scopeKeys=config.datasetScopeKeys(this._type);const scopes=config.getOptionScopes(this.getDataset(),scopeKeys,true);this.options=config.createResolver(scopes,this.getContext());this._parsing=this.options.parsing;this._cachedDataOpts={};}
parse(start,count){const{_cachedMeta:meta,_data:data}=this;const{iScale,_stacked}=meta;const iAxis=iScale.axis;let sorted=start===0&&count===data.length?true:meta._sorted;let prev=start>0&&meta._parsed[start-1];let i,cur,parsed;if(this._parsing===false){meta._parsed=data;meta._sorted=true;parsed=data;}else{if(isArray(data[start])){parsed=this.parseArrayData(meta,data,start,count);}else if(isObject(data[start])){parsed=this.parseObjectData(meta,data,start,count);}else{parsed=this.parsePrimitiveData(meta,data,start,count);}
const isNotInOrderComparedToPrev=()=>cur[iAxis]===null||prev&&cur[iAxis]<prev[iAxis];for(i=0;i<count;++i){meta._parsed[i+start]=cur=parsed[i];if(sorted){if(isNotInOrderComparedToPrev()){sorted=false;}
prev=cur;}}
meta._sorted=sorted;}
if(_stacked){updateStacks(this,parsed);}}
parsePrimitiveData(meta,data,start,count){const{iScale,vScale}=meta;const iAxis=iScale.axis;const vAxis=vScale.axis;const labels=iScale.getLabels();const singleScale=iScale===vScale;const parsed=new Array(count);let i,ilen,index;for(i=0,ilen=count;i<ilen;++i){index=i+start;parsed[i]={[iAxis]:singleScale||iScale.parse(labels[index],index),[vAxis]:vScale.parse(data[index],index)};}
return parsed;}
parseArrayData(meta,data,start,count){const{xScale,yScale}=meta;const parsed=new Array(count);let i,ilen,index,item;for(i=0,ilen=count;i<ilen;++i){index=i+start;item=data[index];parsed[i]={x:xScale.parse(item[0],index),y:yScale.parse(item[1],index)};}
return parsed;}
parseObjectData(meta,data,start,count){const{xScale,yScale}=meta;const{xAxisKey='x',yAxisKey='y'}=this._parsing;const parsed=new Array(count);let i,ilen,index,item;for(i=0,ilen=count;i<ilen;++i){index=i+start;item=data[index];parsed[i]={x:xScale.parse(resolveObjectKey(item,xAxisKey),index),y:yScale.parse(resolveObjectKey(item,yAxisKey),index)};}
return parsed;}
getParsed(index){return this._cachedMeta._parsed[index];}
getDataElement(index){return this._cachedMeta.data[index];}
applyStack(scale,parsed,mode){const chart=this.chart;const meta=this._cachedMeta;const value=parsed[scale.axis];const stack={keys:getSortedDatasetIndices(chart,true),values:parsed._stacks[scale.axis]._visualValues};return applyStack(stack,value,meta.index,{mode});}
updateRangeFromParsed(range,scale,parsed,stack){const parsedValue=parsed[scale.axis];let value=parsedValue===null?NaN:parsedValue;const values=stack&&parsed._stacks[scale.axis];if(stack&&values){stack.values=values;value=applyStack(stack,parsedValue,this._cachedMeta.index);}
range.min=Math.min(range.min,value);range.max=Math.max(range.max,value);}
getMinMax(scale,canStack){const meta=this._cachedMeta;const _parsed=meta._parsed;const sorted=meta._sorted&&scale===meta.iScale;const ilen=_parsed.length;const otherScale=this._getOtherScale(scale);const stack=createStack(canStack,meta,this.chart);const range={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};const{min:otherMin,max:otherMax}=getUserBounds(otherScale);let i,parsed;function _skip(){parsed=_parsed[i];const otherValue=parsed[otherScale.axis];return!isNumberFinite(parsed[scale.axis])||otherMin>otherValue||otherMax<otherValue;}
for(i=0;i<ilen;++i){if(_skip()){continue;}
this.updateRangeFromParsed(range,scale,parsed,stack);if(sorted){break;}}
if(sorted){for(i=ilen-1;i>=0;--i){if(_skip()){continue;}
this.updateRangeFromParsed(range,scale,parsed,stack);break;}}
return range;}
getAllParsedValues(scale){const parsed=this._cachedMeta._parsed;const values=[];let i,ilen,value;for(i=0,ilen=parsed.length;i<ilen;++i){value=parsed[i][scale.axis];if(isNumberFinite(value)){values.push(value);}}
return values;}
getMaxOverflow(){return false;}
getLabelAndValue(index){const meta=this._cachedMeta;const iScale=meta.iScale;const vScale=meta.vScale;const parsed=this.getParsed(index);return{label:iScale?''+iScale.getLabelForValue(parsed[iScale.axis]):'',value:vScale?''+vScale.getLabelForValue(parsed[vScale.axis]):''};}
_update(mode){const meta=this._cachedMeta;this.update(mode||'default');meta._clip=toClip(valueOrDefault(this.options.clip,defaultClip(meta.xScale,meta.yScale,this.getMaxOverflow())));}
update(mode){}
draw(){const ctx=this._ctx;const chart=this.chart;const meta=this._cachedMeta;const elements=meta.data||[];const area=chart.chartArea;const active=[];const start=this._drawStart||0;const count=this._drawCount||elements.length-start;const drawActiveElementsOnTop=this.options.drawActiveElementsOnTop;let i;if(meta.dataset){meta.dataset.draw(ctx,area,start,count);}
for(i=start;i<start+count;++i){const element=elements[i];if(element.hidden){continue;}
if(element.active&&drawActiveElementsOnTop){active.push(element);}else{element.draw(ctx,area);}}
for(i=0;i<active.length;++i){active[i].draw(ctx,area);}}
getStyle(index,active){const mode=active?'active':'default';return index===undefined&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(mode):this.resolveDataElementOptions(index||0,mode);}
getContext(index,active,mode){const dataset=this.getDataset();let context;if(index>=0&&index<this._cachedMeta.data.length){const element=this._cachedMeta.data[index];context=element.$context||(element.$context=createDataContext(this.getContext(),index,element));context.parsed=this.getParsed(index);context.raw=dataset.data[index];context.index=context.dataIndex=index;}else{context=this.$context||(this.$context=createDatasetContext(this.chart.getContext(),this.index));context.dataset=dataset;context.index=context.datasetIndex=this.index;}
context.active=!!active;context.mode=mode;return context;}
resolveDatasetElementOptions(mode){return this._resolveElementOptions(this.datasetElementType.id,mode);}
resolveDataElementOptions(index,mode){return this._resolveElementOptions(this.dataElementType.id,mode,index);}
_resolveElementOptions(elementType,mode='default',index){const active=mode==='active';const cache=this._cachedDataOpts;const cacheKey=elementType+'-'+mode;const cached=cache[cacheKey];const sharing=this.enableOptionSharing&&defined(index);if(cached){return cloneIfNotShared(cached,sharing);}
const config=this.chart.config;const scopeKeys=config.datasetElementScopeKeys(this._type,elementType);const prefixes=active?[`${elementType}Hover`,'hover',elementType,'']:[elementType,''];const scopes=config.getOptionScopes(this.getDataset(),scopeKeys);const names=Object.keys(defaults.elements[elementType]);const context=()=>this.getContext(index,active,mode);const values=config.resolveNamedOptions(scopes,names,context,prefixes);if(values.$shared){values.$shared=sharing;cache[cacheKey]=Object.freeze(cloneIfNotShared(values,sharing));}
return values;}
_resolveAnimations(index,transition,active){const chart=this.chart;const cache=this._cachedDataOpts;const cacheKey=`animation-${transition}`;const cached=cache[cacheKey];if(cached){return cached;}
let options;if(chart.options.animation!==false){const config=this.chart.config;const scopeKeys=config.datasetAnimationScopeKeys(this._type,transition);const scopes=config.getOptionScopes(this.getDataset(),scopeKeys);options=config.createResolver(scopes,this.getContext(index,active,transition));}
const animations=new Animations(chart,options&&options.animations);if(options&&options._cacheable){cache[cacheKey]=Object.freeze(animations);}
return animations;}
getSharedOptions(options){if(!options.$shared){return;}
return this._sharedOptions||(this._sharedOptions=Object.assign({},options));}
includeOptions(mode,sharedOptions){return!sharedOptions||isDirectUpdateMode(mode)||this.chart._animationsDisabled;}
_getSharedOptions(start,mode){const firstOpts=this.resolveDataElementOptions(start,mode);const previouslySharedOptions=this._sharedOptions;const sharedOptions=this.getSharedOptions(firstOpts);const includeOptions=this.includeOptions(mode,sharedOptions)||sharedOptions!==previouslySharedOptions;this.updateSharedOptions(sharedOptions,mode,firstOpts);return{sharedOptions,includeOptions};}
updateElement(element,index,properties,mode){if(isDirectUpdateMode(mode)){Object.assign(element,properties);}else{this._resolveAnimations(index,mode).update(element,properties);}}
updateSharedOptions(sharedOptions,mode,newOptions){if(sharedOptions&&!isDirectUpdateMode(mode)){this._resolveAnimations(undefined,mode).update(sharedOptions,newOptions);}}
_setStyle(element,index,mode,active){element.active=active;const options=this.getStyle(index,active);this._resolveAnimations(index,mode,active).update(element,{options:!active&&this.getSharedOptions(options)||options});}
removeHoverStyle(element,datasetIndex,index){this._setStyle(element,index,'active',false);}
setHoverStyle(element,datasetIndex,index){this._setStyle(element,index,'active',true);}
_removeDatasetHoverStyle(){const element=this._cachedMeta.dataset;if(element){this._setStyle(element,undefined,'active',false);}}
_setDatasetHoverStyle(){const element=this._cachedMeta.dataset;if(element){this._setStyle(element,undefined,'active',true);}}
_resyncElements(resetNewElements){const data=this._data;const elements=this._cachedMeta.data;for(const[method,arg1,arg2]of this._syncList){this[method](arg1,arg2);}
this._syncList=[];const numMeta=elements.length;const numData=data.length;const count=Math.min(numData,numMeta);if(count){this.parse(0,count);}
if(numData>numMeta){this._insertElements(numMeta,numData-numMeta,resetNewElements);}else if(numData<numMeta){this._removeElements(numData,numMeta-numData);}}
_insertElements(start,count,resetNewElements=true){const meta=this._cachedMeta;const data=meta.data;const end=start+count;let i;const move=(arr)=>{arr.length+=count;for(i=arr.length-1;i>=end;i--){arr[i]=arr[i-count];}};move(data);for(i=start;i<end;++i){data[i]=new this.dataElementType();}
if(this._parsing){move(meta._parsed);}
this.parse(start,count);if(resetNewElements){this.updateElements(data,start,count,'reset');}}
updateElements(element,start,count,mode){}
_removeElements(start,count){const meta=this._cachedMeta;if(this._parsing){const removed=meta._parsed.splice(start,count);if(meta._stacked){clearStacks(meta,removed);}}
meta.data.splice(start,count);}
_sync(args){if(this._parsing){this._syncList.push(args);}else{const[method,arg1,arg2]=args;this[method](arg1,arg2);}
this.chart._dataChanges.push([this.index,...args]);}
_onDataPush(){const count=arguments.length;this._sync(['_insertElements',this.getDataset().data.length-count,count]);}
_onDataPop(){this._sync(['_removeElements',this._cachedMeta.data.length-1,1]);}
_onDataShift(){this._sync(['_removeElements',0,1]);}
_onDataSplice(start,count){if(count){this._sync(['_removeElements',start,count]);}
const newCount=arguments.length-2;if(newCount){this._sync(['_insertElements',start,newCount]);}}
_onDataUnshift(){this._sync(['_insertElements',0,arguments.length]);}}
class Element{static defaults={};static defaultRoutes=undefined;x;y;active=false;options;$animations;tooltipPosition(useFinalPosition){const{x,y}=this.getProps(['x','y'],useFinalPosition);return{x,y};}
hasValue(){return isNumber(this.x)&&isNumber(this.y);}
getProps(props,final){const anims=this.$animations;if(!final||!anims){return this;}
const ret={};props.forEach((prop)=>{ret[prop]=anims[prop]&&anims[prop].active()?anims[prop]._to:this[prop];});return ret;}}
function autoSkip(scale,ticks){const tickOpts=scale.options.ticks;const determinedMaxTicks=determineMaxTicks(scale);const ticksLimit=Math.min(tickOpts.maxTicksLimit||determinedMaxTicks,determinedMaxTicks);const majorIndices=tickOpts.major.enabled?getMajorIndices(ticks):[];const numMajorIndices=majorIndices.length;const first=majorIndices[0];const last=majorIndices[numMajorIndices-1];const newTicks=[];if(numMajorIndices>ticksLimit){skipMajors(ticks,newTicks,majorIndices,numMajorIndices/ticksLimit);return newTicks;}
const spacing=calculateSpacing(majorIndices,ticks,ticksLimit);if(numMajorIndices>0){let i,ilen;const avgMajorSpacing=numMajorIndices>1?Math.round((last-first)/(numMajorIndices-1)):null;skip(ticks,newTicks,spacing,isNullOrUndef(avgMajorSpacing)?0:first-avgMajorSpacing,first);for(i=0,ilen=numMajorIndices-1;i<ilen;i++){skip(ticks,newTicks,spacing,majorIndices[i],majorIndices[i+1]);}
skip(ticks,newTicks,spacing,last,isNullOrUndef(avgMajorSpacing)?ticks.length:last+avgMajorSpacing);return newTicks;}
skip(ticks,newTicks,spacing);return newTicks;}
function determineMaxTicks(scale){const offset=scale.options.offset;const tickLength=scale._tickSize();const maxScale=scale._length/tickLength+(offset?0:1);const maxChart=scale._maxLength/tickLength;return Math.floor(Math.min(maxScale,maxChart));}
function calculateSpacing(majorIndices,ticks,ticksLimit){const evenMajorSpacing=getEvenSpacing(majorIndices);const spacing=ticks.length/ticksLimit;if(!evenMajorSpacing){return Math.max(spacing,1);}
const factors=_factorize(evenMajorSpacing);for(let i=0,ilen=factors.length-1;i<ilen;i++){const factor=factors[i];if(factor>spacing){return factor;}}
return Math.max(spacing,1);}
function getMajorIndices(ticks){const result=[];let i,ilen;for(i=0,ilen=ticks.length;i<ilen;i++){if(ticks[i].major){result.push(i);}}
return result;}
function skipMajors(ticks,newTicks,majorIndices,spacing){let count=0;let next=majorIndices[0];let i;spacing=Math.ceil(spacing);for(i=0;i<ticks.length;i++){if(i===next){newTicks.push(ticks[i]);count++;next=majorIndices[count*spacing];}}}
function skip(ticks,newTicks,spacing,majorStart,majorEnd){const start=valueOrDefault(majorStart,0);const end=Math.min(valueOrDefault(majorEnd,ticks.length),ticks.length);let count=0;let length,i,next;spacing=Math.ceil(spacing);if(majorEnd){length=majorEnd-majorStart;spacing=length/Math.floor(length/spacing);}
next=start;while(next<0){count++;next=Math.round(start+count*spacing);}
for(i=Math.max(start,0);i<end;i++){if(i===next){newTicks.push(ticks[i]);count++;next=Math.round(start+count*spacing);}}}
function getEvenSpacing(arr){const len=arr.length;let i,diff;if(len<2){return false;}
for(diff=arr[0],i=1;i<len;++i){if(arr[i]-arr[i-1]!==diff){return false;}}
return diff;}
const reverseAlign=(align)=>align==='left'?'right':align==='right'?'left':align;const offsetFromEdge=(scale,edge,offset)=>edge==='top'||edge==='left'?scale[edge]+offset:scale[edge]-offset;const getTicksLimit=(ticksLength,maxTicksLimit)=>Math.min(maxTicksLimit||ticksLength,ticksLength);function sample(arr,numItems){const result=[];const increment=arr.length/numItems;const len=arr.length;let i=0;for(;i<len;i+=increment){result.push(arr[Math.floor(i)]);}
return result;}
function getPixelForGridLine(scale,index,offsetGridLines){const length=scale.ticks.length;const validIndex=Math.min(index,length-1);const start=scale._startPixel;const end=scale._endPixel;const epsilon=1e-6;let lineValue=scale.getPixelForTick(validIndex);let offset;if(offsetGridLines){if(length===1){offset=Math.max(lineValue-start,end-lineValue);}else if(index===0){offset=(scale.getPixelForTick(1)-lineValue)/2;}else{offset=(lineValue-scale.getPixelForTick(validIndex-1))/2;}
lineValue+=validIndex<index?offset:-offset;if(lineValue<start-epsilon||lineValue>end+epsilon){return;}}
return lineValue;}
function garbageCollect(caches,length){each(caches,(cache)=>{const gc=cache.gc;const gcLen=gc.length/2;let i;if(gcLen>length){for(i=0;i<gcLen;++i){delete cache.data[gc[i]];}
gc.splice(0,gcLen);}});}
function getTickMarkLength(options){return options.drawTicks?options.tickLength:0;}
function getTitleHeight(options,fallback){if(!options.display){return 0;}
const font=toFont(options.font,fallback);const padding=toPadding(options.padding);const lines=isArray(options.text)?options.text.length:1;return lines*font.lineHeight+padding.height;}
function createScaleContext(parent,scale){return createContext(parent,{scale,type:'scale'});}
function createTickContext(parent,index,tick){return createContext(parent,{tick,index,type:'tick'});}
function titleAlign(align,position,reverse){let ret=_toLeftRightCenter(align);if(reverse&&position!=='right'||!reverse&&position==='right'){ret=reverseAlign(ret);}
return ret;}
function titleArgs(scale,offset,position,align){const{top,left,bottom,right,chart}=scale;const{chartArea,scales}=chart;let rotation=0;let maxWidth,titleX,titleY;const height=bottom-top;const width=right-left;if(scale.isHorizontal()){titleX=_alignStartEnd(align,left,right);if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];titleY=scales[positionAxisID].getPixelForValue(value)+height-offset;}else if(position==='center'){titleY=(chartArea.bottom+chartArea.top)/2+height-offset;}else{titleY=offsetFromEdge(scale,position,offset);}
maxWidth=right-left;}else{if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];titleX=scales[positionAxisID].getPixelForValue(value)-width+offset;}else if(position==='center'){titleX=(chartArea.left+chartArea.right)/2-width+offset;}else{titleX=offsetFromEdge(scale,position,offset);}
titleY=_alignStartEnd(align,bottom,top);rotation=position==='left'?-HALF_PI:HALF_PI;}
return{titleX,titleY,maxWidth,rotation};}
class Scale extends Element{constructor(cfg){super();this.id=cfg.id;this.type=cfg.type;this.options=undefined;this.ctx=cfg.ctx;this.chart=cfg.chart;this.top=undefined;this.bottom=undefined;this.left=undefined;this.right=undefined;this.width=undefined;this.height=undefined;this._margins={left:0,right:0,top:0,bottom:0};this.maxWidth=undefined;this.maxHeight=undefined;this.paddingTop=undefined;this.paddingBottom=undefined;this.paddingLeft=undefined;this.paddingRight=undefined;this.axis=undefined;this.labelRotation=undefined;this.min=undefined;this.max=undefined;this._range=undefined;this.ticks=[];this._gridLineItems=null;this._labelItems=null;this._labelSizes=null;this._length=0;this._maxLength=0;this._longestTextCache={};this._startPixel=undefined;this._endPixel=undefined;this._reversePixels=false;this._userMax=undefined;this._userMin=undefined;this._suggestedMax=undefined;this._suggestedMin=undefined;this._ticksLength=0;this._borderValue=0;this._cache={};this._dataLimitsCached=false;this.$context=undefined;}
init(options){this.options=options.setContext(this.getContext());this.axis=options.axis;this._userMin=this.parse(options.min);this._userMax=this.parse(options.max);this._suggestedMin=this.parse(options.suggestedMin);this._suggestedMax=this.parse(options.suggestedMax);}
parse(raw,index){return raw;}
getUserBounds(){let{_userMin,_userMax,_suggestedMin,_suggestedMax}=this;_userMin=finiteOrDefault(_userMin,Number.POSITIVE_INFINITY);_userMax=finiteOrDefault(_userMax,Number.NEGATIVE_INFINITY);_suggestedMin=finiteOrDefault(_suggestedMin,Number.POSITIVE_INFINITY);_suggestedMax=finiteOrDefault(_suggestedMax,Number.NEGATIVE_INFINITY);return{min:finiteOrDefault(_userMin,_suggestedMin),max:finiteOrDefault(_userMax,_suggestedMax),minDefined:isNumberFinite(_userMin),maxDefined:isNumberFinite(_userMax)};}
getMinMax(canStack){let{min,max,minDefined,maxDefined}=this.getUserBounds();let range;if(minDefined&&maxDefined){return{min,max};}
const metas=this.getMatchingVisibleMetas();for(let i=0,ilen=metas.length;i<ilen;++i){range=metas[i].controller.getMinMax(this,canStack);if(!minDefined){min=Math.min(min,range.min);}
if(!maxDefined){max=Math.max(max,range.max);}}
min=maxDefined&&min>max?max:min;max=minDefined&&min>max?min:max;return{min:finiteOrDefault(min,finiteOrDefault(max,min)),max:finiteOrDefault(max,finiteOrDefault(min,max))};}
getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0};}
getTicks(){return this.ticks;}
getLabels(){const data=this.chart.data;return this.options.labels||(this.isHorizontal()?data.xLabels:data.yLabels)||data.labels||[];}
getLabelItems(chartArea=this.chart.chartArea){const items=this._labelItems||(this._labelItems=this._computeLabelItems(chartArea));return items;}
beforeLayout(){this._cache={};this._dataLimitsCached=false;}
beforeUpdate(){callback(this.options.beforeUpdate,[this]);}
update(maxWidth,maxHeight,margins){const{beginAtZero,grace,ticks:tickOpts}=this.options;const sampleSize=tickOpts.sampleSize;this.beforeUpdate();this.maxWidth=maxWidth;this.maxHeight=maxHeight;this._margins=margins=Object.assign({left:0,right:0,top:0,bottom:0},margins);this.ticks=null;this._labelSizes=null;this._gridLineItems=null;this._labelItems=null;this.beforeSetDimensions();this.setDimensions();this.afterSetDimensions();this._maxLength=this.isHorizontal()?this.width+margins.left+margins.right:this.height+margins.top+margins.bottom;if(!this._dataLimitsCached){this.beforeDataLimits();this.determineDataLimits();this.afterDataLimits();this._range=_addGrace(this,grace,beginAtZero);this._dataLimitsCached=true;}
this.beforeBuildTicks();this.ticks=this.buildTicks()||[];this.afterBuildTicks();const samplingEnabled=sampleSize<this.ticks.length;this._convertTicksToLabels(samplingEnabled?sample(this.ticks,sampleSize):this.ticks);this.configure();this.beforeCalculateLabelRotation();this.calculateLabelRotation();this.afterCalculateLabelRotation();if(tickOpts.display&&(tickOpts.autoSkip||tickOpts.source==='auto')){this.ticks=autoSkip(this,this.ticks);this._labelSizes=null;this.afterAutoSkip();}
if(samplingEnabled){this._convertTicksToLabels(this.ticks);}
this.beforeFit();this.fit();this.afterFit();this.afterUpdate();}
configure(){let reversePixels=this.options.reverse;let startPixel,endPixel;if(this.isHorizontal()){startPixel=this.left;endPixel=this.right;}else{startPixel=this.top;endPixel=this.bottom;reversePixels=!reversePixels;}
this._startPixel=startPixel;this._endPixel=endPixel;this._reversePixels=reversePixels;this._length=endPixel-startPixel;this._alignToPixels=this.options.alignToPixels;}
afterUpdate(){callback(this.options.afterUpdate,[this]);}
beforeSetDimensions(){callback(this.options.beforeSetDimensions,[this]);}
setDimensions(){if(this.isHorizontal()){this.width=this.maxWidth;this.left=0;this.right=this.width;}else{this.height=this.maxHeight;this.top=0;this.bottom=this.height;}
this.paddingLeft=0;this.paddingTop=0;this.paddingRight=0;this.paddingBottom=0;}
afterSetDimensions(){callback(this.options.afterSetDimensions,[this]);}
_callHooks(name){this.chart.notifyPlugins(name,this.getContext());callback(this.options[name],[this]);}
beforeDataLimits(){this._callHooks('beforeDataLimits');}
determineDataLimits(){}
afterDataLimits(){this._callHooks('afterDataLimits');}
beforeBuildTicks(){this._callHooks('beforeBuildTicks');}
buildTicks(){return[];}
afterBuildTicks(){this._callHooks('afterBuildTicks');}
beforeTickToLabelConversion(){callback(this.options.beforeTickToLabelConversion,[this]);}
generateTickLabels(ticks){const tickOpts=this.options.ticks;let i,ilen,tick;for(i=0,ilen=ticks.length;i<ilen;i++){tick=ticks[i];tick.label=callback(tickOpts.callback,[tick.value,i,ticks],this);}}
afterTickToLabelConversion(){callback(this.options.afterTickToLabelConversion,[this]);}
beforeCalculateLabelRotation(){callback(this.options.beforeCalculateLabelRotation,[this]);}
calculateLabelRotation(){const options=this.options;const tickOpts=options.ticks;const numTicks=getTicksLimit(this.ticks.length,options.ticks.maxTicksLimit);const minRotation=tickOpts.minRotation||0;const maxRotation=tickOpts.maxRotation;let labelRotation=minRotation;let tickWidth,maxHeight,maxLabelDiagonal;if(!this._isVisible()||!tickOpts.display||minRotation>=maxRotation||numTicks<=1||!this.isHorizontal()){this.labelRotation=minRotation;return;}
const labelSizes=this._getLabelSizes();const maxLabelWidth=labelSizes.widest.width;const maxLabelHeight=labelSizes.highest.height;const maxWidth=_limitValue(this.chart.width-maxLabelWidth,0,this.maxWidth);tickWidth=options.offset?this.maxWidth/numTicks:maxWidth/(numTicks-1);if(maxLabelWidth+6>tickWidth){tickWidth=maxWidth/(numTicks-(options.offset?0.5:1));maxHeight=this.maxHeight-getTickMarkLength(options.grid)-tickOpts.padding-getTitleHeight(options.title,this.chart.options.font);maxLabelDiagonal=Math.sqrt(maxLabelWidth*maxLabelWidth+maxLabelHeight*maxLabelHeight);labelRotation=toDegrees(Math.min(Math.asin(_limitValue((labelSizes.highest.height+6)/tickWidth,-1,1)),Math.asin(_limitValue(maxHeight/maxLabelDiagonal,-1,1))-Math.asin(_limitValue(maxLabelHeight/maxLabelDiagonal,-1,1))));labelRotation=Math.max(minRotation,Math.min(maxRotation,labelRotation));}
this.labelRotation=labelRotation;}
afterCalculateLabelRotation(){callback(this.options.afterCalculateLabelRotation,[this]);}
afterAutoSkip(){}
beforeFit(){callback(this.options.beforeFit,[this]);}
fit(){const minSize={width:0,height:0};const{chart,options:{ticks:tickOpts,title:titleOpts,grid:gridOpts}}=this;const display=this._isVisible();const isHorizontal=this.isHorizontal();if(display){const titleHeight=getTitleHeight(titleOpts,chart.options.font);if(isHorizontal){minSize.width=this.maxWidth;minSize.height=getTickMarkLength(gridOpts)+titleHeight;}else{minSize.height=this.maxHeight;minSize.width=getTickMarkLength(gridOpts)+titleHeight;}
if(tickOpts.display&&this.ticks.length){const{first,last,widest,highest}=this._getLabelSizes();const tickPadding=tickOpts.padding*2;const angleRadians=toRadians(this.labelRotation);const cos=Math.cos(angleRadians);const sin=Math.sin(angleRadians);if(isHorizontal){const labelHeight=tickOpts.mirror?0:sin*widest.width+cos*highest.height;minSize.height=Math.min(this.maxHeight,minSize.height+labelHeight+tickPadding);}else{const labelWidth=tickOpts.mirror?0:cos*widest.width+sin*highest.height;minSize.width=Math.min(this.maxWidth,minSize.width+labelWidth+tickPadding);}
this._calculatePadding(first,last,sin,cos);}}
this._handleMargins();if(isHorizontal){this.width=this._length=chart.width-this._margins.left-this._margins.right;this.height=minSize.height;}else{this.width=minSize.width;this.height=this._length=chart.height-this._margins.top-this._margins.bottom;}}
_calculatePadding(first,last,sin,cos){const{ticks:{align,padding},position}=this.options;const isRotated=this.labelRotation!==0;const labelsBelowTicks=position!=='top'&&this.axis==='x';if(this.isHorizontal()){const offsetLeft=this.getPixelForTick(0)-this.left;const offsetRight=this.right-this.getPixelForTick(this.ticks.length-1);let paddingLeft=0;let paddingRight=0;if(isRotated){if(labelsBelowTicks){paddingLeft=cos*first.width;paddingRight=sin*last.height;}else{paddingLeft=sin*first.height;paddingRight=cos*last.width;}}else if(align==='start'){paddingRight=last.width;}else if(align==='end'){paddingLeft=first.width;}else if(align!=='inner'){paddingLeft=first.width/2;paddingRight=last.width/2;}
this.paddingLeft=Math.max((paddingLeft-offsetLeft+padding)*this.width/(this.width-offsetLeft),0);this.paddingRight=Math.max((paddingRight-offsetRight+padding)*this.width/(this.width-offsetRight),0);}else{let paddingTop=last.height/2;let paddingBottom=first.height/2;if(align==='start'){paddingTop=0;paddingBottom=first.height;}else if(align==='end'){paddingTop=last.height;paddingBottom=0;}
this.paddingTop=paddingTop+padding;this.paddingBottom=paddingBottom+padding;}}
_handleMargins(){if(this._margins){this._margins.left=Math.max(this.paddingLeft,this._margins.left);this._margins.top=Math.max(this.paddingTop,this._margins.top);this._margins.right=Math.max(this.paddingRight,this._margins.right);this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom);}}
afterFit(){callback(this.options.afterFit,[this]);}
isHorizontal(){const{axis,position}=this.options;return position==='top'||position==='bottom'||axis==='x';}
isFullSize(){return this.options.fullSize;}
_convertTicksToLabels(ticks){this.beforeTickToLabelConversion();this.generateTickLabels(ticks);let i,ilen;for(i=0,ilen=ticks.length;i<ilen;i++){if(isNullOrUndef(ticks[i].label)){ticks.splice(i,1);ilen--;i--;}}
this.afterTickToLabelConversion();}
_getLabelSizes(){let labelSizes=this._labelSizes;if(!labelSizes){const sampleSize=this.options.ticks.sampleSize;let ticks=this.ticks;if(sampleSize<ticks.length){ticks=sample(ticks,sampleSize);}
this._labelSizes=labelSizes=this._computeLabelSizes(ticks,ticks.length,this.options.ticks.maxTicksLimit);}
return labelSizes;}
_computeLabelSizes(ticks,length,maxTicksLimit){const{ctx,_longestTextCache:caches}=this;const widths=[];const heights=[];const increment=Math.floor(length/getTicksLimit(length,maxTicksLimit));let widestLabelSize=0;let highestLabelSize=0;let i,j,jlen,label,tickFont,fontString,cache,lineHeight,width,height,nestedLabel;for(i=0;i<length;i+=increment){label=ticks[i].label;tickFont=this._resolveTickFontOptions(i);ctx.font=fontString=tickFont.string;cache=caches[fontString]=caches[fontString]||{data:{},gc:[]};lineHeight=tickFont.lineHeight;width=height=0;if(!isNullOrUndef(label)&&!isArray(label)){width=_measureText(ctx,cache.data,cache.gc,width,label);height=lineHeight;}else if(isArray(label)){for(j=0,jlen=label.length;j<jlen;++j){nestedLabel=label[j];if(!isNullOrUndef(nestedLabel)&&!isArray(nestedLabel)){width=_measureText(ctx,cache.data,cache.gc,width,nestedLabel);height+=lineHeight;}}}
widths.push(width);heights.push(height);widestLabelSize=Math.max(width,widestLabelSize);highestLabelSize=Math.max(height,highestLabelSize);}
garbageCollect(caches,length);const widest=widths.indexOf(widestLabelSize);const highest=heights.indexOf(highestLabelSize);const valueAt=(idx)=>({width:widths[idx]||0,height:heights[idx]||0});return{first:valueAt(0),last:valueAt(length-1),widest:valueAt(widest),highest:valueAt(highest),widths,heights};}
getLabelForValue(value){return value;}
getPixelForValue(value,index){return NaN;}
getValueForPixel(pixel){}
getPixelForTick(index){const ticks=this.ticks;if(index<0||index>ticks.length-1){return null;}
return this.getPixelForValue(ticks[index].value);}
getPixelForDecimal(decimal){if(this._reversePixels){decimal=1-decimal;}
const pixel=this._startPixel+decimal*this._length;return _int16Range(this._alignToPixels?_alignPixel(this.chart,pixel,0):pixel);}
getDecimalForPixel(pixel){const decimal=(pixel-this._startPixel)/this._length;return this._reversePixels?1-decimal:decimal;}
getBasePixel(){return this.getPixelForValue(this.getBaseValue());}
getBaseValue(){const{min,max}=this;return min<0&&max<0?max:min>0&&max>0?min:0;}
getContext(index){const ticks=this.ticks||[];if(index>=0&&index<ticks.length){const tick=ticks[index];return tick.$context||(tick.$context=createTickContext(this.getContext(),index,tick));}
return this.$context||(this.$context=createScaleContext(this.chart.getContext(),this));}
_tickSize(){const optionTicks=this.options.ticks;const rot=toRadians(this.labelRotation);const cos=Math.abs(Math.cos(rot));const sin=Math.abs(Math.sin(rot));const labelSizes=this._getLabelSizes();const padding=optionTicks.autoSkipPadding||0;const w=labelSizes?labelSizes.widest.width+padding:0;const h=labelSizes?labelSizes.highest.height+padding:0;return this.isHorizontal()?h*cos>w*sin?w/cos:h/sin:h*sin<w*cos?h/cos:w/sin;}
_isVisible(){const display=this.options.display;if(display!=='auto'){return!!display;}
return this.getMatchingVisibleMetas().length>0;}
_computeGridLineItems(chartArea){const axis=this.axis;const chart=this.chart;const options=this.options;const{grid,position,border}=options;const offset=grid.offset;const isHorizontal=this.isHorizontal();const ticks=this.ticks;const ticksLength=ticks.length+(offset?1:0);const tl=getTickMarkLength(grid);const items=[];const borderOpts=border.setContext(this.getContext());const axisWidth=borderOpts.display?borderOpts.width:0;const axisHalfWidth=axisWidth/2;const alignBorderValue=function(pixel){return _alignPixel(chart,pixel,axisWidth);};let borderValue,i,lineValue,alignedLineValue;let tx1,ty1,tx2,ty2,x1,y1,x2,y2;if(position==='top'){borderValue=alignBorderValue(this.bottom);ty1=this.bottom-tl;ty2=borderValue-axisHalfWidth;y1=alignBorderValue(chartArea.top)+axisHalfWidth;y2=chartArea.bottom;}else if(position==='bottom'){borderValue=alignBorderValue(this.top);y1=chartArea.top;y2=alignBorderValue(chartArea.bottom)-axisHalfWidth;ty1=borderValue+axisHalfWidth;ty2=this.top+tl;}else if(position==='left'){borderValue=alignBorderValue(this.right);tx1=this.right-tl;tx2=borderValue-axisHalfWidth;x1=alignBorderValue(chartArea.left)+axisHalfWidth;x2=chartArea.right;}else if(position==='right'){borderValue=alignBorderValue(this.left);x1=chartArea.left;x2=alignBorderValue(chartArea.right)-axisHalfWidth;tx1=borderValue+axisHalfWidth;tx2=this.left+tl;}else if(axis==='x'){if(position==='center'){borderValue=alignBorderValue((chartArea.top+chartArea.bottom)/2+0.5);}else if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];borderValue=alignBorderValue(this.chart.scales[positionAxisID].getPixelForValue(value));}
y1=chartArea.top;y2=chartArea.bottom;ty1=borderValue+axisHalfWidth;ty2=ty1+tl;}else if(axis==='y'){if(position==='center'){borderValue=alignBorderValue((chartArea.left+chartArea.right)/2);}else if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];borderValue=alignBorderValue(this.chart.scales[positionAxisID].getPixelForValue(value));}
tx1=borderValue-axisHalfWidth;tx2=tx1-tl;x1=chartArea.left;x2=chartArea.right;}
const limit=valueOrDefault(options.ticks.maxTicksLimit,ticksLength);const step=Math.max(1,Math.ceil(ticksLength/limit));for(i=0;i<ticksLength;i+=step){const context=this.getContext(i);const optsAtIndex=grid.setContext(context);const optsAtIndexBorder=border.setContext(context);const lineWidth=optsAtIndex.lineWidth;const lineColor=optsAtIndex.color;const borderDash=optsAtIndexBorder.dash||[];const borderDashOffset=optsAtIndexBorder.dashOffset;const tickWidth=optsAtIndex.tickWidth;const tickColor=optsAtIndex.tickColor;const tickBorderDash=optsAtIndex.tickBorderDash||[];const tickBorderDashOffset=optsAtIndex.tickBorderDashOffset;lineValue=getPixelForGridLine(this,i,offset);if(lineValue===undefined){continue;}
alignedLineValue=_alignPixel(chart,lineValue,lineWidth);if(isHorizontal){tx1=tx2=x1=x2=alignedLineValue;}else{ty1=ty2=y1=y2=alignedLineValue;}
items.push({tx1,ty1,tx2,ty2,x1,y1,x2,y2,width:lineWidth,color:lineColor,borderDash,borderDashOffset,tickWidth,tickColor,tickBorderDash,tickBorderDashOffset});}
this._ticksLength=ticksLength;this._borderValue=borderValue;return items;}
_computeLabelItems(chartArea){const axis=this.axis;const options=this.options;const{position,ticks:optionTicks}=options;const isHorizontal=this.isHorizontal();const ticks=this.ticks;const{align,crossAlign,padding,mirror}=optionTicks;const tl=getTickMarkLength(options.grid);const tickAndPadding=tl+padding;const hTickAndPadding=mirror?-padding:tickAndPadding;const rotation=-toRadians(this.labelRotation);const items=[];let i,ilen,tick,label,x,y,textAlign,pixel,font,lineHeight,lineCount,textOffset;let textBaseline='middle';if(position==='top'){y=this.bottom-hTickAndPadding;textAlign=this._getXAxisLabelAlignment();}else if(position==='bottom'){y=this.top+hTickAndPadding;textAlign=this._getXAxisLabelAlignment();}else if(position==='left'){const ret=this._getYAxisLabelAlignment(tl);textAlign=ret.textAlign;x=ret.x;}else if(position==='right'){const ret=this._getYAxisLabelAlignment(tl);textAlign=ret.textAlign;x=ret.x;}else if(axis==='x'){if(position==='center'){y=(chartArea.top+chartArea.bottom)/2+tickAndPadding;}else if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];y=this.chart.scales[positionAxisID].getPixelForValue(value)+tickAndPadding;}
textAlign=this._getXAxisLabelAlignment();}else if(axis==='y'){if(position==='center'){x=(chartArea.left+chartArea.right)/2-tickAndPadding;}else if(isObject(position)){const positionAxisID=Object.keys(position)[0];const value=position[positionAxisID];x=this.chart.scales[positionAxisID].getPixelForValue(value);}
textAlign=this._getYAxisLabelAlignment(tl).textAlign;}
if(axis==='y'){if(align==='start'){textBaseline='top';}else if(align==='end'){textBaseline='bottom';}}
const labelSizes=this._getLabelSizes();for(i=0,ilen=ticks.length;i<ilen;++i){tick=ticks[i];label=tick.label;const optsAtIndex=optionTicks.setContext(this.getContext(i));pixel=this.getPixelForTick(i)+optionTicks.labelOffset;font=this._resolveTickFontOptions(i);lineHeight=font.lineHeight;lineCount=isArray(label)?label.length:1;const halfCount=lineCount/2;const color=optsAtIndex.color;const strokeColor=optsAtIndex.textStrokeColor;const strokeWidth=optsAtIndex.textStrokeWidth;let tickTextAlign=textAlign;if(isHorizontal){x=pixel;if(textAlign==='inner'){if(i===ilen-1){tickTextAlign=!this.options.reverse?'right':'left';}else if(i===0){tickTextAlign=!this.options.reverse?'left':'right';}else{tickTextAlign='center';}}
if(position==='top'){if(crossAlign==='near'||rotation!==0){textOffset=-lineCount*lineHeight+lineHeight/2;}else if(crossAlign==='center'){textOffset=-labelSizes.highest.height/2-halfCount*lineHeight+lineHeight;}else{textOffset=-labelSizes.highest.height+lineHeight/2;}}else{if(crossAlign==='near'||rotation!==0){textOffset=lineHeight/2;}else if(crossAlign==='center'){textOffset=labelSizes.highest.height/2-halfCount*lineHeight;}else{textOffset=labelSizes.highest.height-lineCount*lineHeight;}}
if(mirror){textOffset*=-1;}
if(rotation!==0&&!optsAtIndex.showLabelBackdrop){x+=lineHeight/2*Math.sin(rotation);}}else{y=pixel;textOffset=(1-lineCount)*lineHeight/2;}
let backdrop;if(optsAtIndex.showLabelBackdrop){const labelPadding=toPadding(optsAtIndex.backdropPadding);const height=labelSizes.heights[i];const width=labelSizes.widths[i];let top=textOffset-labelPadding.top;let left=0-labelPadding.left;switch(textBaseline){case'middle':top-=height/2;break;case'bottom':top-=height;break;}
switch(textAlign){case'center':left-=width/2;break;case'right':left-=width;break;}
backdrop={left,top,width:width+labelPadding.width,height:height+labelPadding.height,color:optsAtIndex.backdropColor};}
items.push({label,font,textOffset,options:{rotation,color,strokeColor,strokeWidth,textAlign:tickTextAlign,textBaseline,translation:[x,y],backdrop}});}
return items;}
_getXAxisLabelAlignment(){const{position,ticks}=this.options;const rotation=-toRadians(this.labelRotation);if(rotation){return position==='top'?'left':'right';}
let align='center';if(ticks.align==='start'){align='left';}else if(ticks.align==='end'){align='right';}else if(ticks.align==='inner'){align='inner';}
return align;}
_getYAxisLabelAlignment(tl){const{position,ticks:{crossAlign,mirror,padding}}=this.options;const labelSizes=this._getLabelSizes();const tickAndPadding=tl+padding;const widest=labelSizes.widest.width;let textAlign;let x;if(position==='left'){if(mirror){x=this.right+padding;if(crossAlign==='near'){textAlign='left';}else if(crossAlign==='center'){textAlign='center';x+=widest/2;}else{textAlign='right';x+=widest;}}else{x=this.right-tickAndPadding;if(crossAlign==='near'){textAlign='right';}else if(crossAlign==='center'){textAlign='center';x-=widest/2;}else{textAlign='left';x=this.left;}}}else if(position==='right'){if(mirror){x=this.left+padding;if(crossAlign==='near'){textAlign='right';}else if(crossAlign==='center'){textAlign='center';x-=widest/2;}else{textAlign='left';x-=widest;}}else{x=this.left+tickAndPadding;if(crossAlign==='near'){textAlign='left';}else if(crossAlign==='center'){textAlign='center';x+=widest/2;}else{textAlign='right';x=this.right;}}}else{textAlign='right';}
return{textAlign,x};}
_computeLabelArea(){if(this.options.ticks.mirror){return;}
const chart=this.chart;const position=this.options.position;if(position==='left'||position==='right'){return{top:0,left:this.left,bottom:chart.height,right:this.right};}
if(position==='top'||position==='bottom'){return{top:this.top,left:0,bottom:this.bottom,right:chart.width};}}
drawBackground(){const{ctx,options:{backgroundColor},left,top,width,height}=this;if(backgroundColor){ctx.save();ctx.fillStyle=backgroundColor;ctx.fillRect(left,top,width,height);ctx.restore();}}
getLineWidthForValue(value){const grid=this.options.grid;if(!this._isVisible()||!grid.display){return 0;}
const ticks=this.ticks;const index=ticks.findIndex((t)=>t.value===value);if(index>=0){const opts=grid.setContext(this.getContext(index));return opts.lineWidth;}
return 0;}
drawGrid(chartArea){const grid=this.options.grid;const ctx=this.ctx;const items=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(chartArea));let i,ilen;const drawLine=(p1,p2,style)=>{if(!style.width||!style.color){return;}
ctx.save();ctx.lineWidth=style.width;ctx.strokeStyle=style.color;ctx.setLineDash(style.borderDash||[]);ctx.lineDashOffset=style.borderDashOffset;ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();ctx.restore();};if(grid.display){for(i=0,ilen=items.length;i<ilen;++i){const item=items[i];if(grid.drawOnChartArea){drawLine({x:item.x1,y:item.y1},{x:item.x2,y:item.y2},item);}
if(grid.drawTicks){drawLine({x:item.tx1,y:item.ty1},{x:item.tx2,y:item.ty2},{color:item.tickColor,width:item.tickWidth,borderDash:item.tickBorderDash,borderDashOffset:item.tickBorderDashOffset});}}}}
drawBorder(){const{chart,ctx,options:{border,grid}}=this;const borderOpts=border.setContext(this.getContext());const axisWidth=border.display?borderOpts.width:0;if(!axisWidth){return;}
const lastLineWidth=grid.setContext(this.getContext(0)).lineWidth;const borderValue=this._borderValue;let x1,x2,y1,y2;if(this.isHorizontal()){x1=_alignPixel(chart,this.left,axisWidth)-axisWidth/2;x2=_alignPixel(chart,this.right,lastLineWidth)+lastLineWidth/2;y1=y2=borderValue;}else{y1=_alignPixel(chart,this.top,axisWidth)-axisWidth/2;y2=_alignPixel(chart,this.bottom,lastLineWidth)+lastLineWidth/2;x1=x2=borderValue;}
ctx.save();ctx.lineWidth=borderOpts.width;ctx.strokeStyle=borderOpts.color;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.restore();}
drawLabels(chartArea){const optionTicks=this.options.ticks;if(!optionTicks.display){return;}
const ctx=this.ctx;const area=this._computeLabelArea();if(area){clipArea(ctx,area);}
const items=this.getLabelItems(chartArea);for(const item of items){const renderTextOptions=item.options;const tickFont=item.font;const label=item.label;const y=item.textOffset;renderText(ctx,label,0,y,tickFont,renderTextOptions);}
if(area){unclipArea(ctx);}}
drawTitle(){const{ctx,options:{position,title,reverse}}=this;if(!title.display){return;}
const font=toFont(title.font);const padding=toPadding(title.padding);const align=title.align;let offset=font.lineHeight/2;if(position==='bottom'||position==='center'||isObject(position)){offset+=padding.bottom;if(isArray(title.text)){offset+=font.lineHeight*(title.text.length-1);}}else{offset+=padding.top;}
const{titleX,titleY,maxWidth,rotation}=titleArgs(this,offset,position,align);renderText(ctx,title.text,0,0,font,{color:title.color,maxWidth,rotation,textAlign:titleAlign(align,position,reverse),textBaseline:'middle',translation:[titleX,titleY]});}
draw(chartArea){if(!this._isVisible()){return;}
this.drawBackground();this.drawGrid(chartArea);this.drawBorder();this.drawTitle();this.drawLabels(chartArea);}
_layers(){const opts=this.options;const tz=opts.ticks&&opts.ticks.z||0;const gz=valueOrDefault(opts.grid&&opts.grid.z,-1);const bz=valueOrDefault(opts.border&&opts.border.z,0);if(!this._isVisible()||this.draw!==Scale.prototype.draw){return[{z:tz,draw:(chartArea)=>{this.draw(chartArea);}}];}
return[{z:gz,draw:(chartArea)=>{this.drawBackground();this.drawGrid(chartArea);this.drawTitle();}},{z:bz,draw:()=>{this.drawBorder();}},{z:tz,draw:(chartArea)=>{this.drawLabels(chartArea);}}];}
getMatchingVisibleMetas(type){const metas=this.chart.getSortedVisibleDatasetMetas();const axisID=this.axis+'AxisID';const result=[];let i,ilen;for(i=0,ilen=metas.length;i<ilen;++i){const meta=metas[i];if(meta[axisID]===this.id&&(!type||meta.type===type)){result.push(meta);}}
return result;}
_resolveTickFontOptions(index){const opts=this.options.ticks.setContext(this.getContext(index));return toFont(opts.font);}
_maxDigits(){const fontSize=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/fontSize;}}
class TypedRegistry{constructor(type,scope,override){this.type=type;this.scope=scope;this.override=override;this.items=Object.create(null);}
isForType(type){return Object.prototype.isPrototypeOf.call(this.type.prototype,type.prototype);}
register(item){const proto=Object.getPrototypeOf(item);let parentScope;if(isIChartComponent(proto)){parentScope=this.register(proto);}
const items=this.items;const id=item.id;const scope=this.scope+'.'+id;if(!id){throw new Error('class does not have id: '+item);}
if(id in items){return scope;}
items[id]=item;registerDefaults(item,scope,parentScope);if(this.override){defaults.override(item.id,item.overrides);}
return scope;}
get(id){return this.items[id];}
unregister(item){const items=this.items;const id=item.id;const scope=this.scope;if(id in items){delete items[id];}
if(scope&&id in defaults[scope]){delete defaults[scope][id];if(this.override){delete overrides[id];}}}}
function registerDefaults(item,scope,parentScope){const itemDefaults=merge(Object.create(null),[parentScope?defaults.get(parentScope):{},defaults.get(scope),item.defaults]);defaults.set(scope,itemDefaults);if(item.defaultRoutes){routeDefaults(scope,item.defaultRoutes);}
if(item.descriptors){defaults.describe(scope,item.descriptors);}}
function routeDefaults(scope,routes){Object.keys(routes).forEach((property)=>{const propertyParts=property.split('.');const sourceName=propertyParts.pop();const sourceScope=[scope].concat(propertyParts).join('.');const parts=routes[property].split('.');const targetName=parts.pop();const targetScope=parts.join('.');defaults.route(sourceScope,sourceName,targetScope,targetName);});}
function isIChartComponent(proto){return'id'in proto&&'defaults'in proto;}
class Registry{constructor(){this.controllers=new TypedRegistry(DatasetController,'datasets',true);this.elements=new TypedRegistry(Element,'elements');this.plugins=new TypedRegistry(Object,'plugins');this.scales=new TypedRegistry(Scale,'scales');this._typedRegistries=[this.controllers,this.scales,this.elements];}
add(...args){this._each('register',args);}
remove(...args){this._each('unregister',args);}
addControllers(...args){this._each('register',args,this.controllers);}
addElements(...args){this._each('register',args,this.elements);}
addPlugins(...args){this._each('register',args,this.plugins);}
addScales(...args){this._each('register',args,this.scales);}
getController(id){return this._get(id,this.controllers,'controller');}
getElement(id){return this._get(id,this.elements,'element');}
getPlugin(id){return this._get(id,this.plugins,'plugin');}
getScale(id){return this._get(id,this.scales,'scale');}
removeControllers(...args){this._each('unregister',args,this.controllers);}
removeElements(...args){this._each('unregister',args,this.elements);}
removePlugins(...args){this._each('unregister',args,this.plugins);}
removeScales(...args){this._each('unregister',args,this.scales);}
_each(method,args,typedRegistry){[...args].forEach((arg)=>{const reg=typedRegistry||this._getRegistryForType(arg);if(typedRegistry||reg.isForType(arg)||reg===this.plugins&&arg.id){this._exec(method,reg,arg);}else{each(arg,(item)=>{const itemReg=typedRegistry||this._getRegistryForType(item);this._exec(method,itemReg,item);});}});}
_exec(method,registry,component){const camelMethod=_capitalize(method);callback(component['before'+camelMethod],[],component);registry[method](component);callback(component['after'+camelMethod],[],component);}
_getRegistryForType(type){for(let i=0;i<this._typedRegistries.length;i++){const reg=this._typedRegistries[i];if(reg.isForType(type)){return reg;}}
return this.plugins;}
_get(id,typedRegistry,type){const item=typedRegistry.get(id);if(item===undefined){throw new Error('"'+id+'" is not a registered '+type+'.');}
return item;}}
var registry=new Registry();class PluginService{constructor(){this._init=[];}
notify(chart,hook,args,filter){if(hook==='beforeInit'){this._init=this._createDescriptors(chart,true);this._notify(this._init,chart,'install');}
const descriptors=filter?this._descriptors(chart).filter(filter):this._descriptors(chart);const result=this._notify(descriptors,chart,hook,args);if(hook==='afterDestroy'){this._notify(descriptors,chart,'stop');this._notify(this._init,chart,'uninstall');}
return result;}
_notify(descriptors,chart,hook,args){args=args||{};for(const descriptor of descriptors){const plugin=descriptor.plugin;const method=plugin[hook];const params=[chart,args,descriptor.options];if(callback(method,params,plugin)===false&&args.cancelable){return false;}}
return true;}
invalidate(){if(!isNullOrUndef(this._cache)){this._oldCache=this._cache;this._cache=undefined;}}
_descriptors(chart){if(this._cache){return this._cache;}
const descriptors=this._cache=this._createDescriptors(chart);this._notifyStateChanges(chart);return descriptors;}
_createDescriptors(chart,all){const config=chart&&chart.config;const options=valueOrDefault(config.options&&config.options.plugins,{});const plugins=allPlugins(config);return options===false&&!all?[]:createDescriptors(chart,plugins,options,all);}
_notifyStateChanges(chart){const previousDescriptors=this._oldCache||[];const descriptors=this._cache;const diff=(a,b)=>a.filter((x)=>!b.some((y)=>x.plugin.id===y.plugin.id));this._notify(diff(previousDescriptors,descriptors),chart,'stop');this._notify(diff(descriptors,previousDescriptors),chart,'start');}}
function allPlugins(config){const localIds={};const plugins=[];const keys=Object.keys(registry.plugins.items);for(let i=0;i<keys.length;i++){plugins.push(registry.getPlugin(keys[i]));}
const local=config.plugins||[];for(let i=0;i<local.length;i++){const plugin=local[i];if(plugins.indexOf(plugin)===-1){plugins.push(plugin);localIds[plugin.id]=true;}}
return{plugins,localIds};}
function getOpts(options,all){if(!all&&options===false){return null;}
if(options===true){return{};}
return options;}
function createDescriptors(chart,{plugins,localIds},options,all){const result=[];const context=chart.getContext();for(const plugin of plugins){const id=plugin.id;const opts=getOpts(options[id],all);if(opts===null){continue;}
result.push({plugin,options:pluginOpts(chart.config,{plugin,local:localIds[id]},opts,context)});}
return result;}
function pluginOpts(config,{plugin,local},opts,context){const keys=config.pluginScopeKeys(plugin);const scopes=config.getOptionScopes(opts,keys);if(local&&plugin.defaults){scopes.push(plugin.defaults);}
return config.createResolver(scopes,context,[''],{scriptable:false,indexable:false,allKeys:true});}
function getIndexAxis(type,options){const datasetDefaults=defaults.datasets[type]||{};const datasetOptions=(options.datasets||{})[type]||{};return datasetOptions.indexAxis||options.indexAxis||datasetDefaults.indexAxis||'x';}
function getAxisFromDefaultScaleID(id,indexAxis){let axis=id;if(id==='_index_'){axis=indexAxis;}else if(id==='_value_'){axis=indexAxis==='x'?'y':'x';}
return axis;}
function getDefaultScaleIDFromAxis(axis,indexAxis){return axis===indexAxis?'_index_':'_value_';}
function idMatchesAxis(id){if(id==='x'||id==='y'||id==='r'){return id;}}
function axisFromPosition(position){if(position==='top'||position==='bottom'){return'x';}
if(position==='left'||position==='right'){return'y';}}
function determineAxis(id,...scaleOptions){if(idMatchesAxis(id)){return id;}
for(const opts of scaleOptions){const axis=opts.axis||axisFromPosition(opts.position)||id.length>1&&idMatchesAxis(id[0].toLowerCase());if(axis){return axis;}}
throw new Error(`Cannot determine type of '${id}' axis. Please provide 'axis' or 'position' option.`);}
function getAxisFromDataset(id,axis,dataset){if(dataset[axis+'AxisID']===id){return{axis};}}
function retrieveAxisFromDatasets(id,config){if(config.data&&config.data.datasets){const boundDs=config.data.datasets.filter((d)=>d.xAxisID===id||d.yAxisID===id);if(boundDs.length){return getAxisFromDataset(id,'x',boundDs[0])||getAxisFromDataset(id,'y',boundDs[0]);}}
return{};}
function mergeScaleConfig(config,options){const chartDefaults=overrides[config.type]||{scales:{}};const configScales=options.scales||{};const chartIndexAxis=getIndexAxis(config.type,options);const scales=Object.create(null);Object.keys(configScales).forEach((id)=>{const scaleConf=configScales[id];if(!isObject(scaleConf)){return console.error(`Invalid scale configuration for scale: ${id}`);}
if(scaleConf._proxy){return console.warn(`Ignoring resolver passed as options for scale: ${id}`);}
const axis=determineAxis(id,scaleConf,retrieveAxisFromDatasets(id,config),defaults.scales[scaleConf.type]);const defaultId=getDefaultScaleIDFromAxis(axis,chartIndexAxis);const defaultScaleOptions=chartDefaults.scales||{};scales[id]=mergeIf(Object.create(null),[{axis},scaleConf,defaultScaleOptions[axis],defaultScaleOptions[defaultId]]);});config.data.datasets.forEach((dataset)=>{const type=dataset.type||config.type;const indexAxis=dataset.indexAxis||getIndexAxis(type,options);const datasetDefaults=overrides[type]||{};const defaultScaleOptions=datasetDefaults.scales||{};Object.keys(defaultScaleOptions).forEach((defaultID)=>{const axis=getAxisFromDefaultScaleID(defaultID,indexAxis);const id=dataset[axis+'AxisID']||axis;scales[id]=scales[id]||Object.create(null);mergeIf(scales[id],[{axis},configScales[id],defaultScaleOptions[defaultID]]);});});Object.keys(scales).forEach((key)=>{const scale=scales[key];mergeIf(scale,[defaults.scales[scale.type],defaults.scale]);});return scales;}
function initOptions(config){const options=config.options||(config.options={});options.plugins=valueOrDefault(options.plugins,{});options.scales=mergeScaleConfig(config,options);}
function initData(data){data=data||{};data.datasets=data.datasets||[];data.labels=data.labels||[];return data;}
function initConfig(config){config=config||{};config.data=initData(config.data);initOptions(config);return config;}
const keyCache=new Map();const keysCached=new Set();function cachedKeys(cacheKey,generate){let keys=keyCache.get(cacheKey);if(!keys){keys=generate();keyCache.set(cacheKey,keys);keysCached.add(keys);}
return keys;}
const addIfFound=(set,obj,key)=>{const opts=resolveObjectKey(obj,key);if(opts!==undefined){set.add(opts);}};class Config{constructor(config){this._config=initConfig(config);this._scopeCache=new Map();this._resolverCache=new Map();}
get platform(){return this._config.platform;}
get type(){return this._config.type;}
set type(type){this._config.type=type;}
get data(){return this._config.data;}
set data(data){this._config.data=initData(data);}
get options(){return this._config.options;}
set options(options){this._config.options=options;}
get plugins(){return this._config.plugins;}
update(){const config=this._config;this.clearCache();initOptions(config);}
clearCache(){this._scopeCache.clear();this._resolverCache.clear();}
datasetScopeKeys(datasetType){return cachedKeys(datasetType,()=>[[`datasets.${datasetType}`,'']]);}
datasetAnimationScopeKeys(datasetType,transition){return cachedKeys(`${datasetType}.transition.${transition}`,()=>[[`datasets.${datasetType}.transitions.${transition}`,`transitions.${transition}`],[`datasets.${datasetType}`,'']]);}
datasetElementScopeKeys(datasetType,elementType){return cachedKeys(`${datasetType}-${elementType}`,()=>[[`datasets.${datasetType}.elements.${elementType}`,`datasets.${datasetType}`,`elements.${elementType}`,'']]);}
pluginScopeKeys(plugin){const id=plugin.id;const type=this.type;return cachedKeys(`${type}-plugin-${id}`,()=>[[`plugins.${id}`,...plugin.additionalOptionScopes||[]]]);}
_cachedScopes(mainScope,resetCache){const _scopeCache=this._scopeCache;let cache=_scopeCache.get(mainScope);if(!cache||resetCache){cache=new Map();_scopeCache.set(mainScope,cache);}
return cache;}
getOptionScopes(mainScope,keyLists,resetCache){const{options,type}=this;const cache=this._cachedScopes(mainScope,resetCache);const cached=cache.get(keyLists);if(cached){return cached;}
const scopes=new Set();keyLists.forEach((keys)=>{if(mainScope){scopes.add(mainScope);keys.forEach((key)=>addIfFound(scopes,mainScope,key));}
keys.forEach((key)=>addIfFound(scopes,options,key));keys.forEach((key)=>addIfFound(scopes,overrides[type]||{},key));keys.forEach((key)=>addIfFound(scopes,defaults,key));keys.forEach((key)=>addIfFound(scopes,descriptors,key));});const array=Array.from(scopes);if(array.length===0){array.push(Object.create(null));}
if(keysCached.has(keyLists)){cache.set(keyLists,array);}
return array;}
chartOptionScopes(){const{options,type}=this;return[options,overrides[type]||{},defaults.datasets[type]||{},{type},defaults,descriptors];}
resolveNamedOptions(scopes,names,context,prefixes=['']){const result={$shared:true};const{resolver,subPrefixes}=getResolver(this._resolverCache,scopes,prefixes);let options=resolver;if(needContext(resolver,names)){result.$shared=false;context=isFunction(context)?context():context;const subResolver=this.createResolver(scopes,context,subPrefixes);options=_attachContext(resolver,context,subResolver);}
for(const prop of names){result[prop]=options[prop];}
return result;}
createResolver(scopes,context,prefixes=[''],descriptorDefaults){const{resolver}=getResolver(this._resolverCache,scopes,prefixes);return isObject(context)?_attachContext(resolver,context,undefined,descriptorDefaults):resolver;}}
function getResolver(resolverCache,scopes,prefixes){let cache=resolverCache.get(scopes);if(!cache){cache=new Map();resolverCache.set(scopes,cache);}
const cacheKey=prefixes.join();let cached=cache.get(cacheKey);if(!cached){const resolver=_createResolver(scopes,prefixes);cached={resolver,subPrefixes:prefixes.filter((p)=>!p.toLowerCase().includes('hover'))};cache.set(cacheKey,cached);}
return cached;}
const hasFunction=(value)=>isObject(value)&&Object.getOwnPropertyNames(value).reduce((acc,key)=>acc||isFunction(value[key]),false);function needContext(proxy,names){const{isScriptable,isIndexable}=_descriptors(proxy);for(const prop of names){const scriptable=isScriptable(prop);const indexable=isIndexable(prop);const value=(indexable||scriptable)&&proxy[prop];if(scriptable&&(isFunction(value)||hasFunction(value))||indexable&&isArray(value)){return true;}}
return false;}
var version="4.3.0";const KNOWN_POSITIONS=['top','bottom','left','right','chartArea'];function positionIsHorizontal(position,axis){return position==='top'||position==='bottom'||KNOWN_POSITIONS.indexOf(position)===-1&&axis==='x';}
function compare2Level(l1,l2){return function(a,b){return a[l1]===b[l1]?a[l2]-b[l2]:a[l1]-b[l1];};}
function onAnimationsComplete(context){const chart=context.chart;const animationOptions=chart.options.animation;chart.notifyPlugins('afterRender');callback(animationOptions&&animationOptions.onComplete,[context],chart);}
function onAnimationProgress(context){const chart=context.chart;const animationOptions=chart.options.animation;callback(animationOptions&&animationOptions.onProgress,[context],chart);}
function getCanvas(item){if(_isDomSupported()&&typeof item==='string'){item=document.getElementById(item);}else if(item&&item.length){item=item[0];}
if(item&&item.canvas){item=item.canvas;}
return item;}
const instances={};const getChart=(key)=>{const canvas=getCanvas(key);return Object.values(instances).filter((c)=>c.canvas===canvas).pop();};function moveNumericKeys(obj,start,move){const keys=Object.keys(obj);for(const key of keys){const intKey=+key;if(intKey>=start){const value=obj[key];delete obj[key];if(move>0||intKey>start){obj[intKey+move]=value;}}}}
function determineLastEvent(e,lastEvent,inChartArea,isClick){if(!inChartArea||e.type==='mouseout'){return null;}
if(isClick){return lastEvent;}
return e;}
function getDatasetArea(meta){const{xScale,yScale}=meta;if(xScale&&yScale){return{left:xScale.left,right:xScale.right,top:yScale.top,bottom:yScale.bottom};}}
class Chart{static defaults=defaults;static instances=instances;static overrides=overrides;static registry=registry;static version=version;static getChart=getChart;static register(...items){registry.add(...items);invalidatePlugins();}
static unregister(...items){registry.remove(...items);invalidatePlugins();}
constructor(item,userConfig){const config=this.config=new Config(userConfig);const initialCanvas=getCanvas(item);const existingChart=getChart(initialCanvas);if(existingChart){throw new Error('Canvas is already in use. Chart with ID \''+existingChart.id+'\''+' must be destroyed before the canvas with ID \''+existingChart.canvas.id+'\' can be reused.');}
const options=config.createResolver(config.chartOptionScopes(),this.getContext());this.platform=new(config.platform||_detectPlatform(initialCanvas))();this.platform.updateConfig(config);const context=this.platform.acquireContext(initialCanvas,options.aspectRatio);const canvas=context&&context.canvas;const height=canvas&&canvas.height;const width=canvas&&canvas.width;this.id=uid();this.ctx=context;this.canvas=canvas;this.width=width;this.height=height;this._options=options;this._aspectRatio=this.aspectRatio;this._layers=[];this._metasets=[];this._stacks=undefined;this.boxes=[];this.currentDevicePixelRatio=undefined;this.chartArea=undefined;this._active=[];this._lastEvent=undefined;this._listeners={};this._responsiveListeners=undefined;this._sortedMetasets=[];this.scales={};this._plugins=new PluginService();this.$proxies={};this._hiddenIndices={};this.attached=false;this._animationsDisabled=undefined;this.$context=undefined;this._doResize=debounce((mode)=>this.update(mode),options.resizeDelay||0);this._dataChanges=[];instances[this.id]=this;if(!context||!canvas){console.error("Failed to create chart: can't acquire context from the given item");return;}
animator.listen(this,'complete',onAnimationsComplete);animator.listen(this,'progress',onAnimationProgress);this._initialize();if(this.attached){this.update();}}
get aspectRatio(){const{options:{aspectRatio,maintainAspectRatio},width,height,_aspectRatio}=this;if(!isNullOrUndef(aspectRatio)){return aspectRatio;}
if(maintainAspectRatio&&_aspectRatio){return _aspectRatio;}
return height?width/height:null;}
get data(){return this.config.data;}
set data(data){this.config.data=data;}
get options(){return this._options;}
set options(options){this.config.options=options;}
get registry(){return registry;}
_initialize(){this.notifyPlugins('beforeInit');if(this.options.responsive){this.resize();}else{retinaScale(this,this.options.devicePixelRatio);}
this.bindEvents();this.notifyPlugins('afterInit');return this;}
clear(){clearCanvas(this.canvas,this.ctx);return this;}
stop(){animator.stop(this);return this;}
resize(width,height){if(!animator.running(this)){this._resize(width,height);}else{this._resizeBeforeDraw={width,height};}}
_resize(width,height){const options=this.options;const canvas=this.canvas;const aspectRatio=options.maintainAspectRatio&&this.aspectRatio;const newSize=this.platform.getMaximumSize(canvas,width,height,aspectRatio);const newRatio=options.devicePixelRatio||this.platform.getDevicePixelRatio();const mode=this.width?'resize':'attach';this.width=newSize.width;this.height=newSize.height;this._aspectRatio=this.aspectRatio;if(!retinaScale(this,newRatio,true)){return;}
this.notifyPlugins('resize',{size:newSize});callback(options.onResize,[this,newSize],this);if(this.attached){if(this._doResize(mode)){this.render();}}}
ensureScalesHaveIDs(){const options=this.options;const scalesOptions=options.scales||{};each(scalesOptions,(axisOptions,axisID)=>{axisOptions.id=axisID;});}
buildOrUpdateScales(){const options=this.options;const scaleOpts=options.scales;const scales=this.scales;const updated=Object.keys(scales).reduce((obj,id)=>{obj[id]=false;return obj;},{});let items=[];if(scaleOpts){items=items.concat(Object.keys(scaleOpts).map((id)=>{const scaleOptions=scaleOpts[id];const axis=determineAxis(id,scaleOptions);const isRadial=axis==='r';const isHorizontal=axis==='x';return{options:scaleOptions,dposition:isRadial?'chartArea':isHorizontal?'bottom':'left',dtype:isRadial?'radialLinear':isHorizontal?'category':'linear'};}));}
each(items,(item)=>{const scaleOptions=item.options;const id=scaleOptions.id;const axis=determineAxis(id,scaleOptions);const scaleType=valueOrDefault(scaleOptions.type,item.dtype);if(scaleOptions.position===undefined||positionIsHorizontal(scaleOptions.position,axis)!==positionIsHorizontal(item.dposition)){scaleOptions.position=item.dposition;}
updated[id]=true;let scale=null;if(id in scales&&scales[id].type===scaleType){scale=scales[id];}else{const scaleClass=registry.getScale(scaleType);scale=new scaleClass({id,type:scaleType,ctx:this.ctx,chart:this});scales[scale.id]=scale;}
scale.init(scaleOptions,options);});each(updated,(hasUpdated,id)=>{if(!hasUpdated){delete scales[id];}});each(scales,(scale)=>{layouts.configure(this,scale,scale.options);layouts.addBox(this,scale);});}
_updateMetasets(){const metasets=this._metasets;const numData=this.data.datasets.length;const numMeta=metasets.length;metasets.sort((a,b)=>a.index-b.index);if(numMeta>numData){for(let i=numData;i<numMeta;++i){this._destroyDatasetMeta(i);}
metasets.splice(numData,numMeta-numData);}
this._sortedMetasets=metasets.slice(0).sort(compare2Level('order','index'));}
_removeUnreferencedMetasets(){const{_metasets:metasets,data:{datasets}}=this;if(metasets.length>datasets.length){delete this._stacks;}
metasets.forEach((meta,index)=>{if(datasets.filter((x)=>x===meta._dataset).length===0){this._destroyDatasetMeta(index);}});}
buildOrUpdateControllers(){const newControllers=[];const datasets=this.data.datasets;let i,ilen;this._removeUnreferencedMetasets();for(i=0,ilen=datasets.length;i<ilen;i++){const dataset=datasets[i];let meta=this.getDatasetMeta(i);const type=dataset.type||this.config.type;if(meta.type&&meta.type!==type){this._destroyDatasetMeta(i);meta=this.getDatasetMeta(i);}
meta.type=type;meta.indexAxis=dataset.indexAxis||getIndexAxis(type,this.options);meta.order=dataset.order||0;meta.index=i;meta.label=''+dataset.label;meta.visible=this.isDatasetVisible(i);if(meta.controller){meta.controller.updateIndex(i);meta.controller.linkScales();}else{const ControllerClass=registry.getController(type);const{datasetElementType,dataElementType}=defaults.datasets[type];Object.assign(ControllerClass,{dataElementType:registry.getElement(dataElementType),datasetElementType:datasetElementType&&registry.getElement(datasetElementType)});meta.controller=new ControllerClass(this,i);newControllers.push(meta.controller);}}
this._updateMetasets();return newControllers;}
_resetElements(){each(this.data.datasets,(dataset,datasetIndex)=>{this.getDatasetMeta(datasetIndex).controller.reset();},this);}
reset(){this._resetElements();this.notifyPlugins('reset');}
update(mode){const config=this.config;config.update();const options=this._options=config.createResolver(config.chartOptionScopes(),this.getContext());const animsDisabled=this._animationsDisabled=!options.animation;this._updateScales();this._checkEventBindings();this._updateHiddenIndices();this._plugins.invalidate();if(this.notifyPlugins('beforeUpdate',{mode,cancelable:true})===false){return;}
const newControllers=this.buildOrUpdateControllers();this.notifyPlugins('beforeElementsUpdate');let minPadding=0;for(let i=0,ilen=this.data.datasets.length;i<ilen;i++){const{controller}=this.getDatasetMeta(i);const reset=!animsDisabled&&newControllers.indexOf(controller)===-1;controller.buildOrUpdateElements(reset);minPadding=Math.max(+controller.getMaxOverflow(),minPadding);}
minPadding=this._minPadding=options.layout.autoPadding?minPadding:0;this._updateLayout(minPadding);if(!animsDisabled){each(newControllers,(controller)=>{controller.reset();});}
this._updateDatasets(mode);this.notifyPlugins('afterUpdate',{mode});this._layers.sort(compare2Level('z','_idx'));const{_active,_lastEvent}=this;if(_lastEvent){this._eventHandler(_lastEvent,true);}else if(_active.length){this._updateHoverStyles(_active,_active,true);}
this.render();}
_updateScales(){each(this.scales,(scale)=>{layouts.removeBox(this,scale);});this.ensureScalesHaveIDs();this.buildOrUpdateScales();}
_checkEventBindings(){const options=this.options;const existingEvents=new Set(Object.keys(this._listeners));const newEvents=new Set(options.events);if(!setsEqual(existingEvents,newEvents)||!!this._responsiveListeners!==options.responsive){this.unbindEvents();this.bindEvents();}}
_updateHiddenIndices(){const{_hiddenIndices}=this;const changes=this._getUniformDataChanges()||[];for(const{method,start,count}of changes){const move=method==='_removeElements'?-count:count;moveNumericKeys(_hiddenIndices,start,move);}}
_getUniformDataChanges(){const _dataChanges=this._dataChanges;if(!_dataChanges||!_dataChanges.length){return;}
this._dataChanges=[];const datasetCount=this.data.datasets.length;const makeSet=(idx)=>new Set(_dataChanges.filter((c)=>c[0]===idx).map((c,i)=>i+','+c.splice(1).join(',')));const changeSet=makeSet(0);for(let i=1;i<datasetCount;i++){if(!setsEqual(changeSet,makeSet(i))){return;}}
return Array.from(changeSet).map((c)=>c.split(',')).map((a)=>({method:a[1],start:+a[2],count:+a[3]}));}
_updateLayout(minPadding){if(this.notifyPlugins('beforeLayout',{cancelable:true})===false){return;}
layouts.update(this,this.width,this.height,minPadding);const area=this.chartArea;const noArea=area.width<=0||area.height<=0;this._layers=[];each(this.boxes,(box)=>{if(noArea&&box.position==='chartArea'){return;}
if(box.configure){box.configure();}
this._layers.push(...box._layers());},this);this._layers.forEach((item,index)=>{item._idx=index;});this.notifyPlugins('afterLayout');}
_updateDatasets(mode){if(this.notifyPlugins('beforeDatasetsUpdate',{mode,cancelable:true})===false){return;}
for(let i=0,ilen=this.data.datasets.length;i<ilen;++i){this.getDatasetMeta(i).controller.configure();}
for(let i=0,ilen=this.data.datasets.length;i<ilen;++i){this._updateDataset(i,isFunction(mode)?mode({datasetIndex:i}):mode);}
this.notifyPlugins('afterDatasetsUpdate',{mode});}
_updateDataset(index,mode){const meta=this.getDatasetMeta(index);const args={meta,index,mode,cancelable:true};if(this.notifyPlugins('beforeDatasetUpdate',args)===false){return;}
meta.controller._update(mode);args.cancelable=false;this.notifyPlugins('afterDatasetUpdate',args);}
render(){if(this.notifyPlugins('beforeRender',{cancelable:true})===false){return;}
if(animator.has(this)){if(this.attached&&!animator.running(this)){animator.start(this);}}else{this.draw();onAnimationsComplete({chart:this});}}
draw(){let i;if(this._resizeBeforeDraw){const{width,height}=this._resizeBeforeDraw;this._resize(width,height);this._resizeBeforeDraw=null;}
this.clear();if(this.width<=0||this.height<=0){return;}
if(this.notifyPlugins('beforeDraw',{cancelable:true})===false){return;}
const layers=this._layers;for(i=0;i<layers.length&&layers[i].z<=0;++i){layers[i].draw(this.chartArea);}
this._drawDatasets();for(;i<layers.length;++i){layers[i].draw(this.chartArea);}
this.notifyPlugins('afterDraw');}
_getSortedDatasetMetas(filterVisible){const metasets=this._sortedMetasets;const result=[];let i,ilen;for(i=0,ilen=metasets.length;i<ilen;++i){const meta=metasets[i];if(!filterVisible||meta.visible){result.push(meta);}}
return result;}
getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(true);}
_drawDatasets(){if(this.notifyPlugins('beforeDatasetsDraw',{cancelable:true})===false){return;}
const metasets=this.getSortedVisibleDatasetMetas();for(let i=metasets.length-1;i>=0;--i){this._drawDataset(metasets[i]);}
this.notifyPlugins('afterDatasetsDraw');}
_drawDataset(meta){const ctx=this.ctx;const clip=meta._clip;const useClip=!clip.disabled;const area=getDatasetArea(meta)||this.chartArea;const args={meta,index:meta.index,cancelable:true};if(this.notifyPlugins('beforeDatasetDraw',args)===false){return;}
if(useClip){clipArea(ctx,{left:clip.left===false?0:area.left-clip.left,right:clip.right===false?this.width:area.right+clip.right,top:clip.top===false?0:area.top-clip.top,bottom:clip.bottom===false?this.height:area.bottom+clip.bottom});}
meta.controller.draw();if(useClip){unclipArea(ctx);}
args.cancelable=false;this.notifyPlugins('afterDatasetDraw',args);}
isPointInArea(point){return _isPointInArea(point,this.chartArea,this._minPadding);}
getElementsAtEventForMode(e,mode,options,useFinalPosition){const method=Interaction.modes[mode];if(typeof method==='function'){return method(this,e,options,useFinalPosition);}
return[];}
getDatasetMeta(datasetIndex){const dataset=this.data.datasets[datasetIndex];const metasets=this._metasets;let meta=metasets.filter((x)=>x&&x._dataset===dataset).pop();if(!meta){meta={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:dataset&&dataset.order||0,index:datasetIndex,_dataset:dataset,_parsed:[],_sorted:false};metasets.push(meta);}
return meta;}
getContext(){return this.$context||(this.$context=createContext(null,{chart:this,type:'chart'}));}
getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length;}
isDatasetVisible(datasetIndex){const dataset=this.data.datasets[datasetIndex];if(!dataset){return false;}
const meta=this.getDatasetMeta(datasetIndex);return typeof meta.hidden==='boolean'?!meta.hidden:!dataset.hidden;}
setDatasetVisibility(datasetIndex,visible){const meta=this.getDatasetMeta(datasetIndex);meta.hidden=!visible;}
toggleDataVisibility(index){this._hiddenIndices[index]=!this._hiddenIndices[index];}
getDataVisibility(index){return!this._hiddenIndices[index];}
_updateVisibility(datasetIndex,dataIndex,visible){const mode=visible?'show':'hide';const meta=this.getDatasetMeta(datasetIndex);const anims=meta.controller._resolveAnimations(undefined,mode);if(defined(dataIndex)){meta.data[dataIndex].hidden=!visible;this.update();}else{this.setDatasetVisibility(datasetIndex,visible);anims.update(meta,{visible});this.update((ctx)=>ctx.datasetIndex===datasetIndex?mode:undefined);}}
hide(datasetIndex,dataIndex){this._updateVisibility(datasetIndex,dataIndex,false);}
show(datasetIndex,dataIndex){this._updateVisibility(datasetIndex,dataIndex,true);}
_destroyDatasetMeta(datasetIndex){const meta=this._metasets[datasetIndex];if(meta&&meta.controller){meta.controller._destroy();}
delete this._metasets[datasetIndex];}
_stop(){let i,ilen;this.stop();animator.remove(this);for(i=0,ilen=this.data.datasets.length;i<ilen;++i){this._destroyDatasetMeta(i);}}
destroy(){this.notifyPlugins('beforeDestroy');const{canvas,ctx}=this;this._stop();this.config.clearCache();if(canvas){this.unbindEvents();clearCanvas(canvas,ctx);this.platform.releaseContext(ctx);this.canvas=null;this.ctx=null;}
delete instances[this.id];this.notifyPlugins('afterDestroy');}
toBase64Image(...args){return this.canvas.toDataURL(...args);}
bindEvents(){this.bindUserEvents();if(this.options.responsive){this.bindResponsiveEvents();}else{this.attached=true;}}
bindUserEvents(){const listeners=this._listeners;const platform=this.platform;const _add=(type,listener)=>{platform.addEventListener(this,type,listener);listeners[type]=listener;};const listener=(e,x,y)=>{e.offsetX=x;e.offsetY=y;this._eventHandler(e);};each(this.options.events,(type)=>_add(type,listener));}
bindResponsiveEvents(){if(!this._responsiveListeners){this._responsiveListeners={};}
const listeners=this._responsiveListeners;const platform=this.platform;const _add=(type,listener)=>{platform.addEventListener(this,type,listener);listeners[type]=listener;};const _remove=(type,listener)=>{if(listeners[type]){platform.removeEventListener(this,type,listener);delete listeners[type];}};const listener=(width,height)=>{if(this.canvas){this.resize(width,height);}};let detached;const attached=()=>{_remove('attach',attached);this.attached=true;this.resize();_add('resize',listener);_add('detach',detached);};detached=()=>{this.attached=false;_remove('resize',listener);this._stop();this._resize(0,0);_add('attach',attached);};if(platform.isAttached(this.canvas)){attached();}else{detached();}}
unbindEvents(){each(this._listeners,(listener,type)=>{this.platform.removeEventListener(this,type,listener);});this._listeners={};each(this._responsiveListeners,(listener,type)=>{this.platform.removeEventListener(this,type,listener);});this._responsiveListeners=undefined;}
updateHoverStyle(items,mode,enabled){const prefix=enabled?'set':'remove';let meta,item,i,ilen;if(mode==='dataset'){meta=this.getDatasetMeta(items[0].datasetIndex);meta.controller['_'+prefix+'DatasetHoverStyle']();}
for(i=0,ilen=items.length;i<ilen;++i){item=items[i];const controller=item&&this.getDatasetMeta(item.datasetIndex).controller;if(controller){controller[prefix+'HoverStyle'](item.element,item.datasetIndex,item.index);}}}
getActiveElements(){return this._active||[];}
setActiveElements(activeElements){const lastActive=this._active||[];const active=activeElements.map(({datasetIndex,index})=>{const meta=this.getDatasetMeta(datasetIndex);if(!meta){throw new Error('No dataset found at index '+datasetIndex);}
return{datasetIndex,element:meta.data[index],index};});const changed=!_elementsEqual(active,lastActive);if(changed){this._active=active;this._lastEvent=null;this._updateHoverStyles(active,lastActive);}}
notifyPlugins(hook,args,filter){return this._plugins.notify(this,hook,args,filter);}
isPluginEnabled(pluginId){return this._plugins._cache.filter((p)=>p.plugin.id===pluginId).length===1;}
_updateHoverStyles(active,lastActive,replay){const hoverOptions=this.options.hover;const diff=(a,b)=>a.filter((x)=>!b.some((y)=>x.datasetIndex===y.datasetIndex&&x.index===y.index));const deactivated=diff(lastActive,active);const activated=replay?active:diff(active,lastActive);if(deactivated.length){this.updateHoverStyle(deactivated,hoverOptions.mode,false);}
if(activated.length&&hoverOptions.mode){this.updateHoverStyle(activated,hoverOptions.mode,true);}}
_eventHandler(e,replay){const args={event:e,replay,cancelable:true,inChartArea:this.isPointInArea(e)};const eventFilter=(plugin)=>(plugin.options.events||this.options.events).includes(e.native.type);if(this.notifyPlugins('beforeEvent',args,eventFilter)===false){return;}
const changed=this._handleEvent(e,replay,args.inChartArea);args.cancelable=false;this.notifyPlugins('afterEvent',args,eventFilter);if(changed||args.changed){this.render();}
return this;}
_handleEvent(e,replay,inChartArea){const{_active:lastActive=[],options}=this;const useFinalPosition=replay;const active=this._getActiveElements(e,lastActive,inChartArea,useFinalPosition);const isClick=_isClickEvent(e);const lastEvent=determineLastEvent(e,this._lastEvent,inChartArea,isClick);if(inChartArea){this._lastEvent=null;callback(options.onHover,[e,active,this],this);if(isClick){callback(options.onClick,[e,active,this],this);}}
const changed=!_elementsEqual(active,lastActive);if(changed||replay){this._active=active;this._updateHoverStyles(active,lastActive,replay);}
this._lastEvent=lastEvent;return changed;}
_getActiveElements(e,lastActive,inChartArea,useFinalPosition){if(e.type==='mouseout'){return[];}
if(!inChartArea){return lastActive;}
const hoverOptions=this.options.hover;return this.getElementsAtEventForMode(e,hoverOptions.mode,hoverOptions,useFinalPosition);}}
function invalidatePlugins(){return each(Chart.instances,(chart)=>chart._plugins.invalidate());}
function abstract(){throw new Error('This method is not implemented: Check that a complete date adapter is provided.');}
class DateAdapterBase{static override(members){Object.assign(DateAdapterBase.prototype,members);}
options;constructor(options){this.options=options||{};}
init(){}
formats(){return abstract();}
parse(){return abstract();}
format(){return abstract();}
add(){return abstract();}
diff(){return abstract();}
startOf(){return abstract();}
endOf(){return abstract();}}
var _adapters={_date:DateAdapterBase};function getAllScaleValues(scale,type){if(!scale._cache.$bar){const visibleMetas=scale.getMatchingVisibleMetas(type);let values=[];for(let i=0,ilen=visibleMetas.length;i<ilen;i++){values=values.concat(visibleMetas[i].controller.getAllParsedValues(scale));}
scale._cache.$bar=_arrayUnique(values.sort((a,b)=>a-b));}
return scale._cache.$bar;}
function computeMinSampleSize(meta){const scale=meta.iScale;const values=getAllScaleValues(scale,meta.type);let min=scale._length;let i,ilen,curr,prev;const updateMinAndPrev=()=>{if(curr===32767||curr===-32768){return;}
if(defined(prev)){min=Math.min(min,Math.abs(curr-prev)||min);}
prev=curr;};for(i=0,ilen=values.length;i<ilen;++i){curr=scale.getPixelForValue(values[i]);updateMinAndPrev();}
prev=undefined;for(i=0,ilen=scale.ticks.length;i<ilen;++i){curr=scale.getPixelForTick(i);updateMinAndPrev();}
return min;}
function computeFitCategoryTraits(index,ruler,options,stackCount){const thickness=options.barThickness;let size,ratio;if(isNullOrUndef(thickness)){size=ruler.min*options.categoryPercentage;ratio=options.barPercentage;}else{size=thickness*stackCount;ratio=1;}
return{chunk:size/stackCount,ratio,start:ruler.pixels[index]-size/2};}
function computeFlexCategoryTraits(index,ruler,options,stackCount){const pixels=ruler.pixels;const curr=pixels[index];let prev=index>0?pixels[index-1]:null;let next=index<pixels.length-1?pixels[index+1]:null;const percent=options.categoryPercentage;if(prev===null){prev=curr-(next===null?ruler.end-ruler.start:next-curr);}
if(next===null){next=curr+curr-prev;}
const start=curr-(curr-Math.min(prev,next))/2*percent;const size=Math.abs(next-prev)/2*percent;return{chunk:size/stackCount,ratio:options.barPercentage,start};}
function parseFloatBar(entry,item,vScale,i){const startValue=vScale.parse(entry[0],i);const endValue=vScale.parse(entry[1],i);const min=Math.min(startValue,endValue);const max=Math.max(startValue,endValue);let barStart=min;let barEnd=max;if(Math.abs(min)>Math.abs(max)){barStart=max;barEnd=min;}
item[vScale.axis]=barEnd;item._custom={barStart,barEnd,start:startValue,end:endValue,min,max};}
function parseValue(entry,item,vScale,i){if(isArray(entry)){parseFloatBar(entry,item,vScale,i);}else{item[vScale.axis]=vScale.parse(entry,i);}
return item;}
function parseArrayOrPrimitive(meta,data,start,count){const iScale=meta.iScale;const vScale=meta.vScale;const labels=iScale.getLabels();const singleScale=iScale===vScale;const parsed=[];let i,ilen,item,entry;for(i=start,ilen=start+count;i<ilen;++i){entry=data[i];item={};item[iScale.axis]=singleScale||iScale.parse(labels[i],i);parsed.push(parseValue(entry,item,vScale,i));}
return parsed;}
function isFloatBar(custom){return custom&&custom.barStart!==undefined&&custom.barEnd!==undefined;}
function barSign(size,vScale,actualBase){if(size!==0){return sign(size);}
return(vScale.isHorizontal()?1:-1)*(vScale.min>=actualBase?1:-1);}
function borderProps(properties){let reverse,start,end,top,bottom;if(properties.horizontal){reverse=properties.base>properties.x;start='left';end='right';}else{reverse=properties.base<properties.y;start='bottom';end='top';}
if(reverse){top='end';bottom='start';}else{top='start';bottom='end';}
return{start,end,reverse,top,bottom};}
function setBorderSkipped(properties,options,stack,index){let edge=options.borderSkipped;const res={};if(!edge){properties.borderSkipped=res;return;}
if(edge===true){properties.borderSkipped={top:true,right:true,bottom:true,left:true};return;}
const{start,end,reverse,top,bottom}=borderProps(properties);if(edge==='middle'&&stack){properties.enableBorderRadius=true;if((stack._top||0)===index){edge=top;}else if((stack._bottom||0)===index){edge=bottom;}else{res[parseEdge(bottom,start,end,reverse)]=true;edge=top;}}
res[parseEdge(edge,start,end,reverse)]=true;properties.borderSkipped=res;}
function parseEdge(edge,a,b,reverse){if(reverse){edge=swap(edge,a,b);edge=startEnd(edge,b,a);}else{edge=startEnd(edge,a,b);}
return edge;}
function swap(orig,v1,v2){return orig===v1?v2:orig===v2?v1:orig;}
function startEnd(v,start,end){return v==='start'?start:v==='end'?end:v;}
function setInflateAmount(properties,{inflateAmount},ratio){properties.inflateAmount=inflateAmount==='auto'?ratio===1?0.33:0:inflateAmount;}
class BarController extends DatasetController{static id='bar';static defaults={datasetElementType:false,dataElementType:'bar',categoryPercentage:0.8,barPercentage:0.9,grouped:true,animations:{numbers:{type:'number',properties:['x','y','base','width','height']}}};static overrides={scales:{_index_:{type:'category',offset:true,grid:{offset:true}},_value_:{type:'linear',beginAtZero:true}}};parsePrimitiveData(meta,data,start,count){return parseArrayOrPrimitive(meta,data,start,count);}
parseArrayData(meta,data,start,count){return parseArrayOrPrimitive(meta,data,start,count);}
parseObjectData(meta,data,start,count){const{iScale,vScale}=meta;const{xAxisKey='x',yAxisKey='y'}=this._parsing;const iAxisKey=iScale.axis==='x'?xAxisKey:yAxisKey;const vAxisKey=vScale.axis==='x'?xAxisKey:yAxisKey;const parsed=[];let i,ilen,item,obj;for(i=start,ilen=start+count;i<ilen;++i){obj=data[i];item={};item[iScale.axis]=iScale.parse(resolveObjectKey(obj,iAxisKey),i);parsed.push(parseValue(resolveObjectKey(obj,vAxisKey),item,vScale,i));}
return parsed;}
updateRangeFromParsed(range,scale,parsed,stack){super.updateRangeFromParsed(range,scale,parsed,stack);const custom=parsed._custom;if(custom&&scale===this._cachedMeta.vScale){range.min=Math.min(range.min,custom.min);range.max=Math.max(range.max,custom.max);}}
getMaxOverflow(){return 0;}
getLabelAndValue(index){const meta=this._cachedMeta;const{iScale,vScale}=meta;const parsed=this.getParsed(index);const custom=parsed._custom;const value=isFloatBar(custom)?'['+custom.start+', '+custom.end+']':''+vScale.getLabelForValue(parsed[vScale.axis]);return{label:''+iScale.getLabelForValue(parsed[iScale.axis]),value};}
initialize(){this.enableOptionSharing=true;super.initialize();const meta=this._cachedMeta;meta.stack=this.getDataset().stack;}
update(mode){const meta=this._cachedMeta;this.updateElements(meta.data,0,meta.data.length,mode);}
updateElements(bars,start,count,mode){const reset=mode==='reset';const{index,_cachedMeta:{vScale}}=this;const base=vScale.getBasePixel();const horizontal=vScale.isHorizontal();const ruler=this._getRuler();const{sharedOptions,includeOptions}=this._getSharedOptions(start,mode);for(let i=start;i<start+count;i++){const parsed=this.getParsed(i);const vpixels=reset||isNullOrUndef(parsed[vScale.axis])?{base,head:base}:this._calculateBarValuePixels(i);const ipixels=this._calculateBarIndexPixels(i,ruler);const stack=(parsed._stacks||{})[vScale.axis];const properties={horizontal,base:vpixels.base,enableBorderRadius:!stack||isFloatBar(parsed._custom)||index===stack._top||index===stack._bottom,x:horizontal?vpixels.head:ipixels.center,y:horizontal?ipixels.center:vpixels.head,height:horizontal?ipixels.size:Math.abs(vpixels.size),width:horizontal?Math.abs(vpixels.size):ipixels.size};if(includeOptions){properties.options=sharedOptions||this.resolveDataElementOptions(i,bars[i].active?'active':mode);}
const options=properties.options||bars[i].options;setBorderSkipped(properties,options,stack,index);setInflateAmount(properties,options,ruler.ratio);this.updateElement(bars[i],i,properties,mode);}}
_getStacks(last,dataIndex){const{iScale}=this._cachedMeta;const metasets=iScale.getMatchingVisibleMetas(this._type).filter((meta)=>meta.controller.options.grouped);const stacked=iScale.options.stacked;const stacks=[];const skipNull=(meta)=>{const parsed=meta.controller.getParsed(dataIndex);const val=parsed&&parsed[meta.vScale.axis];if(isNullOrUndef(val)||isNaN(val)){return true;}};for(const meta of metasets){if(dataIndex!==undefined&&skipNull(meta)){continue;}
if(stacked===false||stacks.indexOf(meta.stack)===-1||stacked===undefined&&meta.stack===undefined){stacks.push(meta.stack);}
if(meta.index===last){break;}}
if(!stacks.length){stacks.push(undefined);}
return stacks;}
_getStackCount(index){return this._getStacks(undefined,index).length;}
_getStackIndex(datasetIndex,name,dataIndex){const stacks=this._getStacks(datasetIndex,dataIndex);const index=name!==undefined?stacks.indexOf(name):-1;return index===-1?stacks.length-1:index;}
_getRuler(){const opts=this.options;const meta=this._cachedMeta;const iScale=meta.iScale;const pixels=[];let i,ilen;for(i=0,ilen=meta.data.length;i<ilen;++i){pixels.push(iScale.getPixelForValue(this.getParsed(i)[iScale.axis],i));}
const barThickness=opts.barThickness;const min=barThickness||computeMinSampleSize(meta);return{min,pixels,start:iScale._startPixel,end:iScale._endPixel,stackCount:this._getStackCount(),scale:iScale,grouped:opts.grouped,ratio:barThickness?1:opts.categoryPercentage*opts.barPercentage};}
_calculateBarValuePixels(index){const{_cachedMeta:{vScale,_stacked,index:datasetIndex},options:{base:baseValue,minBarLength}}=this;const actualBase=baseValue||0;const parsed=this.getParsed(index);const custom=parsed._custom;const floating=isFloatBar(custom);let value=parsed[vScale.axis];let start=0;let length=_stacked?this.applyStack(vScale,parsed,_stacked):value;let head,size;if(length!==value){start=length-value;length=value;}
if(floating){value=custom.barStart;length=custom.barEnd-custom.barStart;if(value!==0&&sign(value)!==sign(custom.barEnd)){start=0;}
start+=value;}
const startValue=!isNullOrUndef(baseValue)&&!floating?baseValue:start;let base=vScale.getPixelForValue(startValue);if(this.chart.getDataVisibility(index)){head=vScale.getPixelForValue(start+length);}else{head=base;}
size=head-base;if(Math.abs(size)<minBarLength){size=barSign(size,vScale,actualBase)*minBarLength;if(value===actualBase){base-=size/2;}
const startPixel=vScale.getPixelForDecimal(0);const endPixel=vScale.getPixelForDecimal(1);const min=Math.min(startPixel,endPixel);const max=Math.max(startPixel,endPixel);base=Math.max(Math.min(base,max),min);head=base+size;if(_stacked&&!floating){parsed._stacks[vScale.axis]._visualValues[datasetIndex]=vScale.getValueForPixel(head)-vScale.getValueForPixel(base);}}
if(base===vScale.getPixelForValue(actualBase)){const halfGrid=sign(size)*vScale.getLineWidthForValue(actualBase)/2;base+=halfGrid;size-=halfGrid;}
return{size,base,head,center:head+size/2};}
_calculateBarIndexPixels(index,ruler){const scale=ruler.scale;const options=this.options;const skipNull=options.skipNull;const maxBarThickness=valueOrDefault(options.maxBarThickness,Infinity);let center,size;if(ruler.grouped){const stackCount=skipNull?this._getStackCount(index):ruler.stackCount;const range=options.barThickness==='flex'?computeFlexCategoryTraits(index,ruler,options,stackCount):computeFitCategoryTraits(index,ruler,options,stackCount);const stackIndex=this._getStackIndex(this.index,this._cachedMeta.stack,skipNull?index:undefined);center=range.start+range.chunk*stackIndex+range.chunk/2;size=Math.min(maxBarThickness,range.chunk*range.ratio);}else{center=scale.getPixelForValue(this.getParsed(index)[scale.axis],index);size=Math.min(maxBarThickness,ruler.min*ruler.ratio);}
return{base:center-size/2,head:center+size/2,center,size};}
draw(){const meta=this._cachedMeta;const vScale=meta.vScale;const rects=meta.data;const ilen=rects.length;let i=0;for(;i<ilen;++i){if(this.getParsed(i)[vScale.axis]!==null){rects[i].draw(this._ctx);}}}}
class BubbleController extends DatasetController{static id='bubble';static defaults={datasetElementType:false,dataElementType:'point',animations:{numbers:{type:'number',properties:['x','y','borderWidth','radius']}}};static overrides={scales:{x:{type:'linear'},y:{type:'linear'}}};initialize(){this.enableOptionSharing=true;super.initialize();}
parsePrimitiveData(meta,data,start,count){const parsed=super.parsePrimitiveData(meta,data,start,count);for(let i=0;i<parsed.length;i++){parsed[i]._custom=this.resolveDataElementOptions(i+start).radius;}
return parsed;}
parseArrayData(meta,data,start,count){const parsed=super.parseArrayData(meta,data,start,count);for(let i=0;i<parsed.length;i++){const item=data[start+i];parsed[i]._custom=valueOrDefault(item[2],this.resolveDataElementOptions(i+start).radius);}
return parsed;}
parseObjectData(meta,data,start,count){const parsed=super.parseObjectData(meta,data,start,count);for(let i=0;i<parsed.length;i++){const item=data[start+i];parsed[i]._custom=valueOrDefault(item&&item.r&&+item.r,this.resolveDataElementOptions(i+start).radius);}
return parsed;}
getMaxOverflow(){const data=this._cachedMeta.data;let max=0;for(let i=data.length-1;i>=0;--i){max=Math.max(max,data[i].size(this.resolveDataElementOptions(i))/2);}
return max>0&&max;}
getLabelAndValue(index){const meta=this._cachedMeta;const labels=this.chart.data.labels||[];const{xScale,yScale}=meta;const parsed=this.getParsed(index);const x=xScale.getLabelForValue(parsed.x);const y=yScale.getLabelForValue(parsed.y);const r=parsed._custom;return{label:labels[index]||'',value:'('+x+', '+y+(r?', '+r:'')+')'};}
update(mode){const points=this._cachedMeta.data;this.updateElements(points,0,points.length,mode);}
updateElements(points,start,count,mode){const reset=mode==='reset';const{iScale,vScale}=this._cachedMeta;const{sharedOptions,includeOptions}=this._getSharedOptions(start,mode);const iAxis=iScale.axis;const vAxis=vScale.axis;for(let i=start;i<start+count;i++){const point=points[i];const parsed=!reset&&this.getParsed(i);const properties={};const iPixel=properties[iAxis]=reset?iScale.getPixelForDecimal(0.5):iScale.getPixelForValue(parsed[iAxis]);const vPixel=properties[vAxis]=reset?vScale.getBasePixel():vScale.getPixelForValue(parsed[vAxis]);properties.skip=isNaN(iPixel)||isNaN(vPixel);if(includeOptions){properties.options=sharedOptions||this.resolveDataElementOptions(i,point.active?'active':mode);if(reset){properties.options.radius=0;}}
this.updateElement(point,i,properties,mode);}}
resolveDataElementOptions(index,mode){const parsed=this.getParsed(index);let values=super.resolveDataElementOptions(index,mode);if(values.$shared){values=Object.assign({},values,{$shared:false});}
const radius=values.radius;if(mode!=='active'){values.radius=0;}
values.radius+=valueOrDefault(parsed&&parsed._custom,radius);return values;}}
function getRatioAndOffset(rotation,circumference,cutout){let ratioX=1;let ratioY=1;let offsetX=0;let offsetY=0;if(circumference<TAU){const startAngle=rotation;const endAngle=startAngle+circumference;const startX=Math.cos(startAngle);const startY=Math.sin(startAngle);const endX=Math.cos(endAngle);const endY=Math.sin(endAngle);const calcMax=(angle,a,b)=>_angleBetween(angle,startAngle,endAngle,true)?1:Math.max(a,a*cutout,b,b*cutout);const calcMin=(angle,a,b)=>_angleBetween(angle,startAngle,endAngle,true)?-1:Math.min(a,a*cutout,b,b*cutout);const maxX=calcMax(0,startX,endX);const maxY=calcMax(HALF_PI,startY,endY);const minX=calcMin(PI,startX,endX);const minY=calcMin(PI+HALF_PI,startY,endY);ratioX=(maxX-minX)/2;ratioY=(maxY-minY)/2;offsetX=-(maxX+minX)/2;offsetY=-(maxY+minY)/2;}
return{ratioX,ratioY,offsetX,offsetY};}
class DoughnutController extends DatasetController{static id='doughnut';static defaults={datasetElementType:false,dataElementType:'arc',animation:{animateRotate:true,animateScale:false},animations:{numbers:{type:'number',properties:['circumference','endAngle','innerRadius','outerRadius','startAngle','x','y','offset','borderWidth','spacing']}},cutout:'50%',rotation:0,circumference:360,radius:'100%',spacing:0,indexAxis:'r'};static descriptors={_scriptable:(name)=>name!=='spacing',_indexable:(name)=>name!=='spacing'&&!name.startsWith('borderDash')&&!name.startsWith('hoverBorderDash')};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(chart){const data=chart.data;if(data.labels.length&&data.datasets.length){const{labels:{pointStyle,color}}=chart.legend.options;return data.labels.map((label,i)=>{const meta=chart.getDatasetMeta(0);const style=meta.controller.getStyle(i);return{text:label,fillStyle:style.backgroundColor,strokeStyle:style.borderColor,fontColor:color,lineWidth:style.borderWidth,pointStyle:pointStyle,hidden:!chart.getDataVisibility(i),index:i};});}
return[];}},onClick(e,legendItem,legend){legend.chart.toggleDataVisibility(legendItem.index);legend.chart.update();}}}};constructor(chart,datasetIndex){super(chart,datasetIndex);this.enableOptionSharing=true;this.innerRadius=undefined;this.outerRadius=undefined;this.offsetX=undefined;this.offsetY=undefined;}
linkScales(){}
parse(start,count){const data=this.getDataset().data;const meta=this._cachedMeta;if(this._parsing===false){meta._parsed=data;}else{let getter=(i)=>+data[i];if(isObject(data[start])){const{key='value'}=this._parsing;getter=(i)=>+resolveObjectKey(data[i],key);}
let i,ilen;for(i=start,ilen=start+count;i<ilen;++i){meta._parsed[i]=getter(i);}}}
_getRotation(){return toRadians(this.options.rotation-90);}
_getCircumference(){return toRadians(this.options.circumference);}
_getRotationExtents(){let min=TAU;let max=-TAU;for(let i=0;i<this.chart.data.datasets.length;++i){if(this.chart.isDatasetVisible(i)&&this.chart.getDatasetMeta(i).type===this._type){const controller=this.chart.getDatasetMeta(i).controller;const rotation=controller._getRotation();const circumference=controller._getCircumference();min=Math.min(min,rotation);max=Math.max(max,rotation+circumference);}}
return{rotation:min,circumference:max-min};}
update(mode){const chart=this.chart;const{chartArea}=chart;const meta=this._cachedMeta;const arcs=meta.data;const spacing=this.getMaxBorderWidth()+this.getMaxOffset(arcs)+this.options.spacing;const maxSize=Math.max((Math.min(chartArea.width,chartArea.height)-spacing)/2,0);const cutout=Math.min(toPercentage(this.options.cutout,maxSize),1);const chartWeight=this._getRingWeight(this.index);const{circumference,rotation}=this._getRotationExtents();const{ratioX,ratioY,offsetX,offsetY}=getRatioAndOffset(rotation,circumference,cutout);const maxWidth=(chartArea.width-spacing)/ratioX;const maxHeight=(chartArea.height-spacing)/ratioY;const maxRadius=Math.max(Math.min(maxWidth,maxHeight)/2,0);const outerRadius=toDimension(this.options.radius,maxRadius);const innerRadius=Math.max(outerRadius*cutout,0);const radiusLength=(outerRadius-innerRadius)/this._getVisibleDatasetWeightTotal();this.offsetX=offsetX*outerRadius;this.offsetY=offsetY*outerRadius;meta.total=this.calculateTotal();this.outerRadius=outerRadius-radiusLength*this._getRingWeightOffset(this.index);this.innerRadius=Math.max(this.outerRadius-radiusLength*chartWeight,0);this.updateElements(arcs,0,arcs.length,mode);}
_circumference(i,reset){const opts=this.options;const meta=this._cachedMeta;const circumference=this._getCircumference();if(reset&&opts.animation.animateRotate||!this.chart.getDataVisibility(i)||meta._parsed[i]===null||meta.data[i].hidden){return 0;}
return this.calculateCircumference(meta._parsed[i]*circumference/TAU);}
updateElements(arcs,start,count,mode){const reset=mode==='reset';const chart=this.chart;const chartArea=chart.chartArea;const opts=chart.options;const animationOpts=opts.animation;const centerX=(chartArea.left+chartArea.right)/2;const centerY=(chartArea.top+chartArea.bottom)/2;const animateScale=reset&&animationOpts.animateScale;const innerRadius=animateScale?0:this.innerRadius;const outerRadius=animateScale?0:this.outerRadius;const{sharedOptions,includeOptions}=this._getSharedOptions(start,mode);let startAngle=this._getRotation();let i;for(i=0;i<start;++i){startAngle+=this._circumference(i,reset);}
for(i=start;i<start+count;++i){const circumference=this._circumference(i,reset);const arc=arcs[i];const properties={x:centerX+this.offsetX,y:centerY+this.offsetY,startAngle,endAngle:startAngle+circumference,circumference,outerRadius,innerRadius};if(includeOptions){properties.options=sharedOptions||this.resolveDataElementOptions(i,arc.active?'active':mode);}
startAngle+=circumference;this.updateElement(arc,i,properties,mode);}}
calculateTotal(){const meta=this._cachedMeta;const metaData=meta.data;let total=0;let i;for(i=0;i<metaData.length;i++){const value=meta._parsed[i];if(value!==null&&!isNaN(value)&&this.chart.getDataVisibility(i)&&!metaData[i].hidden){total+=Math.abs(value);}}
return total;}
calculateCircumference(value){const total=this._cachedMeta.total;if(total>0&&!isNaN(value)){return TAU*(Math.abs(value)/total);}
return 0;}
getLabelAndValue(index){const meta=this._cachedMeta;const chart=this.chart;const labels=chart.data.labels||[];const value=formatNumber(meta._parsed[index],chart.options.locale);return{label:labels[index]||'',value};}
getMaxBorderWidth(arcs){let max=0;const chart=this.chart;let i,ilen,meta,controller,options;if(!arcs){for(i=0,ilen=chart.data.datasets.length;i<ilen;++i){if(chart.isDatasetVisible(i)){meta=chart.getDatasetMeta(i);arcs=meta.data;controller=meta.controller;break;}}}
if(!arcs){return 0;}
for(i=0,ilen=arcs.length;i<ilen;++i){options=controller.resolveDataElementOptions(i);if(options.borderAlign!=='inner'){max=Math.max(max,options.borderWidth||0,options.hoverBorderWidth||0);}}
return max;}
getMaxOffset(arcs){let max=0;for(let i=0,ilen=arcs.length;i<ilen;++i){const options=this.resolveDataElementOptions(i);max=Math.max(max,options.offset||0,options.hoverOffset||0);}
return max;}
_getRingWeightOffset(datasetIndex){let ringWeightOffset=0;for(let i=0;i<datasetIndex;++i){if(this.chart.isDatasetVisible(i)){ringWeightOffset+=this._getRingWeight(i);}}
return ringWeightOffset;}
_getRingWeight(datasetIndex){return Math.max(valueOrDefault(this.chart.data.datasets[datasetIndex].weight,1),0);}
_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1;}}
class LineController extends DatasetController{static id='line';static defaults={datasetElementType:'line',dataElementType:'point',showLine:true,spanGaps:false};static overrides={scales:{_index_:{type:'category'},_value_:{type:'linear'}}};initialize(){this.enableOptionSharing=true;this.supportsDecimation=true;super.initialize();}
update(mode){const meta=this._cachedMeta;const{dataset:line,data:points=[],_dataset}=meta;const animationsDisabled=this.chart._animationsDisabled;let{start,count}=_getStartAndCountOfVisiblePoints(meta,points,animationsDisabled);this._drawStart=start;this._drawCount=count;if(_scaleRangesChanged(meta)){start=0;count=points.length;}
line._chart=this.chart;line._datasetIndex=this.index;line._decimated=!!_dataset._decimated;line.points=points;const options=this.resolveDatasetElementOptions(mode);if(!this.options.showLine){options.borderWidth=0;}
options.segment=this.options.segment;this.updateElement(line,undefined,{animated:!animationsDisabled,options},mode);this.updateElements(points,start,count,mode);}
updateElements(points,start,count,mode){const reset=mode==='reset';const{iScale,vScale,_stacked,_dataset}=this._cachedMeta;const{sharedOptions,includeOptions}=this._getSharedOptions(start,mode);const iAxis=iScale.axis;const vAxis=vScale.axis;const{spanGaps,segment}=this.options;const maxGapLength=isNumber(spanGaps)?spanGaps:Number.POSITIVE_INFINITY;const directUpdate=this.chart._animationsDisabled||reset||mode==='none';const end=start+count;const pointsCount=points.length;let prevParsed=start>0&&this.getParsed(start-1);for(let i=0;i<pointsCount;++i){const point=points[i];const properties=directUpdate?point:{};if(i<start||i>=end){properties.skip=true;continue;}
const parsed=this.getParsed(i);const nullData=isNullOrUndef(parsed[vAxis]);const iPixel=properties[iAxis]=iScale.getPixelForValue(parsed[iAxis],i);const vPixel=properties[vAxis]=reset||nullData?vScale.getBasePixel():vScale.getPixelForValue(_stacked?this.applyStack(vScale,parsed,_stacked):parsed[vAxis],i);properties.skip=isNaN(iPixel)||isNaN(vPixel)||nullData;properties.stop=i>0&&Math.abs(parsed[iAxis]-prevParsed[iAxis])>maxGapLength;if(segment){properties.parsed=parsed;properties.raw=_dataset.data[i];}
if(includeOptions){properties.options=sharedOptions||this.resolveDataElementOptions(i,point.active?'active':mode);}
if(!directUpdate){this.updateElement(point,i,properties,mode);}
prevParsed=parsed;}}
getMaxOverflow(){const meta=this._cachedMeta;const dataset=meta.dataset;const border=dataset.options&&dataset.options.borderWidth||0;const data=meta.data||[];if(!data.length){return border;}
const firstPoint=data[0].size(this.resolveDataElementOptions(0));const lastPoint=data[data.length-1].size(this.resolveDataElementOptions(data.length-1));return Math.max(border,firstPoint,lastPoint)/2;}
draw(){const meta=this._cachedMeta;meta.dataset.updateControlPoints(this.chart.chartArea,meta.iScale.axis);super.draw();}}
class PolarAreaController extends DatasetController{static id='polarArea';static defaults={dataElementType:'arc',animation:{animateRotate:true,animateScale:true},animations:{numbers:{type:'number',properties:['x','y','startAngle','endAngle','innerRadius','outerRadius']}},indexAxis:'r',startAngle:0};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(chart){const data=chart.data;if(data.labels.length&&data.datasets.length){const{labels:{pointStyle,color}}=chart.legend.options;return data.labels.map((label,i)=>{const meta=chart.getDatasetMeta(0);const style=meta.controller.getStyle(i);return{text:label,fillStyle:style.backgroundColor,strokeStyle:style.borderColor,fontColor:color,lineWidth:style.borderWidth,pointStyle:pointStyle,hidden:!chart.getDataVisibility(i),index:i};});}
return[];}},onClick(e,legendItem,legend){legend.chart.toggleDataVisibility(legendItem.index);legend.chart.update();}}},scales:{r:{type:'radialLinear',angleLines:{display:false},beginAtZero:true,grid:{circular:true},pointLabels:{display:false},startAngle:0}}};constructor(chart,datasetIndex){super(chart,datasetIndex);this.innerRadius=undefined;this.outerRadius=undefined;}
getLabelAndValue(index){const meta=this._cachedMeta;const chart=this.chart;const labels=chart.data.labels||[];const value=formatNumber(meta._parsed[index].r,chart.options.locale);return{label:labels[index]||'',value};}
parseObjectData(meta,data,start,count){return _parseObjectDataRadialScale.bind(this)(meta,data,start,count);}
update(mode){const arcs=this._cachedMeta.data;this._updateRadius();this.updateElements(arcs,0,arcs.length,mode);}
getMinMax(){const meta=this._cachedMeta;const range={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};meta.data.forEach((element,index)=>{const parsed=this.getParsed(index).r;if(!isNaN(parsed)&&this.chart.getDataVisibility(index)){if(parsed<range.min){range.min=parsed;}
if(parsed>range.max){range.max=parsed;}}});return range;}
_updateRadius(){const chart=this.chart;const chartArea=chart.chartArea;const opts=chart.options;const minSize=Math.min(chartArea.right-chartArea.left,chartArea.bottom-chartArea.top);const outerRadius=Math.max(minSize/2,0);const innerRadius=Math.max(opts.cutoutPercentage?outerRadius/100*opts.cutoutPercentage:1,0);const radiusLength=(outerRadius-innerRadius)/chart.getVisibleDatasetCount();this.outerRadius=outerRadius-radiusLength*this.index;this.innerRadius=this.outerRadius-radiusLength;}
updateElements(arcs,start,count,mode){const reset=mode==='reset';const chart=this.chart;const opts=chart.options;const animationOpts=opts.animation;const scale=this._cachedMeta.rScale;const centerX=scale.xCenter;const centerY=scale.yCenter;const datasetStartAngle=scale.getIndexAngle(0)-0.5*PI;let angle=datasetStartAngle;let i;const defaultAngle=360/this.countVisibleElements();for(i=0;i<start;++i){angle+=this._computeAngle(i,mode,defaultAngle);}
for(i=start;i<start+count;i++){const arc=arcs[i];let startAngle=angle;let endAngle=angle+this._computeAngle(i,mode,defaultAngle);let outerRadius=chart.getDataVisibility(i)?scale.getDistanceFromCenterForValue(this.getParsed(i).r):0;angle=endAngle;if(reset){if(animationOpts.animateScale){outerRadius=0;}
if(animationOpts.animateRotate){startAngle=endAngle=datasetStartAngle;}}
const properties={x:centerX,y:centerY,innerRadius:0,outerRadius,startAngle,endAngle,options:this.resolveDataElementOptions(i,arc.active?'active':mode)};this.updateElement(arc,i,properties,mode);}}
countVisibleElements(){const meta=this._cachedMeta;let count=0;meta.data.forEach((element,index)=>{if(!isNaN(this.getParsed(index).r)&&this.chart.getDataVisibility(index)){count++;}});return count;}
_computeAngle(index,mode,defaultAngle){return this.chart.getDataVisibility(index)?toRadians(this.resolveDataElementOptions(index,mode).angle||defaultAngle):0;}}
class PieController extends DoughnutController{static id='pie';static defaults={cutout:0,rotation:0,circumference:360,radius:'100%'};}
class RadarController extends DatasetController{static id='radar';static defaults={datasetElementType:'line',dataElementType:'point',indexAxis:'r',showLine:true,elements:{line:{fill:'start'}}};static overrides={aspectRatio:1,scales:{r:{type:'radialLinear'}}};getLabelAndValue(index){const vScale=this._cachedMeta.vScale;const parsed=this.getParsed(index);return{label:vScale.getLabels()[index],value:''+vScale.getLabelForValue(parsed[vScale.axis])};}
parseObjectData(meta,data,start,count){return _parseObjectDataRadialScale.bind(this)(meta,data,start,count);}
update(mode){const meta=this._cachedMeta;const line=meta.dataset;const points=meta.data||[];const labels=meta.iScale.getLabels();line.points=points;if(mode!=='resize'){const options=this.resolveDatasetElementOptions(mode);if(!this.options.showLine){options.borderWidth=0;}
const properties={_loop:true,_fullLoop:labels.length===points.length,options};this.updateElement(line,undefined,properties,mode);}
this.updateElements(points,0,points.length,mode);}
updateElements(points,start,count,mode){const scale=this._cachedMeta.rScale;const reset=mode==='reset';for(let i=start;i<start+count;i++){const point=points[i];const options=this.resolveDataElementOptions(i,point.active?'active':mode);const pointPosition=scale.getPointPositionForValue(i,this.getParsed(i).r);const x=reset?scale.xCenter:pointPosition.x;const y=reset?scale.yCenter:pointPosition.y;const properties={x,y,angle:pointPosition.angle,skip:isNaN(x)||isNaN(y),options};this.updateElement(point,i,properties,mode);}}}
class ScatterController extends DatasetController{static id='scatter';static defaults={datasetElementType:false,dataElementType:'point',showLine:false,fill:false};static overrides={interaction:{mode:'point'},scales:{x:{type:'linear'},y:{type:'linear'}}};getLabelAndValue(index){const meta=this._cachedMeta;const labels=this.chart.data.labels||[];const{xScale,yScale}=meta;const parsed=this.getParsed(index);const x=xScale.getLabelForValue(parsed.x);const y=yScale.getLabelForValue(parsed.y);return{label:labels[index]||'',value:'('+x+', '+y+')'};}
update(mode){const meta=this._cachedMeta;const{data:points=[]}=meta;const animationsDisabled=this.chart._animationsDisabled;let{start,count}=_getStartAndCountOfVisiblePoints(meta,points,animationsDisabled);this._drawStart=start;this._drawCount=count;if(_scaleRangesChanged(meta)){start=0;count=points.length;}
if(this.options.showLine){if(!this.datasetElementType){this.addElements();}
const{dataset:line,_dataset}=meta;line._chart=this.chart;line._datasetIndex=this.index;line._decimated=!!_dataset._decimated;line.points=points;const options=this.resolveDatasetElementOptions(mode);options.segment=this.options.segment;this.updateElement(line,undefined,{animated:!animationsDisabled,options},mode);}else if(this.datasetElementType){delete meta.dataset;this.datasetElementType=false;}
this.updateElements(points,start,count,mode);}
addElements(){const{showLine}=this.options;if(!this.datasetElementType&&showLine){this.datasetElementType=this.chart.registry.getElement('line');}
super.addElements();}
updateElements(points,start,count,mode){const reset=mode==='reset';const{iScale,vScale,_stacked,_dataset}=this._cachedMeta;const firstOpts=this.resolveDataElementOptions(start,mode);const sharedOptions=this.getSharedOptions(firstOpts);const includeOptions=this.includeOptions(mode,sharedOptions);const iAxis=iScale.axis;const vAxis=vScale.axis;const{spanGaps,segment}=this.options;const maxGapLength=isNumber(spanGaps)?spanGaps:Number.POSITIVE_INFINITY;const directUpdate=this.chart._animationsDisabled||reset||mode==='none';let prevParsed=start>0&&this.getParsed(start-1);for(let i=start;i<start+count;++i){const point=points[i];const parsed=this.getParsed(i);const properties=directUpdate?point:{};const nullData=isNullOrUndef(parsed[vAxis]);const iPixel=properties[iAxis]=iScale.getPixelForValue(parsed[iAxis],i);const vPixel=properties[vAxis]=reset||nullData?vScale.getBasePixel():vScale.getPixelForValue(_stacked?this.applyStack(vScale,parsed,_stacked):parsed[vAxis],i);properties.skip=isNaN(iPixel)||isNaN(vPixel)||nullData;properties.stop=i>0&&Math.abs(parsed[iAxis]-prevParsed[iAxis])>maxGapLength;if(segment){properties.parsed=parsed;properties.raw=_dataset.data[i];}
if(includeOptions){properties.options=sharedOptions||this.resolveDataElementOptions(i,point.active?'active':mode);}
if(!directUpdate){this.updateElement(point,i,properties,mode);}
prevParsed=parsed;}
this.updateSharedOptions(sharedOptions,mode,firstOpts);}
getMaxOverflow(){const meta=this._cachedMeta;const data=meta.data||[];if(!this.options.showLine){let max=0;for(let i=data.length-1;i>=0;--i){max=Math.max(max,data[i].size(this.resolveDataElementOptions(i))/2);}
return max>0&&max;}
const dataset=meta.dataset;const border=dataset.options&&dataset.options.borderWidth||0;if(!data.length){return border;}
const firstPoint=data[0].size(this.resolveDataElementOptions(0));const lastPoint=data[data.length-1].size(this.resolveDataElementOptions(data.length-1));return Math.max(border,firstPoint,lastPoint)/2;}}
var controllers=Object.freeze({__proto__:null,BarController:BarController,BubbleController:BubbleController,DoughnutController:DoughnutController,LineController:LineController,PieController:PieController,PolarAreaController:PolarAreaController,RadarController:RadarController,ScatterController:ScatterController});function clipArc(ctx,element,endAngle){const{startAngle,pixelMargin,x,y,outerRadius,innerRadius}=element;let angleMargin=pixelMargin/outerRadius;ctx.beginPath();ctx.arc(x,y,outerRadius,startAngle-angleMargin,endAngle+angleMargin);if(innerRadius>pixelMargin){angleMargin=pixelMargin/innerRadius;ctx.arc(x,y,innerRadius,endAngle+angleMargin,startAngle-angleMargin,true);}else{ctx.arc(x,y,pixelMargin,endAngle+HALF_PI,startAngle-HALF_PI);}
ctx.closePath();ctx.clip();}
function toRadiusCorners(value){return _readValueToProps(value,['outerStart','outerEnd','innerStart','innerEnd']);}
function parseBorderRadius$1(arc,innerRadius,outerRadius,angleDelta){const o=toRadiusCorners(arc.options.borderRadius);const halfThickness=(outerRadius-innerRadius)/2;const innerLimit=Math.min(halfThickness,angleDelta*innerRadius/2);const computeOuterLimit=(val)=>{const outerArcLimit=(outerRadius-Math.min(halfThickness,val))*angleDelta/2;return _limitValue(val,0,Math.min(halfThickness,outerArcLimit));};return{outerStart:computeOuterLimit(o.outerStart),outerEnd:computeOuterLimit(o.outerEnd),innerStart:_limitValue(o.innerStart,0,innerLimit),innerEnd:_limitValue(o.innerEnd,0,innerLimit)};}
function rThetaToXY(r,theta,x,y){return{x:x+r*Math.cos(theta),y:y+r*Math.sin(theta)};}
function pathArc(ctx,element,offset,spacing,end,circular){const{x,y,startAngle:start,pixelMargin,innerRadius:innerR}=element;const outerRadius=Math.max(element.outerRadius+spacing+offset-pixelMargin,0);const innerRadius=innerR>0?innerR+spacing+offset+pixelMargin:0;let spacingOffset=0;const alpha=end-start;if(spacing){const noSpacingInnerRadius=innerR>0?innerR-spacing:0;const noSpacingOuterRadius=outerRadius>0?outerRadius-spacing:0;const avNogSpacingRadius=(noSpacingInnerRadius+noSpacingOuterRadius)/2;const adjustedAngle=avNogSpacingRadius!==0?alpha*avNogSpacingRadius/(avNogSpacingRadius+spacing):alpha;spacingOffset=(alpha-adjustedAngle)/2;}
const beta=Math.max(0.001,alpha*outerRadius-offset/PI)/outerRadius;const angleOffset=(alpha-beta)/2;const startAngle=start+angleOffset+spacingOffset;const endAngle=end-angleOffset-spacingOffset;const{outerStart,outerEnd,innerStart,innerEnd}=parseBorderRadius$1(element,innerRadius,outerRadius,endAngle-startAngle);const outerStartAdjustedRadius=outerRadius-outerStart;const outerEndAdjustedRadius=outerRadius-outerEnd;const outerStartAdjustedAngle=startAngle+outerStart/outerStartAdjustedRadius;const outerEndAdjustedAngle=endAngle-outerEnd/outerEndAdjustedRadius;const innerStartAdjustedRadius=innerRadius+innerStart;const innerEndAdjustedRadius=innerRadius+innerEnd;const innerStartAdjustedAngle=startAngle+innerStart/innerStartAdjustedRadius;const innerEndAdjustedAngle=endAngle-innerEnd/innerEndAdjustedRadius;ctx.beginPath();if(circular){const outerMidAdjustedAngle=(outerStartAdjustedAngle+outerEndAdjustedAngle)/2;ctx.arc(x,y,outerRadius,outerStartAdjustedAngle,outerMidAdjustedAngle);ctx.arc(x,y,outerRadius,outerMidAdjustedAngle,outerEndAdjustedAngle);if(outerEnd>0){const pCenter=rThetaToXY(outerEndAdjustedRadius,outerEndAdjustedAngle,x,y);ctx.arc(pCenter.x,pCenter.y,outerEnd,outerEndAdjustedAngle,endAngle+HALF_PI);}
const p4=rThetaToXY(innerEndAdjustedRadius,endAngle,x,y);ctx.lineTo(p4.x,p4.y);if(innerEnd>0){const pCenter=rThetaToXY(innerEndAdjustedRadius,innerEndAdjustedAngle,x,y);ctx.arc(pCenter.x,pCenter.y,innerEnd,endAngle+HALF_PI,innerEndAdjustedAngle+Math.PI);}
const innerMidAdjustedAngle=(endAngle-innerEnd/innerRadius+(startAngle+innerStart/innerRadius))/2;ctx.arc(x,y,innerRadius,endAngle-innerEnd/innerRadius,innerMidAdjustedAngle,true);ctx.arc(x,y,innerRadius,innerMidAdjustedAngle,startAngle+innerStart/innerRadius,true);if(innerStart>0){const pCenter=rThetaToXY(innerStartAdjustedRadius,innerStartAdjustedAngle,x,y);ctx.arc(pCenter.x,pCenter.y,innerStart,innerStartAdjustedAngle+Math.PI,startAngle-HALF_PI);}
const p8=rThetaToXY(outerStartAdjustedRadius,startAngle,x,y);ctx.lineTo(p8.x,p8.y);if(outerStart>0){const pCenter=rThetaToXY(outerStartAdjustedRadius,outerStartAdjustedAngle,x,y);ctx.arc(pCenter.x,pCenter.y,outerStart,startAngle-HALF_PI,outerStartAdjustedAngle);}}else{ctx.moveTo(x,y);const outerStartX=Math.cos(outerStartAdjustedAngle)*outerRadius+x;const outerStartY=Math.sin(outerStartAdjustedAngle)*outerRadius+y;ctx.lineTo(outerStartX,outerStartY);const outerEndX=Math.cos(outerEndAdjustedAngle)*outerRadius+x;const outerEndY=Math.sin(outerEndAdjustedAngle)*outerRadius+y;ctx.lineTo(outerEndX,outerEndY);}
ctx.closePath();}
function drawArc(ctx,element,offset,spacing,circular){const{fullCircles,startAngle,circumference}=element;let endAngle=element.endAngle;if(fullCircles){pathArc(ctx,element,offset,spacing,endAngle,circular);for(let i=0;i<fullCircles;++i){ctx.fill();}
if(!isNaN(circumference)){endAngle=startAngle+(circumference%TAU||TAU);}}
pathArc(ctx,element,offset,spacing,endAngle,circular);ctx.fill();return endAngle;}
function drawBorder(ctx,element,offset,spacing,circular){const{fullCircles,startAngle,circumference,options}=element;const{borderWidth,borderJoinStyle,borderDash,borderDashOffset}=options;const inner=options.borderAlign==='inner';if(!borderWidth){return;}
ctx.setLineDash(borderDash||[]);ctx.lineDashOffset=borderDashOffset;if(inner){ctx.lineWidth=borderWidth*2;ctx.lineJoin=borderJoinStyle||'round';}else{ctx.lineWidth=borderWidth;ctx.lineJoin=borderJoinStyle||'bevel';}
let endAngle=element.endAngle;if(fullCircles){pathArc(ctx,element,offset,spacing,endAngle,circular);for(let i=0;i<fullCircles;++i){ctx.stroke();}
if(!isNaN(circumference)){endAngle=startAngle+(circumference%TAU||TAU);}}
if(inner){clipArc(ctx,element,endAngle);}
if(!fullCircles){pathArc(ctx,element,offset,spacing,endAngle,circular);ctx.stroke();}}
class ArcElement extends Element{static id='arc';static defaults={borderAlign:'center',borderColor:'#fff',borderDash:[],borderDashOffset:0,borderJoinStyle:undefined,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:undefined,circular:true};static defaultRoutes={backgroundColor:'backgroundColor'};static descriptors={_scriptable:true,_indexable:(name)=>name!=='borderDash'};circumference;endAngle;fullCircles;innerRadius;outerRadius;pixelMargin;startAngle;constructor(cfg){super();this.options=undefined;this.circumference=undefined;this.startAngle=undefined;this.endAngle=undefined;this.innerRadius=undefined;this.outerRadius=undefined;this.pixelMargin=0;this.fullCircles=0;if(cfg){Object.assign(this,cfg);}}
inRange(chartX,chartY,useFinalPosition){const point=this.getProps(['x','y'],useFinalPosition);const{angle,distance}=getAngleFromPoint(point,{x:chartX,y:chartY});const{startAngle,endAngle,innerRadius,outerRadius,circumference}=this.getProps(['startAngle','endAngle','innerRadius','outerRadius','circumference'],useFinalPosition);const rAdjust=(this.options.spacing+this.options.borderWidth)/2;const _circumference=valueOrDefault(circumference,endAngle-startAngle);const betweenAngles=_circumference>=TAU||_angleBetween(angle,startAngle,endAngle);const withinRadius=_isBetween(distance,innerRadius+rAdjust,outerRadius+rAdjust);return betweenAngles&&withinRadius;}
getCenterPoint(useFinalPosition){const{x,y,startAngle,endAngle,innerRadius,outerRadius}=this.getProps(['x','y','startAngle','endAngle','innerRadius','outerRadius'],useFinalPosition);const{offset,spacing}=this.options;const halfAngle=(startAngle+endAngle)/2;const halfRadius=(innerRadius+outerRadius+spacing+offset)/2;return{x:x+Math.cos(halfAngle)*halfRadius,y:y+Math.sin(halfAngle)*halfRadius};}
tooltipPosition(useFinalPosition){return this.getCenterPoint(useFinalPosition);}
draw(ctx){const{options,circumference}=this;const offset=(options.offset||0)/4;const spacing=(options.spacing||0)/2;const circular=options.circular;this.pixelMargin=options.borderAlign==='inner'?0.33:0;this.fullCircles=circumference>TAU?Math.floor(circumference/TAU):0;if(circumference===0||this.innerRadius<0||this.outerRadius<0){return;}
ctx.save();const halfAngle=(this.startAngle+this.endAngle)/2;ctx.translate(Math.cos(halfAngle)*offset,Math.sin(halfAngle)*offset);const fix=1-Math.sin(Math.min(PI,circumference||0));const radiusOffset=offset*fix;ctx.fillStyle=options.backgroundColor;ctx.strokeStyle=options.borderColor;drawArc(ctx,this,radiusOffset,spacing,circular);drawBorder(ctx,this,radiusOffset,spacing,circular);ctx.restore();}}
function setStyle(ctx,options,style=options){ctx.lineCap=valueOrDefault(style.borderCapStyle,options.borderCapStyle);ctx.setLineDash(valueOrDefault(style.borderDash,options.borderDash));ctx.lineDashOffset=valueOrDefault(style.borderDashOffset,options.borderDashOffset);ctx.lineJoin=valueOrDefault(style.borderJoinStyle,options.borderJoinStyle);ctx.lineWidth=valueOrDefault(style.borderWidth,options.borderWidth);ctx.strokeStyle=valueOrDefault(style.borderColor,options.borderColor);}
function lineTo(ctx,previous,target){ctx.lineTo(target.x,target.y);}
function getLineMethod(options){if(options.stepped){return _steppedLineTo;}
if(options.tension||options.cubicInterpolationMode==='monotone'){return _bezierCurveTo;}
return lineTo;}
function pathVars(points,segment,params={}){const count=points.length;const{start:paramsStart=0,end:paramsEnd=count-1}=params;const{start:segmentStart,end:segmentEnd}=segment;const start=Math.max(paramsStart,segmentStart);const end=Math.min(paramsEnd,segmentEnd);const outside=paramsStart<segmentStart&&paramsEnd<segmentStart||paramsStart>segmentEnd&&paramsEnd>segmentEnd;return{count,start,loop:segment.loop,ilen:end<start&&!outside?count+end-start:end-start};}
function pathSegment(ctx,line,segment,params){const{points,options}=line;const{count,start,loop,ilen}=pathVars(points,segment,params);const lineMethod=getLineMethod(options);let{move=true,reverse}=params||{};let i,point,prev;for(i=0;i<=ilen;++i){point=points[(start+(reverse?ilen-i:i))%count];if(point.skip){continue;}else if(move){ctx.moveTo(point.x,point.y);move=false;}else{lineMethod(ctx,prev,point,reverse,options.stepped);}
prev=point;}
if(loop){point=points[(start+(reverse?ilen:0))%count];lineMethod(ctx,prev,point,reverse,options.stepped);}
return!!loop;}
function fastPathSegment(ctx,line,segment,params){const points=line.points;const{count,start,ilen}=pathVars(points,segment,params);const{move=true,reverse}=params||{};let avgX=0;let countX=0;let i,point,prevX,minY,maxY,lastY;const pointIndex=(index)=>(start+(reverse?ilen-index:index))%count;const drawX=()=>{if(minY!==maxY){ctx.lineTo(avgX,maxY);ctx.lineTo(avgX,minY);ctx.lineTo(avgX,lastY);}};if(move){point=points[pointIndex(0)];ctx.moveTo(point.x,point.y);}
for(i=0;i<=ilen;++i){point=points[pointIndex(i)];if(point.skip){continue;}
const x=point.x;const y=point.y;const truncX=x|0;if(truncX===prevX){if(y<minY){minY=y;}else if(y>maxY){maxY=y;}
avgX=(countX*avgX+x)/++countX;}else{drawX();ctx.lineTo(x,y);prevX=truncX;countX=0;minY=maxY=y;}
lastY=y;}
drawX();}
function _getSegmentMethod(line){const opts=line.options;const borderDash=opts.borderDash&&opts.borderDash.length;const useFastPath=!line._decimated&&!line._loop&&!opts.tension&&opts.cubicInterpolationMode!=='monotone'&&!opts.stepped&&!borderDash;return useFastPath?fastPathSegment:pathSegment;}
function _getInterpolationMethod(options){if(options.stepped){return _steppedInterpolation;}
if(options.tension||options.cubicInterpolationMode==='monotone'){return _bezierInterpolation;}
return _pointInLine;}
function strokePathWithCache(ctx,line,start,count){let path=line._path;if(!path){path=line._path=new Path2D();if(line.path(path,start,count)){path.closePath();}}
setStyle(ctx,line.options);ctx.stroke(path);}
function strokePathDirect(ctx,line,start,count){const{segments,options}=line;const segmentMethod=_getSegmentMethod(line);for(const segment of segments){setStyle(ctx,options,segment.style);ctx.beginPath();if(segmentMethod(ctx,line,segment,{start,end:start+count-1})){ctx.closePath();}
ctx.stroke();}}
const usePath2D=typeof Path2D==='function';function draw(ctx,line,start,count){if(usePath2D&&!line.options.segment){strokePathWithCache(ctx,line,start,count);}else{strokePathDirect(ctx,line,start,count);}}
class LineElement extends Element{static id='line';static defaults={borderCapStyle:'butt',borderDash:[],borderDashOffset:0,borderJoinStyle:'miter',borderWidth:3,capBezierPoints:true,cubicInterpolationMode:'default',fill:false,spanGaps:false,stepped:false,tension:0};static defaultRoutes={backgroundColor:'backgroundColor',borderColor:'borderColor'};static descriptors={_scriptable:true,_indexable:(name)=>name!=='borderDash'&&name!=='fill'};constructor(cfg){super();this.animated=true;this.options=undefined;this._chart=undefined;this._loop=undefined;this._fullLoop=undefined;this._path=undefined;this._points=undefined;this._segments=undefined;this._decimated=false;this._pointsUpdated=false;this._datasetIndex=undefined;if(cfg){Object.assign(this,cfg);}}
updateControlPoints(chartArea,indexAxis){const options=this.options;if((options.tension||options.cubicInterpolationMode==='monotone')&&!options.stepped&&!this._pointsUpdated){const loop=options.spanGaps?this._loop:this._fullLoop;_updateBezierControlPoints(this._points,options,chartArea,loop,indexAxis);this._pointsUpdated=true;}}
set points(points){this._points=points;delete this._segments;delete this._path;this._pointsUpdated=false;}
get points(){return this._points;}
get segments(){return this._segments||(this._segments=_computeSegments(this,this.options.segment));}
first(){const segments=this.segments;const points=this.points;return segments.length&&points[segments[0].start];}
last(){const segments=this.segments;const points=this.points;const count=segments.length;return count&&points[segments[count-1].end];}
interpolate(point,property){const options=this.options;const value=point[property];const points=this.points;const segments=_boundSegments(this,{property,start:value,end:value});if(!segments.length){return;}
const result=[];const _interpolate=_getInterpolationMethod(options);let i,ilen;for(i=0,ilen=segments.length;i<ilen;++i){const{start,end}=segments[i];const p1=points[start];const p2=points[end];if(p1===p2){result.push(p1);continue;}
const t=Math.abs((value-p1[property])/(p2[property]-p1[property]));const interpolated=_interpolate(p1,p2,t,options.stepped);interpolated[property]=point[property];result.push(interpolated);}
return result.length===1?result[0]:result;}
pathSegment(ctx,segment,params){const segmentMethod=_getSegmentMethod(this);return segmentMethod(ctx,this,segment,params);}
path(ctx,start,count){const segments=this.segments;const segmentMethod=_getSegmentMethod(this);let loop=this._loop;start=start||0;count=count||this.points.length-start;for(const segment of segments){loop&=segmentMethod(ctx,this,segment,{start,end:start+count-1});}
return!!loop;}
draw(ctx,chartArea,start,count){const options=this.options||{};const points=this.points||[];if(points.length&&options.borderWidth){ctx.save();draw(ctx,this,start,count);ctx.restore();}
if(this.animated){this._pointsUpdated=false;this._path=undefined;}}}
function inRange$1(el,pos,axis,useFinalPosition){const options=el.options;const{[axis]:value}=el.getProps([axis],useFinalPosition);return Math.abs(pos-value)<options.radius+options.hitRadius;}
class PointElement extends Element{static id='point';parsed;skip;stop;static defaults={borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:'circle',radius:3,rotation:0};static defaultRoutes={backgroundColor:'backgroundColor',borderColor:'borderColor'};constructor(cfg){super();this.options=undefined;this.parsed=undefined;this.skip=undefined;this.stop=undefined;if(cfg){Object.assign(this,cfg);}}
inRange(mouseX,mouseY,useFinalPosition){const options=this.options;const{x,y}=this.getProps(['x','y'],useFinalPosition);return Math.pow(mouseX-x,2)+Math.pow(mouseY-y,2)<Math.pow(options.hitRadius+options.radius,2);}
inXRange(mouseX,useFinalPosition){return inRange$1(this,mouseX,'x',useFinalPosition);}
inYRange(mouseY,useFinalPosition){return inRange$1(this,mouseY,'y',useFinalPosition);}
getCenterPoint(useFinalPosition){const{x,y}=this.getProps(['x','y'],useFinalPosition);return{x,y};}
size(options){options=options||this.options||{};let radius=options.radius||0;radius=Math.max(radius,radius&&options.hoverRadius||0);const borderWidth=radius&&options.borderWidth||0;return(radius+borderWidth)*2;}
draw(ctx,area){const options=this.options;if(this.skip||options.radius<0.1||!_isPointInArea(this,area,this.size(options)/2)){return;}
ctx.strokeStyle=options.borderColor;ctx.lineWidth=options.borderWidth;ctx.fillStyle=options.backgroundColor;drawPoint(ctx,options,this.x,this.y);}
getRange(){const options=this.options||{};return options.radius+options.hitRadius;}}
function getBarBounds(bar,useFinalPosition){const{x,y,base,width,height}=bar.getProps(['x','y','base','width','height'],useFinalPosition);let left,right,top,bottom,half;if(bar.horizontal){half=height/2;left=Math.min(x,base);right=Math.max(x,base);top=y-half;bottom=y+half;}else{half=width/2;left=x-half;right=x+half;top=Math.min(y,base);bottom=Math.max(y,base);}
return{left,top,right,bottom};}
function skipOrLimit(skip,value,min,max){return skip?0:_limitValue(value,min,max);}
function parseBorderWidth(bar,maxW,maxH){const value=bar.options.borderWidth;const skip=bar.borderSkipped;const o=toTRBL(value);return{t:skipOrLimit(skip.top,o.top,0,maxH),r:skipOrLimit(skip.right,o.right,0,maxW),b:skipOrLimit(skip.bottom,o.bottom,0,maxH),l:skipOrLimit(skip.left,o.left,0,maxW)};}
function parseBorderRadius(bar,maxW,maxH){const{enableBorderRadius}=bar.getProps(['enableBorderRadius']);const value=bar.options.borderRadius;const o=toTRBLCorners(value);const maxR=Math.min(maxW,maxH);const skip=bar.borderSkipped;const enableBorder=enableBorderRadius||isObject(value);return{topLeft:skipOrLimit(!enableBorder||skip.top||skip.left,o.topLeft,0,maxR),topRight:skipOrLimit(!enableBorder||skip.top||skip.right,o.topRight,0,maxR),bottomLeft:skipOrLimit(!enableBorder||skip.bottom||skip.left,o.bottomLeft,0,maxR),bottomRight:skipOrLimit(!enableBorder||skip.bottom||skip.right,o.bottomRight,0,maxR)};}
function boundingRects(bar){const bounds=getBarBounds(bar);const width=bounds.right-bounds.left;const height=bounds.bottom-bounds.top;const border=parseBorderWidth(bar,width/2,height/2);const radius=parseBorderRadius(bar,width/2,height/2);return{outer:{x:bounds.left,y:bounds.top,w:width,h:height,radius},inner:{x:bounds.left+border.l,y:bounds.top+border.t,w:width-border.l-border.r,h:height-border.t-border.b,radius:{topLeft:Math.max(0,radius.topLeft-Math.max(border.t,border.l)),topRight:Math.max(0,radius.topRight-Math.max(border.t,border.r)),bottomLeft:Math.max(0,radius.bottomLeft-Math.max(border.b,border.l)),bottomRight:Math.max(0,radius.bottomRight-Math.max(border.b,border.r))}}};}
function inRange(bar,x,y,useFinalPosition){const skipX=x===null;const skipY=y===null;const skipBoth=skipX&&skipY;const bounds=bar&&!skipBoth&&getBarBounds(bar,useFinalPosition);return bounds&&(skipX||_isBetween(x,bounds.left,bounds.right))&&(skipY||_isBetween(y,bounds.top,bounds.bottom));}
function hasRadius(radius){return radius.topLeft||radius.topRight||radius.bottomLeft||radius.bottomRight;}
function addNormalRectPath(ctx,rect){ctx.rect(rect.x,rect.y,rect.w,rect.h);}
function inflateRect(rect,amount,refRect={}){const x=rect.x!==refRect.x?-amount:0;const y=rect.y!==refRect.y?-amount:0;const w=(rect.x+rect.w!==refRect.x+refRect.w?amount:0)-x;const h=(rect.y+rect.h!==refRect.y+refRect.h?amount:0)-y;return{x:rect.x+x,y:rect.y+y,w:rect.w+w,h:rect.h+h,radius:rect.radius};}
class BarElement extends Element{static id='bar';static defaults={borderSkipped:'start',borderWidth:0,borderRadius:0,inflateAmount:'auto',pointStyle:undefined};static defaultRoutes={backgroundColor:'backgroundColor',borderColor:'borderColor'};constructor(cfg){super();this.options=undefined;this.horizontal=undefined;this.base=undefined;this.width=undefined;this.height=undefined;this.inflateAmount=undefined;if(cfg){Object.assign(this,cfg);}}
draw(ctx){const{inflateAmount,options:{borderColor,backgroundColor}}=this;const{inner,outer}=boundingRects(this);const addRectPath=hasRadius(outer.radius)?addRoundedRectPath:addNormalRectPath;ctx.save();if(outer.w!==inner.w||outer.h!==inner.h){ctx.beginPath();addRectPath(ctx,inflateRect(outer,inflateAmount,inner));ctx.clip();addRectPath(ctx,inflateRect(inner,-inflateAmount,outer));ctx.fillStyle=borderColor;ctx.fill('evenodd');}
ctx.beginPath();addRectPath(ctx,inflateRect(inner,inflateAmount));ctx.fillStyle=backgroundColor;ctx.fill();ctx.restore();}
inRange(mouseX,mouseY,useFinalPosition){return inRange(this,mouseX,mouseY,useFinalPosition);}
inXRange(mouseX,useFinalPosition){return inRange(this,mouseX,null,useFinalPosition);}
inYRange(mouseY,useFinalPosition){return inRange(this,null,mouseY,useFinalPosition);}
getCenterPoint(useFinalPosition){const{x,y,base,horizontal}=this.getProps(['x','y','base','horizontal'],useFinalPosition);return{x:horizontal?(x+base)/2:x,y:horizontal?y:(y+base)/2};}
getRange(axis){return axis==='x'?this.width/2:this.height/2;}}
var elements=Object.freeze({__proto__:null,ArcElement:ArcElement,BarElement:BarElement,LineElement:LineElement,PointElement:PointElement});const addIfString=(labels,raw,index,addedLabels)=>{if(typeof raw==='string'){index=labels.push(raw)-1;addedLabels.unshift({index,label:raw});}else if(isNaN(raw)){index=null;}
return index;};function findOrAddLabel(labels,raw,index,addedLabels){const first=labels.indexOf(raw);if(first===-1){return addIfString(labels,raw,index,addedLabels);}
const last=labels.lastIndexOf(raw);return first!==last?index:first;}
const validIndex=(index,max)=>index===null?null:_limitValue(Math.round(index),0,max);function _getLabelForValue(value){const labels=this.getLabels();if(value>=0&&value<labels.length){return labels[value];}
return value;}
class CategoryScale extends Scale{static id='category';static defaults={ticks:{callback:_getLabelForValue}};constructor(cfg){super(cfg);this._startValue=undefined;this._valueRange=0;this._addedLabels=[];}
init(scaleOptions){const added=this._addedLabels;if(added.length){const labels=this.getLabels();for(const{index,label}of added){if(labels[index]===label){labels.splice(index,1);}}
this._addedLabels=[];}
super.init(scaleOptions);}
parse(raw,index){if(isNullOrUndef(raw)){return null;}
const labels=this.getLabels();index=isFinite(index)&&labels[index]===raw?index:findOrAddLabel(labels,raw,valueOrDefault(index,raw),this._addedLabels);return validIndex(index,labels.length-1);}
determineDataLimits(){const{minDefined,maxDefined}=this.getUserBounds();let{min,max}=this.getMinMax(true);if(this.options.bounds==='ticks'){if(!minDefined){min=0;}
if(!maxDefined){max=this.getLabels().length-1;}}
this.min=min;this.max=max;}
buildTicks(){const min=this.min;const max=this.max;const offset=this.options.offset;const ticks=[];let labels=this.getLabels();labels=min===0&&max===labels.length-1?labels:labels.slice(min,max+1);this._valueRange=Math.max(labels.length-(offset?0:1),1);this._startValue=this.min-(offset?0.5:0);for(let value=min;value<=max;value++){ticks.push({value});}
return ticks;}
getLabelForValue(value){return _getLabelForValue.call(this,value);}
configure(){super.configure();if(!this.isHorizontal()){this._reversePixels=!this._reversePixels;}}
getPixelForValue(value){if(typeof value!=='number'){value=this.parse(value);}
return value===null?NaN:this.getPixelForDecimal((value-this._startValue)/this._valueRange);}
getPixelForTick(index){const ticks=this.ticks;if(index<0||index>ticks.length-1){return null;}
return this.getPixelForValue(ticks[index].value);}
getValueForPixel(pixel){return Math.round(this._startValue+this.getDecimalForPixel(pixel)*this._valueRange);}
getBasePixel(){return this.bottom;}}
function generateTicks$1(generationOptions,dataRange){const ticks=[];const MIN_SPACING=1e-14;const{bounds,step,min,max,precision,count,maxTicks,maxDigits,includeBounds}=generationOptions;const unit=step||1;const maxSpaces=maxTicks-1;const{min:rmin,max:rmax}=dataRange;const minDefined=!isNullOrUndef(min);const maxDefined=!isNullOrUndef(max);const countDefined=!isNullOrUndef(count);const minSpacing=(rmax-rmin)/(maxDigits+1);let spacing=niceNum((rmax-rmin)/maxSpaces/unit)*unit;let factor,niceMin,niceMax,numSpaces;if(spacing<MIN_SPACING&&!minDefined&&!maxDefined){return[{value:rmin},{value:rmax}];}
numSpaces=Math.ceil(rmax/spacing)-Math.floor(rmin/spacing);if(numSpaces>maxSpaces){spacing=niceNum(numSpaces*spacing/maxSpaces/unit)*unit;}
if(!isNullOrUndef(precision)){factor=Math.pow(10,precision);spacing=Math.ceil(spacing*factor)/factor;}
if(bounds==='ticks'){niceMin=Math.floor(rmin/spacing)*spacing;niceMax=Math.ceil(rmax/spacing)*spacing;}else{niceMin=rmin;niceMax=rmax;}
if(minDefined&&maxDefined&&step&&almostWhole((max-min)/step,spacing/1000)){numSpaces=Math.round(Math.min((max-min)/spacing,maxTicks));spacing=(max-min)/numSpaces;niceMin=min;niceMax=max;}else if(countDefined){niceMin=minDefined?min:niceMin;niceMax=maxDefined?max:niceMax;numSpaces=count-1;spacing=(niceMax-niceMin)/numSpaces;}else{numSpaces=(niceMax-niceMin)/spacing;if(almostEquals(numSpaces,Math.round(numSpaces),spacing/1000)){numSpaces=Math.round(numSpaces);}else{numSpaces=Math.ceil(numSpaces);}}
const decimalPlaces=Math.max(_decimalPlaces(spacing),_decimalPlaces(niceMin));factor=Math.pow(10,isNullOrUndef(precision)?decimalPlaces:precision);niceMin=Math.round(niceMin*factor)/factor;niceMax=Math.round(niceMax*factor)/factor;let j=0;if(minDefined){if(includeBounds&&niceMin!==min){ticks.push({value:min});if(niceMin<min){j++;}
if(almostEquals(Math.round((niceMin+j*spacing)*factor)/factor,min,relativeLabelSize(min,minSpacing,generationOptions))){j++;}}else if(niceMin<min){j++;}}
for(;j<numSpaces;++j){const tickValue=Math.round((niceMin+j*spacing)*factor)/factor;if(maxDefined&&tickValue>max){break;}
ticks.push({value:tickValue});}
if(maxDefined&&includeBounds&&niceMax!==max){if(ticks.length&&almostEquals(ticks[ticks.length-1].value,max,relativeLabelSize(max,minSpacing,generationOptions))){ticks[ticks.length-1].value=max;}else{ticks.push({value:max});}}else if(!maxDefined||niceMax===max){ticks.push({value:niceMax});}
return ticks;}
function relativeLabelSize(value,minSpacing,{horizontal,minRotation}){const rad=toRadians(minRotation);const ratio=(horizontal?Math.sin(rad):Math.cos(rad))||0.001;const length=0.75*minSpacing*(''+value).length;return Math.min(minSpacing/ratio,length);}
class LinearScaleBase extends Scale{constructor(cfg){super(cfg);this.start=undefined;this.end=undefined;this._startValue=undefined;this._endValue=undefined;this._valueRange=0;}
parse(raw,index){if(isNullOrUndef(raw)){return null;}
if((typeof raw==='number'||raw instanceof Number)&&!isFinite(+raw)){return null;}
return+raw;}
handleTickRangeOptions(){const{beginAtZero}=this.options;const{minDefined,maxDefined}=this.getUserBounds();let{min,max}=this;const setMin=(v)=>min=minDefined?min:v;const setMax=(v)=>max=maxDefined?max:v;if(beginAtZero){const minSign=sign(min);const maxSign=sign(max);if(minSign<0&&maxSign<0){setMax(0);}else if(minSign>0&&maxSign>0){setMin(0);}}
if(min===max){let offset=max===0?1:Math.abs(max*0.05);setMax(max+offset);if(!beginAtZero){setMin(min-offset);}}
this.min=min;this.max=max;}
getTickLimit(){const tickOpts=this.options.ticks;let{maxTicksLimit,stepSize}=tickOpts;let maxTicks;if(stepSize){maxTicks=Math.ceil(this.max/stepSize)-Math.floor(this.min/stepSize)+1;if(maxTicks>1000){console.warn(`scales.${this.id}.ticks.stepSize: ${stepSize} would result generating up to ${maxTicks} ticks. Limiting to 1000.`);maxTicks=1000;}}else{maxTicks=this.computeTickLimit();maxTicksLimit=maxTicksLimit||11;}
if(maxTicksLimit){maxTicks=Math.min(maxTicksLimit,maxTicks);}
return maxTicks;}
computeTickLimit(){return Number.POSITIVE_INFINITY;}
buildTicks(){const opts=this.options;const tickOpts=opts.ticks;let maxTicks=this.getTickLimit();maxTicks=Math.max(2,maxTicks);const numericGeneratorOptions={maxTicks,bounds:opts.bounds,min:opts.min,max:opts.max,precision:tickOpts.precision,step:tickOpts.stepSize,count:tickOpts.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:tickOpts.minRotation||0,includeBounds:tickOpts.includeBounds!==false};const dataRange=this._range||this;const ticks=generateTicks$1(numericGeneratorOptions,dataRange);if(opts.bounds==='ticks'){_setMinAndMaxByKey(ticks,this,'value');}
if(opts.reverse){ticks.reverse();this.start=this.max;this.end=this.min;}else{this.start=this.min;this.end=this.max;}
return ticks;}
configure(){const ticks=this.ticks;let start=this.min;let end=this.max;super.configure();if(this.options.offset&&ticks.length){const offset=(end-start)/Math.max(ticks.length-1,1)/2;start-=offset;end+=offset;}
this._startValue=start;this._endValue=end;this._valueRange=end-start;}
getLabelForValue(value){return formatNumber(value,this.chart.options.locale,this.options.ticks.format);}}
class LinearScale extends LinearScaleBase{static id='linear';static defaults={ticks:{callback:Ticks.formatters.numeric}};determineDataLimits(){const{min,max}=this.getMinMax(true);this.min=isNumberFinite(min)?min:0;this.max=isNumberFinite(max)?max:1;this.handleTickRangeOptions();}
computeTickLimit(){const horizontal=this.isHorizontal();const length=horizontal?this.width:this.height;const minRotation=toRadians(this.options.ticks.minRotation);const ratio=(horizontal?Math.sin(minRotation):Math.cos(minRotation))||0.001;const tickFont=this._resolveTickFontOptions(0);return Math.ceil(length/Math.min(40,tickFont.lineHeight/ratio));}
getPixelForValue(value){return value===null?NaN:this.getPixelForDecimal((value-this._startValue)/this._valueRange);}
getValueForPixel(pixel){return this._startValue+this.getDecimalForPixel(pixel)*this._valueRange;}}
const log10Floor=(v)=>Math.floor(log10(v));const changeExponent=(v,m)=>Math.pow(10,log10Floor(v)+m);function isMajor(tickVal){const remain=tickVal/Math.pow(10,log10Floor(tickVal));return remain===1;}
function steps(min,max,rangeExp){const rangeStep=Math.pow(10,rangeExp);const start=Math.floor(min/rangeStep);const end=Math.ceil(max/rangeStep);return end-start;}
function startExp(min,max){const range=max-min;let rangeExp=log10Floor(range);while(steps(min,max,rangeExp)>10){rangeExp++;}
while(steps(min,max,rangeExp)<10){rangeExp--;}
return Math.min(rangeExp,log10Floor(min));}
function generateTicks(generationOptions,{min,max}){min=finiteOrDefault(generationOptions.min,min);const ticks=[];const minExp=log10Floor(min);let exp=startExp(min,max);let precision=exp<0?Math.pow(10,Math.abs(exp)):1;const stepSize=Math.pow(10,exp);const base=minExp>exp?Math.pow(10,minExp):0;const start=Math.round((min-base)*precision)/precision;const offset=Math.floor((min-base)/stepSize/10)*stepSize*10;let significand=Math.floor((start-offset)/Math.pow(10,exp));let value=finiteOrDefault(generationOptions.min,Math.round((base+offset+significand*Math.pow(10,exp))*precision)/precision);while(value<max){ticks.push({value,major:isMajor(value),significand});if(significand>=10){significand=significand<15?15:20;}else{significand++;}
if(significand>=20){exp++;significand=2;precision=exp>=0?1:precision;}
value=Math.round((base+offset+significand*Math.pow(10,exp))*precision)/precision;}
const lastTick=finiteOrDefault(generationOptions.max,value);ticks.push({value:lastTick,major:isMajor(lastTick),significand});return ticks;}
class LogarithmicScale extends Scale{static id='logarithmic';static defaults={ticks:{callback:Ticks.formatters.logarithmic,major:{enabled:true}}};constructor(cfg){super(cfg);this.start=undefined;this.end=undefined;this._startValue=undefined;this._valueRange=0;}
parse(raw,index){const value=LinearScaleBase.prototype.parse.apply(this,[raw,index]);if(value===0){this._zero=true;return undefined;}
return isNumberFinite(value)&&value>0?value:null;}
determineDataLimits(){const{min,max}=this.getMinMax(true);this.min=isNumberFinite(min)?Math.max(0,min):null;this.max=isNumberFinite(max)?Math.max(0,max):null;if(this.options.beginAtZero){this._zero=true;}
if(this._zero&&this.min!==this._suggestedMin&&!isNumberFinite(this._userMin)){this.min=min===changeExponent(this.min,0)?changeExponent(this.min,-1):changeExponent(this.min,0);}
this.handleTickRangeOptions();}
handleTickRangeOptions(){const{minDefined,maxDefined}=this.getUserBounds();let min=this.min;let max=this.max;const setMin=(v)=>min=minDefined?min:v;const setMax=(v)=>max=maxDefined?max:v;if(min===max){if(min<=0){setMin(1);setMax(10);}else{setMin(changeExponent(min,-1));setMax(changeExponent(max,+1));}}
if(min<=0){setMin(changeExponent(max,-1));}
if(max<=0){setMax(changeExponent(min,+1));}
this.min=min;this.max=max;}
buildTicks(){const opts=this.options;const generationOptions={min:this._userMin,max:this._userMax};const ticks=generateTicks(generationOptions,this);if(opts.bounds==='ticks'){_setMinAndMaxByKey(ticks,this,'value');}
if(opts.reverse){ticks.reverse();this.start=this.max;this.end=this.min;}else{this.start=this.min;this.end=this.max;}
return ticks;}
getLabelForValue(value){return value===undefined?'0':formatNumber(value,this.chart.options.locale,this.options.ticks.format);}
configure(){const start=this.min;super.configure();this._startValue=log10(start);this._valueRange=log10(this.max)-log10(start);}
getPixelForValue(value){if(value===undefined||value===0){value=this.min;}
if(value===null||isNaN(value)){return NaN;}
return this.getPixelForDecimal(value===this.min?0:(log10(value)-this._startValue)/this._valueRange);}
getValueForPixel(pixel){const decimal=this.getDecimalForPixel(pixel);return Math.pow(10,this._startValue+decimal*this._valueRange);}}
function getTickBackdropHeight(opts){const tickOpts=opts.ticks;if(tickOpts.display&&opts.display){const padding=toPadding(tickOpts.backdropPadding);return valueOrDefault(tickOpts.font&&tickOpts.font.size,defaults.font.size)+padding.height;}
return 0;}
function measureLabelSize(ctx,font,label){label=isArray(label)?label:[label];return{w:_longestText(ctx,font.string,label),h:label.length*font.lineHeight};}
function determineLimits(angle,pos,size,min,max){if(angle===min||angle===max){return{start:pos-size/2,end:pos+size/2};}else if(angle<min||angle>max){return{start:pos-size,end:pos};}
return{start:pos,end:pos+size};}
function fitWithPointLabels(scale){const orig={l:scale.left+scale._padding.left,r:scale.right-scale._padding.right,t:scale.top+scale._padding.top,b:scale.bottom-scale._padding.bottom};const limits=Object.assign({},orig);const labelSizes=[];const padding=[];const valueCount=scale._pointLabels.length;const pointLabelOpts=scale.options.pointLabels;const additionalAngle=pointLabelOpts.centerPointLabels?PI/valueCount:0;for(let i=0;i<valueCount;i++){const opts=pointLabelOpts.setContext(scale.getPointLabelContext(i));padding[i]=opts.padding;const pointPosition=scale.getPointPosition(i,scale.drawingArea+padding[i],additionalAngle);const plFont=toFont(opts.font);const textSize=measureLabelSize(scale.ctx,plFont,scale._pointLabels[i]);labelSizes[i]=textSize;const angleRadians=_normalizeAngle(scale.getIndexAngle(i)+additionalAngle);const angle=Math.round(toDegrees(angleRadians));const hLimits=determineLimits(angle,pointPosition.x,textSize.w,0,180);const vLimits=determineLimits(angle,pointPosition.y,textSize.h,90,270);updateLimits(limits,orig,angleRadians,hLimits,vLimits);}
scale.setCenterPoint(orig.l-limits.l,limits.r-orig.r,orig.t-limits.t,limits.b-orig.b);scale._pointLabelItems=buildPointLabelItems(scale,labelSizes,padding);}
function updateLimits(limits,orig,angle,hLimits,vLimits){const sin=Math.abs(Math.sin(angle));const cos=Math.abs(Math.cos(angle));let x=0;let y=0;if(hLimits.start<orig.l){x=(orig.l-hLimits.start)/sin;limits.l=Math.min(limits.l,orig.l-x);}else if(hLimits.end>orig.r){x=(hLimits.end-orig.r)/sin;limits.r=Math.max(limits.r,orig.r+x);}
if(vLimits.start<orig.t){y=(orig.t-vLimits.start)/cos;limits.t=Math.min(limits.t,orig.t-y);}else if(vLimits.end>orig.b){y=(vLimits.end-orig.b)/cos;limits.b=Math.max(limits.b,orig.b+y);}}
function createPointLabelItem(scale,index,itemOpts){const outerDistance=scale.drawingArea;const{extra,additionalAngle,padding,size}=itemOpts;const pointLabelPosition=scale.getPointPosition(index,outerDistance+extra+padding,additionalAngle);const angle=Math.round(toDegrees(_normalizeAngle(pointLabelPosition.angle+HALF_PI)));const y=yForAngle(pointLabelPosition.y,size.h,angle);const textAlign=getTextAlignForAngle(angle);const left=leftForTextAlign(pointLabelPosition.x,size.w,textAlign);return{visible:true,x:pointLabelPosition.x,y,textAlign,left,top:y,right:left+size.w,bottom:y+size.h};}
function isNotOverlapped(item,area){if(!area){return true;}
const{left,top,right,bottom}=item;const apexesInArea=_isPointInArea({x:left,y:top},area)||_isPointInArea({x:left,y:bottom},area)||_isPointInArea({x:right,y:top},area)||_isPointInArea({x:right,y:bottom},area);return!apexesInArea;}
function buildPointLabelItems(scale,labelSizes,padding){const items=[];const valueCount=scale._pointLabels.length;const opts=scale.options;const{centerPointLabels,display}=opts.pointLabels;const itemOpts={extra:getTickBackdropHeight(opts)/2,additionalAngle:centerPointLabels?PI/valueCount:0};let area;for(let i=0;i<valueCount;i++){itemOpts.padding=padding[i];itemOpts.size=labelSizes[i];const item=createPointLabelItem(scale,i,itemOpts);items.push(item);if(display==='auto'){item.visible=isNotOverlapped(item,area);if(item.visible){area=item;}}}
return items;}
function getTextAlignForAngle(angle){if(angle===0||angle===180){return'center';}else if(angle<180){return'left';}
return'right';}
function leftForTextAlign(x,w,align){if(align==='right'){x-=w;}else if(align==='center'){x-=w/2;}
return x;}
function yForAngle(y,h,angle){if(angle===90||angle===270){y-=h/2;}else if(angle>270||angle<90){y-=h;}
return y;}
function drawPointLabelBox(ctx,opts,item){const{left,top,right,bottom}=item;const{backdropColor}=opts;if(!isNullOrUndef(backdropColor)){const borderRadius=toTRBLCorners(opts.borderRadius);const padding=toPadding(opts.backdropPadding);ctx.fillStyle=backdropColor;const backdropLeft=left-padding.left;const backdropTop=top-padding.top;const backdropWidth=right-left+padding.width;const backdropHeight=bottom-top+padding.height;if(Object.values(borderRadius).some((v)=>v!==0)){ctx.beginPath();addRoundedRectPath(ctx,{x:backdropLeft,y:backdropTop,w:backdropWidth,h:backdropHeight,radius:borderRadius});ctx.fill();}else{ctx.fillRect(backdropLeft,backdropTop,backdropWidth,backdropHeight);}}}
function drawPointLabels(scale,labelCount){const{ctx,options:{pointLabels}}=scale;for(let i=labelCount-1;i>=0;i--){const item=scale._pointLabelItems[i];if(!item.visible){continue;}
const optsAtIndex=pointLabels.setContext(scale.getPointLabelContext(i));drawPointLabelBox(ctx,optsAtIndex,item);const plFont=toFont(optsAtIndex.font);const{x,y,textAlign}=item;renderText(ctx,scale._pointLabels[i],x,y+plFont.lineHeight/2,plFont,{color:optsAtIndex.color,textAlign:textAlign,textBaseline:'middle'});}}
function pathRadiusLine(scale,radius,circular,labelCount){const{ctx}=scale;if(circular){ctx.arc(scale.xCenter,scale.yCenter,radius,0,TAU);}else{let pointPosition=scale.getPointPosition(0,radius);ctx.moveTo(pointPosition.x,pointPosition.y);for(let i=1;i<labelCount;i++){pointPosition=scale.getPointPosition(i,radius);ctx.lineTo(pointPosition.x,pointPosition.y);}}}
function drawRadiusLine(scale,gridLineOpts,radius,labelCount,borderOpts){const ctx=scale.ctx;const circular=gridLineOpts.circular;const{color,lineWidth}=gridLineOpts;if(!circular&&!labelCount||!color||!lineWidth||radius<0){return;}
ctx.save();ctx.strokeStyle=color;ctx.lineWidth=lineWidth;ctx.setLineDash(borderOpts.dash);ctx.lineDashOffset=borderOpts.dashOffset;ctx.beginPath();pathRadiusLine(scale,radius,circular,labelCount);ctx.closePath();ctx.stroke();ctx.restore();}
function createPointLabelContext(parent,index,label){return createContext(parent,{label,index,type:'pointLabel'});}
class RadialLinearScale extends LinearScaleBase{static id='radialLinear';static defaults={display:true,animate:true,position:'chartArea',angleLines:{display:true,lineWidth:1,borderDash:[],borderDashOffset:0.0},grid:{circular:false},startAngle:0,ticks:{showLabelBackdrop:true,callback:Ticks.formatters.numeric},pointLabels:{backdropColor:undefined,backdropPadding:2,display:true,font:{size:10},callback(label){return label;},padding:5,centerPointLabels:false}};static defaultRoutes={'angleLines.color':'borderColor','pointLabels.color':'color','ticks.color':'color'};static descriptors={angleLines:{_fallback:'grid'}};constructor(cfg){super(cfg);this.xCenter=undefined;this.yCenter=undefined;this.drawingArea=undefined;this._pointLabels=[];this._pointLabelItems=[];}
setDimensions(){const padding=this._padding=toPadding(getTickBackdropHeight(this.options)/2);const w=this.width=this.maxWidth-padding.width;const h=this.height=this.maxHeight-padding.height;this.xCenter=Math.floor(this.left+w/2+padding.left);this.yCenter=Math.floor(this.top+h/2+padding.top);this.drawingArea=Math.floor(Math.min(w,h)/2);}
determineDataLimits(){const{min,max}=this.getMinMax(false);this.min=isNumberFinite(min)&&!isNaN(min)?min:0;this.max=isNumberFinite(max)&&!isNaN(max)?max:0;this.handleTickRangeOptions();}
computeTickLimit(){return Math.ceil(this.drawingArea/getTickBackdropHeight(this.options));}
generateTickLabels(ticks){LinearScaleBase.prototype.generateTickLabels.call(this,ticks);this._pointLabels=this.getLabels().map((value,index)=>{const label=callback(this.options.pointLabels.callback,[value,index],this);return label||label===0?label:'';}).filter((v,i)=>this.chart.getDataVisibility(i));}
fit(){const opts=this.options;if(opts.display&&opts.pointLabels.display){fitWithPointLabels(this);}else{this.setCenterPoint(0,0,0,0);}}
setCenterPoint(leftMovement,rightMovement,topMovement,bottomMovement){this.xCenter+=Math.floor((leftMovement-rightMovement)/2);this.yCenter+=Math.floor((topMovement-bottomMovement)/2);this.drawingArea-=Math.min(this.drawingArea/2,Math.max(leftMovement,rightMovement,topMovement,bottomMovement));}
getIndexAngle(index){const angleMultiplier=TAU/(this._pointLabels.length||1);const startAngle=this.options.startAngle||0;return _normalizeAngle(index*angleMultiplier+toRadians(startAngle));}
getDistanceFromCenterForValue(value){if(isNullOrUndef(value)){return NaN;}
const scalingFactor=this.drawingArea/(this.max-this.min);if(this.options.reverse){return(this.max-value)*scalingFactor;}
return(value-this.min)*scalingFactor;}
getValueForDistanceFromCenter(distance){if(isNullOrUndef(distance)){return NaN;}
const scaledDistance=distance/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-scaledDistance:this.min+scaledDistance;}
getPointLabelContext(index){const pointLabels=this._pointLabels||[];if(index>=0&&index<pointLabels.length){const pointLabel=pointLabels[index];return createPointLabelContext(this.getContext(),index,pointLabel);}}
getPointPosition(index,distanceFromCenter,additionalAngle=0){const angle=this.getIndexAngle(index)-HALF_PI+additionalAngle;return{x:Math.cos(angle)*distanceFromCenter+this.xCenter,y:Math.sin(angle)*distanceFromCenter+this.yCenter,angle};}
getPointPositionForValue(index,value){return this.getPointPosition(index,this.getDistanceFromCenterForValue(value));}
getBasePosition(index){return this.getPointPositionForValue(index||0,this.getBaseValue());}
getPointLabelPosition(index){const{left,top,right,bottom}=this._pointLabelItems[index];return{left,top,right,bottom};}
drawBackground(){const{backgroundColor,grid:{circular}}=this.options;if(backgroundColor){const ctx=this.ctx;ctx.save();ctx.beginPath();pathRadiusLine(this,this.getDistanceFromCenterForValue(this._endValue),circular,this._pointLabels.length);ctx.closePath();ctx.fillStyle=backgroundColor;ctx.fill();ctx.restore();}}
drawGrid(){const ctx=this.ctx;const opts=this.options;const{angleLines,grid,border}=opts;const labelCount=this._pointLabels.length;let i,offset,position;if(opts.pointLabels.display){drawPointLabels(this,labelCount);}
if(grid.display){this.ticks.forEach((tick,index)=>{if(index!==0){offset=this.getDistanceFromCenterForValue(tick.value);const context=this.getContext(index);const optsAtIndex=grid.setContext(context);const optsAtIndexBorder=border.setContext(context);drawRadiusLine(this,optsAtIndex,offset,labelCount,optsAtIndexBorder);}});}
if(angleLines.display){ctx.save();for(i=labelCount-1;i>=0;i--){const optsAtIndex=angleLines.setContext(this.getPointLabelContext(i));const{color,lineWidth}=optsAtIndex;if(!lineWidth||!color){continue;}
ctx.lineWidth=lineWidth;ctx.strokeStyle=color;ctx.setLineDash(optsAtIndex.borderDash);ctx.lineDashOffset=optsAtIndex.borderDashOffset;offset=this.getDistanceFromCenterForValue(opts.ticks.reverse?this.min:this.max);position=this.getPointPosition(i,offset);ctx.beginPath();ctx.moveTo(this.xCenter,this.yCenter);ctx.lineTo(position.x,position.y);ctx.stroke();}
ctx.restore();}}
drawBorder(){}
drawLabels(){const ctx=this.ctx;const opts=this.options;const tickOpts=opts.ticks;if(!tickOpts.display){return;}
const startAngle=this.getIndexAngle(0);let offset,width;ctx.save();ctx.translate(this.xCenter,this.yCenter);ctx.rotate(startAngle);ctx.textAlign='center';ctx.textBaseline='middle';this.ticks.forEach((tick,index)=>{if(index===0&&!opts.reverse){return;}
const optsAtIndex=tickOpts.setContext(this.getContext(index));const tickFont=toFont(optsAtIndex.font);offset=this.getDistanceFromCenterForValue(this.ticks[index].value);if(optsAtIndex.showLabelBackdrop){ctx.font=tickFont.string;width=ctx.measureText(tick.label).width;ctx.fillStyle=optsAtIndex.backdropColor;const padding=toPadding(optsAtIndex.backdropPadding);ctx.fillRect(-width/2-padding.left,-offset-tickFont.size/2-padding.top,width+padding.width,tickFont.size+padding.height);}
renderText(ctx,tick.label,0,-offset,tickFont,{color:optsAtIndex.color,strokeColor:optsAtIndex.textStrokeColor,strokeWidth:optsAtIndex.textStrokeWidth});});ctx.restore();}
drawTitle(){}}
const INTERVALS={millisecond:{common:true,size:1,steps:1000},second:{common:true,size:1000,steps:60},minute:{common:true,size:60000,steps:60},hour:{common:true,size:3600000,steps:24},day:{common:true,size:86400000,steps:30},week:{common:false,size:604800000,steps:4},month:{common:true,size:2.628e9,steps:12},quarter:{common:false,size:7.884e9,steps:4},year:{common:true,size:3.154e10}};const UNITS=Object.keys(INTERVALS);function sorter(a,b){return a-b;}
function parse(scale,input){if(isNullOrUndef(input)){return null;}
const adapter=scale._adapter;const{parser,round,isoWeekday}=scale._parseOpts;let value=input;if(typeof parser==='function'){value=parser(value);}
if(!isNumberFinite(value)){value=typeof parser==='string'?adapter.parse(value,parser):adapter.parse(value);}
if(value===null){return null;}
if(round){value=round==='week'&&(isNumber(isoWeekday)||isoWeekday===true)?adapter.startOf(value,'isoWeek',isoWeekday):adapter.startOf(value,round);}
return+value;}
function determineUnitForAutoTicks(minUnit,min,max,capacity){const ilen=UNITS.length;for(let i=UNITS.indexOf(minUnit);i<ilen-1;++i){const interval=INTERVALS[UNITS[i]];const factor=interval.steps?interval.steps:Number.MAX_SAFE_INTEGER;if(interval.common&&Math.ceil((max-min)/(factor*interval.size))<=capacity){return UNITS[i];}}
return UNITS[ilen-1];}
function determineUnitForFormatting(scale,numTicks,minUnit,min,max){for(let i=UNITS.length-1;i>=UNITS.indexOf(minUnit);i--){const unit=UNITS[i];if(INTERVALS[unit].common&&scale._adapter.diff(max,min,unit)>=numTicks-1){return unit;}}
return UNITS[minUnit?UNITS.indexOf(minUnit):0];}
function determineMajorUnit(unit){for(let i=UNITS.indexOf(unit)+1,ilen=UNITS.length;i<ilen;++i){if(INTERVALS[UNITS[i]].common){return UNITS[i];}}}
function addTick(ticks,time,timestamps){if(!timestamps){ticks[time]=true;}else if(timestamps.length){const{lo,hi}=_lookup(timestamps,time);const timestamp=timestamps[lo]>=time?timestamps[lo]:timestamps[hi];ticks[timestamp]=true;}}
function setMajorTicks(scale,ticks,map,majorUnit){const adapter=scale._adapter;const first=+adapter.startOf(ticks[0].value,majorUnit);const last=ticks[ticks.length-1].value;let major,index;for(major=first;major<=last;major=+adapter.add(major,1,majorUnit)){index=map[major];if(index>=0){ticks[index].major=true;}}
return ticks;}
function ticksFromTimestamps(scale,values,majorUnit){const ticks=[];const map={};const ilen=values.length;let i,value;for(i=0;i<ilen;++i){value=values[i];map[value]=i;ticks.push({value,major:false});}
return ilen===0||!majorUnit?ticks:setMajorTicks(scale,ticks,map,majorUnit);}
class TimeScale extends Scale{static id='time';static defaults={bounds:'data',adapters:{},time:{parser:false,unit:false,round:false,isoWeekday:false,minUnit:'millisecond',displayFormats:{}},ticks:{source:'auto',callback:false,major:{enabled:false}}};constructor(props){super(props);this._cache={data:[],labels:[],all:[]};this._unit='day';this._majorUnit=undefined;this._offsets={};this._normalized=false;this._parseOpts=undefined;}
init(scaleOpts,opts={}){const time=scaleOpts.time||(scaleOpts.time={});const adapter=this._adapter=new _adapters._date(scaleOpts.adapters.date);adapter.init(opts);mergeIf(time.displayFormats,adapter.formats());this._parseOpts={parser:time.parser,round:time.round,isoWeekday:time.isoWeekday};super.init(scaleOpts);this._normalized=opts.normalized;}
parse(raw,index){if(raw===undefined){return null;}
return parse(this,raw);}
beforeLayout(){super.beforeLayout();this._cache={data:[],labels:[],all:[]};}
determineDataLimits(){const options=this.options;const adapter=this._adapter;const unit=options.time.unit||'day';let{min,max,minDefined,maxDefined}=this.getUserBounds();function _applyBounds(bounds){if(!minDefined&&!isNaN(bounds.min)){min=Math.min(min,bounds.min);}
if(!maxDefined&&!isNaN(bounds.max)){max=Math.max(max,bounds.max);}}
if(!minDefined||!maxDefined){_applyBounds(this._getLabelBounds());if(options.bounds!=='ticks'||options.ticks.source!=='labels'){_applyBounds(this.getMinMax(false));}}
min=isNumberFinite(min)&&!isNaN(min)?min:+adapter.startOf(Date.now(),unit);max=isNumberFinite(max)&&!isNaN(max)?max:+adapter.endOf(Date.now(),unit)+1;this.min=Math.min(min,max-1);this.max=Math.max(min+1,max);}
_getLabelBounds(){const arr=this.getLabelTimestamps();let min=Number.POSITIVE_INFINITY;let max=Number.NEGATIVE_INFINITY;if(arr.length){min=arr[0];max=arr[arr.length-1];}
return{min,max};}
buildTicks(){const options=this.options;const timeOpts=options.time;const tickOpts=options.ticks;const timestamps=tickOpts.source==='labels'?this.getLabelTimestamps():this._generate();if(options.bounds==='ticks'&&timestamps.length){this.min=this._userMin||timestamps[0];this.max=this._userMax||timestamps[timestamps.length-1];}
const min=this.min;const max=this.max;const ticks=_filterBetween(timestamps,min,max);this._unit=timeOpts.unit||(tickOpts.autoSkip?determineUnitForAutoTicks(timeOpts.minUnit,this.min,this.max,this._getLabelCapacity(min)):determineUnitForFormatting(this,ticks.length,timeOpts.minUnit,this.min,this.max));this._majorUnit=!tickOpts.major.enabled||this._unit==='year'?undefined:determineMajorUnit(this._unit);this.initOffsets(timestamps);if(options.reverse){ticks.reverse();}
return ticksFromTimestamps(this,ticks,this._majorUnit);}
afterAutoSkip(){if(this.options.offsetAfterAutoskip){this.initOffsets(this.ticks.map((tick)=>+tick.value));}}
initOffsets(timestamps=[]){let start=0;let end=0;let first,last;if(this.options.offset&&timestamps.length){first=this.getDecimalForValue(timestamps[0]);if(timestamps.length===1){start=1-first;}else{start=(this.getDecimalForValue(timestamps[1])-first)/2;}
last=this.getDecimalForValue(timestamps[timestamps.length-1]);if(timestamps.length===1){end=last;}else{end=(last-this.getDecimalForValue(timestamps[timestamps.length-2]))/2;}}
const limit=timestamps.length<3?0.5:0.25;start=_limitValue(start,0,limit);end=_limitValue(end,0,limit);this._offsets={start,end,factor:1/(start+1+end)};}
_generate(){const adapter=this._adapter;const min=this.min;const max=this.max;const options=this.options;const timeOpts=options.time;const minor=timeOpts.unit||determineUnitForAutoTicks(timeOpts.minUnit,min,max,this._getLabelCapacity(min));const stepSize=valueOrDefault(options.ticks.stepSize,1);const weekday=minor==='week'?timeOpts.isoWeekday:false;const hasWeekday=isNumber(weekday)||weekday===true;const ticks={};let first=min;let time,count;if(hasWeekday){first=+adapter.startOf(first,'isoWeek',weekday);}
first=+adapter.startOf(first,hasWeekday?'day':minor);if(adapter.diff(max,min,minor)>100000*stepSize){throw new Error(min+' and '+max+' are too far apart with stepSize of '+stepSize+' '+minor);}
const timestamps=options.ticks.source==='data'&&this.getDataTimestamps();for(time=first,count=0;time<max;time=+adapter.add(time,stepSize,minor),count++){addTick(ticks,time,timestamps);}
if(time===max||options.bounds==='ticks'||count===1){addTick(ticks,time,timestamps);}
return Object.keys(ticks).sort((a,b)=>a-b).map((x)=>+x);}
getLabelForValue(value){const adapter=this._adapter;const timeOpts=this.options.time;if(timeOpts.tooltipFormat){return adapter.format(value,timeOpts.tooltipFormat);}
return adapter.format(value,timeOpts.displayFormats.datetime);}
format(value,format){const options=this.options;const formats=options.time.displayFormats;const unit=this._unit;const fmt=format||formats[unit];return this._adapter.format(value,fmt);}
_tickFormatFunction(time,index,ticks,format){const options=this.options;const formatter=options.ticks.callback;if(formatter){return callback(formatter,[time,index,ticks],this);}
const formats=options.time.displayFormats;const unit=this._unit;const majorUnit=this._majorUnit;const minorFormat=unit&&formats[unit];const majorFormat=majorUnit&&formats[majorUnit];const tick=ticks[index];const major=majorUnit&&majorFormat&&tick&&tick.major;return this._adapter.format(time,format||(major?majorFormat:minorFormat));}
generateTickLabels(ticks){let i,ilen,tick;for(i=0,ilen=ticks.length;i<ilen;++i){tick=ticks[i];tick.label=this._tickFormatFunction(tick.value,i,ticks);}}
getDecimalForValue(value){return value===null?NaN:(value-this.min)/(this.max-this.min);}
getPixelForValue(value){const offsets=this._offsets;const pos=this.getDecimalForValue(value);return this.getPixelForDecimal((offsets.start+pos)*offsets.factor);}
getValueForPixel(pixel){const offsets=this._offsets;const pos=this.getDecimalForPixel(pixel)/offsets.factor-offsets.end;return this.min+pos*(this.max-this.min);}
_getLabelSize(label){const ticksOpts=this.options.ticks;const tickLabelWidth=this.ctx.measureText(label).width;const angle=toRadians(this.isHorizontal()?ticksOpts.maxRotation:ticksOpts.minRotation);const cosRotation=Math.cos(angle);const sinRotation=Math.sin(angle);const tickFontSize=this._resolveTickFontOptions(0).size;return{w:tickLabelWidth*cosRotation+tickFontSize*sinRotation,h:tickLabelWidth*sinRotation+tickFontSize*cosRotation};}
_getLabelCapacity(exampleTime){const timeOpts=this.options.time;const displayFormats=timeOpts.displayFormats;const format=displayFormats[timeOpts.unit]||displayFormats.millisecond;const exampleLabel=this._tickFormatFunction(exampleTime,0,ticksFromTimestamps(this,[exampleTime],this._majorUnit),format);const size=this._getLabelSize(exampleLabel);const capacity=Math.floor(this.isHorizontal()?this.width/size.w:this.height/size.h)-1;return capacity>0?capacity:1;}
getDataTimestamps(){let timestamps=this._cache.data||[];let i,ilen;if(timestamps.length){return timestamps;}
const metas=this.getMatchingVisibleMetas();if(this._normalized&&metas.length){return this._cache.data=metas[0].controller.getAllParsedValues(this);}
for(i=0,ilen=metas.length;i<ilen;++i){timestamps=timestamps.concat(metas[i].controller.getAllParsedValues(this));}
return this._cache.data=this.normalize(timestamps);}
getLabelTimestamps(){const timestamps=this._cache.labels||[];let i,ilen;if(timestamps.length){return timestamps;}
const labels=this.getLabels();for(i=0,ilen=labels.length;i<ilen;++i){timestamps.push(parse(this,labels[i]));}
return this._cache.labels=this._normalized?timestamps:this.normalize(timestamps);}
normalize(values){return _arrayUnique(values.sort(sorter));}}
function interpolate(table,val,reverse){let lo=0;let hi=table.length-1;let prevSource,nextSource,prevTarget,nextTarget;if(reverse){if(val>=table[lo].pos&&val<=table[hi].pos){({lo,hi}=_lookupByKey(table,'pos',val));}
({pos:prevSource,time:prevTarget}=table[lo]);({pos:nextSource,time:nextTarget}=table[hi]);}else{if(val>=table[lo].time&&val<=table[hi].time){({lo,hi}=_lookupByKey(table,'time',val));}
({time:prevSource,pos:prevTarget}=table[lo]);({time:nextSource,pos:nextTarget}=table[hi]);}
const span=nextSource-prevSource;return span?prevTarget+(nextTarget-prevTarget)*(val-prevSource)/span:prevTarget;}
class TimeSeriesScale extends TimeScale{static id='timeseries';static defaults=TimeScale.defaults;constructor(props){super(props);this._table=[];this._minPos=undefined;this._tableRange=undefined;}
initOffsets(){const timestamps=this._getTimestampsForTable();const table=this._table=this.buildLookupTable(timestamps);this._minPos=interpolate(table,this.min);this._tableRange=interpolate(table,this.max)-this._minPos;super.initOffsets(timestamps);}
buildLookupTable(timestamps){const{min,max}=this;const items=[];const table=[];let i,ilen,prev,curr,next;for(i=0,ilen=timestamps.length;i<ilen;++i){curr=timestamps[i];if(curr>=min&&curr<=max){items.push(curr);}}
if(items.length<2){return[{time:min,pos:0},{time:max,pos:1}];}
for(i=0,ilen=items.length;i<ilen;++i){next=items[i+1];prev=items[i-1];curr=items[i];if(Math.round((next+prev)/2)!==curr){table.push({time:curr,pos:i/(ilen-1)});}}
return table;}
_getTimestampsForTable(){let timestamps=this._cache.all||[];if(timestamps.length){return timestamps;}
const data=this.getDataTimestamps();const label=this.getLabelTimestamps();if(data.length&&label.length){timestamps=this.normalize(data.concat(label));}else{timestamps=data.length?data:label;}
timestamps=this._cache.all=timestamps;return timestamps;}
getDecimalForValue(value){return(interpolate(this._table,value)-this._minPos)/this._tableRange;}
getValueForPixel(pixel){const offsets=this._offsets;const decimal=this.getDecimalForPixel(pixel)/offsets.factor-offsets.end;return interpolate(this._table,decimal*this._tableRange+this._minPos,true);}}
var scales=Object.freeze({__proto__:null,CategoryScale:CategoryScale,LinearScale:LinearScale,LogarithmicScale:LogarithmicScale,RadialLinearScale:RadialLinearScale,TimeScale:TimeScale,TimeSeriesScale:TimeSeriesScale});const BORDER_COLORS=['rgb(54, 162, 235)','rgb(255, 99, 132)','rgb(255, 159, 64)','rgb(255, 205, 86)','rgb(75, 192, 192)','rgb(153, 102, 255)','rgb(201, 203, 207)'];const BACKGROUND_COLORS=BORDER_COLORS.map((color)=>color.replace('rgb(','rgba(').replace(')',', 0.5)'));function getBorderColor(i){return BORDER_COLORS[i%BORDER_COLORS.length];}
function getBackgroundColor(i){return BACKGROUND_COLORS[i%BACKGROUND_COLORS.length];}
function colorizeDefaultDataset(dataset,i){dataset.borderColor=getBorderColor(i);dataset.backgroundColor=getBackgroundColor(i);return++i;}
function colorizeDoughnutDataset(dataset,i){dataset.backgroundColor=dataset.data.map(()=>getBorderColor(i++));return i;}
function colorizePolarAreaDataset(dataset,i){dataset.backgroundColor=dataset.data.map(()=>getBackgroundColor(i++));return i;}
function getColorizer(chart){let i=0;return(dataset,datasetIndex)=>{const controller=chart.getDatasetMeta(datasetIndex).controller;if(controller instanceof DoughnutController){i=colorizeDoughnutDataset(dataset,i);}else if(controller instanceof PolarAreaController){i=colorizePolarAreaDataset(dataset,i);}else if(controller){i=colorizeDefaultDataset(dataset,i);}};}
function containsColorsDefinitions(descriptors){let k;for(k in descriptors){if(descriptors[k].borderColor||descriptors[k].backgroundColor){return true;}}
return false;}
function containsColorsDefinition(descriptor){return descriptor&&(descriptor.borderColor||descriptor.backgroundColor);}
var plugin_colors={id:'colors',defaults:{enabled:true,forceOverride:false},beforeLayout(chart,_args,options){if(!options.enabled){return;}
const{data:{datasets},options:chartOptions}=chart.config;const{elements}=chartOptions;if(!options.forceOverride&&(containsColorsDefinitions(datasets)||containsColorsDefinition(chartOptions)||elements&&containsColorsDefinitions(elements))){return;}
const colorizer=getColorizer(chart);datasets.forEach(colorizer);}};function lttbDecimation(data,start,count,availableWidth,options){const samples=options.samples||availableWidth;if(samples>=count){return data.slice(start,start+count);}
const decimated=[];const bucketWidth=(count-2)/(samples-2);let sampledIndex=0;const endIndex=start+count-1;let a=start;let i,maxAreaPoint,maxArea,area,nextA;decimated[sampledIndex++]=data[a];for(i=0;i<samples-2;i++){let avgX=0;let avgY=0;let j;const avgRangeStart=Math.floor((i+1)*bucketWidth)+1+start;const avgRangeEnd=Math.min(Math.floor((i+2)*bucketWidth)+1,count)+start;const avgRangeLength=avgRangeEnd-avgRangeStart;for(j=avgRangeStart;j<avgRangeEnd;j++){avgX+=data[j].x;avgY+=data[j].y;}
avgX/=avgRangeLength;avgY/=avgRangeLength;const rangeOffs=Math.floor(i*bucketWidth)+1+start;const rangeTo=Math.min(Math.floor((i+1)*bucketWidth)+1,count)+start;const{x:pointAx,y:pointAy}=data[a];maxArea=area=-1;for(j=rangeOffs;j<rangeTo;j++){area=0.5*Math.abs((pointAx-avgX)*(data[j].y-pointAy)-(pointAx-data[j].x)*(avgY-pointAy));if(area>maxArea){maxArea=area;maxAreaPoint=data[j];nextA=j;}}
decimated[sampledIndex++]=maxAreaPoint;a=nextA;}
decimated[sampledIndex++]=data[endIndex];return decimated;}
function minMaxDecimation(data,start,count,availableWidth){let avgX=0;let countX=0;let i,point,x,y,prevX,minIndex,maxIndex,startIndex,minY,maxY;const decimated=[];const endIndex=start+count-1;const xMin=data[start].x;const xMax=data[endIndex].x;const dx=xMax-xMin;for(i=start;i<start+count;++i){point=data[i];x=(point.x-xMin)/dx*availableWidth;y=point.y;const truncX=x|0;if(truncX===prevX){if(y<minY){minY=y;minIndex=i;}else if(y>maxY){maxY=y;maxIndex=i;}
avgX=(countX*avgX+point.x)/++countX;}else{const lastIndex=i-1;if(!isNullOrUndef(minIndex)&&!isNullOrUndef(maxIndex)){const intermediateIndex1=Math.min(minIndex,maxIndex);const intermediateIndex2=Math.max(minIndex,maxIndex);if(intermediateIndex1!==startIndex&&intermediateIndex1!==lastIndex){decimated.push({...data[intermediateIndex1],x:avgX});}
if(intermediateIndex2!==startIndex&&intermediateIndex2!==lastIndex){decimated.push({...data[intermediateIndex2],x:avgX});}}
if(i>0&&lastIndex!==startIndex){decimated.push(data[lastIndex]);}
decimated.push(point);prevX=truncX;countX=0;minY=maxY=y;minIndex=maxIndex=startIndex=i;}}
return decimated;}
function cleanDecimatedDataset(dataset){if(dataset._decimated){const data=dataset._data;delete dataset._decimated;delete dataset._data;Object.defineProperty(dataset,'data',{configurable:true,enumerable:true,writable:true,value:data});}}
function cleanDecimatedData(chart){chart.data.datasets.forEach((dataset)=>{cleanDecimatedDataset(dataset);});}
function getStartAndCountOfVisiblePointsSimplified(meta,points){const pointCount=points.length;let start=0;let count;const{iScale}=meta;const{min,max,minDefined,maxDefined}=iScale.getUserBounds();if(minDefined){start=_limitValue(_lookupByKey(points,iScale.axis,min).lo,0,pointCount-1);}
if(maxDefined){count=_limitValue(_lookupByKey(points,iScale.axis,max).hi+1,start,pointCount)-start;}else{count=pointCount-start;}
return{start,count};}
var plugin_decimation={id:'decimation',defaults:{algorithm:'min-max',enabled:false},beforeElementsUpdate:(chart,args,options)=>{if(!options.enabled){cleanDecimatedData(chart);return;}
const availableWidth=chart.width;chart.data.datasets.forEach((dataset,datasetIndex)=>{const{_data,indexAxis}=dataset;const meta=chart.getDatasetMeta(datasetIndex);const data=_data||dataset.data;if(resolve([indexAxis,chart.options.indexAxis])==='y'){return;}
if(!meta.controller.supportsDecimation){return;}
const xAxis=chart.scales[meta.xAxisID];if(xAxis.type!=='linear'&&xAxis.type!=='time'){return;}
if(chart.options.parsing){return;}
let{start,count}=getStartAndCountOfVisiblePointsSimplified(meta,data);const threshold=options.threshold||4*availableWidth;if(count<=threshold){cleanDecimatedDataset(dataset);return;}
if(isNullOrUndef(_data)){dataset._data=data;delete dataset.data;Object.defineProperty(dataset,'data',{configurable:true,enumerable:true,get:function(){return this._decimated;},set:function(d){this._data=d;}});}
let decimated;switch(options.algorithm){case'lttb':decimated=lttbDecimation(data,start,count,availableWidth,options);break;case'min-max':decimated=minMaxDecimation(data,start,count,availableWidth);break;default:throw new Error(`Unsupported decimation algorithm '${options.algorithm}'`);}
dataset._decimated=decimated;});},destroy(chart){cleanDecimatedData(chart);}};function _segments(line,target,property){const segments=line.segments;const points=line.points;const tpoints=target.points;const parts=[];for(const segment of segments){let{start,end}=segment;end=_findSegmentEnd(start,end,points);const bounds=_getBounds(property,points[start],points[end],segment.loop);if(!target.segments){parts.push({source:segment,target:bounds,start:points[start],end:points[end]});continue;}
const targetSegments=_boundSegments(target,bounds);for(const tgt of targetSegments){const subBounds=_getBounds(property,tpoints[tgt.start],tpoints[tgt.end],tgt.loop);const fillSources=_boundSegment(segment,points,subBounds);for(const fillSource of fillSources){parts.push({source:fillSource,target:tgt,start:{[property]:_getEdge(bounds,subBounds,'start',Math.max)},end:{[property]:_getEdge(bounds,subBounds,'end',Math.min)}});}}}
return parts;}
function _getBounds(property,first,last,loop){if(loop){return;}
let start=first[property];let end=last[property];if(property==='angle'){start=_normalizeAngle(start);end=_normalizeAngle(end);}
return{property,start,end};}
function _pointsFromSegments(boundary,line){const{x=null,y=null}=boundary||{};const linePoints=line.points;const points=[];line.segments.forEach(({start,end})=>{end=_findSegmentEnd(start,end,linePoints);const first=linePoints[start];const last=linePoints[end];if(y!==null){points.push({x:first.x,y});points.push({x:last.x,y});}else if(x!==null){points.push({x,y:first.y});points.push({x,y:last.y});}});return points;}
function _findSegmentEnd(start,end,points){for(;end>start;end--){const point=points[end];if(!isNaN(point.x)&&!isNaN(point.y)){break;}}
return end;}
function _getEdge(a,b,prop,fn){if(a&&b){return fn(a[prop],b[prop]);}
return a?a[prop]:b?b[prop]:0;}
function _createBoundaryLine(boundary,line){let points=[];let _loop=false;if(isArray(boundary)){_loop=true;points=boundary;}else{points=_pointsFromSegments(boundary,line);}
return points.length?new LineElement({points,options:{tension:0},_loop,_fullLoop:_loop}):null;}
function _shouldApplyFill(source){return source&&source.fill!==false;}
function _resolveTarget(sources,index,propagate){const source=sources[index];let fill=source.fill;const visited=[index];let target;if(!propagate){return fill;}
while(fill!==false&&visited.indexOf(fill)===-1){if(!isNumberFinite(fill)){return fill;}
target=sources[fill];if(!target){return false;}
if(target.visible){return fill;}
visited.push(fill);fill=target.fill;}
return false;}
function _decodeFill(line,index,count){const fill=parseFillOption(line);if(isObject(fill)){return isNaN(fill.value)?false:fill;}
let target=parseFloat(fill);if(isNumberFinite(target)&&Math.floor(target)===target){return decodeTargetIndex(fill[0],index,target,count);}
return['origin','start','end','stack','shape'].indexOf(fill)>=0&&fill;}
function decodeTargetIndex(firstCh,index,target,count){if(firstCh==='-'||firstCh==='+'){target=index+target;}
if(target===index||target<0||target>=count){return false;}
return target;}
function _getTargetPixel(fill,scale){let pixel=null;if(fill==='start'){pixel=scale.bottom;}else if(fill==='end'){pixel=scale.top;}else if(isObject(fill)){pixel=scale.getPixelForValue(fill.value);}else if(scale.getBasePixel){pixel=scale.getBasePixel();}
return pixel;}
function _getTargetValue(fill,scale,startValue){let value;if(fill==='start'){value=startValue;}else if(fill==='end'){value=scale.options.reverse?scale.min:scale.max;}else if(isObject(fill)){value=fill.value;}else{value=scale.getBaseValue();}
return value;}
function parseFillOption(line){const options=line.options;const fillOption=options.fill;let fill=valueOrDefault(fillOption&&fillOption.target,fillOption);if(fill===undefined){fill=!!options.backgroundColor;}
if(fill===false||fill===null){return false;}
if(fill===true){return'origin';}
return fill;}
function _buildStackLine(source){const{scale,index,line}=source;const points=[];const segments=line.segments;const sourcePoints=line.points;const linesBelow=getLinesBelow(scale,index);linesBelow.push(_createBoundaryLine({x:null,y:scale.bottom},line));for(let i=0;i<segments.length;i++){const segment=segments[i];for(let j=segment.start;j<=segment.end;j++){addPointsBelow(points,sourcePoints[j],linesBelow);}}
return new LineElement({points,options:{}});}
function getLinesBelow(scale,index){const below=[];const metas=scale.getMatchingVisibleMetas('line');for(let i=0;i<metas.length;i++){const meta=metas[i];if(meta.index===index){break;}
if(!meta.hidden){below.unshift(meta.dataset);}}
return below;}
function addPointsBelow(points,sourcePoint,linesBelow){const postponed=[];for(let j=0;j<linesBelow.length;j++){const line=linesBelow[j];const{first,last,point}=findPoint(line,sourcePoint,'x');if(!point||first&&last){continue;}
if(first){postponed.unshift(point);}else{points.push(point);if(!last){break;}}}
points.push(...postponed);}
function findPoint(line,sourcePoint,property){const point=line.interpolate(sourcePoint,property);if(!point){return{};}
const pointValue=point[property];const segments=line.segments;const linePoints=line.points;let first=false;let last=false;for(let i=0;i<segments.length;i++){const segment=segments[i];const firstValue=linePoints[segment.start][property];const lastValue=linePoints[segment.end][property];if(_isBetween(pointValue,firstValue,lastValue)){first=pointValue===firstValue;last=pointValue===lastValue;break;}}
return{first,last,point};}
class simpleArc{constructor(opts){this.x=opts.x;this.y=opts.y;this.radius=opts.radius;}
pathSegment(ctx,bounds,opts){const{x,y,radius}=this;bounds=bounds||{start:0,end:TAU};ctx.arc(x,y,radius,bounds.end,bounds.start,true);return!opts.bounds;}
interpolate(point){const{x,y,radius}=this;const angle=point.angle;return{x:x+Math.cos(angle)*radius,y:y+Math.sin(angle)*radius,angle};}}
function _getTarget(source){const{chart,fill,line}=source;if(isNumberFinite(fill)){return getLineByIndex(chart,fill);}
if(fill==='stack'){return _buildStackLine(source);}
if(fill==='shape'){return true;}
const boundary=computeBoundary(source);if(boundary instanceof simpleArc){return boundary;}
return _createBoundaryLine(boundary,line);}
function getLineByIndex(chart,index){const meta=chart.getDatasetMeta(index);const visible=meta&&chart.isDatasetVisible(index);return visible?meta.dataset:null;}
function computeBoundary(source){const scale=source.scale||{};if(scale.getPointPositionForValue){return computeCircularBoundary(source);}
return computeLinearBoundary(source);}
function computeLinearBoundary(source){const{scale={},fill}=source;const pixel=_getTargetPixel(fill,scale);if(isNumberFinite(pixel)){const horizontal=scale.isHorizontal();return{x:horizontal?pixel:null,y:horizontal?null:pixel};}
return null;}
function computeCircularBoundary(source){const{scale,fill}=source;const options=scale.options;const length=scale.getLabels().length;const start=options.reverse?scale.max:scale.min;const value=_getTargetValue(fill,scale,start);const target=[];if(options.grid.circular){const center=scale.getPointPositionForValue(0,start);return new simpleArc({x:center.x,y:center.y,radius:scale.getDistanceFromCenterForValue(value)});}
for(let i=0;i<length;++i){target.push(scale.getPointPositionForValue(i,value));}
return target;}
function _drawfill(ctx,source,area){const target=_getTarget(source);const{line,scale,axis}=source;const lineOpts=line.options;const fillOption=lineOpts.fill;const color=lineOpts.backgroundColor;const{above=color,below=color}=fillOption||{};if(target&&line.points.length){clipArea(ctx,area);doFill(ctx,{line,target,above,below,area,scale,axis});unclipArea(ctx);}}
function doFill(ctx,cfg){const{line,target,above,below,area,scale}=cfg;const property=line._loop?'angle':cfg.axis;ctx.save();if(property==='x'&&below!==above){clipVertical(ctx,target,area.top);fill(ctx,{line,target,color:above,scale,property});ctx.restore();ctx.save();clipVertical(ctx,target,area.bottom);}
fill(ctx,{line,target,color:below,scale,property});ctx.restore();}
function clipVertical(ctx,target,clipY){const{segments,points}=target;let first=true;let lineLoop=false;ctx.beginPath();for(const segment of segments){const{start,end}=segment;const firstPoint=points[start];const lastPoint=points[_findSegmentEnd(start,end,points)];if(first){ctx.moveTo(firstPoint.x,firstPoint.y);first=false;}else{ctx.lineTo(firstPoint.x,clipY);ctx.lineTo(firstPoint.x,firstPoint.y);}
lineLoop=!!target.pathSegment(ctx,segment,{move:lineLoop});if(lineLoop){ctx.closePath();}else{ctx.lineTo(lastPoint.x,clipY);}}
ctx.lineTo(target.first().x,clipY);ctx.closePath();ctx.clip();}
function fill(ctx,cfg){const{line,target,property,color,scale}=cfg;const segments=_segments(line,target,property);for(const{source:src,target:tgt,start,end}of segments){const{style:{backgroundColor=color}={}}=src;const notShape=target!==true;ctx.save();ctx.fillStyle=backgroundColor;clipBounds(ctx,scale,notShape&&_getBounds(property,start,end));ctx.beginPath();const lineLoop=!!line.pathSegment(ctx,src);let loop;if(notShape){if(lineLoop){ctx.closePath();}else{interpolatedLineTo(ctx,target,end,property);}
const targetLoop=!!target.pathSegment(ctx,tgt,{move:lineLoop,reverse:true});loop=lineLoop&&targetLoop;if(!loop){interpolatedLineTo(ctx,target,start,property);}}
ctx.closePath();ctx.fill(loop?'evenodd':'nonzero');ctx.restore();}}
function clipBounds(ctx,scale,bounds){const{top,bottom}=scale.chart.chartArea;const{property,start,end}=bounds||{};if(property==='x'){ctx.beginPath();ctx.rect(start,top,end-start,bottom-top);ctx.clip();}}
function interpolatedLineTo(ctx,target,point,property){const interpolatedPoint=target.interpolate(point,property);if(interpolatedPoint){ctx.lineTo(interpolatedPoint.x,interpolatedPoint.y);}}
var index={id:'filler',afterDatasetsUpdate(chart,_args,options){const count=(chart.data.datasets||[]).length;const sources=[];let meta,i,line,source;for(i=0;i<count;++i){meta=chart.getDatasetMeta(i);line=meta.dataset;source=null;if(line&&line.options&&line instanceof LineElement){source={visible:chart.isDatasetVisible(i),index:i,fill:_decodeFill(line,i,count),chart,axis:meta.controller.options.indexAxis,scale:meta.vScale,line};}
meta.$filler=source;sources.push(source);}
for(i=0;i<count;++i){source=sources[i];if(!source||source.fill===false){continue;}
source.fill=_resolveTarget(sources,i,options.propagate);}},beforeDraw(chart,_args,options){const draw=options.drawTime==='beforeDraw';const metasets=chart.getSortedVisibleDatasetMetas();const area=chart.chartArea;for(let i=metasets.length-1;i>=0;--i){const source=metasets[i].$filler;if(!source){continue;}
source.line.updateControlPoints(area,source.axis);if(draw&&source.fill){_drawfill(chart.ctx,source,area);}}},beforeDatasetsDraw(chart,_args,options){if(options.drawTime!=='beforeDatasetsDraw'){return;}
const metasets=chart.getSortedVisibleDatasetMetas();for(let i=metasets.length-1;i>=0;--i){const source=metasets[i].$filler;if(_shouldApplyFill(source)){_drawfill(chart.ctx,source,chart.chartArea);}}},beforeDatasetDraw(chart,args,options){const source=args.meta.$filler;if(!_shouldApplyFill(source)||options.drawTime!=='beforeDatasetDraw'){return;}
_drawfill(chart.ctx,source,chart.chartArea);},defaults:{propagate:true,drawTime:'beforeDatasetDraw'}};const getBoxSize=(labelOpts,fontSize)=>{let{boxHeight=fontSize,boxWidth=fontSize}=labelOpts;if(labelOpts.usePointStyle){boxHeight=Math.min(boxHeight,fontSize);boxWidth=labelOpts.pointStyleWidth||Math.min(boxWidth,fontSize);}
return{boxWidth,boxHeight,itemHeight:Math.max(fontSize,boxHeight)};};const itemsEqual=(a,b)=>a!==null&&b!==null&&a.datasetIndex===b.datasetIndex&&a.index===b.index;class Legend extends Element{constructor(config){super();this._added=false;this.legendHitBoxes=[];this._hoveredItem=null;this.doughnutMode=false;this.chart=config.chart;this.options=config.options;this.ctx=config.ctx;this.legendItems=undefined;this.columnSizes=undefined;this.lineWidths=undefined;this.maxHeight=undefined;this.maxWidth=undefined;this.top=undefined;this.bottom=undefined;this.left=undefined;this.right=undefined;this.height=undefined;this.width=undefined;this._margins=undefined;this.position=undefined;this.weight=undefined;this.fullSize=undefined;}
update(maxWidth,maxHeight,margins){this.maxWidth=maxWidth;this.maxHeight=maxHeight;this._margins=margins;this.setDimensions();this.buildLabels();this.fit();}
setDimensions(){if(this.isHorizontal()){this.width=this.maxWidth;this.left=this._margins.left;this.right=this.width;}else{this.height=this.maxHeight;this.top=this._margins.top;this.bottom=this.height;}}
buildLabels(){const labelOpts=this.options.labels||{};let legendItems=callback(labelOpts.generateLabels,[this.chart],this)||[];if(labelOpts.filter){legendItems=legendItems.filter((item)=>labelOpts.filter(item,this.chart.data));}
if(labelOpts.sort){legendItems=legendItems.sort((a,b)=>labelOpts.sort(a,b,this.chart.data));}
if(this.options.reverse){legendItems.reverse();}
this.legendItems=legendItems;}
fit(){const{options,ctx}=this;if(!options.display){this.width=this.height=0;return;}
const labelOpts=options.labels;const labelFont=toFont(labelOpts.font);const fontSize=labelFont.size;const titleHeight=this._computeTitleHeight();const{boxWidth,itemHeight}=getBoxSize(labelOpts,fontSize);let width,height;ctx.font=labelFont.string;if(this.isHorizontal()){width=this.maxWidth;height=this._fitRows(titleHeight,fontSize,boxWidth,itemHeight)+10;}else{height=this.maxHeight;width=this._fitCols(titleHeight,labelFont,boxWidth,itemHeight)+10;}
this.width=Math.min(width,options.maxWidth||this.maxWidth);this.height=Math.min(height,options.maxHeight||this.maxHeight);}
_fitRows(titleHeight,fontSize,boxWidth,itemHeight){const{ctx,maxWidth,options:{labels:{padding}}}=this;const hitboxes=this.legendHitBoxes=[];const lineWidths=this.lineWidths=[0];const lineHeight=itemHeight+padding;let totalHeight=titleHeight;ctx.textAlign='left';ctx.textBaseline='middle';let row=-1;let top=-lineHeight;this.legendItems.forEach((legendItem,i)=>{const itemWidth=boxWidth+fontSize/2+ctx.measureText(legendItem.text).width;if(i===0||lineWidths[lineWidths.length-1]+itemWidth+2*padding>maxWidth){totalHeight+=lineHeight;lineWidths[lineWidths.length-(i>0?0:1)]=0;top+=lineHeight;row++;}
hitboxes[i]={left:0,top,row,width:itemWidth,height:itemHeight};lineWidths[lineWidths.length-1]+=itemWidth+padding;});return totalHeight;}
_fitCols(titleHeight,labelFont,boxWidth,_itemHeight){const{ctx,maxHeight,options:{labels:{padding}}}=this;const hitboxes=this.legendHitBoxes=[];const columnSizes=this.columnSizes=[];const heightLimit=maxHeight-titleHeight;let totalWidth=padding;let currentColWidth=0;let currentColHeight=0;let left=0;let col=0;this.legendItems.forEach((legendItem,i)=>{const{itemWidth,itemHeight}=calculateItemSize(boxWidth,labelFont,ctx,legendItem,_itemHeight);if(i>0&&currentColHeight+itemHeight+2*padding>heightLimit){totalWidth+=currentColWidth+padding;columnSizes.push({width:currentColWidth,height:currentColHeight});left+=currentColWidth+padding;col++;currentColWidth=currentColHeight=0;}
hitboxes[i]={left,top:currentColHeight,col,width:itemWidth,height:itemHeight};currentColWidth=Math.max(currentColWidth,itemWidth);currentColHeight+=itemHeight+padding;});totalWidth+=currentColWidth;columnSizes.push({width:currentColWidth,height:currentColHeight});return totalWidth;}
adjustHitBoxes(){if(!this.options.display){return;}
const titleHeight=this._computeTitleHeight();const{legendHitBoxes:hitboxes,options:{align,labels:{padding},rtl}}=this;const rtlHelper=getRtlAdapter(rtl,this.left,this.width);if(this.isHorizontal()){let row=0;let left=_alignStartEnd(align,this.left+padding,this.right-this.lineWidths[row]);for(const hitbox of hitboxes){if(row!==hitbox.row){row=hitbox.row;left=_alignStartEnd(align,this.left+padding,this.right-this.lineWidths[row]);}
hitbox.top+=this.top+titleHeight+padding;hitbox.left=rtlHelper.leftForLtr(rtlHelper.x(left),hitbox.width);left+=hitbox.width+padding;}}else{let col=0;let top=_alignStartEnd(align,this.top+titleHeight+padding,this.bottom-this.columnSizes[col].height);for(const hitbox of hitboxes){if(hitbox.col!==col){col=hitbox.col;top=_alignStartEnd(align,this.top+titleHeight+padding,this.bottom-this.columnSizes[col].height);}
hitbox.top=top;hitbox.left+=this.left+padding;hitbox.left=rtlHelper.leftForLtr(rtlHelper.x(hitbox.left),hitbox.width);top+=hitbox.height+padding;}}}
isHorizontal(){return this.options.position==='top'||this.options.position==='bottom';}
draw(){if(this.options.display){const ctx=this.ctx;clipArea(ctx,this);this._draw();unclipArea(ctx);}}
_draw(){const{options:opts,columnSizes,lineWidths,ctx}=this;const{align,labels:labelOpts}=opts;const defaultColor=defaults.color;const rtlHelper=getRtlAdapter(opts.rtl,this.left,this.width);const labelFont=toFont(labelOpts.font);const{padding}=labelOpts;const fontSize=labelFont.size;const halfFontSize=fontSize/2;let cursor;this.drawTitle();ctx.textAlign=rtlHelper.textAlign('left');ctx.textBaseline='middle';ctx.lineWidth=0.5;ctx.font=labelFont.string;const{boxWidth,boxHeight,itemHeight}=getBoxSize(labelOpts,fontSize);const drawLegendBox=function(x,y,legendItem){if(isNaN(boxWidth)||boxWidth<=0||isNaN(boxHeight)||boxHeight<0){return;}
ctx.save();const lineWidth=valueOrDefault(legendItem.lineWidth,1);ctx.fillStyle=valueOrDefault(legendItem.fillStyle,defaultColor);ctx.lineCap=valueOrDefault(legendItem.lineCap,'butt');ctx.lineDashOffset=valueOrDefault(legendItem.lineDashOffset,0);ctx.lineJoin=valueOrDefault(legendItem.lineJoin,'miter');ctx.lineWidth=lineWidth;ctx.strokeStyle=valueOrDefault(legendItem.strokeStyle,defaultColor);ctx.setLineDash(valueOrDefault(legendItem.lineDash,[]));if(labelOpts.usePointStyle){const drawOptions={radius:boxHeight*Math.SQRT2/2,pointStyle:legendItem.pointStyle,rotation:legendItem.rotation,borderWidth:lineWidth};const centerX=rtlHelper.xPlus(x,boxWidth/2);const centerY=y+halfFontSize;drawPointLegend(ctx,drawOptions,centerX,centerY,labelOpts.pointStyleWidth&&boxWidth);}else{const yBoxTop=y+Math.max((fontSize-boxHeight)/2,0);const xBoxLeft=rtlHelper.leftForLtr(x,boxWidth);const borderRadius=toTRBLCorners(legendItem.borderRadius);ctx.beginPath();if(Object.values(borderRadius).some((v)=>v!==0)){addRoundedRectPath(ctx,{x:xBoxLeft,y:yBoxTop,w:boxWidth,h:boxHeight,radius:borderRadius});}else{ctx.rect(xBoxLeft,yBoxTop,boxWidth,boxHeight);}
ctx.fill();if(lineWidth!==0){ctx.stroke();}}
ctx.restore();};const fillText=function(x,y,legendItem){renderText(ctx,legendItem.text,x,y+itemHeight/2,labelFont,{strikethrough:legendItem.hidden,textAlign:rtlHelper.textAlign(legendItem.textAlign)});};const isHorizontal=this.isHorizontal();const titleHeight=this._computeTitleHeight();if(isHorizontal){cursor={x:_alignStartEnd(align,this.left+padding,this.right-lineWidths[0]),y:this.top+padding+titleHeight,line:0};}else{cursor={x:this.left+padding,y:_alignStartEnd(align,this.top+titleHeight+padding,this.bottom-columnSizes[0].height),line:0};}
overrideTextDirection(this.ctx,opts.textDirection);const lineHeight=itemHeight+padding;this.legendItems.forEach((legendItem,i)=>{ctx.strokeStyle=legendItem.fontColor;ctx.fillStyle=legendItem.fontColor;const textWidth=ctx.measureText(legendItem.text).width;const textAlign=rtlHelper.textAlign(legendItem.textAlign||(legendItem.textAlign=labelOpts.textAlign));const width=boxWidth+halfFontSize+textWidth;let x=cursor.x;let y=cursor.y;rtlHelper.setWidth(this.width);if(isHorizontal){if(i>0&&x+width+padding>this.right){y=cursor.y+=lineHeight;cursor.line++;x=cursor.x=_alignStartEnd(align,this.left+padding,this.right-lineWidths[cursor.line]);}}else if(i>0&&y+lineHeight>this.bottom){x=cursor.x=x+columnSizes[cursor.line].width+padding;cursor.line++;y=cursor.y=_alignStartEnd(align,this.top+titleHeight+padding,this.bottom-columnSizes[cursor.line].height);}
const realX=rtlHelper.x(x);drawLegendBox(realX,y,legendItem);x=_textX(textAlign,x+boxWidth+halfFontSize,isHorizontal?x+width:this.right,opts.rtl);fillText(rtlHelper.x(x),y,legendItem);if(isHorizontal){cursor.x+=width+padding;}else if(typeof legendItem.text!=='string'){const fontLineHeight=labelFont.lineHeight;cursor.y+=calculateLegendItemHeight(legendItem,fontLineHeight)+padding;}else{cursor.y+=lineHeight;}});restoreTextDirection(this.ctx,opts.textDirection);}
drawTitle(){const opts=this.options;const titleOpts=opts.title;const titleFont=toFont(titleOpts.font);const titlePadding=toPadding(titleOpts.padding);if(!titleOpts.display){return;}
const rtlHelper=getRtlAdapter(opts.rtl,this.left,this.width);const ctx=this.ctx;const position=titleOpts.position;const halfFontSize=titleFont.size/2;const topPaddingPlusHalfFontSize=titlePadding.top+halfFontSize;let y;let left=this.left;let maxWidth=this.width;if(this.isHorizontal()){maxWidth=Math.max(...this.lineWidths);y=this.top+topPaddingPlusHalfFontSize;left=_alignStartEnd(opts.align,left,this.right-maxWidth);}else{const maxHeight=this.columnSizes.reduce((acc,size)=>Math.max(acc,size.height),0);y=topPaddingPlusHalfFontSize+_alignStartEnd(opts.align,this.top,this.bottom-maxHeight-opts.labels.padding-this._computeTitleHeight());}
const x=_alignStartEnd(position,left,left+maxWidth);ctx.textAlign=rtlHelper.textAlign(_toLeftRightCenter(position));ctx.textBaseline='middle';ctx.strokeStyle=titleOpts.color;ctx.fillStyle=titleOpts.color;ctx.font=titleFont.string;renderText(ctx,titleOpts.text,x,y,titleFont);}
_computeTitleHeight(){const titleOpts=this.options.title;const titleFont=toFont(titleOpts.font);const titlePadding=toPadding(titleOpts.padding);return titleOpts.display?titleFont.lineHeight+titlePadding.height:0;}
_getLegendItemAt(x,y){let i,hitBox,lh;if(_isBetween(x,this.left,this.right)&&_isBetween(y,this.top,this.bottom)){lh=this.legendHitBoxes;for(i=0;i<lh.length;++i){hitBox=lh[i];if(_isBetween(x,hitBox.left,hitBox.left+hitBox.width)&&_isBetween(y,hitBox.top,hitBox.top+hitBox.height)){return this.legendItems[i];}}}
return null;}
handleEvent(e){const opts=this.options;if(!isListened(e.type,opts)){return;}
const hoveredItem=this._getLegendItemAt(e.x,e.y);if(e.type==='mousemove'||e.type==='mouseout'){const previous=this._hoveredItem;const sameItem=itemsEqual(previous,hoveredItem);if(previous&&!sameItem){callback(opts.onLeave,[e,previous,this],this);}
this._hoveredItem=hoveredItem;if(hoveredItem&&!sameItem){callback(opts.onHover,[e,hoveredItem,this],this);}}else if(hoveredItem){callback(opts.onClick,[e,hoveredItem,this],this);}}}
function calculateItemSize(boxWidth,labelFont,ctx,legendItem,_itemHeight){const itemWidth=calculateItemWidth(legendItem,boxWidth,labelFont,ctx);const itemHeight=calculateItemHeight(_itemHeight,legendItem,labelFont.lineHeight);return{itemWidth,itemHeight};}
function calculateItemWidth(legendItem,boxWidth,labelFont,ctx){let legendItemText=legendItem.text;if(legendItemText&&typeof legendItemText!=='string'){legendItemText=legendItemText.reduce((a,b)=>a.length>b.length?a:b);}
return boxWidth+labelFont.size/2+ctx.measureText(legendItemText).width;}
function calculateItemHeight(_itemHeight,legendItem,fontLineHeight){let itemHeight=_itemHeight;if(typeof legendItem.text!=='string'){itemHeight=calculateLegendItemHeight(legendItem,fontLineHeight);}
return itemHeight;}
function calculateLegendItemHeight(legendItem,fontLineHeight){const labelHeight=legendItem.text?legendItem.text.length:0;return fontLineHeight*labelHeight;}
function isListened(type,opts){if((type==='mousemove'||type==='mouseout')&&(opts.onHover||opts.onLeave)){return true;}
if(opts.onClick&&(type==='click'||type==='mouseup')){return true;}
return false;}
var plugin_legend={id:'legend',_element:Legend,start(chart,_args,options){const legend=chart.legend=new Legend({ctx:chart.ctx,options,chart});layouts.configure(chart,legend,options);layouts.addBox(chart,legend);},stop(chart){layouts.removeBox(chart,chart.legend);delete chart.legend;},beforeUpdate(chart,_args,options){const legend=chart.legend;layouts.configure(chart,legend,options);legend.options=options;},afterUpdate(chart){const legend=chart.legend;legend.buildLabels();legend.adjustHitBoxes();},afterEvent(chart,args){if(!args.replay){chart.legend.handleEvent(args.event);}},defaults:{display:true,position:'top',align:'center',fullSize:true,reverse:false,weight:1000,onClick(e,legendItem,legend){const index=legendItem.datasetIndex;const ci=legend.chart;if(ci.isDatasetVisible(index)){ci.hide(index);legendItem.hidden=true;}else{ci.show(index);legendItem.hidden=false;}},onHover:null,onLeave:null,labels:{color:(ctx)=>ctx.chart.options.color,boxWidth:40,padding:10,generateLabels(chart){const datasets=chart.data.datasets;const{labels:{usePointStyle,pointStyle,textAlign,color,useBorderRadius,borderRadius}}=chart.legend.options;return chart._getSortedDatasetMetas().map((meta)=>{const style=meta.controller.getStyle(usePointStyle?0:undefined);const borderWidth=toPadding(style.borderWidth);return{text:datasets[meta.index].label,fillStyle:style.backgroundColor,fontColor:color,hidden:!meta.visible,lineCap:style.borderCapStyle,lineDash:style.borderDash,lineDashOffset:style.borderDashOffset,lineJoin:style.borderJoinStyle,lineWidth:(borderWidth.width+borderWidth.height)/4,strokeStyle:style.borderColor,pointStyle:pointStyle||style.pointStyle,rotation:style.rotation,textAlign:textAlign||style.textAlign,borderRadius:useBorderRadius&&(borderRadius||style.borderRadius),datasetIndex:meta.index};},this);}},title:{color:(ctx)=>ctx.chart.options.color,display:false,position:'center',text:''}},descriptors:{_scriptable:(name)=>!name.startsWith('on'),labels:{_scriptable:(name)=>!['generateLabels','filter','sort'].includes(name)}}};class Title extends Element{constructor(config){super();this.chart=config.chart;this.options=config.options;this.ctx=config.ctx;this._padding=undefined;this.top=undefined;this.bottom=undefined;this.left=undefined;this.right=undefined;this.width=undefined;this.height=undefined;this.position=undefined;this.weight=undefined;this.fullSize=undefined;}
update(maxWidth,maxHeight){const opts=this.options;this.left=0;this.top=0;if(!opts.display){this.width=this.height=this.right=this.bottom=0;return;}
this.width=this.right=maxWidth;this.height=this.bottom=maxHeight;const lineCount=isArray(opts.text)?opts.text.length:1;this._padding=toPadding(opts.padding);const textSize=lineCount*toFont(opts.font).lineHeight+this._padding.height;if(this.isHorizontal()){this.height=textSize;}else{this.width=textSize;}}
isHorizontal(){const pos=this.options.position;return pos==='top'||pos==='bottom';}
_drawArgs(offset){const{top,left,bottom,right,options}=this;const align=options.align;let rotation=0;let maxWidth,titleX,titleY;if(this.isHorizontal()){titleX=_alignStartEnd(align,left,right);titleY=top+offset;maxWidth=right-left;}else{if(options.position==='left'){titleX=left+offset;titleY=_alignStartEnd(align,bottom,top);rotation=PI*-0.5;}else{titleX=right-offset;titleY=_alignStartEnd(align,top,bottom);rotation=PI*0.5;}
maxWidth=bottom-top;}
return{titleX,titleY,maxWidth,rotation};}
draw(){const ctx=this.ctx;const opts=this.options;if(!opts.display){return;}
const fontOpts=toFont(opts.font);const lineHeight=fontOpts.lineHeight;const offset=lineHeight/2+this._padding.top;const{titleX,titleY,maxWidth,rotation}=this._drawArgs(offset);renderText(ctx,opts.text,0,0,fontOpts,{color:opts.color,maxWidth,rotation,textAlign:_toLeftRightCenter(opts.align),textBaseline:'middle',translation:[titleX,titleY]});}}
function createTitle(chart,titleOpts){const title=new Title({ctx:chart.ctx,options:titleOpts,chart});layouts.configure(chart,title,titleOpts);layouts.addBox(chart,title);chart.titleBlock=title;}
var plugin_title={id:'title',_element:Title,start(chart,_args,options){createTitle(chart,options);},stop(chart){const titleBlock=chart.titleBlock;layouts.removeBox(chart,titleBlock);delete chart.titleBlock;},beforeUpdate(chart,_args,options){const title=chart.titleBlock;layouts.configure(chart,title,options);title.options=options;},defaults:{align:'center',display:false,font:{weight:'bold'},fullSize:true,padding:10,position:'top',text:'',weight:2000},defaultRoutes:{color:'color'},descriptors:{_scriptable:true,_indexable:false}};const map=new WeakMap();var plugin_subtitle={id:'subtitle',start(chart,_args,options){const title=new Title({ctx:chart.ctx,options,chart});layouts.configure(chart,title,options);layouts.addBox(chart,title);map.set(chart,title);},stop(chart){layouts.removeBox(chart,map.get(chart));map.delete(chart);},beforeUpdate(chart,_args,options){const title=map.get(chart);layouts.configure(chart,title,options);title.options=options;},defaults:{align:'center',display:false,font:{weight:'normal'},fullSize:true,padding:0,position:'top',text:'',weight:1500},defaultRoutes:{color:'color'},descriptors:{_scriptable:true,_indexable:false}};const positioners={average(items){if(!items.length){return false;}
let i,len;let x=0;let y=0;let count=0;for(i=0,len=items.length;i<len;++i){const el=items[i].element;if(el&&el.hasValue()){const pos=el.tooltipPosition();x+=pos.x;y+=pos.y;++count;}}
return{x:x/count,y:y/count};},nearest(items,eventPosition){if(!items.length){return false;}
let x=eventPosition.x;let y=eventPosition.y;let minDistance=Number.POSITIVE_INFINITY;let i,len,nearestElement;for(i=0,len=items.length;i<len;++i){const el=items[i].element;if(el&&el.hasValue()){const center=el.getCenterPoint();const d=distanceBetweenPoints(eventPosition,center);if(d<minDistance){minDistance=d;nearestElement=el;}}}
if(nearestElement){const tp=nearestElement.tooltipPosition();x=tp.x;y=tp.y;}
return{x,y};}};function pushOrConcat(base,toPush){if(toPush){if(isArray(toPush)){Array.prototype.push.apply(base,toPush);}else{base.push(toPush);}}
return base;}
function splitNewlines(str){if((typeof str==='string'||str instanceof String)&&str.indexOf('\n')>-1){return str.split('\n');}
return str;}
function createTooltipItem(chart,item){const{element,datasetIndex,index}=item;const controller=chart.getDatasetMeta(datasetIndex).controller;const{label,value}=controller.getLabelAndValue(index);return{chart,label,parsed:controller.getParsed(index),raw:chart.data.datasets[datasetIndex].data[index],formattedValue:value,dataset:controller.getDataset(),dataIndex:index,datasetIndex,element};}
function getTooltipSize(tooltip,options){const ctx=tooltip.chart.ctx;const{body,footer,title}=tooltip;const{boxWidth,boxHeight}=options;const bodyFont=toFont(options.bodyFont);const titleFont=toFont(options.titleFont);const footerFont=toFont(options.footerFont);const titleLineCount=title.length;const footerLineCount=footer.length;const bodyLineItemCount=body.length;const padding=toPadding(options.padding);let height=padding.height;let width=0;let combinedBodyLength=body.reduce((count,bodyItem)=>count+bodyItem.before.length+bodyItem.lines.length+bodyItem.after.length,0);combinedBodyLength+=tooltip.beforeBody.length+tooltip.afterBody.length;if(titleLineCount){height+=titleLineCount*titleFont.lineHeight+(titleLineCount-1)*options.titleSpacing+options.titleMarginBottom;}
if(combinedBodyLength){const bodyLineHeight=options.displayColors?Math.max(boxHeight,bodyFont.lineHeight):bodyFont.lineHeight;height+=bodyLineItemCount*bodyLineHeight+(combinedBodyLength-bodyLineItemCount)*bodyFont.lineHeight+(combinedBodyLength-1)*options.bodySpacing;}
if(footerLineCount){height+=options.footerMarginTop+footerLineCount*footerFont.lineHeight+(footerLineCount-1)*options.footerSpacing;}
let widthPadding=0;const maxLineWidth=function(line){width=Math.max(width,ctx.measureText(line).width+widthPadding);};ctx.save();ctx.font=titleFont.string;each(tooltip.title,maxLineWidth);ctx.font=bodyFont.string;each(tooltip.beforeBody.concat(tooltip.afterBody),maxLineWidth);widthPadding=options.displayColors?boxWidth+2+options.boxPadding:0;each(body,(bodyItem)=>{each(bodyItem.before,maxLineWidth);each(bodyItem.lines,maxLineWidth);each(bodyItem.after,maxLineWidth);});widthPadding=0;ctx.font=footerFont.string;each(tooltip.footer,maxLineWidth);ctx.restore();width+=padding.width;return{width,height};}
function determineYAlign(chart,size){const{y,height}=size;if(y<height/2){return'top';}else if(y>chart.height-height/2){return'bottom';}
return'center';}
function doesNotFitWithAlign(xAlign,chart,options,size){const{x,width}=size;const caret=options.caretSize+options.caretPadding;if(xAlign==='left'&&x+width+caret>chart.width){return true;}
if(xAlign==='right'&&x-width-caret<0){return true;}}
function determineXAlign(chart,options,size,yAlign){const{x,width}=size;const{width:chartWidth,chartArea:{left,right}}=chart;let xAlign='center';if(yAlign==='center'){xAlign=x<=(left+right)/2?'left':'right';}else if(x<=width/2){xAlign='left';}else if(x>=chartWidth-width/2){xAlign='right';}
if(doesNotFitWithAlign(xAlign,chart,options,size)){xAlign='center';}
return xAlign;}
function determineAlignment(chart,options,size){const yAlign=size.yAlign||options.yAlign||determineYAlign(chart,size);return{xAlign:size.xAlign||options.xAlign||determineXAlign(chart,options,size,yAlign),yAlign};}
function alignX(size,xAlign){let{x,width}=size;if(xAlign==='right'){x-=width;}else if(xAlign==='center'){x-=width/2;}
return x;}
function alignY(size,yAlign,paddingAndSize){let{y,height}=size;if(yAlign==='top'){y+=paddingAndSize;}else if(yAlign==='bottom'){y-=height+paddingAndSize;}else{y-=height/2;}
return y;}
function getBackgroundPoint(options,size,alignment,chart){const{caretSize,caretPadding,cornerRadius}=options;const{xAlign,yAlign}=alignment;const paddingAndSize=caretSize+caretPadding;const{topLeft,topRight,bottomLeft,bottomRight}=toTRBLCorners(cornerRadius);let x=alignX(size,xAlign);const y=alignY(size,yAlign,paddingAndSize);if(yAlign==='center'){if(xAlign==='left'){x+=paddingAndSize;}else if(xAlign==='right'){x-=paddingAndSize;}}else if(xAlign==='left'){x-=Math.max(topLeft,bottomLeft)+caretSize;}else if(xAlign==='right'){x+=Math.max(topRight,bottomRight)+caretSize;}
return{x:_limitValue(x,0,chart.width-size.width),y:_limitValue(y,0,chart.height-size.height)};}
function getAlignedX(tooltip,align,options){const padding=toPadding(options.padding);return align==='center'?tooltip.x+tooltip.width/2:align==='right'?tooltip.x+tooltip.width-padding.right:tooltip.x+padding.left;}
function getBeforeAfterBodyLines(callback){return pushOrConcat([],splitNewlines(callback));}
function createTooltipContext(parent,tooltip,tooltipItems){return createContext(parent,{tooltip,tooltipItems,type:'tooltip'});}
function overrideCallbacks(callbacks,context){const override=context&&context.dataset&&context.dataset.tooltip&&context.dataset.tooltip.callbacks;return override?callbacks.override(override):callbacks;}
const defaultCallbacks={beforeTitle:noop,title(tooltipItems){if(tooltipItems.length>0){const item=tooltipItems[0];const labels=item.chart.data.labels;const labelCount=labels?labels.length:0;if(this&&this.options&&this.options.mode==='dataset'){return item.dataset.label||'';}else if(item.label){return item.label;}else if(labelCount>0&&item.dataIndex<labelCount){return labels[item.dataIndex];}}
return'';},afterTitle:noop,beforeBody:noop,beforeLabel:noop,label(tooltipItem){if(this&&this.options&&this.options.mode==='dataset'){return tooltipItem.label+': '+tooltipItem.formattedValue||tooltipItem.formattedValue;}
let label=tooltipItem.dataset.label||'';if(label){label+=': ';}
const value=tooltipItem.formattedValue;if(!isNullOrUndef(value)){label+=value;}
return label;},labelColor(tooltipItem){const meta=tooltipItem.chart.getDatasetMeta(tooltipItem.datasetIndex);const options=meta.controller.getStyle(tooltipItem.dataIndex);return{borderColor:options.borderColor,backgroundColor:options.backgroundColor,borderWidth:options.borderWidth,borderDash:options.borderDash,borderDashOffset:options.borderDashOffset,borderRadius:0};},labelTextColor(){return this.options.bodyColor;},labelPointStyle(tooltipItem){const meta=tooltipItem.chart.getDatasetMeta(tooltipItem.datasetIndex);const options=meta.controller.getStyle(tooltipItem.dataIndex);return{pointStyle:options.pointStyle,rotation:options.rotation};},afterLabel:noop,afterBody:noop,beforeFooter:noop,footer:noop,afterFooter:noop};function invokeCallbackWithFallback(callbacks,name,ctx,arg){const result=callbacks[name].call(ctx,arg);if(typeof result==='undefined'){return defaultCallbacks[name].call(ctx,arg);}
return result;}
class Tooltip extends Element{static positioners=positioners;constructor(config){super();this.opacity=0;this._active=[];this._eventPosition=undefined;this._size=undefined;this._cachedAnimations=undefined;this._tooltipItems=[];this.$animations=undefined;this.$context=undefined;this.chart=config.chart;this.options=config.options;this.dataPoints=undefined;this.title=undefined;this.beforeBody=undefined;this.body=undefined;this.afterBody=undefined;this.footer=undefined;this.xAlign=undefined;this.yAlign=undefined;this.x=undefined;this.y=undefined;this.height=undefined;this.width=undefined;this.caretX=undefined;this.caretY=undefined;this.labelColors=undefined;this.labelPointStyles=undefined;this.labelTextColors=undefined;}
initialize(options){this.options=options;this._cachedAnimations=undefined;this.$context=undefined;}
_resolveAnimations(){const cached=this._cachedAnimations;if(cached){return cached;}
const chart=this.chart;const options=this.options.setContext(this.getContext());const opts=options.enabled&&chart.options.animation&&options.animations;const animations=new Animations(this.chart,opts);if(opts._cacheable){this._cachedAnimations=Object.freeze(animations);}
return animations;}
getContext(){return this.$context||(this.$context=createTooltipContext(this.chart.getContext(),this,this._tooltipItems));}
getTitle(context,options){const{callbacks}=options;const beforeTitle=invokeCallbackWithFallback(callbacks,'beforeTitle',this,context);const title=invokeCallbackWithFallback(callbacks,'title',this,context);const afterTitle=invokeCallbackWithFallback(callbacks,'afterTitle',this,context);let lines=[];lines=pushOrConcat(lines,splitNewlines(beforeTitle));lines=pushOrConcat(lines,splitNewlines(title));lines=pushOrConcat(lines,splitNewlines(afterTitle));return lines;}
getBeforeBody(tooltipItems,options){return getBeforeAfterBodyLines(invokeCallbackWithFallback(options.callbacks,'beforeBody',this,tooltipItems));}
getBody(tooltipItems,options){const{callbacks}=options;const bodyItems=[];each(tooltipItems,(context)=>{const bodyItem={before:[],lines:[],after:[]};const scoped=overrideCallbacks(callbacks,context);pushOrConcat(bodyItem.before,splitNewlines(invokeCallbackWithFallback(scoped,'beforeLabel',this,context)));pushOrConcat(bodyItem.lines,invokeCallbackWithFallback(scoped,'label',this,context));pushOrConcat(bodyItem.after,splitNewlines(invokeCallbackWithFallback(scoped,'afterLabel',this,context)));bodyItems.push(bodyItem);});return bodyItems;}
getAfterBody(tooltipItems,options){return getBeforeAfterBodyLines(invokeCallbackWithFallback(options.callbacks,'afterBody',this,tooltipItems));}
getFooter(tooltipItems,options){const{callbacks}=options;const beforeFooter=invokeCallbackWithFallback(callbacks,'beforeFooter',this,tooltipItems);const footer=invokeCallbackWithFallback(callbacks,'footer',this,tooltipItems);const afterFooter=invokeCallbackWithFallback(callbacks,'afterFooter',this,tooltipItems);let lines=[];lines=pushOrConcat(lines,splitNewlines(beforeFooter));lines=pushOrConcat(lines,splitNewlines(footer));lines=pushOrConcat(lines,splitNewlines(afterFooter));return lines;}
_createItems(options){const active=this._active;const data=this.chart.data;const labelColors=[];const labelPointStyles=[];const labelTextColors=[];let tooltipItems=[];let i,len;for(i=0,len=active.length;i<len;++i){tooltipItems.push(createTooltipItem(this.chart,active[i]));}
if(options.filter){tooltipItems=tooltipItems.filter((element,index,array)=>options.filter(element,index,array,data));}
if(options.itemSort){tooltipItems=tooltipItems.sort((a,b)=>options.itemSort(a,b,data));}
each(tooltipItems,(context)=>{const scoped=overrideCallbacks(options.callbacks,context);labelColors.push(invokeCallbackWithFallback(scoped,'labelColor',this,context));labelPointStyles.push(invokeCallbackWithFallback(scoped,'labelPointStyle',this,context));labelTextColors.push(invokeCallbackWithFallback(scoped,'labelTextColor',this,context));});this.labelColors=labelColors;this.labelPointStyles=labelPointStyles;this.labelTextColors=labelTextColors;this.dataPoints=tooltipItems;return tooltipItems;}
update(changed,replay){const options=this.options.setContext(this.getContext());const active=this._active;let properties;let tooltipItems=[];if(!active.length){if(this.opacity!==0){properties={opacity:0};}}else{const position=positioners[options.position].call(this,active,this._eventPosition);tooltipItems=this._createItems(options);this.title=this.getTitle(tooltipItems,options);this.beforeBody=this.getBeforeBody(tooltipItems,options);this.body=this.getBody(tooltipItems,options);this.afterBody=this.getAfterBody(tooltipItems,options);this.footer=this.getFooter(tooltipItems,options);const size=this._size=getTooltipSize(this,options);const positionAndSize=Object.assign({},position,size);const alignment=determineAlignment(this.chart,options,positionAndSize);const backgroundPoint=getBackgroundPoint(options,positionAndSize,alignment,this.chart);this.xAlign=alignment.xAlign;this.yAlign=alignment.yAlign;properties={opacity:1,x:backgroundPoint.x,y:backgroundPoint.y,width:size.width,height:size.height,caretX:position.x,caretY:position.y};}
this._tooltipItems=tooltipItems;this.$context=undefined;if(properties){this._resolveAnimations().update(this,properties);}
if(changed&&options.external){options.external.call(this,{chart:this.chart,tooltip:this,replay});}}
drawCaret(tooltipPoint,ctx,size,options){const caretPosition=this.getCaretPosition(tooltipPoint,size,options);ctx.lineTo(caretPosition.x1,caretPosition.y1);ctx.lineTo(caretPosition.x2,caretPosition.y2);ctx.lineTo(caretPosition.x3,caretPosition.y3);}
getCaretPosition(tooltipPoint,size,options){const{xAlign,yAlign}=this;const{caretSize,cornerRadius}=options;const{topLeft,topRight,bottomLeft,bottomRight}=toTRBLCorners(cornerRadius);const{x:ptX,y:ptY}=tooltipPoint;const{width,height}=size;let x1,x2,x3,y1,y2,y3;if(yAlign==='center'){y2=ptY+height/2;if(xAlign==='left'){x1=ptX;x2=x1-caretSize;y1=y2+caretSize;y3=y2-caretSize;}else{x1=ptX+width;x2=x1+caretSize;y1=y2-caretSize;y3=y2+caretSize;}
x3=x1;}else{if(xAlign==='left'){x2=ptX+Math.max(topLeft,bottomLeft)+caretSize;}else if(xAlign==='right'){x2=ptX+width-Math.max(topRight,bottomRight)-caretSize;}else{x2=this.caretX;}
if(yAlign==='top'){y1=ptY;y2=y1-caretSize;x1=x2-caretSize;x3=x2+caretSize;}else{y1=ptY+height;y2=y1+caretSize;x1=x2+caretSize;x3=x2-caretSize;}
y3=y1;}
return{x1,x2,x3,y1,y2,y3};}
drawTitle(pt,ctx,options){const title=this.title;const length=title.length;let titleFont,titleSpacing,i;if(length){const rtlHelper=getRtlAdapter(options.rtl,this.x,this.width);pt.x=getAlignedX(this,options.titleAlign,options);ctx.textAlign=rtlHelper.textAlign(options.titleAlign);ctx.textBaseline='middle';titleFont=toFont(options.titleFont);titleSpacing=options.titleSpacing;ctx.fillStyle=options.titleColor;ctx.font=titleFont.string;for(i=0;i<length;++i){ctx.fillText(title[i],rtlHelper.x(pt.x),pt.y+titleFont.lineHeight/2);pt.y+=titleFont.lineHeight+titleSpacing;if(i+1===length){pt.y+=options.titleMarginBottom-titleSpacing;}}}}
_drawColorBox(ctx,pt,i,rtlHelper,options){const labelColor=this.labelColors[i];const labelPointStyle=this.labelPointStyles[i];const{boxHeight,boxWidth}=options;const bodyFont=toFont(options.bodyFont);const colorX=getAlignedX(this,'left',options);const rtlColorX=rtlHelper.x(colorX);const yOffSet=boxHeight<bodyFont.lineHeight?(bodyFont.lineHeight-boxHeight)/2:0;const colorY=pt.y+yOffSet;if(options.usePointStyle){const drawOptions={radius:Math.min(boxWidth,boxHeight)/2,pointStyle:labelPointStyle.pointStyle,rotation:labelPointStyle.rotation,borderWidth:1};const centerX=rtlHelper.leftForLtr(rtlColorX,boxWidth)+boxWidth/2;const centerY=colorY+boxHeight/2;ctx.strokeStyle=options.multiKeyBackground;ctx.fillStyle=options.multiKeyBackground;drawPoint(ctx,drawOptions,centerX,centerY);ctx.strokeStyle=labelColor.borderColor;ctx.fillStyle=labelColor.backgroundColor;drawPoint(ctx,drawOptions,centerX,centerY);}else{ctx.lineWidth=isObject(labelColor.borderWidth)?Math.max(...Object.values(labelColor.borderWidth)):labelColor.borderWidth||1;ctx.strokeStyle=labelColor.borderColor;ctx.setLineDash(labelColor.borderDash||[]);ctx.lineDashOffset=labelColor.borderDashOffset||0;const outerX=rtlHelper.leftForLtr(rtlColorX,boxWidth);const innerX=rtlHelper.leftForLtr(rtlHelper.xPlus(rtlColorX,1),boxWidth-2);const borderRadius=toTRBLCorners(labelColor.borderRadius);if(Object.values(borderRadius).some((v)=>v!==0)){ctx.beginPath();ctx.fillStyle=options.multiKeyBackground;addRoundedRectPath(ctx,{x:outerX,y:colorY,w:boxWidth,h:boxHeight,radius:borderRadius});ctx.fill();ctx.stroke();ctx.fillStyle=labelColor.backgroundColor;ctx.beginPath();addRoundedRectPath(ctx,{x:innerX,y:colorY+1,w:boxWidth-2,h:boxHeight-2,radius:borderRadius});ctx.fill();}else{ctx.fillStyle=options.multiKeyBackground;ctx.fillRect(outerX,colorY,boxWidth,boxHeight);ctx.strokeRect(outerX,colorY,boxWidth,boxHeight);ctx.fillStyle=labelColor.backgroundColor;ctx.fillRect(innerX,colorY+1,boxWidth-2,boxHeight-2);}}
ctx.fillStyle=this.labelTextColors[i];}
drawBody(pt,ctx,options){const{body}=this;const{bodySpacing,bodyAlign,displayColors,boxHeight,boxWidth,boxPadding}=options;const bodyFont=toFont(options.bodyFont);let bodyLineHeight=bodyFont.lineHeight;let xLinePadding=0;const rtlHelper=getRtlAdapter(options.rtl,this.x,this.width);const fillLineOfText=function(line){ctx.fillText(line,rtlHelper.x(pt.x+xLinePadding),pt.y+bodyLineHeight/2);pt.y+=bodyLineHeight+bodySpacing;};const bodyAlignForCalculation=rtlHelper.textAlign(bodyAlign);let bodyItem,textColor,lines,i,j,ilen,jlen;ctx.textAlign=bodyAlign;ctx.textBaseline='middle';ctx.font=bodyFont.string;pt.x=getAlignedX(this,bodyAlignForCalculation,options);ctx.fillStyle=options.bodyColor;each(this.beforeBody,fillLineOfText);xLinePadding=displayColors&&bodyAlignForCalculation!=='right'?bodyAlign==='center'?boxWidth/2+boxPadding:boxWidth+2+boxPadding:0;for(i=0,ilen=body.length;i<ilen;++i){bodyItem=body[i];textColor=this.labelTextColors[i];ctx.fillStyle=textColor;each(bodyItem.before,fillLineOfText);lines=bodyItem.lines;if(displayColors&&lines.length){this._drawColorBox(ctx,pt,i,rtlHelper,options);bodyLineHeight=Math.max(bodyFont.lineHeight,boxHeight);}
for(j=0,jlen=lines.length;j<jlen;++j){fillLineOfText(lines[j]);bodyLineHeight=bodyFont.lineHeight;}
each(bodyItem.after,fillLineOfText);}
xLinePadding=0;bodyLineHeight=bodyFont.lineHeight;each(this.afterBody,fillLineOfText);pt.y-=bodySpacing;}
drawFooter(pt,ctx,options){const footer=this.footer;const length=footer.length;let footerFont,i;if(length){const rtlHelper=getRtlAdapter(options.rtl,this.x,this.width);pt.x=getAlignedX(this,options.footerAlign,options);pt.y+=options.footerMarginTop;ctx.textAlign=rtlHelper.textAlign(options.footerAlign);ctx.textBaseline='middle';footerFont=toFont(options.footerFont);ctx.fillStyle=options.footerColor;ctx.font=footerFont.string;for(i=0;i<length;++i){ctx.fillText(footer[i],rtlHelper.x(pt.x),pt.y+footerFont.lineHeight/2);pt.y+=footerFont.lineHeight+options.footerSpacing;}}}
drawBackground(pt,ctx,tooltipSize,options){const{xAlign,yAlign}=this;const{x,y}=pt;const{width,height}=tooltipSize;const{topLeft,topRight,bottomLeft,bottomRight}=toTRBLCorners(options.cornerRadius);ctx.fillStyle=options.backgroundColor;ctx.strokeStyle=options.borderColor;ctx.lineWidth=options.borderWidth;ctx.beginPath();ctx.moveTo(x+topLeft,y);if(yAlign==='top'){this.drawCaret(pt,ctx,tooltipSize,options);}
ctx.lineTo(x+width-topRight,y);ctx.quadraticCurveTo(x+width,y,x+width,y+topRight);if(yAlign==='center'&&xAlign==='right'){this.drawCaret(pt,ctx,tooltipSize,options);}
ctx.lineTo(x+width,y+height-bottomRight);ctx.quadraticCurveTo(x+width,y+height,x+width-bottomRight,y+height);if(yAlign==='bottom'){this.drawCaret(pt,ctx,tooltipSize,options);}
ctx.lineTo(x+bottomLeft,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-bottomLeft);if(yAlign==='center'&&xAlign==='left'){this.drawCaret(pt,ctx,tooltipSize,options);}
ctx.lineTo(x,y+topLeft);ctx.quadraticCurveTo(x,y,x+topLeft,y);ctx.closePath();ctx.fill();if(options.borderWidth>0){ctx.stroke();}}
_updateAnimationTarget(options){const chart=this.chart;const anims=this.$animations;const animX=anims&&anims.x;const animY=anims&&anims.y;if(animX||animY){const position=positioners[options.position].call(this,this._active,this._eventPosition);if(!position){return;}
const size=this._size=getTooltipSize(this,options);const positionAndSize=Object.assign({},position,this._size);const alignment=determineAlignment(chart,options,positionAndSize);const point=getBackgroundPoint(options,positionAndSize,alignment,chart);if(animX._to!==point.x||animY._to!==point.y){this.xAlign=alignment.xAlign;this.yAlign=alignment.yAlign;this.width=size.width;this.height=size.height;this.caretX=position.x;this.caretY=position.y;this._resolveAnimations().update(this,point);}}}
_willRender(){return!!this.opacity;}
draw(ctx){const options=this.options.setContext(this.getContext());let opacity=this.opacity;if(!opacity){return;}
this._updateAnimationTarget(options);const tooltipSize={width:this.width,height:this.height};const pt={x:this.x,y:this.y};opacity=Math.abs(opacity)<1e-3?0:opacity;const padding=toPadding(options.padding);const hasTooltipContent=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;if(options.enabled&&hasTooltipContent){ctx.save();ctx.globalAlpha=opacity;this.drawBackground(pt,ctx,tooltipSize,options);overrideTextDirection(ctx,options.textDirection);pt.y+=padding.top;this.drawTitle(pt,ctx,options);this.drawBody(pt,ctx,options);this.drawFooter(pt,ctx,options);restoreTextDirection(ctx,options.textDirection);ctx.restore();}}
getActiveElements(){return this._active||[];}
setActiveElements(activeElements,eventPosition){const lastActive=this._active;const active=activeElements.map(({datasetIndex,index})=>{const meta=this.chart.getDatasetMeta(datasetIndex);if(!meta){throw new Error('Cannot find a dataset at index '+datasetIndex);}
return{datasetIndex,element:meta.data[index],index};});const changed=!_elementsEqual(lastActive,active);const positionChanged=this._positionChanged(active,eventPosition);if(changed||positionChanged){this._active=active;this._eventPosition=eventPosition;this._ignoreReplayEvents=true;this.update(true);}}
handleEvent(e,replay,inChartArea=true){if(replay&&this._ignoreReplayEvents){return false;}
this._ignoreReplayEvents=false;const options=this.options;const lastActive=this._active||[];const active=this._getActiveElements(e,lastActive,replay,inChartArea);const positionChanged=this._positionChanged(active,e);const changed=replay||!_elementsEqual(active,lastActive)||positionChanged;if(changed){this._active=active;if(options.enabled||options.external){this._eventPosition={x:e.x,y:e.y};this.update(true,replay);}}
return changed;}
_getActiveElements(e,lastActive,replay,inChartArea){const options=this.options;if(e.type==='mouseout'){return[];}
if(!inChartArea){return lastActive;}
const active=this.chart.getElementsAtEventForMode(e,options.mode,options,replay);if(options.reverse){active.reverse();}
return active;}
_positionChanged(active,e){const{caretX,caretY,options}=this;const position=positioners[options.position].call(this,active,e);return position!==false&&(caretX!==position.x||caretY!==position.y);}}
var plugin_tooltip={id:'tooltip',_element:Tooltip,positioners,afterInit(chart,_args,options){if(options){chart.tooltip=new Tooltip({chart,options});}},beforeUpdate(chart,_args,options){if(chart.tooltip){chart.tooltip.initialize(options);}},reset(chart,_args,options){if(chart.tooltip){chart.tooltip.initialize(options);}},afterDraw(chart){const tooltip=chart.tooltip;if(tooltip&&tooltip._willRender()){const args={tooltip};if(chart.notifyPlugins('beforeTooltipDraw',{...args,cancelable:true})===false){return;}
tooltip.draw(chart.ctx);chart.notifyPlugins('afterTooltipDraw',args);}},afterEvent(chart,args){if(chart.tooltip){const useFinalPosition=args.replay;if(chart.tooltip.handleEvent(args.event,useFinalPosition,args.inChartArea)){args.changed=true;}}},defaults:{enabled:true,external:null,position:'average',backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',titleFont:{weight:'bold'},titleSpacing:2,titleMarginBottom:6,titleAlign:'left',bodyColor:'#fff',bodySpacing:2,bodyFont:{},bodyAlign:'left',footerColor:'#fff',footerSpacing:2,footerMarginTop:6,footerFont:{weight:'bold'},footerAlign:'left',padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(ctx,opts)=>opts.bodyFont.size,boxWidth:(ctx,opts)=>opts.bodyFont.size,multiKeyBackground:'#fff',displayColors:true,boxPadding:0,borderColor:'rgba(0,0,0,0)',borderWidth:0,animation:{duration:400,easing:'easeOutQuart'},animations:{numbers:{type:'number',properties:['x','y','width','height','caretX','caretY']},opacity:{easing:'linear',duration:200}},callbacks:defaultCallbacks},defaultRoutes:{bodyFont:'font',footerFont:'font',titleFont:'font'},descriptors:{_scriptable:(name)=>name!=='filter'&&name!=='itemSort'&&name!=='external',_indexable:false,callbacks:{_scriptable:false,_indexable:false},animation:{_fallback:false},animations:{_fallback:'animation'}},additionalOptionScopes:['interaction']};Chart.register(controllers,scales,elements,plugins);Chart.helpers={...helpers};Chart._adapters=_adapters;Chart.Animation=Animation;Chart.Animations=Animations;Chart.animator=animator;Chart.controllers=registry.controllers.items;Chart.DatasetController=DatasetController;Chart.Element=Element;Chart.elements=elements;Chart.Interaction=Interaction;Chart.layouts=layouts;Chart.platforms=platforms;Chart.Scale=Scale;Chart.Ticks=Ticks;Object.assign(Chart,controllers,scales,elements,plugins,platforms);Chart.Chart=Chart;if(typeof window!=='undefined'){window.Chart=Chart;}
return Chart;}));;

/* /web/static/lib/chartjs-adapter-luxon/chartjs-adapter-luxon.js */
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(require("chart.js"),require("luxon")):typeof define==="function"&&define.amd?define(["chart.js","luxon"],factory):((global=typeof globalThis!=="undefined"?globalThis:global||self),factory(global.Chart,global.luxon));})(this,function(chart_js,luxon){"use strict";const FORMATS={datetime:luxon.DateTime.DATETIME_MED_WITH_SECONDS,millisecond:"h:mm:ss.SSS a",second:luxon.DateTime.TIME_WITH_SECONDS,minute:luxon.DateTime.TIME_SIMPLE,hour:{hour:"numeric"},day:{day:"numeric",month:"short"},week:"DD",month:{month:"short",year:"numeric"},quarter:"'Q'q - yyyy",year:{year:"numeric"},};chart_js._adapters._date.override({_id:"luxon",_create:function(time){return luxon.DateTime.fromMillis(time,this.options);},init(chartOptions){if(!this.options.locale){this.options.locale=chartOptions.locale;}},formats:function(){return FORMATS;},parse:function(value,format){const options=this.options;const type=typeof value;if(value===null||type==="undefined"){return null;}
if(type==="number"){value=this._create(value);}else if(type==="string"){if(typeof format==="string"){value=luxon.DateTime.fromFormat(value,format,options);}else{value=luxon.DateTime.fromISO(value,options);}}else if(value instanceof Date){value=luxon.DateTime.fromJSDate(value,options);}else if(type==="object"&&!(value instanceof luxon.DateTime)){value=luxon.DateTime.fromObject(value,options);}
return value.isValid?value.valueOf():null;},format:function(time,format){const datetime=this._create(time);return typeof format==="string"?datetime.toFormat(format):datetime.toLocaleString(format);},add:function(time,amount,unit){const args={};args[unit]=amount;return this._create(time).plus(args).valueOf();},diff:function(max,min,unit){return this._create(max).diff(this._create(min)).as(unit).valueOf();},startOf:function(time,unit,weekday){if(unit==="isoWeek"){weekday=Math.trunc(Math.min(Math.max(0,weekday),6));const dateTime=this._create(time);return dateTime.minus({days:(dateTime.weekday-weekday+7)%7}).startOf("day").valueOf();}
return unit?this._create(time).startOf(unit).valueOf():time;},endOf:function(time,unit){return this._create(time).endOf(unit).valueOf();},});});;

/* /spreadsheet/static/src/o_spreadsheet/o_spreadsheet.js */
(function(exports,owl){'use strict';let _translate=(s)=>s;let _loaded=()=>false;function sprintf(s,...values){if(values.length===1&&typeof values[0]==="object"&&!(values[0]instanceof String)){const valuesDict=values[0];s=s.replace(/\%\(([^\)]+)\)s/g,(match,value)=>valuesDict[value]);}
else if(values.length>0){s=s.replace(/\%s/g,()=>values.shift());}
return s;}
function setTranslationMethod(tfn,loaded=()=>true){_translate=tfn;_loaded=loaded;}
const _t=function(s,...values){if(!_loaded()){return new LazyTranslatedString(s,values);}
return sprintf(_translate(s),...values);};class LazyTranslatedString extends String{values;constructor(str,values){super(str);this.values=values;}
valueOf(){const str=super.valueOf();return _loaded()?sprintf(_translate(str),...this.values):str;}
toString(){return this.valueOf();}}
var CellErrorType;(function(CellErrorType){CellErrorType["NotAvailable"]="#N/A";CellErrorType["InvalidReference"]="#REF";CellErrorType["BadExpression"]="#BAD_EXPR";CellErrorType["CircularDependency"]="#CYCLE";CellErrorType["UnknownFunction"]="#NAME?";CellErrorType["GenericError"]="#ERROR";})(CellErrorType||(CellErrorType={}));var CellErrorLevel;(function(CellErrorLevel){CellErrorLevel[CellErrorLevel["silent"]=0]="silent";CellErrorLevel[CellErrorLevel["error"]=1]="error";})(CellErrorLevel||(CellErrorLevel={}));class EvaluationError extends Error{errorType;logLevel;constructor(errorType,message,logLevel=CellErrorLevel.error){super(message);this.errorType=errorType;this.logLevel=logLevel;}
get isVerbose(){return this.logLevel>CellErrorLevel.silent;}}
class BadExpressionError extends EvaluationError{constructor(errorMessage){super(CellErrorType.BadExpression,errorMessage);}}
class CircularDependencyError extends EvaluationError{constructor(){super(CellErrorType.CircularDependency,_t("Circular reference"));}}
class InvalidReferenceError extends EvaluationError{constructor(){super(CellErrorType.InvalidReference,_t("Invalid reference"));}}
class NotAvailableError extends EvaluationError{constructor(errorMessage=undefined){super(CellErrorType.NotAvailable,errorMessage||_t("Data not available"),errorMessage?CellErrorLevel.error:CellErrorLevel.silent);}}
class UnknownFunctionError extends EvaluationError{constructor(fctName){super(CellErrorType.UnknownFunction,_t('Unknown function: "%s"',fctName));}}
const CANVAS_SHIFT=0.5;const BACKGROUND_GRAY_COLOR="#f5f5f5";const BACKGROUND_HEADER_COLOR="#F8F9FA";const BACKGROUND_HEADER_SELECTED_COLOR="#E8EAED";const BACKGROUND_HEADER_ACTIVE_COLOR="#595959";const TEXT_HEADER_COLOR="#666666";const FIGURE_BORDER_COLOR="#c9ccd2";const SELECTION_BORDER_COLOR="#3266ca";const HEADER_BORDER_COLOR="#C0C0C0";const CELL_BORDER_COLOR="#E2E3E3";const BACKGROUND_CHART_COLOR="#FFFFFF";const BG_HOVER_COLOR="#EBEBEB";const DISABLED_TEXT_COLOR="#CACACA";const DEFAULT_COLOR_SCALE_MIDPOINT_COLOR=0xb6d7a8;const LINK_COLOR="#01666b";const FILTERS_COLOR="#188038";const BACKGROUND_HEADER_FILTER_COLOR="#E6F4EA";const BACKGROUND_HEADER_SELECTED_FILTER_COLOR="#CEEAD6";const SEPARATOR_COLOR="#E0E2E4";const ICONS_COLOR="#4A4F59";const HEADER_GROUPING_BACKGROUND_COLOR="#F5F5F5";const HEADER_GROUPING_BORDER_COLOR="#999";const GRID_BORDER_COLOR="#E2E3E3";const FROZEN_PANE_HEADER_BORDER_COLOR="#BCBCBC";const FROZEN_PANE_BORDER_COLOR="#DADFE8";const COMPOSER_ASSISTANT_COLOR="#9B359B";const COLOR_PICKER_DEFAULTS=["#000000","#434343","#666666","#999999","#B7B7B7","#CCCCCC","#D9D9D9","#EFEFEF","#F3F3F3","#FFFFFF","#980000","#FF0000","#FF9900","#FFFF00","#00FF00","#00FFFF","#4A86E8","#0000FF","#9900FF","#FF00FF","#E6B8AF","#F4CCCC","#FCE5CD","#FFF2CC","#D9EAD3","#D0E0E3","#C9DAF8","#CFE2F3","#D9D2E9","#EAD1DC","#DD7E6B","#EA9999","#F9CB9C","#FFE599","#B6D7A8","#A2C4C9","#A4C2F4","#9FC5E8","#B4A7D6","#D5A6BD","#CC4125","#E06666","#F6B26B","#FFD966","#93C47D","#76A5AF","#6D9EEB","#6FA8DC","#8E7CC3","#C27BA0","#A61C00","#CC0000","#E69138","#F1C232","#6AA84F","#45818E","#3C78D8","#3D85C6","#674EA7","#A64D79","#85200C","#990000","#B45F06","#BF9000","#38761D","#134F5C","#1155CC","#0B5394","#351C75","#741B47","#5B0F00","#660000","#783F04","#7F6000","#274E13","#0C343D","#1C4587","#073763","#20124D","#4C1130",];const MIN_ROW_HEIGHT=10;const MIN_COL_WIDTH=5;const HEADER_HEIGHT=26;const HEADER_WIDTH=48;const TOPBAR_HEIGHT=63;const TOPBAR_TOOLBAR_HEIGHT=34;const BOTTOMBAR_HEIGHT=36;const DEFAULT_CELL_WIDTH=96;const DEFAULT_CELL_HEIGHT=23;const SCROLLBAR_WIDTH=15;const AUTOFILL_EDGE_LENGTH=8;const ICON_EDGE_LENGTH=18;const UNHIDE_ICON_EDGE_LENGTH=14;const MIN_CF_ICON_MARGIN=4;const MIN_CELL_TEXT_MARGIN=4;const CF_ICON_EDGE_LENGTH=15;const PADDING_AUTORESIZE_VERTICAL=3;const PADDING_AUTORESIZE_HORIZONTAL=MIN_CELL_TEXT_MARGIN;const GROUP_LAYER_WIDTH=21;const GRID_ICON_MARGIN=2;const GRID_ICON_EDGE_LENGTH=17;const FOOTER_HEIGHT=2*DEFAULT_CELL_HEIGHT;const MENU_WIDTH=250;const MENU_VERTICAL_PADDING=6;const MENU_ITEM_HEIGHT=26;const MENU_ITEM_PADDING_HORIZONTAL=11;const MENU_ITEM_PADDING_VERTICAL=4;const MENU_SEPARATOR_BORDER_WIDTH=1;const MENU_SEPARATOR_PADDING=5;const DEFAULT_STYLE={align:"left",verticalAlign:"bottom",wrapping:"overflow",bold:false,italic:false,strikethrough:false,underline:false,fontSize:10,fillColor:"",textColor:"#000000",};const DEFAULT_VERTICAL_ALIGN=DEFAULT_STYLE.verticalAlign;const DEFAULT_WRAPPING_MODE=DEFAULT_STYLE.wrapping;const DEFAULT_FONT_WEIGHT="400";const DEFAULT_FONT_SIZE=DEFAULT_STYLE.fontSize;const HEADER_FONT_SIZE=11;const DEFAULT_FONT="'Roboto', arial";const DEFAULT_BORDER_DESC={style:"thin",color:"#000000"};const DEFAULT_FILTER_BORDER_DESC={style:"thin",color:FILTERS_COLOR};const INCORRECT_RANGE_STRING=CellErrorType.InvalidReference;const MAX_HISTORY_STEPS=99;const DEFAULT_REVISION_ID="START_REVISION";const DEFAULT_FIGURE_HEIGHT=335;const DEFAULT_FIGURE_WIDTH=536;const FIGURE_BORDER_WIDTH=1;const MIN_FIG_SIZE=80;const MAX_CHAR_LABEL=20;const FIGURE_ID_SPLITTER="??";const DEFAULT_GAUGE_LOWER_COLOR="#cc0000";const DEFAULT_GAUGE_MIDDLE_COLOR="#f1c232";const DEFAULT_GAUGE_UPPER_COLOR="#6aa84f";const DEFAULT_SCORECARD_BASELINE_MODE="difference";const DEFAULT_SCORECARD_BASELINE_COLOR_UP="#00A04A";const DEFAULT_SCORECARD_BASELINE_COLOR_DOWN="#DC6965";const LINE_FILL_TRANSPARENCY=0.4;const DEBOUNCE_TIME=200;const MESSAGE_VERSION=1;const FORBIDDEN_SHEET_CHARS=["'","*","?","/","\\","[","]"];const FORBIDDEN_IN_EXCEL_REGEX=/'|\*|\?|\/|\\|\[|\]/;const FORMULA_REF_IDENTIFIER="|";const DEFAULT_ERROR_MESSAGE=_t("Invalid expression");var ComponentsImportance;(function(ComponentsImportance){ComponentsImportance[ComponentsImportance["Grid"]=0]="Grid";ComponentsImportance[ComponentsImportance["Highlight"]=5]="Highlight";ComponentsImportance[ComponentsImportance["HeaderGroupingButton"]=6]="HeaderGroupingButton";ComponentsImportance[ComponentsImportance["Figure"]=10]="Figure";ComponentsImportance[ComponentsImportance["ScrollBar"]=15]="ScrollBar";ComponentsImportance[ComponentsImportance["GridPopover"]=19]="GridPopover";ComponentsImportance[ComponentsImportance["GridComposer"]=20]="GridComposer";ComponentsImportance[ComponentsImportance["Dropdown"]=21]="Dropdown";ComponentsImportance[ComponentsImportance["IconPicker"]=25]="IconPicker";ComponentsImportance[ComponentsImportance["TopBarComposer"]=30]="TopBarComposer";ComponentsImportance[ComponentsImportance["Popover"]=35]="Popover";ComponentsImportance[ComponentsImportance["FigureAnchor"]=1000]="FigureAnchor";ComponentsImportance[ComponentsImportance["FigureSnapLine"]=1001]="FigureSnapLine";})(ComponentsImportance||(ComponentsImportance={}));let DEFAULT_SHEETVIEW_SIZE=0;function getDefaultSheetViewSize(){return DEFAULT_SHEETVIEW_SIZE;}
function setDefaultSheetViewSize(size){DEFAULT_SHEETVIEW_SIZE=size;}
const MAXIMAL_FREEZABLE_RATIO=0.85;const NEWLINE="\n";const FONT_SIZES=[6,7,8,9,10,11,12,14,18,24,36];function removeStringQuotes(str){if(str[0]==='"'){str=str.slice(1);}
if(str[str.length-1]==='"'&&str[str.length-2]!=="\\"){return str.slice(0,str.length-1);}
return str;}
function isCloneable(obj){return"clone"in obj&&obj.clone instanceof Function;}
function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}
function deepCopy(obj){const result=Array.isArray(obj)?[]:{};switch(typeof obj){case"object":{if(obj===null){return obj;}
else if(isCloneable(obj)){return obj.clone();}
else if(!(isPlainObject(obj)||obj instanceof Array)){throw new Error("Unsupported type: only objects and arrays are supported");}
for(const key in obj){result[key]=deepCopy(obj[key]);}
return result;}
case"number":case"string":case"boolean":case"function":case"undefined":return obj;default:throw new Error(`Unsupported type: ${typeof obj}`);}}
function isPlainObject(obj){return typeof obj==="object"&&obj?.constructor===Object;}
function getUnquotedSheetName(sheetName){if(sheetName.startsWith("'")){sheetName=sheetName.slice(1,-1).replace(/''/g,"'");}
return sheetName;}
function getCanonicalSheetName(sheetName){if(sheetName.match(/\w/g)?.length!==sheetName.length){sheetName=`'${sheetName}'`;}
return sheetName;}
function clip(val,min,max){return val<min?min:val>max?max:val;}
function range(start,end,step=1){if(end<=start&&step>0){return[];}
if(step===0){throw new Error("range() step must not be zero");}
const length=Math.ceil(Math.abs((end-start)/step));const array=Array(length);for(let i=0;i<length;i++){array[i]=start+i*step;}
return array;}
function groupConsecutive(numbers){return numbers.reduce((groups,currentRow,index,rows)=>{if(Math.abs(currentRow-rows[index-1])===1){const lastGroup=groups[groups.length-1];lastGroup.push(currentRow);}
else{groups.push([currentRow]);}
return groups;},[]);}
function*linkNext(generator,nextGenerator){nextGenerator.next();for(const item of generator){const nextItem=nextGenerator.next();yield{...item,next:nextItem.done?undefined:nextItem.value,};}}
function isBoolean(str){const upperCased=str.toUpperCase();return upperCased==="TRUE"||upperCased==="FALSE";}
const MARKDOWN_LINK_REGEX=/^\[(.+)\]\((.+)\)$/;const WEB_LINK_REGEX=/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,4}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/;function isMarkdownLink(str){return MARKDOWN_LINK_REGEX.test(str);}
function isWebLink(str){return WEB_LINK_REGEX.test(str);}
function markdownLink(label,url){return`[${label}](${url})`;}
function parseMarkdownLink(str){const matches=str.match(MARKDOWN_LINK_REGEX)||[];const label=matches[1];const url=matches[2];if(!label||!url){throw new Error(`Could not parse markdown link ${str}.`);}
return{label,url,};}
const O_SPREADSHEET_LINK_PREFIX="o-spreadsheet://";function isSheetUrl(url){return url.startsWith(O_SPREADSHEET_LINK_PREFIX);}
function buildSheetLink(sheetId){return`${O_SPREADSHEET_LINK_PREFIX}${sheetId}`;}
function parseSheetUrl(sheetLink){if(sheetLink.startsWith(O_SPREADSHEET_LINK_PREFIX)){return sheetLink.substr(O_SPREADSHEET_LINK_PREFIX.length);}
throw new Error(`${sheetLink} is not a valid sheet link`);}
function isDefined$1(argument){return argument!==undefined;}
function isNotNull(argument){return argument!==null;}
function isObjectEmptyRecursive(argument){if(argument===undefined)
return true;return Object.values(argument).every((value)=>typeof value==="object"?isObjectEmptyRecursive(value):!value);}
function getItemId(item,itemsDic){for(const key in itemsDic){if(deepEquals(itemsDic[key],item)){return parseInt(key,10);}}
const ids=Object.keys(itemsDic);const maxId=ids.length===0?0:largeMax(ids.map((id)=>parseInt(id,10)));itemsDic[maxId+1]=item;return maxId+1;}
function debounce(func,wait,immediate){let timeout;return function(){const context=this;const args=arguments;function later(){timeout=null;if(!immediate){func.apply(context,args);}}
const callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow){func.apply(context,args);}};}
function concat(chars){let output="";for(let i=0,len=chars.length;i<len;i++){output+=chars[i];}
return output;}
function lazy(fn){let isMemoized=false;let memo;const lazyValue=()=>{if(!isMemoized){memo=fn instanceof Function?fn():fn;isMemoized=true;}
return memo;};lazyValue.map=(callback)=>lazy(()=>callback(lazyValue()));return lazyValue;}
function findNextDefinedValue(arr,index){let value=arr.slice(index).find((val)=>val);if(!value){value=arr.slice(0,index).reverse().find((val)=>val);}
return value||"";}
function getAddHeaderStartIndex(position,base){return position==="after"?base+1:base;}
function deepEquals(o1,o2){if(o1===o2)
return true;if((o1&&!o2)||(o2&&!o1))
return false;if(typeof o1!==typeof o2)
return false;if(typeof o1!=="object")
return false;for(const key in o2){if(!(key in o1)&&o2[key]!==undefined){return false;}}
for(const key in o1){if(typeof o1[key]!==typeof o2[key])
return false;if(typeof o1[key]==="object"){if(!deepEquals(o1[key],o2[key]))
return false;}
else{if(o1[key]!==o2[key])
return false;}}
return true;}
function includesAll(arr,values){return values.every((value)=>arr.includes(value));}
function removeFalsyAttributes(obj){const cleanObject={...obj};Object.keys(cleanObject).forEach((key)=>!cleanObject[key]&&delete cleanObject[key]);return cleanObject;}
const whiteSpaceSpecialCharacters=["\t","\f","\v",String.fromCharCode(parseInt("00a0",16)),String.fromCharCode(parseInt("1680",16)),String.fromCharCode(parseInt("2000",16)),String.fromCharCode(parseInt("200a",16)),String.fromCharCode(parseInt("2028",16)),String.fromCharCode(parseInt("2029",16)),String.fromCharCode(parseInt("202f",16)),String.fromCharCode(parseInt("205f",16)),String.fromCharCode(parseInt("3000",16)),String.fromCharCode(parseInt("feff",16)),];const whiteSpaceRegexp=new RegExp(whiteSpaceSpecialCharacters.join("|")+"|(\r\n|\r|\n)","g");function replaceSpecialSpaces(text){if(!text)
return"";if(!whiteSpaceRegexp.test(text))
return text;return text.replace(whiteSpaceRegexp,(match,newLine)=>(newLine?NEWLINE:" "));}
function isConsecutive(iterable){const array=Array.from(iterable).sort((a,b)=>a-b);for(let i=1;i<array.length;i++){if(array[i]-array[i-1]!==1){return false;}}
return true;}
class JetSet extends Set{addMany(iterable){for(const element of iterable){super.add(element);}
return this;}
deleteMany(iterable){let wasDeleted=false;for(const element of iterable){wasDeleted||=super.delete(element);}
return wasDeleted;}}
function memoize(func){const cache=new Map();const funcName=func.name?func.name+" (memoized)":"memoized";return{[funcName](...args){if(!cache.has(args[0])){cache.set(args[0],func(...args));}
return cache.get(args[0]);},}[funcName];}
function removeIndexesFromArray(array,indexes){return array.filter((_,index)=>!indexes.includes(index));}
function insertItemsAtIndex(array,items,index){const newArray=[...array];newArray.splice(index,0,...items);return newArray;}
function trimContent(content){const contentLines=content.split("\n");return contentLines.map((line)=>line.replace(/\s+/g," ").trim()).join("\n");}
function isNumberBetween(value,min,max){if(min>max){return isNumberBetween(value,max,min);}
return value>=min&&value<=max;}
function largeMax(array){let len=array.length;if(len<100000)
return Math.max(...array);let max=-Infinity;while(len--){max=array[len]>max?array[len]:max;}
return max;}
function largeMin(array){let len=array.length;if(len<100000)
return Math.min(...array);let min=+Infinity;while(len--){min=array[len]<min?array[len]:min;}
return min;}
const RBA_REGEX=/rgba?\(|\s+|\)/gi;const HEX_MATCH=/^#([A-F\d]{2}){3,4}$/;const colors$1=["#eb6d00","#0074d9","#ad8e00","#169ed4","#b10dc9","#00a82d","#00a3a3","#f012be","#3d9970","#111111","#62A300","#ff4136","#949494","#85144b","#001f3f",];function colorNumberString(color){return toHex(color.toString(16).padStart(6,"0"));}
function toHex(color){let hexColor=color;if(color.startsWith("rgb")){hexColor=rgbaStringToHex(color);}
else{hexColor=color.replace("#","").toUpperCase();if(hexColor.length===3||hexColor.length===4){hexColor=hexColor.split("").reduce((acc,h)=>acc+h+h,"");}
hexColor=`#${hexColor}`;}
if(!HEX_MATCH.test(hexColor)){throw new Error(`invalid color input: ${color}`);}
return hexColor;}
function isColorValid(color){try{toHex(color);return true;}
catch(error){return false;}}
function isHSLAValid(color){try{hslaToHex(color);return true;}
catch(error){return false;}}
const isColorValueValid=(v)=>v>=0&&v<=255;function rgba(r,g,b,a=1){const isInvalid=!isColorValueValid(r)||!isColorValueValid(g)||!isColorValueValid(b)||a<0||a>1;if(isInvalid){throw new Error(`Invalid RGBA values ${[r, g, b, a]}`);}
return{a,b,g,r};}
function relativeLuminance(color){let{r,g,b}=colorToRGBA(color);r/=255;g/=255;b/=255;const toLinearValue=(c)=>(c<=0.03928?c/12.92:((c+0.055)/1.055)**2.4);const R=toLinearValue(r);const G=toLinearValue(g);const B=toLinearValue(b);return 0.2126*R+0.7152*G+0.0722*B;}
function rgbaStringToHex(color){const stringVals=color.replace(RBA_REGEX,"").split(",");let alphaHex=255;if(stringVals.length!==3&&stringVals.length!==4){throw new Error("invalid color");}
else if(stringVals.length===4){const alpha=parseFloat(stringVals.pop()||"1");alphaHex=Math.round((alpha||1)*255);}
const vals=stringVals.map((val)=>parseInt(val,10));if(alphaHex!==255){vals.push(alphaHex);}
return"#"+concat(vals.map((value)=>value.toString(16).padStart(2,"0"))).toUpperCase();}
function rgbaToHex(rgba){let r=rgba.r.toString(16);let g=rgba.g.toString(16);let b=rgba.b.toString(16);let a=Math.round(rgba.a*255).toString(16);if(r.length===1)
r="0"+r;if(g.length===1)
g="0"+g;if(b.length===1)
b="0"+b;if(a.length===1)
a="0"+a;if(a==="ff")
a="";return("#"+r+g+b+a).toUpperCase();}
function colorToRGBA(color){color=toHex(color);let r;let g;let b;let a;if(color.length===7){r=parseInt(color[1]+color[2],16);g=parseInt(color[3]+color[4],16);b=parseInt(color[5]+color[6],16);a=255;}
else if(color.length===9){r=parseInt(color[1]+color[2],16);g=parseInt(color[3]+color[4],16);b=parseInt(color[5]+color[6],16);a=parseInt(color[7]+color[8],16);}
else{throw new Error("Invalid color");}
a=+(a/255).toFixed(3);return{a,r,g,b};}
function hslaToRGBA(hsla){hsla={...hsla};hsla.s/=100;hsla.l/=100;let c=(1-Math.abs(2*hsla.l-1))*hsla.s;let x=c*(1-Math.abs(((hsla.h/60)%2)-1));let m=hsla.l-c/2;let r=0;let g=0;let b=0;if(0<=hsla.h&&hsla.h<60){r=c;g=x;b=0;}
else if(60<=hsla.h&&hsla.h<120){r=x;g=c;b=0;}
else if(120<=hsla.h&&hsla.h<180){r=0;g=c;b=x;}
else if(180<=hsla.h&&hsla.h<240){r=0;g=x;b=c;}
else if(240<=hsla.h&&hsla.h<300){r=x;g=0;b=c;}
else if(300<=hsla.h&&hsla.h<360){r=c;g=0;b=x;}
r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);return{a:hsla.a,r,g,b};}
function rgbaToHSLA(rgba){const r=rgba.r/255;const g=rgba.g/255;const b=rgba.b/255;let cMin=Math.min(r,g,b);let cMax=Math.max(r,g,b);let delta=cMax-cMin;let h=0;let s=0;let l=0;if(delta===0)
h=0;else if(cMax===r)
h=((g-b)/delta)%6;else if(cMax===g)
h=(b-r)/delta+2;else
h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)
h+=360;l=(cMax+cMin)/2;s=delta===0?0:delta/(1-Math.abs(2*l-1));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);return{a:rgba.a,h,s,l};}
function hslaToHex(hsla){return rgbaToHex(hslaToRGBA(hsla));}
function hexToHSLA(hex){return rgbaToHSLA(colorToRGBA(hex));}
function isSameColor(color1,color2,tolerance=0){if(!(isColorValid(color1)&&isColorValid(color2))){return false;}
const rgb1=colorToRGBA(color1);const rgb2=colorToRGBA(color2);if(rgb1.a!==rgb2.a){return false;}
const diff=Math.sqrt(((rgb1.r-rgb2.r)/255)**2+((rgb1.g-rgb2.g)/255)**2+((rgb1.b-rgb2.b)/255)**2);return diff<=tolerance;}
function numberToLetters(n){if(n<0){throw new Error(`number must be positive. Got ${n}`);}
if(n<26){return String.fromCharCode(65+n);}
else{return numberToLetters(Math.floor(n/26)-1)+numberToLetters(n%26);}}
const LETTERS="ABCDEFGHIJKLMNOPQRSTUVWXYZ";const LETTERS_NUMBER_MAPPING={};for(const letter of LETTERS){const colIndex=letter.charCodeAt(0)-64;LETTERS_NUMBER_MAPPING[letter]=colIndex;LETTERS_NUMBER_MAPPING[letter.toLowerCase()]=colIndex;}
function lettersToNumber(letters){let result=-1;const l=letters.length;let pow=1;for(let i=l-1;i>=0;i--){const charCode=LETTERS_NUMBER_MAPPING[letters[i]];result+=charCode*pow;pow*=26;}
return result;}
function isCharALetter(char){return(char>="A"&&char<="Z")||(char>="a"&&char<="z");}
function isCharADigit(char){return char>="0"&&char<="9";}
function toCartesian(xc){xc=xc.trim();let numberPartStart=undefined;for(let i=0;i<xc.length;i++){const char=xc[i];if(!numberPartStart){if((char==="$"&&i===0)||isCharALetter(char)){continue;}
numberPartStart=i;}
if(!isCharADigit(char)){if(char==="$"&&i===numberPartStart){continue;}
throw new Error(`Invalid cell description: ${xc}`);}}
if(!numberPartStart||numberPartStart===xc.length){throw new Error(`Invalid cell description: ${xc}`);}
const letterPart=xc[0]==="$"?xc.slice(1,numberPartStart):xc.slice(0,numberPartStart);const numberPart=xc[numberPartStart]==="$"?xc.slice(numberPartStart+1):xc.slice(numberPartStart);if(letterPart.length<1||letterPart.length>3||numberPart.length<1||numberPart.length>7){throw new Error(`Invalid cell description: ${xc}`);}
const col=lettersToNumber(letterPart);const row=Number(numberPart)-1;if(isNaN(row)){throw new Error(`Invalid cell description: ${xc}`);}
return{col,row};}
function toXC(col,row,rangePart={colFixed:false,rowFixed:false}){return((rangePart.colFixed?"$":"")+
numberToLetters(col)+
(rangePart.rowFixed?"$":"")+
String(row+1));}
class DateTime{jsDate;constructor(year,month,day,hours=0,minutes=0,seconds=0){this.jsDate=new Date(Date.UTC(year,month,day,hours,minutes,seconds,0));}
static fromTimestamp(timestamp){const date=new Date(timestamp);return new DateTime(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds());}
static now(){const now=new Date();return new DateTime(now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds());}
toString(){return this.jsDate.toString();}
toLocaleDateString(){return this.jsDate.toLocaleDateString();}
getTime(){return this.jsDate.getTime();}
getFullYear(){return this.jsDate.getUTCFullYear();}
getMonth(){return this.jsDate.getUTCMonth();}
getDate(){return this.jsDate.getUTCDate();}
getDay(){return this.jsDate.getUTCDay();}
getHours(){return this.jsDate.getUTCHours();}
getMinutes(){return this.jsDate.getUTCMinutes();}
getSeconds(){return this.jsDate.getUTCSeconds();}
setFullYear(year){return this.jsDate.setUTCFullYear(year);}
setMonth(month){return this.jsDate.setUTCMonth(month);}
setDate(date){return this.jsDate.setUTCDate(date);}
setHours(hours){return this.jsDate.setUTCHours(hours);}
setMinutes(minutes){return this.jsDate.setUTCMinutes(minutes);}
setSeconds(seconds){return this.jsDate.setUTCSeconds(seconds);}}
const INITIAL_1900_DAY=new DateTime(1899,11,30);const MS_PER_DAY=24*60*60*1000;const CURRENT_MILLENIAL=2000;const CURRENT_YEAR=DateTime.now().getFullYear();const CURRENT_MONTH=DateTime.now().getMonth();const INITIAL_JS_DAY=DateTime.fromTimestamp(0);const DATE_JS_1900_OFFSET=INITIAL_JS_DAY.getTime()-INITIAL_1900_DAY.getTime();const mdyDateRegexp=/^\d{1,2}(\/|-|\s)\d{1,2}((\/|-|\s)\d{1,4})?$/;const ymdDateRegexp=/^\d{3,4}(\/|-|\s)\d{1,2}(\/|-|\s)\d{1,2}$/;const dateSeparatorsRegex=/\/|-|\s/;const dateRegexp=/^(\d{1,4})[\/-\s](\d{1,4})([\/-\s](\d{1,4}))?$/;const timeRegexp=/((\d+(:\d+)?(:\d+)?\s*(AM|PM))|(\d+:\d+(:\d+)?))$/;function valueToDateNumber(value,locale){switch(typeof value){case"number":return value;case"string":if(isDateTime(value,locale)){return parseDateTime(value,locale)?.value;}
return!value||isNaN(Number(value))?undefined:Number(value);default:return undefined;}}
function isDateTime(str,locale){return parseDateTime(str,locale)!==null;}
const CACHE=new Map();function parseDateTime(str,locale){if(!CACHE.has(locale)){CACHE.set(locale,new Map());}
if(!CACHE.get(locale).has(str)){CACHE.get(locale).set(str,_parseDateTime(str,locale));}
return CACHE.get(locale).get(str);}
function _parseDateTime(str,locale){str=str.trim();let time=null;const timeMatch=str.match(timeRegexp);if(timeMatch){time=parseTime(timeMatch[0]);if(time===null){return null;}
str=str.replace(timeMatch[0],"").trim();}
let date=null;const dateParts=getDateParts(str,locale);if(dateParts){const separator=dateParts.dateString.match(dateSeparatorsRegex)[0];date=parseDate(dateParts,separator);if(date===null){return null;}
str=str.replace(dateParts.dateString,"").trim();}
if(str!==""||!(date||time)){return null;}
if(date&&date.jsDate&&time&&time.jsDate){return{value:date.value+time.value,format:date.format+" "+(time.format==="hhhh:mm:ss"?"hh:mm:ss":time.format),jsDate:new DateTime(date.jsDate.getFullYear()+time.jsDate.getFullYear()-1899,date.jsDate.getMonth()+time.jsDate.getMonth()-11,date.jsDate.getDate()+time.jsDate.getDate()-30,date.jsDate.getHours()+time.jsDate.getHours(),date.jsDate.getMinutes()+time.jsDate.getMinutes(),date.jsDate.getSeconds()+time.jsDate.getSeconds()),};}
return date||time;}
function getDateParts(dateString,locale){const match=dateString.match(dateRegexp);if(!match){return null;}
const[,part1,part2,,part3]=match;if(part1.length>2&&part3&&part3.length>2){return null;}
if(part1.length>2){return{year:part1,month:part2,day:part3,dateString,type:"ymd"};}
const localeDateType=getLocaleDateFormatType(locale);if(!part3){if(part2.length>2){return{month:part1,year:part2,day:undefined,dateString,type:localeDateType};}
if(localeDateType==="dmy"){return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
if(part3.length>2){if(localeDateType==="mdy"){return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
if(localeDateType==="mdy"){return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
if(localeDateType==="ymd"){return{year:part1,month:part2,day:part3,dateString,type:"ymd"};}
if(localeDateType==="dmy"){return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
return null;}
function getLocaleDateFormatType(locale){switch(locale.dateFormat[0]){case"d":return"dmy";case"m":return"mdy";case"y":return"ymd";}
throw new Error("Invalid date format in locale");}
function parseDate(parts,separator){let{year:yearStr,month:monthStr,day:dayStr}=parts;const month=inferMonth(monthStr);const day=inferDay(dayStr);const year=inferYear(yearStr);if(year===null||month===null||day===null){return null;}
const leadingZero=(monthStr?.length===2&&month+1<10)||(dayStr?.length===2&&day<10);const fullYear=yearStr?.length!==2;const jsDate=new DateTime(year,month,day);if(jsDate.getMonth()!==month||jsDate.getDate()!==day){return null;}
const delta=jsDate.getTime()-INITIAL_1900_DAY.getTime();const format=getFormatFromDateParts(parts,separator,leadingZero,fullYear);return{value:Math.round(delta/MS_PER_DAY),format:format,jsDate,};}
function getFormatFromDateParts(parts,sep,leadingZero,fullYear){const yearFmt=parts.year?(fullYear?"yyyy":"yy"):undefined;const monthFmt=parts.month?(leadingZero?"mm":"m"):undefined;const dayFmt=parts.day?(leadingZero?"dd":"d"):undefined;switch(parts.type){case"mdy":return[monthFmt,dayFmt,yearFmt].filter(isDefined$1).join(sep);case"ymd":return[yearFmt,monthFmt,dayFmt].filter(isDefined$1).join(sep);case"dmy":return[dayFmt,monthFmt,yearFmt].filter(isDefined$1).join(sep);}}
function inferYear(yearStr){if(!yearStr){return CURRENT_YEAR;}
const nbr=Number(yearStr);switch(yearStr.length){case 1:return CURRENT_MILLENIAL+nbr;case 2:const offset=CURRENT_MILLENIAL+nbr>CURRENT_YEAR+10?-100:0;const base=CURRENT_MILLENIAL+offset;return base+nbr;case 3:case 4:return nbr;}
return null;}
function inferMonth(monthStr){if(!monthStr){return CURRENT_MONTH;}
const nbr=Number(monthStr);if(nbr>=1&&nbr<=12){return nbr-1;}
return null;}
function inferDay(dayStr){if(!dayStr){return 1;}
const nbr=Number(dayStr);if(nbr>=0&&nbr<=31){return nbr;}
return null;}
function parseTime(str){str=str.trim();if(timeRegexp.test(str)){const isAM=/AM/i.test(str);const isPM=/PM/i.test(str);const strTime=isAM||isPM?str.substring(0,str.length-2).trim():str;const parts=strTime.split(/:/);const isMinutes=parts.length>=2;const isSeconds=parts.length===3;let hours=Number(parts[0]);let minutes=isMinutes?Number(parts[1]):0;let seconds=isSeconds?Number(parts[2]):0;let format=isSeconds?"hh:mm:ss":"hh:mm";if(isAM||isPM){format+=" a";}
else if(!isMinutes){return null;}
if(hours>=12&&isAM){hours-=12;}
else if(hours<12&&isPM){hours+=12;}
minutes+=Math.floor(seconds/60);seconds%=60;hours+=Math.floor(minutes/60);minutes%=60;if(hours>=24){format="hhhh:mm:ss";}
const jsDate=new DateTime(1899,11,30,hours,minutes,seconds);return{value:hours/24+minutes/1440+seconds/86400,format:format,jsDate:jsDate,};}
return null;}
function numberToJsDate(value){const truncValue=Math.trunc(value);let date=DateTime.fromTimestamp(truncValue*MS_PER_DAY-DATE_JS_1900_OFFSET);let time=value-truncValue;time=time<0?1+time:time;const hours=Math.round(time*24);const minutes=Math.round((time-hours/24)*24*60);const seconds=Math.round((time-hours/24-minutes/24/60)*24*60*60);date.setHours(hours);date.setMinutes(minutes);date.setSeconds(seconds);return date;}
function jsDateToRoundNumber(date){return Math.round(jsDateToNumber(date));}
function jsDateToNumber(date){const delta=date.getTime()-INITIAL_1900_DAY.getTime();return delta/MS_PER_DAY;}
function getDaysInMonth(date){return new DateTime(date.getFullYear(),date.getMonth()+1,0).getDate();}
function isLastDayOfMonth(date){return getDaysInMonth(date)===date.getDate();}
function addMonthsToDate(date,months,keepEndOfMonth){const yStart=date.getFullYear();const mStart=date.getMonth();const dStart=date.getDate();const jsDate=new DateTime(yStart,mStart+months,1);if(keepEndOfMonth&&dStart===getDaysInMonth(date)){jsDate.setDate(getDaysInMonth(jsDate));}
else if(dStart>getDaysInMonth(jsDate)){jsDate.setDate(getDaysInMonth(jsDate));}
else{jsDate.setDate(dStart);}
return jsDate;}
function isLeapYear(year){const _year=Math.trunc(year);return(_year%4===0&&_year%100!=0)||_year%400===0;}
function getYearFrac(startDate,endDate,_dayCountConvention){if(startDate===endDate){return 0;}
if(startDate>endDate){const stack=endDate;endDate=startDate;startDate=stack;}
const jsStartDate=numberToJsDate(startDate);const jsEndDate=numberToJsDate(endDate);let dayStart=jsStartDate.getDate();let dayEnd=jsEndDate.getDate();const monthStart=jsStartDate.getMonth();const monthEnd=jsEndDate.getMonth();const yearStart=jsStartDate.getFullYear();const yearEnd=jsEndDate.getFullYear();let yearsStart=0;let yearsEnd=0;switch(_dayCountConvention){case 0:if(dayStart===31)
dayStart=30;if(dayStart===30&&dayEnd===31)
dayEnd=30;if(monthStart===1&&dayStart===(isLeapYear(yearStart)?29:28)){dayStart=30;if(monthEnd===1&&dayEnd===(isLeapYear(yearEnd)?29:28)){dayEnd=30;}}
yearsStart=yearStart+(monthStart*30+dayStart)/360;yearsEnd=yearEnd+(monthEnd*30+dayEnd)/360;break;case 1:let daysInYear=365;const isSameYear=yearStart===yearEnd;const isOneDeltaYear=yearStart+1===yearEnd;const isMonthEndBigger=monthStart<monthEnd;const isSameMonth=monthStart===monthEnd;const isDayEndBigger=dayStart<dayEnd;if((!isSameYear&&!isOneDeltaYear)||(!isSameYear&&isMonthEndBigger)||(!isSameYear&&isSameMonth&&isDayEndBigger)){let countYears=0;let countDaysInYears=0;for(let y=yearStart;y<=yearEnd;y++){countYears++;countDaysInYears+=isLeapYear(y)?366:365;}
daysInYear=countDaysInYears/countYears;}
else if(!isSameYear){if(isLeapYear(yearStart)&&monthStart<2){daysInYear=366;}
if(isLeapYear(yearEnd)&&(monthEnd>1||(monthEnd===1&&dayEnd===29))){daysInYear=366;}}
else{if(isLeapYear(yearStart)){daysInYear=366;}}
yearsStart=startDate/daysInYear;yearsEnd=endDate/daysInYear;break;case 2:yearsStart=startDate/360;yearsEnd=endDate/360;break;case 3:yearsStart=startDate/365;yearsEnd=endDate/365;break;case 4:if(dayStart===31)
dayStart=30;if(dayEnd===31)
dayEnd=30;yearsStart=yearStart+(monthStart*30+dayStart)/360;yearsEnd=yearEnd+(monthEnd*30+dayEnd)/360;break;}
return yearsEnd-yearsStart;}
function getTimeDifferenceInWholeMonths(startDate,endDate){const months=(endDate.getFullYear()-startDate.getFullYear())*12+
endDate.getMonth()-
startDate.getMonth();return startDate.getDate()>endDate.getDate()?months-1:months;}
function getTimeDifferenceInWholeDays(startDate,endDate){const startUtc=startDate.getTime();const endUtc=endDate.getTime();return Math.floor((endUtc-startUtc)/MS_PER_DAY);}
function getTimeDifferenceInWholeYears(startDate,endDate){const years=endDate.getFullYear()-startDate.getFullYear();const monthStart=startDate.getMonth();const monthEnd=endDate.getMonth();const dateStart=startDate.getDate();const dateEnd=endDate.getDate();const isEndMonthDateBigger=monthEnd>monthStart||(monthEnd===monthStart&&dateEnd>=dateStart);return isEndMonthDateBigger?years:years-1;}
function areTwoDatesWithinOneYear(startDate,endDate){return getYearFrac(startDate,endDate,1)<1;}
function areDatesSameDay(startDate,endDate){return Math.trunc(startDate)===Math.trunc(endDate);}
function isDateBetween(date,startDate,endDate){if(startDate>endDate){return isDateBetween(date,endDate,startDate);}
date=Math.trunc(date);startDate=Math.trunc(startDate);endDate=Math.trunc(endDate);return date>=startDate&&date<=endDate;}
function isDateStrictlyBefore(date,dateBefore){return Math.trunc(date)<Math.trunc(dateBefore);}
function isDateBefore(date,dateBefore){return Math.trunc(date)<=Math.trunc(dateBefore);}
function isDateStrictlyAfter(date,dateAfter){return Math.trunc(date)>Math.trunc(dateAfter);}
function isDateAfter(date,dateAfter){return Math.trunc(date)>=Math.trunc(dateAfter);}
const getFormulaNumberRegex=memoize(function getFormulaNumberRegex(decimalSeparator){decimalSeparator=escapeRegExp(decimalSeparator);return new RegExp(`(^-?\\d+(${decimalSeparator}?\\d*(e\\d+)?)?|^-?${decimalSeparator}\\d+)(?!\\w|!)`);});const getNumberRegex=memoize(function getNumberRegex(locale){const decimalSeparator=escapeRegExp(locale.decimalSeparator);const thousandsSeparator=escapeRegExp(locale.thousandsSeparator);const pIntegerAndDecimals=`(\\d+(${thousandsSeparator}\\d{3,})*(${decimalSeparator}\\d*)?)`;const pOnlyDecimals=`(${decimalSeparator}\\d+)`;const pScientificFormat="(e(\\+|-)?\\d+)?";const pPercentFormat="(\\s*%)?";const pNumber="(\\s*"+pIntegerAndDecimals+"|"+pOnlyDecimals+")"+pScientificFormat+pPercentFormat;const pMinus="(\\s*-)?";const pCurrencyFormat="(\\s*[\\$€])?";const p1=pMinus+pCurrencyFormat+pNumber;const p2=pMinus+pNumber+pCurrencyFormat;const p3=pCurrencyFormat+pMinus+pNumber;const pNumberExp="^(("+[p1,p2,p3].join(")|(")+"))$";const numberRegexp=new RegExp(pNumberExp,"i");return numberRegexp;});function isNumber(value,locale){if(!value)
return false;return getNumberRegex(locale).test(value.trim());}
const getInvaluableSymbolsRegexp=memoize(function getInvaluableSymbolsRegexp(locale){return new RegExp(`[\$€${escapeRegExp(locale.thousandsSeparator)}]`,"g");});function parseNumber(str,locale){if(locale.decimalSeparator!=="."){str=str.replace(locale.decimalSeparator,".");}
str=str.replace(getInvaluableSymbolsRegexp(locale),"");let n=Number(str);if(isNaN(n)&&str.includes("%")){n=Number(str.split("%")[0]);if(!isNaN(n)){return n/100;}}
return n;}
function percentile(values,percent,isInclusive){const sortedValues=[...values].sort((a,b)=>a-b);let percentIndex=(sortedValues.length+(isInclusive?-1:1))*percent;if(!isInclusive){percentIndex--;}
if(Number.isInteger(percentIndex)){return sortedValues[percentIndex];}
const indexSup=Math.ceil(percentIndex);const indexLow=Math.floor(percentIndex);return(sortedValues[indexSup]*(percentIndex-indexLow)+
sortedValues[indexLow]*(indexSup-percentIndex));}
var CellValueType;(function(CellValueType){CellValueType["boolean"]="boolean";CellValueType["number"]="number";CellValueType["text"]="text";CellValueType["empty"]="empty";CellValueType["error"]="error";})(CellValueType||(CellValueType={}));var ClipboardMIMEType;(function(ClipboardMIMEType){ClipboardMIMEType["PlainText"]="text/plain";ClipboardMIMEType["Html"]="text/html";})(ClipboardMIMEType||(ClipboardMIMEType={}));function isSheetDependent(cmd){return"sheetId"in cmd;}
function isHeadersDependant(cmd){return"dimension"in cmd&&"sheetId"in cmd&&"elements"in cmd;}
function isTargetDependent(cmd){return"target"in cmd&&"sheetId"in cmd;}
function isRangeDependant(cmd){return"ranges"in cmd;}
function isZoneDependent(cmd){return"zone"in cmd;}
function isPositionDependent(cmd){return"col"in cmd&&"row"in cmd&&"sheetId"in cmd;}
const invalidateEvaluationCommands=new Set(["RENAME_SHEET","DELETE_SHEET","CREATE_SHEET","ADD_COLUMNS_ROWS","REMOVE_COLUMNS_ROWS","UNDO","REDO","ADD_MERGE","UPDATE_LOCALE",]);const invalidateDependenciesCommands=new Set([...invalidateEvaluationCommands,"MOVE_RANGES",]);const invalidateCFEvaluationCommands=new Set([...invalidateEvaluationCommands,"DUPLICATE_SHEET","EVALUATE_CELLS","ADD_CONDITIONAL_FORMAT","REMOVE_CONDITIONAL_FORMAT","CHANGE_CONDITIONAL_FORMAT_PRIORITY",]);const readonlyAllowedCommands=new Set(["START","ACTIVATE_SHEET","COPY","RESIZE_SHEETVIEW","SET_VIEWPORT_OFFSET","SELECT_SEARCH_NEXT_MATCH","SELECT_SEARCH_PREVIOUS_MATCH","UPDATE_SEARCH","CLEAR_SEARCH","EVALUATE_CELLS","SET_CURRENT_CONTENT","SET_FORMULA_VISIBILITY","OPEN_CELL_POPOVER","CLOSE_CELL_POPOVER","UPDATE_FILTER",]);const coreTypes=new Set(["UPDATE_CELL","UPDATE_CELL_POSITION","CLEAR_CELL","DELETE_CONTENT","ADD_COLUMNS_ROWS","REMOVE_COLUMNS_ROWS","RESIZE_COLUMNS_ROWS","HIDE_COLUMNS_ROWS","UNHIDE_COLUMNS_ROWS","SET_GRID_LINES_VISIBILITY","UNFREEZE_COLUMNS","UNFREEZE_ROWS","FREEZE_COLUMNS","FREEZE_ROWS","UNFREEZE_COLUMNS_ROWS","ADD_MERGE","REMOVE_MERGE","CREATE_SHEET","DELETE_SHEET","DUPLICATE_SHEET","MOVE_SHEET","RENAME_SHEET","HIDE_SHEET","SHOW_SHEET","MOVE_RANGES","ADD_CONDITIONAL_FORMAT","REMOVE_CONDITIONAL_FORMAT","CHANGE_CONDITIONAL_FORMAT_PRIORITY","CREATE_FIGURE","DELETE_FIGURE","UPDATE_FIGURE","SET_FORMATTING","CLEAR_FORMATTING","SET_BORDER","SET_ZONE_BORDERS","CREATE_CHART","UPDATE_CHART","CREATE_FILTER_TABLE","REMOVE_FILTER_TABLE","CREATE_IMAGE","GROUP_HEADERS","UNGROUP_HEADERS","UNFOLD_HEADER_GROUP","FOLD_HEADER_GROUP","FOLD_ALL_HEADER_GROUPS","UNFOLD_ALL_HEADER_GROUPS","UNFOLD_HEADER_GROUPS_IN_ZONE","FOLD_HEADER_GROUPS_IN_ZONE","ADD_DATA_VALIDATION_RULE","REMOVE_DATA_VALIDATION_RULE","UPDATE_LOCALE",]);function isCoreCommand(cmd){return coreTypes.has(cmd.type);}
function canExecuteInReadonly(cmd){return readonlyAllowedCommands.has(cmd.type);}
class DispatchResult{reasons;constructor(results=[]){if(!Array.isArray(results)){results=[results];}
results=[...new Set(results)];this.reasons=results.filter((result)=>result!=="Success");}
static get Success(){return SUCCESS;}
get isSuccessful(){return this.reasons.length===0;}
isCancelledBecause(reason){return this.reasons.includes(reason);}}
const SUCCESS=new DispatchResult();exports.CommandResult=void 0;(function(CommandResult){CommandResult["Success"]="Success";CommandResult["CancelledForUnknownReason"]="CancelledForUnknownReason";CommandResult["WillRemoveExistingMerge"]="WillRemoveExistingMerge";CommandResult["MergeIsDestructive"]="MergeIsDestructive";CommandResult["CellIsMerged"]="CellIsMerged";CommandResult["InvalidTarget"]="InvalidTarget";CommandResult["EmptyUndoStack"]="EmptyUndoStack";CommandResult["EmptyRedoStack"]="EmptyRedoStack";CommandResult["NotEnoughElements"]="NotEnoughElements";CommandResult["NotEnoughSheets"]="NotEnoughSheets";CommandResult["MissingSheetName"]="MissingSheetName";CommandResult["UnchangedSheetName"]="UnchangedSheetName";CommandResult["DuplicatedSheetName"]="DuplicatedSheetName";CommandResult["DuplicatedSheetId"]="DuplicatedSheetId";CommandResult["ForbiddenCharactersInSheetName"]="ForbiddenCharactersInSheetName";CommandResult["WrongSheetMove"]="WrongSheetMove";CommandResult["WrongSheetPosition"]="WrongSheetPosition";CommandResult["InvalidAnchorZone"]="InvalidAnchorZone";CommandResult["SelectionOutOfBound"]="SelectionOutOfBound";CommandResult["TargetOutOfSheet"]="TargetOutOfSheet";CommandResult["WrongCutSelection"]="WrongCutSelection";CommandResult["WrongPasteSelection"]="WrongPasteSelection";CommandResult["WrongPasteOption"]="WrongPasteOption";CommandResult["WrongFigurePasteOption"]="WrongFigurePasteOption";CommandResult["EmptyClipboard"]="EmptyClipboard";CommandResult["EmptyRange"]="EmptyRange";CommandResult["InvalidRange"]="InvalidRange";CommandResult["InvalidZones"]="InvalidZones";CommandResult["InvalidSheetId"]="InvalidSheetId";CommandResult["InvalidFigureId"]="InvalidFigureId";CommandResult["InputAlreadyFocused"]="InputAlreadyFocused";CommandResult["MaximumRangesReached"]="MaximumRangesReached";CommandResult["MinimumRangesReached"]="MinimumRangesReached";CommandResult["InvalidChartDefinition"]="InvalidChartDefinition";CommandResult["InvalidDataSet"]="InvalidDataSet";CommandResult["InvalidLabelRange"]="InvalidLabelRange";CommandResult["InvalidScorecardKeyValue"]="InvalidScorecardKeyValue";CommandResult["InvalidScorecardBaseline"]="InvalidScorecardBaseline";CommandResult["InvalidGaugeDataRange"]="InvalidGaugeDataRange";CommandResult["EmptyGaugeRangeMin"]="EmptyGaugeRangeMin";CommandResult["GaugeRangeMinNaN"]="GaugeRangeMinNaN";CommandResult["EmptyGaugeRangeMax"]="EmptyGaugeRangeMax";CommandResult["GaugeRangeMaxNaN"]="GaugeRangeMaxNaN";CommandResult["GaugeRangeMinBiggerThanRangeMax"]="GaugeRangeMinBiggerThanRangeMax";CommandResult["GaugeLowerInflectionPointNaN"]="GaugeLowerInflectionPointNaN";CommandResult["GaugeUpperInflectionPointNaN"]="GaugeUpperInflectionPointNaN";CommandResult["GaugeLowerBiggerThanUpper"]="GaugeLowerBiggerThanUpper";CommandResult["InvalidAutofillSelection"]="InvalidAutofillSelection";CommandResult["WrongComposerSelection"]="WrongComposerSelection";CommandResult["MinBiggerThanMax"]="MinBiggerThanMax";CommandResult["LowerBiggerThanUpper"]="LowerBiggerThanUpper";CommandResult["MidBiggerThanMax"]="MidBiggerThanMax";CommandResult["MinBiggerThanMid"]="MinBiggerThanMid";CommandResult["FirstArgMissing"]="FirstArgMissing";CommandResult["SecondArgMissing"]="SecondArgMissing";CommandResult["MinNaN"]="MinNaN";CommandResult["MidNaN"]="MidNaN";CommandResult["MaxNaN"]="MaxNaN";CommandResult["ValueUpperInflectionNaN"]="ValueUpperInflectionNaN";CommandResult["ValueLowerInflectionNaN"]="ValueLowerInflectionNaN";CommandResult["MinInvalidFormula"]="MinInvalidFormula";CommandResult["MidInvalidFormula"]="MidInvalidFormula";CommandResult["MaxInvalidFormula"]="MaxInvalidFormula";CommandResult["ValueUpperInvalidFormula"]="ValueUpperInvalidFormula";CommandResult["ValueLowerInvalidFormula"]="ValueLowerInvalidFormula";CommandResult["InvalidSortZone"]="InvalidSortZone";CommandResult["WaitingSessionConfirmation"]="WaitingSessionConfirmation";CommandResult["MergeOverlap"]="MergeOverlap";CommandResult["TooManyHiddenElements"]="TooManyHiddenElements";CommandResult["Readonly"]="Readonly";CommandResult["InvalidViewportSize"]="InvalidViewportSize";CommandResult["InvalidScrollingDirection"]="InvalidScrollingDirection";CommandResult["FigureDoesNotExist"]="FigureDoesNotExist";CommandResult["InvalidConditionalFormatId"]="InvalidConditionalFormatId";CommandResult["InvalidCellPopover"]="InvalidCellPopover";CommandResult["EmptyTarget"]="EmptyTarget";CommandResult["InvalidFreezeQuantity"]="InvalidFreezeQuantity";CommandResult["FrozenPaneOverlap"]="FrozenPaneOverlap";CommandResult["ValuesNotChanged"]="ValuesNotChanged";CommandResult["InvalidFilterZone"]="InvalidFilterZone";CommandResult["FilterOverlap"]="FilterOverlap";CommandResult["FilterNotFound"]="FilterNotFound";CommandResult["MergeInFilter"]="MergeInFilter";CommandResult["NonContinuousTargets"]="NonContinuousTargets";CommandResult["DuplicatedFigureId"]="DuplicatedFigureId";CommandResult["InvalidSelectionStep"]="InvalidSelectionStep";CommandResult["DuplicatedChartId"]="DuplicatedChartId";CommandResult["ChartDoesNotExist"]="ChartDoesNotExist";CommandResult["InvalidHeaderIndex"]="InvalidHeaderIndex";CommandResult["InvalidQuantity"]="InvalidQuantity";CommandResult["MoreThanOneColumnSelected"]="MoreThanOneColumnSelected";CommandResult["EmptySplitSeparator"]="EmptySplitSeparator";CommandResult["SplitWillOverwriteContent"]="SplitWillOverwriteContent";CommandResult["NoSplitSeparatorInSelection"]="NoSplitSeparatorInSelection";CommandResult["NoActiveSheet"]="NoActiveSheet";CommandResult["InvalidLocale"]="InvalidLocale";CommandResult["AlreadyInPaintingFormatMode"]="AlreadyInPaintingFormatMode";CommandResult["MoreThanOneRangeSelected"]="MoreThanOneRangeSelected";CommandResult["NoColumnsProvided"]="NoColumnsProvided";CommandResult["ColumnsNotIncludedInZone"]="ColumnsNotIncludedInZone";CommandResult["DuplicatesColumnsSelected"]="DuplicatesColumnsSelected";CommandResult["InvalidHeaderGroupStartEnd"]="InvalidHeaderGroupStartEnd";CommandResult["HeaderGroupAlreadyExists"]="HeaderGroupAlreadyExists";CommandResult["UnknownHeaderGroup"]="UnknownHeaderGroup";CommandResult["UnknownDataValidationRule"]="UnknownDataValidationRule";CommandResult["UnknownDataValidationCriterionType"]="UnknownDataValidationCriterionType";CommandResult["InvalidDataValidationCriterionValue"]="InvalidDataValidationCriterionValue";CommandResult["InvalidNumberOfCriterionValues"]="InvalidNumberOfCriterionValues";CommandResult["BlockingValidationRule"]="BlockingValidationRule";CommandResult["InvalidCopyPasteSelection"]="InvalidCopyPasteSelection";CommandResult["NoChanges"]="NoChanges";CommandResult["InvalidInputId"]="InvalidInputId";})(exports.CommandResult||(exports.CommandResult={}));const DEFAULT_LOCALES=[{name:"English (US)",code:"en_US",thousandsSeparator:",",decimalSeparator:".",dateFormat:"m/d/yyyy",timeFormat:"hh:mm:ss a",formulaArgSeparator:",",},{name:"French",code:"fr_FR",thousandsSeparator:" ",decimalSeparator:",",dateFormat:"dd/mm/yyyy",timeFormat:"hh:mm:ss",formulaArgSeparator:";",},];const DEFAULT_LOCALE=DEFAULT_LOCALES[0];const borderStyles=["thin","medium","thick","dashed","dotted"];function isMatrix(x){return Array.isArray(x)&&Array.isArray(x[0]);}
var DIRECTION;(function(DIRECTION){DIRECTION["UP"]="up";DIRECTION["DOWN"]="down";DIRECTION["LEFT"]="left";DIRECTION["RIGHT"]="right";})(DIRECTION||(DIRECTION={}));var LAYERS;(function(LAYERS){LAYERS[LAYERS["Background"]=0]="Background";LAYERS[LAYERS["Highlights"]=1]="Highlights";LAYERS[LAYERS["Clipboard"]=2]="Clipboard";LAYERS[LAYERS["Search"]=3]="Search";LAYERS[LAYERS["Chart"]=4]="Chart";LAYERS[LAYERS["Autofill"]=5]="Autofill";LAYERS[LAYERS["Selection"]=6]="Selection";LAYERS[LAYERS["Headers"]=7]="Headers";})(LAYERS||(LAYERS={}));const SORT_TYPES_ORDER=["number","string","boolean","undefined"];function assert(condition,message){if(!condition()){throw new EvaluationError(CellErrorType.GenericError,message);}}
const expectNumberValueError=(value)=>_t("The function [[FUNCTION_NAME]] expects a number value, but '%s' is a string, and cannot be coerced to a number.",value);const expectNumberRangeError=(lowerBound,upperBound,value)=>_t("The function [[FUNCTION_NAME]] expects a number value between %s and %s inclusive, but receives %s.",lowerBound.toString(),upperBound.toString(),value.toString());const expectStringSetError=(stringSet,value)=>{const stringSetString=stringSet.map((str)=>`'${str}'`).join(", ");return _t("The function [[FUNCTION_NAME]] has an argument with value '%s'. It should be one of: %s.",value,stringSetString);};function toNumber(value,locale){switch(typeof value){case"number":return value;case"boolean":return value?1:0;case"string":if(isNumber(value,locale)||value===""){return parseNumber(value,locale);}
const internalDate=parseDateTime(value,locale);if(internalDate){return internalDate.value;}
throw new Error(expectNumberValueError(value));default:return 0;}}
function tryToNumber(value,locale){try{return toNumber(value,locale);}
catch(e){return undefined;}}
function tryCastAsNumberMatrix(data,argName){data.forEach((row)=>{row.forEach((cell)=>{if(typeof cell!=="number"){throw new Error(_t("Function [[FUNCTION_NAME]] expects number values for %s, but got a %s.",typeof cell,argName));}});});return data;}
function strictToNumber(value,locale){if(value===""){throw new Error(expectNumberValueError(value));}
return toNumber(value,locale);}
function toInteger(value,locale){return Math.trunc(toNumber(value,locale));}
function strictToInteger(value,locale){return Math.trunc(strictToNumber(value,locale));}
function assertNumberGreaterThanOrEqualToOne(value){assert(()=>value>=1,_t("The function [[FUNCTION_NAME]] expects a number value to be greater than or equal to 1, but receives %s.",value.toString()));}
function toString(value){switch(typeof value){case"string":return value;case"number":return value.toString();case"boolean":return value?"TRUE":"FALSE";default:return"";}}
const normalizeString=memoize(function normalizeString(str){return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");});const expectBooleanValueError=(value)=>_t("The function [[FUNCTION_NAME]] expects a boolean value, but '%s' is a text, and cannot be coerced to a number.",value);function toBoolean(value){switch(typeof value){case"boolean":return value;case"string":if(value){let uppercaseVal=value.toUpperCase();if(uppercaseVal==="TRUE"){return true;}
if(uppercaseVal==="FALSE"){return false;}
throw new Error(expectBooleanValueError(value));}
else{return false;}
case"number":return value?true:false;default:return false;}}
function strictToBoolean(value){if(value===""){throw new Error(expectBooleanValueError(value));}
return toBoolean(value);}
function toJsDate(value,locale){return numberToJsDate(toNumber(value,locale));}
function visitArgs(args,cellCb,dataCb){for(let arg of args){if(isMatrix(arg)){const lenRow=arg.length;const lenCol=arg[0].length;for(let y=0;y<lenCol;y++){for(let x=0;x<lenRow;x++){cellCb(arg[x][y]);}}}
else{dataCb(arg);}}}
function visitAny(args,cb){visitArgs(args,cb,cb);}
function visitNumbers(args,cb,locale){visitArgs(args,(cellValue)=>{if(typeof cellValue==="number"){cb(cellValue);}},(argValue)=>{cb(strictToNumber(argValue,locale));});}
function reduceArgs(args,cellCb,dataCb,initialValue,dir="rowFirst"){let val=initialValue;for(let arg of args){if(isMatrix(arg)){const numberOfCols=arg.length;const numberOfRows=arg[0].length;if(dir==="rowFirst"){for(let row=0;row<numberOfRows;row++){for(let col=0;col<numberOfCols;col++){val=cellCb(val,arg[col][row]);}}}
else{for(let col=0;col<numberOfCols;col++){for(let row=0;row<numberOfRows;row++){val=cellCb(val,arg[col][row]);}}}}
else{val=dataCb(val,arg);}}
return val;}
function reduceAny(args,cb,initialValue,dir="rowFirst"){return reduceArgs(args,cb,cb,initialValue,dir);}
function reduceNumbers(args,cb,initialValue,locale){return reduceArgs(args,(acc,ArgValue)=>{if(typeof ArgValue==="number"){return cb(acc,ArgValue);}
return acc;},(acc,argValue)=>{return cb(acc,strictToNumber(argValue,locale));},initialValue);}
function reduceNumbersTextAs0(args,cb,initialValue,locale){return reduceArgs(args,(acc,ArgValue)=>{if(ArgValue!==undefined&&ArgValue!==null){if(typeof ArgValue==="number"){return cb(acc,ArgValue);}
else if(typeof ArgValue==="boolean"){return cb(acc,toNumber(ArgValue,locale));}
else{return cb(acc,0);}}
return acc;},(acc,argValue)=>{return cb(acc,toNumber(argValue,locale));},initialValue);}
function generateMatrix(nColumns,nRows,callback){const returned=Array(nColumns);for(let col=0;col<nColumns;col++){returned[col]=Array(nRows);for(let row=0;row<nRows;row++){returned[col][row]=callback(col,row);}}
return returned;}
function matrixMap(matrix,fn){if(matrix.length===0){return[];}
return generateMatrix(matrix.length,matrix[0].length,(col,row)=>fn(matrix[col][row]));}
function transposeMatrix(matrix){if(!matrix.length){return[];}
return generateMatrix(matrix[0].length,matrix.length,(i,j)=>matrix[j][i]);}
function conditionalVisitArgs(args,cellCb,dataCb){for(let arg of args){if(isMatrix(arg)){const lenRow=arg.length;const lenCol=arg[0].length;for(let y=0;y<lenCol;y++){for(let x=0;x<lenRow;x++){if(!cellCb(arg[x][y]??undefined))
return;}}}
else{if(!dataCb(arg))
return;}}}
function conditionalVisitBoolean(args,cb){return conditionalVisitArgs(args,(ArgValue)=>{if(typeof ArgValue==="boolean"){return cb(ArgValue);}
if(typeof ArgValue==="number"){return cb(ArgValue?true:false);}
return true;},(argValue)=>{if(argValue!==undefined&&argValue!==null){return cb(strictToBoolean(argValue));}
return true;});}
function getPredicate(descr,isQuery,locale){let operator;let operand;let subString=descr.substring(0,2);if(subString==="<="||subString===">="||subString==="<>"){operator=subString;operand=descr.substring(2);}
else{subString=descr.substring(0,1);if(subString==="<"||subString===">"||subString==="="){operator=subString;operand=descr.substring(1);}
else{operator="=";operand=descr;}}
if(isNumber(operand,locale)){operand=toNumber(operand,locale);}
else if(operand==="TRUE"||operand==="FALSE"){operand=toBoolean(operand);}
const result={operator,operand};if(typeof operand==="string"){if(isQuery){operand+="*";}
result.regexp=operandToRegExp(operand);}
return result;}
function operandToRegExp(operand){let exp="";let predecessor="";for(let char of operand){if(char==="?"&&predecessor!=="~"){exp+=".";}
else if(char==="*"&&predecessor!=="~"){exp+=".*";}
else{if(char==="*"||char==="?"){exp=exp.slice(0,-1);}
if(["^",".","[","]","$","(",")","*","+","?","|","{","}","\\"].includes(char)){exp+="\\";}
exp+=char;}
predecessor=char;}
return new RegExp("^"+exp+"$","i");}
function evaluatePredicate(value,criterion){const{operator,operand}=criterion;if(value===undefined||operand===undefined||value===null||operand===null){return false;}
if(typeof operand==="number"&&operator==="="){return toString(value)===toString(operand);}
if(operator==="<>"||operator==="="){let result;if(typeof value===typeof operand){if(typeof value==="string"&&criterion.regexp){result=criterion.regexp.test(value);}
else{result=value===operand;}}
else{result=false;}
return operator==="="?result:!result;}
if(typeof value===typeof operand){switch(operator){case"<":return value<operand;case">":return value>operand;case"<=":return value<=operand;case">=":return value>=operand;}}
return false;}
function visitMatchingRanges(args,cb,locale,isQuery=false){const countArg=args.length;if(countArg%2===1){throw new Error(_t("Function [[FUNCTION_NAME]] expects criteria_range and criterion to be in pairs."));}
const dimRow=args[0].length;const dimCol=args[0][0].length;let predicates=[];for(let i=0;i<countArg-1;i+=2){const criteriaRange=args[i];if(!isMatrix(criteriaRange)||criteriaRange.length!==dimRow||criteriaRange[0].length!==dimCol){throw new Error(_t("Function [[FUNCTION_NAME]] expects criteria_range to have the same dimension"));}
const description=toString(args[i+1]);predicates.push(getPredicate(description,isQuery,locale));}
for(let i=0;i<dimRow;i++){for(let j=0;j<dimCol;j++){let validatedPredicates=true;for(let k=0;k<countArg-1;k+=2){const criteriaValue=args[k][i][j];const criterion=predicates[k/2];validatedPredicates=evaluatePredicate(criteriaValue??undefined,criterion);if(!validatedPredicates){break;}}
if(validatedPredicates){cb(i,j);}}}}
function dichotomicSearch(data,target,mode,sortOrder,rangeLength,getValueInData){if(target===null||target===undefined){return-1;}
const _target=normalizeValue(target);const targetType=typeof _target;let matchVal=undefined;let matchValIndex=undefined;let indexLeft=0;let indexRight=rangeLength-1;let indexMedian;let currentIndex;let currentVal;let currentType;while(indexRight-indexLeft>=0){indexMedian=Math.floor((indexLeft+indexRight)/2);currentIndex=indexMedian;currentVal=normalizeValue(getValueInData(data,currentIndex));currentType=typeof currentVal;while(indexLeft<currentIndex&&targetType!==currentType){currentIndex--;currentVal=normalizeValue(getValueInData(data,currentIndex));currentType=typeof currentVal;}
if(currentType!==targetType||currentVal===undefined||currentVal===null){indexLeft=indexMedian+1;continue;}
if(mode==="strict"&&currentVal===_target){matchVal=currentVal;matchValIndex=currentIndex;}
else if(mode==="nextSmaller"&&currentVal<=_target){if(matchVal===undefined||matchVal===null||matchVal<currentVal||(matchVal===currentVal&&sortOrder==="asc"&&matchValIndex<currentIndex)||(matchVal===currentVal&&sortOrder==="desc"&&matchValIndex>currentIndex)){matchVal=currentVal;matchValIndex=currentIndex;}}
else if(mode==="nextGreater"&&currentVal>=_target){if(matchVal===undefined||matchVal>currentVal||(matchVal===currentVal&&sortOrder==="asc"&&matchValIndex<currentIndex)||(matchVal===currentVal&&sortOrder==="desc"&&matchValIndex>currentIndex)){matchVal=currentVal;matchValIndex=currentIndex;}}
if((sortOrder==="asc"&&currentVal>_target)||(sortOrder==="desc"&&currentVal<=_target)){indexRight=currentIndex-1;}
else{indexLeft=indexMedian+1;}}
return matchValIndex!==undefined?matchValIndex:-1;}
function linearSearch(data,target,mode,numberOfValues,getValueInData,reverseSearch=false){if(target===null||target===undefined)
return-1;const _target=normalizeValue(target);const getValue=reverseSearch?(data,i)=>getValueInData(data,numberOfValues-i-1):getValueInData;let closestMatch=undefined;let closestMatchIndex=-1;for(let i=0;i<numberOfValues;i++){const value=normalizeValue(getValue(data,i));if(value===_target){return reverseSearch?numberOfValues-i-1:i;}
if(mode==="nextSmaller"){if((!closestMatch&&compareCellValues(_target,value)>=0)||(compareCellValues(_target,value)>=0&&compareCellValues(value,closestMatch)>0)){closestMatch=value;closestMatchIndex=i;}}
else if(mode==="nextGreater"){if((!closestMatch&&compareCellValues(_target,value)<=0)||(compareCellValues(_target,value)<=0&&compareCellValues(value,closestMatch)<0)){closestMatch=value;closestMatchIndex=i;}}}
return reverseSearch?numberOfValues-closestMatchIndex-1:closestMatchIndex;}
function normalizeValue(value){return typeof value==="string"?normalizeString(value):value;}
function compareCellValues(left,right){let typeOrder=SORT_TYPES_ORDER.indexOf(typeof left)-SORT_TYPES_ORDER.indexOf(typeof right);if(typeOrder===0){if(typeof left==="string"&&typeof right==="string"){typeOrder=left.localeCompare(right);}
else if(typeof left==="number"&&typeof right==="number"){typeOrder=left-right;}
else if(typeof left==="boolean"&&typeof right==="boolean"){typeOrder=Number(left)-Number(right);}}
return typeOrder;}
function toMatrix(data){if(data===undefined){return[[]];}
return isMatrix(data)?data:[[data]];}
function flattenRowFirst(items,callback){return reduceAny(items,(array,val)=>{array.push(callback(val));return array;},[],"rowFirst");}
function toCriterionDateNumber(dateValue){const today=DateTime.now();switch(dateValue){case"today":return jsDateToNumber(today);case"yesterday":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()-1)));case"tomorrow":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()+1)));case"lastWeek":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()-7)));case"lastMonth":return jsDateToNumber(DateTime.fromTimestamp(today.setMonth(today.getMonth()-1)));case"lastYear":return jsDateToNumber(DateTime.fromTimestamp(today.setFullYear(today.getFullYear()-1)));}}
function getDateNumberCriterionValues(criterion,locale){if("dateValue"in criterion&&criterion.dateValue!=="exactDate"){return[toCriterionDateNumber(criterion.dateValue)];}
return criterion.values.map((value)=>valueToDateNumber(value,locale));}
function getCriterionValuesAsNumber(criterion,locale){return criterion.values.map((value)=>tryToNumber(value,locale));}
const MAX_DELAY=140;const MIN_DELAY=20;const ACCELERATION=0.035;function scrollDelay(value){return MIN_DELAY+(MAX_DELAY-MIN_DELAY)*Math.exp(-ACCELERATION*(value-1));}
const MAX_DECIMAL_PLACES=20;const DEFAULT_FORMAT_NUMBER_OF_DIGITS=11;const thousandsGroupsRegexp=/(\d+?)(?=(\d{3})+(?!\d)|$)/g;const zeroRegexp=/0/g;const MONTHS={0:_t("January"),1:_t("February"),2:_t("March"),3:_t("April"),4:_t("May"),5:_t("June"),6:_t("July"),7:_t("August"),8:_t("September"),9:_t("October"),10:_t("November"),11:_t("December"),};const DAYS$1={0:_t("Sunday"),1:_t("Monday"),2:_t("Tuesday"),3:_t("Wednesday"),4:_t("Thursday"),5:_t("Friday"),6:_t("Saturday"),};const internalFormatByFormatString={};function parseFormat(formatString){let internalFormat=internalFormatByFormatString[formatString];if(internalFormat===undefined){internalFormat=convertFormatToInternalFormat(formatString);internalFormatByFormatString[formatString]=internalFormat;}
return internalFormat;}
function formatValue(value,{format,locale}){switch(typeof value){case"string":if(value.includes('\\"')){return value.replace(/\\"/g,'"');}
return value;case"boolean":return value?"TRUE":"FALSE";case"number":if(!format){format=createDefaultFormat(value);}
const internalFormat=parseFormat(format);return applyInternalFormat(value,internalFormat,locale);case"object":return"0";}}
function applyInternalFormat(value,internalFormat,locale){if(internalFormat[0].type==="DATE"){return applyDateTimeFormat(value,internalFormat[0].format);}
let formattedValue=value<0?"-":"";for(let part of internalFormat){switch(part.type){case"NUMBER":formattedValue+=applyInternalNumberFormat(Math.abs(value),part.format,locale);break;case"STRING":formattedValue+=part.format;break;}}
return formattedValue;}
function applyInternalNumberFormat(value,format,locale){if(format.isPercent){value=value*100;}
value=value/format.magnitude;let maxDecimals=0;if(format.decimalPart!==undefined){maxDecimals=format.decimalPart.length;}
const{integerDigits,decimalDigits}=splitNumber(value,maxDecimals);let formattedValue=applyIntegerFormat(integerDigits,format.integerPart,format.thousandsSeparator?locale.thousandsSeparator:undefined);if(format.decimalPart!==undefined){formattedValue+=locale.decimalSeparator+applyDecimalFormat(decimalDigits||"",format.decimalPart);}
if(format.isPercent){formattedValue+="%";}
return formattedValue;}
function applyIntegerFormat(integerDigits,integerFormat,thousandsSeparator){const _integerDigits=integerDigits==="0"?"":integerDigits;let formattedInteger=_integerDigits;const delta=integerFormat.length-_integerDigits.length;if(delta>0){const restIntegerFormat=integerFormat.substring(0,delta);const countZero=(restIntegerFormat.match(zeroRegexp)||[]).length;formattedInteger="0".repeat(countZero)+formattedInteger;}
if(thousandsSeparator){formattedInteger=formattedInteger.match(thousandsGroupsRegexp)?.join(thousandsSeparator)||formattedInteger;}
return formattedInteger;}
function applyDecimalFormat(decimalDigits,decimalFormat){let formattedDecimals=decimalDigits;if(decimalFormat.length-decimalDigits.length>0){const restDecimalFormat=decimalFormat.substring(decimalDigits.length,decimalFormat.length+1);const countZero=(restDecimalFormat.match(zeroRegexp)||[]).length;formattedDecimals=formattedDecimals+"0".repeat(countZero);}
return formattedDecimals;}
const numberRepresentation=[];function splitNumber(value,maxDecimals=MAX_DECIMAL_PLACES){const asString=value.toString();if(asString.includes("e"))
return splitNumberIntl(value,maxDecimals);if(Number.isInteger(value)){return{integerDigits:asString,decimalDigits:undefined};}
const indexOfDot=asString.indexOf(".");let integerDigits=asString.substring(0,indexOfDot);let decimalDigits=asString.substring(indexOfDot+1);if(maxDecimals===0){if(Number(decimalDigits[0])>=5){integerDigits=(Number(integerDigits)+1).toString();}
return{integerDigits,decimalDigits:undefined};}
if(decimalDigits.length>maxDecimals){const{integerDigits:roundedIntegerDigits,decimalDigits:roundedDecimalDigits}=limitDecimalDigits(decimalDigits,maxDecimals);decimalDigits=roundedDecimalDigits;if(roundedIntegerDigits!=="0"){integerDigits=(Number(integerDigits)+Number(roundedIntegerDigits)).toString();}}
return{integerDigits,decimalDigits:removeTrailingZeroes(decimalDigits||"")};}
function removeTrailingZeroes(numberString){let i=numberString.length-1;while(i>=0&&numberString[i]==="0"){i--;}
return numberString.slice(0,i+1)||undefined;}
const leadingZeroesRegexp=/^0+/;function limitDecimalDigits(decimalDigits,maxDecimals){let integerDigits="0";let resultDecimalDigits=decimalDigits;let slicedDecimalDigits=decimalDigits.slice(0,maxDecimals);const i=maxDecimals;if(Number(decimalDigits[i])<5){return{integerDigits,decimalDigits:slicedDecimalDigits};}
const leadingZeroes=slicedDecimalDigits.match(leadingZeroesRegexp)?.[0]||"";const slicedRoundedUp=(Number(slicedDecimalDigits)+1).toString();const withoutLeadingZeroes=slicedDecimalDigits.slice(leadingZeroes.length);const carryOver=slicedRoundedUp.length>withoutLeadingZeroes.length;if(carryOver&&!leadingZeroes){integerDigits="1";resultDecimalDigits=undefined;}
else if(carryOver){resultDecimalDigits=leadingZeroes.slice(0,-1)+slicedRoundedUp;}
else{resultDecimalDigits=leadingZeroes+slicedRoundedUp;}
return{integerDigits,decimalDigits:resultDecimalDigits};}
function splitNumberIntl(value,maxDecimals=MAX_DECIMAL_PLACES){let formatter=numberRepresentation[maxDecimals];if(!formatter){formatter=new Intl.NumberFormat("en-US",{maximumFractionDigits:maxDecimals,useGrouping:false,});numberRepresentation[maxDecimals]=formatter;}
const[integerDigits,decimalDigits]=formatter.format(value).split(".");return{integerDigits,decimalDigits};}
function numberToString(number,decimalSeparator){const{integerDigits,decimalDigits}=splitNumber(number,20);return decimalDigits?integerDigits+decimalSeparator+decimalDigits:integerDigits;}
function isDateTimeFormat(format){if(!allowedDateTimeFormatFirstChar.has(format[0])){return false;}
try{applyDateTimeFormat(1,format);return true;}
catch(error){return false;}}
const allowedDateTimeFormatFirstChar=new Set(["h","m","y","d"]);function applyDateTimeFormat(value,format){const jsDate=numberToJsDate(value);const indexH=format.indexOf("h");let strDate="";let strTime="";if(indexH>0){strDate=formatJSDate(jsDate,format.substring(0,indexH-1));strTime=formatJSTime(jsDate,format.substring(indexH));}
else if(indexH===0){strTime=formatJSTime(jsDate,format);}
else if(indexH<0){strDate=formatJSDate(jsDate,format);}
return strDate+(strDate&&strTime?" ":"")+strTime;}
function formatJSDate(jsDate,format){const sep=format.match(/\/|-|\s/)?.[0];const parts=sep?format.split(sep):[format];return parts.map((p)=>{switch(p){case"d":return jsDate.getDate();case"dd":return jsDate.getDate().toString().padStart(2,"0");case"ddd":return DAYS$1[jsDate.getDay()].slice(0,3);case"dddd":return DAYS$1[jsDate.getDay()];case"m":return jsDate.getMonth()+1;case"mm":return String(jsDate.getMonth()+1).padStart(2,"0");case"mmm":return MONTHS[jsDate.getMonth()].slice(0,3);case"mmmm":return MONTHS[jsDate.getMonth()];case"mmmmm":return MONTHS[jsDate.getMonth()].slice(0,1);case"yy":const fullYear=String(jsDate.getFullYear()).replace("-","").padStart(2,"0");return fullYear.slice(fullYear.length-2);case"yyyy":return jsDate.getFullYear();default:throw new Error(`invalid format: ${format}`);}}).join(sep);}
function formatJSTime(jsDate,format){let parts=format.split(/:|\s/);const dateHours=jsDate.getHours();const isMeridian=parts[parts.length-1]==="a";let hours=dateHours;let meridian="";if(isMeridian){hours=hours===0?12:hours>12?hours-12:hours;meridian=dateHours>=12?" PM":" AM";parts.pop();}
return(parts.map((p)=>{switch(p){case"hhhh":const helapsedHours=Math.floor((jsDate.getTime()-INITIAL_1900_DAY.getTime())/(60*60*1000));return helapsedHours.toString();case"hh":return hours.toString().padStart(2,"0");case"mm":return jsDate.getMinutes().toString().padStart(2,"0");case"ss":return jsDate.getSeconds().toString().padStart(2,"0");default:throw new Error(`invalid format: ${format}`);}}).join(":")+meridian);}
const getDecimalNumberRegex=memoize(function getDecimalNumberRegex(locale){return new RegExp(`[0-9]+${escapeRegExp(locale.decimalSeparator)}[0-9]`);});function createDefaultFormat(value){let{integerDigits,decimalDigits}=splitNumber(value);if(!decimalDigits)
return"0";const digitsInIntegerPart=integerDigits.replace("-","").length;if(digitsInIntegerPart+2>DEFAULT_FORMAT_NUMBER_OF_DIGITS){return"0";}
const spaceForDecimalsDigits=DEFAULT_FORMAT_NUMBER_OF_DIGITS-digitsInIntegerPart-1;({decimalDigits}=splitNumber(value,Math.min(spaceForDecimalsDigits,decimalDigits.length)));return decimalDigits?"0."+"0".repeat(decimalDigits.length):"0";}
function detectDateFormat(content,locale){if(!isDateTime(content,locale)){return undefined;}
const internalDate=parseDateTime(content,locale);return internalDate.format;}
function detectNumberFormat(content){if(!isNumber(content,DEFAULT_LOCALE)){return undefined;}
const digitBase=content.includes(".")?"0.00":"0";const matchedCurrencies=content.match(/[\$€]/);if(matchedCurrencies){const matchedFirstDigit=content.match(/[\d]/);const currency="[$"+matchedCurrencies.values().next().value+"]";if(matchedFirstDigit.index<matchedCurrencies.index){return"#,##"+digitBase+currency;}
return currency+"#,##"+digitBase;}
if(content.includes("%")){return digitBase+"%";}
return undefined;}
function createCurrencyFormat(currency){const decimalPlaces=currency.decimalPlaces??2;const position=currency.position??"before";const code=currency.code??"";const symbol=currency.symbol??"";const decimalRepresentation=decimalPlaces?"."+"0".repeat(decimalPlaces):"";const numberFormat="#,##0"+decimalRepresentation;let textExpression=`${code} ${symbol}`.trim();if(position==="after"&&code){textExpression=" "+textExpression;}
return insertTextInFormat(textExpression,position,numberFormat);}
function insertTextInFormat(text,position,format){const textExpression=`[$${text}]`;return position==="before"?textExpression+format:format+textExpression;}
function roundFormat(format){const internalFormat=parseFormat(format);const roundedFormat=internalFormat.map((formatPart)=>{if(formatPart.type==="NUMBER"){return{type:formatPart.type,format:{...formatPart.format,decimalPart:undefined,},};}
return formatPart;});return convertInternalFormatToFormat(roundedFormat);}
function createLargeNumberFormat(format,magnitude,postFix,locale){const internalFormat=parseFormat(format||"#,##0");const largeNumberFormat=[];for(let i=0;i<internalFormat.length;i++){const formatPart=internalFormat[i];if(formatPart.type!=="NUMBER"){largeNumberFormat.push(formatPart);continue;}
largeNumberFormat.push({...formatPart,format:{...formatPart.format,magnitude,decimalPart:undefined,},});largeNumberFormat.push({type:"STRING",format:postFix,});const nextFormatPart=internalFormat[i+1];if(nextFormatPart?.type==="STRING"&&["k","m","b"].includes(nextFormatPart.format)){i++;}}
return convertInternalFormatToFormat(largeNumberFormat);}
function changeDecimalPlaces(format,step,locale){const internalFormat=parseFormat(format);const newInternalFormat=internalFormat.map((intFmt)=>{if(intFmt.type==="NUMBER"){return{...intFmt,format:changeInternalNumberFormatDecimalPlaces(intFmt.format,step)};}
else{return intFmt;}});const newFormat=convertInternalFormatToFormat(newInternalFormat);internalFormatByFormatString[newFormat]=newInternalFormat;return newFormat;}
function changeInternalNumberFormatDecimalPlaces(format,step){const _format={...format};const sign=Math.sign(step);const decimalLength=_format.decimalPart?.length||0;const countZero=Math.min(Math.max(0,decimalLength+sign),MAX_DECIMAL_PLACES);_format.decimalPart="0".repeat(countZero);if(_format.decimalPart===""){delete _format.decimalPart;}
return _format;}
function convertFormatToInternalFormat(format){if(format===""){throw new Error("A format cannot be empty");}
let currentIndex=0;let result=[];while(currentIndex<format.length){let closingIndex;if(format.charAt(currentIndex)==="["){if(format.charAt(currentIndex+1)!=="$"){throw new Error(`Currency formats have to be prefixed by a $: ${format}`);}
closingIndex=format.substring(currentIndex+1).indexOf("]")+currentIndex+2;if(closingIndex===0){throw new Error(`Invalid currency brackets format: ${format}`);}
const str=format.substring(currentIndex+2,closingIndex-1);if(str.includes("[")){throw new Error(`Invalid currency format: ${format}`);}
result.push({type:"STRING",format:str,});}
else{const nextPartIndex=format.substring(currentIndex).indexOf("[");closingIndex=nextPartIndex>-1?nextPartIndex+currentIndex:format.length;const subFormat=format.substring(currentIndex,closingIndex);if(isDateTimeFormat(subFormat)){result.push({type:"DATE",format:subFormat});}
else{result.push({type:"NUMBER",format:convertToInternalNumberFormat(subFormat),});}}
currentIndex=closingIndex;}
return result;}
const magnitudeRegex=/,*?$/;function convertToInternalNumberFormat(format){format=format.trim();if(containsInvalidNumberChars(format)){throw new Error(`Invalid number format: ${format}`);}
const isPercent=format.includes("%");const magnitudeCommas=format.match(magnitudeRegex)?.[0]||"";const magnitude=!magnitudeCommas?1:1000**magnitudeCommas.length;let _format=format.slice(0,format.length-(magnitudeCommas.length||0));const thousandsSeparator=_format.includes(",");if(/\..*,/.test(_format)){throw new Error("A format can't contain ',' symbol in the decimal part");}
_format=_format.replace("%","").replace(",","");const extraSigns=_format.match(/[\%|,]/);if(extraSigns){throw new Error(`A format can only contain a single '${extraSigns[0]}' symbol`);}
const[integerPart,decimalPart]=_format.split(".");if(decimalPart&&decimalPart.length>20){throw new Error("A format can't contain more than 20 decimal places");}
if(decimalPart!==undefined){return{integerPart,isPercent,thousandsSeparator,decimalPart,magnitude,};}
else{return{integerPart,isPercent,thousandsSeparator,magnitude,};}}
const validNumberChars=/[,#0.%]/g;function containsInvalidNumberChars(format){return Boolean(format.replace(validNumberChars,""));}
function convertInternalFormatToFormat(internalFormat){let format="";for(let part of internalFormat){let currentFormat;switch(part.type){case"NUMBER":const fmt=part.format;currentFormat=fmt.integerPart;if(fmt.thousandsSeparator){currentFormat=currentFormat.slice(0,-3)+","+currentFormat.slice(-3);}
if(fmt.decimalPart!==undefined){currentFormat+="."+fmt.decimalPart;}
if(fmt.isPercent){currentFormat+="%";}
if(fmt.magnitude){currentFormat+=",".repeat(Math.log10(fmt.magnitude)/3);}
break;case"STRING":currentFormat=`[$${part.format}]`;break;case"DATE":currentFormat=part.format;break;}
format+=currentFormat;}
return format;}
const cellReference=new RegExp(/\$?([A-Z]{1,3})\$?([0-9]{1,7})/,"i");const singleCellReference=new RegExp(/^\$?([A-Z]{1,3})\$?([0-9]{1,7})$/,"i");const colHeader=new RegExp(/^\$?([A-Z]{1,3})+$/,"i");const rowHeader=new RegExp(/^\$?([0-9]{1,7})+$/,"i");const colReference=new RegExp(/^\s*('.+'!|[^']+!)?\$?([A-Z]{1,3})$/,"i");const rowReference=new RegExp(/^\s*('.+'!|[^']+!)?\$?([0-9]{1,7})$/,"i");const fullRowXc=/(\$?[A-Z]{1,3})?\$?[0-9]{1,7}\s*:\s*(\$?[A-Z]{1,3})?\$?[0-9]{1,7}\s*/i;const fullColXc=/\$?[A-Z]{1,3}(\$?[0-9]{1,7})?\s*:\s*\$?[A-Z]{1,3}(\$?[0-9]{1,7})?\s*/i;const rangeReference=new RegExp(/^\s*('.+'!|[^']+!)?/.source+"("+
[cellReference.source,fullRowXc.source,fullColXc.source].join("|")+")"+/$/.source,"i");function isColReference(xc){return colReference.test(xc);}
function isRowReference(xc){return rowReference.test(xc);}
function isColHeader(str){return colHeader.test(str);}
function isRowHeader(str){return rowHeader.test(str);}
function isSingleCellReference(xc){return singleCellReference.test(xc);}
function splitReference(ref){const parts=ref.split("!");const xc=parts.pop();const sheetName=getUnquotedSheetName(parts.join("!"))||undefined;return{sheetName,xc};}
function toZoneWithoutBoundaryChanges(xc){if(xc.includes("!")){xc=xc.split("!").at(-1);}
if(xc.includes("$")){xc=xc.replace(/\$/g,"");}
let ranges;if(xc.includes(":")){ranges=xc.split(":").map((x)=>x.trim());}
else{ranges=[xc.trim()];}
let top,bottom,left,right;let fullCol=false;let fullRow=false;let hasHeader=false;const firstRangePart=ranges[0];const secondRangePart=ranges[1]&&ranges[1];if(isColReference(firstRangePart)){left=right=lettersToNumber(firstRangePart);top=bottom=0;fullCol=true;}
else if(isRowReference(firstRangePart)){top=bottom=parseInt(firstRangePart,10)-1;left=right=0;fullRow=true;}
else{const c=toCartesian(firstRangePart);left=right=c.col;top=bottom=c.row;hasHeader=true;}
if(ranges.length===2){if(isColReference(secondRangePart)){right=lettersToNumber(secondRangePart);fullCol=true;}
else if(isRowReference(secondRangePart)){bottom=parseInt(secondRangePart,10)-1;fullRow=true;}
else{const c=toCartesian(secondRangePart);right=c.col;bottom=c.row;top=fullCol?bottom:top;left=fullRow?right:left;hasHeader=true;}}
if(fullCol&&fullRow){throw new Error("Wrong zone xc. The zone cannot be at the same time a full column and a full row");}
const zone={top,left,bottom:fullCol?undefined:bottom,right:fullRow?undefined:right,};hasHeader=hasHeader&&(fullRow||fullCol);if(hasHeader){zone.hasHeader=hasHeader;}
return zone;}
function toUnboundedZone(xc){const zone=toZoneWithoutBoundaryChanges(xc);if(zone.right!==undefined&&zone.right<zone.left){const tmp=zone.left;zone.left=zone.right;zone.right=tmp;}
if(zone.bottom!==undefined&&zone.bottom<zone.top){const tmp=zone.top;zone.top=zone.bottom;zone.bottom=tmp;}
return zone;}
function toZone(xc){const zone=toUnboundedZone(xc);if(zone.bottom===undefined||zone.right===undefined){throw new Error("This does not support unbounded ranges");}
return zone;}
function isZoneValid(zone){const{bottom,top,left,right}=zone;if((bottom!==undefined&&isNaN(bottom))||isNaN(top)||isNaN(left)||(right!==undefined&&isNaN(right))){return false;}
return isZoneOrdered(zone)&&zone.top>=0&&zone.left>=0;}
function isZoneOrdered(zone){return((zone.bottom===undefined||(zone.bottom>=zone.top&&zone.bottom>=0))&&(zone.right===undefined||(zone.right>=zone.left&&zone.right>=0)));}
function zoneToXc(zone){const{top,bottom,left,right}=zone;const hasHeader="hasHeader"in zone?zone.hasHeader:false;const isOneCell=top===bottom&&left===right;if(bottom===undefined&&right!==undefined){return top===0&&!hasHeader?`${numberToLetters(left)}:${numberToLetters(right)}`:`${toXC(left, top)}:${numberToLetters(right)}`;}
else if(right===undefined&&bottom!==undefined){return left===0&&!hasHeader?`${top + 1}:${bottom + 1}`:`${toXC(left, top)}:${bottom + 1}`;}
else if(bottom!==undefined&&right!==undefined){return isOneCell?toXC(left,top):`${toXC(left, top)}:${toXC(right, bottom)}`;}
throw new Error(_t("Bad zone format"));}
function expandZoneOnInsertion(zone,start,base,position,quantity){const dimension=start==="left"?"columns":"rows";const baseElement=position==="before"?base-1:base;const end=start==="left"?"right":"bottom";const zoneEnd=zone[end];if(zone[start]<=baseElement&&zoneEnd&&zoneEnd>baseElement){return createAdaptedZone(zone,dimension,"RESIZE",quantity);}
if(baseElement<zone[start]){return createAdaptedZone(zone,dimension,"MOVE",quantity);}
return{...zone};}
function updateSelectionOnInsertion(selection,start,base,position,quantity){const dimension=start==="left"?"columns":"rows";const baseElement=position==="before"?base-1:base;const end=start==="left"?"right":"bottom";if(selection[start]<=baseElement&&selection[end]>baseElement){return createAdaptedZone(selection,dimension,"RESIZE",quantity);}
if(baseElement<selection[start]){return createAdaptedZone(selection,dimension,"MOVE",quantity);}
return{...selection};}
function updateSelectionOnDeletion(zone,start,elements){const end=start==="left"?"right":"bottom";let newStart=zone[start];let newEnd=zone[end];for(let removedElement of elements.sort((a,b)=>b-a)){if(zone[start]>removedElement){newStart--;newEnd--;}
if(zone[start]<removedElement&&zone[end]>=removedElement){newEnd--;}}
return{...zone,[start]:newStart,[end]:newEnd};}
function reduceZoneOnDeletion(zone,start,elements){const end=start==="left"?"right":"bottom";let newStart=zone[start];let newEnd=zone[end];const zoneEnd=zone[end];for(let removedElement of elements.sort((a,b)=>b-a)){if(zone[start]>removedElement){newStart--;if(newEnd!==undefined)
newEnd--;}
if(zoneEnd!==undefined&&newEnd!==undefined&&zone[start]<=removedElement&&zoneEnd>=removedElement){newEnd--;}}
if(newEnd!==undefined&&newStart>newEnd){return undefined;}
return{...zone,[start]:newStart,[end]:newEnd};}
function union(...zones){return{top:Math.min(...zones.map((zone)=>zone.top)),left:Math.min(...zones.map((zone)=>zone.left)),bottom:Math.max(...zones.map((zone)=>zone.bottom)),right:Math.max(...zones.map((zone)=>zone.right)),};}
function intersection(z1,z2){if(!overlap(z1,z2)){return undefined;}
return{top:Math.max(z1.top,z2.top),left:Math.max(z1.left,z2.left),bottom:Math.min(z1.bottom,z2.bottom),right:Math.min(z1.right,z2.right),};}
function isEqual(z1,z2){return(z1.left===z2.left&&z1.right===z2.right&&z1.top===z2.top&&z1.bottom===z2.bottom);}
function overlap(z1,z2){if(z1.bottom<z2.top||z2.bottom<z1.top){return false;}
if(z1.right<z2.left||z2.right<z1.left){return false;}
return true;}
function isInside(col,row,zone){const{left,right,top,bottom}=zone;return col>=left&&col<=right&&row>=top&&row<=bottom;}
function isZoneInside(smallZone,biggerZone){return isEqual(union(biggerZone,smallZone),biggerZone);}
function recomputeZones(zonesXc,toRemoveZonesXc){const zones=zonesXc.map(toUnboundedZone);const zonesToRemove=toRemoveZonesXc.map(toUnboundedZone);const maxBottom=Math.max(...zones.concat(zonesToRemove).map((zone)=>zone.bottom||0));const maxRight=Math.max(...zones.concat(zonesToRemove).map((zone)=>zone.right||0));const expandedZones=zones.map((zone)=>({...zone,bottom:zone.bottom===undefined?maxBottom+1:zone.bottom,right:zone.right===undefined?maxRight+1:zone.right,}));const expandedZonesToRemove=zonesToRemove.map((zone)=>({...zone,bottom:zone.bottom===undefined?maxBottom+1:zone.bottom,right:zone.right===undefined?maxRight+1:zone.right,}));const zonePositions=expandedZones.map(positions).flat();const positionsToRemove=expandedZonesToRemove.map(positions).flat();const positionToKeep=positionsDifference(zonePositions,positionsToRemove);const columns=mergePositionsIntoColumns(positionToKeep);return mergeAlignedColumns(columns).map((zone)=>({...zone,bottom:zone.bottom===maxBottom+1?undefined:zone.bottom,right:zone.right===maxRight+1?undefined:zone.right,})).map(zoneToXc);}
function mergeAlignedColumns(columns){if(columns.length===0){return[];}
if(columns.some((zone)=>zone.left!==zone.right)){throw new Error("only columns can be merged");}
const done=[];const cols=removeRedundantZones(columns);const isAdjacentAndAligned=(zone,nextZone)=>zone.top===nextZone.top&&zone.bottom===nextZone.bottom&&zone.right+1===nextZone.left;while(cols.length){const merged=cols.reduce((zone,nextZone)=>(isAdjacentAndAligned(zone,nextZone)?union(zone,nextZone):zone),cols.shift());done.push(merged);}
return removeRedundantZones(done);}
function removeRedundantZones(zones){const sortedZones=[...zones].sort((a,b)=>b.right-a.right).sort((a,b)=>b.bottom-a.bottom).sort((a,b)=>a.top-b.top).sort((a,b)=>a.left-b.left).reverse();const checked=[];while(sortedZones.length!==0){const zone=sortedZones.shift();const isIncludedInOther=sortedZones.some((otherZone)=>isZoneInside(zone,otherZone));if(!isIncludedInOther){checked.push(zone);}}
return checked.reverse();}
function mergePositionsIntoColumns(positions){if(positions.length===0){return[];}
const[startingPosition,...sortedPositions]=[...positions].sort((a,b)=>a.row-b.row).sort((a,b)=>a.col-b.col);const done=[];let active=positionToZone(startingPosition);for(const{col,row}of sortedPositions){if(isInside(col,row,active)){continue;}
else if(col===active.left&&row===active.bottom+1){const bottom=active.bottom+1;active={...active,bottom};}
else{done.push(active);active=positionToZone({col,row});}}
return[...done,active];}
function positionsDifference(positions,toRemove){const forbidden=new Set(toRemove.map(({col,row})=>`${col}-${row}`));return positions.filter(({col,row})=>!forbidden.has(`${col}-${row}`));}
function zoneToDimension(zone){return{numberOfRows:zone.bottom-zone.top+1,numberOfCols:zone.right-zone.left+1,};}
function isOneDimensional(zone){const{numberOfCols,numberOfRows}=zoneToDimension(zone);return numberOfCols===1||numberOfRows===1;}
function positions(zone){const positions=[];const[left,right]=[zone.right,zone.left].sort((a,b)=>a-b);const[top,bottom]=[zone.top,zone.bottom].sort((a,b)=>a-b);for(const col of range(left,right+1)){for(const row of range(top,bottom+1)){positions.push({col,row});}}
return positions;}
function forEachPositionsInZone(zone,callback){const{left,right,top,bottom}=zone;for(let col=left;col<=right;col++){for(let row=top;row<=bottom;row++){callback(col,row);}}}
function createAdaptedZone(zone,dimension,operation,by){const offsetX=dimension==="both"?by[0]:dimension==="columns"?by:0;const offsetY=dimension==="both"?by[1]:dimension==="rows"?by:0;const hasHeader="hasHeader"in zone?zone.hasHeader:false;let shouldStartBeMoved;if(isFullCol(zone)&&!hasHeader){shouldStartBeMoved=dimension!=="rows";}
else if(isFullRow(zone)&&!hasHeader){shouldStartBeMoved=dimension!=="columns";}
else{shouldStartBeMoved=true;}
const newZone={...zone};if(shouldStartBeMoved&&operation==="MOVE"){newZone["left"]+=offsetX;newZone["top"]+=offsetY;}
if(newZone["right"]!==undefined){newZone["right"]+=offsetX;}
if(newZone["bottom"]!==undefined){newZone["bottom"]+=offsetY;}
return newZone;}
function uniqueZones(zones){return zones.reverse().filter((zone,index,self)=>index===self.findIndex((z)=>z.top===zone.top&&z.bottom===zone.bottom&&z.left===zone.left&&z.right===zone.right)).reverse();}
function mergeOverlappingZones(zones){return zones.reduce((dissociatedZones,zone)=>{const nextIndex=dissociatedZones.length;for(let i=0;i<nextIndex;i++){if(overlap(dissociatedZones[i],zone)){dissociatedZones[i]=union(dissociatedZones[i],zone);return dissociatedZones;}}
dissociatedZones[nextIndex]=zone;return dissociatedZones;},[]);}
function findCellInNewZone(oldZone,currentZone){let col,row;const{left:oldLeft,right:oldRight,top:oldTop,bottom:oldBottom}=oldZone;const{left,right,top,bottom}=currentZone;if(left!=oldLeft){col=left;}
else if(right!=oldRight){col=right;}
else{col=left;}
if(top!=oldTop){row=top;}
else if(bottom!=oldBottom){row=bottom;}
else{row=top;}
return{col,row};}
function organizeZone(zone){return{top:Math.min(zone.top,zone.bottom),bottom:Math.max(zone.top,zone.bottom),left:Math.min(zone.left,zone.right),right:Math.max(zone.left,zone.right),};}
function positionToZone(position){return{left:position.col,right:position.col,top:position.row,bottom:position.row};}
function isFullRow(zone){return zone.right===undefined;}
function isFullCol(zone){return zone.bottom===undefined;}
function getZoneArea(zone){return(zone.bottom-zone.top+1)*(zone.right-zone.left+1);}
function areZonesContinuous(...zones){if(zones.length<2)
return true;return recomputeZones(zones.map(zoneToXc),[]).length===1;}
function getZonesCols(zones){const set=new Set();for(let zone of zones){for(let col of range(zone.left,zone.right+1)){set.add(col);}}
return set;}
function getZonesRows(zones){const set=new Set();for(let zone of zones){for(let row of range(zone.top,zone.bottom+1)){set.add(row);}}
return set;}
class RangeImpl{getSheetSize;_zone;parts;invalidXc;prefixSheet=false;sheetId;invalidSheetName;constructor(args,getSheetSize){this.getSheetSize=getSheetSize;this._zone=args.zone;this.prefixSheet=args.prefixSheet;this.invalidXc=args.invalidXc;this.sheetId=args.sheetId;this.invalidSheetName=args.invalidSheetName;let _fixedParts=[...args.parts];if(args.parts.length===1&&getZoneArea(this.zone)>1){_fixedParts.push({...args.parts[0]});}
else if(args.parts.length===2&&getZoneArea(this.zone)===1){_fixedParts.pop();}
this.parts=_fixedParts;}
static fromRange(range,getters){if(range instanceof RangeImpl){return range;}
return new RangeImpl(range,getters.getSheetSize);}
get unboundedZone(){return this._zone;}
get zone(){const{left,top,bottom,right}=this._zone;if(right!==undefined&&bottom!==undefined){return this._zone;}
else if(bottom===undefined&&right!==undefined){return{right,top,left,bottom:this.getSheetSize(this.sheetId).numberOfRows-1};}
else if(right===undefined&&bottom!==undefined){return{bottom,left,top,right:this.getSheetSize(this.sheetId).numberOfCols-1};}
throw new Error(_t("Bad zone format"));}
static getRangeParts(xc,zone){const parts=xc.split(":").map((p)=>{const isFullRow=isRowReference(p);return{colFixed:isFullRow?false:p.startsWith("$"),rowFixed:isFullRow?p.startsWith("$"):p.includes("$",1),};});const isFullCol=zone.bottom===undefined;const isFullRow=zone.right===undefined;if(isFullCol){parts[0].rowFixed=parts[0].rowFixed||parts[1].rowFixed;parts[1].rowFixed=parts[0].rowFixed||parts[1].rowFixed;}
if(isFullRow){parts[0].colFixed=parts[0].colFixed||parts[1].colFixed;parts[1].colFixed=parts[0].colFixed||parts[1].colFixed;}
return parts;}
get isFullCol(){return this._zone.bottom===undefined;}
get isFullRow(){return this._zone.right===undefined;}
get rangeData(){return{_zone:this._zone,_sheetId:this.sheetId,};}
orderZone(){if(isZoneOrdered(this._zone)){return this;}
const zone={...this._zone};let parts=this.parts;if(zone.right!==undefined&&zone.right<zone.left){let right=zone.right;zone.right=zone.left;zone.left=right;parts=[{colFixed:parts[1]?.colFixed||false,rowFixed:parts[0]?.rowFixed||false,},{colFixed:parts[0]?.colFixed||false,rowFixed:parts[1]?.rowFixed||false,},];}
if(zone.bottom!==undefined&&zone.bottom<zone.top){let bottom=zone.bottom;zone.bottom=zone.top;zone.top=bottom;parts=[{colFixed:parts[0]?.colFixed||false,rowFixed:parts[1]?.rowFixed||false,},{colFixed:parts[1]?.colFixed||false,rowFixed:parts[0]?.rowFixed||false,},];}
return this.clone({zone,parts});}
clone(rangeParams){return new RangeImpl({zone:rangeParams?.zone?rangeParams.zone:{...this._zone},sheetId:rangeParams?.sheetId?rangeParams.sheetId:this.sheetId,invalidSheetName:rangeParams&&"invalidSheetName"in rangeParams?rangeParams.invalidSheetName:this.invalidSheetName,invalidXc:rangeParams&&"invalidXc"in rangeParams?rangeParams.invalidXc:this.invalidXc,parts:rangeParams?.parts?rangeParams.parts:this.parts.map((part)=>{return{rowFixed:part.rowFixed,colFixed:part.colFixed};}),prefixSheet:rangeParams?.prefixSheet?rangeParams.prefixSheet:this.prefixSheet,},this.getSheetSize);}}
function copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range){const sheetId=range.sheetId===sheetIdFrom?sheetIdTo:range.sheetId;return range.clone({sheetId});}
function createRange(getters,sheetId,range){return range?getters.getRangeFromSheetXC(sheetId,range):undefined;}
function spreadRange(getters,ranges){const postProcessedRanges=[];for(const range of ranges){if(!getters.isRangeValid(range)){postProcessedRanges.push(range);continue;}
const{sheetName}=splitReference(range);const sheetPrefix=sheetName?`${sheetName}!`:"";const zone=toUnboundedZone(range);if(zone.bottom!==zone.top&&zone.left!=zone.right){if(zone.right){for(let j=zone.left;j<=zone.right;++j){postProcessedRanges.push(`${sheetPrefix}${zoneToXc({
                        left: j,
                        right: j,
                        top: zone.top,
                        bottom: zone.bottom,
                    })}`);}}
else{for(let j=zone.top;j<=zone.bottom;++j){postProcessedRanges.push(`${sheetPrefix}${zoneToXc({
                        left: zone.left,
                        right: zone.right,
                        top: j,
                        bottom: j,
                    })}`);}}}
else{postProcessedRanges.push(range);}}
return postProcessedRanges;}
function getCellPositionsInRanges(ranges){const cellPositions=[];for(const range of ranges){for(const position of positions(range.zone)){cellPositions.push({...position,sheetId:range.sheetId});}}
return cellPositions;}
function fuzzyMatch(pattern,str){pattern=pattern.toLocaleLowerCase();str=str.toLocaleLowerCase();let totalScore=0;let currentScore=0;let len=str.length;let patternIndex=0;for(let i=0;i<len;i++){if(str[i]===pattern[patternIndex]){patternIndex++;currentScore+=100+currentScore-i/200;}
else{currentScore=0;}
totalScore=totalScore+currentScore;}
return patternIndex===pattern.length?totalScore:0;}
function fuzzyLookup(pattern,list,fn){const results=[];list.forEach((data)=>{const score=fuzzyMatch(pattern,fn(data));if(score>0){results.push({score,elem:data});}});results.sort((a,b)=>b.score-a.score);return results.map((r)=>r.elem);}
function createDefaultRows(rowNumber){const rows=[];for(let i=0;i<rowNumber;i++){const row={cells:{},};rows.push(row);}
return rows;}
function moveHeaderIndexesOnHeaderAddition(indexHeaderAdded,numberAdded,headers){return headers.map((header)=>{if(header>=indexHeaderAdded){return header+numberAdded;}
return header;});}
function moveHeaderIndexesOnHeaderDeletion(deletedHeaders,headers){deletedHeaders=[...deletedHeaders].sort((a,b)=>b-a);return headers.map((header)=>{for(const deletedHeader of deletedHeaders){if(header>deletedHeader){header--;}
else if(header===deletedHeader){return undefined;}}
return header;}).filter(isDefined$1);}
function computeTextLinesHeight(textLineHeight,numberOfLines=1){return numberOfLines*(textLineHeight+MIN_CELL_TEXT_MARGIN)-MIN_CELL_TEXT_MARGIN;}
function getDefaultCellHeight(ctx,cell,colSize){if(!cell||(!cell.isFormula&&!cell.content)){return DEFAULT_CELL_HEIGHT;}
const maxWidth=cell.style?.wrapping==="wrap"?colSize-2*MIN_CELL_TEXT_MARGIN:undefined;const numberOfLines=cell.isFormula?1:splitTextToWidth(ctx,cell.content,cell.style,maxWidth).length;const fontSize=computeTextFontSizeInPixels(cell.style);return computeTextLinesHeight(fontSize,numberOfLines)+2*PADDING_AUTORESIZE_VERTICAL;}
const textWidthCache={};function computeTextWidth(context,text,style){const font=computeTextFont(style);if(!textWidthCache[font]){textWidthCache[font]={};}
if(textWidthCache[font][text]===undefined){context.save();context.font=font;const textWidth=context.measureText(text).width;context.restore();textWidthCache[font][text]=textWidth;}
return textWidthCache[font][text];}
function fontSizeInPixels(fontSize){return Math.round((fontSize*96)/72);}
function computeTextFont(style){const italic=style.italic?"italic ":"";const weight=style.bold?"bold":DEFAULT_FONT_WEIGHT;const size=computeTextFontSizeInPixels(style);return`${italic}${weight} ${size}px ${DEFAULT_FONT}`;}
function computeTextFontSizeInPixels(style){const sizeInPt=style?.fontSize||DEFAULT_FONT_SIZE;return fontSizeInPixels(sizeInPt);}
function splitWordToSpecificWidth(ctx,word,width,style){const wordWidth=computeTextWidth(ctx,word,style);if(wordWidth<=width){return[word];}
const splitWord=[];let wordPart="";for(let l of word){const wordPartWidth=computeTextWidth(ctx,wordPart+l,style);if(wordPartWidth>width){splitWord.push(wordPart);wordPart=l;}
else{wordPart+=l;}}
splitWord.push(wordPart);return splitWord;}
function splitTextToWidth(ctx,text,style,width){if(!style)
style={};const brokenText=[];const lines=text.includes(NEWLINE)?text.split(NEWLINE):[text];for(const line of lines){const words=line.includes(" ")?line.split(" "):[line];if(!width){brokenText.push(line);continue;}
let textLine="";let availableWidth=width;for(let word of words){const splitWord=splitWordToSpecificWidth(ctx,word,width,style);const lastPart=splitWord.pop();const lastPartWidth=computeTextWidth(ctx,lastPart,style);if(splitWord.length){if(textLine!==""){brokenText.push(textLine);textLine="";availableWidth=width;}
splitWord.forEach((wordPart)=>{brokenText.push(wordPart);});textLine=lastPart;availableWidth=width-lastPartWidth;}
else{const _word=textLine===""?lastPart:" "+lastPart;const wordWidth=computeTextWidth(ctx,_word,style);if(wordWidth<=availableWidth){textLine+=_word;availableWidth-=wordWidth;}
else{brokenText.push(textLine);textLine=lastPart;availableWidth=width-lastPartWidth;}}}
if(textLine!==""){brokenText.push(textLine);}}
return brokenText;}
function getFontSizeMatchingWidth(lineWidth,maxFontSize,getTextWidth,precision=0.25){let minFontSize=1;if(getTextWidth(minFontSize)>lineWidth)
return minFontSize;if(getTextWidth(maxFontSize)<lineWidth)
return maxFontSize;let fontSize=(minFontSize+maxFontSize)/2;let currentTextWidth=getTextWidth(fontSize);let iterations=0;while(Math.abs(currentTextWidth-lineWidth)>precision&&iterations<20){if(currentTextWidth>=lineWidth){maxFontSize=(minFontSize+maxFontSize)/2;}
else{minFontSize=(minFontSize+maxFontSize)/2;}
fontSize=(minFontSize+maxFontSize)/2;currentTextWidth=getTextWidth(fontSize);iterations++;}
return fontSize;}
function computeIconWidth(style){return computeTextFontSizeInPixels(style)+2*MIN_CF_ICON_MARGIN;}
function toLowerCase(str){return str?str.toLowerCase():"";}
const pxRegex=/([0-9\.]*)px/;function getContextFontSize(font){return Number(font.match(pxRegex)?.[1]);}
function drawDecoratedText(context,text,position,underline=false,strikethrough=false,strokeWidth=getContextFontSize(context.font)/10){context.fillText(text,position.x,position.y);if(!underline&&!strikethrough){return;}
const measure=context.measureText(text);const textWidth=measure.width;const textHeight=measure.actualBoundingBoxAscent+measure.actualBoundingBoxDescent;const boxHeight=measure.fontBoundingBoxAscent+measure.fontBoundingBoxDescent;let{x,y}=position;let strikeY=y,underlineY=y;switch(context.textAlign){case"center":x-=textWidth/2;break;case"right":x-=textWidth;break;}
switch(context.textBaseline){case"top":underlineY+=boxHeight-2*strokeWidth;strikeY+=boxHeight/2-strokeWidth;break;case"middle":underlineY+=boxHeight/2-strokeWidth;break;case"alphabetic":underlineY+=2*strokeWidth;strikeY-=3*strokeWidth;break;case"bottom":underlineY=y;strikeY-=textHeight/2-strokeWidth/2;break;}
if(underline){context.lineWidth=strokeWidth;context.strokeStyle=context.fillStyle;context.beginPath();context.moveTo(x,underlineY);context.lineTo(x+textWidth,underlineY);context.stroke();}
if(strikethrough){context.lineWidth=strokeWidth;context.strokeStyle=context.fillStyle;context.beginPath();context.moveTo(x,strikeY);context.lineTo(x+textWidth,strikeY);context.stroke();}}
class UuidGenerator{isFastIdStrategy=false;fastIdStart=0;setIsFastStrategy(isFast){this.isFastIdStrategy=isFast;}
uuidv4(){if(this.isFastIdStrategy){this.fastIdStart++;return String(this.fastIdStart);}
else if(window.crypto&&window.crypto.getRandomValues){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(c)=>(c^(crypto.getRandomValues(new Uint8Array(1))[0]&(15>>(c/4)))).toString(16));}
else{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(Math.random()*16)|0,v=c==="x"?r:(r&0x3)|0x8;return v.toString(16);});}}}
function createActions(menuItems){return menuItems.map(createAction).sort((a,b)=>a.sequence-b.sequence);}
const uuidGenerator$2=new UuidGenerator();function createAction(item){const name=item.name;const children=item.children;const description=item.description;const icon=item.icon;return{id:item.id||uuidGenerator$2.uuidv4(),name:typeof name==="function"?name:()=>name,isVisible:item.isVisible?item.isVisible:()=>true,isEnabled:item.isEnabled?item.isEnabled:()=>true,isActive:item.isActive,execute:item.execute,children:children?(env)=>{return children.map((child)=>(typeof child==="function"?child(env):child)).flat().map(createAction);}:()=>[],isReadonlyAllowed:item.isReadonlyAllowed||false,separator:item.separator||false,icon:typeof icon==="function"?icon:()=>icon||"",description:typeof description==="function"?description:()=>description||"",textColor:item.textColor,sequence:item.sequence||0,};}
function transformZone(zone,executed){if(executed.type==="REMOVE_COLUMNS_ROWS"){return reduceZoneOnDeletion(zone,executed.dimension==="COL"?"left":"top",executed.elements);}
if(executed.type==="ADD_COLUMNS_ROWS"){return expandZoneOnInsertion(zone,executed.dimension==="COL"?"left":"top",executed.base,executed.position,executed.quantity);}
return{...zone};}
function transformRangeData(range,executed){const deletedSheet=executed.type==="DELETE_SHEET"&&executed.sheetId;if("sheetId"in executed&&range._sheetId!==executed.sheetId){return range;}
else{const newZone=transformZone(range._zone,executed);if(newZone&&deletedSheet!==range._sheetId){return{...range,_zone:newZone};}}
return undefined;}
class ChartJsComponent extends owl.Component{static template="o-spreadsheet-ChartJsComponent";canvas=owl.useRef("graphContainer");chart;get background(){return this.chartRuntime.background;}
get canvasStyle(){return`background-color: ${this.background}`;}
get chartRuntime(){const runtime=this.env.model.getters.getChartRuntime(this.props.figure.id);if(!("chartJsConfig"in runtime)){throw new Error("Unsupported chart runtime");}
return runtime;}
setup(){owl.onMounted(()=>{const runtime=this.chartRuntime;this.createChart(runtime.chartJsConfig);});owl.useEffect(()=>this.updateChartJs(this.chartRuntime),()=>[this.chartRuntime]);}
createChart(chartData){const canvas=this.canvas.el;const ctx=canvas.getContext("2d");this.chart=new window.Chart(ctx,chartData);}
updateChartJs(chartRuntime){const chartData=chartRuntime.chartJsConfig;if(chartData.data&&chartData.data.datasets){this.chart.data=chartData.data;if(chartData.options?.plugins?.title){this.chart.config.options.plugins.title=chartData.options.plugins.title;}
if(chartData.options&&"valueLabel"in chartData.options){if(chartData.options?.valueLabel){this.chart.config.options.valueLabel=chartData.options.valueLabel;}}}
else{this.chart.data.datasets=[];}
this.chart.config.options.plugins.tooltip=chartData.options.plugins.tooltip;this.chart.config.options.plugins.legend=chartData.options.plugins.legend;this.chart.config.options.scales=chartData.options?.scales;this.chart.update("active");}}
ChartJsComponent.props={figure:Object,};class AbstractChart{sheetId;title;getters;constructor(definition,sheetId,getters){this.title=definition.title;this.sheetId=sheetId;this.getters=getters;}
static validateChartDefinition(validator,definition){throw new Error("This method should be implemented by sub class");}
static transformDefinition(definition,executed){throw new Error("This method should be implemented by sub class");}
static getDefinitionFromContextCreation(context){throw new Error("This method should be implemented by sub class");}}
function updateChartRangesWithDataSets(getters,applyChange,chartDataSets,chartLabelRange){let isStale=false;const dataSetsWithUndefined=[];for(let index in chartDataSets){let ds=chartDataSets[index];if(ds.labelCell){const labelCell=adaptChartRange(ds.labelCell,applyChange);if(ds.labelCell!==labelCell){isStale=true;ds={...ds,labelCell:labelCell,};}}
const dataRange=adaptChartRange(ds.dataRange,applyChange);if(dataRange===undefined||getters.getRangeString(dataRange,dataRange.sheetId)===INCORRECT_RANGE_STRING){isStale=true;ds=undefined;}
else if(dataRange!==ds.dataRange){isStale=true;ds={...ds,dataRange,};}
dataSetsWithUndefined[index]=ds;}
let labelRange=chartLabelRange;const range=adaptChartRange(labelRange,applyChange);if(range!==labelRange){isStale=true;labelRange=range;}
const dataSets=dataSetsWithUndefined.filter(isDefined$1);return{isStale,dataSets,labelRange,};}
function copyDataSetsWithNewSheetId(sheetIdFrom,sheetIdTo,dataSets){return dataSets.map((ds)=>{return{dataRange:copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,ds.dataRange),labelCell:ds.labelCell?copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,ds.labelCell):undefined,};});}
function copyLabelRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range){return range?copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range):undefined;}
function adaptChartRange(range,applyChange){if(!range){return undefined;}
const change=applyChange(range);switch(change.changeType){case"NONE":return range;case"REMOVE":return undefined;default:return change.range;}}
function createDataSets(getters,dataSetsString,sheetId,dataSetsHaveTitle){const dataSets=[];for(const sheetXC of dataSetsString){const dataRange=getters.getRangeFromSheetXC(sheetId,sheetXC);const{unboundedZone:zone,sheetId:dataSetSheetId,invalidSheetName,invalidXc}=dataRange;if(invalidSheetName||invalidXc){continue;}
if(zone.left!==zone.right&&zone.top!==zone.bottom){if(zone.right===undefined){continue;}
for(let column=zone.left;column<=zone.right;column++){const columnZone={...zone,left:column,right:column,};dataSets.push(createDataSet(getters,dataSetSheetId,columnZone,dataSetsHaveTitle?{top:columnZone.top,bottom:columnZone.top,left:columnZone.left,right:columnZone.left,}:undefined));}}
else{dataSets.push(createDataSet(getters,dataSetSheetId,zone,dataSetsHaveTitle?{top:zone.top,bottom:zone.top,left:zone.left,right:zone.left,}:undefined));}}
return dataSets;}
function createDataSet(getters,sheetId,fullZone,titleZone){if(fullZone.left!==fullZone.right&&fullZone.top!==fullZone.bottom){throw new Error(`Zone should be a single column or row: ${zoneToXc(fullZone)}`);}
if(titleZone){const dataXC=zoneToXc(fullZone);const labelCellXC=zoneToXc(titleZone);return{labelCell:getters.getRangeFromSheetXC(sheetId,labelCellXC),dataRange:getters.getRangeFromSheetXC(sheetId,dataXC),};}
else{return{labelCell:undefined,dataRange:getters.getRangeFromSheetXC(sheetId,zoneToXc(fullZone)),};}}
function toExcelDataset(getters,ds){const labelZone=ds.labelCell?.zone;let dataZone=ds.dataRange.zone;if(labelZone){const{numberOfRows,numberOfCols}=zoneToDimension(dataZone);if(numberOfRows===1){dataZone={...dataZone,left:dataZone.left+1};}
else if(numberOfCols===1){dataZone={...dataZone,top:dataZone.top+1};}}
const dataRange=ds.dataRange.clone({zone:dataZone});return{label:ds.labelCell?getters.getRangeString(ds.labelCell,"forceSheetReference",{useFixedReference:true}):undefined,range:getters.getRangeString(dataRange,"forceSheetReference",{useFixedReference:true}),};}
function toExcelLabelRange(getters,labelRange,shouldRemoveFirstLabel){if(!labelRange)
return undefined;let zone={...labelRange.zone,};if(shouldRemoveFirstLabel&&labelRange.zone.bottom>labelRange.zone.top){zone.top=zone.top+1;}
const range=labelRange.clone({zone});return getters.getRangeString(range,"forceSheetReference",{useFixedReference:true});}
function transformChartDefinitionWithDataSetsWithZone(definition,executed){let labelRange;if(definition.labelRange){const labelZone=transformZone(toUnboundedZone(definition.labelRange),executed);labelRange=labelZone?zoneToXc(labelZone):undefined;}
const dataSets=definition.dataSets.map(toUnboundedZone).map((zone)=>transformZone(zone,executed)).filter(isDefined$1).map(zoneToXc);return{...definition,labelRange,dataSets,};}
const GraphColors=["rgb(31,119,180)","rgb(255,127,14)","rgb(174,199,232)","rgb(255,187,120)","rgb(44,160,44)","rgb(152,223,138)","rgb(214,39,40)","rgb(255,152,150)","rgb(148,103,189)","rgb(197,176,213)","rgb(140,86,75)","rgb(196,156,148)","rgb(227,119,194)","rgb(247,182,210)","rgb(127,127,127)","rgb(199,199,199)","rgb(188,189,34)","rgb(219,219,141)","rgb(23,190,207)","rgb(158,218,229)",];class ChartColors{graphColorIndex=0;next(){return GraphColors[this.graphColorIndex++%GraphColors.length];}}
function chartFontColor(backgroundColor){if(!backgroundColor){return"#000000";}
return relativeLuminance(backgroundColor)<0.3?"#FFFFFF":"#000000";}
function checkDataset(definition){if(definition.dataSets){const invalidRanges=definition.dataSets.find((range)=>!rangeReference.test(range))!==undefined;if(invalidRanges){return"InvalidDataSet";}
const zones=definition.dataSets.map(toUnboundedZone);if(zones.some((zone)=>zone.top!==zone.bottom&&isFullRow(zone))){return"InvalidDataSet";}}
return"Success";}
function checkLabelRange(definition){if(definition.labelRange){const invalidLabels=!rangeReference.test(definition.labelRange||"");if(invalidLabels){return"InvalidLabelRange";}}
return"Success";}
function shouldRemoveFirstLabel(labelRange,dataset,dataSetsHaveTitle){if(!dataSetsHaveTitle)
return false;if(!labelRange)
return false;if(!dataset)
return true;const datasetLength=getZoneArea(dataset.dataRange.zone);const labelLength=getZoneArea(labelRange.zone);if(labelLength<datasetLength){return false;}
return true;}
function getBaselineText(baseline,keyValue,baselineMode,locale){if(!baseline){return"";}
else if(baselineMode==="text"||keyValue?.type!==CellValueType.number||baseline.type!==CellValueType.number){return baseline.formattedValue;}
else{let diff=keyValue.value-baseline.value;if(baselineMode==="percentage"&&diff!==0){diff=(diff/baseline.value)*100;}
if(baselineMode!=="percentage"&&baseline.format){return formatValue(diff,{format:baseline.format,locale});}
const baselineStr=Math.abs(parseFloat(diff.toFixed(2))).toLocaleString();return baselineMode==="percentage"?baselineStr+"%":baselineStr;}}
function getBaselineColor(baseline,baselineMode,keyValue,colorUp,colorDown){if(baselineMode==="text"||baseline?.type!==CellValueType.number||keyValue?.type!==CellValueType.number){return undefined;}
const diff=keyValue.value-baseline.value;if(diff>0){return colorUp;}
else if(diff<0){return colorDown;}
return undefined;}
function getBaselineArrowDirection(baseline,keyValue,baselineMode){if(baselineMode==="text"||baseline?.type!==CellValueType.number||keyValue?.type!==CellValueType.number){return"neutral";}
const diff=keyValue.value-baseline.value;if(diff>0){return"up";}
else if(diff<0){return"down";}
return"neutral";}
function getChartPositionAtCenterOfViewport(getters,chartSize){const{x,y}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();const{width,height}=getters.getVisibleRect(getters.getActiveMainViewport());const position={x:x+scrollX+Math.max(0,(width-chartSize.width)/2),y:y+scrollY+Math.max(0,(height-chartSize.height)/2),};return position;}
function checkKeyValue(definition){return definition.keyValue&&!rangeReference.test(definition.keyValue)?"InvalidScorecardKeyValue":"Success";}
function checkBaseline(definition){return definition.baseline&&!rangeReference.test(definition.baseline)?"InvalidScorecardBaseline":"Success";}
const arrowDownPath=new window.Path2D("M8.6 4.8a.5.5 0 0 1 0 .75l-3.9 3.9a.5 .5 0 0 1 -.75 0l-3.8 -3.9a.5 .5 0 0 1 0 -.75l.4-.4a.5.5 0 0 1 .75 0l2.3 2.4v-5.7c0-.25.25-.5.5-.5h.6c.25 0 .5.25.5.5v5.8l2.3 -2.4a.5.5 0 0 1 .75 0z");const arrowUpPath=new window.Path2D("M8.7 5.5a.5.5 0 0 0 0-.75l-3.8-4a.5.5 0 0 0-.75 0l-3.8 4a.5.5 0 0 0 0 .75l.4.4a.5.5 0 0 0 .75 0l2.3-2.4v5.8c0 .25.25.5.5.5h.6c.25 0 .5-.25.5-.5v-5.8l2.2 2.4a.5.5 0 0 0 .75 0z");let ScorecardChart$1=class ScorecardChart extends AbstractChart{keyValue;baseline;baselineMode;baselineDescr;background;baselineColorUp;baselineColorDown;fontColor;type="scorecard";constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.keyValue=createRange(getters,sheetId,definition.keyValue);this.baseline=createRange(getters,sheetId,definition.baseline);this.baselineMode=definition.baselineMode;this.baselineDescr=definition.baselineDescr;this.background=definition.background;this.baselineColorUp=definition.baselineColorUp;this.baselineColorDown=definition.baselineColorDown;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkKeyValue,checkBaseline);}
static getDefinitionFromContextCreation(context){return{background:context.background,type:"scorecard",keyValue:context.range?context.range[0]:undefined,title:context.title||"",baselineMode:DEFAULT_SCORECARD_BASELINE_MODE,baselineColorUp:DEFAULT_SCORECARD_BASELINE_COLOR_UP,baselineColorDown:DEFAULT_SCORECARD_BASELINE_COLOR_DOWN,baseline:context.auxiliaryRange||"",};}
static transformDefinition(definition,executed){let baselineZone;let keyValueZone;if(definition.baseline){baselineZone=transformZone(toUnboundedZone(definition.baseline),executed);}
if(definition.keyValue){keyValueZone=transformZone(toUnboundedZone(definition.keyValue),executed);}
return{...definition,baseline:baselineZone?zoneToXc(baselineZone):undefined,keyValue:keyValueZone?zoneToXc(keyValueZone):undefined,};}
copyForSheetId(sheetId){const baseline=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.baseline);const keyValue=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.keyValue);const definition=this.getDefinitionWithSpecificRanges(baseline,keyValue,sheetId);return new ScorecardChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificRanges(this.baseline,this.keyValue,sheetId);return new ScorecardChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificRanges(this.baseline,this.keyValue);}
getContextCreation(){return{background:this.background,title:this.title,range:this.keyValue?[this.getters.getRangeString(this.keyValue,this.sheetId)]:undefined,auxiliaryRange:this.baseline?this.getters.getRangeString(this.baseline,this.sheetId):undefined,};}
getDefinitionWithSpecificRanges(baseline,keyValue,targetSheetId){return{baselineColorDown:this.baselineColorDown,baselineColorUp:this.baselineColorUp,baselineMode:this.baselineMode,title:this.title,type:"scorecard",background:this.background,baseline:baseline?this.getters.getRangeString(baseline,targetSheetId||this.sheetId):undefined,baselineDescr:this.baselineDescr,keyValue:keyValue?this.getters.getRangeString(keyValue,targetSheetId||this.sheetId):undefined,};}
getDefinitionForExcel(){return undefined;}
updateRanges(applyChange){const baseline=adaptChartRange(this.baseline,applyChange);const keyValue=adaptChartRange(this.keyValue,applyChange);if(this.baseline===baseline&&this.keyValue===keyValue){return this;}
const definition=this.getDefinitionWithSpecificRanges(baseline,keyValue);return new ScorecardChart(definition,this.sheetId,this.getters);}};function drawScoreChart(structure,canvas){const ctx=canvas.getContext("2d");canvas.width=structure.canvas.width;canvas.height=structure.canvas.height;ctx.fillStyle=structure.canvas.backgroundColor;ctx.fillRect(0,0,structure.canvas.width,structure.canvas.height);if(structure.title){ctx.font=structure.title.style.font;ctx.fillStyle=structure.title.style.color;ctx.fillText(structure.title.text,structure.title.position.x,structure.title.position.y);}
if(structure.baseline){ctx.font=structure.baseline.style.font;ctx.fillStyle=structure.baseline.style.color;drawDecoratedText(ctx,structure.baseline.text,structure.baseline.position,structure.baseline.style.underline,structure.baseline.style.strikethrough);}
if(structure.baselineArrow&&structure.baselineArrow.style.size>0){ctx.save();ctx.fillStyle=structure.baselineArrow.style.color;ctx.translate(structure.baselineArrow.position.x,structure.baselineArrow.position.y);const ratio=structure.baselineArrow.style.size/10;ctx.scale(ratio,ratio);switch(structure.baselineArrow.direction){case"down":{ctx.fill(arrowDownPath);break;}
case"up":{ctx.fill(arrowUpPath);break;}}
ctx.restore();}
if(structure.baselineDescr){ctx.font=structure.baselineDescr.style.font;ctx.fillStyle=structure.baselineDescr.style.color;ctx.fillText(structure.baselineDescr.text,structure.baselineDescr.position.x,structure.baselineDescr.position.y);}
if(structure.key){ctx.font=structure.key.style.font;ctx.fillStyle=structure.key.style.color;drawDecoratedText(ctx,structure.key.text,structure.key.position,structure.key.style.underline,structure.key.style.strikethrough);}}
function createScorecardChartRuntime(chart,getters){let keyValue="";let formattedKeyValue="";let keyValueCell;if(chart.keyValue){const keyValuePosition={sheetId:chart.keyValue.sheetId,col:chart.keyValue.zone.left,row:chart.keyValue.zone.top,};keyValueCell=getters.getEvaluatedCell(keyValuePosition);keyValue=String(keyValueCell.value);formattedKeyValue=keyValueCell.formattedValue;}
let baselineCell;const baseline=chart.baseline;if(baseline){const baselinePosition={sheetId:chart.baseline.sheetId,col:chart.baseline.zone.left,row:chart.baseline.zone.top,};baselineCell=getters.getEvaluatedCell(baselinePosition);}
const{background,fontColor}=getters.getStyleOfSingleCellChart(chart.background,chart.keyValue);const locale=getters.getLocale();return{title:_t(chart.title),keyValue:formattedKeyValue||keyValue,baselineDisplay:getBaselineText(baselineCell,keyValueCell,chart.baselineMode,locale),baselineArrow:getBaselineArrowDirection(baselineCell,keyValueCell,chart.baselineMode),baselineColor:getBaselineColor(baselineCell,chart.baselineMode,keyValueCell,chart.baselineColorUp,chart.baselineColorDown),baselineDescr:chart.baselineDescr?_t(chart.baselineDescr):"",fontColor,background,baselineStyle:chart.baselineMode!=="percentage"&&baseline?getters.getCellStyle({sheetId:baseline.sheetId,col:baseline.zone.left,row:baseline.zone.top,}):undefined,keyValueStyle:chart.keyValue?getters.getCellStyle({sheetId:chart.keyValue.sheetId,col:chart.keyValue.zone.left,row:chart.keyValue.zone.top,}):undefined,};}
const TITLE_FONT_SIZE=18;const BASELINE_BOX_HEIGHT_RATIO=0.35;const KEY_BOX_HEIGHT_RATIO=0.65;const BASELINE_DESCR_FONT_RATIO=0.9;const CHART_PADDING_RATIO=0.02;const LINE_HEIGHT=1.2;function formatBaselineDescr(baselineDescr,baseline){const _baselineDescr=baselineDescr||"";return baseline&&_baselineDescr?" "+_baselineDescr:_baselineDescr;}
function getDefaultContextFont(fontSize,bold=false,italic=false){const italicStr=italic?"italic":"";const weight=bold?"bold":"";return`${italicStr} ${weight} ${fontSize}px ${DEFAULT_FONT}`;}
function getScorecardConfiguration({width,height},runtime){const designer=new ScorecardChartConfigBuilder({width,height},runtime);return designer.computeDesign();}
class ScorecardChartConfigBuilder{runtime;context;width;height;constructor({width,height},runtime){this.runtime=runtime;const canvas=document.createElement("canvas");this.width=canvas.width=width;this.height=canvas.height=height;this.context=canvas.getContext("2d");}
computeDesign(){const structure={canvas:{width:this.width,height:this.height,backgroundColor:this.backgroundColor,},};const style=this.getTextStyles();const{height:titleHeight}=this.getTextDimensions(this.title,style.title.font);if(this.title){structure.title={text:this.title,style:style.title,position:{x:this.chartPadding,y:this.chartPadding+titleHeight,},};}
const baselineArrowSize=style.baselineArrow?.size??0;const{height:baselineHeight,width:baselineWidth}=this.getTextDimensions(this.baseline,style.baselineValue.font);const{width:baselineDescrWidth}=this.getTextDimensions(this.baselineDescr,style.baselineDescr.font);structure.baseline={text:this.baseline,style:style.baselineValue,position:{x:(this.width-baselineWidth-baselineDescrWidth+baselineArrowSize)/2,y:this.keyValue?this.height-2*this.chartPadding:this.height-(this.height-titleHeight-baselineHeight)/2-this.chartPadding,},};if(style.baselineArrow){structure.baselineArrow={direction:this.baselineArrow,style:style.baselineArrow,position:{x:structure.baseline.position.x-baselineArrowSize,y:structure.baseline.position.y-(baselineHeight+baselineArrowSize)/2,},};}
if(this.baselineDescr){structure.baselineDescr={text:this.baselineDescr,style:style.baselineDescr,position:{x:structure.baseline.position.x+baselineWidth,y:structure.baseline.position.y,},};}
const{height:keyHeight,width:keyWidth}=this.getTextDimensions(this.keyValue,style.keyValue.font);if(this.keyValue){structure.key={text:this.keyValue,style:style.keyValue,position:{x:(this.width-keyWidth)/2,y:(this.height-baselineHeight+titleHeight+keyHeight)/2-this.chartPadding,},};}
return structure;}
get title(){return this.runtime.title;}
get keyValue(){return this.runtime.keyValue;}
get baseline(){return this.runtime.baselineDisplay;}
get baselineDescr(){return formatBaselineDescr(this.runtime.baselineDescr,this.baseline);}
get baselineArrow(){return this.runtime.baselineArrow;}
get backgroundColor(){return this.runtime.background;}
get secondaryFontColor(){return relativeLuminance(this.backgroundColor)>0.3?"#525252":"#C8C8C8";}
get chartPadding(){return this.width*CHART_PADDING_RATIO;}
getTextDimensions(text,font){this.context.font=font;const measure=this.context.measureText(text);return{width:measure.width,height:measure.actualBoundingBoxAscent+measure.actualBoundingBoxDescent,};}
getTextStyles(){const maxLineWidth=this.width*(1-2*CHART_PADDING_RATIO);const widestElement=this.getWidestElement();const baseFontSize=widestElement.getElementMaxFontSize(this.getDrawableHeight(),this);const fontSizeMatchingWidth=getFontSizeMatchingWidth(maxLineWidth,baseFontSize,(fontSize)=>widestElement.getElementWidth(fontSize,this.context,this));let scalingFactor=fontSizeMatchingWidth/baseFontSize;const keyFontSize=new KeyValueElement(this.runtime.keyValueStyle).getElementMaxFontSize(this.getDrawableHeight(),this)*scalingFactor;const baselineFontSize=new BaselineElement(this.runtime.baselineStyle).getElementMaxFontSize(this.getDrawableHeight(),this)*scalingFactor;return{title:{font:getDefaultContextFont(TITLE_FONT_SIZE),color:this.secondaryFontColor,},keyValue:{color:this.runtime.keyValueStyle?.textColor||this.runtime.fontColor,font:getDefaultContextFont(keyFontSize,this.runtime.keyValueStyle?.bold,this.runtime.keyValueStyle?.italic),strikethrough:this.runtime.keyValueStyle?.strikethrough,underline:this.runtime.keyValueStyle?.underline,},baselineValue:{font:getDefaultContextFont(baselineFontSize,this.runtime.baselineStyle?.bold,this.runtime.baselineStyle?.italic),strikethrough:this.runtime.baselineStyle?.strikethrough,underline:this.runtime.baselineStyle?.underline,color:this.runtime.baselineStyle?.textColor||this.runtime.baselineColor||this.secondaryFontColor,},baselineDescr:{font:getDefaultContextFont(baselineFontSize*BASELINE_DESCR_FONT_RATIO),color:this.secondaryFontColor,},baselineArrow:this.baselineArrow==="neutral"?undefined:{size:this.keyValue?0.8*baselineFontSize:0,color:this.runtime.baselineColor||this.secondaryFontColor,},};}
getDrawableHeight(){const verticalPadding=2*this.chartPadding;let availableHeight=this.height-verticalPadding;availableHeight-=this.title?TITLE_FONT_SIZE*LINE_HEIGHT:0;return availableHeight;}
getWidestElement(){const baseline=new BaselineElement(this.runtime.baselineStyle);const keyValue=new KeyValueElement(this.runtime.keyValueStyle);return baseline.getElementWidth(BASELINE_BOX_HEIGHT_RATIO,this.context,this)>keyValue.getElementWidth(KEY_BOX_HEIGHT_RATIO,this.context,this)?baseline:keyValue;}}
class ScorecardScalableElement{style;constructor(style={}){this.style=style;}
measureTextWidth(ctx,text,fontSize){ctx.font=getDefaultContextFont(fontSize,this.style.bold,this.style.italic);return ctx.measureText(text).width;}}
class BaselineElement extends ScorecardScalableElement{getElementWidth(fontSize,ctx,chart){if(!chart.runtime){return 0;}
const baselineStr=chart.baseline;const largeText=chart.baselineArrow!=="neutral"?"A "+baselineStr:baselineStr;let textWidth=this.measureTextWidth(ctx,largeText,fontSize);textWidth+=this.measureTextWidth(ctx,chart.baselineDescr,fontSize*BASELINE_DESCR_FONT_RATIO);return textWidth;}
getElementMaxFontSize(availableHeight,chart){if(!chart.runtime){return 0;}
const haveBaseline=chart.baseline!==""||chart.baselineDescr;const maxHeight=haveBaseline?BASELINE_BOX_HEIGHT_RATIO*availableHeight:0;return maxHeight/LINE_HEIGHT;}}
class KeyValueElement extends ScorecardScalableElement{getElementWidth(fontSize,ctx,chart){if(!chart.runtime){return 0;}
const str=chart.keyValue||"";return this.measureTextWidth(ctx,str,fontSize);}
getElementMaxFontSize(availableHeight,chart){if(!chart.runtime){return 0;}
const haveBaseline=chart.baseline!==""||chart.baselineDescr;const maxHeight=haveBaseline?KEY_BOX_HEIGHT_RATIO*availableHeight:availableHeight;return maxHeight/LINE_HEIGHT;}}
class ScorecardChart extends owl.Component{static template="o-spreadsheet-ScorecardChart";canvas=owl.useRef("chartContainer");get runtime(){return this.env.model.getters.getChartRuntime(this.props.figure.id);}
setup(){owl.useEffect(this.createChart.bind(this),()=>{const canvas=this.canvas.el;const rect=canvas.getBoundingClientRect();return[rect.width,rect.height,this.runtime,this.canvas.el];});}
createChart(){const canvas=this.canvas.el;const config=getScorecardConfiguration(canvas.getBoundingClientRect(),this.runtime);drawScoreChart(config,canvas);}}
ScorecardChart.props={figure:Object,};class Registry{content={};add(key,value){this.content[key]=value;return this;}
get(key){const content=this.content[key];if(!content){if(!(key in this.content)){throw new Error(`Cannot find ${key} in this registry!`);}}
return content;}
contains(key){return key in this.content;}
getAll(){return Object.values(this.content);}
getKeys(){return Object.keys(this.content);}
remove(key){delete this.content[key];}}
function withHttps(url){return!/^https?:\/\//i.test(url)?`https://${url}`:url;}
const urlRegistry=new Registry();function createWebLink(url,label){url=withHttps(url);return{url,label:label||url,isExternal:true,isUrlEditable:true,};}
urlRegistry.add("sheet_URL",{match:(url)=>isSheetUrl(url),createLink:(url,label)=>{return{label,url,isExternal:false,isUrlEditable:false,};},urlRepresentation(url,getters){const sheetId=parseSheetUrl(url);return getters.tryGetSheetName(sheetId)||_t("Invalid sheet");},open(url,env){const sheetId=parseSheetUrl(url);env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:env.model.getters.getActiveSheetId(),sheetIdTo:sheetId,});},sequence:0,});const WebUrlSpec={createLink:createWebLink,match:(url)=>isWebLink(url),open:(url)=>window.open(url,"_blank"),urlRepresentation:(url)=>url,sequence:0,};function findMatchingSpec(url){return(urlRegistry.getAll().sort((a,b)=>a.sequence-b.sequence).find((urlType)=>urlType.match(url))||WebUrlSpec);}
function urlRepresentation(link,getters){return findMatchingSpec(link.url).urlRepresentation(link.url,getters);}
function openLink(link,env){findMatchingSpec(link.url).open(link.url,env);}
function detectLink(value){if(typeof value!=="string"){return undefined;}
if(isMarkdownLink(value)){const{label,url}=parseMarkdownLink(value);return findMatchingSpec(url).createLink(url,label);}
else if(isWebLink(value)){return createWebLink(value);}
return undefined;}
function evaluateLiteral(content,localeFormat){return createEvaluatedCell(parseLiteral(content||"",localeFormat.locale),localeFormat);}
function parseLiteral(content,locale){if(content.startsWith("=")){throw new Error(`Cannot parse "${content}" because it's not a literal value. It's a formula`);}
if(isNumber(content,DEFAULT_LOCALE)){return toNumber(content,DEFAULT_LOCALE);}
else if(isDateTime(content,locale)){return toNumber(content,locale);}
else if(isBoolean(content)){return content.toUpperCase()==="TRUE"?true:false;}
return content;}
function createEvaluatedCell(value,localeFormat){const link=detectLink(value);if(link){return{..._createEvaluatedCell(parseLiteral(link.label,localeFormat.locale),{format:localeFormat.format||detectDateFormat(link.label,localeFormat.locale)||detectNumberFormat(link.label),locale:localeFormat.locale,}),link,};}
return _createEvaluatedCell(value,localeFormat);}
function _createEvaluatedCell(value,localeFormat){try{for(const builder of builders){const evaluateCell=builder(value,localeFormat);if(evaluateCell){return evaluateCell;}}
return textCell((value||"").toString(),localeFormat);}
catch(error){return errorCell(new EvaluationError(CellErrorType.GenericError,error.message||DEFAULT_ERROR_MESSAGE));}}
function textCell(value,localeFormat){return{type:CellValueType.text,value,format:localeFormat.format,isAutoSummable:true,defaultAlign:"left",formattedValue:formatValue(value,localeFormat),};}
function numberCell(value,localeFormat){return{type:CellValueType.number,value:value||0,format:localeFormat.format,isAutoSummable:true,defaultAlign:"right",formattedValue:formatValue(value,localeFormat),};}
const EMPTY_EVALUATED_CELL={type:CellValueType.empty,value:"",format:undefined,isAutoSummable:true,defaultAlign:"left",formattedValue:"",};function emptyCell(localeFormat){if(localeFormat.format===undefined){return EMPTY_EVALUATED_CELL;}
return{type:CellValueType.empty,value:"",format:localeFormat.format,isAutoSummable:true,defaultAlign:"left",formattedValue:"",};}
function dateTimeCell(value,localeFormat){const formattedValue=formatValue(value,localeFormat);return{type:CellValueType.number,value,format:localeFormat.format,isAutoSummable:false,defaultAlign:"right",formattedValue,};}
function booleanCell(value,localeFormat){const formattedValue=value?"TRUE":"FALSE";return{type:CellValueType.boolean,value,format:localeFormat.format,isAutoSummable:false,defaultAlign:"center",formattedValue,};}
function errorCell(error){return{type:CellValueType.error,value:error.errorType,error,isAutoSummable:false,defaultAlign:"center",formattedValue:error.errorType,};}
const builders=[function createEmpty(value,localeFormat){if(value===""){return emptyCell(localeFormat);}
return undefined;},function createDateTime(value,localeFormat){if(!!localeFormat.format&&typeof value==="number"&&isDateTimeFormat(localeFormat.format)){return dateTimeCell(value,localeFormat);}
return undefined;},function createNumber(value,localeFormat){if(typeof value==="number"){return numberCell(value,localeFormat);}
else if(value===null){return numberCell(0,localeFormat);}
return undefined;},function createBoolean(value,localeFormat){if(typeof value==="boolean"){return booleanCell(value,localeFormat);}
return undefined;},];const autofillModifiersRegistry=new Registry();autofillModifiersRegistry.add("ALPHANUMERIC_INCREMENT_MODIFIER",{apply:(rule,data)=>{rule.current+=rule.increment;const content=`${rule.prefix}${rule.current
            .toString()
            .padStart(rule.numberPostfixLength || 0, "0")}`;return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:{props:{content}},};},}).add("INCREMENT_MODIFIER",{apply:(rule,data,getters)=>{rule.current+=rule.increment;const content=rule.current.toString();const locale=getters.getLocale();const tooltipValue=formatValue(rule.current,{format:data.cell?.format,locale});return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:content?{props:{content:tooltipValue}}:undefined,};},}).add("COPY_MODIFIER",{apply:(rule,data,getters)=>{const content=data.cell?.content||"";const localeFormat={locale:getters.getLocale(),format:data.cell?.format};return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:content?{props:{content:evaluateLiteral(data.cell?.content,localeFormat).formattedValue,},}:undefined,};},}).add("FORMULA_MODIFIER",{apply:(rule,data,getters,direction)=>{rule.current+=rule.increment;let x=0;let y=0;switch(direction){case"up":x=0;y=-rule.current;break;case"down":x=0;y=rule.current;break;case"left":x=-rule.current;y=0;break;case"right":x=rule.current;y=0;break;}
const cell=data.cell;if(!cell||!cell.isFormula){return{cellData:{}};}
const sheetId=data.sheetId;const content=getters.getTranslatedCellFormula(sheetId,x,y,cell.compiledFormula);return{cellData:{border:data.border,style:cell.style,format:cell.format,content,},tooltip:content?{props:{content}}:undefined,};},});const autofillRulesRegistry=new Registry();const numberPostfixRegExp=/(\d+)$/;const stringPrefixRegExp=/^(.*\D+)/;const alphaNumericValueRegExp=/^(.*\D+)(\d+)$/;function getGroup(cell,cells,filter){let group=[];let found=false;for(let x of cells){if(x===cell){found=true;}
const cellValue=x?.isFormula?undefined:evaluateLiteral(x?.content,{locale:DEFAULT_LOCALE});if(cellValue&&filter(cellValue)){group.push(cellValue);}
else{if(found){return group;}
group=[];}}
return group;}
function getAverageIncrement(group){const averages=[];let last=group[0];for(let i=1;i<group.length;i++){const current=group[i];averages.push(current-last);last=current;}
return averages.reduce((a,b)=>a+b,0)/averages.length;}
function calculateIncrementBasedOnGroup(group){let increment=1;if(group.length>=2){increment=getAverageIncrement(group)*group.length;}
return increment;}
autofillRulesRegistry.add("simple_value_copy",{condition:(cell,cells)=>{return(cells.length===1&&!cell.isFormula&&!(cell.format&&isDateTimeFormat(cell.format)));},generateRule:()=>{return{type:"COPY_MODIFIER"};},sequence:10,}).add("increment_alphanumeric_value",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.text&&alphaNumericValueRegExp.test(cell.content),generateRule:(cell,cells)=>{const numberPostfix=parseInt(cell.content.match(numberPostfixRegExp)[0]);const prefix=cell.content.match(stringPrefixRegExp)[0];const numberPostfixLength=cell.content.length-prefix.length;const group=getGroup(cell,cells,(evaluatedCell)=>evaluatedCell.type===CellValueType.text&&alphaNumericValueRegExp.test(evaluatedCell.value)).filter((cell)=>prefix===cell.value.toString().match(stringPrefixRegExp)[0]).map((cell)=>parseInt(cell.value.toString().match(numberPostfixRegExp)[0]));const increment=calculateIncrementBasedOnGroup(group);return{type:"ALPHANUMERIC_INCREMENT_MODIFIER",prefix,current:numberPostfix,increment,numberPostfixLength,};},sequence:15,}).add("copy_text",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.text,generateRule:()=>{return{type:"COPY_MODIFIER"};},sequence:20,}).add("update_formula",{condition:(cell)=>cell.isFormula,generateRule:(_,cells)=>{return{type:"FORMULA_MODIFIER",increment:cells.length,current:0};},sequence:30,}).add("increment_number",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.number,generateRule:(cell,cells)=>{const group=getGroup(cell,cells,(evaluatedCell)=>evaluatedCell.type===CellValueType.number).map((cell)=>Number(cell.value));const increment=calculateIncrementBasedOnGroup(group);const evaluation=evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE});return{type:"INCREMENT_MODIFIER",increment,current:evaluation.type===CellValueType.number?evaluation.value:0,};},sequence:40,});const STYLESHEETS={};let nextId=0;function css(strings,...args){const name=`__sheet__${nextId++}`;const value=String.raw(strings,...args);registerSheet(name,value);activateSheet(name);return name;}
function processSheet(str){const tokens=str.split(/(\{|\}|;)/).map((s)=>s.trim());const selectorStack=[];const parts=[];let rules=[];function generateSelector(stackIndex,parentSelector){const parts=[];for(const selector of selectorStack[stackIndex]){let part=(parentSelector&&parentSelector+" "+selector)||selector;if(part.includes("&")){part=selector.replace(/&/g,parentSelector||"");}
if(stackIndex<selectorStack.length-1){part=generateSelector(stackIndex+1,part);}
parts.push(part);}
return parts.join(", ");}
function generateRules(){if(rules.length){parts.push(generateSelector(0)+" {");parts.push(...rules);parts.push("}");rules=[];}}
while(tokens.length){let token=tokens.shift();if(token==="}"){generateRules();selectorStack.pop();}
else{if(tokens[0]==="{"){generateRules();selectorStack.push(token.split(/\s*,\s*/));tokens.shift();}
if(tokens[0]===";"){rules.push("  "+token+";");}}}
return parts.join("\n");}
function registerSheet(id,css){const sheet=document.createElement("style");sheet.textContent=processSheet(css);STYLESHEETS[id]=sheet;}
function activateSheet(id){const sheet=STYLESHEETS[id];sheet.setAttribute("component",id);document.head.appendChild(sheet);}
function getTextDecoration({strikethrough,underline,}){if(!strikethrough&&!underline){return"none";}
return`${strikethrough ? "line-through" : ""} ${underline ? "underline" : ""}`;}
function cellStyleToCss(style){const attributes=cellTextStyleToCss(style);if(!style)
return attributes;if(style.fillColor){attributes["background"]=style.fillColor;}
return attributes;}
function cellTextStyleToCss(style){const attributes={};if(!style)
return attributes;if(style.bold){attributes["font-weight"]="bold";}
if(style.italic){attributes["font-style"]="italic";}
if(style.strikethrough||style.underline){let decoration=style.strikethrough?"line-through":"";decoration=style.underline?decoration+" underline":decoration;attributes["text-decoration"]=decoration;}
if(style.textColor){attributes["color"]=style.textColor;}
return attributes;}
function cssPropertiesToCss(attributes){let styleStr="";for(const attName in attributes){if(!attributes[attName]){continue;}
styleStr+=`${attName}:${attributes[attName]}; `;}
return styleStr;}
function getElementMargins(el){const style=window.getComputedStyle(el);const margins={top:parseInt(style.marginTop,10)||0,bottom:parseInt(style.marginBottom,10)||0,left:parseInt(style.marginLeft,10)||0,right:parseInt(style.marginRight,10)||0,};return margins;}
const ERROR_TOOLTIP_MAX_HEIGHT=80;const ERROR_TOOLTIP_WIDTH=180;css`
  .o-error-tooltip {
    font-size: 13px;
    background-color: white;
    border-left: 3px solid red;
    padding: 10px;
    width: ${ERROR_TOOLTIP_WIDTH}px;
    box-sizing: border-box !important;
    overflow-wrap: break-word;

    .o-error-tooltip-message {
      overflow: hidden;
    }
  }
`;class ErrorToolTip extends owl.Component{static maxSize={maxHeight:ERROR_TOOLTIP_MAX_HEIGHT};static template="o-spreadsheet-ErrorToolTip";}
ErrorToolTip.props={errors:Array,onClosed:{type:Function,optional:true},};const ErrorToolTipPopoverBuilder={onHover:(position,getters)=>{const cell=getters.getEvaluatedCell(position);const errors=[];if(cell.type===CellValueType.error&&cell.error.isVerbose){errors.push({title:_t("Error"),message:cell.error.message,});}
const validationErrorMessage=getters.getInvalidDataValidationMessage(position);if(validationErrorMessage){errors.push({title:_t("Invalid"),message:validationErrorMessage,});}
if(!errors.length){return{isOpen:false};}
return{isOpen:true,props:{errors:errors},Component:ErrorToolTip,cellCorner:"TopRight",};},};css`
  .o-filter-menu-value {
    padding: 4px;
    line-height: 20px;
    height: 28px;
    .o-filter-menu-value-checked {
      width: 20px;
    }
  }
`;class FilterMenuValueItem extends owl.Component{static template="o-spreadsheet-FilterMenuValueItem";itemRef=owl.useRef("menuValueItem");setup(){owl.onWillPatch(()=>{if(this.props.scrolledTo){this.scrollListToSelectedValue();}});}
scrollListToSelectedValue(){if(!this.itemRef.el){return;}
this.itemRef.el.scrollIntoView?.({block:this.props.scrolledTo==="bottom"?"end":"start",});}}
FilterMenuValueItem.props={value:String,isChecked:Boolean,isSelected:Boolean,onMouseMove:Function,onClick:Function,scrolledTo:{type:String,optional:true},};const FILTER_MENU_HEIGHT=295;const CSS$2=css`
  .o-filter-menu {
    box-sizing: border-box;
    padding: 8px 16px;
    height: ${FILTER_MENU_HEIGHT}px;
    line-height: 1;

    .o-filter-menu-item {
      display: flex;
      box-sizing: border-box;
      height: ${MENU_ITEM_HEIGHT}px;
      padding: 4px 4px 4px 0px;
      cursor: pointer;
      user-select: none;

      &.selected {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    input {
      box-sizing: border-box;
      margin-bottom: 5px;
      border: 1px solid #949494;
      height: 24px;
      padding-right: 28px;
    }

    .o-search-icon {
      right: 5px;
      top: 4px;
      opacity: 0.4;

      svg {
        height: 16px;
        width: 16px;
        vertical-align: middle;
      }
    }

    .o-filter-menu-actions {
      display: flex;
      flex-direction: row;
      margin-bottom: 4px;

      .o-filter-menu-action-text {
        cursor: pointer;
        margin-right: 10px;
        color: blue;
        text-decoration: underline;
      }
    }

    .o-filter-menu-list {
      flex: auto;
      overflow-y: auto;
      border: 1px solid #949494;

      .o-filter-menu-no-values {
        color: #949494;
        font-style: italic;
      }
    }

    .o-filter-menu-buttons {
      margin-top: 9px;

      .o-filter-menu-button {
        border: 1px solid lightgrey;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        line-height: 16px;
      }

      .o-filter-menu-button-cancel {
        background: white;
        &:hover {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }

      .o-filter-menu-button-primary {
        background-color: #188038;
        &:hover {
          background-color: #1d9641;
        }
        color: white;
        font-weight: bold;
        margin-left: 10px;
      }
    }
  }
`;class FilterMenu extends owl.Component{static size={width:MENU_WIDTH,height:FILTER_MENU_HEIGHT};static template="o-spreadsheet-FilterMenu";static style=CSS$2;static components={FilterMenuValueItem};state=owl.useState({values:[],textFilter:"",selectedValue:undefined,});searchBar=owl.useRef("filterMenuSearchBar");setup(){owl.onWillUpdateProps((nextProps)=>{if(!deepEquals(nextProps.filterPosition,this.props.filterPosition)){this.state.values=this.getFilterValues(nextProps.filterPosition);}});this.state.values=this.getFilterValues(this.props.filterPosition);}
get isReadonly(){return this.env.model.getters.isReadonly();}
getFilterValues(position){const sheetId=this.env.model.getters.getActiveSheetId();const filter=this.env.model.getters.getFilter({sheetId,...position});if(!filter){return[];}
const cellValues=(filter.filteredZone?positions(filter.filteredZone):[]).filter(({row})=>!this.env.model.getters.isRowHidden(sheetId,row)).map(({col,row})=>this.env.model.getters.getEvaluatedCell({sheetId,col,row}).formattedValue);const filterValues=this.env.model.getters.getFilterValues({sheetId,...position});const strValues=[...cellValues,...filterValues];const normalizedFilteredValues=filterValues.map(toLowerCase);const normalizedValues=[...new Set(strValues.map(toLowerCase))];const sortedValues=normalizedValues.sort((val1,val2)=>val1.localeCompare(val2,undefined,{numeric:true,sensitivity:"base"}));return sortedValues.map((normalizedValue)=>{const checked=normalizedFilteredValues.findIndex((filteredValue)=>filteredValue===normalizedValue)===-1;return{checked,string:strValues.find((val)=>toLowerCase(val)===normalizedValue)||"",};});}
checkValue(value){this.state.selectedValue=value.string;value.checked=!value.checked;this.searchBar.el?.focus();}
onMouseMove(value){this.state.selectedValue=value.string;}
selectAll(){this.displayedValues.forEach((value)=>(value.checked=true));}
clearAll(){this.displayedValues.forEach((value)=>(value.checked=false));}
get filterTable(){const sheetId=this.env.model.getters.getActiveSheetId();const position=this.props.filterPosition;return this.env.model.getters.getFilterTable({sheetId,...position});}
get displayedValues(){if(!this.state.textFilter){return this.state.values;}
return fuzzyLookup(this.state.textFilter,this.state.values,(val)=>val.string);}
confirm(){const position=this.props.filterPosition;this.env.model.dispatch("UPDATE_FILTER",{...position,sheetId:this.env.model.getters.getActiveSheetId(),hiddenValues:this.state.values.filter((val)=>!val.checked).map((val)=>val.string),});this.props.onClosed?.();}
cancel(){this.props.onClosed?.();}
onKeyDown(ev){const displayedValues=this.displayedValues;if(displayedValues.length===0)
return;let selectedIndex=undefined;if(this.state.selectedValue!==undefined){const index=displayedValues.findIndex((val)=>val.string===this.state.selectedValue);selectedIndex=index===-1?undefined:index;}
switch(ev.key){case"ArrowDown":if(selectedIndex===undefined){selectedIndex=0;}
else{selectedIndex=Math.min(selectedIndex+1,displayedValues.length-1);}
ev.preventDefault();ev.stopPropagation();break;case"ArrowUp":if(selectedIndex===undefined){selectedIndex=displayedValues.length-1;}
else{selectedIndex=Math.max(selectedIndex-1,0);}
ev.preventDefault();ev.stopPropagation();break;case"Enter":if(selectedIndex!==undefined){this.checkValue(displayedValues[selectedIndex]);}
ev.stopPropagation();ev.preventDefault();break;}
this.state.selectedValue=selectedIndex!==undefined?displayedValues[selectedIndex].string:undefined;if(ev.key==="ArrowUp"||ev.key==="ArrowDown"){this.scrollListToSelectedValue(ev.key);}}
clearScrolledToValue(){this.state.values.forEach((val)=>(val.scrolledTo=undefined));}
scrollListToSelectedValue(arrow){this.clearScrolledToValue();const selectedValue=this.state.values.find((val)=>val.string===this.state.selectedValue);if(selectedValue){selectedValue.scrolledTo=arrow==="ArrowUp"?"top":"bottom";}}
sortFilterZone(sortDirection){const filterPosition=this.props.filterPosition;const filterTable=this.filterTable;if(!filterPosition||!filterTable||!filterTable.contentZone){return;}
const sheetId=this.env.model.getters.getActiveSheetId();this.env.model.dispatch("SORT_CELLS",{sheetId,col:filterPosition.col,row:filterTable.contentZone.top,zone:filterTable.contentZone,sortDirection,sortOptions:{emptyCellAsZero:true,sortHeaders:true},});this.props.onClosed?.();}}
FilterMenu.props={filterPosition:Object,onClosed:{type:Function,optional:true},};const FilterMenuPopoverBuilder={onOpen:(position,getters)=>{return{isOpen:true,props:{filterPosition:position},Component:FilterMenu,cellCorner:"BottomLeft",};},};const macRegex=/Mac/i;function isChildEvent(parent,ev){return!!ev.target&&parent.contains(ev.target);}
function gridOverlayPosition(){const spreadsheetElement=document.querySelector(".o-grid-overlay");if(spreadsheetElement){const{top,left}=spreadsheetElement?.getBoundingClientRect();return{top,left};}
throw new Error("Can't find spreadsheet position");}
function getBoundingRectAsPOJO(el){const rect=el.getBoundingClientRect();return{x:rect.x,y:rect.y,width:rect.width,height:rect.height,};}
function*iterateChildren(el){yield el;if(el.hasChildNodes()){for(let child of el.childNodes){yield*iterateChildren(child);}}}
function getOpenedMenus(){return Array.from(document.querySelectorAll(".o-spreadsheet .o-menu"));}
function isMacOS(){return Boolean(macRegex.test(navigator.userAgent));}
function isCtrlKey(ev){return isMacOS()?ev.metaKey:ev.ctrlKey;}
function useSpreadsheetRect(){const position=owl.useState({x:0,y:0,width:0,height:0});let spreadsheetElement=document.querySelector(".o-spreadsheet");updatePosition();function updatePosition(){if(!spreadsheetElement){spreadsheetElement=document.querySelector(".o-spreadsheet");}
if(spreadsheetElement){const{top,left,width,height}=spreadsheetElement.getBoundingClientRect();position.x=left;position.y=top;position.width=width;position.height=height;}}
owl.onMounted(updatePosition);owl.onPatched(updatePosition);return position;}
function useAbsoluteBoundingRect(ref){const rect=owl.useState({x:0,y:0,width:0,height:0});function updateElRect(){const el=ref.el;if(el===null){return;}
const{top,left,width,height}=el.getBoundingClientRect();rect.x=left;rect.y=top;rect.width=width;rect.height=height;}
owl.onMounted(updateElRect);owl.onPatched(updateElRect);return rect;}
function usePopoverContainer(){const container=owl.useState({x:0,y:0,width:0,height:0});const component=owl.useComponent();const spreadsheetRect=useSpreadsheetRect();function updateRect(){const env=component.env;const newRect="getPopoverContainerRect"in env?env.getPopoverContainerRect():spreadsheetRect;container.x=newRect.x;container.y=newRect.y;container.width=newRect.width;container.height=newRect.height;}
updateRect();owl.onMounted(updateRect);owl.onPatched(updateRect);return container;}
function rectIntersection(rect1,rect2){return zoneToRect(intersection(rectToZone(rect1),rectToZone(rect2)));}
function rectUnion(...rects){return zoneToRect(union(...rects.map(rectToZone)));}
function rectToZone(rect){return{left:rect.x,top:rect.y,right:rect.x+rect.width,bottom:rect.y+rect.height,};}
function zoneToRect(zone){if(!zone)
return undefined;return{x:zone.left,y:zone.top,width:zone.right-zone.left,height:zone.bottom-zone.top,};}
css`
  .o-popover {
    position: absolute;
    z-index: ${ComponentsImportance.Popover};
    overflow: auto;
    box-shadow: 1px 2px 5px 2px rgb(51 51 51 / 15%);
    width: fit-content;
    height: fit-content;
  }
`;class Popover extends owl.Component{static template="o-spreadsheet-Popover";static defaultProps={positioning:"BottomLeft",verticalOffset:0,onMouseWheel:()=>{},onPopoverMoved:()=>{},onPopoverHidden:()=>{},zIndex:ComponentsImportance.Popover,};popoverRef=owl.useRef("popover");currentPosition=undefined;currentDisplayValue=undefined;spreadsheetRect=useSpreadsheetRect();containerRect;setup(){this.containerRect=usePopoverContainer();owl.useEffect(()=>{if(!this.containerRect)
throw new Error("Popover container is not defined");const el=this.popoverRef.el;const anchor=rectIntersection(this.props.anchorRect,this.containerRect);const newDisplay=anchor?"block":"none";if(this.currentDisplayValue!=="none"&&newDisplay==="none"){this.props.onPopoverHidden?.();}
el.style.display=newDisplay;this.currentDisplayValue=newDisplay;if(!anchor)
return;const propsMaxSize={width:this.props.maxWidth,height:this.props.maxHeight};const elDims={width:el.getBoundingClientRect().width,height:el.getBoundingClientRect().height,};const spreadsheetRect=this.spreadsheetRect;const popoverPositionHelper=this.props.positioning==="BottomLeft"?new BottomLeftPopoverContext(anchor,this.containerRect,propsMaxSize,spreadsheetRect):new TopRightPopoverContext(anchor,this.containerRect,propsMaxSize,spreadsheetRect);const style=popoverPositionHelper.getCss(elDims,this.props.verticalOffset);for(const property of Object.keys(style)){el.style[property]=style[property];}
const newPosition=popoverPositionHelper.getCurrentPosition(elDims);if(this.currentPosition&&newPosition!==this.currentPosition){this.props.onPopoverMoved?.();}
this.currentPosition=newPosition;});}
get popoverStyle(){return cssPropertiesToCss({"z-index":`${this.props.zIndex}`,});}}
Popover.props={anchorRect:Object,containerRect:{type:Object,optional:true},positioning:{type:String,optional:true},maxWidth:{type:Number,optional:true},maxHeight:{type:Number,optional:true},verticalOffset:{type:Number,optional:true},onMouseWheel:{type:Function,optional:true},onPopoverHidden:{type:Function,optional:true},onPopoverMoved:{type:Function,optional:true},zIndex:{type:Number,optional:true},slots:Object,};class PopoverPositionContext{anchorRect;containerRect;propsMaxSize;spreadsheetOffset;constructor(anchorRect,containerRect,propsMaxSize,spreadsheetOffset){this.anchorRect=anchorRect;this.containerRect=containerRect;this.propsMaxSize=propsMaxSize;this.spreadsheetOffset=spreadsheetOffset;}
shouldRenderAtBottom(elementHeight){return(elementHeight<=this.availableHeightDown||this.availableHeightDown>=this.availableHeightUp);}
shouldRenderAtRight(elementWidth){return(elementWidth<=this.availableWidthRight||this.availableWidthRight>=this.availableWidthLeft);}
getMaxHeight(elementHeight){const shouldRenderAtBottom=this.shouldRenderAtBottom(elementHeight);const availableHeight=shouldRenderAtBottom?this.availableHeightDown:this.availableHeightUp;return this.propsMaxSize.height?Math.min(availableHeight,this.propsMaxSize.height):availableHeight;}
getMaxWidth(elementWidth){const shouldRenderAtRight=this.shouldRenderAtRight(elementWidth);const availableWidth=shouldRenderAtRight?this.availableWidthRight:this.availableWidthLeft;return this.propsMaxSize.width?Math.min(availableWidth,this.propsMaxSize.width):availableWidth;}
getCss(elDims,verticalOffset){const maxHeight=this.getMaxHeight(elDims.height);const maxWidth=this.getMaxWidth(elDims.width);const actualHeight=Math.min(maxHeight,elDims.height);const actualWidth=Math.min(maxWidth,elDims.width);const shouldRenderAtBottom=this.shouldRenderAtBottom(elDims.height);const shouldRenderAtRight=this.shouldRenderAtRight(elDims.width);verticalOffset=shouldRenderAtBottom?verticalOffset:-verticalOffset;const cssProperties={"max-height":maxHeight+"px","max-width":maxWidth+"px",top:this.getTopCoordinate(actualHeight,shouldRenderAtBottom)-
this.spreadsheetOffset.y-
verticalOffset+"px",left:this.getLeftCoordinate(actualWidth,shouldRenderAtRight)-this.spreadsheetOffset.x+"px",};return cssProperties;}
getCurrentPosition(elDims){const shouldRenderAtBottom=this.shouldRenderAtBottom(elDims.height);const shouldRenderAtRight=this.shouldRenderAtRight(elDims.width);if(shouldRenderAtBottom&&shouldRenderAtRight)
return"BottomRight";if(shouldRenderAtBottom&&!shouldRenderAtRight)
return"BottomLeft";if(!shouldRenderAtBottom&&shouldRenderAtRight)
return"TopRight";return"TopLeft";}}
class BottomLeftPopoverContext extends PopoverPositionContext{get availableHeightUp(){return this.anchorRect.y-this.containerRect.y;}
get availableHeightDown(){return this.containerRect.height-this.availableHeightUp-this.anchorRect.height;}
get availableWidthRight(){return this.containerRect.x+this.containerRect.width-this.anchorRect.x;}
get availableWidthLeft(){return this.anchorRect.x+this.anchorRect.width-this.containerRect.x;}
getTopCoordinate(elementHeight,shouldRenderAtBottom){if(shouldRenderAtBottom){return this.anchorRect.y+this.anchorRect.height;}
else{return this.anchorRect.y-elementHeight;}}
getLeftCoordinate(elementWidth,shouldRenderAtRight){if(shouldRenderAtRight){return this.anchorRect.x;}
else{return this.anchorRect.x+this.anchorRect.width-elementWidth;}}}
class TopRightPopoverContext extends PopoverPositionContext{get availableHeightUp(){return this.anchorRect.y+this.anchorRect.height-this.containerRect.y;}
get availableHeightDown(){return this.containerRect.y+this.containerRect.height-this.anchorRect.y;}
get availableWidthRight(){return this.containerRect.width-this.anchorRect.width-this.availableWidthLeft;}
get availableWidthLeft(){return this.anchorRect.x-this.containerRect.x;}
getTopCoordinate(elementHeight,shouldRenderAtBottom){if(shouldRenderAtBottom){return this.anchorRect.y;}
else{return this.anchorRect.y+this.anchorRect.height-elementHeight;}}
getLeftCoordinate(elementWidth,shouldRenderAtRight){if(shouldRenderAtRight){return this.anchorRect.x+this.anchorRect.width;}
else{return this.anchorRect.x-elementWidth;}}}
css`
  .o-menu {
    background-color: white;
    padding: ${MENU_VERTICAL_PADDING}px 0px;
    width: ${MENU_WIDTH}px;
    box-sizing: border-box !important;

    .o-menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      height: ${MENU_ITEM_HEIGHT}px;
      padding: ${MENU_ITEM_PADDING_VERTICAL}px ${MENU_ITEM_PADDING_HORIZONTAL}px;
      cursor: pointer;
      user-select: none;

      .o-menu-item-name {
        min-width: 40%;
      }

      &.o-menu-root {
        display: flex;
        justify-content: space-between;
      }

      .o-menu-item-icon {
        display: inline-block;
        margin: 0px 8px 0px 0px;
        width: ${MENU_ITEM_HEIGHT - 2 * MENU_ITEM_PADDING_VERTICAL}px;
        line-height: ${MENU_ITEM_HEIGHT - 2 * MENU_ITEM_PADDING_VERTICAL}px;
      }
      .o-menu-item-root {
        width: 10px;
      }

      &:not(.disabled) {
        &:hover,
        &.o-menu-item-active {
          background-color: ${BG_HOVER_COLOR};
        }
        .o-menu-item-description {
          color: grey;
        }
        .o-menu-item-icon {
          .o-icon {
            color: ${ICONS_COLOR};
          }
        }
      }
      &.disabled {
        color: ${DISABLED_TEXT_COLOR};
        cursor: not-allowed;
      }
    }
  }
`;class Menu extends owl.Component{static template="o-spreadsheet-Menu";static components={Menu,Popover};static defaultProps={depth:1,};subMenu=owl.useState({isOpen:false,position:null,scrollOffset:0,menuItems:[],});menuRef=owl.useRef("menu");position=useAbsoluteBoundingRect(this.menuRef);setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});owl.useExternalListener(window,"contextmenu",this.onExternalClick,{capture:true});owl.onWillUpdateProps((nextProps)=>{if(nextProps.menuItems!==this.props.menuItems){this.closeSubMenu();}});}
get menuItemsAndSeparators(){const menuItemsAndSeparators=[];for(let i=0;i<this.props.menuItems.length;i++){const menuItem=this.props.menuItems[i];if(menuItem.isVisible(this.env)){menuItemsAndSeparators.push(menuItem);}
if(menuItem.separator&&i!==this.props.menuItems.length-1&&menuItemsAndSeparators[menuItemsAndSeparators.length-1]!=="separator"){menuItemsAndSeparators.push("separator");}}
if(menuItemsAndSeparators[menuItemsAndSeparators.length-1]==="separator"){menuItemsAndSeparators.pop();}
if(menuItemsAndSeparators.length===1&&menuItemsAndSeparators[0]==="separator"){return[];}
return menuItemsAndSeparators;}
get subMenuPosition(){const position=Object.assign({},this.subMenu.position);position.y-=this.subMenu.scrollOffset||0;return position;}
get popoverProps(){const isRoot=this.props.depth===1;return{anchorRect:{x:this.props.position.x-MENU_WIDTH*(this.props.depth-1),y:this.props.position.y,width:isRoot?0:MENU_WIDTH,height:isRoot?0:MENU_ITEM_HEIGHT,},positioning:"TopRight",verticalOffset:isRoot?0:MENU_VERTICAL_PADDING,onPopoverHidden:()=>this.closeSubMenu(),onPopoverMoved:()=>this.closeSubMenu(),};}
get childrenHaveIcon(){return this.props.menuItems.some((menuItem)=>!!this.getIconName(menuItem));}
getIconName(menu){if(menu.icon(this.env)){return menu.icon(this.env);}
if(menu.isActive?.(this.env)){return"o-spreadsheet-Icon.CHECK";}
return"";}
getColor(menu){return menu.textColor?`color: ${menu.textColor}`:undefined;}
async activateMenu(menu){const result=await menu.execute?.(this.env);this.close();this.props.onMenuClicked?.({detail:result});}
close(){this.closeSubMenu();this.props.onClose();}
onExternalClick(ev){const el=this.menuRef.el;if(el&&getOpenedMenus().some((el)=>isChildEvent(el,ev))){return;}
ev.closedMenuId=this.props.menuId;this.close();}
getName(menu){return menu.name(this.env);}
isRoot(menu){return!menu.execute;}
isEnabled(menu){if(menu.isEnabled(this.env)){return this.env.model.getters.isReadonly()?menu.isReadonlyAllowed:true;}
return false;}
onScroll(ev){this.subMenu.scrollOffset=ev.target.scrollTop;}
openSubMenu(menu,menuIndex,ev){const parentMenuEl=ev.currentTarget;if(!parentMenuEl)
return;const y=parentMenuEl.getBoundingClientRect().top;this.subMenu.position={x:this.position.x+this.props.depth*MENU_WIDTH,y:y-(this.subMenu.scrollOffset||0),};this.subMenu.menuItems=menu.children(this.env);this.subMenu.isOpen=true;this.subMenu.parentMenu=menu;}
isParentMenu(subMenu,menuItem){return subMenu.parentMenu?.id===menuItem.id;}
closeSubMenu(){this.subMenu.isOpen=false;this.subMenu.parentMenu=undefined;}
onClickMenu(menu,menuIndex,ev){if(this.isEnabled(menu)){if(this.isRoot(menu)){this.openSubMenu(menu,menuIndex,ev);}
else{this.activateMenu(menu);}}}
onMouseOver(menu,position,ev){if(this.isEnabled(menu)){if(this.isRoot(menu)){this.openSubMenu(menu,position,ev);}
else{this.closeSubMenu();}}}}
Menu.props={position:Object,menuItems:Array,depth:{type:Number,optional:true},maxHeight:{type:Number,optional:true},onClose:Function,onMenuClicked:{type:Function,optional:true},menuId:{type:String,optional:true},};const LINK_TOOLTIP_HEIGHT=32;const LINK_TOOLTIP_WIDTH=220;css`
  .o-link-tool {
    font-size: 13px;
    background-color: white;
    box-shadow: 0 1px 4px 3px rgba(60, 64, 67, 0.15);
    padding: 6px 12px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    height: ${LINK_TOOLTIP_HEIGHT}px;
    width: ${LINK_TOOLTIP_WIDTH}px;
    box-sizing: border-box !important;

    img {
      margin-right: 3px;
      width: 16px;
      height: 16px;
    }

    a.o-link {
      color: #01666b;
      text-decoration: none;
      flex-grow: 2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    a.o-link:hover {
      text-decoration: none;
      color: #001d1f;
      cursor: pointer;
    }
  }
  .o-link-icon {
    float: right;
    padding-left: 5px;
    .o-icon {
      height: 16px;
    }
  }
  .o-link-icon .o-icon {
    height: 13px;
  }
  .o-link-icon:hover {
    cursor: pointer;
    color: #000;
  }
`;class LinkDisplay extends owl.Component{static components={Menu};static template="o-spreadsheet-LinkDisplay";get cell(){const{col,row}=this.props.cellPosition;const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getEvaluatedCell({sheetId,col,row});}
get link(){if(this.cell.link){return this.cell.link;}
const{col,row}=this.props.cellPosition;throw new Error(`LinkDisplay Component can only be used with link cells. ${toXC(col, row)} is not a link.`);}
getUrlRepresentation(link){return urlRepresentation(link,this.env.model.getters);}
openLink(){openLink(this.link,this.env);}
edit(){const{col,row}=this.props.cellPosition;this.env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"LinkEditor",});}
unlink(){const sheetId=this.env.model.getters.getActiveSheetId();const{col,row}=this.props.cellPosition;const style=this.env.model.getters.getCellComputedStyle({sheetId,col,row});const textColor=style?.textColor===LINK_COLOR?undefined:style?.textColor;this.env.model.dispatch("UPDATE_CELL",{col,row,sheetId,content:this.link.label,style:{...style,textColor,underline:undefined},});}}
const LinkCellPopoverBuilder={onHover:(position,getters)=>{const cell=getters.getEvaluatedCell(position);const shouldDisplayLink=!getters.isDashboard()&&cell.link&&getters.isVisibleInViewport(position);if(!shouldDisplayLink)
return{isOpen:false};return{isOpen:true,Component:LinkDisplay,props:{cellPosition:position},cellCorner:"BottomLeft",};},};LinkDisplay.props={cellPosition:Object,onClosed:{type:Function,optional:true},};const POSTFIX_UNARY_OPERATORS=["%"];const OPERATORS="+,-,*,/,:,=,<>,>=,>,<=,<,^,&".split(",").concat(POSTFIX_UNARY_OPERATORS);function tokenize(str,locale=DEFAULT_LOCALE){str=replaceSpecialSpaces(str);const chars=new TokenizingChars(str);const result=[];while(!chars.isOver()){let token=tokenizeSpace(chars)||tokenizeArgsSeparator(chars,locale)||tokenizeParenthesis(chars)||tokenizeOperator(chars)||tokenizeString(chars)||tokenizeDebugger(chars)||tokenizeInvalidRange(chars)||tokenizeNumber(chars,locale)||tokenizeSymbol(chars);if(!token){token={type:"UNKNOWN",value:chars.shift()};}
result.push(token);}
return result;}
function tokenizeDebugger(chars){if(chars.current==="?"){chars.shift();return{type:"DEBUGGER",value:"?"};}
return null;}
const parenthesis={"(":{type:"LEFT_PAREN",value:"("},")":{type:"RIGHT_PAREN",value:")"},};function tokenizeParenthesis(chars){if(chars.current==="("||chars.current===")"){const value=chars.shift();return parenthesis[value];}
return null;}
function tokenizeArgsSeparator(chars,locale){if(chars.current===locale.formulaArgSeparator){const value=chars.shift();const type="ARG_SEPARATOR";return{type,value};}
return null;}
function tokenizeOperator(chars){for(let op of OPERATORS){if(chars.currentStartsWith(op)){chars.advanceBy(op.length);return{type:"OPERATOR",value:op};}}
return null;}
const FIRST_POSSIBLE_NUMBER_CHARS=new Set("0123456789");function tokenizeNumber(chars,locale){if(!FIRST_POSSIBLE_NUMBER_CHARS.has(chars.current)&&chars.current!==locale.decimalSeparator){return null;}
const match=chars.remaining().match(getFormulaNumberRegex(locale.decimalSeparator));if(match){chars.advanceBy(match[0].length);return{type:"NUMBER",value:match[0]};}
return null;}
function tokenizeString(chars){if(chars.current==='"'){const startChar=chars.shift();let letters=startChar;while(chars.current&&(chars.current!==startChar||letters[letters.length-1]==="\\")){letters+=chars.shift();}
if(chars.current==='"'){letters+=chars.shift();}
return{type:"STRING",value:letters,};}
return null;}
const separatorRegexp=/^[\w\.!\$]+/;function tokenizeSymbol(chars){let result="";if(chars.current==="'"){let lastChar=chars.shift();result+=lastChar;while(chars.current){lastChar=chars.shift();result+=lastChar;if(lastChar==="'"){if(chars.current&&chars.current==="'"){lastChar=chars.shift();result+=lastChar;}
else{break;}}}
if(lastChar!=="'"){return{type:"UNKNOWN",value:result,};}}
const match=chars.remaining().match(separatorRegexp);if(match){const value=match[0];result+=value;chars.advanceBy(value.length);}
if(result.length){const value=result;const isReference=rangeReference.test(value);if(isReference){return{type:"REFERENCE",value};}
return{type:"SYMBOL",value};}
return null;}
function tokenizeSpace(chars){let length=0;while(chars.current===NEWLINE){length++;chars.shift();}
if(length){return{type:"SPACE",value:NEWLINE.repeat(length)};}
while(chars.current===" "){length++;chars.shift();}
if(length){return{type:"SPACE",value:" ".repeat(length)};}
return null;}
function tokenizeInvalidRange(chars){if(chars.currentStartsWith(INCORRECT_RANGE_STRING)){chars.advanceBy(INCORRECT_RANGE_STRING.length);return{type:"INVALID_REFERENCE",value:INCORRECT_RANGE_STRING};}
return null;}
class TokenizingChars{text;currentIndex=0;current;constructor(text){this.text=text;this.current=text[0];}
shift(){const current=this.current;const next=this.text[++this.currentIndex];this.current=next;return current;}
advanceBy(length){this.currentIndex+=length;this.current=this.text[this.currentIndex];}
isOver(){return this.currentIndex>=this.text.length;}
remaining(){return this.text.substring(this.currentIndex);}
currentStartsWith(str){if(this.current!==str[0]){return false;}
for(let j=1;j<str.length;j++){if(this.text[this.currentIndex+j]!==str[j]){return false;}}
return true;}}
function isValidLocale(locale){if(!(locale&&typeof locale==="object"&&typeof locale.name==="string"&&typeof locale.code==="string"&&typeof locale.thousandsSeparator==="string"&&typeof locale.decimalSeparator==="string"&&typeof locale.dateFormat==="string"&&typeof locale.timeFormat==="string"&&typeof locale.formulaArgSeparator==="string")){return false;}
if(!Object.values(locale).every((v)=>v)){return false;}
if(locale.formulaArgSeparator===locale.decimalSeparator){return false;}
if(locale.thousandsSeparator===locale.decimalSeparator){return false;}
try{formatValue(1,{locale,format:"#,##0.00"});formatValue(1,{locale,format:locale.dateFormat});formatValue(1,{locale,format:locale.timeFormat});}
catch{return false;}
return true;}
function canonicalizeNumberContent(content,locale){return content.startsWith("=")?canonicalizeFormula$1(content,locale):canonicalizeNumberLiteral(content,locale);}
function canonicalizeContent(content,locale){return content.startsWith("=")?canonicalizeFormula$1(content,locale):canonicalizeLiteral(content,locale);}
function localizeContent(content,locale){return content.startsWith("=")?localizeFormula(content,locale):localizeLiteral(content,locale);}
function canonicalizeFormula$1(formula,locale){return _localizeFormula$1(formula,locale,DEFAULT_LOCALE);}
function localizeFormula(formula,locale){return _localizeFormula$1(formula,DEFAULT_LOCALE,locale);}
function _localizeFormula$1(formula,fromLocale,toLocale){if(fromLocale.formulaArgSeparator===toLocale.formulaArgSeparator&&fromLocale.decimalSeparator===toLocale.decimalSeparator){return formula;}
const tokens=tokenize(formula,fromLocale);let localizedFormula="";for(const token of tokens){if(token.type==="NUMBER"){localizedFormula+=token.value.replace(fromLocale.decimalSeparator,toLocale.decimalSeparator);}
else if(token.type==="ARG_SEPARATOR"){localizedFormula+=toLocale.formulaArgSeparator;}
else{localizedFormula+=token.value;}}
return localizedFormula;}
function canonicalizeNumberLiteral(content,locale){if(locale.decimalSeparator==="."||!isNumber(content,locale)){return content;}
return content.replace(locale.thousandsSeparator,"").replace(locale.decimalSeparator,".");}
function canonicalizeLiteral(content,locale){if(isDateTime(content,locale)){const dateNumber=toNumber(content,locale);let format=DEFAULT_LOCALE.dateFormat;if(!Number.isInteger(dateNumber)){format+=" "+DEFAULT_LOCALE.timeFormat;}
return formatValue(dateNumber,{locale:DEFAULT_LOCALE,format});}
return canonicalizeNumberLiteral(content,locale);}
function localizeNumberLiteral(literal,locale){if(locale.decimalSeparator==="."||!isNumber(literal,DEFAULT_LOCALE)){return literal;}
const decimalNumberRegex=getDecimalNumberRegex(DEFAULT_LOCALE);const localized=literal.replace(decimalNumberRegex,(match)=>{return match.replace(".",locale.decimalSeparator);});return localized;}
function localizeLiteral(literal,locale){if(isDateTime(literal,DEFAULT_LOCALE)){const dateNumber=toNumber(literal,DEFAULT_LOCALE);let format=locale.dateFormat;if(!Number.isInteger(dateNumber)){format+=" "+locale.timeFormat;}
return formatValue(dateNumber,{locale,format});}
return localizeNumberLiteral(literal,locale);}
function canonicalizeCFRule(cf,locale){return changeCFRuleLocale(cf,(content)=>canonicalizeContent(content,locale));}
function localizeCFRule(cf,locale){return changeCFRuleLocale(cf,(content)=>localizeContent(content,locale));}
function localizeDataValidationRule(rule,locale){const localizedDVRule=deepCopy(rule);localizedDVRule.criterion.values=localizedDVRule.criterion.values.map((content)=>localizeContent(content,locale));return localizedDVRule;}
function changeCFRuleLocale(rule,changeContentLocale){rule=deepCopy(rule);switch(rule.type){case"CellIsRule":switch(rule.operator){case"Between":case"NotBetween":case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":rule.values=rule.values.map((v)=>changeContentLocale(v));return rule;case"BeginsWith":case"ContainsText":case"EndsWith":case"NotContains":case"IsEmpty":case"IsNotEmpty":return rule;}
break;case"ColorScaleRule":rule.minimum=changeCFRuleThresholdLocale(rule.minimum,changeContentLocale);rule.maximum=changeCFRuleThresholdLocale(rule.maximum,changeContentLocale);if(rule.midpoint){rule.midpoint=changeCFRuleThresholdLocale(rule.midpoint,changeContentLocale);}
return rule;case"IconSetRule":rule.lowerInflectionPoint.value=changeContentLocale(rule.lowerInflectionPoint.value);rule.upperInflectionPoint.value=changeContentLocale(rule.upperInflectionPoint.value);return rule;}}
function changeCFRuleThresholdLocale(threshold,changeContentLocale){if(!threshold?.value){return threshold;}
const value=threshold.type==="formula"?"="+threshold.value:threshold.value;const modified=changeContentLocale(value);const newValue=threshold.type==="formula"?modified.slice(1):modified;return{...threshold,value:newValue};}
function getDateTimeFormat(locale){return locale.dateFormat+" "+locale.timeFormat;}
const linkSheet={name:_t("Link sheet"),children:[(env)=>{const sheets=env.model.getters.getSheetIds().map((sheetId)=>env.model.getters.getSheet(sheetId));return sheets.map((sheet)=>({id:sheet.id,name:sheet.name,execute:()=>markdownLink(sheet.name,buildSheetLink(sheet.id)),}));},],};const deleteSheet={name:_t("Delete"),isVisible:(env)=>{return env.model.getters.getSheetIds().length>1;},execute:(env)=>env.askConfirmation(_t("Are you sure you want to delete this sheet?"),()=>{env.model.dispatch("DELETE_SHEET",{sheetId:env.model.getters.getActiveSheetId()});}),};const duplicateSheet={name:_t("Duplicate"),execute:(env)=>{const sheetIdFrom=env.model.getters.getActiveSheetId();const sheetIdTo=env.model.uuidGenerator.uuidv4();env.model.dispatch("DUPLICATE_SHEET",{sheetId:sheetIdFrom,sheetIdTo,});env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom,sheetIdTo});},};const renameSheet=(args)=>{return{name:_t("Rename"),execute:args.renameSheetCallback,};};const sheetMoveRight={name:_t("Move right"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const sheetIds=env.model.getters.getVisibleSheetIds();return sheetIds.indexOf(sheetId)!==sheetIds.length-1;},execute:(env)=>env.model.dispatch("MOVE_SHEET",{sheetId:env.model.getters.getActiveSheetId(),delta:1,}),};const sheetMoveLeft={name:_t("Move left"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();return env.model.getters.getVisibleSheetIds()[0]!==sheetId;},execute:(env)=>env.model.dispatch("MOVE_SHEET",{sheetId:env.model.getters.getActiveSheetId(),delta:-1,}),};const hideSheet={name:_t("Hide sheet"),isVisible:(env)=>env.model.getters.getVisibleSheetIds().length!==1,execute:(env)=>env.model.dispatch("HIDE_SHEET",{sheetId:env.model.getters.getActiveSheetId()}),};class MenuItemRegistry extends Registry{add(key,value){if(value.id===undefined){value.id=key;}
this.content[key]=value;return this;}
addChild(key,path,value){if(typeof value!=="function"&&value.id===undefined){value.id=key;}
const root=path.splice(0,1)[0];let node=this.content[root];if(!node){throw new Error(`Path ${root + ":" + path.join(":")} not found`);}
for(let p of path){const children=node.children;if(!children||typeof children==="function"){throw new Error(`${p} is either not a node or it's dynamically computed`);}
node=children.find((elt)=>elt.id===p);if(!node){throw new Error(`Path ${root + ":" + path.join(":")} not found`);}}
if(!node.children){node.children=[];}
node.children.push(value);return this;}
getMenuItems(){return createActions(this.getAll());}}
const linkMenuRegistry=new MenuItemRegistry();linkMenuRegistry.add("sheet",{...linkSheet,sequence:10,});const MENU_OFFSET_X=320;const MENU_OFFSET_Y=100;const PADDING=12;const LINK_EDITOR_WIDTH=340;const LINK_EDITOR_HEIGHT=165;css`
  .o-link-editor {
    font-size: 13px;
    background-color: white;
    box-shadow: 0 1px 4px 3px rgba(60, 64, 67, 0.15);
    padding: ${PADDING}px;
    display: flex;
    flex-direction: column;
    border-radius: 4px;
    height: ${LINK_EDITOR_HEIGHT}px;
    width: ${LINK_EDITOR_WIDTH}px;

    .o-section {
      .o-section-title {
        font-weight: bold;
        color: dimgrey;
        margin-bottom: 5px;
      }
    }
    .o-buttons {
      padding-left: 16px;
      padding-top: 16px;
      padding-bottom: 16px;
      text-align: right;
    }
    input {
      box-sizing: border-box;
      width: 100%;
      border-radius: 4px;
      padding: 4px 23px 4px 10px;
      border: none;
      height: 24px;
      border: 1px solid lightgrey;
    }
    .o-link-url {
      position: relative;
      flex-grow: 1;
      button {
        position: absolute;
        right: 0px;
        top: 0px;
        border: none;
        height: 20px;
        width: 20px;
        background-color: #fff;
        margin: 2px 3px 1px 0px;
        padding: 0px 1px 0px 0px;
      }
      button:hover {
        cursor: pointer;
      }
    }
  }
`;class LinkEditor extends owl.Component{static template="o-spreadsheet-LinkEditor";static components={Menu};menuItems=linkMenuRegistry.getMenuItems();link=owl.useState(this.defaultState);menu=owl.useState({isOpen:false,});linkEditorRef=owl.useRef("linkEditor");position=useAbsoluteBoundingRect(this.linkEditorRef);urlInput=owl.useRef("urlInput");setup(){owl.onMounted(()=>this.urlInput.el?.focus());}
get defaultState(){const{col,row}=this.props.cellPosition;const sheetId=this.env.model.getters.getActiveSheetId();const cell=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(cell.link){return{url:cell.link.url,label:cell.formattedValue,isUrlEditable:cell.link.isUrlEditable,};}
return{label:cell.formattedValue,url:"",isUrlEditable:true,};}
get menuPosition(){return{x:this.position.x+MENU_OFFSET_X-PADDING-2,y:this.position.y+MENU_OFFSET_Y,};}
onSpecialLink(ev){const{detail:markdownLink}=ev;const link=detectLink(markdownLink);if(!link){return;}
this.link.url=link.url;this.link.label=link.label;this.link.isUrlEditable=link.isUrlEditable;}
getUrlRepresentation(link){return urlRepresentation(link,this.env.model.getters);}
openMenu(){this.menu.isOpen=true;}
removeLink(){this.link.url="";this.link.isUrlEditable=true;}
save(){const{col,row}=this.props.cellPosition;const locale=this.env.model.getters.getLocale();const label=this.link.label?canonicalizeNumberContent(this.link.label,locale):this.link.url;this.env.model.dispatch("UPDATE_CELL",{col:col,row:row,sheetId:this.env.model.getters.getActiveSheetId(),content:markdownLink(label,this.link.url),});this.props.onClosed?.();}
cancel(){this.props.onClosed?.();}
onKeyDown(ev){switch(ev.key){case"Enter":if(this.link.url){this.save();}
ev.stopPropagation();ev.preventDefault();break;case"Escape":this.cancel();ev.stopPropagation();break;}}}
const LinkEditorPopoverBuilder={onOpen:(position,getters)=>{return{isOpen:true,props:{cellPosition:position},Component:LinkEditor,cellCorner:"BottomLeft",};},};LinkEditor.props={cellPosition:Object,onClosed:{type:Function,optional:true},};const cellPopoverRegistry=new Registry();cellPopoverRegistry.add("ErrorToolTip",ErrorToolTipPopoverBuilder).add("LinkCell",LinkCellPopoverBuilder).add("LinkEditor",LinkEditorPopoverBuilder).add("FilterMenu",FilterMenuPopoverBuilder);function toXlsxHexColor(color){color=toHex(color).replace("#","");if(color.length===8){return color.slice(6)+color.slice(0,6);}
return color;}
const PasteInteractiveContent={wrongPasteSelection:_t("This operation is not allowed with multiple selections."),willRemoveExistingMerge:_t("This operation is not possible due to a merge. Please remove the merges first than try again."),wrongFigurePasteOption:_t("Cannot do a special paste of a figure."),frozenPaneOverlap:_t("This operation is not allowed due to an overlapping frozen pane."),};function handlePasteResult(env,result){if(!result.isSuccessful){if(result.reasons.includes("WrongPasteSelection")){env.raiseError(PasteInteractiveContent.wrongPasteSelection);}
else if(result.reasons.includes("WillRemoveExistingMerge")){env.raiseError(PasteInteractiveContent.willRemoveExistingMerge);}
else if(result.reasons.includes("WrongFigurePasteOption")){env.raiseError(PasteInteractiveContent.wrongFigurePasteOption);}
else if(result.reasons.includes("FrozenPaneOverlap")){env.raiseError(PasteInteractiveContent.frozenPaneOverlap);}}}
function interactivePaste(env,target,pasteOption){const result=env.model.dispatch("PASTE",{target,pasteOption});handlePasteResult(env,result);}
function interactivePasteFromOS(env,target,text,pasteOption){const result=env.model.dispatch("PASTE_FROM_OS_CLIPBOARD",{target,text,pasteOption});handlePasteResult(env,result);}
const CfTerms={Errors:{["InvalidRange"]:_t("The range is invalid"),["FirstArgMissing"]:_t("The argument is missing. Please provide a value"),["SecondArgMissing"]:_t("The second argument is missing. Please provide a value"),["MinNaN"]:_t("The minpoint must be a number"),["MidNaN"]:_t("The midpoint must be a number"),["MaxNaN"]:_t("The maxpoint must be a number"),["ValueUpperInflectionNaN"]:_t("The first value must be a number"),["ValueLowerInflectionNaN"]:_t("The second value must be a number"),["MinBiggerThanMax"]:_t("Minimum must be smaller then Maximum"),["MinBiggerThanMid"]:_t("Minimum must be smaller then Midpoint"),["MidBiggerThanMax"]:_t("Midpoint must be smaller then Maximum"),["LowerBiggerThanUpper"]:_t("Lower inflection point must be smaller than upper inflection point"),["MinInvalidFormula"]:_t("Invalid Minpoint formula"),["MaxInvalidFormula"]:_t("Invalid Maxpoint formula"),["MidInvalidFormula"]:_t("Invalid Midpoint formula"),["ValueUpperInvalidFormula"]:_t("Invalid upper inflection point formula"),["ValueLowerInvalidFormula"]:_t("Invalid lower inflection point formula"),["EmptyRange"]:_t("A range needs to be defined"),Unexpected:_t("The rule is invalid for an unknown reason"),},ColorScale:_t("Color scale"),IconSet:_t("Icon set"),};const CellIsOperators={IsEmpty:_t("Is empty"),IsNotEmpty:_t("Is not empty"),ContainsText:_t("Contains"),NotContains:_t("Does not contain"),BeginsWith:_t("Starts with"),EndsWith:_t("Ends with"),Equal:_t("Is equal to"),NotEqual:_t("Is not equal to"),GreaterThan:_t("Is greater than"),GreaterThanOrEqual:_t("Is greater than or equal to"),LessThan:_t("Is less than"),LessThanOrEqual:_t("Is less than or equal to"),Between:_t("Is between"),NotBetween:_t("Is not between"),};const ChartTerms={Series:_t("Series"),Errors:{Unexpected:_t("The chart definition is invalid for an unknown reason"),["InvalidDataSet"]:_t("The dataset is invalid"),["InvalidLabelRange"]:_t("Labels are invalid"),["InvalidScorecardKeyValue"]:_t("The key value is invalid"),["InvalidScorecardBaseline"]:_t("The baseline value is invalid"),["InvalidGaugeDataRange"]:_t("The data range is invalid"),["EmptyGaugeRangeMin"]:_t("A minimum range limit value is needed"),["GaugeRangeMinNaN"]:_t("The minimum range limit value must be a number"),["EmptyGaugeRangeMax"]:_t("A maximum range limit value is needed"),["GaugeRangeMaxNaN"]:_t("The maximum range limit value must be a number"),["GaugeRangeMinBiggerThanRangeMax"]:_t("Minimum range limit must be smaller than maximum range limit"),["GaugeLowerInflectionPointNaN"]:_t("The lower inflection point value must be a number"),["GaugeUpperInflectionPointNaN"]:_t("The upper inflection point value must be a number"),},};const CustomCurrencyTerms={Custom:_t("Custom"),};const MergeErrorMessage=_t("Merged cells are preventing this operation. Unmerge those cells and try again.");const SplitToColumnsTerms={Errors:{Unexpected:_t("Cannot split the selection for an unknown reason"),["NoSplitSeparatorInSelection"]:_t("There is no match for the selected separator in the selection"),["MoreThanOneColumnSelected"]:_t("Only a selection from a single column can be split"),["SplitWillOverwriteContent"]:_t("Splitting will overwrite existing content"),},};const RemoveDuplicateTerms={Errors:{Unexpected:_t("Cannot remove duplicates for an unknown reason"),["MoreThanOneRangeSelected"]:_t("Please select only one range of cells"),["EmptyTarget"]:_t("Please select a range of cells containing values."),["NoColumnsProvided"]:_t("Please select at latest one column to analyze."),["WillRemoveExistingMerge"]:PasteInteractiveContent.willRemoveExistingMerge,},};const DVTerms={DateIs:{today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("in the past week"),lastMonth:_t("in the past month"),lastYear:_t("in the past year"),},DateIsBefore:{today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("one week ago"),lastMonth:_t("one month ago"),lastYear:_t("one year ago"),},CriterionError:{notEmptyValue:_t("The value must not be empty"),numberValue:_t("The value must be a number"),dateValue:_t("The value must be a date"),validRange:_t("The value must be a valid range"),},};function getData(getters,ds){if(ds.dataRange){const labelCellZone=ds.labelCell?[zoneToXc(ds.labelCell.zone)]:[];const dataXC=recomputeZones([zoneToXc(ds.dataRange.zone)],labelCellZone)[0];if(dataXC===undefined){return[];}
const dataRange=getters.getRangeFromSheetXC(ds.dataRange.sheetId,dataXC);return getters.getRangeValues(dataRange).map((value)=>(value===""?undefined:value));}
return[];}
function filterEmptyDataPoints(labels,datasets){const numberOfDataPoints=Math.max(labels.length,...datasets.map((dataset)=>dataset.data?.length||0));const dataPointsIndexes=range(0,numberOfDataPoints).filter((dataPointIndex)=>{const label=labels[dataPointIndex];const values=datasets.map((dataset)=>dataset.data?.[dataPointIndex]);return label||values.some((value)=>value===0||Boolean(value));});return{labels:dataPointsIndexes.map((i)=>labels[i]||""),dataSetsValues:datasets.map((dataset)=>({...dataset,data:dataPointsIndexes.map((i)=>dataset.data[i]),})),};}
function aggregateDataForLabels(labels,datasets){const parseNumber=(value)=>(typeof value==="number"?value:0);const labelSet=new Set(labels);const labelMap={};labelSet.forEach((label)=>{labelMap[label]=new Array(datasets.length).fill(0);});for(const indexOfLabel of range(0,labels.length)){const label=labels[indexOfLabel];for(const indexOfDataset of range(0,datasets.length)){labelMap[label][indexOfDataset]+=parseNumber(datasets[indexOfDataset].data[indexOfLabel]);}}
return{labels:Array.from(labelSet),dataSetsValues:datasets.map((dataset,indexOfDataset)=>({...dataset,data:Array.from(labelSet).map((label)=>labelMap[label][indexOfDataset]),})),};}
function truncateLabel(label){if(!label){return"";}
if(label.length>MAX_CHAR_LABEL){return label.substring(0,MAX_CHAR_LABEL)+"…";}
return label;}
function getDefaultChartJsRuntime(chart,labels,fontColor,{format,locale}){const options={responsive:true,maintainAspectRatio:false,layout:{padding:{left:20,right:20,top:chart.title?10:25,bottom:10},},elements:{line:{fill:false,},point:{hitRadius:15,},},animation:false,plugins:{title:{display:!!chart.title,text:_t(chart.title),color:fontColor,font:{size:22,weight:"normal"},},legend:{onClick:()=>{},},tooltip:{callbacks:{label:function(tooltipItem){const xLabel=tooltipItem.dataset?.label||tooltipItem.label;const yLabel=tooltipItem.parsed.y??tooltipItem.parsed;const toolTipFormat=!format&&Math.abs(yLabel)>=1000?"#,##":format;const yLabelStr=formatValue(yLabel,{format:toolTipFormat,locale});return xLabel?`${xLabel}: ${yLabelStr}`:yLabelStr;},},},},};return{type:chart.type,options,data:{labels:labels.map(truncateLabel),datasets:[],},plugins:[],};}
function getChartLabelFormat(getters,range){if(!range)
return undefined;return getters.getEvaluatedCell({sheetId:range.sheetId,col:range.zone.left,row:range.zone.top,}).format;}
function getChartLabelValues(getters,dataSets,labelRange){let labels={values:[],formattedValues:[]};if(labelRange){if(!labelRange.invalidXc&&!labelRange.invalidSheetName){labels={formattedValues:getters.getRangeFormattedValues(labelRange),values:getters.getRangeValues(labelRange).map((val)=>String(val)),};}}
else if(dataSets.length===1){for(let i=0;i<getData(getters,dataSets[0]).length;i++){labels.formattedValues.push("");labels.values.push("");}}
else{if(dataSets[0]){const ranges=getData(getters,dataSets[0]);labels={formattedValues:range(0,ranges.length).map((r)=>r.toString()),values:labels.formattedValues,};}}
return labels;}
function getChartDatasetFormat(getters,dataSets){for(const ds of dataSets){const formatsInDataset=getters.getRangeFormats(ds.dataRange);const format=formatsInDataset.find((f)=>f!==undefined&&!isDateTimeFormat(f));if(format)
return format;}
return undefined;}
function getChartDatasetValues(getters,dataSets){const datasetValues=[];for(const[dsIndex,ds]of Object.entries(dataSets)){let label;if(ds.labelCell){const labelRange=ds.labelCell;const cell=labelRange?getters.getEvaluatedCell({sheetId:labelRange.sheetId,col:labelRange.zone.left,row:labelRange.zone.top,}):undefined;label=cell&&labelRange?truncateLabel(cell.formattedValue):(label=`${ChartTerms.Series} ${parseInt(dsIndex) + 1}`);}
else{label=label=`${ChartTerms.Series} ${parseInt(dsIndex) + 1}`;}
let data=ds.dataRange?getData(getters,ds):[];datasetValues.push({data,label});}
return datasetValues;}
function getFillingMode(index){if(index===0){return"origin";}
else{return index-1;}}
function chartToImage(runtime,figure,type){const div=document.createElement("div");div.style.width=`${figure.width}px`;div.style.height=`${figure.height}px`;const canvas=document.createElement("canvas");div.append(canvas);canvas.setAttribute("width",figure.width.toString());canvas.setAttribute("height",figure.height.toString());document.body.append(div);if("chartJsConfig"in runtime){runtime.chartJsConfig.plugins=[backgroundColorChartJSPlugin];const chart=new window.Chart(canvas,runtime.chartJsConfig);const imgContent=chart.toBase64Image();chart.destroy();div.remove();return imgContent;}
else if(type==="scorecard"){const design=getScorecardConfiguration(figure,runtime);drawScoreChart(design,canvas);const imgContent=canvas.toDataURL();div.remove();return imgContent;}
return"";}
const backgroundColorChartJSPlugin={id:"customCanvasBackgroundColor",beforeDraw:(chart)=>{const{ctx}=chart;ctx.save();ctx.globalCompositeOperation="destination-over";ctx.fillStyle="#ffffff";ctx.fillRect(0,0,chart.width,chart.height);ctx.restore();},};class BarChart extends AbstractChart{dataSets;labelRange;background;verticalAxisPosition;legendPosition;stacked;aggregated;type="bar";dataSetsHaveTitle;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createRange(getters,sheetId,definition.labelRange);this.background=definition.background;this.verticalAxisPosition=definition.verticalAxisPosition;this.legendPosition=definition.legendPosition;this.stacked=definition.stacked;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,stacked:false,aggregated:false,legendPosition:"top",title:context.title||"",type:"bar",verticalAxisPosition:"left",labelRange:context.auxiliaryRange||undefined,};}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new BarChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new BarChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"bar",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,verticalAxisPosition:this.verticalAxisPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,stacked:this.stacked,aggregated:this.aggregated,};}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),dataSets,labelRange,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new BarChart(definition,this.sheetId,this.getters);}}
function getBarConfiguration(chart,labels,localeFormat){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,localeFormat);const legend={labels:{color:fontColor},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
config.options.plugins.legend={...config.options.plugins?.legend,...legend};config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{padding:5,color:fontColor,},},y:{position:chart.verticalAxisPosition,beginAtZero:true,ticks:{color:fontColor,callback:(value)=>{value=Number(value);if(isNaN(value))
return value;const{locale,format}=localeFormat;return formatValue(value,{locale,format:!format&&Math.abs(value)>=1000?"#,##":format,});},},},};if(chart.stacked){config.options.scales.x.stacked=true;config.options.scales.y.stacked=true;}
return config;}
function createBarChartRuntime(chart,getters){const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const locale=getters.getLocale();const config=getBarConfiguration(chart,labels,{format:dataSetFormat,locale});const colors=new ChartColors();for(let{label,data}of dataSetsValues){const color=colors.next();const dataset={label,data,borderColor:color,backgroundColor:color,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
function isDataRangeValid(definition){return definition.dataRange&&!rangeReference.test(definition.dataRange)?"InvalidGaugeDataRange":"Success";}
function checkRangeLimits(check,batchValidations){return batchValidations((definition)=>{if(definition.sectionRule){return check(definition.sectionRule.rangeMin,"rangeMin");}
return"Success";},(definition)=>{if(definition.sectionRule){return check(definition.sectionRule.rangeMax,"rangeMax");}
return"Success";});}
function checkInflectionPointsValue(check,batchValidations){return batchValidations((definition)=>{if(definition.sectionRule){return check(definition.sectionRule.lowerInflectionPoint.value,"lowerInflectionPointValue");}
return"Success";},(definition)=>{if(definition.sectionRule){return check(definition.sectionRule.upperInflectionPoint.value,"upperInflectionPointValue");}
return"Success";});}
function checkRangeMinBiggerThanRangeMax(definition){if(definition.sectionRule){if(Number(definition.sectionRule.rangeMin)>=Number(definition.sectionRule.rangeMax)){return"GaugeRangeMinBiggerThanRangeMax";}}
return"Success";}
function checkEmpty(value,valueName){if(value===""){switch(valueName){case"rangeMin":return"EmptyGaugeRangeMin";case"rangeMax":return"EmptyGaugeRangeMax";}}
return"Success";}
function checkNaN(value,valueName){if(isNaN(value)){switch(valueName){case"rangeMin":return"GaugeRangeMinNaN";case"rangeMax":return"GaugeRangeMaxNaN";case"lowerInflectionPointValue":return"GaugeLowerInflectionPointNaN";case"upperInflectionPointValue":return"GaugeUpperInflectionPointNaN";}}
return"Success";}
class GaugeChart extends AbstractChart{dataRange;sectionRule;background;type="gauge";constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataRange=createRange(this.getters,this.sheetId,definition.dataRange);this.sectionRule=definition.sectionRule;this.background=definition.background;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,isDataRangeValid,validator.chainValidations(checkRangeLimits(checkEmpty,validator.batchValidations),checkRangeLimits(checkNaN,validator.batchValidations),checkRangeMinBiggerThanRangeMax),validator.chainValidations(checkInflectionPointsValue(checkNaN,validator.batchValidations)));}
static transformDefinition(definition,executed){let dataRangeZone;if(definition.dataRange){dataRangeZone=transformZone(toUnboundedZone(definition.dataRange),executed);}
return{...definition,dataRange:dataRangeZone?zoneToXc(dataRangeZone):undefined,};}
static getDefinitionFromContextCreation(context){return{background:context.background,title:context.title||"",type:"gauge",dataRange:context.range?context.range[0]:undefined,sectionRule:{colors:{lowerColor:DEFAULT_GAUGE_LOWER_COLOR,middleColor:DEFAULT_GAUGE_MIDDLE_COLOR,upperColor:DEFAULT_GAUGE_UPPER_COLOR,},rangeMin:"0",rangeMax:"100",lowerInflectionPoint:{type:"percentage",value:"15",},upperInflectionPoint:{type:"percentage",value:"40",},},};}
copyForSheetId(sheetId){const dataRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.dataRange);const definition=this.getDefinitionWithSpecificRanges(dataRange,sheetId);return new GaugeChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificRanges(this.dataRange,sheetId);return new GaugeChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificRanges(this.dataRange);}
getDefinitionWithSpecificRanges(dataRange,targetSheetId){return{background:this.background,sectionRule:this.sectionRule,title:this.title,type:"gauge",dataRange:dataRange?this.getters.getRangeString(dataRange,targetSheetId||this.sheetId):undefined,};}
getDefinitionForExcel(){return undefined;}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataRange?[this.getters.getRangeString(this.dataRange,this.sheetId)]:undefined,};}
updateRanges(applyChange){const range=adaptChartRange(this.dataRange,applyChange);if(this.dataRange===range){return this;}
const definition=this.getDefinitionWithSpecificRanges(range);return new GaugeChart(definition,this.sheetId,this.getters);}}
function getGaugeConfiguration(chart,locale){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,[],fontColor,{locale,});config.options.hover=undefined;config.options.events=[];config.options.layout={padding:{left:30,right:30,top:chart.title?10:25,bottom:25},};config.options.needle={width:10,borderColor:"#000000",backgroundColor:"#000000",};config.options.valueLabel={display:false,font:{size:30,color:"#FFFFFF",},backgroundColor:"#000000",borderColor:"#000000",borderRadius:5,padding:{top:5,right:5,bottom:5,left:5,},};return config;}
function createGaugeChartRuntime(chart,getters){const locale=getters.getLocale();const config=getGaugeConfiguration(chart,locale);const colors=chart.sectionRule.colors;const lowerPoint=chart.sectionRule.lowerInflectionPoint;const upperPoint=chart.sectionRule.upperInflectionPoint;const lowerPointValue=Number(lowerPoint.value);const upperPointValue=Number(upperPoint.value);const minNeedleValue=Number(chart.sectionRule.rangeMin);const maxNeedleValue=Number(chart.sectionRule.rangeMax);const needleCoverage=maxNeedleValue-minNeedleValue;const needleInflectionPoint=[];if(lowerPoint.value!==""){const lowerPointNeedleValue=lowerPoint.type==="number"?lowerPointValue:minNeedleValue+(needleCoverage*lowerPointValue)/100;needleInflectionPoint.push({value:clip(lowerPointNeedleValue,minNeedleValue,maxNeedleValue),color:colors.lowerColor,});}
if(upperPoint.value!==""){const upperPointNeedleValue=upperPoint.type==="number"?upperPointValue:minNeedleValue+(needleCoverage*upperPointValue)/100;needleInflectionPoint.push({value:clip(upperPointNeedleValue,minNeedleValue,maxNeedleValue),color:colors.middleColor,});}
const data=[];const backgroundColor=[];needleInflectionPoint.sort((a,b)=>a.value-b.value).map((point)=>{data.push(point.value);backgroundColor.push(point.color);});data.push(maxNeedleValue);backgroundColor.push(colors.upperColor);const dataRange=chart.dataRange;const deltaBeyondRangeLimit=needleCoverage/30;let needleValue=minNeedleValue-deltaBeyondRangeLimit;let cellFormatter=undefined;let displayValue=false;if(dataRange!==undefined){const cell=getters.getEvaluatedCell({sheetId:dataRange.sheetId,col:dataRange.zone.left,row:dataRange.zone.top,});if(cell.type===CellValueType.number){needleValue=clip(cell.value,minNeedleValue-deltaBeyondRangeLimit,maxNeedleValue+deltaBeyondRangeLimit);cellFormatter=()=>getters.getRangeFormattedValues(dataRange)[0];displayValue=true;}}
config.options.valueLabel.display=displayValue;config.options.valueLabel.formatter=cellFormatter;config.data.datasets.push({data,minValue:Number(chart.sectionRule.rangeMin),value:needleValue,backgroundColor,});return{chartJsConfig:config,background:getters.getStyleOfSingleCellChart(chart.background,dataRange).background,};}
const UNIT_LENGTH={second:1000,minute:1000*60,hour:1000*3600,day:1000*3600*24,month:1000*3600*24*30,year:1000*3600*24*365,};const Milliseconds={inSeconds:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.second);},inMinutes:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.minute);},inHours:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.hour);},inDays:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.day);},inMonths:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.month);},inYears:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.year);},};const timeFormatLuxonCompatible=/^((d|dd|m|mm|yyyy|yy|hh|h|ss|a)(-|:|\s|\/))*(d|dd|m|mm|yyyy|yy|hh|h|ss|a)$/i;function getChartTimeOptions(labels,labelFormat,locale){const luxonFormat=convertDateFormatForLuxon(labelFormat);const timeUnit=getBestTimeUnitForScale(labels,luxonFormat,locale);const displayFormats={};if(timeUnit){displayFormats[timeUnit]=luxonFormat;}
return{parser:luxonFormat,displayFormats,unit:timeUnit??false,};}
function convertDateFormatForLuxon(format){const indexH=format.indexOf("h");if(indexH>=0){format=format.slice(0,indexH).replace(/m/g,"M")+format.slice(indexH);}
else{format=format.replace(/m/g,"M");}
if(!format.includes("a")){format=format.replace(/h/g,"H");}
return format;}
function getFormatMinDisplayUnit(format){if(format.includes("s")){return"second";}
else if(format.includes("m")){return"minute";}
else if(format.includes("h")||format.includes("H")){return"hour";}
else if(format.includes("d")){return"day";}
else if(format.includes("M")){return"month";}
return"year";}
function getBestTimeUnitForScale(labels,format,locale){const labelDates=labels.map((label)=>parseDateTime(label,locale)?.jsDate);if(labelDates.some((date)=>date===undefined)||labels.length<2){return undefined;}
const labelsTimestamps=labelDates.map((date)=>date.getTime());const period=largeMax(labelsTimestamps)-largeMin(labelsTimestamps);const minUnit=getFormatMinDisplayUnit(format);if(UNIT_LENGTH.second>=UNIT_LENGTH[minUnit]&&Milliseconds.inSeconds(period)<180){return"second";}
else if(UNIT_LENGTH.minute>=UNIT_LENGTH[minUnit]&&Milliseconds.inMinutes(period)<180){return"minute";}
else if(UNIT_LENGTH.hour>=UNIT_LENGTH[minUnit]&&Milliseconds.inHours(period)<96){return"hour";}
else if(UNIT_LENGTH.day>=UNIT_LENGTH[minUnit]&&Milliseconds.inDays(period)<90){return"day";}
else if(UNIT_LENGTH.month>=UNIT_LENGTH[minUnit]&&Milliseconds.inMonths(period)<36){return"month";}
return"year";}
class LineChart extends AbstractChart{dataSets;labelRange;background;verticalAxisPosition;legendPosition;labelsAsText;stacked;aggregated;type="line";dataSetsHaveTitle;cumulative;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(this.getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createRange(this.getters,sheetId,definition.labelRange);this.background=definition.background;this.verticalAxisPosition=definition.verticalAxisPosition;this.legendPosition=definition.legendPosition;this.labelsAsText=definition.labelsAsText;this.stacked=definition.stacked;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;this.cumulative=definition.cumulative;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,labelsAsText:false,legendPosition:"top",title:context.title||"",type:"line",verticalAxisPosition:"left",labelRange:context.auxiliaryRange||undefined,stacked:false,aggregated:false,cumulative:false,};}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"line",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,verticalAxisPosition:this.verticalAxisPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,labelsAsText:this.labelsAsText,stacked:this.stacked,aggregated:this.aggregated,cumulative:this.cumulative,};}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new LineChart(definition,this.sheetId,this.getters);}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),dataSets,labelRange,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new LineChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new LineChart(definition,sheetId,this.getters);}}
function fixEmptyLabelsForDateCharts(labels,dataSetsValues){if(labels.length===0||labels.every((label)=>!label)){return{labels,dataSetsValues};}
const newLabels=[...labels];const newDatasets=deepCopy(dataSetsValues);for(let i=0;i<newLabels.length;i++){if(!newLabels[i]){newLabels[i]=findNextDefinedValue(newLabels,i);for(let ds of newDatasets){ds.data[i]=undefined;}}}
return{labels:newLabels,dataSetsValues:newDatasets};}
function canChartParseLabels(labelRange,getters){return canBeDateChart(labelRange,getters)||canBeLinearChart(labelRange,getters);}
function getChartAxisType(chart,getters){if(isDateChart(chart,getters)&&isLuxonTimeAdapterInstalled()){return"time";}
if(isLinearChart(chart,getters)){return"linear";}
return"category";}
function isDateChart(chart,getters){return!chart.labelsAsText&&canBeDateChart(chart.labelRange,getters);}
function isLinearChart(chart,getters){return!chart.labelsAsText&&canBeLinearChart(chart.labelRange,getters);}
function canBeDateChart(labelRange,getters){if(!labelRange||!canBeLinearChart(labelRange,getters)){return false;}
const labelFormat=getters.getEvaluatedCell({sheetId:labelRange.sheetId,col:labelRange.zone.left,row:labelRange.zone.top,}).format;return Boolean(labelFormat&&timeFormatLuxonCompatible.test(labelFormat));}
function canBeLinearChart(labelRange,getters){if(!labelRange){return false;}
const labels=getters.getRangeValues(labelRange);if(labels.some((label)=>isNaN(Number(label))&&label)){return false;}
if(labels.every((label)=>!label)){return false;}
return true;}
function getLineConfiguration(chart,labels,localeFormat){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,localeFormat);const legend={labels:{color:fontColor,generateLabels(chart){const{data}=chart;const labels=window.Chart.defaults.plugins.legend.labels.generateLabels(chart);for(const[index,label]of labels.entries()){label.fillStyle=data.datasets[index].borderColor;}
return labels;},},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
Object.assign(config.options.plugins.legend||{},legend);config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{padding:5,color:fontColor,},},y:{position:chart.verticalAxisPosition,beginAtZero:true,ticks:{color:fontColor,callback:(value)=>{value=Number(value);if(isNaN(value))
return value;const{locale,format}=localeFormat;return formatValue(value,{locale,format:!format&&Math.abs(value)>=1000?"#,##":format,});},},},};if(chart.stacked&&config.options?.scales?.y){config.options.scales.y.stacked=true;}
return config;}
function createLineChartRuntime(chart,getters){const axisType=getChartAxisType(chart,getters);const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=axisType==="linear"?labelValues.values:labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(axisType==="time"){({labels,dataSetsValues}=fixEmptyLabelsForDateCharts(labels,dataSetsValues));}
if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const locale=getters.getLocale();const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const localeFormat={format:dataSetFormat,locale};const config=getLineConfiguration(chart,labels,localeFormat);const labelFormat=getChartLabelFormat(getters,chart.labelRange);if(axisType==="time"){const axis={type:"time",time:getChartTimeOptions(labels,labelFormat,locale),};Object.assign(config.options.scales.x,axis);config.options.scales.x.ticks.maxTicksLimit=15;}
else if(axisType==="linear"){config.options.scales.x.type="linear";config.options.scales.x.ticks.callback=(value)=>formatValue(value,{format:labelFormat,locale});config.options.plugins.tooltip.callbacks.title=(tooltipItem)=>{return formatValue(tooltipItem[0].parsed.x||tooltipItem[0].label,{locale,format:labelFormat,});};}
const colors=new ChartColors();for(let[index,{label,data}]of dataSetsValues.entries()){if(["linear","time"].includes(axisType)){data=data.map((y,index)=>({x:labels[index]||undefined,y}));}
const color=colors.next();let backgroundRGBA=colorToRGBA(color);if(chart.stacked){backgroundRGBA.a=LINE_FILL_TRANSPARENCY;}
if(chart.cumulative){let accumulator=0;data=data.map((value)=>{if(!isNaN(value)){accumulator+=parseFloat(value);return accumulator;}
return value;});}
const backgroundColor=rgbaToHex(backgroundRGBA);const dataset={label,data,tension:0,borderColor:color,backgroundColor,pointBackgroundColor:color,fill:chart.stacked?getFillingMode(index):false,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
let missingTimeAdapterAlreadyWarned=false;function isLuxonTimeAdapterInstalled(){if(!window.Chart){return false;}
const adapter=new window.Chart._adapters._date({});const isInstalled=adapter._id==="luxon";if(!isInstalled&&!missingTimeAdapterAlreadyWarned){missingTimeAdapterAlreadyWarned=true;console.warn("'chartjs-adapter-luxon' time adapter is not installed. Time scale axes are disabled.");}
return isInstalled;}
class PieChart extends AbstractChart{dataSets;labelRange;background;legendPosition;type="pie";aggregated;dataSetsHaveTitle;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createRange(getters,sheetId,definition.labelRange);this.background=definition.background;this.legendPosition=definition.legendPosition;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,legendPosition:"top",title:context.title||"",type:"pie",labelRange:context.auxiliaryRange||undefined,aggregated:false,};}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"pie",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,aggregated:this.aggregated,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new PieChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new PieChart(definition,sheetId,this.getters);}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),verticalAxisPosition:"left",dataSets,labelRange,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new PieChart(definition,this.sheetId,this.getters);}}
function getPieConfiguration(chart,labels,localeFormat){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,localeFormat);const legend={labels:{color:fontColor},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
Object.assign(config.options.plugins.legend||{},legend);config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.plugins.tooltip.callbacks.title=function(tooltipItems){return tooltipItems[0].dataset.label;};config.options.plugins.tooltip.callbacks.label=function(tooltipItem){const{format,locale}=localeFormat;const data=tooltipItem.dataset.data;const dataIndex=tooltipItem.dataIndex;const percentage=calculatePercentage(data,dataIndex);const xLabel=tooltipItem.label||tooltipItem.dataset.label;const yLabel=tooltipItem.parsed.y??tooltipItem.parsed;const toolTipFormat=!format&&Math.abs(yLabel)>=1000?"#,##":format;const yLabelStr=formatValue(yLabel,{format:toolTipFormat,locale});return xLabel?`${xLabel}: ${yLabelStr} (${percentage}%)`:`${yLabelStr} (${percentage}%)`;};return config;}
function getPieColors(colors,dataSetsValues){const pieColors=[];const maxLength=largeMax(dataSetsValues.map((ds)=>ds.data.length));for(let i=0;i<=maxLength;i++){pieColors.push(colors.next());}
return pieColors;}
function calculatePercentage(dataset,dataIndex){const numericData=dataset.filter((value)=>typeof value==="number");const total=numericData.reduce((sum,value)=>sum+value,0);if(!total){return"";}
const percentage=(dataset[dataIndex]/total)*100;return percentage.toFixed(2);}
function createPieChartRuntime(chart,getters){const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const locale=getters.getLocale();const config=getPieConfiguration(chart,labels,{format:dataSetFormat,locale});const colors=new ChartColors();for(let{label,data}of dataSetsValues){const backgroundColor=getPieColors(colors,dataSetsValues);const dataset={label,data,borderColor:"#FFFFFF",backgroundColor,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
const chartRegistry=new Registry();chartRegistry.add("bar",{match:(type)=>type==="bar",createChart:(definition,sheetId,getters)=>new BarChart(definition,sheetId,getters),getChartRuntime:createBarChartRuntime,validateChartDefinition:(validator,definition)=>BarChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>BarChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>BarChart.getDefinitionFromContextCreation(context),name:_t("Bar"),sequence:10,});chartRegistry.add("line",{match:(type)=>type==="line",createChart:(definition,sheetId,getters)=>new LineChart(definition,sheetId,getters),getChartRuntime:createLineChartRuntime,validateChartDefinition:(validator,definition)=>LineChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>LineChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>LineChart.getDefinitionFromContextCreation(context),name:_t("Line"),sequence:20,});chartRegistry.add("pie",{match:(type)=>type==="pie",createChart:(definition,sheetId,getters)=>new PieChart(definition,sheetId,getters),getChartRuntime:createPieChartRuntime,validateChartDefinition:(validator,definition)=>PieChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>PieChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>PieChart.getDefinitionFromContextCreation(context),name:_t("Pie"),sequence:30,});chartRegistry.add("scorecard",{match:(type)=>type==="scorecard",createChart:(definition,sheetId,getters)=>new ScorecardChart$1(definition,sheetId,getters),getChartRuntime:createScorecardChartRuntime,validateChartDefinition:(validator,definition)=>ScorecardChart$1.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>ScorecardChart$1.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>ScorecardChart$1.getDefinitionFromContextCreation(context),name:_t("Scorecard"),sequence:40,});chartRegistry.add("gauge",{match:(type)=>type==="gauge",createChart:(definition,sheetId,getters)=>new GaugeChart(definition,sheetId,getters),getChartRuntime:createGaugeChartRuntime,validateChartDefinition:(validator,definition)=>GaugeChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>GaugeChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>GaugeChart.getDefinitionFromContextCreation(context),name:_t("Gauge"),sequence:50,});const chartComponentRegistry=new Registry();chartComponentRegistry.add("line",ChartJsComponent);chartComponentRegistry.add("bar",ChartJsComponent);chartComponentRegistry.add("pie",ChartJsComponent);chartComponentRegistry.add("gauge",ChartJsComponent);chartComponentRegistry.add("scorecard",ScorecardChart);const currenciesRegistry=new Registry();css`
  .o-chart-container {
    width: 100%;
    height: 100%;
    position: relative;
  }
`;class ChartFigure extends owl.Component{static template="o-spreadsheet-ChartFigure";static components={};onDoubleClick(){this.env.model.dispatch("SELECT_FIGURE",{id:this.props.figure.id});this.env.openSidePanel("ChartPanel");}
get chartType(){return this.env.model.getters.getChartType(this.props.figure.id);}
get chartComponent(){const type=this.chartType;const component=chartComponentRegistry.get(type);if(!component){throw new Error(`Component is not defined for type ${type}`);}
return component;}}
ChartFigure.props={figure:Object,onFigureDeleted:Function,};class ImageFigure extends owl.Component{static template="o-spreadsheet-ImageFigure";static components={};get figureId(){return this.props.figure.id;}
get getImagePath(){return this.env.model.getters.getImagePath(this.figureId);}}
ImageFigure.props={figure:Object,onFigureDeleted:Function,};function centerFigurePosition(getters,size){const{x:offsetCorrectionX,y:offsetCorrectionY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();const dim=getters.getSheetViewDimension();const rect=getters.getVisibleRect(getters.getActiveMainViewport());const scrollableViewportWidth=Math.min(rect.width,dim.width-offsetCorrectionX);const scrollableViewportHeight=Math.min(rect.height,dim.height-offsetCorrectionY);const position={x:offsetCorrectionX+scrollX+Math.max(0,(scrollableViewportWidth-size.width)/2),y:offsetCorrectionY+scrollY+Math.max(0,(scrollableViewportHeight-size.height)/2),};return position;}
function getMaxFigureSize(getters,figureSize){const size=deepCopy(figureSize);const dim=getters.getSheetViewDimension();const maxWidth=dim.width;const maxHeight=dim.height;if(size.width>maxWidth){const ratio=maxWidth/size.width;size.width=maxWidth;size.height=size.height*ratio;}
if(size.height>maxHeight){const ratio=maxHeight/size.height;size.height=maxHeight;size.width=size.width*ratio;}
return size;}
const figureRegistry=new Registry();figureRegistry.add("chart",{Component:ChartFigure,SidePanelComponent:"ChartPanel",menuBuilder:getChartMenu,});figureRegistry.add("image",{Component:ImageFigure,keepRatio:true,minFigSize:20,borderWidth:0,menuBuilder:getImageMenuRegistry,});function getChartMenu(figureId,onFigureDeleted,env){const menuItemSpecs=[{id:"edit",name:_t("Edit"),sequence:1,execute:()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.openSidePanel("ChartPanel");},icon:"o-spreadsheet-Icon.EDIT",},getCopyMenuItem(figureId,env),getCutMenuItem(figureId,env),getDeleteMenuItem(figureId,onFigureDeleted,env),];return createActions(menuItemSpecs);}
function getImageMenuRegistry(figureId,onFigureDeleted,env){const menuItemSpecs=[getCopyMenuItem(figureId,env),getCutMenuItem(figureId,env),{id:"reset_size",name:_t("Reset size"),sequence:4,execute:async()=>{const imagePath=env.model.getters.getImagePath(figureId);const size=env.model.getters.getImageSize(figureId)??(await env.imageProvider?.getImageOriginalSize(imagePath));if(!env.model.getters.getImageSize(figureId)){const image=env.model.getters.getImage(figureId);image.size=size;}
const{height,width}=getMaxFigureSize(env.model.getters,size);env.model.dispatch("UPDATE_FIGURE",{sheetId:env.model.getters.getActiveSheetId(),id:figureId,height,width,});},icon:"o-spreadsheet-Icon.REFRESH",},getDeleteMenuItem(figureId,onFigureDeleted,env),];return createActions(menuItemSpecs);}
function getCopyMenuItem(figureId,env){return{id:"copy",name:_t("Copy"),sequence:2,description:"Ctrl+C",execute:async()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.model.dispatch("COPY");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.COPY",};}
function getCutMenuItem(figureId,env){return{id:"cut",name:_t("Cut"),sequence:3,description:"Ctrl+X",execute:async()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.model.dispatch("CUT");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.CUT",};}
function getDeleteMenuItem(figureId,onFigureDeleted,env){return{id:"delete",name:_t("Delete"),sequence:10,execute:()=>{env.model.dispatch("DELETE_FIGURE",{sheetId:env.model.getters.getActiveSheetId(),id:figureId,});onFigureDeleted();},icon:"o-spreadsheet-Icon.DELETE",};}
const inverseCommandRegistry=new Registry().add("ADD_COLUMNS_ROWS",inverseAddColumnsRows).add("REMOVE_COLUMNS_ROWS",inverseRemoveColumnsRows).add("ADD_MERGE",inverseAddMerge).add("REMOVE_MERGE",inverseRemoveMerge).add("CREATE_SHEET",inverseCreateSheet).add("DELETE_SHEET",inverseDeleteSheet).add("DUPLICATE_SHEET",inverseDuplicateSheet).add("CREATE_FIGURE",inverseCreateFigure).add("CREATE_CHART",inverseCreateChart).add("HIDE_COLUMNS_ROWS",inverseHideColumnsRows).add("UNHIDE_COLUMNS_ROWS",inverseUnhideColumnsRows);for(const cmd of coreTypes.values()){if(!inverseCommandRegistry.contains(cmd)){inverseCommandRegistry.add(cmd,identity);}}
function identity(cmd){return[cmd];}
function inverseAddColumnsRows(cmd){const elements=[];let start=cmd.base;if(cmd.position==="after"){start++;}
for(let i=0;i<cmd.quantity;i++){elements.push(i+start);}
return[{type:"REMOVE_COLUMNS_ROWS",dimension:cmd.dimension,elements,sheetId:cmd.sheetId,},];}
function inverseAddMerge(cmd){return[{type:"REMOVE_MERGE",sheetId:cmd.sheetId,target:cmd.target}];}
function inverseRemoveMerge(cmd){return[{type:"ADD_MERGE",sheetId:cmd.sheetId,target:cmd.target}];}
function inverseCreateSheet(cmd){return[{type:"DELETE_SHEET",sheetId:cmd.sheetId}];}
function inverseDuplicateSheet(cmd){return[{type:"DELETE_SHEET",sheetId:cmd.sheetIdTo}];}
function inverseRemoveColumnsRows(cmd){const commands=[];const elements=[...cmd.elements].sort((a,b)=>a-b);for(let group of groupConsecutive(elements)){const column=group[0]===0?0:group[0]-1;const position=group[0]===0?"before":"after";commands.push({type:"ADD_COLUMNS_ROWS",dimension:cmd.dimension,quantity:group.length,base:column,sheetId:cmd.sheetId,position,});}
return commands;}
function inverseDeleteSheet(cmd){return[{type:"CREATE_SHEET",sheetId:cmd.sheetId,position:1}];}
function inverseCreateFigure(cmd){return[{type:"DELETE_FIGURE",id:cmd.figure.id,sheetId:cmd.sheetId}];}
function inverseCreateChart(cmd){return[{type:"DELETE_FIGURE",id:cmd.id,sheetId:cmd.sheetId}];}
function inverseHideColumnsRows(cmd){return[{type:"UNHIDE_COLUMNS_ROWS",sheetId:cmd.sheetId,dimension:cmd.dimension,elements:cmd.elements,},];}
function inverseUnhideColumnsRows(cmd){return[{type:"HIDE_COLUMNS_ROWS",sheetId:cmd.sheetId,dimension:cmd.dimension,elements:cmd.elements,},];}
function interactiveCut(env){const result=env.model.dispatch("CUT");if(!result.isSuccessful){if(result.isCancelledBecause("WrongCutSelection")){env.raiseError(_t("This operation is not allowed with multiple selections."));}}}
const AddMergeInteractiveContent={MergeIsDestructive:_t("Merging these cells will only preserve the top-leftmost value. Merge anyway?"),MergeInFilter:_t("You can't merge cells inside of an existing filter."),};function interactiveAddMerge(env,sheetId,target){const result=env.model.dispatch("ADD_MERGE",{sheetId,target});if(result.isCancelledBecause("MergeInFilter")){env.raiseError(AddMergeInteractiveContent.MergeInFilter);}
else if(result.isCancelledBecause("MergeIsDestructive")){env.askConfirmation(AddMergeInteractiveContent.MergeIsDestructive,()=>{env.model.dispatch("ADD_MERGE",{sheetId,target,force:true});});}}
function chartFactory(getters){const builders=chartRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);function createChart(id,definition,sheetId){const builder=builders.find((builder)=>builder.match(definition.type));if(!builder){throw new Error(`No builder for this chart: ${definition.type}`);}
return builder.createChart(definition,sheetId,getters);}
return createChart;}
function chartRuntimeFactory(getters){const builders=chartRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);function createRuntimeChart(chart){const builder=builders.find((builder)=>builder.match(chart.type));if(!builder){throw new Error("No runtime builder for this chart.");}
return builder.getChartRuntime(chart,getters);}
return createRuntimeChart;}
function validateChartDefinition(validator,definition){const validators=chartRegistry.getAll().find((validator)=>validator.match(definition.type));if(!validators){throw new Error("Unknown chart type.");}
return validators.validateChartDefinition(validator,definition);}
function transformDefinition(definition,executed){const transformation=chartRegistry.getAll().find((factory)=>factory.match(definition.type));if(!transformation){throw new Error("Unknown chart type.");}
return transformation.transformDefinition(definition,executed);}
function getChartDefinitionFromContextCreation(context,type){const chartClass=chartRegistry.get(type);return chartClass.getChartDefinitionFromContextCreation(context);}
function getChartTypes(){const result={};for(const key of chartRegistry.getKeys()){result[key]=chartRegistry.get(key).name;}
return result;}
function getSmartChartDefinition(zone,getters){let dataSetZone=zone;if(zone.left!==zone.right){dataSetZone={...zone,left:zone.left+1};}
const dataSets=[zoneToXc(dataSetZone)];const sheetId=getters.getActiveSheetId();const topLeftCell=getters.getCell({sheetId,col:zone.left,row:zone.top});if(getZoneArea(zone)===1&&topLeftCell?.content){return{type:"scorecard",title:"",background:topLeftCell.style?.fillColor||undefined,keyValue:zoneToXc(zone),baselineMode:DEFAULT_SCORECARD_BASELINE_MODE,baselineColorUp:DEFAULT_SCORECARD_BASELINE_COLOR_UP,baselineColorDown:DEFAULT_SCORECARD_BASELINE_COLOR_DOWN,};}
let title="";const cellsInFirstRow=getters.getEvaluatedCellsInZone(sheetId,{...dataSetZone,bottom:dataSetZone.top,});const dataSetsHaveTitle=!!cellsInFirstRow.find((cell)=>cell.type!==CellValueType.empty&&cell.type!==CellValueType.number);if(dataSetsHaveTitle){const texts=cellsInFirstRow.filter((cell)=>cell.type!==CellValueType.error&&cell.type!==CellValueType.empty).map((cell)=>cell.formattedValue);const lastElement=texts.splice(-1)[0];title=texts.join(", ");if(lastElement){title+=(title?" "+_t("and")+" ":"")+lastElement;}}
let labelRangeXc;if(zone.left!==zone.right){labelRangeXc=zoneToXc({...zone,right:zone.left,});}
const newLegendPos=dataSetZone.right===dataSetZone.left?"none":"top";const labelRange=labelRangeXc?getters.getRangeFromSheetXC(sheetId,labelRangeXc):undefined;if(canChartParseLabels(labelRange,getters)){return{title,dataSets,labelsAsText:false,stacked:false,aggregated:false,cumulative:false,labelRange:labelRangeXc,type:"line",dataSetsHaveTitle,verticalAxisPosition:"left",legendPosition:newLegendPos,};}
return{title,dataSets,labelRange:labelRangeXc,type:"bar",stacked:false,aggregated:false,dataSetsHaveTitle,verticalAxisPosition:"left",legendPosition:newLegendPos,};}
if(window.Chart){const DoughnutController=window.Chart?.DoughnutController;class GaugeController extends DoughnutController{static id="gauge";static defaults={...DoughnutController.defaults,circumference:180,rotation:270,};static overrides={aspectRatio:2,plugins:{legend:{display:false,},tooltip:{enabled:false,},},};get chartHeight(){return Math.abs(this.chart.chartArea.top-this.chart.chartArea.bottom);}
get chartWidth(){return Math.abs(this.chart.chartArea.left-this.chart.chartArea.right);}
get needleOptions(){const{config}=this.chart;const options=config.options;return options?.needle||{};}
get valueLabelOptions(){const{config}=this.chart;const options=config.options;return options?.valueLabel||{};}
get minValue(){const dataset=this.getDataset();return dataset.minValue||0;}
getValueAngleInPercent(value){const dataset=this.getDataset();const data=dataset.data||[];const max=Math.max(...data);const min=this.minValue;return(value-min)/(max-min);}
drawValueLabel(params){const{ctx}=this.chart;if(this.valueLabelOptions.display===false){return;}
ctx.save();ctx.beginPath();ctx.fillStyle=params.valueLabel.backgroundColor;ctx.strokeStyle=params.valueLabel.borderColor;ctx.roundRect(params.valueLabel.rect.x,params.valueLabel.rect.y,params.valueLabel.rect.width,params.valueLabel.rect.height,params.valueLabel.borderRadius);ctx.stroke();ctx.fill();ctx.textAlign="center";ctx.textBaseline="middle";ctx.font=params.valueLabel.font;ctx.fillStyle=params.valueLabel.textColor;ctx.fillText(params.valueLabel.valueText,params.valueLabel.textPosition.x,params.valueLabel.textPosition.y);ctx.restore();}
drawNeedle(params){const{ctx}=this.chart;if(this.needleOptions.display===false){return;}
ctx.save();ctx.translate(params.needle.position.x,params.needle.position.y);ctx.rotate(-Math.PI/2+Math.PI*params.needle.percent);ctx.beginPath();ctx.fillStyle=params.needle.backgroundColor;ctx.strokeStyle=params.needle.borderColor;ctx.ellipse(0,0,params.needle.width/2,params.needle.width/2,0,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.closePath();ctx.fillStyle=params.needle.backgroundColor;ctx.strokeStyle=params.needle.borderColor;ctx.beginPath();ctx.moveTo(-params.needle.width/2,0);ctx.lineTo(0,-params.needle.height+10);ctx.lineTo(+params.needle.width/2,0);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();}
computeRenderingParams(){const{ctx,config}=this.chart;const options=config.options;options.layout=options.layout||{};options.layout.padding=options.layout.padding||{};const formatter=this.valueLabelOptions.formatter;const fmt=typeof formatter==="function"?formatter:(value)=>value;const dataset=this.getDataset();const value=dataset.value||0;const valueText=fmt(value).toString();const percent=this.getValueAngleInPercent(value);const fontFamily=this.valueLabelOptions.font?.family||"Arial";const optionsFontSize=this.valueLabelOptions.font?.size||0;const fontSize=optionsFontSize>=1?optionsFontSize:30;const font=`${fontSize}px ${fontFamily}`;const padding={right:0,left:0,top:0,bottom:0,...this.valueLabelOptions.padding,};padding.left=padding.left>=0?padding.left:10;padding.right=padding.right>=0?padding.right:10;padding.top=padding.top>=0?padding.top:10;padding.bottom=padding.bottom>=0?padding.bottom:10;const chartArea=this.chart.chartArea;const offsetX=this.offsetX||0;const offsetY=this.offsetY||0;const centerX=(chartArea.left+chartArea.right)/2;const centerY=(chartArea.top+chartArea.bottom)/2;const center={x:centerX+offsetX,y:centerY+offsetY,};const textPosition={x:center.x,y:center.y,};ctx.save();ctx.font=font;const metrics=ctx.measureText(valueText);ctx.restore();const textHeight=metrics.fontBoundingBoxAscent-metrics.fontBoundingBoxDescent;return{needle:{borderColor:this.needleOptions.borderColor||"#000",backgroundColor:this.needleOptions.backgroundColor||"#000",width:this.needleOptions.width||10,height:Math.min(this.chartHeight,this.chartWidth/2),position:{x:textPosition.x,y:textPosition.y,},percent,},valueLabel:{textColor:this.valueLabelOptions.font?.color||"#FFF",backgroundColor:this.valueLabelOptions.backgroundColor||"#000",borderColor:this.valueLabelOptions.borderColor||"#000",borderRadius:this.valueLabelOptions.borderRadius||10,rect:{x:center.x-metrics.width/2-padding.left,y:center.y+textHeight/2+padding.top,width:metrics.width+padding.left+padding.right,height:-(textHeight+6+padding.top+padding.bottom),},valueText,textPosition,textHeight,font,},};}
draw(){super.draw();const params=this.computeRenderingParams();this.drawNeedle(params);this.drawValueLabel(params);}
updateElements(elements,start,count,mode){super.updateElements(elements,start,count,mode);const dataset=this.getDataset();const data=this.getDataset().data;const minValue=dataset.minValue;const rotation=this.chart.options.rotation||0;const circumference=this.chart.options.circumference||0;for(let arcIndex=0;arcIndex<data.length;arcIndex++){const previousValue=arcIndex===0?minValue:data[arcIndex-1];const startAngleInPercent=this.getValueAngleInPercent(previousValue);const endAngleInPercent=this.getValueAngleInPercent(data[arcIndex]);const startAngle=degreesToRadians(rotation+circumference*startAngleInPercent)-Math.PI/2;const endAngle=degreesToRadians(rotation+circumference*endAngleInPercent)-Math.PI/2;const arcCircumference=endAngle-startAngle;const arc=elements[arcIndex];const propertiesUpdates={startAngle,endAngle,circumference:arcCircumference,};this.updateElement(arc,arcIndex,propertiesUpdates,mode);}}}
function degreesToRadians(degrees){return(degrees*Math.PI)/180;}
window.Chart.register(GaugeController);}
function setFormatter(env,format){env.model.dispatch("CANCEL_EDITION");env.model.dispatch("SET_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),format,});}
function setStyle(env,style){env.model.dispatch("SET_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),style,});}
const PASTE_ACTION=async(env)=>paste$1(env);const PASTE_VALUE_ACTION=async(env)=>paste$1(env,"onlyValue");async function paste$1(env,pasteOption){const spreadsheetClipboard=env.model.getters.getClipboardTextContent();const osClipboard=await env.clipboard.readText();switch(osClipboard.status){case"ok":const target=env.model.getters.getSelectedZones();if(osClipboard&&osClipboard.content!==spreadsheetClipboard){interactivePasteFromOS(env,target,osClipboard.content,pasteOption);}
else{interactivePaste(env,target,pasteOption);}
if(env.model.getters.isCutOperation()&&pasteOption!=="onlyValue"){await env.clipboard.write({[ClipboardMIMEType.PlainText]:""});}
break;case"notImplemented":env.raiseError(_t("Pasting from the context menu is not supported in this browser. Use keyboard shortcuts ctrl+c / ctrl+v instead."));break;case"permissionDenied":env.raiseError(_t("Access to the clipboard denied by the browser. Please enable clipboard permission for this page in your browser settings."));break;}}
const PASTE_FORMAT_ACTION=(env)=>paste$1(env,"onlyFormat");const DELETE_CONTENT_ROWS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Clear rows");}
let first;let last;const activesRows=env.model.getters.getActiveRows();if(activesRows.size!==0){first=largeMin([...activesRows]);last=largeMax([...activesRows]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.top;last=zone.bottom;}
if(first===last){return _t("Clear row %s",(first+1).toString());}
return _t("Clear rows %s - %s",(first+1).toString(),(last+1).toString());};const DELETE_CONTENT_ROWS_ACTION=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const target=[...env.model.getters.getActiveRows()].map((index)=>env.model.getters.getRowsZone(sheetId,index,index));env.model.dispatch("DELETE_CONTENT",{target,sheetId:env.model.getters.getActiveSheetId(),});};const DELETE_CONTENT_COLUMNS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Clear columns");}
let first;let last;const activeCols=env.model.getters.getActiveCols();if(activeCols.size!==0){first=largeMin([...activeCols]);last=largeMax([...activeCols]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.left;last=zone.right;}
if(first===last){return _t("Clear column %s",numberToLetters(first));}
return _t("Clear columns %s - %s",numberToLetters(first),numberToLetters(last));};const DELETE_CONTENT_COLUMNS_ACTION=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const target=[...env.model.getters.getActiveCols()].map((index)=>env.model.getters.getColsZone(sheetId,index,index));env.model.dispatch("DELETE_CONTENT",{target,sheetId:env.model.getters.getActiveSheetId(),});};const REMOVE_ROWS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Delete rows");}
let first;let last;const activesRows=env.model.getters.getActiveRows();if(activesRows.size!==0){first=largeMin([...activesRows]);last=largeMax([...activesRows]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.top;last=zone.bottom;}
if(first===last){return _t("Delete row %s",(first+1).toString());}
return _t("Delete rows %s - %s",(first+1).toString(),(last+1).toString());};const REMOVE_ROWS_ACTION=(env)=>{let rows=[...env.model.getters.getActiveRows()];if(!rows.length){const zone=env.model.getters.getSelectedZones()[0];for(let i=zone.top;i<=zone.bottom;i++){rows.push(i);}}
env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});};const CAN_REMOVE_COLUMNS_ROWS=(dimension,env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedElements=env.model.getters.getElementsFromSelection(dimension);const includesAllVisibleHeaders=env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,dimension,selectedElements);const includesAllNonFrozenHeaders=env.model.getters.checkElementsIncludeAllNonFrozenHeaders(sheetId,dimension,selectedElements);return!includesAllVisibleHeaders&&!includesAllNonFrozenHeaders;};const REMOVE_COLUMNS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Delete columns");}
let first;let last;const activeCols=env.model.getters.getActiveCols();if(activeCols.size!==0){first=largeMin([...activeCols]);last=largeMax([...activeCols]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.left;last=zone.right;}
if(first===last){return _t("Delete column %s",numberToLetters(first));}
return _t("Delete columns %s - %s",numberToLetters(first),numberToLetters(last));};const NOT_ALL_VISIBLE_ROWS_SELECTED=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedRows=env.model.getters.getElementsFromSelection("ROW");return!env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,"ROW",selectedRows);};const REMOVE_COLUMNS_ACTION=(env)=>{let columns=[...env.model.getters.getActiveCols()];if(!columns.length){const zone=env.model.getters.getSelectedZones()[0];for(let i=zone.left;i<=zone.right;i++){columns.push(i);}}
env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});};const NOT_ALL_VISIBLE_COLS_SELECTED=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedCols=env.model.getters.getElementsFromSelection("COL");return!env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,"COL",selectedCols);};const INSERT_ROWS_BEFORE_ACTION=(env)=>{const activeRows=env.model.getters.getActiveRows();let row;let quantity;if(activeRows.size){row=largeMin([...activeRows]);quantity=activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];row=zone.top;quantity=zone.bottom-zone.top+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"before",base:row,quantity,dimension:"ROW",});};const INSERT_ROWS_AFTER_ACTION=(env)=>{const activeRows=env.model.getters.getActiveRows();let row;let quantity;if(activeRows.size){row=largeMax([...activeRows]);quantity=activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];row=zone.bottom;quantity=zone.bottom-zone.top+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"after",base:row,quantity,dimension:"ROW",});};const INSERT_COLUMNS_BEFORE_ACTION=(env)=>{const activeCols=env.model.getters.getActiveCols();let column;let quantity;if(activeCols.size){column=largeMin([...activeCols]);quantity=activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];column=zone.left;quantity=zone.right-zone.left+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"before",dimension:"COL",base:column,quantity,});};const INSERT_COLUMNS_AFTER_ACTION=(env)=>{const activeCols=env.model.getters.getActiveCols();let column;let quantity;if(activeCols.size){column=largeMax([...activeCols]);quantity=activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];column=zone.right;quantity=zone.right-zone.left+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"after",dimension:"COL",base:column,quantity,});};const HIDE_COLUMNS_NAME=(env)=>{const cols=env.model.getters.getElementsFromSelection("COL");let first=cols[0];let last=cols[cols.length-1];if(cols.length===1){return _t("Hide column %s",numberToLetters(first).toString());}
else if(last-first+1===cols.length){return _t("Hide columns %s - %s",numberToLetters(first).toString(),numberToLetters(last).toString());}
else{return _t("Hide columns");}};const HIDE_ROWS_NAME=(env)=>{const rows=env.model.getters.getElementsFromSelection("ROW");let first=rows[0];let last=rows[rows.length-1];if(rows.length===1){return _t("Hide row %s",(first+1).toString());}
else if(last-first+1===rows.length){return _t("Hide rows %s - %s",(first+1).toString(),(last+1).toString());}
else{return _t("Hide rows");}};const CREATE_CHART=(env)=>{const getters=env.model.getters;const id=env.model.uuidGenerator.uuidv4();const sheetId=getters.getActiveSheetId();if(getZoneArea(env.model.getters.getSelectedZone())===1){env.model.selection.selectTableAroundSelection();}
const size={width:DEFAULT_FIGURE_WIDTH,height:DEFAULT_FIGURE_HEIGHT};const position=getChartPositionAtCenterOfViewport(getters,size);const result=env.model.dispatch("CREATE_CHART",{sheetId,id,position,size,definition:getSmartChartDefinition(env.model.getters.getSelectedZone(),env.model.getters),});if(result.isSuccessful){env.model.dispatch("SELECT_FIGURE",{id});env.openSidePanel("ChartPanel");}};async function requestImage(env){try{return await env.imageProvider.requestImage();}
catch{env.raiseError(_t("An unexpected error occurred during the image transfer"));return undefined;}}
const CREATE_IMAGE=async(env)=>{if(env.imageProvider){const sheetId=env.model.getters.getActiveSheetId();const figureId=env.model.uuidGenerator.uuidv4();const image=await requestImage(env);if(!image){throw new Error("No image provider was given to the environment");}
const size=getMaxFigureSize(env.model.getters,image.size);const position=centerFigurePosition(env.model.getters,size);env.model.dispatch("CREATE_IMAGE",{sheetId,figureId,position,size,definition:image,});}};const FORMAT_PERCENT_ACTION=(env)=>setFormatter(env,"0.00%");const OPEN_CF_SIDEPANEL_ACTION=(env)=>{env.openSidePanel("ConditionalFormatting",{selection:env.model.getters.getSelectedZones()});};const INSERT_LINK=(env)=>{let{col,row}=env.model.getters.getActivePosition();env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"LinkEditor"});};const INSERT_LINK_NAME=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const{col,row}=env.model.getters.getActivePosition();const cell=env.model.getters.getEvaluatedCell({sheetId,col,row});return cell&&cell.link?_t("Edit link"):_t("Insert link");};const SELECTION_CONTAINS_FILTER=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedZones=env.model.getters.getSelectedZones();return env.model.getters.doesZonesContainFilter(sheetId,selectedZones);};const IS_ONLY_ONE_RANGE=(env)=>{return env.model.getters.getSelectedZones().length===1;};const CAN_INSERT_HEADER=(env,dimension)=>{if(!IS_ONLY_ONE_RANGE(env)){return false;}
const activeHeaders=dimension==="COL"?env.model.getters.getActiveCols():env.model.getters.getActiveRows();const ortogonalActiveHeaders=dimension==="COL"?env.model.getters.getActiveRows():env.model.getters.getActiveCols();const sheetId=env.model.getters.getActiveSheetId();const zone=env.model.getters.getSelectedZone();const allSheetSelected=isEqual(zone,env.model.getters.getSheetZone(sheetId));return isConsecutive(activeHeaders)&&(ortogonalActiveHeaders.size===0||allSheetSelected);};const undo={name:_t("Undo"),description:"Ctrl+Z",execute:(env)=>env.model.dispatch("REQUEST_UNDO"),isEnabled:(env)=>env.model.getters.canUndo(),icon:"o-spreadsheet-Icon.UNDO",};const redo={name:_t("Redo"),description:"Ctrl+Y",execute:(env)=>env.model.dispatch("REQUEST_REDO"),isEnabled:(env)=>env.model.getters.canRedo(),icon:"o-spreadsheet-Icon.REDO",};const copy={name:_t("Copy"),description:"Ctrl+C",isReadonlyAllowed:true,execute:async(env)=>{env.model.dispatch("COPY");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.COPY",};const cut={name:_t("Cut"),description:"Ctrl+X",execute:async(env)=>{interactiveCut(env);await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.CUT",};const paste={name:_t("Paste"),description:"Ctrl+V",execute:PASTE_ACTION,icon:"o-spreadsheet-Icon.PASTE",};const pasteSpecial={name:_t("Paste special"),isVisible:(env)=>{return!env.model.getters.isCutOperation();},icon:"o-spreadsheet-Icon.PASTE",};const pasteSpecialValue={name:_t("Paste value only"),description:"Ctrl+Shift+V",execute:PASTE_VALUE_ACTION,};const pasteSpecialFormat={name:_t("Paste format only"),execute:PASTE_FORMAT_ACTION,};const findAndReplace={name:_t("Find and replace"),description:"Ctrl+H",isReadonlyAllowed:true,execute:(env)=>{env.openSidePanel("FindAndReplace",{});},icon:"o-spreadsheet-Icon.FIND_AND_REPLACE",};const deleteValues={name:_t("Delete values"),execute:(env)=>env.model.dispatch("DELETE_CONTENT",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),}),};const deleteRows={name:REMOVE_ROWS_NAME,execute:REMOVE_ROWS_ACTION,isVisible:(env)=>CAN_REMOVE_COLUMNS_ROWS("ROW",env),};const deleteRow={...deleteRows,isVisible:IS_ONLY_ONE_RANGE,};const clearRows={name:DELETE_CONTENT_ROWS_NAME,execute:DELETE_CONTENT_ROWS_ACTION,};const deleteCols={name:REMOVE_COLUMNS_NAME,execute:REMOVE_COLUMNS_ACTION,isVisible:(env)=>CAN_REMOVE_COLUMNS_ROWS("COL",env),};const deleteCol={...deleteCols,isVisible:IS_ONLY_ONE_RANGE,};const clearCols={name:DELETE_CONTENT_COLUMNS_NAME,execute:DELETE_CONTENT_COLUMNS_ACTION,};const deleteCells={name:_t("Delete cells"),isVisible:IS_ONLY_ONE_RANGE,};const deleteCellShiftUp={name:_t("Delete cell and shift up"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("DELETE_CELL",{zone,shiftDimension:"ROW"});handlePasteResult(env,result);},};const deleteCellShiftLeft={name:_t("Delete cell and shift left"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("DELETE_CELL",{zone,shiftDimension:"COL"});handlePasteResult(env,result);},};const mergeCells={name:_t("Merge cells"),isEnabled:(env)=>!cannotMerge(env),isActive:(env)=>isInMerge(env),execute:(env)=>toggleMerge(env),icon:"o-spreadsheet-Icon.MERGE_CELL",};function cannotMerge(env){const zones=env.model.getters.getSelectedZones();const{top,left,right,bottom}=env.model.getters.getSelectedZone();const{sheetId}=env.model.getters.getActivePosition();const{xSplit,ySplit}=env.model.getters.getPaneDivisions(sheetId);return(zones.length>1||(top===bottom&&left===right)||(left<xSplit&&xSplit<=right)||(top<ySplit&&ySplit<=bottom));}
function isInMerge(env){if(!cannotMerge(env)){const zones=env.model.getters.getSelectedZones();const{col,row,sheetId}=env.model.getters.getActivePosition();const zone=env.model.getters.expandZone(sheetId,positionToZone({col,row}));return isEqual(zones[0],zone);}
return false;}
function toggleMerge(env){if(cannotMerge(env)){return;}
const zones=env.model.getters.getSelectedZones();const target=[zones[zones.length-1]];const sheetId=env.model.getters.getActiveSheetId();if(isInMerge(env)){env.model.dispatch("REMOVE_MERGE",{sheetId,target});}
else{interactiveAddMerge(env,sheetId,target);}}
var ACTION_EDIT=Object.freeze({__proto__:null,clearCols:clearCols,clearRows:clearRows,copy:copy,cut:cut,deleteCellShiftLeft:deleteCellShiftLeft,deleteCellShiftUp:deleteCellShiftUp,deleteCells:deleteCells,deleteCol:deleteCol,deleteCols:deleteCols,deleteRow:deleteRow,deleteRows:deleteRows,deleteValues:deleteValues,findAndReplace:findAndReplace,mergeCells:mergeCells,paste:paste,pasteSpecial:pasteSpecial,pasteSpecialFormat:pasteSpecialFormat,pasteSpecialValue:pasteSpecialValue,redo:redo,undo:undo});const ARG_REGEXP=/(.*?)\((.*?)\)(.*)/;const ARG_TYPES=["ANY","BOOLEAN","DATE","NUMBER","STRING","RANGE","RANGE<BOOLEAN>","RANGE<DATE>","RANGE<NUMBER>","RANGE<STRING>","META",];function arg(definition,description=""){return makeArg(definition,description);}
function makeArg(str,description){let parts=str.match(ARG_REGEXP);let name=parts[1].trim();if(!name){throw new Error(`Function argument definition is missing a name: '${str}'.`);}
let types=[];let isOptional=false;let isRepeating=false;let isLazy=false;let defaultValue;for(let param of parts[2].split(",")){const key=param.trim().toUpperCase();let type=ARG_TYPES.find((t)=>key===t);if(type){types.push(type);}
else if(key==="RANGE<ANY>"){types.push("RANGE");}
else if(key==="OPTIONAL"){isOptional=true;}
else if(key==="REPEATING"){isRepeating=true;}
else if(key==="LAZY"){isLazy=true;}
else if(key.startsWith("DEFAULT=")){defaultValue=param.trim().slice(8);}}
const result={name,description,type:types,};if(isOptional){result.optional=true;}
if(isRepeating){result.repeating=true;}
if(isLazy){result.lazy=true;}
if(defaultValue!==undefined){result.default=true;result.defaultValue=defaultValue;}
if(types.some((t)=>t.startsWith("RANGE"))){result.acceptMatrix=true;}
return result;}
function addMetaInfoFromArg(addDescr){let countArg=0;let minArg=0;let repeatingArg=0;for(let arg of addDescr.args){countArg++;if(!arg.optional&&!arg.repeating&&!arg.default){minArg++;}
if(arg.repeating){repeatingArg++;}}
const descr=addDescr;descr.minArgRequired=minArg;descr.maxArgPossible=repeatingArg?Infinity:countArg;descr.nbrArgRepeating=repeatingArg;descr.getArgToFocus=argTargeting(countArg,repeatingArg);descr.hidden=addDescr.hidden||false;return descr;}
function argTargeting(countArg,repeatingArg){if(!repeatingArg){return(argPosition)=>argPosition;}
if(repeatingArg===1){return(argPosition)=>Math.min(argPosition,countArg);}
const argBeforeRepeat=countArg-repeatingArg;return(argPosition)=>{if(argPosition<=argBeforeRepeat){return argPosition;}
const argAfterRepeat=(argPosition-argBeforeRepeat)%repeatingArg||repeatingArg;return argBeforeRepeat+argAfterRepeat;};}
function validateArguments(args){let previousArgRepeating=false;let previousArgOptional=false;let previousArgDefault=false;for(let current of args){if(current.type.includes("META")&&current.type.length>1){throw new Error(_t("Function ${name} has an argument that has been declared with more than one type whose type 'META'. The 'META' type can only be declared alone."));}
if(previousArgRepeating&&!current.repeating){throw new Error(_t("Function ${name} has no-repeatable arguments declared after repeatable ones. All repeatable arguments must be declared last."));}
const previousIsOptional=previousArgOptional||previousArgRepeating||previousArgDefault;const currentIsntOptional=!(current.optional||current.repeating||current.default);if(previousIsOptional&&currentIsntOptional){throw new Error(_t("Function ${name} has at mandatory arguments declared after optional ones. All optional arguments must be after all mandatory arguments."));}
previousArgRepeating=current.repeating;previousArgOptional=current.optional;previousArgDefault=current.default;}}
function assertSingleColOrRow(errorStr,arg){assert(()=>arg.length===1||arg[0].length===1,errorStr);}
function assertSameDimensions(errorStr,...args){if(args.every(isMatrix)){const cols=args[0].length;const rows=args[0][0].length;for(const arg of args){assert(()=>arg.length===cols&&arg[0].length===rows,errorStr);}
return;}
if(args.some((arg)=>Array.isArray(arg)&&(arg.length!==1||arg[0].length!==1))){throw new Error(errorStr);}}
function assertPositive(errorStr,arg){assert(()=>arg>0,errorStr);}
function assertSquareMatrix(errorStr,arg){assert(()=>arg.length===arg[0].length,errorStr);}
function isNumberMatrix(arg){return arg.every((row)=>row.every((val)=>typeof val==="number"));}
function getUnitMatrix(n){const matrix=Array(n);for(let i=0;i<n;i++){matrix[i]=Array(n).fill(0);matrix[i][i]=1;}
return matrix;}
function invertMatrix(M){if(M.length!==M[0].length){throw new Error(`Function [[FUNCTION_NAME]] invert matrix error, only square matrices are invertible`);}
let determinant=1;const dim=M.length;const I=getUnitMatrix(dim);const C=M.map((row)=>row.slice());for(let pivot=0;pivot<dim;pivot++){let diagonalElement=C[pivot][pivot];if(diagonalElement===0){for(let row=pivot+1;row<dim;row++){if(C[pivot][row]!=0){swapMatrixRows(C,pivot,row);swapMatrixRows(I,pivot,row);determinant*=-1;break;}}
diagonalElement=C[pivot][pivot];if(diagonalElement===0){return{determinant:0};}}
for(let col=0;col<dim;col++){C[col][pivot]=C[col][pivot]/diagonalElement;I[col][pivot]=I[col][pivot]/diagonalElement;}
determinant*=diagonalElement;for(let row=0;row<dim;row++){if(row===pivot){continue;}
const e=C[pivot][row];for(let col=0;col<dim;col++){C[col][row]-=e*C[col][pivot];I[col][row]-=e*I[col][pivot];}}}
return{inverted:I,determinant};}
function swapMatrixRows(matrix,row1,row2){for(let i=0;i<matrix.length;i++){const tmp=matrix[i][row1];matrix[i][row1]=matrix[i][row2];matrix[i][row2]=tmp;}}
function multiplyMatrices(matrix1,matrix2){if(matrix1.length!==matrix2[0].length){throw new Error(_t("Cannot multiply matrices : incompatible matrices size."));}
const rowsM1=matrix1[0].length;const colsM2=matrix2.length;const n=matrix1.length;const result=Array(colsM2);for(let col=0;col<colsM2;col++){result[col]=Array(rowsM1);for(let row=0;row<rowsM1;row++){let sum=0;for(let k=0;k<n;k++){sum+=matrix1[k][row]*matrix2[col][k];}
result[col][row]=sum;}}
return result;}
function toScalar(matrix){if(!isMatrix(matrix)){return matrix;}
if(matrix.length!==1||matrix[0].length!==1){throw new Error("toScalar: matrix should be a scalar or a 1x1 matrix");}
return matrix[0][0];}
const ARRAY_CONSTRAIN={description:_t("Returns a result array constrained to a specific width and height."),args:[arg("input_range (any, range<any>)",_t("The range to constrain.")),arg("rows (number)",_t("The number of rows in the constrained array.")),arg("columns (number)",_t("The number of columns in the constrained array.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,rows,columns){const _array=toMatrix(array);const _rowsArg=toInteger(rows?.value,this.locale);const _columnsArg=toInteger(columns?.value,this.locale);assertPositive(_t("The rows argument (%s) must be strictly positive.",_rowsArg.toString()),_rowsArg);assertPositive(_t("The columns argument (%s) must be strictly positive.",_rowsArg.toString()),_columnsArg);const _nbRows=Math.min(_rowsArg,_array[0].length);const _nbColumns=Math.min(_columnsArg,_array.length);return generateMatrix(_nbColumns,_nbRows,(col,row)=>_array[col][row]);},isExported:false,};const CHOOSECOLS={description:_t("Creates a new array from the selected columns in the existing range."),args:[arg("array (any, range<any>)",_t("The array that contains the columns to be returned.")),arg("col_num (number, range<number>)",_t("The first column index of the columns to be returned.")),arg("col_num2 (number, range<number>, repeating)",_t("The columns indexes of the columns to be returned.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,...columns){const _array=toMatrix(array);const _columns=flattenRowFirst(columns,(item)=>toInteger(item?.value,this.locale));assert(()=>_columns.every((col)=>col>0&&col<=_array.length),_t("The columns arguments must be between 1 and %s (got %s).",_array.length.toString(),(_columns.find((col)=>col<=0||col>_array.length)||0).toString()));const result=Array(_columns.length);for(let col=0;col<_columns.length;col++){const colIndex=_columns[col]-1;result[col]=_array[colIndex];}
return result;},isExported:true,};const CHOOSEROWS={description:_t("Creates a new array from the selected rows in the existing range."),args:[arg("array (any, range<any>)",_t("The array that contains the rows to be returned.")),arg("row_num (number, range<number>)",_t("The first row index of the rows to be returned.")),arg("row_num2 (number, range<number>, repeating)",_t("The rows indexes of the rows to be returned.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,...rows){const _array=toMatrix(array);const _rows=flattenRowFirst(rows,(item)=>toInteger(item?.value,this.locale));const _nbColumns=_array.length;assert(()=>_rows.every((row)=>row>0&&row<=_array[0].length),_t("The rows arguments must be between 1 and %s (got %s).",_array[0].length.toString(),(_rows.find((row)=>row<=0||row>_array[0].length)||0).toString()));return generateMatrix(_nbColumns,_rows.length,(col,row)=>_array[col][_rows[row]-1]);},isExported:true,};const EXPAND={description:_t("Expands or pads an array to specified row and column dimensions."),args:[arg("array (any, range<any>)",_t("The array to expand.")),arg("rows (number)",_t("The number of rows in the expanded array. If missing, rows will not be expanded.")),arg("columns (number, optional)",_t("The number of columns in the expanded array. If missing, columns will not be expanded.")),arg("pad_with (any, default=0)",_t("The value with which to pad.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(arg,rows,columns,padWith={value:0}){const _array=toMatrix(arg);const _nbRows=toInteger(rows?.value,this.locale);const _nbColumns=columns!==undefined?toInteger(columns.value,this.local):_array.length;assert(()=>_nbRows>=_array[0].length,_t("The rows arguments (%s) must be greater or equal than the number of rows of the array.",_nbRows.toString()));assert(()=>_nbColumns>=_array.length,_t("The columns arguments (%s) must be greater or equal than the number of columns of the array.",_nbColumns.toString()));return generateMatrix(_nbColumns,_nbRows,(col,row)=>col>=_array.length||row>=_array[col].length?padWith:_array[col][row]);},isExported:true,};const FLATTEN={description:_t("Flattens all the values from one or more ranges into a single column."),args:[arg("range (any, range<any>)",_t("The first range to flatten.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to flatten.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){return[flattenRowFirst(ranges,(val)=>(val===undefined?{value:""}:val))];},isExported:false,};const FREQUENCY={description:_t("Calculates the frequency distribution of a range."),args:[arg("data (range<number>)",_t("The array of ranges containing the values to be counted.")),arg("classes (number, range<number>)",_t("The range containing the set of classes.")),],returns:["RANGE<NUMBER>"],compute:function(data,classes){const _data=flattenRowFirst([data],(val)=>val).filter((val)=>typeof val==="number");const _classes=flattenRowFirst([classes],(val)=>val).filter((val)=>typeof val==="number");const sortedClasses=_classes.map((value,index)=>({initialIndex:index,value,count:0})).sort((a,b)=>a.value-b.value);sortedClasses.push({initialIndex:sortedClasses.length,value:Infinity,count:0});const sortedData=_data.sort((a,b)=>a-b);let index=0;for(const val of sortedData){while(val>sortedClasses[index].value&&index<sortedClasses.length-1){index++;}
sortedClasses[index].count++;}
const result=sortedClasses.sort((a,b)=>a.initialIndex-b.initialIndex).map((val)=>val.count);return[result];},isExported:true,};const HSTACK={description:_t("Appends ranges horizontally and in sequence to return a larger array."),args:[arg("range1 (any, range<any>)",_t("The first range to be appended.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to add to range1.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){const nbRows=Math.max(...ranges.map((r)=>r?.[0]?.length??0));const result=[];for(const range of ranges){const _range=toMatrix(range);for(let col=0;col<_range.length;col++){const array=Array(nbRows).fill({value:null});for(let row=0;row<_range[col].length;row++){array[row]=_range[col][row];}
result.push(array);}}
return result;},isExported:true,};const MDETERM={description:_t("Returns the matrix determinant of a square matrix."),args:[arg("square_matrix (number, range<number>)",_t("An range with an equal number of rows and columns representing a matrix whose determinant will be calculated.")),],returns:["NUMBER"],compute:function(matrix){const _matrix=toMatrix(matrix);assertSquareMatrix(_t("The argument square_matrix must have the same number of columns and rows."),_matrix);if(!isNumberMatrix(_matrix)){throw new Error(_t("The argument square_matrix must be a matrix of numbers."));}
const{determinant}=invertMatrix(_matrix);return determinant;},isExported:true,};const MINVERSE={description:_t("Returns the multiplicative inverse of a square matrix."),args:[arg("square_matrix (number, range<number>)",_t("An range with an equal number of rows and columns representing a matrix whose multiplicative inverse will be calculated.")),],returns:["RANGE<NUMBER>"],compute:function(matrix){const _matrix=toMatrix(matrix);assertSquareMatrix(_t("The argument square_matrix must have the same number of columns and rows."),_matrix);if(!isNumberMatrix(_matrix)){throw new Error(_t("The argument square_matrix must be a matrix of numbers."));}
const{inverted}=invertMatrix(_matrix);if(!inverted){throw new Error(_t("The matrix is not invertible."));}
return inverted;},isExported:true,};const MMULT={description:_t("Calculates the matrix product of two matrices."),args:[arg("matrix1 (number, range<number>)",_t("The first matrix in the matrix multiplication operation.")),arg("matrix2 (number, range<number>)",_t("The second matrix in the matrix multiplication operation.")),],returns:["RANGE<NUMBER>"],compute:function(matrix1,matrix2){const _matrix1=toMatrix(matrix1);const _matrix2=toMatrix(matrix2);assert(()=>_matrix1.length===_matrix2[0].length,_t("In [[FUNCTION_NAME]], the number of columns of the first matrix (%s) must be equal to the \
        number of rows of the second matrix (%s).",_matrix1.length.toString(),_matrix2[0].length.toString()));if(!isNumberMatrix(_matrix1)||!isNumberMatrix(_matrix2)){throw new Error(_t("The arguments matrix1 and matrix2 must be matrices of numbers."));}
return multiplyMatrices(_matrix1,_matrix2);},isExported:true,};const SUMPRODUCT={description:_t("Calculates the sum of the products of corresponding entries in equal-sized ranges."),args:[arg("range1 (number, range<number>)",_t("The first range whose entries will be multiplied with corresponding entries in the other ranges.")),arg("range2 (number, range<number>, repeating)",_t("The other range whose entries will be multiplied with corresponding entries in the other ranges.")),],returns:["NUMBER"],compute:function(...args){assertSameDimensions(_t("All the ranges must have the same dimensions."),...args);const _args=args.map(toMatrix);let result=0;for(let col=0;col<_args[0].length;col++){for(let row=0;row<_args[0][col].length;row++){if(!_args.every((range)=>typeof range[col][row]==="number")){continue;}
let product=1;for(const range of _args){product*=toNumber(range[col][row],this.locale);}
result+=product;}}
return result;},isExported:true,};function getSumXAndY(arrayX,arrayY,cb){assertSameDimensions("The arguments array_x and array_y must have the same dimensions.",arrayX,arrayY);const _arrayX=toMatrix(arrayX);const _arrayY=toMatrix(arrayY);let validPairFound=false;let result=0;for(const col in _arrayX){for(const row in _arrayX[col]){const arrayXValue=_arrayX[col][row];const arrayYValue=_arrayY[col][row];if(typeof arrayXValue!=="number"||typeof arrayYValue!=="number"){continue;}
validPairFound=true;result+=cb(arrayXValue,arrayYValue);}}
if(!validPairFound){throw new Error("The arguments array_x and array_y must contain at least one pair of numbers.");}
return result;}
const SUMX2MY2={description:_t("Calculates the sum of the difference of the squares of the values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values whose squares will be reduced by the squares of corresponding entries in array_y and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values whose squares will be subtracted from the squares of corresponding entries in array_x and added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>x**2-y**2);},isExported:true,};const SUMX2PY2={description:_t("Calculates the sum of the sum of the squares of the values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values whose squares will be added to the squares of corresponding entries in array_y and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values whose squares will be added to the squares of corresponding entries in array_x and added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>x**2+y**2);},isExported:true,};const SUMXMY2={description:_t("Calculates the sum of squares of the differences of values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values that will be reduced by corresponding entries in array_y, squared, and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values that will be subtracted from corresponding entries in array_x, the result squared, and all such results added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>(x-y)**2);},isExported:true,};const TO_COL_ROW_DEFAULT_IGNORE=0;const TO_COL_ROW_DEFAULT_SCAN=false;const TO_COL_ROW_ARGS=[arg("array (any, range<any>)",_t("The array which will be transformed.")),arg(`ignore (number, default=${TO_COL_ROW_DEFAULT_IGNORE})`,_t("The control to ignore blanks and errors. 0 (default) is to keep all values, 1 is to ignore blanks, 2 is to ignore errors, and 3 is to ignore blanks and errors.")),arg(`scan_by_column (number, default=${TO_COL_ROW_DEFAULT_SCAN})`,_t("Whether the array should be scanned by column. True scans the array by column and false (default) \
      scans the array by row.")),];const TOCOL={description:_t("Transforms a range of cells into a single column."),args:TO_COL_ROW_ARGS,returns:["RANGE<ANY>"],computeValueAndFormat:function(array,ignore={value:TO_COL_ROW_DEFAULT_IGNORE},scanByColumn={value:TO_COL_ROW_DEFAULT_SCAN}){const _array=toMatrix(array);const _ignore=toInteger(ignore.value,this.locale);const _scanByColumn=toBoolean(scanByColumn.value);assert(()=>_ignore>=0&&_ignore<=3,_t("Argument ignore must be between 0 and 3"));const result=(_scanByColumn?_array:transposeMatrix(_array)).flat().filter((item)=>(_ignore!==1&&_ignore!==3)||(item.value!==undefined&&item.value!==null));if(result.length===0){throw new NotAvailableError(_t("No results for the given arguments of TOCOL."));}
return[result];},isExported:true,};const TOROW={description:_t("Transforms a range of cells into a single row."),args:TO_COL_ROW_ARGS,returns:["RANGE<ANY>"],computeValueAndFormat:function(array,ignore={value:TO_COL_ROW_DEFAULT_IGNORE},scanByColumn={value:TO_COL_ROW_DEFAULT_SCAN}){const _array=toMatrix(array);const _ignore=toInteger(ignore.value,this.locale);const _scanByColumn=toBoolean(scanByColumn.value);assert(()=>_ignore>=0&&_ignore<=3,_t("Argument ignore must be between 0 and 3"));const result=(_scanByColumn?_array:transposeMatrix(_array)).flat().filter((item)=>(_ignore!==1&&_ignore!==3)||(item.value!==undefined&&item.value!==null)).map((item)=>[item]);if(result.length===0||result[0].length===0){throw new NotAvailableError(_t("No results for the given arguments of TOROW."));}
return result;},isExported:true,};const TRANSPOSE={description:_t("Transposes the rows and columns of a range."),args:[arg("range (any, range<any>)",_t("The range to be transposed."))],returns:["RANGE"],computeValueAndFormat:function(arg){const _array=toMatrix(arg);const nbColumns=_array[0].length;const nbRows=_array.length;return generateMatrix(nbColumns,nbRows,(col,row)=>_array[row][col]);},isExported:true,};const VSTACK={description:_t("Appends ranges vertically and in sequence to return a larger array."),args:[arg("range1 (any, range<any>)",_t("The first range to be appended.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to add to range1.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){const nbColumns=Math.max(...ranges.map((range)=>toMatrix(range).length));const nbRows=ranges.reduce((acc,range)=>acc+toMatrix(range)[0].length,0);const result=Array(nbColumns).fill([]).map(()=>Array(nbRows).fill({value:0}));let currentRow=0;for(const range of ranges){const _array=toMatrix(range);for(let col=0;col<_array.length;col++){for(let row=0;row<_array[col].length;row++){result[col][currentRow+row]=_array[col][row];}}
currentRow+=_array[0].length;}
return result;},isExported:true,};const WRAPCOLS={description:_t("Wraps the provided row or column of cells by columns after a specified number of elements to form a new array."),args:[arg("range (any, range<any>)",_t("The range to wrap.")),arg("wrap_count (number)",_t("The maximum number of cells for each column, rounded down to the nearest whole number.")),arg("pad_with  (any, default=0)",_t("The value with which to fill the extra cells in the range.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,wrapCount,padWith={value:0}){const _array=toMatrix(range);const nbRows=toInteger(wrapCount?.value,this.locale);assertSingleColOrRow(_t("Argument range must be a single row or column."),_array);const array=_array.flat();const nbColumns=Math.ceil(array.length/nbRows);return generateMatrix(nbColumns,nbRows,(col,row)=>{const index=col*nbRows+row;return index<array.length?array[index]:padWith;});},isExported:true,};const WRAPROWS={description:_t("Wraps the provided row or column of cells by rows after a specified number of elements to form a new array."),args:[arg("range (any, range<any>)",_t("The range to wrap.")),arg("wrap_count (number)",_t("The maximum number of cells for each row, rounded down to the nearest whole number.")),arg("pad_with  (any, default=0)",_t("The value with which to fill the extra cells in the range.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,wrapCount,padWith={value:0}){const _array=toMatrix(range);const nbColumns=toInteger(wrapCount?.value,this.locale);assertSingleColOrRow(_t("Argument range must be a single row or column."),_array);const array=_array.flat();const nbRows=Math.ceil(array.length/nbColumns);return generateMatrix(nbColumns,nbRows,(col,row)=>{const index=row*nbColumns+col;return index<array.length?array[index]:padWith;});},isExported:true,};var array=Object.freeze({__proto__:null,ARRAY_CONSTRAIN:ARRAY_CONSTRAIN,CHOOSECOLS:CHOOSECOLS,CHOOSEROWS:CHOOSEROWS,EXPAND:EXPAND,FLATTEN:FLATTEN,FREQUENCY:FREQUENCY,HSTACK:HSTACK,MDETERM:MDETERM,MINVERSE:MINVERSE,MMULT:MMULT,SUMPRODUCT:SUMPRODUCT,SUMX2MY2:SUMX2MY2,SUMX2PY2:SUMX2PY2,SUMXMY2:SUMXMY2,TOCOL:TOCOL,TOROW:TOROW,TRANSPOSE:TRANSPOSE,VSTACK:VSTACK,WRAPCOLS:WRAPCOLS,WRAPROWS:WRAPROWS});const FORMAT_LARGE_NUMBER={description:_t("Apply a large number format"),args:[arg("value (number)",_t("The number.")),arg("unit (string, optional)",_t("The formatting unit. Use 'k', 'm', or 'b' to force the unit")),],returns:["NUMBER"],computeFormat:function(arg,unit){const value=Math.abs(toNumber(arg?.value,this.locale));const format=arg?.format;if(unit!==undefined){const postFix=unit?.value;switch(postFix){case"k":return createLargeNumberFormat(format,1e3,"k",this.locale);case"m":return createLargeNumberFormat(format,1e6,"m",this.locale);case"b":return createLargeNumberFormat(format,1e9,"b",this.locale);default:throw new Error(_t("The formatting unit should be 'k', 'm' or 'b'."));}}
if(value<1e5){return createLargeNumberFormat(format,0,"",this.locale);}
else if(value<1e8){return createLargeNumberFormat(format,1e3,"k",this.locale);}
else if(value<1e11){return createLargeNumberFormat(format,1e6,"m",this.locale);}
return createLargeNumberFormat(format,1e9,"b",this.locale);},compute:function(value){return toNumber(value,this.locale);},};var misc=Object.freeze({__proto__:null,FORMAT_LARGE_NUMBER:FORMAT_LARGE_NUMBER});const DEFAULT_FACTOR=1;const DEFAULT_MODE=0;const DEFAULT_PLACES=0;const DEFAULT_SIGNIFICANCE=1;const DECIMAL_REPRESENTATION=/^-?[a-z0-9]+$/i;const ABS={description:_t("Absolute value of a number."),args:[arg("value (number)",_t("The number of which to return the absolute value."))],returns:["NUMBER"],compute:function(value){return Math.abs(toNumber(value,this.locale));},isExported:true,};const ACOS={description:_t("Inverse cosine of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse cosine. Must be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<=1,_t("The value (%s) must be between -1 and 1 inclusive.",_value.toString()));return Math.acos(_value);},isExported:true,};const ACOSH={description:_t("Inverse hyperbolic cosine of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic cosine. Must be greater than or equal to 1.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>=1,_t("The value (%s) must be greater than or equal to 1.",_value.toString()));return Math.acosh(_value);},isExported:true,};const ACOT={description:_t("Inverse cotangent of a value."),args:[arg("value (number)",_t("The value for which to calculate the inverse cotangent."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);const sign=Math.sign(_value)||1;return(sign*Math.PI)/2-Math.atan(_value);},isExported:true,};const ACOTH={description:_t("Inverse hyperbolic cotangent of a value."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic cotangent. Must not be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)>1,_t("The value (%s) cannot be between -1 and 1 inclusive.",_value.toString()));return Math.log((_value+1)/(_value-1))/2;},isExported:true,};const ASIN={description:_t("Inverse sine of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse sine. Must be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<=1,_t("The value (%s) must be between -1 and 1 inclusive.",_value.toString()));return Math.asin(_value);},isExported:true,};const ASINH={description:_t("Inverse hyperbolic sine of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic sine.")),],returns:["NUMBER"],compute:function(value){return Math.asinh(toNumber(value,this.locale));},isExported:true,};const ATAN={description:_t("Inverse tangent of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse tangent."))],returns:["NUMBER"],compute:function(value){return Math.atan(toNumber(value,this.locale));},isExported:true,};const ATAN2={description:_t("Angle from the X axis to a point (x,y), in radians."),args:[arg("x (number)",_t("The x coordinate of the endpoint of the line segment for which to calculate the angle from the x-axis.")),arg("y (number)",_t("The y coordinate of the endpoint of the line segment for which to calculate the angle from the x-axis.")),],returns:["NUMBER"],compute:function(x,y){const _x=toNumber(x,this.locale);const _y=toNumber(y,this.locale);assert(()=>_x!==0||_y!==0,_t("Function [[FUNCTION_NAME]] caused a divide by zero error."));return Math.atan2(_y,_x);},isExported:true,};const ATANH={description:_t("Inverse hyperbolic tangent of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic tangent. Must be between -1 and 1, exclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<1,_t("The value (%s) must be between -1 and 1 exclusive.",_value.toString()));return Math.atanh(_value);},isExported:true,};const CEILING={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("value (number)",_t("The value to round up to the nearest integer multiple of factor.")),arg(`factor (number, default=${DEFAULT_FACTOR})`,_t("The number to whose multiples value will be rounded.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,factor=DEFAULT_FACTOR){const _value=toNumber(value,this.locale);const _factor=toNumber(factor,this.locale);assert(()=>_factor>=0||_value<=0,_t("The factor (%s) must be positive when the value (%s) is positive.",_factor.toString(),_value.toString()));return _factor?Math.ceil(_value/_factor)*_factor:0;},isExported:true,};const CEILING_MATH={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded. The sign of significance will be ignored.")),arg(`mode (number, default=${DEFAULT_MODE})`,_t("If number is negative, specifies the rounding direction. If 0 or blank, it is rounded towards zero. Otherwise, it is rounded away from zero.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE,mode=DEFAULT_MODE){let _significance=toNumber(significance,this.locale);if(_significance===0){return 0;}
const _number=toNumber(number,this.locale);_significance=Math.abs(_significance);if(_number>=0){return Math.ceil(_number/_significance)*_significance;}
const _mode=toNumber(mode,this.locale);if(_mode===0){return-Math.floor(Math.abs(_number)/_significance)*_significance;}
return-Math.ceil(Math.abs(_number)/_significance)*_significance;},isExported:true,};const CEILING_PRECISE={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance){return CEILING_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const COS={description:_t("Cosine of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cosine of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.cos(toNumber(angle,this.locale));},isExported:true,};const COSH={description:_t("Hyperbolic cosine of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cosine of."))],returns:["NUMBER"],compute:function(value){return Math.cosh(toNumber(value,this.locale));},isExported:true,};const COT={description:_t("Cotangent of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cotangent of, in radians."))],returns:["NUMBER"],compute:function(angle){const _angle=toNumber(angle,this.locale);assert(()=>_angle!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.tan(_angle);},isExported:true,};const COTH={description:_t("Hyperbolic cotangent of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cotangent of."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.tanh(_value);},isExported:true,};const COUNTBLANK={description:_t("Number of empty values."),args:[arg("value1 (any, range)",_t("The first value or range in which to count the number of blanks.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges in which to count the number of blanks.")),],returns:["NUMBER"],compute:function(...argsValues){return reduceAny(argsValues,(acc,a)=>(a===null||a===undefined||a===""?acc+1:acc),0);},isExported:true,};const COUNTIF={description:_t("A conditional count across a range."),args:[arg("range (range)",_t("The range that is tested against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to range.")),],returns:["NUMBER"],compute:function(...argsValues){let count=0;visitMatchingRanges(argsValues,(i,j)=>{count+=1;},this.locale);return count;},isExported:true,};const COUNTIFS={description:_t("Count values depending on multiple criteria."),args:[arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("Additional criteria to check.")),],returns:["NUMBER"],compute:function(...argsValues){let count=0;visitMatchingRanges(argsValues,(i,j)=>{count+=1;},this.locale);return count;},isExported:true,};function isDefined(value){switch(value){case undefined:return false;case"":return false;case null:return false;default:return true;}}
const COUNTUNIQUE={description:_t("Counts number of unique values in a range."),args:[arg("value1 (any, range)",_t("The first value or range to consider for uniqueness.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider for uniqueness.")),],returns:["NUMBER"],compute:function(...argsValues){return reduceAny(argsValues,(acc,a)=>(isDefined(a)?acc.add(a):acc),new Set()).size;},};const COUNTUNIQUEIFS={description:_t("Counts number of unique values in a range, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the number of unique values will be counted.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...argsValues){let uniqueValues=new Set();visitMatchingRanges(argsValues,(i,j)=>{const value=range[i][j];if(isDefined(value)){uniqueValues.add(value);}},this.locale);return uniqueValues.size;},};const CSC={description:_t("Cosecant of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cosecant of, in radians."))],returns:["NUMBER"],compute:function(angle){const _angle=toNumber(angle,this.locale);assert(()=>_angle!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.sin(_angle);},isExported:true,};const CSCH={description:_t("Hyperbolic cosecant of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cosecant of."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.sinh(_value);},isExported:true,};const DECIMAL={description:_t("Converts from another base to decimal."),args:[arg("value (string)",_t("The number to convert.")),arg(",base (number)",_t("The base to convert the value from.")),],returns:["NUMBER"],compute:function(value,base){let _base=toNumber(base,this.locale);_base=Math.floor(_base);assert(()=>2<=_base&&_base<=36,_t("The base (%s) must be between 2 and 36 inclusive.",_base.toString()));const _value=toString(value);if(_value===""){return 0;}
assert(()=>!!DECIMAL_REPRESENTATION.test(_value),_t("The value (%s) must be a valid base %s representation.",_value,_base.toString()));const deci=parseInt(_value,_base);assert(()=>!isNaN(deci),_t("The value (%s) must be a valid base %s representation.",_value,_base.toString()));return deci;},isExported:true,};const DEGREES={description:_t("Converts an angle value in radians to degrees."),args:[arg("angle (number)",_t("The angle to convert from radians to degrees."))],returns:["NUMBER"],compute:function(angle){return(toNumber(angle,this.locale)*180)/Math.PI;},isExported:true,};const EXP={description:_t("Euler's number, e (~2.718) raised to a power."),args:[arg("value (number)",_t("The exponent to raise e."))],returns:["NUMBER"],compute:function(value){return Math.exp(toNumber(value,this.locale));},isExported:true,};const FLOOR={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("value (number)",_t("The value to round down to the nearest integer multiple of factor.")),arg(`factor (number, default=${DEFAULT_FACTOR})`,_t("The number to whose multiples value will be rounded.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,factor=DEFAULT_FACTOR){const _value=toNumber(value,this.locale);const _factor=toNumber(factor,this.locale);assert(()=>_factor>=0||_value<=0,_t("The factor (%s) must be positive when the value (%s) is positive.",_factor.toString(),_value.toString()));return _factor?Math.floor(_value/_factor)*_factor:0;},isExported:true,};const FLOOR_MATH={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round down to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded. The sign of significance will be ignored.")),arg(`mode (number, default=${DEFAULT_MODE})`,_t("If number is negative, specifies the rounding direction. If 0 or blank, it is rounded away from zero. Otherwise, it is rounded towards zero.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE,mode=DEFAULT_MODE){let _significance=toNumber(significance,this.locale);if(_significance===0){return 0;}
const _number=toNumber(number,this.locale);_significance=Math.abs(_significance);if(_number>=0){return Math.floor(_number/_significance)*_significance;}
const _mode=toNumber(mode,this.locale);if(_mode===0){return-Math.ceil(Math.abs(_number)/_significance)*_significance;}
return-Math.floor(Math.abs(_number)/_significance)*_significance;},isExported:true,};const FLOOR_PRECISE={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round down to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE){return FLOOR_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const ISEVEN={description:_t("Whether the provided value is even."),args:[arg("value (number)",_t("The value to be verified as even."))],returns:["BOOLEAN"],compute:function(value){const _value=strictToNumber(value,this.locale);return Math.floor(Math.abs(_value))&1?false:true;},isExported:true,};const ISO_CEILING={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE){return CEILING_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const ISODD={description:_t("Whether the provided value is even."),args:[arg("value (number)",_t("The value to be verified as even."))],returns:["BOOLEAN"],compute:function(value){const _value=strictToNumber(value,this.locale);return Math.floor(Math.abs(_value))&1?true:false;},isExported:true,};const LN={description:_t("The logarithm of a number, base e (euler's number)."),args:[arg("value (number)",_t("The value for which to calculate the logarithm, base e."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>0,_t("The value (%s) must be strictly positive.",_value.toString()));return Math.log(_value);},isExported:true,};const MOD={description:_t("Modulo (remainder) operator."),args:[arg("dividend (number)",_t("The number to be divided to find the remainder.")),arg("divisor (number)",_t("The number to divide by.")),],returns:["NUMBER"],computeFormat:(dividend)=>dividend?.format,compute:function(dividend,divisor){const _divisor=toNumber(divisor,this.locale);assert(()=>_divisor!==0,_t("The divisor must be different from 0."));const _dividend=toNumber(dividend,this.locale);const modulus=_dividend%_divisor;if((modulus>0&&_divisor<0)||(modulus<0&&_divisor>0)){return modulus+_divisor;}
return modulus;},isExported:true,};const MUNIT={description:_t("Returns a n x n unit matrix, where n is the input dimension."),args:[arg("dimension (number)",_t("An integer specifying the dimension size of the unit matrix. It must be positive.")),],returns:["RANGE<NUMBER>"],compute:function(n){const _n=toInteger(n,this.locale);assertPositive(_t("The argument dimension must be positive"),_n);return getUnitMatrix(_n);},isExported:true,};const ODD={description:_t("Rounds a number up to the nearest odd integer."),args:[arg("value (number)",_t("The value to round to the next greatest odd number."))],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(value){const _value=toNumber(value,this.locale);let temp=Math.ceil(Math.abs(_value));temp=temp&1?temp:temp+1;return _value<0?-temp:temp;},isExported:true,};const PI={description:_t("The number pi."),args:[],returns:["NUMBER"],compute:function(){return Math.PI;},isExported:true,};const POWER={description:_t("A number raised to a power."),args:[arg("base (number)",_t("The number to raise to the exponent power.")),arg("exponent (number)",_t("The exponent to raise base to.")),],returns:["NUMBER"],computeFormat:(base)=>base?.format,compute:function(base,exponent){const _base=toNumber(base,this.locale);const _exponent=toNumber(exponent,this.locale);assert(()=>_base>=0||Number.isInteger(_exponent),_t("The exponent (%s) must be an integer when the base is negative.",_exponent.toString()));return Math.pow(_base,_exponent);},isExported:true,};const PRODUCT={description:_t("Result of multiplying a series of numbers together."),args:[arg("factor1 (number, range<number>)",_t("The first number or range to calculate for the product.")),arg("factor2 (number, range<number>, repeating)",_t("More numbers or ranges to calculate for the product.")),],returns:["NUMBER"],computeFormat:(factor1)=>{return isMatrix(factor1)?factor1[0][0]?.format:factor1?.format;},compute:function(...factors){let count=0;let acc=1;for(let n of factors){if(isMatrix(n)){for(let i of n){for(let j of i){if(typeof j==="number"){acc*=j;count+=1;}}}}
else if(n!==null&&n!==undefined){acc*=strictToNumber(n,this.locale);count+=1;}}
if(count===0){return 0;}
return acc;},isExported:true,};const RAND={description:_t("A random number between 0 inclusive and 1 exclusive."),args:[],returns:["NUMBER"],compute:function(){return Math.random();},isExported:true,};const RANDARRAY={description:_t("Returns a grid of random numbers between 0 inclusive and 1 exclusive."),args:[arg("rows (number, default=1)",_t("The number of rows to be returned.")),arg("columns (number, default=1)",_t("The number of columns to be returned.")),arg("min (number, default=0)",_t("The minimum number you would like returned.")),arg("max (number, default=1)",_t("The maximum number you would like returned.")),arg("whole_number (number, default=FALSE)",_t("Return a whole number or a decimal value.")),],returns:["RANGE<NUMBER>"],compute:function(rows=1,columns=1,min=0,max=1,whole_number=false){const _cols=toInteger(columns,this.locale);const _rows=toInteger(rows,this.locale);const _min=toNumber(min,this.locale);const _max=toNumber(max,this.locale);const _whole_number=toBoolean(whole_number);assertPositive(_t("The number columns (%s) must be positive.",_cols.toString()),_cols);assertPositive(_t("The number rows (%s) must be positive.",_rows.toString()),_rows);assert(()=>_min<=_max,_t("The maximum (%s) must be greater than or equal to the minimum (%s).",_max.toString(),_min.toString()));if(_whole_number){assert(()=>Number.isInteger(_min)&&Number.isInteger(_max),_t("The maximum (%s) and minimum (%s) must be integers when whole_number is TRUE.",_max.toString(),_min.toString()));}
const result=Array(_cols);for(let col=0;col<_cols;col++){result[col]=Array(_rows);for(let row=0;row<_rows;row++){if(!_whole_number){result[col][row]=_min+Math.random()*(_max-_min);}
else{result[col][row]=Math.floor(Math.random()*(_max-_min+1)+_min);}}}
return result;},isExported:true,};const RANDBETWEEN={description:_t("Random integer between two values, inclusive."),args:[arg("low (number)",_t("The low end of the random range.")),arg("high (number)",_t("The high end of the random range.")),],returns:["NUMBER"],computeFormat:(low)=>low?.format,compute:function(low,high){let _low=toNumber(low,this.locale);if(!Number.isInteger(_low)){_low=Math.ceil(_low);}
let _high=toNumber(high,this.locale);if(!Number.isInteger(_high)){_high=Math.floor(_high);}
assert(()=>_low<=_high,_t("The high (%s) must be greater than or equal to the low (%s).",_high.toString(),_low.toString()));return _low+Math.ceil((_high-_low+1)*Math.random())-1;},isExported:true,};const ROUND={description:_t("Rounds a number according to standard rules."),args:[arg("value (number)",_t("The value to round to places number of places.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.round(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.round(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const ROUNDDOWN={description:_t("Rounds down a number."),args:[arg("value (number)",_t("The value to round to places number of places, always rounding down.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.floor(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.floor(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const ROUNDUP={description:_t("Rounds up a number."),args:[arg("value (number)",_t("The value to round to places number of places, always rounding up.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.ceil(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.ceil(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const SEC={description:_t("Secant of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the secant of, in radians."))],returns:["NUMBER"],compute:function(angle){return 1/Math.cos(toNumber(angle,this.locale));},isExported:true,};const SECH={description:_t("Hyperbolic secant of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic secant of."))],returns:["NUMBER"],compute:function(value){return 1/Math.cosh(toNumber(value,this.locale));},isExported:true,};const SIN={description:_t("Sine of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the sine of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.sin(toNumber(angle,this.locale));},isExported:true,};const SINH={description:_t("Hyperbolic sine of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic sine of."))],returns:["NUMBER"],compute:function(value){return Math.sinh(toNumber(value,this.locale));},isExported:true,};const SQRT={description:_t("Positive square root of a positive number."),args:[arg("value (number)",_t("The number for which to calculate the positive square root."))],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>=0,_t("The value (%s) must be positive or null.",_value.toString()));return Math.sqrt(_value);},isExported:true,};const SUM={description:_t("Sum of a series of numbers and/or cells."),args:[arg("value1 (number, range<number>)",_t("The first number or range to add together.")),arg("value2 (number, range<number>, repeating)",_t("Additional numbers or ranges to add to value1.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){return reduceNumbers(values,(acc,a)=>acc+a,0,this.locale);},isExported:true,};const SUMIF={description:_t("A conditional sum across a range."),args:[arg("criteria_range (range)",_t("The range which is tested against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to range.")),arg("sum_range (range, default=criteria_range)",_t("The range to be summed, if different from range.")),],returns:["NUMBER"],compute:function(criteriaRange,criterion,sumRange){if(sumRange===undefined){sumRange=criteriaRange;}
let sum=0;visitMatchingRanges([criteriaRange,criterion],(i,j)=>{const value=sumRange[i][j];if(typeof value==="number"){sum+=value;}},this.locale);return sum;},isExported:true,};const SUMIFS={description:_t("Sums a range depending on multiple criteria."),args:[arg("sum_range (range)",_t("The range to sum.")),arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges to check.")),arg("criterion2 (string, repeating)",_t("Additional criteria to check.")),],returns:["NUMBER"],compute:function(sumRange,...criters){let sum=0;visitMatchingRanges(criters,(i,j)=>{const value=sumRange[i][j];if(typeof value==="number"){sum+=value;}},this.locale);return sum;},isExported:true,};const TAN={description:_t("Tangent of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the tangent of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.tan(toNumber(angle,this.locale));},isExported:true,};const TANH={description:_t("Hyperbolic tangent of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic tangent of."))],returns:["NUMBER"],compute:function(value){return Math.tanh(toNumber(value,this.locale));},isExported:true,};const TRUNC={description:_t("Truncates a number."),args:[arg("value (number)",_t("The value to be truncated.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of significant digits to the right of the decimal point to retain.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);if(_places===0){return Math.trunc(_value);}
if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
return Math.trunc(_value*Math.pow(10,_places))/Math.pow(10,_places);},isExported:true,};const INT={description:_t("Rounds a number down to the nearest integer that is less than or equal to it."),args:[arg("value (number)",_t("The number to round down to the nearest integer."))],returns:["NUMBER"],compute:function(value){return Math.floor(toNumber(value,this.locale));},isExported:true,};var math=Object.freeze({__proto__:null,ABS:ABS,ACOS:ACOS,ACOSH:ACOSH,ACOT:ACOT,ACOTH:ACOTH,ASIN:ASIN,ASINH:ASINH,ATAN:ATAN,ATAN2:ATAN2,ATANH:ATANH,CEILING:CEILING,CEILING_MATH:CEILING_MATH,CEILING_PRECISE:CEILING_PRECISE,COS:COS,COSH:COSH,COT:COT,COTH:COTH,COUNTBLANK:COUNTBLANK,COUNTIF:COUNTIF,COUNTIFS:COUNTIFS,COUNTUNIQUE:COUNTUNIQUE,COUNTUNIQUEIFS:COUNTUNIQUEIFS,CSC:CSC,CSCH:CSCH,DECIMAL:DECIMAL,DEGREES:DEGREES,EXP:EXP,FLOOR:FLOOR,FLOOR_MATH:FLOOR_MATH,FLOOR_PRECISE:FLOOR_PRECISE,INT:INT,ISEVEN:ISEVEN,ISODD:ISODD,ISO_CEILING:ISO_CEILING,LN:LN,MOD:MOD,MUNIT:MUNIT,ODD:ODD,PI:PI,POWER:POWER,PRODUCT:PRODUCT,RAND:RAND,RANDARRAY:RANDARRAY,RANDBETWEEN:RANDBETWEEN,ROUND:ROUND,ROUNDDOWN:ROUNDDOWN,ROUNDUP:ROUNDUP,SEC:SEC,SECH:SECH,SIN:SIN,SINH:SINH,SQRT:SQRT,SUM:SUM,SUMIF:SUMIF,SUMIFS:SUMIFS,TAN:TAN,TANH:TANH,TRUNC:TRUNC});function assertSameNumberOfElements(...args){const dims=args[0].length;args.forEach((arg,i)=>assert(()=>arg.length===dims,_t("[[FUNCTION_NAME]] has mismatched dimensions for argument %s (%s vs %s).",i.toString(),dims.toString(),arg.length.toString())));}
function filterAndFlatData(dataY,dataX){const _flatDataY=[];const _flatDataX=[];let lenY=0;let lenX=0;visitAny([dataY],(y)=>{_flatDataY.push(y);lenY+=1;});visitAny([dataX],(x)=>{_flatDataX.push(x);lenX+=1;});assert(()=>lenY===lenX,_t("[[FUNCTION_NAME]] has mismatched argument count %s vs %s.",lenY,lenX));const flatDataX=[];const flatDataY=[];for(let i=0;i<lenY;i++){const valueY=_flatDataY[i];const valueX=_flatDataX[i];if(typeof valueY==="number"&&typeof valueX==="number"){flatDataY.push(valueY);flatDataX.push(valueX);}}
return{flatDataX,flatDataY};}
function covariance(dataY,dataX,isSample){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const count=flatDataY.length;assert(()=>count!==0&&(!isSample||count!==1),_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));let sumY=0;let sumX=0;for(let i=0;i<count;i++){sumY+=flatDataY[i];sumX+=flatDataX[i];}
const averageY=sumY/count;const averageX=sumX/count;let acc=0;for(let i=0;i<count;i++){acc+=(flatDataY[i]-averageY)*(flatDataX[i]-averageX);}
return acc/(count-(isSample?1:0));}
function variance(args,isSample,textAs0,locale){let count=0;let sum=0;const reduceFunction=textAs0?reduceNumbersTextAs0:reduceNumbers;sum=reduceFunction(args,(acc,a)=>{count+=1;return acc+a;},0,locale);assert(()=>count!==0&&(!isSample||count!==1),_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));const average=sum/count;return(reduceFunction(args,(acc,a)=>acc+Math.pow(a-average,2),0,locale)/(count-(isSample?1:0)));}
function centile(data,percent,isInclusive,locale){const _percent=toNumber(percent,locale);assert(()=>(isInclusive?0<=_percent&&_percent<=1:0<_percent&&_percent<1),_t("Function [[FUNCTION_NAME]] parameter 2 value is out of range."));let sortedArray=[];let index;let count=0;visitAny(data,(d)=>{if(typeof d==="number"){index=dichotomicSearch(sortedArray,d,"nextSmaller","asc",sortedArray.length,(array,i)=>array[i]);sortedArray.splice(index+1,0,d);count++;}});assert(()=>count!==0,_t("[[FUNCTION_NAME]] has no valid input data."));if(!isInclusive){assert(()=>1/(count+1)<=_percent&&_percent<=count/(count+1),_t("Function [[FUNCTION_NAME]] parameter 2 value is out of range."));}
return percentile(sortedArray,_percent,isInclusive);}
function prepareDataForRegression(X,Y,newX){const _X=X.length?X:[range(1,Y.flat().length+1)];const nVar=_X.length;let _newX=newX.length?newX:_X;_newX=_newX.length===nVar?transposeMatrix(_newX):_newX;return{_X,_newX};}
function fullLinearRegression(X,Y,computeIntercept=true,verbose=false){const y=Y.flat();const n=y.length;let{_X}=prepareDataForRegression(X,Y,[]);_X=_X.length===n?transposeMatrix(_X):_X.slice();assertSameNumberOfElements(_X[0],y);const nVar=_X.length;const nDeg=n-nVar-(computeIntercept?1:0);const yMatrix=[y];const xMatrix=transposeMatrix(_X.reverse());let avgX=[];for(let i=0;i<nVar;i++){avgX.push(0);if(computeIntercept){for(const xij of _X[i]){avgX[i]+=xij;}
avgX[i]/=n;}}
let avgY=0;if(computeIntercept){for(const yi of y){avgY+=yi;}
avgY/=n;}
const redX=xMatrix.map((row)=>row.map((value,i)=>value-avgX[i]));if(computeIntercept){xMatrix.forEach((row)=>row.push(1));}
const coeffs=getLMSCoefficients(xMatrix,yMatrix);if(!computeIntercept){coeffs.push([0]);}
if(!verbose){return coeffs;}
const dot1=multiplyMatrices(redX,transposeMatrix(redX));const{inverted:dotInv}=invertMatrix(dot1);if(dotInv===undefined){throw new Error(_t("Matrix is not invertible"));}
let SSE=0,SSR=0;for(let i=0;i<n;i++){const yi=y[i]-avgY;let temp=0;for(let j=0;j<nVar;j++){const xi=redX[i][j];temp+=xi*coeffs[j][0];}
const ei=yi-temp;SSE+=ei*ei;SSR+=temp*temp;}
const RMSE=Math.sqrt(SSE/nDeg);const r2=SSR/(SSR+SSE);const f_stat=SSR/nVar/(SSE/nDeg);const deltaCoeffs=[];for(let i=0;i<nVar;i++){deltaCoeffs.push(RMSE*Math.sqrt(dotInv[i][i]));}
if(computeIntercept){const dot2=multiplyMatrices(dotInv,[avgX]);const dot3=multiplyMatrices(transposeMatrix([avgX]),dot2);deltaCoeffs.push(RMSE*Math.sqrt(dot3[0][0]+1/y.length));}
const returned=[[coeffs[0][0],deltaCoeffs[0],r2,f_stat,SSR],[coeffs[1][0],deltaCoeffs[1],RMSE,nDeg,SSE],];for(let i=2;i<nVar;i++){returned.push([coeffs[i][0],deltaCoeffs[i],"","",""]);}
if(computeIntercept){returned.push([coeffs[nVar][0],deltaCoeffs[nVar],"","",""]);}
else{returned.push([0,"","","",""]);}
return returned;}
function polynomialRegression(flatY,flatX,order,intercept){assertSameNumberOfElements(flatX,flatY);assert(()=>order>=1,_t("Function [[FUNCTION_NAME]] A regression of order less than 1 cannot be possible."));const yMatrix=[flatY];const xMatrix=flatX.map((x)=>range(0,order).map((i)=>Math.pow(x,order-i)));if(intercept){xMatrix.forEach((row)=>row.push(1));}
const coeffs=getLMSCoefficients(xMatrix,yMatrix);if(!intercept){coeffs.push([0]);}
return coeffs;}
function getLMSCoefficients(xMatrix,yMatrix){const xMatrixT=transposeMatrix(xMatrix);const dot1=multiplyMatrices(xMatrix,xMatrixT);const{inverted:dotInv}=invertMatrix(dot1);if(dotInv===undefined){throw new Error(_t("Matrix is not invertible"));}
const dot2=multiplyMatrices(xMatrix,yMatrix);return transposeMatrix(multiplyMatrices(dotInv,dot2));}
function evaluatePolynomial(coeffs,x,order){return coeffs.reduce((acc,coeff,i)=>acc+coeff*Math.pow(x,order-i),0);}
function expM(M){return M.map((col)=>col.map((cell)=>Math.exp(cell)));}
function logM(M){return M.map((col)=>col.map((cell)=>Math.log(cell)));}
function predictLinearValues(Y,X,newX,computeIntercept){const{_X,_newX}=prepareDataForRegression(X,Y,newX);const coeffs=fullLinearRegression(_X,Y,computeIntercept,false);const nVar=coeffs.length-1;const newY=_newX.map((col)=>{let value=0;for(let i=0;i<nVar;i++){value+=coeffs[i][0]*col[nVar-i-1];}
value+=coeffs[nVar][0];return[value];});return newY.length===newX.length?newY:transposeMatrix(newY);}
const AVEDEV={description:_t("Average magnitude of deviations from mean."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){let count=0;const sum=reduceNumbers(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));const average=sum/count;return reduceNumbers(values,(acc,a)=>acc+Math.abs(average-a),0,this.locale)/count;},isExported:true,};const AVERAGE={description:_t("Numerical average value in a dataset, ignoring text."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the average value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the average value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let count=0;const sum=reduceNumbers(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const rangeError=_t("[[FUNCTION_NAME]] has mismatched range sizes.");const negativeWeightError=_t("[[FUNCTION_NAME]] expects the weight to be positive or equal to 0.");const AVERAGE_WEIGHTED={description:_t("Weighted average."),args:[arg("values (number, range<number>)",_t("Values to average.")),arg("weights (number, range<number>)",_t("Weights for each corresponding value.")),arg("additional_values (number, range<number>, repeating)",_t("Additional values to average.")),arg("additional_weights (number, range<number>, repeating)",_t("Additional weights.")),],returns:["NUMBER"],computeFormat:(values)=>{return isMatrix(values)?values[0][0]?.format:values?.format;},compute:function(...values){let sum=0;let count=0;let value;let weight;assert(()=>values.length%2===0,_t("Wrong number of Argument[]. Expected an even number of Argument[]."));for(let n=0;n<values.length-1;n+=2){value=values[n];weight=values[n+1];if(isMatrix(value)){assert(()=>isMatrix(weight),rangeError);let dimColValue=value.length;let dimLinValue=value[0].length;assert(()=>dimColValue===weight.length&&dimLinValue===weight[0].length,rangeError);for(let i=0;i<dimColValue;i++){for(let j=0;j<dimLinValue;j++){let subValue=value[i][j];let subWeight=weight[i][j];let subValueIsNumber=typeof subValue==="number";let subWeightIsNumber=typeof subWeight==="number";assert(()=>subValueIsNumber===subWeightIsNumber,_t("[[FUNCTION_NAME]] expects number values."));if(subWeightIsNumber){assert(()=>subWeight>=0,negativeWeightError);sum+=subValue*subWeight;count+=subWeight;}}}}
else{weight=toNumber(weight,this.locale);value=toNumber(value,this.locale);assert(()=>weight>=0,negativeWeightError);sum+=value*weight;count+=weight;}}
assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},};const AVERAGEA={description:_t("Numerical average value in a dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the average value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the average value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let count=0;const sum=reduceNumbersTextAs0(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const AVERAGEIF={description:_t("Average of values depending on criteria."),args:[arg("criteria_range (number, range<number>)",_t("The range to check against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to criteria_range.")),arg("average_range (number, range<number>, default=criteria_range)",_t("The range to average. If not included, criteria_range is used for the average instead.")),],returns:["NUMBER"],compute:function(criteriaRange,criterion,averageRange){const _criteriaRange=toMatrix(criteriaRange);const _averageRange=averageRange===undefined?_criteriaRange:toMatrix(averageRange);let count=0;let sum=0;visitMatchingRanges([criteriaRange,criterion],(i,j)=>{const value=_averageRange[i][j];if(typeof value==="number"){count+=1;sum+=value;}},this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const AVERAGEIFS={description:_t("Average of values depending on multiple criteria."),args:[arg("average_range (range)",_t("The range to average.")),arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional criteria_range and criterion to check.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(averageRange,...values){const _averageRange=toMatrix(averageRange);let count=0;let sum=0;visitMatchingRanges(values,(i,j)=>{const value=_averageRange[i][j];if(typeof value==="number"){count+=1;sum+=value;}},this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const COUNT={description:_t("The number of numeric values in dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when counting.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when counting.")),],returns:["NUMBER"],compute:function(...values){let count=0;for(let n of values){if(isMatrix(n)){for(let i of n){for(let j of i){if(typeof j==="number"){count+=1;}}}}
else if(typeof n!=="string"||isNumber(n,this.locale)||parseDateTime(n,this.locale)){count+=1;}}
return count;},isExported:true,};const COUNTA={description:_t("The number of values in a dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when counting.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when counting.")),],returns:["NUMBER"],compute:function(...values){return reduceAny(values,(acc,a)=>(a!==undefined&&a!==null?acc+1:acc),0);},isExported:true,};const COVAR={description:_t("The covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,false);},isExported:true,};const COVARIANCE_P={description:_t("The covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,false);},isExported:true,};const COVARIANCE_S={description:_t("The sample covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,true);},isExported:true,};const FORECAST={description:_t("Calculates the expected y-value for a specified x based on a linear regression of a dataset."),args:[arg("x (number, range<number>)",_t("The value(s) on the x-axis to forecast.")),arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(x,dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);return predictLinearValues([flatDataY],[flatDataX],matrixMap(toMatrix(x),(value)=>toNumber(value,this.locale)),true);},isExported:true,};const GROWTH={description:_t("Fits points to exponential growth trend."),args:[arg("known_data_y (range<number>)",_t("The array or range containing dependent (y) values that are already known, used to curve fit an ideal exponential growth curve.")),arg("known_data_x (range<number>, default={1;2;3;...})",_t("The values of the independent variable(s) corresponding with known_data_y.")),arg("new_data_x (any, range, default=known_data_x)",_t("The data points to return the y values for on the ideal curve fit.")),arg("b (boolean, default=TRUE)",_t("Given a general exponential form of y = b*m^x for a curve fit, calculates b if TRUE or forces b to be 1 and only calculates the m values if FALSE.")),],returns:["NUMBER"],compute:function(knownDataY,knownDataX=[],newDataX=[],b=true){return expM(predictLinearValues(logM(tryCastAsNumberMatrix(knownDataY,"the first argument (known_data_y)")),tryCastAsNumberMatrix(knownDataX,"the second argument (known_data_x)"),tryCastAsNumberMatrix(newDataX,"the third argument (new_data_y)"),toBoolean(b)));},};const INTERCEPT={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const[[],[intercept]]=fullLinearRegression([flatDataX],[flatDataY]);return intercept;},isExported:true,};const LARGE={description:_t("Nth largest element from a data set."),args:[arg("data (any, range)",_t("Array or range containing the dataset to consider.")),arg("n (number)",_t("The rank from largest to smallest of the element to return.")),],returns:["NUMBER"],computeValueAndFormat:function(data,n){const _n=Math.trunc(toNumber(n?.value,this.locale));let largests=[];let index;let count=0;visitAny([data],(d)=>{if(typeof d.value==="number"){index=dichotomicSearch(largests,d.value,"nextSmaller","asc",largests.length,(array,i)=>array[i].value);largests.splice(index+1,0,d);count++;if(count>_n){largests.shift();count--;}}});const result=largests.shift();assert(()=>result!==undefined,_t("[[FUNCTION_NAME]] has no valid input data."));assert(()=>count>=_n,_t("Function [[FUNCTION_NAME]] parameter 2 value (%s) is out of range.",_n));return result;},isExported:true,};const LINEST={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>, default={1;2;3;...})",_t("The range representing the array or matrix of independent data.")),arg("calculate_b (boolean, default=TRUE)",_t("A flag specifying wheter to compute the slope or not")),arg("verbose (boolean, default=FALSE)",_t("A flag specifying whether to return additional regression statistics or only the linear coefficients and the y-intercept")),],returns:["NUMBER"],compute:function(dataY,dataX=[],calculateB=true,verbose=false){return fullLinearRegression(tryCastAsNumberMatrix(dataX,"the first argument (data_y)"),tryCastAsNumberMatrix(dataY,"the second argument (data_x)"),toBoolean(calculateB),toBoolean(verbose));},isExported:true,};const LOGEST={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>, optional, default={1;2;3;...})",_t("The range representing the array or matrix of independent data.")),arg("calculate_b (boolean, default=TRUE)",_t("A flag specifying wheter to compute the slope or not")),arg("verbose (boolean, default=FALSE)",_t("A flag specifying whether to return additional regression statistics or only the linear coefficients and the y-intercept")),],returns:["NUMBER"],compute:function(dataY,dataX=[],calculateB=true,verbose=false){const coeffs=fullLinearRegression(tryCastAsNumberMatrix(dataX,"the second argument (data_x)"),logM(tryCastAsNumberMatrix(dataY,"the first argument (data_y)")),toBoolean(calculateB),toBoolean(verbose));for(let i=0;i<coeffs.length;i++){coeffs[i][0]=Math.exp(coeffs[i][0]);}
return coeffs;},isExported:true,};const MATTHEWS={description:_t("Compute the Matthews correlation coefficient of a dataset."),args:[arg("data_x (range)",_t("The range representing the array or matrix of observed data.")),arg("data_y (range)",_t("The range representing the array or matrix of predicted data.")),],returns:["NUMBER"],compute:function(dataX,dataY){const flatX=dataX.flat();const flatY=dataY.flat();assertSameNumberOfElements(flatX,flatY);if(flatX.length===0){throw new Error(_t("[[FUNCTION_NAME]] expects non-empty ranges for both parameters."));}
const n=flatX.length;let trueN=0,trueP=0,falseP=0,falseN=0;for(let i=0;i<n;++i){const isTrue1=toBoolean(flatX[i]);const isTrue2=toBoolean(flatY[i]);if(isTrue1===isTrue2){if(isTrue1){trueP++;}
else{trueN++;}}
else{if(isTrue1){falseN++;}
else{falseP++;}}}
return((trueP*trueN-falseP*falseN)/Math.sqrt((trueP+falseP)*(trueP+falseN)*(trueN+falseP)*(trueN+falseN)));},isExported:false,};const MAX={description:_t("Maximum value in a numeric dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the maximum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the maximum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const result=reduceNumbers(values,(acc,a)=>(acc<a?a:acc),-Infinity,this.locale);return result===-Infinity?0:result;},isExported:true,};const MAXA={description:_t("Maximum numeric value in a dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when calculating the maximum value.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when calculating the maximum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const maxa=reduceNumbersTextAs0(values,(acc,a)=>{return Math.max(a,acc);},-Infinity,this.locale);return maxa===-Infinity?0:maxa;},isExported:true,};const MAXIFS={description:_t("Returns the maximum value in a range of cells, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the maximum will be determined.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...args){let result=-Infinity;const _range=toMatrix(range);visitMatchingRanges(args,(i,j)=>{const value=_range[i][j];if(typeof value==="number"){result=result<value?value:result;}},this.locale);return result===-Infinity?0:result;},isExported:true,};const MEDIAN={description:_t("Median value in a numeric dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when calculating the median value.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when calculating the median value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let data=[];visitNumbers(values,(arg)=>{data.push(arg);},this.locale);return centile(data,0.5,true,this.locale);},isExported:true,};const MIN={description:_t("Minimum value in a numeric dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the minimum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the minimum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const result=reduceNumbers(values,(acc,a)=>(a<acc?a:acc),Infinity,this.locale);return result===Infinity?0:result;},isExported:true,};const MINA={description:_t("Minimum numeric value in a dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the minimum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the minimum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const mina=reduceNumbersTextAs0(values,(acc,a)=>{return Math.min(a,acc);},Infinity,this.locale);return mina===Infinity?0:mina;},isExported:true,};const MINIFS={description:_t("Returns the minimum value in a range of cells, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the minimum will be determined.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...args){let result=Infinity;const _range=toMatrix(range);visitMatchingRanges(args,(i,j)=>{const value=_range[i][j];if(typeof value==="number"){result=result>value?value:result;}},this.locale);return result===Infinity?0:result;},isExported:true,};const PEARSON={description:_t("Compute the Pearson product-moment correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataX,dataY);if(flatDataX.length===0){throw new Error(_t("[[FUNCTION_NAME]] expects non-empty ranges for both parameters."));}
if(flatDataX.length<2){throw new Error(_t("[[FUNCTION_NAME]] needs at least two values for both parameters"));}
const n=flatDataX.length;let sumX=0,sumY=0,sumXY=0,sumXX=0,sumYY=0;for(let i=0;i<n;i++){const xij=flatDataX[i];const yij=flatDataY[i];sumX+=xij;sumY+=yij;sumXY+=xij*yij;sumXX+=xij*xij;sumYY+=yij*yij;}
return((n*sumXY-sumX*sumY)/Math.sqrt((n*sumXX-sumX*sumX)*(n*sumYY-sumY*sumY)));},isExported:true,};const CORREL=PEARSON;const PERCENTILE={description:_t("Value at a given percentile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile whose value within data will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return PERCENTILE_INC.compute.bind(this)(data,percentile);},isExported:true,};const PERCENTILE_EXC={description:_t("Value at a given percentile of a dataset exclusive of 0 and 1."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile, exclusive of 0 and 1, whose value within 'data' will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return centile([data],percentile,false,this.locale);},isExported:true,};const PERCENTILE_INC={description:_t("Value at a given percentile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile whose value within data will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return centile([data],percentile,true,this.locale);},isExported:true,};const POLYFIT_COEFFS={description:_t("Compute the coefficients of polynomial regression of the dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),arg("order (number)",_t("The order of the polynomial to fit the data, between 1 and 6.")),arg("intercept (boolean, default=TRUE)",_t("A flag specifying whether to compute the intercept or not.")),],returns:["RANGE<NUMBER>"],compute:function(dataY,dataX,order,intercept=true){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);return polynomialRegression(flatDataY,flatDataX,toNumber(order,this.locale),toBoolean(intercept));},isExported:false,};const POLYFIT_FORECAST={description:_t("Predict value by computing a polynomial regression of the dataset."),args:[arg("x (number, range<number>)",_t("The value(s) on the x-axis to forecast.")),arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),arg("order (number)",_t("The order of the polynomial to fit the data, between 1 and 6.")),arg("intercept (boolean, default=TRUE)",_t("A flag specifying whether to compute the intercept or not.")),],returns:["NUMBER"],compute:function(x,dataY,dataX,order,intercept=true){const _order=toNumber(order,this.locale);const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const coeffs=polynomialRegression(flatDataY,flatDataX,_order,toBoolean(intercept)).flat();return matrixMap(toMatrix(x),(xij)=>evaluatePolynomial(coeffs,toNumber(xij,this.locale),_order));},isExported:false,};const QUARTILE={description:_t("Value nearest to a specific quartile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){return QUARTILE_INC.compute.bind(this)(data,quartileNumber);},isExported:true,};const QUARTILE_EXC={description:_t("Value nearest to a specific quartile of a dataset exclusive of 0 and 4."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value, exclusive of 0 and 4, to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){const _quartileNumber=Math.trunc(toNumber(quartileNumber,this.locale));return centile([data],0.25*_quartileNumber,false,this.locale);},isExported:true,};const QUARTILE_INC={description:_t("Value nearest to a specific quartile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){const _quartileNumber=Math.trunc(toNumber(quartileNumber,this.locale));return centile([data],0.25*_quartileNumber,true,this.locale);},isExported:true,};const RANK={description:_t("Returns the rank of a specified value in a dataset."),args:[arg("value (number)",_t("The value whose rank will be determined.")),arg("data (range)",_t("The range containing the dataset to consider.")),arg("is_ascending (boolean, default=FALSE)",_t("Whether to consider the values in data in descending or ascending order.")),],returns:["ANY"],compute:function(value,data,isAscending=false){const _isAscending=toBoolean(isAscending);const _value=toNumber(value,this.locale);let rank=1;let found=false;for(const row of data){for(const cell of row){if(typeof cell!=="number"){continue;}
const _cell=toNumber(cell,this.locale);if(_cell===_value){found=true;}
else if(_cell>_value!==_isAscending){rank++;}}}
if(!found){throw new NotAvailableError(_t("Value not found in the given data."));}
return rank;},isExported:true,};const RSQ={description:_t("Compute the square of r, the Pearson product-moment correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const pearson=PEARSON.compute.bind(this);return Math.pow(pearson(dataX,dataY),2.0);},isExported:true,};const SLOPE={description:_t("Compute the slope of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const[[slope]]=fullLinearRegression([flatDataX],[flatDataY]);return slope;},isExported:true,};const SMALL={description:_t("Nth smallest element in a data set."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("n (number)",_t("The rank from smallest to largest of the element to return.")),],returns:["NUMBER"],computeValueAndFormat:function(data,n){const _n=Math.trunc(toNumber(n?.value,this.locale));let largests=[];let index;let count=0;visitAny([data],(d)=>{if(typeof d.value==="number"){index=dichotomicSearch(largests,d.value,"nextSmaller","asc",largests.length,(array,i)=>array[i].value);largests.splice(index+1,0,d);count++;if(count>_n){largests.pop();count--;}}});const result=largests.pop();assert(()=>result!==undefined,_t("[[FUNCTION_NAME]] has no valid input data."));assert(()=>count>=_n,_t("Function [[FUNCTION_NAME]] parameter 2 value (%s) is out of range.",_n));return result;},isExported:true,};const SPEARMAN={description:_t("Compute the Spearman rank correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataX,dataY){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const n=flatDataX.length;const order=flatDataX.map((e,i)=>[e,flatDataY[i]]);order.sort((a,b)=>a[0]-b[0]);for(let i=0;i<n;++i){order[i][0]=i;}
order.sort((a,b)=>a[1]-b[1]);let sum=0.0;for(let i=0;i<n;++i){sum+=(order[i][0]-i)**2;}
return 1-(6*sum)/(n**3-n);},isExported:false,};const STDEV={description:_t("Standard deviation."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR.compute.bind(this)(...values));},isExported:true,};const STDEV_P={description:_t("Standard deviation of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR_P.compute.bind(this)(...values));},isExported:true,};const STDEV_S={description:_t("Standard deviation."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR_S.compute.bind(this)(...values));},isExported:true,};const STDEVA={description:_t("Standard deviation of sample (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARA.compute.bind(this)(...values));},isExported:true,};const STDEVP={description:_t("Standard deviation of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARP.compute.bind(this)(...values));},isExported:true,};const STDEVPA={description:_t("Standard deviation of entire population (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARPA.compute.bind(this)(...values));},isExported:true,};const STEYX={description:_t("Calculates the standard error of the predicted y-value for each x in the regression of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const data=fullLinearRegression([flatDataX],[flatDataY],true,true);return data[1][2];},isExported:true,};const TREND={description:_t("Fits points to linear trend derived via least-squares."),args:[arg("known_data_y (number, range<number>)",_t("The array or range containing dependent (y) values that are already known, used to curve fit an ideal linear trend.")),arg("known_data_x (number, range<number>, optional, default={1;2;3;...})",_t("The values of the independent variable(s) corresponding with known_data_y.")),arg("new_data_x (number, range<number>, optional, default=known_data_x)",_t("The data points to return the y values for on the ideal curve fit.")),arg("b (boolean, optional, default=TRUE)",_t("Given a general linear form of y = m*x+b for a curve fit, calculates b if TRUE or forces b to be 0 and only calculates the m values if FALSE, i.e. forces the curve fit to pass through the origin.")),],returns:["NUMBER"],compute:function(knownDataY,knownDataX=[],newDataX=[],b=true){return predictLinearValues(tryCastAsNumberMatrix(knownDataY,"the first argument (known_data_y)"),tryCastAsNumberMatrix(knownDataX,"the second argument (known_data_x)"),tryCastAsNumberMatrix(newDataX,"the third argument (new_data_y)"),toBoolean(b));},};const VAR={description:_t("Variance."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,false,this.locale);},isExported:true,};const VAR_P={description:_t("Variance of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,false,this.locale);},isExported:true,};const VAR_S={description:_t("Variance."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,false,this.locale);},isExported:true,};const VARA={description:_t("Variance of sample (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,true,this.locale);},isExported:true,};const VARP={description:_t("Variance of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,false,this.locale);},isExported:true,};const VARPA={description:_t("Variance of entire population (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,true,this.locale);},isExported:true,};var statistical=Object.freeze({__proto__:null,AVEDEV:AVEDEV,AVERAGE:AVERAGE,AVERAGEA:AVERAGEA,AVERAGEIF:AVERAGEIF,AVERAGEIFS:AVERAGEIFS,AVERAGE_WEIGHTED:AVERAGE_WEIGHTED,CORREL:CORREL,COUNT:COUNT,COUNTA:COUNTA,COVAR:COVAR,COVARIANCE_P:COVARIANCE_P,COVARIANCE_S:COVARIANCE_S,FORECAST:FORECAST,GROWTH:GROWTH,INTERCEPT:INTERCEPT,LARGE:LARGE,LINEST:LINEST,LOGEST:LOGEST,MATTHEWS:MATTHEWS,MAX:MAX,MAXA:MAXA,MAXIFS:MAXIFS,MEDIAN:MEDIAN,MIN:MIN,MINA:MINA,MINIFS:MINIFS,PEARSON:PEARSON,PERCENTILE:PERCENTILE,PERCENTILE_EXC:PERCENTILE_EXC,PERCENTILE_INC:PERCENTILE_INC,POLYFIT_COEFFS:POLYFIT_COEFFS,POLYFIT_FORECAST:POLYFIT_FORECAST,QUARTILE:QUARTILE,QUARTILE_EXC:QUARTILE_EXC,QUARTILE_INC:QUARTILE_INC,RANK:RANK,RSQ:RSQ,SLOPE:SLOPE,SMALL:SMALL,SPEARMAN:SPEARMAN,STDEV:STDEV,STDEVA:STDEVA,STDEVP:STDEVP,STDEVPA:STDEVPA,STDEV_P:STDEV_P,STDEV_S:STDEV_S,STEYX:STEYX,TREND:TREND,VAR:VAR,VARA:VARA,VARP:VARP,VARPA:VARPA,VAR_P:VAR_P,VAR_S:VAR_S});function getMatchingCells(database,field,criteria,locale){const indexColNameDB=new Map();const dimRowDB=database.length;for(let indexCol=dimRowDB-1;indexCol>=0;indexCol--){indexColNameDB.set(toString(database[indexCol][0]).toUpperCase(),indexCol);}
if(typeof field!=="number"&&typeof field!=="string"){throw new Error(_t("The field must be a number or a string"));}
let index;if(typeof field==="number"){index=Math.trunc(field)-1;if(index<0||dimRowDB-1<index){throw new Error(_t("The field (%s) must be one of %s or must be a number between 1 and %s inclusive.",field.toString(),dimRowDB.toString()));}}
else{const colName=toString(field).toUpperCase();index=indexColNameDB.get(colName)??-1;if(index===-1){throw new Error(_t("The field (%s) must be one of %s.",toString(field),[...indexColNameDB.keys()].toString()));}}
const dimColCriteria=criteria[0].length;if(dimColCriteria<2){throw new Error(_t("The criteria range contains %s row, it must be at least 2 rows.",dimColCriteria.toString()));}
let matchingRows=new Set();const dimColDB=database[0].length;for(let indexRow=1;indexRow<dimColCriteria;indexRow++){let args=[];let existColNameDB=true;for(let indexCol=0;indexCol<criteria.length;indexCol++){const currentName=toString(criteria[indexCol][0]).toUpperCase();const indexColDB=indexColNameDB.get(currentName);const criter=criteria[indexCol][indexRow];if(criter!==null){if(indexColDB!==undefined){args.push([database[indexColDB].slice(1,dimColDB)]);args.push(criter);}
else{existColNameDB=false;break;}}}
if(existColNameDB){if(args.length>0){visitMatchingRanges(args,(i,j)=>{matchingRows.add(j);},locale,true);}
else{matchingRows=new Set(Array(dimColDB-1).keys());break;}}}
const fieldCol=database[index];const matchingCells=[...matchingRows].map((x)=>fieldCol[x+1]);return matchingCells;}
const databaseArgs=[arg("database (range)",_t("The array or range containing the data to consider, structured in such a way that the first row contains the labels for each column's values.")),arg("field (any)",_t("Indicates which column in database contains the values to be extracted and operated on.")),arg("criteria (range)",_t("An array or range containing zero or more criteria to filter the database values by before operating.")),];const DAVERAGE={description:_t("Average of a set of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return AVERAGE.compute.bind(this)([cells]);},isExported:true,};const DCOUNT={description:_t("Counts values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return COUNT.compute.bind(this)([cells]);},isExported:true,};const DCOUNTA={description:_t("Counts values and text from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return COUNTA.compute.bind(this)([cells]);},isExported:true,};const DGET={description:_t("Single value from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);assert(()=>cells.length===1,_t("More than one match found in DGET evaluation."));return cells[0];},isExported:true,};const DMAX={description:_t("Maximum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return MAX.compute.bind(this)([cells]);},isExported:true,};const DMIN={description:_t("Minimum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return MIN.compute.bind(this)([cells]);},isExported:true,};const DPRODUCT={description:_t("Product of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return PRODUCT.compute.bind(this)([cells]);},isExported:true,};const DSTDEV={description:_t("Standard deviation of population sample from table."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return STDEV.compute.bind(this)([cells]);},isExported:true,};const DSTDEVP={description:_t("Standard deviation of entire population from table."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return STDEVP.compute.bind(this)([cells]);},isExported:true,};const DSUM={description:_t("Sum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return SUM.compute.bind(this)([cells]);},isExported:true,};const DVAR={description:_t("Variance of population sample from table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return VAR.compute.bind(this)([cells]);},isExported:true,};const DVARP={description:_t("Variance of a population from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return VARP.compute.bind(this)([cells]);},isExported:true,};var database=Object.freeze({__proto__:null,DAVERAGE:DAVERAGE,DCOUNT:DCOUNT,DCOUNTA:DCOUNTA,DGET:DGET,DMAX:DMAX,DMIN:DMIN,DPRODUCT:DPRODUCT,DSTDEV:DSTDEV,DSTDEVP:DSTDEVP,DSUM:DSUM,DVAR:DVAR,DVARP:DVARP});const DEFAULT_TYPE=1;const DEFAULT_WEEKEND=1;var TIME_UNIT;(function(TIME_UNIT){TIME_UNIT["WHOLE_YEARS"]="Y";TIME_UNIT["WHOLE_MONTHS"]="M";TIME_UNIT["WHOLE_DAYS"]="D";TIME_UNIT["DAYS_WITHOUT_WHOLE_MONTHS"]="MD";TIME_UNIT["MONTH_WITHOUT_WHOLE_YEARS"]="YM";TIME_UNIT["DAYS_BETWEEN_NO_MORE_THAN_ONE_YEAR"]="YD";})(TIME_UNIT||(TIME_UNIT={}));const DATE={description:_t("Converts year/month/day into a date."),args:[arg("year (number)",_t("The year component of the date.")),arg("month (number)",_t("The month component of the date.")),arg("day (number)",_t("The day component of the date.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(year,month,day){let _year=Math.trunc(toNumber(year,this.locale));const _month=Math.trunc(toNumber(month,this.locale));const _day=Math.trunc(toNumber(day,this.locale));assert(()=>0<=_year&&_year<=9999,_t("The year (%s) must be between 0 and 9999 inclusive.",_year.toString()));if(_year<1900){_year+=1900;}
const jsDate=new DateTime(_year,_month-1,_day);const result=jsDateToRoundNumber(jsDate);assert(()=>result>=0,_t("The function [[FUNCTION_NAME]] result must be greater than or equal 01/01/1900."));return result;},isExported:true,};const DATEDIF={description:_t("Calculates the number of days, months, or years between two dates."),args:[arg("start_date (date)",_t("The start date to consider in the calculation. Must be a reference to a cell containing a DATE, a function returning a DATE type, or a number.")),arg("end_date (date)",_t("The end date to consider in the calculation. Must be a reference to a cell containing a DATE, a function returning a DATE type, or a number.")),arg("unit (string)",_t('A text abbreviation for unit of time. Accepted values are "Y" (the number of whole years between start_date and end_date), "M" (the number of whole months between start_date and end_date), "D" (the number of days between start_date and end_date), "MD" (the number of days between start_date and end_date after subtracting whole months), "YM" (the number of whole months between start_date and end_date after subtracting whole years), "YD" (the number of days between start_date and end_date, assuming start_date and end_date were no more than one year apart).')),],returns:["NUMBER"],compute:function(startDate,endDate,unit){const _unit=toString(unit).toUpperCase();assert(()=>Object.values(TIME_UNIT).includes(_unit),expectStringSetError(Object.values(TIME_UNIT),toString(unit)));const _startDate=Math.trunc(toNumber(startDate,this.locale));const _endDate=Math.trunc(toNumber(endDate,this.locale));const jsStartDate=numberToJsDate(_startDate);const jsEndDate=numberToJsDate(_endDate);assert(()=>_endDate>=_startDate,_t("start_date (%s) should be on or before end_date (%s).",jsStartDate.toLocaleDateString(),jsEndDate.toLocaleDateString()));switch(_unit){case TIME_UNIT.WHOLE_YEARS:return getTimeDifferenceInWholeYears(jsStartDate,jsEndDate);case TIME_UNIT.WHOLE_MONTHS:return getTimeDifferenceInWholeMonths(jsStartDate,jsEndDate);case TIME_UNIT.WHOLE_DAYS:{return getTimeDifferenceInWholeDays(jsStartDate,jsEndDate);}
case TIME_UNIT.MONTH_WITHOUT_WHOLE_YEARS:{return(getTimeDifferenceInWholeMonths(jsStartDate,jsEndDate)-
getTimeDifferenceInWholeYears(jsStartDate,jsEndDate)*12);}
case TIME_UNIT.DAYS_WITHOUT_WHOLE_MONTHS:let days=jsEndDate.getDate()-jsStartDate.getDate();if(days<0){const monthBeforeEndMonth=new DateTime(jsEndDate.getFullYear(),jsEndDate.getMonth()-1,1);const daysInMonthBeforeEndMonth=getDaysInMonth(monthBeforeEndMonth);days=daysInMonthBeforeEndMonth-Math.abs(days);}
return days;case TIME_UNIT.DAYS_BETWEEN_NO_MORE_THAN_ONE_YEAR:{if(areTwoDatesWithinOneYear(_startDate,_endDate)){return getTimeDifferenceInWholeDays(jsStartDate,jsEndDate);}
const endDateWithinOneYear=new DateTime(jsStartDate.getFullYear(),jsEndDate.getMonth(),jsEndDate.getDate());let days=getTimeDifferenceInWholeDays(jsStartDate,endDateWithinOneYear);if(days<0){endDateWithinOneYear.setFullYear(jsStartDate.getFullYear()+1);days=getTimeDifferenceInWholeDays(jsStartDate,endDateWithinOneYear);}
return days;}}},isExported:true,};const DATEVALUE={description:_t("Converts a date string to a date value."),args:[arg("date_string (string)",_t("The string representing the date."))],returns:["NUMBER"],compute:function(dateString){const _dateString=toString(dateString);const internalDate=parseDateTime(_dateString,this.locale);assert(()=>internalDate!==null,_t("The date_string (%s) cannot be parsed to date/time.",_dateString.toString()));return Math.trunc(internalDate.value);},isExported:true,};const DAY={description:_t("Day of the month that a specific date falls on."),args:[arg("date (string)",_t("The date from which to extract the day."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getDate();},isExported:true,};const DAYS={description:_t("Number of days between two dates."),args:[arg("end_date (date)",_t("The end of the date range.")),arg("start_date (date)",_t("The start of the date range.")),],returns:["NUMBER"],compute:function(endDate,startDate){const _endDate=toJsDate(endDate,this.locale);const _startDate=toJsDate(startDate,this.locale);const dateDif=_endDate.getTime()-_startDate.getTime();return Math.round(dateDif/MS_PER_DAY);},isExported:true,};const DEFAULT_DAY_COUNT_METHOD=0;const DAYS360={description:_t("Number of days between two dates on a 360-day year (months of 30 days)."),args:[arg("start_date (date)",_t("The start date to consider in the calculation.")),arg("end_date (date)",_t("The end date to consider in the calculation.")),arg(`method (number, default=${DEFAULT_DAY_COUNT_METHOD})`,_t("An indicator of what day count method to use. (0) US NASD method (1) European method")),],returns:["NUMBER"],compute:function(startDate,endDate,method=DEFAULT_DAY_COUNT_METHOD){const _startDate=toNumber(startDate,this.locale);const _endDate=toNumber(endDate,this.locale);const dayCountConvention=toBoolean(method)?4:0;const yearFrac=YEARFRAC.compute.bind(this)(startDate,endDate,dayCountConvention);return Math.sign(_endDate-_startDate)*Math.round(yearFrac*360);},isExported:true,};const EDATE={description:_t("Date a number of months before/after another date."),args:[arg("start_date (date)",_t("The date from which to calculate the result.")),arg("months (number)",_t("The number of months before (negative) or after (positive) 'start_date' to calculate.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,months){const _startDate=toJsDate(startDate,this.locale);const _months=Math.trunc(toNumber(months,this.locale));const jsDate=addMonthsToDate(_startDate,_months,false);return jsDateToRoundNumber(jsDate);},isExported:true,};const EOMONTH={description:_t("Last day of a month before or after a date."),args:[arg("start_date (date)",_t("The date from which to calculate the result.")),arg("months (number)",_t("The number of months before (negative) or after (positive) 'start_date' to consider.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,months){const _startDate=toJsDate(startDate,this.locale);const _months=Math.trunc(toNumber(months,this.locale));const yStart=_startDate.getFullYear();const mStart=_startDate.getMonth();const jsDate=new DateTime(yStart,mStart+_months+1,0);return jsDateToRoundNumber(jsDate);},isExported:true,};const HOUR={description:_t("Hour component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the hour component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getHours();},isExported:true,};const ISOWEEKNUM={description:_t("ISO week number of the year."),args:[arg("date (date)",_t("The date for which to determine the ISO week number. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),],returns:["NUMBER"],compute:function(date){const _date=toJsDate(date,this.locale);const y=_date.getFullYear();let firstThursday=1;while(new DateTime(y,0,firstThursday).getDay()!==4){firstThursday+=1;}
const firstDayOfFirstWeek=new DateTime(y,0,firstThursday-3);let lastThursday=31;while(new DateTime(y,11,lastThursday).getDay()!==4){lastThursday-=1;}
const lastDayOfLastWeek=new DateTime(y,11,lastThursday+3);let offsetYear;if(firstDayOfFirstWeek.getTime()<=_date.getTime()){if(_date.getTime()<=lastDayOfLastWeek.getTime()){offsetYear=0;}
else{offsetYear=1;}}
else{offsetYear=-1;}
let firstDay;switch(offsetYear){case 0:firstDay=firstDayOfFirstWeek;break;case 1:firstDay=new DateTime(y,11,lastThursday+3+1);break;case-1:let firstThursdayPreviousYear=1;while(new DateTime(y-1,0,firstThursdayPreviousYear).getDay()!==4){firstThursdayPreviousYear+=1;}
firstDay=new DateTime(y-1,0,firstThursdayPreviousYear-3);break;}
const diff=(_date.getTime()-firstDay.getTime())/MS_PER_DAY;return Math.floor(diff/7)+1;},isExported:true,};const MINUTE={description:_t("Minute component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the minute component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getMinutes();},isExported:true,};const MONTH={description:_t("Month of the year a specific date falls in"),args:[arg("date (date)",_t("The date from which to extract the month."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getMonth()+1;},isExported:true,};const NETWORKDAYS={description:_t("Net working days between two provided days."),args:[arg("start_date (date)",_t("The start date of the period from which to calculate the number of net working days.")),arg("end_date (date)",_t("The end date of the period from which to calculate the number of net working days.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the date serial numbers to consider holidays.")),],returns:["NUMBER"],compute:function(startDate,endDate,holidays){return NETWORKDAYS_INTL.compute.bind(this)(startDate,endDate,1,holidays);},isExported:true,};function weekendToDayNumber(weekend){if(typeof weekend==="string"){assert(()=>{if(weekend.length!==7){return false;}
for(let day of weekend){if(day!=="0"&&day!=="1"){return false;}}
return true;},_t('When weekend is a string (%s) it must be composed of "0" or "1".',weekend));let result=[];for(let i=0;i<7;i++){if(weekend[i]==="1"){result.push((i+1)%7);}}
return result;}
if(typeof weekend==="number"){assert(()=>(1<=weekend&&weekend<=7)||(11<=weekend&&weekend<=17),_t("The weekend (%s) must be a string or a number in the range 1-7 or 11-17.",weekend.toString()));if(weekend<=7){return[weekend-2===-1?6:weekend-2,weekend-1];}
return[weekend-11];}
throw Error(_t("The weekend must be a number or a string."));}
const NETWORKDAYS_INTL={description:_t("Net working days between two dates (specifying weekends)."),args:[arg("start_date (date)",_t("The start date of the period from which to calculate the number of net working days.")),arg("end_date (date)",_t("The end date of the period from which to calculate the number of net working days.")),arg(`weekend (any, default=${DEFAULT_WEEKEND})`,_t("A number or string representing which days of the week are considered weekends.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider as holidays.")),],returns:["NUMBER"],compute:function(startDate,endDate,weekend=DEFAULT_WEEKEND,holidays){const _startDate=toJsDate(startDate,this.locale);const _endDate=toJsDate(endDate,this.locale);const daysWeekend=weekendToDayNumber(weekend);let timesHoliday=new Set();if(holidays!==undefined){visitAny([holidays],(h)=>{const holiday=toJsDate(h,this.locale);timesHoliday.add(holiday.getTime());});}
const invertDate=_startDate.getTime()>_endDate.getTime();const stopDate=DateTime.fromTimestamp((invertDate?_startDate:_endDate).getTime());let stepDate=DateTime.fromTimestamp((invertDate?_endDate:_startDate).getTime());const timeStopDate=stopDate.getTime();let timeStepDate=stepDate.getTime();let netWorkingDay=0;while(timeStepDate<=timeStopDate){if(!daysWeekend.includes(stepDate.getDay())&&!timesHoliday.has(timeStepDate)){netWorkingDay+=1;}
stepDate.setDate(stepDate.getDate()+1);timeStepDate=stepDate.getTime();}
return invertDate?-netWorkingDay:netWorkingDay;},isExported:true,};const NOW={description:_t("Current date and time as a date value."),args:[],returns:["DATE"],computeFormat:function(){return getDateTimeFormat(this.locale);},compute:function(){let today=DateTime.now();const delta=today.getTime()-INITIAL_1900_DAY.getTime();const time=today.getHours()/24+today.getMinutes()/1440+today.getSeconds()/86400;return Math.floor(delta/MS_PER_DAY)+time;},isExported:true,};const SECOND={description:_t("Minute component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the second component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getSeconds();},isExported:true,};const TIME={description:_t("Converts hour/minute/second into a time."),args:[arg("hour (number)",_t("The hour component of the time.")),arg("minute (number)",_t("The minute component of the time.")),arg("second (number)",_t("The second component of the time.")),],returns:["DATE"],computeFormat:function(){return this.locale.timeFormat;},compute:function(hour,minute,second){let _hour=Math.trunc(toNumber(hour,this.locale));let _minute=Math.trunc(toNumber(minute,this.locale));let _second=Math.trunc(toNumber(second,this.locale));_minute+=Math.floor(_second/60);_second=(_second%60)+(_second<0?60:0);_hour+=Math.floor(_minute/60);_minute=(_minute%60)+(_minute<0?60:0);_hour%=24;assert(()=>_hour>=0,_t("The function [[FUNCTION_NAME]] result cannot be negative"));return _hour/24+_minute/(24*60)+_second/(24*60*60);},isExported:true,};const TIMEVALUE={description:_t("Converts a time string into its serial number representation."),args:[arg("time_string (string)",_t("The string that holds the time representation."))],returns:["NUMBER"],compute:function(timeString){const _timeString=toString(timeString);const internalDate=parseDateTime(_timeString,this.locale);assert(()=>internalDate!==null,_t("The time_string (%s) cannot be parsed to date/time.",_timeString));const result=internalDate.value-Math.trunc(internalDate.value);return result<0?1+result:result;},isExported:true,};const TODAY={description:_t("Current date as a date value."),args:[],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(){const today=DateTime.now();const jsDate=new DateTime(today.getFullYear(),today.getMonth(),today.getDate());return jsDateToRoundNumber(jsDate);},isExported:true,};const WEEKDAY={description:_t("Day of the week of the date provided (as number)."),args:[arg("date (date)",_t("The date for which to determine the day of the week. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`type (number, default=${DEFAULT_TYPE})`,_t("A number indicating which numbering system to use to represent weekdays. By default, counts starting with Sunday = 1.")),],returns:["NUMBER"],compute:function(date,type=DEFAULT_TYPE){const _date=toJsDate(date,this.locale);const _type=Math.round(toNumber(type,this.locale));const m=_date.getDay();assert(()=>[1,2,3].includes(_type),_t("The type (%s) must be 1, 2 or 3.",_type.toString()));if(_type===1)
return m+1;if(_type===2)
return m===0?7:m;return m===0?6:m-1;},isExported:true,};const WEEKNUM={description:_t("Week number of the year."),args:[arg("date (date)",_t("The date for which to determine the week number. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`type (number, default=${DEFAULT_TYPE})`,_t("A number representing the day that a week starts on. Sunday = 1.")),],returns:["NUMBER"],compute:function(date,type=DEFAULT_TYPE){const _date=toJsDate(date,this.locale);const _type=Math.round(toNumber(type,this.locale));assert(()=>_type===1||_type===2||(11<=_type&&_type<=17)||_type===21,_t("The type (%s) is out of range.",_type.toString()));if(_type===21){return ISOWEEKNUM.compute.bind(this)(date);}
let startDayOfWeek;if(_type===1||_type===2){startDayOfWeek=_type-1;}
else{startDayOfWeek=_type-10===7?0:_type-10;}
const y=_date.getFullYear();let dayStart=1;let startDayOfFirstWeek=new DateTime(y,0,dayStart);while(startDayOfFirstWeek.getDay()!==startDayOfWeek){dayStart+=1;startDayOfFirstWeek=new DateTime(y,0,dayStart);}
const dif=(_date.getTime()-startDayOfFirstWeek.getTime())/MS_PER_DAY;if(dif<0){return 1;}
return Math.floor(dif/7)+(dayStart===1?1:2);},isExported:true,};const WORKDAY={description:_t("Date after a number of workdays."),args:[arg("start_date (date)",_t("The date from which to begin counting.")),arg("num_days (number)",_t("The number of working days to advance from start_date. If negative, counts backwards.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider holidays.")),],returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,numDays,holidays=undefined){return WORKDAY_INTL.compute.bind(this)(startDate,numDays,1,holidays??null);},isExported:true,};const WORKDAY_INTL={description:_t("Date after a number of workdays (specifying weekends)."),args:[arg("start_date (date)",_t("The date from which to begin counting.")),arg("num_days (number)",_t("The number of working days to advance from start_date. If negative, counts backwards.")),arg(`weekend (any, default=${DEFAULT_WEEKEND})`,_t("A number or string representing which days of the week are considered weekends.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider holidays.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,numDays,weekend=DEFAULT_WEEKEND,holidays){let _startDate=toJsDate(startDate,this.locale);let _numDays=Math.trunc(toNumber(numDays,this.locale));if(typeof weekend==="string"){assert(()=>weekend!=="1111111",_t("The weekend (%s) must be different from '1111111'.",weekend));}
const daysWeekend=weekendToDayNumber(weekend);let timesHoliday=new Set();if(holidays!==undefined){visitAny([holidays],(h)=>{const holiday=toJsDate(h,this.locale);timesHoliday.add(holiday.getTime());});}
let stepDate=DateTime.fromTimestamp(_startDate.getTime());let timeStepDate=stepDate.getTime();const unitDay=Math.sign(_numDays);let stepDay=Math.abs(_numDays);while(stepDay>0){stepDate.setDate(stepDate.getDate()+unitDay);timeStepDate=stepDate.getTime();if(!daysWeekend.includes(stepDate.getDay())&&!timesHoliday.has(timeStepDate)){stepDay-=1;}}
const delta=timeStepDate-INITIAL_1900_DAY.getTime();return Math.round(delta/MS_PER_DAY);},isExported:true,};const YEAR={description:_t("Year specified by a given date."),args:[arg("date (date)",_t("The date from which to extract the year."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getFullYear();},isExported:true,};const DEFAULT_DAY_COUNT_CONVENTION$1=0;const YEARFRAC={description:_t("Exact number of years between two dates."),args:[arg("start_date (date)",_t("The start date to consider in the calculation. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg("end_date (date)",_t("The end date to consider in the calculation. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION$1})`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(startDate,endDate,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION$1){let _startDate=Math.trunc(toNumber(startDate,this.locale));let _endDate=Math.trunc(toNumber(endDate,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assert(()=>_startDate>=0,_t("The start_date (%s) must be positive or null.",_startDate.toString()));assert(()=>_endDate>=0,_t("The end_date (%s) must be positive or null.",_endDate.toString()));assert(()=>0<=_dayCountConvention&&_dayCountConvention<=4,_t("The day_count_convention (%s) must be between 0 and 4 inclusive.",_dayCountConvention.toString()));return getYearFrac(_startDate,_endDate,_dayCountConvention);},};const MONTH_START={description:_t("First day of the month preceding a date."),args:[arg("date (date)",_t("The date from which to calculate the result."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const _startDate=toJsDate(date,this.locale);const yStart=_startDate.getFullYear();const mStart=_startDate.getMonth();const jsDate=new DateTime(yStart,mStart,1);return jsDateToRoundNumber(jsDate);},};const MONTH_END={description:_t("Last day of the month following a date."),args:[arg("date (date)",_t("The date from which to calculate the result."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){return EOMONTH.compute.bind(this)(date,0);},};const QUARTER={description:_t("Quarter of the year a specific date falls in"),args:[arg("date (date)",_t("The date from which to extract the quarter."))],returns:["NUMBER"],compute:function(date){return Math.ceil((toJsDate(date,this.locale).getMonth()+1)/3);},};const QUARTER_START={description:_t("First day of the quarter of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the start of quarter."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const quarter=QUARTER.compute.bind(this)(date);const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,(quarter-1)*3,1);return jsDateToRoundNumber(jsDate);},};const QUARTER_END={description:_t("Last day of the quarter of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the end of quarter."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const quarter=QUARTER.compute.bind(this)(date);const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,quarter*3,0);return jsDateToRoundNumber(jsDate);},};const YEAR_START={description:_t("First day of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the start of the year."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,0,1);return jsDateToRoundNumber(jsDate);},};const YEAR_END={description:_t("Last day of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the end of the year."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year+1,0,0);return jsDateToRoundNumber(jsDate);},};var date=Object.freeze({__proto__:null,DATE:DATE,DATEDIF:DATEDIF,DATEVALUE:DATEVALUE,DAY:DAY,DAYS:DAYS,DAYS360:DAYS360,EDATE:EDATE,EOMONTH:EOMONTH,HOUR:HOUR,ISOWEEKNUM:ISOWEEKNUM,MINUTE:MINUTE,MONTH:MONTH,MONTH_END:MONTH_END,MONTH_START:MONTH_START,NETWORKDAYS:NETWORKDAYS,NETWORKDAYS_INTL:NETWORKDAYS_INTL,NOW:NOW,QUARTER:QUARTER,QUARTER_END:QUARTER_END,QUARTER_START:QUARTER_START,SECOND:SECOND,TIME:TIME,TIMEVALUE:TIMEVALUE,TODAY:TODAY,WEEKDAY:WEEKDAY,WEEKNUM:WEEKNUM,WORKDAY:WORKDAY,WORKDAY_INTL:WORKDAY_INTL,YEAR:YEAR,YEARFRAC:YEARFRAC,YEAR_END:YEAR_END,YEAR_START:YEAR_START});const DEFAULT_DELTA_ARG=0;const DELTA={description:_t("Compare two numeric values, returning 1 if they're equal."),args:[arg("number1 (number)",_t("The first number to compare.")),arg(`number2 (number, default=${DEFAULT_DELTA_ARG})`,_t("The second number to compare.")),],returns:["NUMBER"],compute:function(number1,number2=DEFAULT_DELTA_ARG){const _number1=toNumber(number1,this.locale);const _number2=toNumber(number2,this.locale);return _number1===_number2?1:0;},isExported:true,};var engineering=Object.freeze({__proto__:null,DELTA:DELTA});const SORT_TYPES=[CellValueType.number,CellValueType.error,CellValueType.text,CellValueType.boolean,];function cellsSortingCriterion(sortingOrder){const inverse=sortingOrder==="ascending"?1:-1;return(left,right)=>{if(left.type===CellValueType.empty){return right.type===CellValueType.empty?0:1;}
else if(right.type===CellValueType.empty){return-1;}
let typeOrder=SORT_TYPES.indexOf(left.type)-SORT_TYPES.indexOf(right.type);if(typeOrder===0){if(left.type===CellValueType.text||left.type===CellValueType.error){typeOrder=left.value.localeCompare(right.value);}
else{typeOrder=left.value-right.value;}}
return inverse*typeOrder;};}
function sortCells(cells,sortDirection,emptyCellAsZero){const cellsWithIndex=cells.map((cell,index)=>({index,type:cell.type,value:cell.value,}));const cellsToSort=emptyCellAsZero?cellsWithIndex.map((cell)=>cell.type===CellValueType.empty?{...cell,type:CellValueType.number,value:0}:cell):cellsWithIndex;return cellsToSort.sort(cellsSortingCriterion(sortDirection));}
function interactiveSortSelection(env,sheetId,anchor,zone,sortDirection){let result=DispatchResult.Success;let multiColumns=zone.right>zone.left;if(env.model.getters.doesIntersectMerge(sheetId,zone)){multiColumns=false;let table;for(let row=zone.top;row<=zone.bottom;row++){table=[];for(let col=zone.left;col<=zone.right;col++){let merge=env.model.getters.getMerge({sheetId,col,row});if(merge&&!table.includes(merge.id.toString())){table.push(merge.id.toString());}}
if(table.length>=2){multiColumns=true;break;}}}
const{col,row}=anchor;if(multiColumns){result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection});}
else{const contiguousZone=env.model.getters.getContiguousZone(sheetId,zone);if(isEqual(contiguousZone,zone)){result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});}
else{env.askConfirmation(_t("We found data next to your selection. Since this data was not selected, it will not be sorted. Do you want to extend your selection?"),()=>{zone=contiguousZone;result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});},()=>{result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});});}}
if(result.isCancelledBecause("InvalidSortZone")){const{col,row}=anchor;env.model.selection.selectZone({cell:{col,row},zone});env.raiseError(_t("Cannot sort. To sort, select only cells or only merges that have the same size."));}}
function sortMatrix(matrix,locale,...criteria){for(const[i,value]of criteria.entries()){assert(()=>value!==undefined,_t("Value for parameter %d is missing, while the function [[FUNCTION_NAME]] expect a number or a range.",i+1));}
const sortingOrders=[];const sortColumns=[];const nRows=matrix.length;for(let i=0;i<criteria.length;i+=2){sortingOrders.push(toBoolean(toScalar(criteria[i+1])?.value)?"ascending":"descending");const sortColumn=criteria[i];if(isMatrix(sortColumn)&&(sortColumn.length>1||sortColumn[0].length>1)){assert(()=>sortColumn.length===1&&sortColumn[0].length===nRows,_t("Wrong size for %s. Expected a range of size 1x%s. Got %sx%s.",`sort_column${i + 1}`,nRows,sortColumn.length,sortColumn[0].length));sortColumns.push(sortColumn.flat().map((c)=>c.value));}
else{const colIndex=toNumber(toScalar(sortColumn)?.value,locale);if(colIndex<1||colIndex>matrix[0].length){return matrix;}
sortColumns.push(matrix.map((row)=>row[colIndex-1].value));}}
if(sortColumns.length===0){for(let i=0;i<matrix[0].length;i++){sortColumns.push(matrix.map((row)=>row[i].value));sortingOrders.push("ascending");}}
const sortingCriteria={descending:cellsSortingCriterion("descending"),ascending:cellsSortingCriterion("ascending"),};const indexes=range(0,matrix.length);indexes.sort((a,b)=>{for(const[i,sortColumn]of sortColumns.entries()){const left=sortColumn[a];const right=sortColumn[b];const leftCell={value:left,type:left===null?CellValueType.empty:typeof left==="string"?CellValueType.text:typeof left,};const rightCell={value:right,type:right===null?CellValueType.empty:typeof right==="string"?CellValueType.text:typeof right,};const result=sortingCriteria[sortingOrders[i]](leftCell,rightCell);if(result!==0){return result;}}
return 0;});return indexes.map((i)=>matrix[i]);}
const FILTER={description:_t("Returns a filtered version of the source range, returning only rows or columns that meet the specified conditions."),args:[arg("range (any, range<any>)",_t("The data to be filtered.")),arg("condition1 (boolean, range<boolean>)",_t("A column or row containing true or false values corresponding to the first column or row of range.")),arg("condition2 (boolean, range<boolean>, repeating)",_t("Additional column or row containing true or false values.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,...conditions){let _array=toMatrix(range);const _conditionsMatrices=conditions.map((cond)=>matrixMap(toMatrix(cond),(data)=>data.value));_conditionsMatrices.map((c)=>assertSingleColOrRow(_t("The arguments condition must be a single column or row."),c));assertSameDimensions(_t("The arguments conditions must have the same dimensions."),..._conditionsMatrices);const _conditions=_conditionsMatrices.map((c)=>c.flat());const mode=_conditionsMatrices[0].length===1?"row":"col";_array=mode==="row"?transposeMatrix(_array):_array;assert(()=>_conditions.every((cond)=>cond.length===_array.length),_t("FILTER has mismatched sizes on the range and conditions."));const result=[];for(let i=0;i<_array.length;i++){const row=_array[i];if(_conditions.every((c)=>c[i])){result.push(row);}}
if(!result.length){throw new NotAvailableError(_t("No match found in FILTER evaluation"));}
return mode==="row"?transposeMatrix(result):result;},isExported:true,};const SORT={description:_t("Sorts the rows of a given array or range by the values in one or more columns."),args:[arg("range (range)",_t("The data to be sorted.")),arg("sort_column (any, range<number>, repeating)",_t("The index of the column in range or a range outside of range containing the values by which to sort.")),arg("is_ascending (boolean, repeating)",_t("TRUE or FALSE indicating whether to sort sort_column in ascending order. FALSE sorts in descending order.")),],returns:["RANGE"],computeValueAndFormat:function(range,...sortingCriteria){const _range=transposeMatrix(range);return transposeMatrix(sortMatrix(_range,this.locale,...sortingCriteria));},isExported:true,};const SORTN={description:_t("Returns the first n items in a data set after performing a sort."),args:[arg("range (range)",_t("The data to be sorted.")),arg("n (number, default=1)",_t("The number of items to return.")),arg("display_ties_mode (number, default=0)",_t("A number representing the way to display ties.")),arg("sort_column (number, range<number>, repeating)",_t("The index of the column in range or a range outside of range containing the values by which to sort.")),arg("is_ascending (boolean, repeating)",_t("TRUE or FALSE indicating whether to sort sort_column in ascending order. FALSE sorts in descending order.")),],returns:["RANGE"],computeValueAndFormat:function(range,n,displayTiesMode,...sortingCriteria){const _n=toNumber(n?.value??1,this.locale);assert(()=>_n>=0,_t("Wrong value of 'n'. Expected a positive number. Got %s.",_n));const _displayTiesMode=toNumber(displayTiesMode?.value??0,this.locale);assert(()=>_displayTiesMode>=0&&_displayTiesMode<=3,_t("Wrong value of 'display_ties_mode'. Expected a positive number between 0 and 3. Got %s.",_displayTiesMode));const sortedData=sortMatrix(transposeMatrix(range),this.locale,...sortingCriteria);const sameRows=(i,j)=>JSON.stringify(sortedData[i].map((c)=>c.value))===JSON.stringify(sortedData[j].map((c)=>c.value));switch(_displayTiesMode){case 0:return transposeMatrix(sortedData.slice(0,_n));case 1:for(let i=_n;i<sortedData.length;i++){if(!sameRows(i,_n-1)){return transposeMatrix(sortedData.slice(0,i));}}
return transposeMatrix(sortedData);case 2:{const uniques=[sortedData[0]];for(let i=1;i<sortedData.length;i++){for(let j=0;j<i;j++){if(sameRows(i,j)){break;}
if(j===i-1){uniques.push(sortedData[i]);}}}
return transposeMatrix(uniques.slice(0,_n));}
case 3:{const uniques=[sortedData[0]];let counter=1;for(let i=1;i<sortedData.length;i++){if(!sameRows(i,i-1)){counter++;}
if(counter>_n){break;}
uniques.push(sortedData[i]);}
return transposeMatrix(uniques);}}},isExported:true,};const UNIQUE={description:_t("Unique rows in the provided source range."),args:[arg("range (any, range<any>)",_t("The data to filter by unique entries.")),arg("by_column (boolean, default=FALSE)",_t("Whether to filter the data by columns or by rows.")),arg("exactly_once (boolean, default=FALSE)",_t("Whether to return only entries with no duplicates.")),],returns:["RANGE<NUMBER>"],computeValueAndFormat:function(range={value:""},byColumn,exactlyOnce){if(!isMatrix(range)){return[[range]];}
const _byColumn=toBoolean(byColumn?.value)||false;const _exactlyOnce=toBoolean(exactlyOnce?.value)||false;if(!_byColumn){range=transposeMatrix(range);}
const map=new Map();for(const data of range){const key=JSON.stringify(data.map((item)=>item.value));const occurrence=map.get(key);if(!occurrence){map.set(key,{data,count:1});}
else{occurrence.count++;}}
const result=[];for(const row of map.values()){if(_exactlyOnce&&row.count>1){continue;}
result.push(row.data);}
if(!result.length)
throw new Error(_t("No unique values found"));return _byColumn?result:transposeMatrix(result);},isExported:true,};var filter=Object.freeze({__proto__:null,FILTER:FILTER,SORT:SORT,SORTN:SORTN,UNIQUE:UNIQUE});function assertMaturityAndSettlementDatesAreValid(settlement,maturity){assert(()=>settlement<maturity,_t("The maturity (%s) must be strictly greater than the settlement (%s).",maturity.toString(),settlement.toString()));}
function assertSettlementAndIssueDatesAreValid(settlement,issue){assert(()=>issue<settlement,_t("The settlement date (%s) must be strictly greater than the issue date (%s).",settlement.toString(),issue.toString()));}
function assertCouponFrequencyIsValid(frequency){assert(()=>[1,2,4].includes(frequency),_t("The frequency (%s) must be one of %s",frequency.toString(),[1,2,4].toString()));}
function assertDayCountConventionIsValid(dayCountConvention){assert(()=>0<=dayCountConvention&&dayCountConvention<=4,_t("The day_count_convention (%s) must be between 0 and 4 inclusive.",dayCountConvention.toString()));}
function assertRedemptionStrictlyPositive(redemption){assert(()=>redemption>0,_t("The redemption (%s) must be strictly positive.",redemption.toString()));}
function assertPriceStrictlyPositive(price){assert(()=>price>0,_t("The price (%s) must be strictly positive.",price.toString()));}
function assertNumberOfPeriodsStrictlyPositive(nPeriods){assert(()=>nPeriods>0,_t("The number_of_periods (%s) must be greater than 0.",nPeriods.toString()));}
function assertRateStrictlyPositive(rate){assert(()=>rate>0,_t("The rate (%s) must be strictly positive.",rate.toString()));}
function assertLifeStrictlyPositive(life){assert(()=>life>0,_t("The life (%s) must be strictly positive.",life.toString()));}
function assertCostStrictlyPositive(cost){assert(()=>cost>0,_t("The cost (%s) must be strictly positive.",cost.toString()));}
function assertCostPositiveOrZero(cost){assert(()=>cost>=0,_t("The cost (%s) must be positive or null.",cost.toString()));}
function assertPeriodStrictlyPositive(period){assert(()=>period>0,_t("The period (%s) must be strictly positive.",period.toString()));}
function assertPeriodPositiveOrZero(period){assert(()=>period>=0,_t("The period (%s) must be positive or null.",period.toString()));}
function assertSalvagePositiveOrZero(salvage){assert(()=>salvage>=0,_t("The salvage (%s) must be positive or null.",salvage.toString()));}
function assertSalvageSmallerOrEqualThanCost(salvage,cost){assert(()=>salvage<=cost,_t("The salvage (%s) must be smaller or equal than the cost (%s).",salvage.toString(),cost.toString()));}
function assertPresentValueStrictlyPositive(pv){assert(()=>pv>0,_t("The present value (%s) must be strictly positive.",pv.toString()));}
function assertPeriodSmallerOrEqualToLife(period,life){assert(()=>period<=life,_t("The period (%s) must be less than or equal life (%s).",period.toString(),life.toString()));}
function assertInvestmentStrictlyPositive(investment){assert(()=>investment>0,_t("The investment (%s) must be strictly positive.",investment.toString()));}
function assertDiscountStrictlyPositive(discount){assert(()=>discount>0,_t("The discount (%s) must be strictly positive.",discount.toString()));}
function assertDiscountStrictlySmallerThanOne(discount){assert(()=>discount<1,_t("The discount (%s) must be smaller than 1.",discount.toString()));}
function assertDeprecationFactorStrictlyPositive(factor){assert(()=>factor>0,_t("The depreciation factor (%s) must be strictly positive.",factor.toString()));}
function assertSettlementLessThanOneYearBeforeMaturity(settlement,maturity,locale){const startDate=toJsDate(settlement,locale);const endDate=toJsDate(maturity,locale);const startDatePlusOneYear=toJsDate(settlement,locale);startDatePlusOneYear.setFullYear(startDate.getFullYear()+1);assert(()=>endDate.getTime()<=startDatePlusOneYear.getTime(),_t("The settlement date (%s) must at most one year after the maturity date (%s).",settlement.toString(),maturity.toString()));}
function assertFirstAndLastPeriodsAreValid(firstPeriod,lastPeriod,numberOfPeriods){assertNumberOfPeriodsStrictlyPositive(numberOfPeriods);assert(()=>firstPeriod>0,_t("The first_period (%s) must be strictly positive.",firstPeriod.toString()));assert(()=>lastPeriod>0,_t("The last_period (%s) must be strictly positive.",lastPeriod.toString()));assert(()=>firstPeriod<=lastPeriod,_t("The first_period (%s) must be smaller or equal to the last_period (%s).",firstPeriod.toString(),lastPeriod.toString()));assert(()=>lastPeriod<=numberOfPeriods,_t("The last_period (%s) must be smaller or equal to the number_of_periods (%s).",firstPeriod.toString(),numberOfPeriods.toString()));}
function assertStartAndEndPeriodAreValid(startPeriod,endPeriod,life){assertLifeStrictlyPositive(life);assert(()=>startPeriod>=0,_t("The start_period (%s) must be greater or equal than 0.",startPeriod.toString()));assert(()=>endPeriod>=0,_t("The end_period (%s) must be greater or equal than 0.",endPeriod.toString()));assert(()=>startPeriod<=endPeriod,_t("The start_period (%s) must be smaller or equal to the end_period (%s).",startPeriod.toString(),endPeriod.toString()));assert(()=>endPeriod<=life,_t("The end_period (%s) must be smaller or equal to the life (%s).",startPeriod.toString(),life.toString()));}
function assertRateGuessStrictlyGreaterThanMinusOne(guess){assert(()=>guess>-1,_t("The rate_guess (%s) must be strictly greater than -1.",guess.toString()));}
function assertCashFlowsAndDatesHaveSameDimension(cashFlows,dates){assert(()=>cashFlows.length===dates.length&&cashFlows[0].length===dates[0].length,_t("The cashflow_amounts and cashflow_dates ranges must have the same dimensions."));}
function assertCashFlowsHavePositiveAndNegativesValues(cashFlow){assert(()=>cashFlow.some((val)=>val>0)&&cashFlow.some((val)=>val<0),_t("There must be both positive and negative values in cashflow_amounts."));}
function assertEveryDateGreaterThanFirstDateOfCashFlowDates(dates){assert(()=>dates.every((date)=>date>=dates[0]),_t("All the dates should be greater or equal to the first date in cashflow_dates (%s).",dates[0].toString()));}
const DEFAULT_DAY_COUNT_CONVENTION=0;const DEFAULT_END_OR_BEGINNING=0;const DEFAULT_FUTURE_VALUE=0;const COUPON_FUNCTION_ARGS=[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),];function newtonMethod(func,derivFunc,startValue,maxIterations,epsMax=1e-10,nanFallback){let x=startValue;let newX;let xDelta;let y;let yEqual0=false;let count=0;let previousFallback=undefined;do{y=func(x);if(isNaN(y)){assert(()=>count<maxIterations&&nanFallback!==undefined,_t("Function [[FUNCTION_NAME]] didn't find any result."));count++;x=nanFallback(previousFallback);previousFallback=x;continue;}
newX=x-y/derivFunc(x);xDelta=Math.abs(newX-x);x=newX;yEqual0=xDelta<epsMax||Math.abs(y)<epsMax;assert(()=>count<maxIterations,_t("Function [[FUNCTION_NAME]] didn't find any result."));count++;}while(!yEqual0);return x;}
const ACCRINTM={description:_t("Accrued interest of security paying at maturity."),args:[arg("issue (date)",_t("The date the security was initially issued.")),arg("maturity (date)",_t("The maturity date of the security.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(issue,maturity,rate,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(issue,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _redemption=toNumber(redemption,this.locale);const _rate=toNumber(rate,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertSettlementAndIssueDatesAreValid(end,start);assertDayCountConventionIsValid(_dayCountConvention);assertRedemptionStrictlyPositive(_redemption);assertRateStrictlyPositive(_rate);const yearFrac=YEARFRAC.compute.bind(this)(start,end,dayCountConvention);return _redemption*_rate*yearFrac;},isExported:true,};const AMORLINC={description:_t("Depreciation for an accounting period."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("purchase_date (date)",_t("The date the asset was purchased.")),arg("first_period_end (date)",_t("The date the first period ended.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg("rate (number)",_t("The deprecation rate.")),arg("day_count_convention (number, optional)",_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(cost,purchaseDate,firstPeriodEnd,salvage,period,rate,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _cost=toNumber(cost,this.locale);const _purchaseDate=Math.trunc(toNumber(purchaseDate,this.locale));const _firstPeriodEnd=Math.trunc(toNumber(firstPeriodEnd,this.locale));const _salvage=toNumber(salvage,this.locale);const _period=toNumber(period,this.locale);const _rate=toNumber(rate,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertCostStrictlyPositive(_cost);assertSalvagePositiveOrZero(_salvage);assertSalvageSmallerOrEqualThanCost(_salvage,_cost);assertPeriodPositiveOrZero(_period);assertRateStrictlyPositive(_rate);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_purchaseDate<=_firstPeriodEnd,_t("The purchase_date (%s) must be before the first_period_end (%s).",_purchaseDate.toString(),_firstPeriodEnd.toString()));const roundedPeriod=_period<1&&_period>0?1:Math.trunc(_period);const deprec=_cost*_rate;const yearFrac=YEARFRAC.compute.bind(this)(_purchaseDate,_firstPeriodEnd,_dayCountConvention);const firstDeprec=_purchaseDate===_firstPeriodEnd?deprec:deprec*yearFrac;const valueAtPeriod=_cost-firstDeprec-deprec*roundedPeriod;if(valueAtPeriod>=_salvage){return roundedPeriod===0?firstDeprec:deprec;}
return _salvage-valueAtPeriod<deprec?deprec-(_salvage-valueAtPeriod):0;},isExported:true,};const COUPDAYS={description:_t("Days in coupon period containing settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);if(_dayCountConvention===1){const before=COUPPCD.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const after=COUPNCD.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);return after-before;}
const daysInYear=_dayCountConvention===3?365:360;return daysInYear/_frequency;},isExported:true,};const COUPDAYBS={description:_t("Days from settlement until next coupon."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const couponBeforeStart=COUPPCD.compute.bind(this)(start,end,frequency,dayCountConvention);if([1,2,3].includes(_dayCountConvention)){return start-couponBeforeStart;}
if(_dayCountConvention===4){const yearFrac=getYearFrac(couponBeforeStart,start,_dayCountConvention);return Math.round(yearFrac*360);}
const startDate=toJsDate(start,this.locale);const dateCouponBeforeStart=toJsDate(couponBeforeStart,this.locale);const y1=dateCouponBeforeStart.getFullYear();const y2=startDate.getFullYear();const m1=dateCouponBeforeStart.getMonth()+1;const m2=startDate.getMonth()+1;let d1=dateCouponBeforeStart.getDate();let d2=startDate.getDate();if(m1===2&&m2===2&&isLastDayOfMonth(dateCouponBeforeStart)&&isLastDayOfMonth(startDate)){d2=30;}
if(d2===31&&(d1===30||d1===31)){d2=30;}
if(m1===2&&isLastDayOfMonth(dateCouponBeforeStart)){d1=30;}
if(d1===31){d1=30;}
return(y2-y1)*360+(m2-m1)*30+(d2-d1);},isExported:true,};const COUPDAYSNC={description:_t("Days from settlement until next coupon."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const couponAfterStart=COUPNCD.compute.bind(this)(start,end,frequency,dayCountConvention);if([1,2,3].includes(_dayCountConvention)){return couponAfterStart-start;}
if(_dayCountConvention===4){const yearFrac=getYearFrac(start,couponAfterStart,_dayCountConvention);return Math.round(yearFrac*360);}
const coupDayBs=COUPDAYBS.compute.bind(this)(settlement,maturity,frequency,_dayCountConvention);const coupDays=COUPDAYS.compute.bind(this)(settlement,maturity,frequency,_dayCountConvention);return coupDays-coupDayBs;},isExported:true,};const COUPNCD={description:_t("Next coupon date after the settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const monthsPerPeriod=12/_frequency;const coupNum=COUPNUM.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const date=addMonthsToDate(toJsDate(end,this.locale),-(coupNum-1)*monthsPerPeriod,true);return jsDateToRoundNumber(date);},isExported:true,};const COUPNUM={description:_t("Number of coupons between settlement and maturity."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);let num=1;let currentDate=end;const monthsPerPeriod=12/_frequency;while(currentDate>start){currentDate=jsDateToRoundNumber(addMonthsToDate(toJsDate(currentDate,this.locale),-monthsPerPeriod,false));num++;}
return num-1;},isExported:true,};const COUPPCD={description:_t("Last coupon date prior to or on the settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const monthsPerPeriod=12/_frequency;const coupNum=COUPNUM.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const date=addMonthsToDate(toJsDate(end,this.locale),-coupNum*monthsPerPeriod,true);return jsDateToRoundNumber(date);},isExported:true,};const CUMIPMT={description:_t("Cumulative interest paid over a set of periods."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg("first_period (number)",_t("The number of the payment period to begin the cumulative calculation.")),arg("last_period (number)",_t("The number of the payment period to end the cumulative calculation.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,numberOfPeriods,presentValue,firstPeriod,lastPeriod,endOrBeginning=DEFAULT_END_OR_BEGINNING){const first=toNumber(firstPeriod,this.locale);const last=toNumber(lastPeriod,this.locale);const _rate=toNumber(rate,this.locale);const pv=toNumber(presentValue,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);assertFirstAndLastPeriodsAreValid(first,last,nOfPeriods);assertRateStrictlyPositive(_rate);assertPresentValueStrictlyPositive(pv);let cumSum=0;for(let i=first;i<=last;i++){const impt=IPMT.compute.bind(this)(rate,i,nOfPeriods,presentValue,0,endOrBeginning);cumSum+=impt;}
return cumSum;},isExported:true,};const CUMPRINC={description:_t("Cumulative principal paid over a set of periods."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg("first_period (number)",_t("The number of the payment period to begin the cumulative calculation.")),arg("last_period (number)",_t("The number of the payment period to end the cumulative calculation.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,numberOfPeriods,presentValue,firstPeriod,lastPeriod,endOrBeginning=DEFAULT_END_OR_BEGINNING){const first=toNumber(firstPeriod,this.locale);const last=toNumber(lastPeriod,this.locale);const _rate=toNumber(rate,this.locale);const pv=toNumber(presentValue,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);assertFirstAndLastPeriodsAreValid(first,last,nOfPeriods);assertRateStrictlyPositive(_rate);assertPresentValueStrictlyPositive(pv);let cumSum=0;for(let i=first;i<=last;i++){const ppmt=PPMT.compute.bind(this)(rate,i,nOfPeriods,presentValue,0,endOrBeginning);cumSum+=ppmt;}
return cumSum;},isExported:true,};const DB={description:_t("Depreciation via declining balance method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg("month (number, optional)",_t("The number of months in the first year of depreciation.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period,...args){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=Math.trunc(toNumber(period,this.locale));const _month=args.length?Math.trunc(toNumber(args[0],this.locale)):12;const lifeLimit=_life+(_month===12?0:1);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assert(()=>1<=_month&&_month<=12,_t("The month (%s) must be between 1 and 12 inclusive.",_month.toString()));assert(()=>_period<=lifeLimit,_t("The period (%s) must be less than or equal to %s.",_period.toString(),lifeLimit.toString()));const monthPart=_month/12;let rate=1-Math.pow(_salvage/_cost,1/_life);rate=Math.round(rate*1000)/1000;let before=_cost;let after=_cost*(1-rate*monthPart);for(let i=1;i<_period;i++){before=after;after=before*(1-rate);if(i===_life){after=before*(1-rate*(1-monthPart));}}
return before-after;},isExported:true,};const DEFAULT_DDB_DEPRECIATION_FACTOR=2;const DDB={description:_t("Depreciation via double-declining balance method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg(`factor (number, default=${DEFAULT_DDB_DEPRECIATION_FACTOR})`,_t("The factor by which depreciation decreases.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period,factor=DEFAULT_DDB_DEPRECIATION_FACTOR){factor=factor||0;const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=toNumber(period,this.locale);const _factor=toNumber(factor,this.locale);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assertPeriodSmallerOrEqualToLife(_period,_life);assertDeprecationFactorStrictlyPositive(_factor);if(_cost===0||_salvage>=_cost)
return 0;const deprecFactor=_factor/_life;if(deprecFactor>1){return period===1?_cost-_salvage:0;}
if(_period<=1){return _cost*deprecFactor;}
const previousCost=_cost*Math.pow(1-deprecFactor,_period-1);const nextCost=_cost*Math.pow(1-deprecFactor,_period);const deprec=nextCost<_salvage?previousCost-_salvage:previousCost-nextCost;return Math.max(deprec,0);},isExported:true,};const DISC={description:_t("Discount rate of a security based on price."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,price,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return(_redemption-_price)/_redemption/yearsFrac;},isExported:true,};const DOLLARDE={description:_t("Convert a decimal fraction to decimal value."),args:[arg("fractional_price (number)",_t("The price quotation given using fractional decimal conventions.")),arg("unit (number)",_t("The units of the fraction, e.g. 8 for 1/8ths or 32 for 1/32nds.")),],returns:["NUMBER"],compute:function(fractionalPrice,unit){const price=toNumber(fractionalPrice,this.locale);const _unit=Math.trunc(toNumber(unit,this.locale));assert(()=>_unit>0,_t("The unit (%s) must be strictly positive.",_unit.toString()));const truncatedPrice=Math.trunc(price);const priceFractionalPart=price-truncatedPrice;const frac=10**Math.ceil(Math.log10(_unit))/_unit;return truncatedPrice+priceFractionalPart*frac;},isExported:true,};const DOLLARFR={description:_t("Convert a decimal value to decimal fraction."),args:[arg("decimal_price (number)",_t("The price quotation given as a decimal value.")),arg("unit (number)",_t("The units of the desired fraction, e.g. 8 for 1/8ths or 32 for 1/32nds.")),],returns:["NUMBER"],compute:function(decimalPrice,unit){const price=toNumber(decimalPrice,this.locale);const _unit=Math.trunc(toNumber(unit,this.locale));assert(()=>_unit>0,_t("The unit (%s) must be strictly positive.",_unit.toString()));const truncatedPrice=Math.trunc(price);const priceFractionalPart=price-truncatedPrice;const frac=_unit/10**Math.ceil(Math.log10(_unit));return truncatedPrice+priceFractionalPart*frac;},isExported:true,};const DURATION={description:_t("Number of periods for an investment to reach a value."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));const years=YEARFRAC.compute.bind(this)(start,end,_dayCountConvention);const timeFirstYear=years-Math.trunc(years)||1/_frequency;const nbrCoupons=Math.ceil(years*_frequency);const cashFlowFromCoupon=_rate/_frequency;const yieldPerPeriod=_yield/_frequency;let count=0;let sum=0;for(let i=1;i<=nbrCoupons;i++){const cashFlowPerPeriod=cashFlowFromCoupon+(i===nbrCoupons?1:0);const presentValuePerPeriod=cashFlowPerPeriod/(1+yieldPerPeriod)**i;sum+=(timeFirstYear+(i-1)/_frequency)*presentValuePerPeriod;count+=presentValuePerPeriod;}
return count===0?0:sum/count;},isExported:true,};const EFFECT={description:_t("Annual effective interest rate."),args:[arg("nominal_rate (number)",_t("The nominal interest rate per year.")),arg("periods_per_year (number)",_t("The number of compounding periods per year.")),],returns:["NUMBER"],compute:function(nominal_rate,periods_per_year){const nominal=toNumber(nominal_rate,this.locale);const periods=Math.trunc(toNumber(periods_per_year,this.locale));assert(()=>nominal>0,_t("The nominal rate (%s) must be strictly greater than 0.",nominal.toString()));assert(()=>periods>0,_t("The number of periods by year (%s) must strictly greater than 0.",periods.toString()));return Math.pow(1+nominal/periods,periods)-1;},isExported:true,};const DEFAULT_PRESENT_VALUE=0;const FV={description:_t("Future value of an annuity investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_amount (number)",_t("The amount per period to be paid.")),arg(`present_value (number, default=${DEFAULT_PRESENT_VALUE})`,_t("The current value of the annuity.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,paymentAmount,presentValue=DEFAULT_PRESENT_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){presentValue=presentValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const n=toNumber(numberOfPeriods,this.locale);const p=toNumber(paymentAmount,this.locale);const pv=toNumber(presentValue,this.locale);const type=toBoolean(endOrBeginning)?1:0;return r?-pv*(1+r)**n-(p*(1+r*type)*((1+r)**n-1))/r:-(pv+p*n);},isExported:true,};const FVSCHEDULE={description:_t("Future value of principal from series of rates."),args:[arg("principal (number)",_t("The amount of initial capital or value to compound against.")),arg("rate_schedule (number, range<number>)",_t("A series of interest rates to compound against the principal.")),],returns:["NUMBER"],compute:function(principalAmount,rateSchedule){const principal=toNumber(principalAmount,this.locale);return reduceAny([rateSchedule],(acc,rate)=>acc*(1+toNumber(rate,this.locale)),principal);},isExported:true,};const INTRATE={description:_t("Calculates effective interest rate."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("investment (number)",_t("The amount invested in the security.")),arg("redemption (number)",_t("The amount to be received at maturity.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,investment,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _redemption=toNumber(redemption,this.locale);const _investment=toNumber(investment,this.locale);assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertInvestmentStrictlyPositive(_investment);assertRedemptionStrictlyPositive(_redemption);const yearFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,dayCountConvention);return(_redemption-_investment)/_investment/yearFrac;},isExported:true,};const IPMT={description:_t("Payment on the principal of an investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("period (number)",_t("The amortization period, in terms of number of periods.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,currentPeriod,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){const payment=PMT.compute.bind(this)(rate,numberOfPeriods,presentValue,futureValue,endOrBeginning);const ppmt=PPMT.compute.bind(this)(rate,currentPeriod,numberOfPeriods,presentValue,futureValue,endOrBeginning);return payment-ppmt;},isExported:true,};const DEFAULT_RATE_GUESS=0.1;const IRR={description:_t("Internal rate of return given periodic cashflows."),args:[arg("cashflow_amounts (number, range<number>)",_t("An array or range containing the income or payments associated with the investment.")),arg(`rate_guess (number, default=${DEFAULT_RATE_GUESS})`,_t("An estimate for what the internal rate of return will be.")),],returns:["NUMBER"],computeFormat:()=>"0%",compute:function(cashFlowAmounts,rateGuess=DEFAULT_RATE_GUESS){const _rateGuess=toNumber(rateGuess,this.locale);assertRateGuessStrictlyGreaterThanMinusOne(_rateGuess);let positive=false;let negative=false;let amounts=[];visitNumbers([cashFlowAmounts],(amount)=>{if(amount>0)
positive=true;if(amount<0)
negative=true;amounts.push(amount);},this.locale);assert(()=>positive&&negative,_t("The cashflow_amounts must include negative and positive values."));const firstAmount=amounts.shift();function npvNumerator(rate,startValue,values){const nbrValue=values.length;let i=0;return values.reduce((acc,v)=>{i++;return acc+v*rate**(nbrValue-i);},startValue*rate**nbrValue);}
function npvNumeratorDeriv(rate,startValue,values){const nbrValue=values.length;let i=0;return values.reduce((acc,v)=>{i++;return acc+v*(nbrValue-i)*rate**(nbrValue-i-1);},startValue*nbrValue*rate**(nbrValue-1));}
function func(x){return npvNumerator(x,firstAmount,amounts);}
function derivFunc(x){return npvNumeratorDeriv(x,firstAmount,amounts);}
return newtonMethod(func,derivFunc,_rateGuess+1,20,1e-5)-1;},isExported:true,};const ISPMT={description:_t("Returns the interest paid at a particular period of an investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("period (number)",_t("The period for which you want to view the interest payment.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),],returns:["NUMBER"],compute:function(rate,currentPeriod,numberOfPeriods,presentValue){const interestRate=toNumber(rate,this.locale);const period=toNumber(currentPeriod,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);const investment=toNumber(presentValue,this.locale);assert(()=>nOfPeriods!==0,_t("The number of periods must be different than 0.",nOfPeriods.toString()));const currentInvestment=investment-investment*(period/nOfPeriods);return-1*currentInvestment*interestRate;},isExported:true,};const MDURATION={description:_t("Modified Macaulay duration."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){const duration=DURATION.compute.bind(this)(settlement,maturity,rate,securityYield,frequency,dayCountConvention);const y=toNumber(securityYield,this.locale);const k=Math.trunc(toNumber(frequency,this.locale));return duration/(1+y/k);},isExported:true,};const MIRR={description:_t("Modified internal rate of return."),args:[arg("cashflow_amounts (range<number>)",_t("A range containing the income or payments associated with the investment. The array should contain bot payments and incomes.")),arg("financing_rate (number)",_t("The interest rate paid on funds invested.")),arg("reinvestment_return_rate (number)",_t("The return (as a percentage) earned on reinvestment of income received from the investment.")),],returns:["NUMBER"],compute:function(cashflowAmount,financingRate,reinvestmentRate){const fRate=toNumber(financingRate,this.locale);const rRate=toNumber(reinvestmentRate,this.locale);const cashFlow=transposeMatrix(cashflowAmount).flat().filter((t)=>t!==null).map((val)=>toNumber(val,this.locale));const n=cashFlow.length;let fv=0;let pv=0;for(const i of range(0,n)){const amount=cashFlow[i];if(amount>=0){fv+=amount*(rRate+1)**(n-i-1);}
else{pv+=amount/(fRate+1)**i;}}
assert(()=>pv!==0&&fv!==0,_t("There must be both positive and negative values in cashflow_amounts."));const exponent=1/(n-1);return(-fv/pv)**exponent-1;},isExported:true,};const NOMINAL={description:_t("Annual nominal interest rate."),args:[arg("effective_rate (number)",_t("The effective interest rate per year.")),arg("periods_per_year (number)",_t("The number of compounding periods per year.")),],returns:["NUMBER"],compute:function(effective_rate,periods_per_year){const effective=toNumber(effective_rate,this.locale);const periods=Math.trunc(toNumber(periods_per_year,this.locale));assert(()=>effective>0,_t("The effective rate (%s) must must strictly greater than 0.",effective.toString()));assert(()=>periods>0,_t("The number of periods by year (%s) must strictly greater than 0.",periods.toString()));return(Math.pow(effective+1,1/periods)-1)*periods;},isExported:true,};const NPER={description:_t("Number of payment periods for an investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("payment_amount (number)",_t("The amount of each payment made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,paymentAmount,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const p=toNumber(paymentAmount,this.locale);const pv=toNumber(presentValue,this.locale);const fv=toNumber(futureValue,this.locale);const t=toBoolean(endOrBeginning)?1:0;if(r===0){return-(fv+pv)/p;}
const c=(p*(1+r*t))/r;return Math.log((c-fv)/(pv+c))/Math.log(1+r);},isExported:true,};function npvResult(r,startValue,values,locale){let i=0;return reduceNumbers(values,(acc,v)=>{i++;return acc+v/(1+r)**i;},startValue,locale);}
const NPV={description:_t("The net present value of an investment based on a series of periodic cash flows and a discount rate."),args:[arg("discount (number)",_t("The discount rate of the investment over one period.")),arg("cashflow1 (number, range<number>)",_t("The first future cash flow.")),arg("cashflow2 (number, range<number>, repeating)",_t("Additional future cash flows.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(discount,...values){const _discount=toNumber(discount,this.locale);assert(()=>_discount!==-1,_t("The discount (%s) must be different from -1.",_discount.toString()));return npvResult(_discount,0,values,this.locale);},isExported:true,};const PDURATION={description:_t("Computes the number of periods needed for an investment to reach a value."),args:[arg("rate (number)",_t("The rate at which the investment grows each period.")),arg("present_value (number)",_t("The investment's current value.")),arg("future_value (number)",_t("The investment's desired future value.")),],returns:["NUMBER"],compute:function(rate,presentValue,futureValue){const _rate=toNumber(rate,this.locale);const _presentValue=toNumber(presentValue,this.locale);const _futureValue=toNumber(futureValue,this.locale);assertRateStrictlyPositive(_rate);assert(()=>_presentValue>0,_t("The present_value (%s) must be strictly positive.",_presentValue.toString()));assert(()=>_futureValue>0,_t("The future_value (%s) must be strictly positive.",_futureValue.toString()));return(Math.log(_futureValue)-Math.log(_presentValue))/Math.log(1+_rate);},isExported:true,};const PMT={description:_t("Periodic payment for an annuity investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const n=toNumber(numberOfPeriods,this.locale);const r=toNumber(rate,this.locale);const t=toBoolean(endOrBeginning)?1:0;let fv=toNumber(futureValue,this.locale);let pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);if(r===0){return-(fv+pv)/n;}
let payment=-(pv*(1+r)**n+fv);payment=(payment*r)/((1+r*t)*((1+r)**n-1));return payment;},isExported:true,};const PPMT={description:_t("Payment on the principal of an investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("period (number)",_t("The amortization period, in terms of number of periods.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,currentPeriod,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const n=toNumber(numberOfPeriods,this.locale);const r=toNumber(rate,this.locale);const period=toNumber(currentPeriod,this.locale);const type=toBoolean(endOrBeginning)?1:0;const fv=toNumber(futureValue,this.locale);const pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);assert(()=>period>0&&period<=n,_t("The period must be between 1 and number_of_periods",n.toString()));const payment=PMT.compute.bind(this)(r,n,pv,fv,endOrBeginning);if(type===1&&period===1)
return payment;const eqPeriod=type===0?period-1:period-2;const eqPv=pv+payment*type;const capitalAtPeriod=-FV.compute.bind(this)(r,eqPeriod,payment,eqPv,0);const currentInterest=capitalAtPeriod*r;return payment+currentInterest;},isExported:true,};const PV={description:_t("Present value of an annuity investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_amount (number)",_t("The amount per period to be paid.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,paymentAmount,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const n=toNumber(numberOfPeriods,this.locale);const p=toNumber(paymentAmount,this.locale);const fv=toNumber(futureValue,this.locale);const type=toBoolean(endOrBeginning)?1:0;return r?-((p*(1+r*type)*((1+r)**n-1))/r+fv)/(1+r)**n:-(fv+p*n);},isExported:true,};const PRICE={description:_t("Price of a security paying periodic interest."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,redemption,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _redemption=toNumber(redemption,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));assertRedemptionStrictlyPositive(_redemption);const years=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const nbrRealCoupons=years*_frequency;const nbrFullCoupons=Math.ceil(nbrRealCoupons);const timeFirstCoupon=nbrRealCoupons-Math.floor(nbrRealCoupons)||1;const yieldFactorPerPeriod=1+_yield/_frequency;const cashFlowFromCoupon=(100*_rate)/_frequency;if(nbrFullCoupons===1){return((cashFlowFromCoupon+_redemption)/((timeFirstCoupon*_yield)/_frequency+1)-
cashFlowFromCoupon*(1-timeFirstCoupon));}
let cashFlowsPresentValue=0;for(let i=1;i<=nbrFullCoupons;i++){cashFlowsPresentValue+=cashFlowFromCoupon/yieldFactorPerPeriod**(i-1+timeFirstCoupon);}
const redemptionPresentValue=_redemption/yieldFactorPerPeriod**(nbrFullCoupons-1+timeFirstCoupon);return(redemptionPresentValue+cashFlowsPresentValue-cashFlowFromCoupon*(1-timeFirstCoupon));},isExported:true,};const PRICEDISC={description:_t("Price of a discount security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the security at time of purchase.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _discount=toNumber(discount,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertDiscountStrictlyPositive(_discount);assertRedemptionStrictlyPositive(_redemption);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return _redemption-_discount*_redemption*yearsFrac;},isExported:true,};const PRICEMAT={description:_t("Calculates the price of a security paying interest at maturity, based on expected yield."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("issue (date)",_t("The date the security was initially issued.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,issue,rate,securityYield,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _issue=Math.trunc(toNumber(issue,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _dayCount=Math.trunc(toNumber(dayCountConvention,this.locale));assertSettlementAndIssueDatesAreValid(_settlement,_issue);assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCount);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));const settlementToMaturity=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCount);const issueToSettlement=YEARFRAC.compute.bind(this)(_settlement,_issue,_dayCount);const issueToMaturity=YEARFRAC.compute.bind(this)(_issue,_maturity,_dayCount);const numerator=100+issueToMaturity*_rate*100;const denominator=1+settlementToMaturity*_yield;const term2=issueToSettlement*_rate*100;return numerator/denominator-term2;},isExported:true,};const RATE_GUESS_DEFAULT=0.1;const RATE={description:_t("Interest rate of an annuity investment."),args:[arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_per_period (number)",_t("The amount per period to be paid.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),arg(`rate_guess (number, default=${RATE_GUESS_DEFAULT})`,_t("An estimate for what the interest rate will be.")),],returns:["NUMBER"],computeFormat:()=>"0%",compute:function(numberOfPeriods,paymentPerPeriod,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING,rateGuess=RATE_GUESS_DEFAULT){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;rateGuess=rateGuess||RATE_GUESS_DEFAULT;const n=toNumber(numberOfPeriods,this.locale);const payment=toNumber(paymentPerPeriod,this.locale);const type=toBoolean(endOrBeginning)?1:0;const guess=toNumber(rateGuess,this.locale);let fv=toNumber(futureValue,this.locale);let pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);assert(()=>[payment,pv,fv].some((val)=>val>0)&&[payment,pv,fv].some((val)=>val<0),_t("There must be both positive and negative values in [payment_amount, present_value, future_value].",n.toString()));assertRateGuessStrictlyGreaterThanMinusOne(guess);fv-=payment*type;pv+=payment*type;const func=(rate)=>{const powN=Math.pow(1+rate,n);const intResult=(powN-1)/rate;return fv+pv*powN+payment*intResult;};const derivFunc=(rate)=>{const powNMinus1=Math.pow(1+rate,n-1);const powN=Math.pow(1+rate,n);const intResult=(powN-1)/rate;const intResultDeriv=(n*powNMinus1)/rate-intResult/rate;const fTermDerivation=pv*n*powNMinus1+payment*intResultDeriv;return fTermDerivation;};return newtonMethod(func,derivFunc,guess,40,1e-5);},isExported:true,};const RECEIVED={description:_t("Amount received at maturity for a security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("investment (number)",_t("The amount invested (irrespective of face value of each security).")),arg("discount (number)",_t("The discount rate of the security invested in.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,investment,discount,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _investment=toNumber(investment,this.locale);const _discount=toNumber(discount,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertInvestmentStrictlyPositive(_investment);assertDiscountStrictlyPositive(_discount);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return _investment/(1-_discount*yearsFrac);},isExported:true,};const RRI={description:_t("Computes the rate needed for an investment to reach a specific value within a specific number of periods."),args:[arg("number_of_periods (number)",_t("The number of periods.")),arg("present_value (number)",_t("The present value of the investment.")),arg("future_value (number)",_t("The future value of the investment.")),],returns:["NUMBER"],compute:function(numberOfPeriods,presentValue,futureValue){const n=toNumber(numberOfPeriods,this.locale);const pv=toNumber(presentValue,this.locale);const fv=toNumber(futureValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);return(fv/pv)**(1/n)-1;},isExported:true,};const SLN={description:_t("Depreciation of an asset using the straight-line method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);return(_cost-_salvage)/_life;},isExported:true,};const SYD={description:_t("Depreciation via sum of years digit method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=toNumber(period,this.locale);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assertPeriodSmallerOrEqualToLife(_period,_life);const deprecFactor=(_life*(_life+1))/2;const remainingPeriods=_life-_period+1;return(_cost-_salvage)*(remainingPeriods/deprecFactor);},isExported:true,};const TBILLPRICE={description:_t("Price of a US Treasury bill."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the bill at time of purchase.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const disc=toNumber(discount,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertDiscountStrictlyPositive(disc);assertDiscountStrictlySmallerThanOne(disc);const yearFrac=YEARFRAC.compute.bind(this)(start,end,2);return 100*(1-disc*yearFrac);},isExported:true,};const TBILLEQ={description:_t("Equivalent rate of return for a US Treasury bill."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the bill at time of purchase.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const disc=toNumber(discount,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertDiscountStrictlyPositive(disc);assertDiscountStrictlySmallerThanOne(disc);const nDays=DAYS.compute.bind(this)(end,start);if(nDays<=182){return(365*disc)/(360-disc*nDays);}
const p=TBILLPRICE.compute.bind(this)(start,end,disc)/100;const daysInYear=nDays===366?366:365;const x=nDays/daysInYear;const num=-2*x+2*Math.sqrt(x**2-(2*x-1)*(1-1/p));const denom=2*x-1;return num/denom;},isExported:true,};const TBILLYIELD={description:_t("The yield of a US Treasury bill based on price."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),],returns:["NUMBER"],compute:function(settlement,maturity,price){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const p=toNumber(price,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertPriceStrictlyPositive(p);const yearFrac=YEARFRAC.compute.bind(this)(start,end,2);return((100-p)/p)*(1/yearFrac);},isExported:true,};const DEFAULT_VDB_NO_SWITCH=false;const VDB={description:_t("Variable declining balance. WARNING : does not handle decimal periods."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("start (number)",_t("Starting period to calculate depreciation.")),arg("end (number)",_t("Ending period to calculate depreciation.")),arg(`factor (number, default=${DEFAULT_DDB_DEPRECIATION_FACTOR})`,_t("The number of months in the first year of depreciation.")),arg(`no_switch (number, default=${DEFAULT_VDB_NO_SWITCH})`,_t("Whether to switch to straight-line depreciation when the depreciation is greater than the declining balance calculation.")),],returns:["NUMBER"],compute:function(cost,salvage,life,startPeriod,endPeriod,factor=DEFAULT_DDB_DEPRECIATION_FACTOR,noSwitch=DEFAULT_VDB_NO_SWITCH){factor=factor||0;const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _startPeriod=Math.trunc(toNumber(startPeriod,this.locale));const _endPeriod=Math.trunc(toNumber(endPeriod,this.locale));const _factor=toNumber(factor,this.locale);const _noSwitch=toBoolean(noSwitch);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertStartAndEndPeriodAreValid(_startPeriod,_endPeriod,_life);assertDeprecationFactorStrictlyPositive(_factor);if(_cost===0)
return 0;if(_salvage>=_cost){return _startPeriod<1?_cost-_salvage:0;}
const doubleDeprecFactor=_factor/_life;if(doubleDeprecFactor>=1){return _startPeriod<1?_cost-_salvage:0;}
let previousCost=_cost;let currentDeprec=0;let resultDeprec=0;let isLinearDeprec=false;for(let i=0;i<_endPeriod;i++){if(!isLinearDeprec||_noSwitch){const doubleDeprec=previousCost*doubleDeprecFactor;const remainingPeriods=_life-i;const linearDeprec=(previousCost-_salvage)/remainingPeriods;if(!_noSwitch&&linearDeprec>doubleDeprec){isLinearDeprec=true;currentDeprec=linearDeprec;}
else{currentDeprec=doubleDeprec;}}
const nextCost=Math.max(previousCost-currentDeprec,_salvage);if(i>=_startPeriod){resultDeprec+=previousCost-nextCost;}
previousCost=nextCost;}
return resultDeprec;},isExported:true,};const XIRR={description:_t("Internal rate of return given non-periodic cash flows."),args:[arg("cashflow_amounts (range<number>)",_t("An range containing the income or payments associated with the investment.")),arg("cashflow_dates (range<number>)",_t("An range with dates corresponding to the cash flows in cashflow_amounts.")),arg(`rate_guess (number, default=${RATE_GUESS_DEFAULT})`,_t("An estimate for what the internal rate of return will be.")),],returns:["NUMBER"],compute:function(cashflowAmounts,cashflowDates,rateGuess=RATE_GUESS_DEFAULT){rateGuess=rateGuess||0;const guess=toNumber(rateGuess,this.locale);const _cashFlows=cashflowAmounts.flat().map((val)=>toNumber(val,this.locale));const _dates=cashflowDates.flat().map((val)=>toNumber(val,this.locale));assertCashFlowsAndDatesHaveSameDimension(cashflowAmounts,cashflowDates);assertCashFlowsHavePositiveAndNegativesValues(_cashFlows);assertEveryDateGreaterThanFirstDateOfCashFlowDates(_dates);assertRateGuessStrictlyGreaterThanMinusOne(guess);const map=new Map();for(const i of range(0,_dates.length)){const date=_dates[i];if(map.has(date))
map.set(date,map.get(date)+_cashFlows[i]);else
map.set(date,_cashFlows[i]);}
const dates=Array.from(map.keys());const values=dates.map((date)=>map.get(date));const func=(rate)=>{let value=values[0];for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;value+=values[i]*(1+rate)**dateDiff;}
return value;};const derivFunc=(rate)=>{let deriv=0;for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;deriv+=dateDiff*values[i]*(1+rate)**(dateDiff-1);}
return deriv;};const nanFallback=(previousFallback)=>{if(!previousFallback)
return-0.9;return previousFallback/10-0.9;};return newtonMethod(func,derivFunc,guess,40,1e-5,nanFallback);},isExported:true,};const XNPV={description:_t("Net present value given to non-periodic cash flows.."),args:[arg("discount (number)",_t("The discount rate of the investment over one period.")),arg("cashflow_amounts (number, range<number>)",_t("An range containing the income or payments associated with the investment.")),arg("cashflow_dates (number, range<number>)",_t("An range with dates corresponding to the cash flows in cashflow_amounts.")),],returns:["NUMBER"],compute:function(discount,cashflowAmounts,cashflowDates){const rate=toNumber(discount,this.locale);const _cashFlows=isMatrix(cashflowAmounts)?cashflowAmounts.flat().map((val)=>strictToNumber(val,this.locale)):[strictToNumber(cashflowAmounts,this.locale)];const _dates=isMatrix(cashflowDates)?cashflowDates.flat().map((val)=>strictToNumber(val,this.locale)):[strictToNumber(cashflowDates,this.locale)];if(isMatrix(cashflowDates)&&isMatrix(cashflowAmounts)){assertCashFlowsAndDatesHaveSameDimension(cashflowAmounts,cashflowDates);}
else{assert(()=>_cashFlows.length===_dates.length,_t("There must be the same number of values in cashflow_amounts and cashflow_dates."));}
assertEveryDateGreaterThanFirstDateOfCashFlowDates(_dates);assertRateStrictlyPositive(rate);if(_cashFlows.length===1)
return _cashFlows[0];const map=new Map();for(const i of range(0,_dates.length)){const date=_dates[i];if(map.has(date))
map.set(date,map.get(date)+_cashFlows[i]);else
map.set(date,_cashFlows[i]);}
const dates=Array.from(map.keys());const values=dates.map((date)=>map.get(date));let pv=values[0];for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;pv+=values[i]*(1+rate)**dateDiff;}
return pv;},isExported:true,};const YIELD={description:_t("Annual yield of a security paying periodic interest."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,price,redemption,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const years=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const nbrRealCoupons=years*_frequency;const nbrFullCoupons=Math.ceil(nbrRealCoupons);const timeFirstCoupon=nbrRealCoupons-Math.floor(nbrRealCoupons)||1;const cashFlowFromCoupon=(100*_rate)/_frequency;if(nbrFullCoupons===1){const subPart=_price+cashFlowFromCoupon*(1-timeFirstCoupon);return(((_redemption+cashFlowFromCoupon-subPart)*_frequency*(1/timeFirstCoupon))/subPart);}
function priceNumerator(price,timeFirstCoupon,nbrFullCoupons,yieldFactorPerPeriod,cashFlowFromCoupon,redemption){let result=redemption-
(price+cashFlowFromCoupon*(1-timeFirstCoupon))*yieldFactorPerPeriod**(nbrFullCoupons-1+timeFirstCoupon);for(let i=1;i<=nbrFullCoupons;i++){result+=cashFlowFromCoupon*yieldFactorPerPeriod**(i-1);}
return result;}
function priceNumeratorDeriv(price,timeFirstCoupon,nbrFullCoupons,yieldFactorPerPeriod,cashFlowFromCoupon){let result=-(price+cashFlowFromCoupon*(1-timeFirstCoupon))*(nbrFullCoupons-1+timeFirstCoupon)*yieldFactorPerPeriod**(nbrFullCoupons-2+timeFirstCoupon);for(let i=1;i<=nbrFullCoupons;i++){result+=cashFlowFromCoupon*(i-1)*yieldFactorPerPeriod**(i-2);}
return result;}
function func(x){return priceNumerator(_price,timeFirstCoupon,nbrFullCoupons,x,cashFlowFromCoupon,_redemption);}
function derivFunc(x){return priceNumeratorDeriv(_price,timeFirstCoupon,nbrFullCoupons,x,cashFlowFromCoupon);}
const initYield=_rate+1;const initYieldFactorPerPeriod=1+initYield/_frequency;const methodResult=newtonMethod(func,derivFunc,initYieldFactorPerPeriod,100,1e-5);return(methodResult-1)*_frequency;},isExported:true,};const YIELDDISC={description:_t("Annual yield of a discount security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,price,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const yearFrac=YEARFRAC.compute.bind(this)(settlement,maturity,dayCountConvention);return(_redemption/_price-1)/yearFrac;},isExported:true,};const YIELDMAT={description:_t("Annual yield of a security paying interest at maturity."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("issue (date)",_t("The date the security was initially issued.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("price (number)",_t("The price at which the security is bought.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,issue,rate,price,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _issue=Math.trunc(toNumber(issue,this.locale));const _rate=toNumber(rate,this.locale);const _price=toNumber(price,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_settlement>=_issue,_t("The settlement (%s) must be greater than or equal to the issue (%s).",_settlement.toString(),_issue.toString()));assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assertPriceStrictlyPositive(_price);const issueToMaturity=YEARFRAC.compute.bind(this)(_issue,_maturity,_dayCountConvention);const issueToSettlement=YEARFRAC.compute.bind(this)(_issue,_settlement,_dayCountConvention);const settlementToMaturity=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const numerator=(100*(1+_rate*issueToMaturity))/(_price+100*_rate*issueToSettlement)-1;return numerator/settlementToMaturity;},isExported:true,};var financial=Object.freeze({__proto__:null,ACCRINTM:ACCRINTM,AMORLINC:AMORLINC,COUPDAYBS:COUPDAYBS,COUPDAYS:COUPDAYS,COUPDAYSNC:COUPDAYSNC,COUPNCD:COUPNCD,COUPNUM:COUPNUM,COUPPCD:COUPPCD,CUMIPMT:CUMIPMT,CUMPRINC:CUMPRINC,DB:DB,DDB:DDB,DISC:DISC,DOLLARDE:DOLLARDE,DOLLARFR:DOLLARFR,DURATION:DURATION,EFFECT:EFFECT,FV:FV,FVSCHEDULE:FVSCHEDULE,INTRATE:INTRATE,IPMT:IPMT,IRR:IRR,ISPMT:ISPMT,MDURATION:MDURATION,MIRR:MIRR,NOMINAL:NOMINAL,NPER:NPER,NPV:NPV,PDURATION:PDURATION,PMT:PMT,PPMT:PPMT,PRICE:PRICE,PRICEDISC:PRICEDISC,PRICEMAT:PRICEMAT,PV:PV,RATE:RATE,RECEIVED:RECEIVED,RRI:RRI,SLN:SLN,SYD:SYD,TBILLEQ:TBILLEQ,TBILLPRICE:TBILLPRICE,TBILLYIELD:TBILLYIELD,VDB:VDB,XIRR:XIRR,XNPV:XNPV,YIELD:YIELD,YIELDDISC:YIELDDISC,YIELDMAT:YIELDMAT});const ISERR={description:_t("Whether a value is an error other than #N/A."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return e?.errorType!=CellErrorType.NotAvailable;}},isExported:true,};const ISERROR={description:_t("Whether a value is an error."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return true;}},isExported:true,};const ISLOGICAL={description:_t("Whether a value is `true` or `false`."),args:[arg("value (any, lazy)",_t("The value to be verified as a logical TRUE or FALSE."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="boolean";}
catch(e){return false;}},isExported:true,};const ISNA={description:_t("Whether a value is the error #N/A."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return e?.errorType===CellErrorType.NotAvailable;}},isExported:true,};const ISNONTEXT={description:_t("Whether a value is non-textual."),args:[arg("value (any, lazy)",_t("The value to be checked."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()!=="string";}
catch(e){return true;}},isExported:true,};const ISNUMBER={description:_t("Whether a value is a number."),args:[arg("value (any, lazy)",_t("The value to be verified as a number."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="number";}
catch(e){return false;}},isExported:true,};const ISTEXT={description:_t("Whether a value is text."),args:[arg("value (any, lazy)",_t("The value to be verified as text."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="string";}
catch(e){return false;}},isExported:true,};const ISBLANK={description:_t("Whether the referenced cell is empty"),args:[arg("value (any, lazy)",_t("Reference to the cell that will be checked for emptiness."))],returns:["BOOLEAN"],compute:function(value){try{const val=value();return val===null;}
catch(e){return false;}},isExported:true,};const NA={description:_t("Returns the error value #N/A."),args:[],returns:["BOOLEAN"],compute:function(value){throw new NotAvailableError();},isExported:true,};var info=Object.freeze({__proto__:null,ISBLANK:ISBLANK,ISERR:ISERR,ISERROR:ISERROR,ISLOGICAL:ISLOGICAL,ISNA:ISNA,ISNONTEXT:ISNONTEXT,ISNUMBER:ISNUMBER,ISTEXT:ISTEXT,NA:NA});const AND={description:_t("Logical `and` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that represent logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=true;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc&&arg;return acc;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};const FALSE={description:_t("Logical value `false`."),args:[],returns:["BOOLEAN"],compute:function(){return false;},isExported:true,};const IF={description:_t("Returns value depending on logical expression."),args:[arg("logical_expression (boolean)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE.")),arg("value_if_true (any, lazy)",_t("The value the function returns if logical_expression is TRUE.")),arg("value_if_false (any, lazy, default=FALSE)",_t("The value the function returns if logical_expression is FALSE.")),],returns:["ANY"],computeValueAndFormat:function(logicalExpression,valueIfTrue,valueIfFalse=()=>({value:false})){const result=toBoolean(logicalExpression?.value)?valueIfTrue():valueIfFalse();if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFERROR={description:_t("Value if it is not an error, otherwise 2nd argument."),args:[arg("value (any, lazy)",_t("The value to return if value itself is not an error.")),arg(`value_if_error (any, lazy, default="empty")`,_t("The value the function returns if value is an error.")),],returns:["ANY"],computeValueAndFormat:function(value,valueIfError=()=>({value:""})){let result;try{result=value();}
catch(e){result=valueIfError();}
if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFNA={description:_t("Value if it is not an #N/A error, otherwise 2nd argument."),args:[arg("value (any, lazy)",_t("The value to return if value itself is not #N/A an error.")),arg(`value_if_error (any, lazy, default="empty")`,_t("The value the function returns if value is an #N/A error.")),],returns:["ANY"],computeValueAndFormat:function(value,valueIfError=()=>({value:""})){let result;try{result=value();}
catch(e){if(e.errorType===CellErrorType.NotAvailable){result=valueIfError();}
else{result=value();}}
if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFS={description:_t("Returns a value depending on multiple logical expressions."),args:[arg("condition1 (boolean, lazy)",_t("The first condition to be evaluated. This can be a boolean, a number, an array, or a reference to any of those.")),arg("value1 (any, lazy)",_t("The returned value if condition1 is TRUE.")),arg("condition2 (boolean, lazy, repeating)",_t("Additional conditions to be evaluated if the previous ones are FALSE.")),arg("value2 (any, lazy, repeating)",_t("Additional values to be returned if their corresponding conditions are TRUE.")),],returns:["ANY"],computeValueAndFormat:function(...values){assert(()=>values.length%2===0,_t("Wrong number of arguments. Expected an even number of arguments."));for(let n=0;n<values.length-1;n+=2){if(toBoolean(values[n]()?.value)){const result=values[n+1]();if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;}}
throw new Error(_t("No match."));},isExported:true,};const NOT={description:_t("Returns opposite of provided logical value."),args:[arg("logical_expression (boolean)",_t("An expression or reference to a cell holding an expression that represents some logical value.")),],returns:["BOOLEAN"],compute:function(logicalExpression){return!toBoolean(logicalExpression);},isExported:true,};const OR={description:_t("Logical `or` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that evaluate to logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=false;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc||arg;return!acc;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};const TRUE={description:_t("Logical value `true`."),args:[],returns:["BOOLEAN"],compute:function(){return true;},isExported:true,};const XOR={description:_t("Logical `xor` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that evaluate to logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=false;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc?!arg:arg;return true;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};var logical=Object.freeze({__proto__:null,AND:AND,FALSE:FALSE,IF:IF,IFERROR:IFERROR,IFNA:IFNA,IFS:IFS,NOT:NOT,OR:OR,TRUE:TRUE,XOR:XOR});const DEFAULT_IS_SORTED=true;const DEFAULT_MATCH_MODE=0;const DEFAULT_SEARCH_MODE=1;const DEFAULT_ABSOLUTE_RELATIVE_MODE=1;function assertAvailable(variable,searchKey){if(variable===undefined){throw new NotAvailableError(_t("Did not find value '%s' in [[FUNCTION_NAME]] evaluation.",toString(searchKey)));}}
const ADDRESS={description:_t("Returns a cell reference as a string. "),args:[arg("row (number)",_t("The row number of the cell reference. ")),arg("column (number)",_t("The column number (not name) of the cell reference. A is column number 1. ")),arg(`absolute_relative_mode (number, default=${DEFAULT_ABSOLUTE_RELATIVE_MODE})`,_t("An indicator of whether the reference is row/column absolute. 1 is row and column absolute (e.g. $A$1), 2 is row absolute and column relative (e.g. A$1), 3 is row relative and column absolute (e.g. $A1), and 4 is row and column relative (e.g. A1).")),arg("use_a1_notation (boolean, default=TRUE)",_t("A boolean indicating whether to use A1 style notation (TRUE) or R1C1 style notation (FALSE).")),arg("sheet (string, optional)",_t("A string indicating the name of the sheet into which the address points.")),],returns:["STRING"],compute:function(row,column,absoluteRelativeMode=DEFAULT_ABSOLUTE_RELATIVE_MODE,useA1Notation=true,sheet){const rowNumber=strictToInteger(row,this.locale);const colNumber=strictToInteger(column,this.locale);assertNumberGreaterThanOrEqualToOne(rowNumber);assertNumberGreaterThanOrEqualToOne(colNumber);const _absoluteRelativeMode=strictToInteger(absoluteRelativeMode,this.locale);assert(()=>[1,2,3,4].includes(_absoluteRelativeMode),expectNumberRangeError(1,4,_absoluteRelativeMode));const _useA1Notation=toBoolean(useA1Notation);let cellReference;if(_useA1Notation){const rangePart={rowFixed:[1,2].includes(_absoluteRelativeMode)?true:false,colFixed:[1,3].includes(_absoluteRelativeMode)?true:false,};cellReference=toXC(colNumber-1,rowNumber-1,rangePart);}
else{const rowPart=[1,2].includes(_absoluteRelativeMode)?`R${rowNumber}`:`R[${rowNumber}]`;const colPart=[1,3].includes(_absoluteRelativeMode)?`C${colNumber}`:`C[${colNumber}]`;cellReference=rowPart+colPart;}
if(sheet!==undefined){return`${getCanonicalSheetName(toString(sheet))}!${cellReference}`;}
return cellReference;},isExported:true,};const COLUMN={description:_t("Column number of a specified cell."),args:[arg("cell_reference (meta, default='this cell')",_t("The cell whose column number will be returned. Column A corresponds to 1. By default, the function use the cell in which the formula is entered.")),],returns:["NUMBER"],compute:function(cellReference){const _cellReference=cellReference||this.__originCellXC?.();assert(()=>!!_cellReference,"In this context, the function [[FUNCTION_NAME]] needs to have a cell or range in parameter.");const zone=toZone(_cellReference);return zone.left+1;},isExported:true,};const COLUMNS={description:_t("Number of columns in a specified array or range."),args:[arg("range (meta)",_t("The range whose column count will be returned."))],returns:["NUMBER"],compute:function(range){const zone=toZone(range);return zone.right-zone.left+1;},isExported:true,};const HLOOKUP={description:_t("Horizontal lookup"),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (range)",_t("The range to consider for the search. The first row in the range is searched for the key specified in search_key.")),arg("index (number)",_t("The row index of the value to be returned, where the first row in range is numbered 1.")),arg(`is_sorted (boolean, default=${DEFAULT_IS_SORTED})`,_t("Indicates whether the row to be searched (the first row of the specified range) is sorted, in which case the closest match for search_key will be returned.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,range,index,isSorted={value:DEFAULT_IS_SORTED}){const _index=Math.trunc(toNumber(index?.value,this.locale));assert(()=>1<=_index&&_index<=range[0].length,_t("[[FUNCTION_NAME]] evaluates to an out of bounds range."));const getValueFromRange=(range,index)=>range[index][0].value;const _isSorted=toBoolean(isSorted.value);const colIndex=_isSorted?dichotomicSearch(range,searchKey?.value,"nextSmaller","asc",range.length,getValueFromRange):linearSearch(range,searchKey?.value,"strict",range.length,getValueFromRange);const col=range[colIndex];assertAvailable(col,searchKey?.value);return col[_index-1];},isExported:true,};const INDEX={description:_t("Returns the content of a cell, specified by row and column offset."),args:[arg("reference (any, range)",_t("The range of cells from which the values are returned.")),arg("row (number, default=0)",_t("The index of the row to be returned from within the reference range of cells.")),arg("column (number, default=0)",_t("The index of the column to be returned from within the reference range of cells.")),],returns:["ANY"],computeValueAndFormat:function(reference,row={value:0},column={value:0}){const _reference=isMatrix(reference)?reference:[[reference]];const _row=toNumber(row.value,this.locale);const _column=toNumber(column.value,this.locale);assert(()=>_column>=0&&_column-1<_reference.length&&_row>=0&&_row-1<_reference[0].length,_t("Index out of range."));if(_row===0&&_column===0){return _reference;}
if(_row===0){return[_reference[_column-1]];}
if(_column===0){return _reference.map((col)=>[col[_row-1]]);}
return _reference[_column-1][_row-1];},isExported:true,};const LOOKUP={description:_t("Look up a value."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("search_array (range)",_t("One method of using this function is to provide a single sorted row or column search_array to look through for the search_key with a second argument result_range. The other way is to combine these two arguments into one search_array where the first row or column is searched and a value is returned from the last row or column in the array. If search_key is not found, a non-exact match may be returned.")),arg("result_range (range, optional)",_t("The range from which to return a result. The value returned corresponds to the location where search_key is found in search_range. This range must be only a single row or column and should not be used if using the search_result_array method.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,searchArray,resultRange){let nbCol=searchArray.length;let nbRow=searchArray[0].length;const verticalSearch=nbRow>=nbCol;const getElement=verticalSearch?(range,index)=>range[0][index].value:(range,index)=>range[index][0].value;const rangeLength=verticalSearch?nbRow:nbCol;const index=dichotomicSearch(searchArray,searchKey?.value,"nextSmaller","asc",rangeLength,getElement);if(index===-1)
assertAvailable(undefined,searchKey?.value);verticalSearch?assertAvailable(searchArray[0][index],searchKey?.value):assertAvailable(searchArray[index][nbRow-1],searchKey?.value);if(resultRange===undefined){return verticalSearch?searchArray[nbCol-1][index]:searchArray[index][nbRow-1];}
nbCol=resultRange.length;nbRow=resultRange[0].length;assert(()=>nbCol===1||nbRow===1,_t("The result_range must be a single row or a single column."));if(nbCol>1){assert(()=>index<=nbCol-1,_t("[[FUNCTION_NAME]] evaluates to an out of range row value %s.",(index+1).toString()));return resultRange[index][0];}
assert(()=>index<=nbRow-1,_t("[[FUNCTION_NAME]] evaluates to an out of range column value %s.",(index+1).toString()));return resultRange[0][index];},isExported:true,};const DEFAULT_SEARCH_TYPE=1;const MATCH={description:_t("Position of item in range that matches value."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (any, range)",_t("The one-dimensional array to be searched.")),arg(`search_type (number, default=${DEFAULT_SEARCH_TYPE})`,_t("The search method. 1 (default) finds the largest value less than or equal to search_key when range is sorted in ascending order. 0 finds the exact value when range is unsorted. -1 finds the smallest value greater than or equal to search_key when range is sorted in descending order.")),],returns:["NUMBER"],compute:function(searchKey,range,searchType=DEFAULT_SEARCH_TYPE){let _searchType=toNumber(searchType,this.locale);const nbCol=range.length;const nbRow=range[0].length;assert(()=>nbCol===1||nbRow===1,_t("The range must be a single row or a single column."));let index=-1;const getElement=nbCol===1?(range,index)=>range[0][index]:(range,index)=>range[index][0];const rangeLen=nbCol===1?range[0].length:range.length;_searchType=Math.sign(_searchType);switch(_searchType){case 1:index=dichotomicSearch(range,searchKey,"nextSmaller","asc",rangeLen,getElement);break;case 0:index=linearSearch(range,searchKey,"strict",rangeLen,getElement);break;case-1:index=dichotomicSearch(range,searchKey,"nextGreater","desc",rangeLen,getElement);break;}
assertAvailable(nbCol===1?range[0][index]:range[index],searchKey);return index+1;},isExported:true,};const ROW={description:_t("Row number of a specified cell."),args:[arg("cell_reference (meta, default='this cell')",_t("The cell whose row number will be returned. By default, this function uses the cell in which the formula is entered.")),],returns:["NUMBER"],compute:function(cellReference){cellReference=cellReference||this.__originCellXC?.();assert(()=>!!cellReference,"In this context, the function [[FUNCTION_NAME]] needs to have a cell or range in parameter.");const zone=toZone(cellReference);return zone.top+1;},isExported:true,};const ROWS={description:_t("Number of rows in a specified array or range."),args:[arg("range (meta)",_t("The range whose row count will be returned."))],returns:["NUMBER"],compute:function(range){const zone=toZone(range);return zone.bottom-zone.top+1;},isExported:true,};const VLOOKUP={description:_t("Vertical lookup."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (any, range)",_t("The range to consider for the search. The first column in the range is searched for the key specified in search_key.")),arg("index (number)",_t("The column index of the value to be returned, where the first column in range is numbered 1.")),arg(`is_sorted (boolean, default=${DEFAULT_IS_SORTED})`,_t("Indicates whether the column to be searched (the first column of the specified range) is sorted, in which case the closest match for search_key will be returned.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,range,index,isSorted={value:DEFAULT_IS_SORTED}){const _index=Math.trunc(toNumber(index?.value,this.locale));assert(()=>1<=_index&&_index<=range.length,_t("[[FUNCTION_NAME]] evaluates to an out of bounds range."));const getValueFromRange=(range,index)=>range[0][index].value;const _isSorted=toBoolean(isSorted.value);const rowIndex=_isSorted?dichotomicSearch(range,searchKey?.value,"nextSmaller","asc",range[0].length,getValueFromRange):linearSearch(range,searchKey?.value,"strict",range[0].length,getValueFromRange);const value=range[_index-1][rowIndex];assertAvailable(value,searchKey);return value;},isExported:true,};const XLOOKUP={description:_t("Search a range for a match and return the corresponding item from a second range."),args:[arg("search_key (any)",_t("The value to search for.")),arg("lookup_range (any, range)",_t("The range to consider for the search. Should be a single column or a single row.")),arg("return_range (any, range)",_t("The range containing the return value. Should have the same dimensions as lookup_range.")),arg("if_not_found (any, lazy, optional)",_t("If a valid match is not found, return this value.")),arg(`match_mode (any, default=${DEFAULT_MATCH_MODE})`,_t("(0) Exact match. (-1) Return next smaller item if no match. (1) Return next greater item if no match.")),arg(`search_mode (any, default=${DEFAULT_SEARCH_MODE})`,_t("(1) Search starting at first item. \
      (-1) Search starting at last item. \
      (2) Perform a binary search that relies on lookup_array being sorted in ascending order. If not sorted, invalid results will be returned. \
      (-2) Perform a binary search that relies on lookup_array being sorted in descending order. If not sorted, invalid results will be returned.\
      ")),],returns:["ANY"],computeValueAndFormat:function(searchKey,lookupRange,returnRange,defaultValue,matchMode={value:DEFAULT_MATCH_MODE},searchMode={value:DEFAULT_SEARCH_MODE}){const _matchMode=Math.trunc(toNumber(matchMode.value,this.locale));const _searchMode=Math.trunc(toNumber(searchMode.value,this.locale));assert(()=>lookupRange.length===1||lookupRange[0].length===1,_t("lookup_range should be either a single row or single column."));assert(()=>[-1,1,-2,2].includes(_searchMode),_t("searchMode should be a value in [-1, 1, -2, 2]."));assert(()=>[-1,0,1].includes(_matchMode),_t("matchMode should be a value in [-1, 0, 1]."));const lookupDirection=lookupRange.length===1?"col":"row";assert(()=>lookupDirection==="col"?returnRange[0].length===lookupRange[0].length:returnRange.length===lookupRange.length,_t("return_range should have the same dimensions as lookup_range."));const getElement=lookupDirection==="col"?(range,index)=>range[0][index].value:(range,index)=>range[index][0].value;const rangeLen=lookupDirection==="col"?lookupRange[0].length:lookupRange.length;const mode=_matchMode===0?"strict":_matchMode===1?"nextGreater":"nextSmaller";const reverseSearch=_searchMode===-1;const index=_searchMode===2||_searchMode===-2?dichotomicSearch(lookupRange,searchKey?.value,mode,_searchMode===2?"asc":"desc",rangeLen,getElement):linearSearch(lookupRange,searchKey?.value,mode,rangeLen,getElement,reverseSearch);if(index!==-1){return lookupDirection==="col"?returnRange.map((col)=>[col[index]]):[returnRange[index]];}
const _defaultValue=defaultValue?.();assertAvailable(_defaultValue,searchKey);return[[_defaultValue]];},isExported:true,};var lookup=Object.freeze({__proto__:null,ADDRESS:ADDRESS,COLUMN:COLUMN,COLUMNS:COLUMNS,HLOOKUP:HLOOKUP,INDEX:INDEX,LOOKUP:LOOKUP,MATCH:MATCH,ROW:ROW,ROWS:ROWS,VLOOKUP:VLOOKUP,XLOOKUP:XLOOKUP});const ADD={description:_t("Sum of two numbers."),args:[arg("value1 (number)",_t("The first addend.")),arg("value2 (number)",_t("The second addend.")),],returns:["NUMBER"],computeFormat:(value1,value2)=>value1?.format||value2?.format,compute:function(value1,value2){return toNumber(value1,this.locale)+toNumber(value2,this.locale);},};const CONCAT={description:_t("Concatenation of two values."),args:[arg("value1 (string)",_t("The value to which value2 will be appended.")),arg("value2 (string)",_t("The value to append to value1.")),],returns:["STRING"],compute:function(value1,value2){return toString(value1)+toString(value2);},isExported:true,};const DIVIDE={description:_t("One number divided by another."),args:[arg("dividend (number)",_t("The number to be divided.")),arg("divisor (number)",_t("The number to divide by.")),],returns:["NUMBER"],computeFormat:(dividend,divisor)=>dividend?.format||divisor?.format,compute:function(dividend,divisor){const _divisor=toNumber(divisor,this.locale);assert(()=>_divisor!==0,_t("The divisor must be different from zero."));return toNumber(dividend,this.locale)/_divisor;},};function isEmpty(value){return value===null||value===undefined;}
const getNeutral={number:0,string:"",boolean:false};const EQ={description:_t("Equal."),args:[arg("value1 (any)",_t("The first value.")),arg("value2 (any)",_t("The value to test against value1 for equality.")),],returns:["BOOLEAN"],compute:function(value1,value2){value1=isEmpty(value1)?getNeutral[typeof value2]:value1;value2=isEmpty(value2)?getNeutral[typeof value1]:value2;if(typeof value1==="string"){value1=value1.toUpperCase();}
if(typeof value2==="string"){value2=value2.toUpperCase();}
return value1===value2;},};function applyRelationalOperator(value1,value2,cb){value1=isEmpty(value1)?getNeutral[typeof value2]:value1;value2=isEmpty(value2)?getNeutral[typeof value1]:value2;if(typeof value1!=="number"){value1=toString(value1).toUpperCase();}
if(typeof value2!=="number"){value2=toString(value2).toUpperCase();}
const tV1=typeof value1;const tV2=typeof value2;if(tV1==="string"&&tV2==="number"){return true;}
if(tV2==="string"&&tV1==="number"){return false;}
return cb(value1,value2);}
const GT={description:_t("Strictly greater than."),args:[arg("value1 (any)",_t("The value to test as being greater than value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return applyRelationalOperator(value1,value2,(v1,v2)=>{return v1>v2;});},};const GTE={description:_t("Greater than or equal to."),args:[arg("value1 (any)",_t("The value to test as being greater than or equal to value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return applyRelationalOperator(value1,value2,(v1,v2)=>{return v1>=v2;});},};const LT={description:_t("Less than."),args:[arg("value1 (any)",_t("The value to test as being less than value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!GTE.compute.bind(this)(value1,value2);},};const LTE={description:_t("Less than or equal to."),args:[arg("value1 (any)",_t("The value to test as being less than or equal to value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!GT.compute.bind(this)(value1,value2);},};const MINUS={description:_t("Difference of two numbers."),args:[arg("value1 (number)",_t("The minuend, or number to be subtracted from.")),arg("value2 (number)",_t("The subtrahend, or number to subtract from value1.")),],returns:["NUMBER"],computeFormat:(value1,value2)=>value1?.format||value2?.format,compute:function(value1,value2){return toNumber(value1,this.locale)-toNumber(value2,this.locale);},};const MULTIPLY={description:_t("Product of two numbers"),args:[arg("factor1 (number)",_t("The first multiplicand.")),arg("factor2 (number)",_t("The second multiplicand.")),],returns:["NUMBER"],computeFormat:(factor1,factor2)=>factor1?.format||factor2?.format,compute:function(factor1,factor2){return toNumber(factor1,this.locale)*toNumber(factor2,this.locale);},};const NE={description:_t("Not equal."),args:[arg("value1 (any)",_t("The first value.")),arg("value2 (any)",_t("The value to test against value1 for inequality.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!EQ.compute.bind(this)(value1,value2);},};const POW={description:_t("A number raised to a power."),args:[arg("base (number)",_t("The number to raise to the exponent power.")),arg("exponent (number)",_t("The exponent to raise base to.")),],returns:["NUMBER"],compute:function(base,exponent){return POWER.compute.bind(this)(base,exponent);},};const UMINUS={description:_t("A number with the sign reversed."),args:[arg("value (number)",_t("The number to have its sign reversed. Equivalently, the number to multiply by -1.")),],computeFormat:(value)=>value?.format,returns:["NUMBER"],compute:function(value){return-toNumber(value,this.locale);},};const UNARY_PERCENT={description:_t("Value interpreted as a percentage."),args:[arg("percentage (number)",_t("The value to interpret as a percentage."))],returns:["NUMBER"],compute:function(percentage){return toNumber(percentage,this.locale)/100;},};const UPLUS={description:_t("A specified number, unchanged."),args:[arg("value (any)",_t("The number to return."))],returns:["ANY"],computeFormat:(value)=>value?.format,compute:function(value=""){return value===null?"":value;},};var operators=Object.freeze({__proto__:null,ADD:ADD,CONCAT:CONCAT,DIVIDE:DIVIDE,EQ:EQ,GT:GT,GTE:GTE,LT:LT,LTE:LTE,MINUS:MINUS,MULTIPLY:MULTIPLY,NE:NE,POW:POW,UMINUS:UMINUS,UNARY_PERCENT:UNARY_PERCENT,UPLUS:UPLUS});const DEFAULT_STARTING_AT=1;const wordRegex=/[A-Za-zÀ-ÖØ-öø-ÿ]+/g;const CHAR={description:_t("Gets character associated with number."),args:[arg("table_number (number)",_t("The number of the character to look up from the current Unicode table in decimal format.")),],returns:["STRING"],compute:function(tableNumber){const _tableNumber=Math.trunc(toNumber(tableNumber,this.locale));assert(()=>_tableNumber>=1,_t("The table_number (%s) is out of range.",_tableNumber.toString()));return String.fromCharCode(_tableNumber);},isExported:true,};const CLEAN={description:_t("Remove non-printable characters from a piece of text."),args:[arg("text (string)",_t("The text whose non-printable characters are to be removed."))],returns:["STRING"],compute:function(text){const _text=toString(text);let cleanedStr="";for(const char of _text){if(char&&char.charCodeAt(0)>31){cleanedStr+=char;}}
return cleanedStr;},isExported:true,};const CONCATENATE={description:_t("Appends strings to one another."),args:[arg("string1 (string, range<string>)",_t("The initial string.")),arg("string2 (string, range<string>, repeating)",_t("More strings to append in sequence.")),],returns:["STRING"],compute:function(...values){return reduceAny(values,(acc,a)=>acc+toString(a),"");},isExported:true,};const EXACT={description:_t("Tests whether two strings are identical."),args:[arg("string1 (string)",_t("The first string to compare.")),arg("string2 (string)",_t("The second string to compare.")),],returns:["BOOLEAN"],compute:function(string1,string2){return toString(string1)===toString(string2);},isExported:true,};const FIND={description:_t("First position of string found in text, case-sensitive."),args:[arg("search_for (string)",_t("The string to look for within text_to_search.")),arg("text_to_search (string)",_t("The text to search for the first occurrence of search_for.")),arg(`starting_at (number, default=${DEFAULT_STARTING_AT})`,_t("The character within text_to_search at which to start the search.")),],returns:["NUMBER"],compute:function(searchFor,textToSearch,startingAt=DEFAULT_STARTING_AT){const _searchFor=toString(searchFor);const _textToSearch=toString(textToSearch);const _startingAt=toNumber(startingAt,this.locale);assert(()=>_textToSearch!=="",_t("The text_to_search must be non-empty."));assert(()=>_startingAt>=1,_t("The starting_at (%s) must be greater than or equal to 1.",_startingAt.toString()));const result=_textToSearch.indexOf(_searchFor,_startingAt-1);assert(()=>result>=0,_t("In [[FUNCTION_NAME]] evaluation, cannot find '%s' within '%s'.",_searchFor.toString(),_textToSearch));return result+1;},isExported:true,};const JOIN={description:_t("Concatenates elements of arrays with delimiter."),args:[arg("delimiter (string)",_t("The character or string to place between each concatenated value.")),arg("value_or_array1 (string, range<string>)",_t("The value or values to be appended using delimiter.")),arg("value_or_array2 (string, range<string>, repeating)",_t("More values to be appended using delimiter.")),],returns:["STRING"],compute:function(delimiter,...valuesOrArrays){const _delimiter=toString(delimiter);return reduceAny(valuesOrArrays,(acc,a)=>(acc?acc+_delimiter:"")+toString(a),"");},};const LEFT={description:_t("Substring from beginning of specified string."),args:[arg("text (string)",_t("The string from which the left portion will be returned.")),arg("number_of_characters (number, optional)",_t("The number of characters to return from the left side of string.")),],returns:["STRING"],compute:function(text,...args){const _numberOfCharacters=args.length?toNumber(args[0],this.locale):1;assert(()=>_numberOfCharacters>=0,_t("The number_of_characters (%s) must be positive or null.",_numberOfCharacters.toString()));return toString(text).substring(0,_numberOfCharacters);},isExported:true,};const LEN={description:_t("Length of a string."),args:[arg("text (string)",_t("The string whose length will be returned."))],returns:["NUMBER"],compute:function(text){return toString(text).length;},isExported:true,};const LOWER={description:_t("Converts a specified string to lowercase."),args:[arg("text (string)",_t("The string to convert to lowercase."))],returns:["STRING"],compute:function(text){return toString(text).toLowerCase();},isExported:true,};const MID={description:_t("A segment of a string."),args:[arg("text (string)",_t("The string to extract a segment from.")),arg("starting_at (number)",_t("The index from the left of string from which to begin extracting. The first character in string has the index 1.")),arg("extract_length (number)",_t("The length of the segment to extract.")),],returns:["STRING"],compute:function(text,starting_at,extract_length){const _text=toString(text);const _starting_at=toNumber(starting_at,this.locale);const _extract_length=toNumber(extract_length,this.locale);assert(()=>_starting_at>=1,_t("The starting_at argument (%s) must be positive greater than one.",_starting_at.toString()));assert(()=>_extract_length>=0,_t("The extract_length argument (%s) must be positive or null.",_extract_length.toString()));return _text.slice(_starting_at-1,_starting_at+_extract_length-1);},isExported:true,};const PROPER={description:_t("Capitalizes each word in a specified string."),args:[arg("text_to_capitalize (string)",_t("The text which will be returned with the first letter of each word in uppercase and all other letters in lowercase.")),],returns:["STRING"],compute:function(text){const _text=toString(text);return _text.replace(wordRegex,(word)=>{return word.charAt(0).toUpperCase()+word.slice(1).toLowerCase();});},isExported:true,};const REPLACE={description:_t("Replaces part of a text string with different text."),args:[arg("text (string)",_t("The text, a part of which will be replaced.")),arg("position (number)",_t("The position where the replacement will begin (starting from 1).")),arg("length (number)",_t("The number of characters in the text to be replaced.")),arg("new_text (string)",_t("The text which will be inserted into the original text.")),],returns:["STRING"],compute:function(text,position,length,newText){const _position=toNumber(position,this.locale);assert(()=>_position>=1,_t("The position (%s) must be greater than or equal to 1.",_position.toString()));const _text=toString(text);const _length=toNumber(length,this.locale);const _newText=toString(newText);return _text.substring(0,_position-1)+_newText+_text.substring(_position-1+_length);},isExported:true,};const RIGHT={description:_t("A substring from the end of a specified string."),args:[arg("text (string)",_t("The string from which the right portion will be returned.")),arg("number_of_characters (number, optional)",_t("The number of characters to return from the right side of string.")),],returns:["STRING"],compute:function(text,...args){const _numberOfCharacters=args.length?toNumber(args[0],this.locale):1;assert(()=>_numberOfCharacters>=0,_t("The number_of_characters (%s) must be positive or null.",_numberOfCharacters.toString()));const _text=toString(text);const stringLength=_text.length;return _text.substring(stringLength-_numberOfCharacters,stringLength);},isExported:true,};const SEARCH={description:_t("First position of string found in text, ignoring case."),args:[arg("search_for (string)",_t("The string to look for within text_to_search.")),arg("text_to_search (string)",_t("The text to search for the first occurrence of search_for.")),arg(`starting_at (number, default=${DEFAULT_STARTING_AT})`,_t("The character within text_to_search at which to start the search.")),],returns:["NUMBER"],compute:function(searchFor,textToSearch,startingAt=DEFAULT_STARTING_AT){const _searchFor=toString(searchFor).toLowerCase();const _textToSearch=toString(textToSearch).toLowerCase();const _startingAt=toNumber(startingAt,this.locale);assert(()=>_textToSearch!=="",_t("The text_to_search must be non-empty."));assert(()=>_startingAt>=1,_t("The starting_at (%s) must be greater than or equal to 1.",_startingAt.toString()));const result=_textToSearch.indexOf(_searchFor,_startingAt-1);assert(()=>result>=0,_t("In [[FUNCTION_NAME]] evaluation, cannot find '%s' within '%s'.",_searchFor,_textToSearch));return result+1;},isExported:true,};const SPLIT_DEFAULT_SPLIT_BY_EACH=true;const SPLIT_DEFAULT_REMOVE_EMPTY_TEXT=true;const SPLIT={description:_t("Split text by specific character delimiter(s)."),args:[arg("text (string)",_t("The text to divide.")),arg("delimiter (string)",_t("The character or characters to use to split text.")),arg(`split_by_each (boolean, default=${SPLIT_DEFAULT_SPLIT_BY_EACH}})`,_t("Whether or not to divide text around each character contained in delimiter.")),arg(`remove_empty_text (boolean, default=${SPLIT_DEFAULT_REMOVE_EMPTY_TEXT})`,_t("Whether or not to remove empty text messages from the split results. The default behavior is to treat \
        consecutive delimiters as one (if TRUE). If FALSE, empty cells values are added between consecutive delimiters.")),],returns:["RANGE<STRING>"],compute:function(text,delimiter,splitByEach=SPLIT_DEFAULT_SPLIT_BY_EACH,removeEmptyText=SPLIT_DEFAULT_REMOVE_EMPTY_TEXT){const _text=toString(text);const _delimiter=escapeRegExp(toString(delimiter));const _splitByEach=toBoolean(splitByEach);const _removeEmptyText=toBoolean(removeEmptyText);assert(()=>_delimiter.length>0,_t("The _delimiter (%s) must be not be empty.",_delimiter));const regex=_splitByEach?new RegExp(`[${_delimiter}]`,"g"):new RegExp(_delimiter,"g");let result=_text.split(regex);if(_removeEmptyText){result=result.filter((text)=>text!=="");}
return transposeMatrix([result]);},isExported:true,};const SUBSTITUTE={description:_t("Replaces existing text with new text in a string."),args:[arg("text_to_search (string)",_t("The text within which to search and replace.")),arg("search_for (string)",_t("The string to search for within text_to_search.")),arg("replace_with (string)",_t("The string that will replace search_for.")),arg("occurrence_number (number, optional)",_t("The instance of search_for within text_to_search to replace with replace_with. By default, all occurrences of search_for are replaced; however, if occurrence_number is specified, only the indicated instance of search_for is replaced.")),],returns:["NUMBER"],compute:function(textToSearch,searchFor,replaceWith,occurrenceNumber){const _occurrenceNumber=toNumber(occurrenceNumber,this.locale);assert(()=>_occurrenceNumber>=0,_t("The occurrenceNumber (%s) must be positive or null.",_occurrenceNumber.toString()));const _textToSearch=toString(textToSearch);const _searchFor=toString(searchFor);if(_searchFor===""){return _textToSearch;}
const _replaceWith=toString(replaceWith);const reg=new RegExp(escapeRegExp(_searchFor),"g");if(_occurrenceNumber===0){return _textToSearch.replace(reg,_replaceWith);}
let n=0;return _textToSearch.replace(reg,(text)=>(++n===_occurrenceNumber?_replaceWith:text));},isExported:true,};const TEXTJOIN={description:_t("Combines text from multiple strings and/or arrays."),args:[arg("delimiter (string)",_t(" A string, possible empty, or a reference to a valid string. If empty, the text will be simply concatenated.")),arg("ignore_empty (boolean)",_t("A boolean; if TRUE, empty cells selected in the text arguments won't be included in the result.")),arg("text1 (string, range<string>)",_t("Any text item. This could be a string, or an array of strings in a range.")),arg("text2 (string, range<string>, repeating)",_t("Additional text item(s).")),],returns:["STRING"],compute:function(delimiter,ignoreEmpty,...textsOrArrays){const _delimiter=toString(delimiter);const _ignoreEmpty=toBoolean(ignoreEmpty);let n=0;return reduceAny(textsOrArrays,(acc,a)=>!(_ignoreEmpty&&toString(a)==="")?(n++?acc+_delimiter:"")+toString(a):acc,"");},isExported:true,};const TRIM={description:_t("Removes space characters."),args:[arg("text (string)",_t("The text or reference to a cell containing text to be trimmed.")),],returns:["STRING"],compute:function(text){return trimContent(toString(text));},isExported:true,};const UPPER={description:_t("Converts a specified string to uppercase."),args:[arg("text (string)",_t("The string to convert to uppercase."))],returns:["STRING"],compute:function(text){return toString(text).toUpperCase();},isExported:true,};const TEXT={description:_t("Converts a number to text according to a specified format."),args:[arg("number (number)",_t("The number, date or time to format.")),arg("format (string)",_t("The pattern by which to format the number, enclosed in quotation marks.")),],returns:["STRING"],compute:function(number,format){const _number=toNumber(number,this.locale);return formatValue(_number,{format:toString(format),locale:this.locale});},isExported:true,};var text=Object.freeze({__proto__:null,CHAR:CHAR,CLEAN:CLEAN,CONCATENATE:CONCATENATE,EXACT:EXACT,FIND:FIND,JOIN:JOIN,LEFT:LEFT,LEN:LEN,LOWER:LOWER,MID:MID,PROPER:PROPER,REPLACE:REPLACE,RIGHT:RIGHT,SEARCH:SEARCH,SPLIT:SPLIT,SUBSTITUTE:SUBSTITUTE,TEXT:TEXT,TEXTJOIN:TEXTJOIN,TRIM:TRIM,UPPER:UPPER});const HYPERLINK={description:_t("Creates a hyperlink in a cell."),args:[arg("url (string)",_t("The full URL of the link enclosed in quotation marks.")),arg("link_label (string, optional)",_t("The text to display in the cell, enclosed in quotation marks.")),],returns:["STRING"],compute:function(url,linkLabel){const processedUrl=toString(url).trim();const processedLabel=toString(linkLabel)||processedUrl;if(processedUrl==="")
return processedLabel;return markdownLink(processedLabel,processedUrl);},isExported:true,};var web=Object.freeze({__proto__:null,HYPERLINK:HYPERLINK});const categories=[{name:_t("Array"),functions:array},{name:_t("Database"),functions:database},{name:_t("Date"),functions:date},{name:_t("Filter"),functions:filter},{name:_t("Financial"),functions:financial},{name:_t("Info"),functions:info},{name:_t("Lookup"),functions:lookup},{name:_t("Logical"),functions:logical},{name:_t("Math"),functions:math},{name:_t("Misc"),functions:misc},{name:_t("Operator"),functions:operators},{name:_t("Statistical"),functions:statistical},{name:_t("Text"),functions:text},{name:_t("Engineering"),functions:engineering},{name:_t("Web"),functions:web},];const functionNameRegex=/^[A-Z0-9\_\.]+$/;class FunctionRegistry extends Registry{mapping={};add(name,addDescr){name=name.toUpperCase();if(!functionNameRegex.test(name)){throw new Error(_t("Invalid function name %s. Function names can exclusively contain alphanumerical values separated by dots (.) or underscore (_)",name));}
const descr=addMetaInfoFromArg(addDescr);validateArguments(descr.args);this.mapping[name]=addInputHandling(descr,createComputeFunctionFromDescription(descr));super.add(name,descr);return this;}}
function addInputHandling(descr,computeFunction){function computeWithInputHandling(...args){for(let i=0;i<args.length;i++){const argDefinition=descr.args[descr.getArgToFocus(i+1)-1];const arg=args[i];if(isMatrix(arg)&&!argDefinition.acceptMatrix){if(arg.length!==1||arg[0].length!==1){throw new EvaluationError(CellErrorType.GenericError,_t("Function [[FUNCTION_NAME]] expects the parameter '%s' to be a single value or a single cell reference, not a range.",argDefinition.name));}
args[i]=arg[0][0];}}
return computeFunction.apply(this,args);}
return computeWithInputHandling;}
function createComputeFunctionFromDescription(descr){const computeValueAndFormat="computeValueAndFormat"in descr;const computeValue="compute"in descr;const computeFormat="computeFormat"in descr;if(!computeValueAndFormat&&!computeValue){throw new Error("Invalid function description, need at least one 'compute' or 'computeValueAndFormat' function");}
if(computeValueAndFormat&&(computeValue||computeFormat)){throw new Error("Invalid function description, cannot have both 'computeValueAndFormat' and 'compute'/'computeFormat' functions");}
if(computeValueAndFormat){return descr.computeValueAndFormat;}
return buildComputeFunctionFromDescription(descr);}
function buildComputeFunctionFromDescription(descr){return function(...args){const value=descr.compute.apply(this,extractArgValuesFromArgs(args));const format=descr.computeFormat?.apply(this,args);if(isMatrix(value)){if(format===undefined||isMatrix(format)){return value.map((col,i)=>col.map((row,j)=>({value:row,format:format?.[i]?.[j]})));}}
else{if(format===undefined||!isMatrix(format)){return{value,format};}}
throw new Error("A format matrix should never be associated with a scalar value");};}
function extractArgValuesFromArgs(args){return args.map((arg)=>{if(arg===undefined){return undefined;}
if(typeof arg==="function"){return()=>extractArgValueFromArg(arg());}
return extractArgValueFromArg(arg);});}
function extractArgValueFromArg(arg){if(isMatrix(arg)){return matrixMap(arg,(data)=>data.value);}
return arg?.value;}
const functionRegistry=new FunctionRegistry();for(let category of categories){const fns=category.functions;for(let name in fns){const addDescr=fns[name];addDescr.category=addDescr.category||category.name;name=name.replace(/_/g,".");functionRegistry.add(name,{isExported:false,...addDescr});}}
const insertRow={name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row"):_t("Insert %s rows",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW",};const rowInsertRowBefore={name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row above"):_t("Insert %s rows above",number.toString());},execute:INSERT_ROWS_BEFORE_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW_BEFORE",};const topBarInsertRowsBefore={...rowInsertRowBefore,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Row above");}
return _t("%s Rows above",number.toString());},};const cellInsertRowsBefore={...rowInsertRowBefore,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Insert row");}
return _t("Insert %s rows",number.toString());},isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.INSERT_ROW_BEFORE",};const rowInsertRowsAfter={execute:INSERT_ROWS_AFTER_ACTION,name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row below"):_t("Insert %s rows below",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW_AFTER",};const topBarInsertRowsAfter={...rowInsertRowsAfter,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Row below");}
return _t("%s Rows below",number.toString());},};const insertCol={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column"):_t("Insert %s columns",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL",};const colInsertColsBefore={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column left"):_t("Insert %s columns left",number.toString());},execute:INSERT_COLUMNS_BEFORE_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL_BEFORE",};const topBarInsertColsBefore={...colInsertColsBefore,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Column left");}
return _t("%s Columns left",number.toString());},};const cellInsertColsBefore={...colInsertColsBefore,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Insert column");}
return _t("Insert %s columns",number.toString());},isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.INSERT_COL_BEFORE",};const colInsertColsAfter={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column right"):_t("Insert %s columns right",number.toString());},execute:INSERT_COLUMNS_AFTER_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL_AFTER",};const topBarInsertColsAfter={...colInsertColsAfter,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Column right");}
return _t("%s Columns right",number.toString());},execute:INSERT_COLUMNS_AFTER_ACTION,};const insertCell={name:_t("Insert cells"),isVisible:(env)=>IS_ONLY_ONE_RANGE(env)&&env.model.getters.getActiveCols().size===0&&env.model.getters.getActiveRows().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL",};const insertCellShiftDown={name:_t("Insert cells and shift down"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("INSERT_CELL",{zone,shiftDimension:"ROW"});handlePasteResult(env,result);},isVisible:(env)=>env.model.getters.getActiveRows().size===0&&env.model.getters.getActiveCols().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL_SHIFT_DOWN",};const insertCellShiftRight={name:_t("Insert cells and shift right"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("INSERT_CELL",{zone,shiftDimension:"COL"});handlePasteResult(env,result);},isVisible:(env)=>env.model.getters.getActiveRows().size===0&&env.model.getters.getActiveCols().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL_SHIFT_RIGHT",};const insertChart={name:_t("Chart"),execute:CREATE_CHART,icon:"o-spreadsheet-Icon.INSERT_CHART",};const insertImage={name:_t("Image"),description:"Ctrl+O",execute:CREATE_IMAGE,isVisible:(env)=>env.imageProvider!==undefined,icon:"o-spreadsheet-Icon.INSERT_IMAGE",};const insertFunction={name:_t("Function"),icon:"o-spreadsheet-Icon.SHOW_HIDE_FORMULA",};const insertFunctionSum={name:_t("SUM"),execute:(env)=>env.startCellEdition(`=SUM(`),};const insertFunctionAverage={name:_t("AVERAGE"),execute:(env)=>env.startCellEdition(`=AVERAGE(`),};const insertFunctionCount={name:_t("COUNT"),execute:(env)=>env.startCellEdition(`=COUNT(`),};const insertFunctionMax={name:_t("MAX"),execute:(env)=>env.startCellEdition(`=MAX(`),};const insertFunctionMin={name:_t("MIN"),execute:(env)=>env.startCellEdition(`=MIN(`),};const categorieFunctionAll={name:_t("All"),children:[allFunctionListMenuBuilder],};function allFunctionListMenuBuilder(){const fnNames=functionRegistry.getKeys().filter((key)=>!functionRegistry.get(key).hidden);return createFormulaFunctions(fnNames);}
const categoriesFunctionListMenuBuilder=()=>{const functions=functionRegistry.content;const categories=[...new Set(functionRegistry.getAll().filter((fn)=>!fn.hidden).map((fn)=>fn.category)),].filter(isDefined$1);return categories.sort().map((category,i)=>{const functionsInCategory=Object.keys(functions).filter((key)=>functions[key].category===category&&!functions[key].hidden);return{name:category,children:createFormulaFunctions(functionsInCategory),};});};const insertLink={name:_t("Link"),execute:INSERT_LINK,icon:"o-spreadsheet-Icon.INSERT_LINK",};const insertSheet={name:_t("Insert sheet"),execute:(env)=>{const activeSheetId=env.model.getters.getActiveSheetId();const position=env.model.getters.getSheetIds().indexOf(activeSheetId)+1;const sheetId=env.model.uuidGenerator.uuidv4();env.model.dispatch("CREATE_SHEET",{sheetId,position});env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:sheetId});},icon:"o-spreadsheet-Icon.INSERT_SHEET",};function createFormulaFunctions(fnNames){return fnNames.sort().map((fnName,i)=>{return{name:fnName,sequence:i*10,execute:(env)=>env.startCellEdition(`=${fnName}(`),};});}
function getRowsNumber(env){const activeRows=env.model.getters.getActiveRows();if(activeRows.size){return activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];return zone.bottom-zone.top+1;}}
function getColumnsNumber(env){const activeCols=env.model.getters.getActiveCols();if(activeCols.size){return activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];return zone.right-zone.left+1;}}
const cellMenuRegistry=new MenuItemRegistry();cellMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("add_row_before",{...cellInsertRowsBefore,sequence:70,}).add("add_column_before",{...cellInsertColsBefore,sequence:90,}).add("insert_cell",{...insertCell,sequence:100,separator:true,}).addChild("insert_cell_down",["insert_cell"],{...insertCellShiftDown,name:_t("Shift down"),sequence:10,}).addChild("insert_cell_right",["insert_cell"],{...insertCellShiftRight,name:_t("Shift right"),sequence:20,}).add("delete_row",{...deleteRow,sequence:110,icon:"o-spreadsheet-Icon.DELETE",}).add("delete_column",{...deleteCol,sequence:120,icon:"o-spreadsheet-Icon.DELETE",}).add("delete_cell",{...deleteCells,sequence:130,separator:true,icon:"o-spreadsheet-Icon.DELETE",}).addChild("delete_cell_up",["delete_cell"],{...deleteCellShiftUp,name:_t("Shift up"),sequence:10,icon:"o-spreadsheet-Icon.DELETE_CELL_SHIFT_UP",}).addChild("delete_cell_left",["delete_cell"],{...deleteCellShiftLeft,name:_t("Shift left"),sequence:20,icon:"o-spreadsheet-Icon.DELETE_CELL_SHIFT_LEFT",}).add("insert_link",{...insertLink,name:INSERT_LINK_NAME,sequence:150,separator:true,});const AddFilterInteractiveContent={filterOverlap:_t("You cannot create overlapping filters."),nonContinuousTargets:_t("A filter can only be created on a continuous selection."),mergeInFilter:_t("You can't create a filter over a range that contains a merge."),};function interactiveAddFilter(env,sheetId,target){const result=env.model.dispatch("CREATE_FILTER_TABLE",{target,sheetId});if(result.isCancelledBecause("FilterOverlap")){env.raiseError(AddFilterInteractiveContent.filterOverlap);}
else if(result.isCancelledBecause("MergeInFilter")){env.raiseError(AddFilterInteractiveContent.mergeInFilter);}
else if(result.isCancelledBecause("NonContinuousTargets")){env.raiseError(AddFilterInteractiveContent.nonContinuousTargets);}}
function interactiveFreezeColumnsRows(env,dimension,base){const sheetId=env.model.getters.getActiveSheetId();const cmd=dimension==="COL"?"FREEZE_COLUMNS":"FREEZE_ROWS";const result=env.model.dispatch(cmd,{sheetId,quantity:base});if(result.isCancelledBecause("MergeOverlap")){env.raiseError(MergeErrorMessage);}}
const hideCols={name:HIDE_COLUMNS_NAME,execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("COL");env.model.dispatch("HIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});},isVisible:NOT_ALL_VISIBLE_COLS_SELECTED,icon:"o-spreadsheet-Icon.HIDE_COL",};const unhideCols={name:_t("Unhide columns"),execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("COL");env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});},isVisible:(env)=>{const hiddenCols=env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId()).flat();const currentCols=env.model.getters.getElementsFromSelection("COL");return currentCols.some((col)=>hiddenCols.includes(col));},};const unhideAllCols={name:_t("Unhide all columns"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId,dimension:"COL",elements:Array.from(Array(env.model.getters.getNumberCols(sheetId)).keys()),});},isVisible:(env)=>env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId()).length>0,};const hideRows={name:HIDE_ROWS_NAME,execute:(env)=>{const rows=env.model.getters.getElementsFromSelection("ROW");env.model.dispatch("HIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});},isVisible:NOT_ALL_VISIBLE_ROWS_SELECTED,icon:"o-spreadsheet-Icon.HIDE_ROW",};const unhideRows={name:_t("Unhide rows"),execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("ROW");env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:columns,});},isVisible:(env)=>{const hiddenRows=env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId()).flat();const currentRows=env.model.getters.getElementsFromSelection("ROW");return currentRows.some((col)=>hiddenRows.includes(col));},};const unhideAllRows={name:_t("Unhide all rows"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId,dimension:"ROW",elements:Array.from(Array(env.model.getters.getNumberRows(sheetId)).keys()),});},isVisible:(env)=>env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId()).length>0,};const unFreezePane={name:_t("Unfreeze"),isVisible:(env)=>{const{xSplit,ySplit}=env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId());return xSplit+ySplit>0;},execute:(env)=>env.model.dispatch("UNFREEZE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),}),icon:"o-spreadsheet-Icon.UNFREEZE",};const freezePane={name:_t("Freeze"),icon:"o-spreadsheet-Icon.FREEZE",};const unFreezeRows={name:_t("No rows"),execute:(env)=>env.model.dispatch("UNFREEZE_ROWS",{sheetId:env.model.getters.getActiveSheetId(),}),isReadonlyAllowed:true,isVisible:(env)=>!!env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId()).ySplit,};const freezeFirstRow={name:_t("1 row"),execute:(env)=>interactiveFreezeColumnsRows(env,"ROW",1),isReadonlyAllowed:true,};const freezeSecondRow={name:_t("2 rows"),execute:(env)=>interactiveFreezeColumnsRows(env,"ROW",2),isReadonlyAllowed:true,};const freezeCurrentRow={name:_t("Up to current row"),execute:(env)=>{const{bottom}=env.model.getters.getSelectedZone();interactiveFreezeColumnsRows(env,"ROW",bottom+1);},isReadonlyAllowed:true,};const unFreezeCols={name:_t("No columns"),execute:(env)=>env.model.dispatch("UNFREEZE_COLUMNS",{sheetId:env.model.getters.getActiveSheetId(),}),isReadonlyAllowed:true,isVisible:(env)=>!!env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId()).xSplit,};const freezeFirstCol={name:_t("1 column"),execute:(env)=>interactiveFreezeColumnsRows(env,"COL",1),isReadonlyAllowed:true,};const freezeSecondCol={name:_t("2 columns"),execute:(env)=>interactiveFreezeColumnsRows(env,"COL",2),isReadonlyAllowed:true,};const freezeCurrentCol={name:_t("Up to current column"),execute:(env)=>{const{right}=env.model.getters.getSelectedZone();interactiveFreezeColumnsRows(env,"COL",right+1);},isReadonlyAllowed:true,};const viewGridlines={name:(env)=>env.model.getters.getGridLinesVisibility(env.model.getters.getActiveSheetId())?_t("Hide gridlines"):_t("Show gridlines"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("SET_GRID_LINES_VISIBILITY",{sheetId,areGridLinesVisible:!env.model.getters.getGridLinesVisibility(sheetId),});},icon:"o-spreadsheet-Icon.SHOW_HIDE_GRID",};const viewFormulas={name:(env)=>env.model.getters.shouldShowFormulas()?"Hide formulas":_t("Show formulas"),execute:(env)=>env.model.dispatch("SET_FORMULA_VISIBILITY",{show:!env.model.getters.shouldShowFormulas()}),isReadonlyAllowed:true,icon:"o-spreadsheet-Icon.SHOW_HIDE_FORMULA",};const createRemoveFilter={name:(env)=>selectionContainsFilter(env)?_t("Remove selected filters"):_t("Create filter"),isActive:(env)=>selectionContainsFilter(env),isEnabled:(env)=>!cannotCreateFilter(env),execute:(env)=>createRemoveFilterAction(env),icon:"o-spreadsheet-Icon.FILTER_ICON_INACTIVE",};const groupColumns={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.left===selection.right){return _t("Group column %s",numberToLetters(selection.left));}
return _t("Group columns %s - %s",numberToLetters(selection.left),numberToLetters(selection.right));},execute:(env)=>groupHeadersAction(env,"COL"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZone();const groups=env.model.getters.getHeaderGroupsInZone(sheetId,"COL",selection);return(IS_ONLY_ONE_RANGE(env)&&!groups.some((group)=>group.start===selection.left&&group.end===selection.right));},icon:"o-spreadsheet-Icon.GROUP_COLUMNS",};const groupRows={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.top===selection.bottom){return _t("Group row %s",String(selection.top+1));}
return _t("Group rows %s - %s",String(selection.top+1),String(selection.bottom+1));},execute:(env)=>groupHeadersAction(env,"ROW"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZone();const groups=env.model.getters.getHeaderGroupsInZone(sheetId,"ROW",selection);return(IS_ONLY_ONE_RANGE(env)&&!groups.some((group)=>group.start===selection.top&&group.end===selection.bottom));},icon:"o-spreadsheet-Icon.GROUP_ROWS",};const ungroupColumns={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.left===selection.right){return _t("Ungroup column %s",numberToLetters(selection.left));}
return _t("Ungroup columns %s - %s",numberToLetters(selection.left),numberToLetters(selection.right));},execute:(env)=>ungroupHeaders(env,"COL"),icon:"o-spreadsheet-Icon.UNGROUP_COLUMNS",};const ungroupRows={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.top===selection.bottom){return _t("Ungroup row %s",String(selection.top+1));}
return _t("Ungroup rows %s - %s",String(selection.top+1),String(selection.bottom+1));},execute:(env)=>ungroupHeaders(env,"ROW"),icon:"o-spreadsheet-Icon.UNGROUP_ROWS",};function selectionContainsFilter(env){const sheetId=env.model.getters.getActiveSheetId();const selectedZones=env.model.getters.getSelectedZones();return env.model.getters.doesZonesContainFilter(sheetId,selectedZones);}
function cannotCreateFilter(env){return!areZonesContinuous(...env.model.getters.getSelectedZones());}
function createRemoveFilterAction(env){if(selectionContainsFilter(env)){env.model.dispatch("REMOVE_FILTER_TABLE",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),});return;}
if(cannotCreateFilter(env)){return;}
env.model.selection.selectTableAroundSelection();const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZones();interactiveAddFilter(env,sheetId,selection);}
function groupHeadersAction(env,dim){const selection=env.model.getters.getSelectedZone();const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("GROUP_HEADERS",{sheetId,dimension:dim,start:dim==="COL"?selection.left:selection.top,end:dim==="COL"?selection.right:selection.bottom,});}
function ungroupHeaders(env,dim){const selection=env.model.getters.getSelectedZone();const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension:dim,start:dim==="COL"?selection.left:selection.top,end:dim==="COL"?selection.right:selection.bottom,});}
function canUngroupHeaders(env,dimension){const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZones();return(selection.length===1&&env.model.getters.getHeaderGroupsInZone(sheetId,dimension,selection[0]).length>0);}
var ACTION_VIEW=Object.freeze({__proto__:null,canUngroupHeaders:canUngroupHeaders,createRemoveFilter:createRemoveFilter,createRemoveFilterAction:createRemoveFilterAction,freezeCurrentCol:freezeCurrentCol,freezeCurrentRow:freezeCurrentRow,freezeFirstCol:freezeFirstCol,freezeFirstRow:freezeFirstRow,freezePane:freezePane,freezeSecondCol:freezeSecondCol,freezeSecondRow:freezeSecondRow,groupColumns:groupColumns,groupRows:groupRows,hideCols:hideCols,hideRows:hideRows,unFreezeCols:unFreezeCols,unFreezePane:unFreezePane,unFreezeRows:unFreezeRows,ungroupColumns:ungroupColumns,ungroupRows:ungroupRows,unhideAllCols:unhideAllCols,unhideAllRows:unhideAllRows,unhideCols:unhideCols,unhideRows:unhideRows,viewFormulas:viewFormulas,viewGridlines:viewGridlines});const sortRange={name:_t("Sort range"),isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.SORT_RANGE",};const sortAscending={name:_t("Ascending (A ⟶ Z)"),execute:(env)=>{const{anchor,zones}=env.model.getters.getSelection();const sheetId=env.model.getters.getActiveSheetId();interactiveSortSelection(env,sheetId,anchor.cell,zones[0],"ascending");},icon:"o-spreadsheet-Icon.SORT_ASCENDING",};const dataCleanup={name:_t("Data cleanup"),icon:"o-spreadsheet-Icon.DATA_CLEANUP",};const removeDuplicates={name:_t("Remove duplicates"),execute:(env)=>{if(getZoneArea(env.model.getters.getSelectedZone())===1){env.model.selection.selectTableAroundSelection();}
env.openSidePanel("RemoveDuplicates",{});},};const trimWhitespace={name:_t("Trim whitespace"),execute:(env)=>{env.model.dispatch("TRIM_WHITESPACE");},};const sortDescending={name:_t("Descending (Z ⟶ A)"),execute:(env)=>{const{anchor,zones}=env.model.getters.getSelection();const sheetId=env.model.getters.getActiveSheetId();interactiveSortSelection(env,sheetId,anchor.cell,zones[0],"descending");},icon:"o-spreadsheet-Icon.SORT_DESCENDING",};const addRemoveDataFilter={name:(env)=>SELECTION_CONTAINS_FILTER(env)?_t("Remove filter"):_t("Create filter"),execute:(env)=>createRemoveFilterAction(env),isEnabled:(env)=>{const selectedZones=env.model.getters.getSelectedZones();return areZonesContinuous(...selectedZones);},icon:"o-spreadsheet-Icon.MENU_FILTER_ICON",};const splitToColumns={name:_t("Split text to columns"),sequence:1,execute:(env)=>env.openSidePanel("SplitToColumns",{}),isEnabled:(env)=>env.model.getters.isSingleColSelected(),icon:"o-spreadsheet-Icon.SPLIT_TEXT",};function createFormatActionSpec({name,format,descriptionValue,}){const formatCallback=typeof format==="function"?format:()=>format;return{name,description:(env)=>formatValue(descriptionValue,{format:formatCallback(env),locale:env.model.getters.getLocale(),}),execute:(env)=>setFormatter(env,formatCallback(env)),isActive:(env)=>isFormatSelected(env,formatCallback(env)),};}
const formatNumberAutomatic={name:_t("Automatic"),execute:(env)=>setFormatter(env,""),isActive:(env)=>isAutomaticFormatSelected(env),};const formatNumberNumber=createFormatActionSpec({name:_t("Number"),descriptionValue:1000.12,format:"#,##0.00",});const formatPercent={name:_t("Format as percent"),execute:FORMAT_PERCENT_ACTION,icon:"o-spreadsheet-Icon.PERCENT",};const formatNumberPercent=createFormatActionSpec({name:_t("Percent"),descriptionValue:0.1012,format:"0.00%",});const formatNumberCurrency=createFormatActionSpec({name:_t("Currency"),descriptionValue:1000.12,format:(env)=>env.model.config.defaultCurrencyFormat??DEFAULT_CURRENCY_FORMAT,});const formatNumberCurrencyRounded={...createFormatActionSpec({name:_t("Currency rounded"),descriptionValue:1000,format:(env)=>roundFormat(env.model.config.defaultCurrencyFormat??DEFAULT_CURRENCY_FORMAT),}),isVisible:(env)=>{const currencyFormat=env.model.config.defaultCurrencyFormat;return currencyFormat!==roundFormat(currencyFormat??DEFAULT_CURRENCY_FORMAT);},};const DEFAULT_CURRENCY_FORMAT="[$$]#,##0.00";const EXAMPLE_DATE=parseLiteral("2023/09/26 10:43:00 PM",DEFAULT_LOCALE);const formatCustomCurrency={name:_t("Custom currency"),isVisible:(env)=>env.loadCurrencies!==undefined,execute:(env)=>env.openSidePanel("CustomCurrency",{}),};const formatNumberDate=createFormatActionSpec({name:_t("Date"),descriptionValue:EXAMPLE_DATE,format:(env)=>env.model.getters.getLocale().dateFormat,});const formatNumberTime=createFormatActionSpec({name:_t("Time"),descriptionValue:EXAMPLE_DATE,format:(env)=>env.model.getters.getLocale().timeFormat,});const formatNumberDateTime=createFormatActionSpec({name:_t("Date time"),descriptionValue:EXAMPLE_DATE,format:(env)=>{const locale=env.model.getters.getLocale();return getDateTimeFormat(locale);},});const formatNumberDuration=createFormatActionSpec({name:_t("Duration"),descriptionValue:"27:51:38",format:"hhhh:mm:ss",});const moreFormats={name:_t("More date formats"),execute:(env)=>env.openSidePanel("MoreFormats",{}),};const formatNumberFullDateTime=createFormatActionSpec({name:_t("Full date time"),format:"dddd d mmmm yyyy hh:mm:ss a",descriptionValue:EXAMPLE_DATE,});const formatNumberFullWeekDayAndMonth=createFormatActionSpec({name:_t("Full week day and month"),format:"dddd d mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberDayAndFullMonth=createFormatActionSpec({name:_t("Day and full month"),format:"d mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberShortWeekDay=createFormatActionSpec({name:_t("Short week day"),format:"ddd d mmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberDayAndShortMonth=createFormatActionSpec({name:_t("Day and short month"),format:"d mmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberFullMonth=createFormatActionSpec({name:_t("Full month"),format:"mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberShortMonth=createFormatActionSpec({name:_t("Short month"),format:"mmm yyyy",descriptionValue:EXAMPLE_DATE,});const incraseDecimalPlaces={name:_t("Increase decimal places"),icon:"o-spreadsheet-Icon.INCREASE_DECIMAL",execute:(env)=>env.model.dispatch("SET_DECIMAL",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),step:1,}),};const decraseDecimalPlaces={name:_t("Decrease decimal places"),icon:"o-spreadsheet-Icon.DECRASE_DECIMAL",execute:(env)=>env.model.dispatch("SET_DECIMAL",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),step:-1,}),};const formatBold={name:_t("Bold"),description:"Ctrl+B",execute:(env)=>setStyle(env,{bold:!env.model.getters.getCurrentStyle().bold}),icon:"o-spreadsheet-Icon.BOLD",isActive:(env)=>!!env.model.getters.getCurrentStyle().bold,};const formatItalic={name:_t("Italic"),description:"Ctrl+I",execute:(env)=>setStyle(env,{italic:!env.model.getters.getCurrentStyle().italic}),icon:"o-spreadsheet-Icon.ITALIC",isActive:(env)=>!!env.model.getters.getCurrentStyle().italic,};const formatUnderline={name:_t("Underline"),description:"Ctrl+U",execute:(env)=>setStyle(env,{underline:!env.model.getters.getCurrentStyle().underline}),icon:"o-spreadsheet-Icon.UNDERLINE",isActive:(env)=>!!env.model.getters.getCurrentStyle().underline,};const formatStrikethrough={name:_t("Strikethrough"),execute:(env)=>setStyle(env,{strikethrough:!env.model.getters.getCurrentStyle().strikethrough}),icon:"o-spreadsheet-Icon.STRIKE",isActive:(env)=>!!env.model.getters.getCurrentStyle().strikethrough,};const formatFontSize={name:_t("Font size"),children:fontSizeMenuBuilder(),icon:"o-spreadsheet-Icon.FONT_SIZE",};const formatAlignment={name:_t("Alignment"),icon:"o-spreadsheet-Icon.ALIGN_LEFT",};const formatAlignmentHorizontal={name:_t("Horizontal align"),icon:(env)=>getHorizontalAlignmentIcon(env),};const formatAlignmentLeft={name:_t("Left"),description:"Ctrl+Shift+L",execute:(env)=>setStyle(env,{align:"left"}),isActive:(env)=>getHorizontalAlign(env)==="left",icon:"o-spreadsheet-Icon.ALIGN_LEFT",};const formatAlignmentCenter={name:_t("Center"),description:"Ctrl+Shift+E",execute:(env)=>setStyle(env,{align:"center"}),isActive:(env)=>getHorizontalAlign(env)==="center",icon:"o-spreadsheet-Icon.ALIGN_CENTER",};const formatAlignmentRight={name:_t("Right"),description:"Ctrl+Shift+R",execute:(env)=>setStyle(env,{align:"right"}),isActive:(env)=>getHorizontalAlign(env)==="right",icon:"o-spreadsheet-Icon.ALIGN_RIGHT",};const formatAlignmentVertical={name:_t("Vertical align"),icon:(env)=>getVerticalAlignmentIcon(env),};const formatAlignmentTop={name:_t("Top"),execute:(env)=>setStyle(env,{verticalAlign:"top"}),isActive:(env)=>getVerticalAlign(env)==="top",icon:"o-spreadsheet-Icon.ALIGN_TOP",};const formatAlignmentMiddle={name:_t("Middle"),execute:(env)=>setStyle(env,{verticalAlign:"middle"}),isActive:(env)=>getVerticalAlign(env)==="middle",icon:"o-spreadsheet-Icon.ALIGN_MIDDLE",};const formatAlignmentBottom={name:_t("Bottom"),execute:(env)=>setStyle(env,{verticalAlign:"bottom"}),isActive:(env)=>getVerticalAlign(env)==="bottom",icon:"o-spreadsheet-Icon.ALIGN_BOTTOM",};const formatWrappingIcon={name:_t("Wrapping"),icon:"o-spreadsheet-Icon.WRAPPING_OVERFLOW",};const formatWrapping={name:_t("Wrapping"),icon:(env)=>getWrapModeIcon(env),};const formatWrappingOverflow={name:_t("Overflow"),execute:(env)=>setStyle(env,{wrapping:"overflow"}),isActive:(env)=>getWrappingMode(env)==="overflow",icon:"o-spreadsheet-Icon.WRAPPING_OVERFLOW",};const formatWrappingWrap={name:_t("Wrap"),execute:(env)=>setStyle(env,{wrapping:"wrap"}),isActive:(env)=>getWrappingMode(env)==="wrap",icon:"o-spreadsheet-Icon.WRAPPING_WRAP",};const formatWrappingClip={name:_t("Clip"),execute:(env)=>setStyle(env,{wrapping:"clip"}),isActive:(env)=>getWrappingMode(env)==="clip",icon:"o-spreadsheet-Icon.WRAPPING_CLIP",};const textColor={name:_t("Text Color"),icon:"o-spreadsheet-Icon.TEXT_COLOR",};const fillColor={name:_t("Fill Color"),icon:"o-spreadsheet-Icon.FILL_COLOR",};const formatCF={name:_t("Conditional formatting"),execute:OPEN_CF_SIDEPANEL_ACTION,icon:"o-spreadsheet-Icon.CONDITIONAL_FORMAT",};const clearFormat={name:_t("Clear formatting"),description:"Ctrl+<",execute:(env)=>env.model.dispatch("CLEAR_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),}),icon:"o-spreadsheet-Icon.CLEAR_FORMAT",};function fontSizeMenuBuilder(){return FONT_SIZES.map((fs)=>{return{name:fs.toString(),sequence:fs,id:`font_size_${fs}`,execute:(env)=>setStyle(env,{fontSize:fs}),isActive:(env)=>isFontSizeSelected(env,fs),};});}
function isAutomaticFormatSelected(env){const activeCell=env.model.getters.getCell(env.model.getters.getActivePosition());return!activeCell||!activeCell.format;}
function isFormatSelected(env,format){const activeCell=env.model.getters.getCell(env.model.getters.getActivePosition());return activeCell?.format===format;}
function isFontSizeSelected(env,fontSize){const currentFontSize=env.model.getters.getCurrentStyle().fontSize||DEFAULT_FONT_SIZE;return currentFontSize===fontSize;}
function getHorizontalAlign(env){const style=env.model.getters.getCurrentStyle();if(style.align){return style.align;}
const cell=env.model.getters.getActiveCell();return cell.defaultAlign;}
function getVerticalAlign(env){const style=env.model.getters.getCurrentStyle();if(style.verticalAlign){return style.verticalAlign;}
return DEFAULT_VERTICAL_ALIGN;}
function getWrappingMode(env){const style=env.model.getters.getCurrentStyle();if(style.wrapping){return style.wrapping;}
return DEFAULT_WRAPPING_MODE;}
function getHorizontalAlignmentIcon(env){const horizontalAlign=getHorizontalAlign(env);switch(horizontalAlign){case"right":return"o-spreadsheet-Icon.ALIGN_RIGHT";case"center":return"o-spreadsheet-Icon.ALIGN_CENTER";default:return"o-spreadsheet-Icon.ALIGN_LEFT";}}
function getVerticalAlignmentIcon(env){const verticalAlign=getVerticalAlign(env);switch(verticalAlign){case"top":return"o-spreadsheet-Icon.ALIGN_TOP";case"middle":return"o-spreadsheet-Icon.ALIGN_MIDDLE";default:return"o-spreadsheet-Icon.ALIGN_BOTTOM";}}
function getWrapModeIcon(env){const wrapMode=getWrappingMode(env);switch(wrapMode){case"wrap":return"o-spreadsheet-Icon.WRAPPING_WRAP";case"clip":return"o-spreadsheet-Icon.WRAPPING_CLIP";default:return"o-spreadsheet-Icon.WRAPPING_OVERFLOW";}}
var ACTION_FORMAT=Object.freeze({__proto__:null,clearFormat:clearFormat,decraseDecimalPlaces:decraseDecimalPlaces,fillColor:fillColor,formatAlignment:formatAlignment,formatAlignmentBottom:formatAlignmentBottom,formatAlignmentCenter:formatAlignmentCenter,formatAlignmentHorizontal:formatAlignmentHorizontal,formatAlignmentLeft:formatAlignmentLeft,formatAlignmentMiddle:formatAlignmentMiddle,formatAlignmentRight:formatAlignmentRight,formatAlignmentTop:formatAlignmentTop,formatAlignmentVertical:formatAlignmentVertical,formatBold:formatBold,formatCF:formatCF,formatCustomCurrency:formatCustomCurrency,formatFontSize:formatFontSize,formatItalic:formatItalic,formatNumberAutomatic:formatNumberAutomatic,formatNumberCurrency:formatNumberCurrency,formatNumberCurrencyRounded:formatNumberCurrencyRounded,formatNumberDate:formatNumberDate,formatNumberDateTime:formatNumberDateTime,formatNumberDayAndFullMonth:formatNumberDayAndFullMonth,formatNumberDayAndShortMonth:formatNumberDayAndShortMonth,formatNumberDuration:formatNumberDuration,formatNumberFullDateTime:formatNumberFullDateTime,formatNumberFullMonth:formatNumberFullMonth,formatNumberFullWeekDayAndMonth:formatNumberFullWeekDayAndMonth,formatNumberNumber:formatNumberNumber,formatNumberPercent:formatNumberPercent,formatNumberShortMonth:formatNumberShortMonth,formatNumberShortWeekDay:formatNumberShortWeekDay,formatNumberTime:formatNumberTime,formatPercent:formatPercent,formatStrikethrough:formatStrikethrough,formatUnderline:formatUnderline,formatWrapping:formatWrapping,formatWrappingClip:formatWrappingClip,formatWrappingIcon:formatWrappingIcon,formatWrappingOverflow:formatWrappingOverflow,formatWrappingWrap:formatWrappingWrap,incraseDecimalPlaces:incraseDecimalPlaces,moreFormats:moreFormats,textColor:textColor});const colMenuRegistry=new MenuItemRegistry();colMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("sort_columns",{...sortRange,name:(env)=>env.model.getters.getActiveCols().size>1?_t("Sort columns"):_t("Sort column"),sequence:50,separator:true,}).addChild("sort_ascending",["sort_columns"],{...sortAscending,sequence:10,}).addChild("sort_descending",["sort_columns"],{...sortDescending,sequence:20,}).add("add_column_before",{...colInsertColsBefore,sequence:70,}).add("add_column_after",{...colInsertColsAfter,sequence:80,}).add("delete_column",{...deleteCols,sequence:90,icon:"o-spreadsheet-Icon.DELETE",}).add("clear_column",{...clearCols,sequence:100,icon:"o-spreadsheet-Icon.CLEAR",}).add("hide_columns",{...hideCols,sequence:105,separator:true,}).add("unhide_columns",{...unhideCols,sequence:106,separator:true,}).add("conditional_formatting",{...formatCF,sequence:110,separator:true,}).add("group_columns",{sequence:120,...groupColumns,}).add("ungroup_columns",{sequence:130,...ungroupColumns,isVisible:(env)=>canUngroupHeaders(env,"COL"),});const numberFormatMenuRegistry=new MenuItemRegistry();numberFormatMenuRegistry.add("format_number_automatic",{...formatNumberAutomatic,sequence:10,separator:true,}).add("format_number_number",{...formatNumberNumber,sequence:20,}).add("format_number_percent",{...formatNumberPercent,sequence:30,separator:true,}).add("format_number_currency",{...formatNumberCurrency,sequence:40,}).add("format_number_currency_rounded",{...formatNumberCurrencyRounded,sequence:50,}).add("format_custom_currency",{...formatCustomCurrency,sequence:60,separator:true,}).add("format_number_date",{...formatNumberDate,sequence:70,}).add("format_number_time",{...formatNumberTime,sequence:80,}).add("format_number_date_time",{...formatNumberDateTime,sequence:90,}).add("format_number_duration",{...formatNumberDuration,sequence:100,separator:true,}).add("more_formats",{...moreFormats,sequence:110,});const formatNumberMenuItemSpec={name:_t("More formats"),icon:"o-spreadsheet-Icon.NUMBER_FORMATS",children:[()=>numberFormatMenuRegistry.getAll()],};const rowMenuRegistry=new MenuItemRegistry();rowMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("add_row_before",{...rowInsertRowBefore,sequence:50,}).add("add_row_after",{...rowInsertRowsAfter,sequence:60,}).add("delete_row",{...deleteRows,sequence:70,icon:"o-spreadsheet-Icon.DELETE",}).add("clear_row",{...clearRows,sequence:80,icon:"o-spreadsheet-Icon.CLEAR",}).add("hide_rows",{...hideRows,sequence:85,separator:true,}).add("unhide_rows",{...unhideRows,sequence:86,separator:true,}).add("conditional_formatting",{...formatCF,sequence:90,separator:true,}).add("group_rows",{sequence:100,...groupRows,}).add("ungroup_rows",{sequence:110,...ungroupRows,isVisible:(env)=>canUngroupHeaders(env,"ROW"),});function getSheetMenuRegistry(args){const sheetMenuRegistry=new MenuItemRegistry();sheetMenuRegistry.add("delete",{...deleteSheet,sequence:10,}).add("duplicate",{...duplicateSheet,sequence:20,}).add("rename",{...renameSheet(args),sequence:30,}).add("move_right",{...sheetMoveRight,sequence:40,}).add("move_left",{...sheetMoveLeft,sequence:50,}).add("hide_sheet",{...hideSheet,sequence:60,});return sheetMenuRegistry;}
const topbarMenuRegistry=new MenuItemRegistry();topbarMenuRegistry.add("file",{name:_t("File"),sequence:10,}).addChild("settings",["file"],{name:_t("Settings"),sequence:100,execute:(env)=>env.openSidePanel("Settings"),icon:"o-spreadsheet-Icon.COG",}).add("edit",{name:_t("Edit"),sequence:20,}).addChild("undo",["edit"],{...undo,sequence:10,}).addChild("redo",["edit"],{...redo,sequence:20,separator:true,}).addChild("copy",["edit"],{...copy,sequence:30,}).addChild("cut",["edit"],{...cut,sequence:40,}).addChild("paste",["edit"],{...paste,sequence:50,}).addChild("paste_special",["edit"],{...pasteSpecial,sequence:60,separator:true,}).addChild("paste_special_value",["edit","paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_special_format",["edit","paste_special"],{...pasteSpecialFormat,sequence:20,}).addChild("find_and_replace",["edit"],{...findAndReplace,sequence:65,separator:true,}).addChild("delete",["edit"],{name:_t("Delete"),icon:"o-spreadsheet-Icon.DELETE",sequence:70,}).addChild("edit_delete_cell_values",["edit","delete"],{...deleteValues,sequence:10,}).addChild("edit_delete_row",["edit","delete"],{...deleteRows,sequence:20,}).addChild("edit_delete_column",["edit","delete"],{...deleteCols,sequence:30,}).addChild("edit_delete_cell_shift_up",["edit","delete"],{...deleteCellShiftUp,sequence:40,}).addChild("edit_delete_cell_shift_left",["edit","delete"],{...deleteCellShiftLeft,sequence:50,}).addChild("edit_unhide_columns",["edit"],{...unhideAllCols,sequence:80,}).addChild("edit_unhide_rows",["edit"],{...unhideAllRows,sequence:80,}).add("view",{name:_t("View"),sequence:30,}).addChild("unfreeze_panes",["view"],{...unFreezePane,sequence:4,}).addChild("freeze_panes",["view"],{...freezePane,sequence:5,}).addChild("unfreeze_rows",["view","freeze_panes"],{...unFreezeRows,sequence:5,}).addChild("freeze_first_row",["view","freeze_panes"],{...freezeFirstRow,sequence:10,}).addChild("freeze_second_row",["view","freeze_panes"],{...freezeSecondRow,sequence:15,}).addChild("freeze_current_row",["view","freeze_panes"],{...freezeCurrentRow,sequence:20,separator:true,}).addChild("unfreeze_columns",["view","freeze_panes"],{...unFreezeCols,sequence:25,}).addChild("freeze_first_col",["view","freeze_panes"],{...freezeFirstCol,sequence:30,}).addChild("freeze_second_col",["view","freeze_panes"],{...freezeSecondCol,sequence:35,}).addChild("freeze_current_col",["view","freeze_panes"],{...freezeCurrentCol,sequence:40,}).addChild("group_headers",["view"],{name:_t("Group"),sequence:15,separator:true,icon:"o-spreadsheet-Icon.PLUS_IN_BOX",isVisible:IS_ONLY_ONE_RANGE,}).addChild("group_columns",["view","group_headers"],{...groupColumns,sequence:5,}).addChild("ungroup_columns",["view","group_headers"],{...ungroupColumns,isVisible:(env)=>canUngroupHeaders(env,"COL"),sequence:10,}).addChild("group_rows",["view","group_headers"],{...groupRows,sequence:15,}).addChild("ungroup_rows",["view","group_headers"],{...ungroupRows,isVisible:(env)=>canUngroupHeaders(env,"ROW"),sequence:20,}).addChild("view_gridlines",["view"],{...viewGridlines,sequence:15,}).addChild("view_formulas",["view"],{...viewFormulas,sequence:20,}).add("insert",{name:_t("Insert"),sequence:40,}).addChild("insert_row",["insert"],{...insertRow,sequence:10,}).addChild("insert_row_before",["insert","insert_row"],{...topBarInsertRowsBefore,sequence:10,}).addChild("insert_row_after",["insert","insert_row"],{...topBarInsertRowsAfter,sequence:20,}).addChild("insert_column",["insert"],{...insertCol,sequence:20,}).addChild("insert_column_before",["insert","insert_column"],{...topBarInsertColsBefore,sequence:10,}).addChild("insert_column_after",["insert","insert_column"],{...topBarInsertColsAfter,sequence:20,}).addChild("insert_cell",["insert"],{...insertCell,sequence:43,}).addChild("insert_cell_down",["insert","insert_cell"],{...insertCellShiftDown,name:_t("Shift down"),sequence:10,}).addChild("insert_cell_right",["insert","insert_cell"],{...insertCellShiftRight,name:_t("Shift right"),sequence:20,}).addChild("insert_sheet",["insert"],{...insertSheet,sequence:80,separator:true,}).addChild("insert_chart",["insert"],{...insertChart,sequence:50,}).addChild("insert_image",["insert"],{...insertImage,sequence:55,}).addChild("insert_function",["insert"],{...insertFunction,sequence:60,}).addChild("insert_function_sum",["insert","insert_function"],{...insertFunctionSum,sequence:0,}).addChild("insert_function_average",["insert","insert_function"],{...insertFunctionAverage,sequence:10,}).addChild("insert_function_count",["insert","insert_function"],{...insertFunctionCount,sequence:20,}).addChild("insert_function_max",["insert","insert_function"],{...insertFunctionMax,sequence:30,}).addChild("insert_function_min",["insert","insert_function"],{...insertFunctionMin,sequence:40,separator:true,}).addChild("categorie_function_all",["insert","insert_function"],{...categorieFunctionAll,sequence:50,}).addChild("categories_function_list",["insert","insert_function"],categoriesFunctionListMenuBuilder).addChild("insert_link",["insert"],{...insertLink,separator:true,sequence:70,}).add("format",{name:_t("Format"),sequence:50}).addChild("format_number",["format"],{...formatNumberMenuItemSpec,name:_t("Number"),sequence:10,separator:true,}).addChild("format_bold",["format"],{...formatBold,sequence:20,}).addChild("format_italic",["format"],{...formatItalic,sequence:30,}).addChild("format_underline",["format"],{...formatUnderline,sequence:40,}).addChild("format_strikethrough",["format"],{...formatStrikethrough,sequence:50,separator:true,}).addChild("format_font_size",["format"],{...formatFontSize,sequence:60,separator:true,}).addChild("format_alignment",["format"],{...formatAlignment,sequence:70,}).addChild("format_alignment_left",["format","format_alignment"],{...formatAlignmentLeft,sequence:10,}).addChild("format_alignment_center",["format","format_alignment"],{...formatAlignmentCenter,sequence:20,}).addChild("format_alignment_right",["format","format_alignment"],{...formatAlignmentRight,sequence:30,separator:true,}).addChild("format_alignment_top",["format","format_alignment"],{...formatAlignmentTop,sequence:40,}).addChild("format_alignment_middle",["format","format_alignment"],{...formatAlignmentMiddle,sequence:50,}).addChild("format_alignment_bottom",["format","format_alignment"],{...formatAlignmentBottom,sequence:60,separator:true,}).addChild("format_wrapping",["format"],{...formatWrappingIcon,sequence:80,separator:true,}).addChild("format_wrapping_overflow",["format","format_wrapping"],{...formatWrappingOverflow,sequence:10,}).addChild("format_wrapping_wrap",["format","format_wrapping"],{...formatWrappingWrap,sequence:20,}).addChild("format_wrapping_clip",["format","format_wrapping"],{...formatWrappingClip,sequence:30,}).addChild("format_cf",["format"],{...formatCF,sequence:90,separator:true,}).addChild("format_clearFormat",["format"],{...clearFormat,sequence:100,separator:true,}).add("data",{name:_t("Data"),sequence:60,}).addChild("sort_range",["data"],{...sortRange,sequence:10,separator:true,}).addChild("sort_ascending",["data","sort_range"],{...sortAscending,sequence:10,}).addChild("sort_descending",["data","sort_range"],{...sortDescending,sequence:20,}).addChild("data_cleanup",["data"],{...dataCleanup,sequence:15,}).addChild("remove_duplicates",["data","data_cleanup"],{...removeDuplicates,sequence:10,}).addChild("trim_whitespace",["data","data_cleanup"],{...trimWhitespace,sequence:20,}).addChild("split_to_columns",["data"],{...splitToColumns,sequence:20,}).addChild("data_validation",["data"],{name:_t("Data Validation"),execute:(env)=>{env.openSidePanel("DataValidation");},icon:"o-spreadsheet-Icon.DATA_VALIDATION",sequence:30,separator:true,}).addChild("add_remove_data_filter",["data"],{...addRemoveDataFilter,sequence:40,separator:true,});class OTRegistry extends Registry{addTransformation(executed,toTransforms,fn){for(let toTransform of toTransforms){if(!this.content[toTransform]){this.content[toTransform]=new Map();}
this.content[toTransform].set(executed,fn);}
return this;}
getTransformation(toTransform,executed){return this.content[toTransform]&&this.content[toTransform].get(executed);}}
const otRegistry=new OTRegistry();const arrowMap={ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",};function updateSelectionWithArrowKeys(ev,selection){const direction=arrowMap[ev.key];if(ev.shiftKey){selection.resizeAnchorZone(direction,isCtrlKey(ev)?"end":1);}
else{selection.moveAnchorCell(direction,isCtrlKey(ev)?"end":1);}}
const uuidGenerator$1=new UuidGenerator();css`
  .o-selection {
    .o-selection-input {
      padding: 2px 0px;

      input {
        padding: 4px 6px;
        border-radius: 4px;
        box-sizing: border-box;
      }
      input:focus {
        outline: none;
      }
      input.o-required,
      input.o-focused {
        border: 1px solid;
      }
      input.o-focused {
        border-width: 2px;
        padding: 3px 5px;
      }
      input.o-invalid {
        /* The background-color is similar to the bootstrap alert-danger class but, because of the commit 0358a76d,
         * which avoids being parasitized by the dark-mode in spreadsheet, we cannot use this class.
         * TODO: Replace with the bootstrap alert-danger class when we support dark mode
         */
        background-color: #ffdddd;
        border-width: 2px;
      }
      button.o-btn {
        color: #333;
      }
      button.o-btn-action {
        margin: 8px 1px;
        border-radius: 4px;
        border: 1px solid #dadce0;
        color: #188038;
        font-size: 14px;
        height: 25px;
      }
      .error-icon {
        right: 7px;
        top: 7px;
      }
    }
    /** Make the character a bit bigger
    compared to its neighbor INPUT box  */
    .o-remove-selection {
      font-size: calc(100% + 4px);
    }
  }
`;class SelectionInput extends owl.Component{static template="o-spreadsheet-SelectionInput";id=uuidGenerator$1.uuidv4();previousRanges=this.props.ranges()||[];originSheet=this.env.model.getters.getActiveSheetId();state=owl.useState({isMissing:false,mode:"select-range",});focusedInput=owl.useRef("focusedInput");get ranges(){const existingSelectionRanges=this.env.model.getters.getSelectionInput(this.id);const ranges=existingSelectionRanges.length?existingSelectionRanges:this.props.ranges().map((xc,id)=>({xc,id:id+1,isFocused:false,}));return ranges.map((range)=>({...range,isValidRange:range.xc===""||this.env.model.getters.isRangeValid(range.xc),}));}
get hasFocus(){return this.ranges.filter((i)=>i.isFocused).length>0;}
get canAddRange(){return!this.props.hasSingleRange;}
get isInvalid(){return this.props.isInvalid||this.state.isMissing;}
get isConfirmable(){return this.hasFocus&&this.ranges.every((range)=>range.isValidRange);}
get isResettable(){return this.previousRanges.join()!==this.ranges.map((r)=>r.xc).join();}
setup(){owl.useEffect(()=>this.focusedInput.el?.focus(),()=>[this.focusedInput.el]);owl.onMounted(()=>this.enableNewSelectionInput());owl.onWillUnmount(async()=>this.disableNewSelectionInput());owl.onPatched(()=>this.checkChange());}
enableNewSelectionInput(){this.env.model.dispatch("ENABLE_NEW_SELECTION_INPUT",{id:this.id,initialRanges:this.props.ranges(),hasSingleRange:this.props.hasSingleRange,});}
disableNewSelectionInput(){this.env.model.dispatch("DISABLE_SELECTION_INPUT",{id:this.id});}
checkChange(){const value=this.env.model.getters.getSelectionInputValue(this.id);const valid=!this.isInvalid&&this.ranges.every((range)=>range.isValidRange);if(valid&&this.previousRanges.join()!==value.join()){this.triggerChange();}}
getColor(range){const color=range.color||"#000";return"color: "+color+";";}
triggerChange(){const ranges=this.env.model.getters.getSelectionInputValue(this.id);this.props.onSelectionChanged?.(ranges);}
onKeydown(ev){if(ev.key==="F2"){ev.preventDefault();ev.stopPropagation();this.state.mode=this.state.mode==="select-range"?"text-edit":"select-range";}
else if(ev.key.startsWith("Arrow")){ev.stopPropagation();if(this.state.mode==="select-range"){ev.preventDefault();updateSelectionWithArrowKeys(ev,this.env.model.selection);}}
else if(ev.key==="Enter"){const target=ev.target;target.blur();this.confirm();}}
extractRanges(value){return this.props.hasSingleRange?value.split(",")[0]:value;}
focus(rangeId){this.state.isMissing=false;this.state.mode="select-range";this.env.model.dispatch("FOCUS_RANGE",{id:this.id,rangeId,});}
addEmptyInput(){this.env.model.dispatch("ADD_EMPTY_RANGE",{id:this.id});}
removeInput(rangeId){this.env.model.dispatch("REMOVE_RANGE",{id:this.id,rangeId});this.triggerChange();this.props.onSelectionConfirmed?.();}
onInputChanged(rangeId,ev){const target=ev.target;const value=this.extractRanges(target.value);this.env.model.dispatch("CHANGE_RANGE",{id:this.id,rangeId,value,});this.triggerChange();}
reset(){this.env.model.dispatch("ENABLE_NEW_SELECTION_INPUT",{id:this.id,initialRanges:this.previousRanges,hasSingleRange:this.props.hasSingleRange,});this.confirm();}
confirm(){let anyValidInput=false;const existingSelectionRanges=this.env.model.getters.getSelectionInput(this.id);const existingSelectionXcs=[];for(const range of existingSelectionRanges){if(range.xc===""){const result=this.env.model.dispatch("REMOVE_RANGE",{id:this.id,rangeId:range.id,});if(result.isSuccessful){continue;}}
existingSelectionXcs.push(range.xc);if(this.env.model.getters.isRangeValid(range.xc)){anyValidInput=true;}}
if(this.props.required&&!anyValidInput){this.state.isMissing=true;}
const activeSheetId=this.env.model.getters.getActiveSheetId();if(this.originSheet!==activeSheetId){this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:this.originSheet,});}
this.props.onSelectionChanged?.(existingSelectionXcs);this.props.onSelectionConfirmed?.();this.previousRanges=this.props.ranges();if(existingSelectionXcs.join()!==this.previousRanges.join()){this.enableNewSelectionInput();}
this.env.model.dispatch("UNFOCUS_SELECTION_INPUT");}}
SelectionInput.props={ranges:Function,hasSingleRange:{type:Boolean,optional:true},required:{type:Boolean,optional:true},isInvalid:{type:Boolean,optional:true},class:{type:String,optional:true},onSelectionChanged:{type:Function,optional:true},onSelectionConfirmed:{type:Function,optional:true},};css`
  .o-validation-error,
  .o-validation-warning {
    margin-top: 10px;

    .o-icon {
      margin-right: 5px;
      height: 1.2em;
      width: 1.2em;
    }
  }
`;class ValidationMessages extends owl.Component{static template="o-spreadsheet-ValidationMessages";get divClasses(){if(this.props.msgType==="warning"){return"o-validation-warning text-warning";}
return"o-validation-error text-danger";}}
ValidationMessages.props={messages:Array,msgType:String,};class LineBarPieConfigPanel extends owl.Component{static template="o-spreadsheet-LineBarPieConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({datasetDispatchResult:undefined,labelsDispatchResult:undefined,});dataSeriesRanges=[];labelRange;setup(){this.dataSeriesRanges=this.props.definition.dataSets;this.labelRange=this.props.definition.labelRange;}
get errorMessages(){const cancelledReasons=[...(this.state.datasetDispatchResult?.reasons||[]),...(this.state.labelsDispatchResult?.reasons||[]),];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isDatasetInvalid(){return!!this.state.datasetDispatchResult?.isCancelledBecause("InvalidDataSet");}
get isLabelInvalid(){return!!this.state.labelsDispatchResult?.isCancelledBecause("InvalidLabelRange");}
onUpdateDataSetsHaveTitle(ev){this.props.updateChart(this.props.figureId,{dataSetsHaveTitle:ev.target.checked,});}
onDataSeriesRangesChanged(ranges){this.dataSeriesRanges=ranges;this.state.datasetDispatchResult=this.props.canUpdateChart(this.props.figureId,{dataSets:this.dataSeriesRanges,});}
onDataSeriesConfirmed(){this.dataSeriesRanges=spreadRange(this.env.model.getters,this.dataSeriesRanges);this.state.datasetDispatchResult=this.props.updateChart(this.props.figureId,{dataSets:this.dataSeriesRanges,});}
getDataSeriesRanges(){return this.dataSeriesRanges;}
onLabelRangeChanged(ranges){this.labelRange=ranges[0];this.state.labelsDispatchResult=this.props.canUpdateChart(this.props.figureId,{labelRange:this.labelRange,});}
onLabelRangeConfirmed(){this.state.labelsDispatchResult=this.props.updateChart(this.props.figureId,{labelRange:this.labelRange,});}
getLabelRange(){return this.labelRange||"";}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}
calculateHeaderPosition(){if(this.isDatasetInvalid||this.isLabelInvalid){return undefined;}
const getters=this.env.model.getters;const sheetId=getters.getActiveSheetId();const labelRange=createRange(getters,sheetId,this.labelRange);const dataSets=createDataSets(getters,this.dataSeriesRanges,sheetId,this.props.definition.dataSetsHaveTitle);if(dataSets.length){return dataSets[0].dataRange.zone.top+1;}
else if(labelRange){return labelRange.zone.top+1;}
return undefined;}}
LineBarPieConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class BarConfigPanel extends LineBarPieConfigPanel{static template="o-spreadsheet-BarConfigPanel";onUpdateStacked(ev){this.props.updateChart(this.props.figureId,{stacked:ev.target.checked,});}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}}
function startDnd(onMouseMove,onMouseUp,onMouseDown=()=>{}){const _onMouseUp=(ev)=>{onMouseUp(ev);window.removeEventListener("mousedown",onMouseDown);window.removeEventListener("mouseup",_onMouseUp);window.removeEventListener("dragstart",_onDragStart);window.removeEventListener("mousemove",onMouseMove);window.removeEventListener("wheel",onMouseMove);};function _onDragStart(ev){ev.preventDefault();}
window.addEventListener("mousedown",onMouseDown);window.addEventListener("mouseup",_onMouseUp);window.addEventListener("dragstart",_onDragStart);window.addEventListener("mousemove",onMouseMove);window.addEventListener("wheel",onMouseMove,{passive:false});}
function dragAndDropBeyondTheViewport(env,cbMouseMove,cbMouseUp,only=false){let timeOutId=null;let currentEv;let previousEv;let startingEv;let startingX;let startingY;const getters=env.model.getters;const sheetId=getters.getActiveSheetId();const position=gridOverlayPosition();let colIndex;let rowIndex;const onMouseDown=(ev)=>{previousEv=ev;startingEv=ev;startingX=startingEv.clientX-position.left;startingY=startingEv.clientY-position.top;};const onMouseMove=(ev)=>{currentEv=ev;if(timeOutId){return;}
const{x:offsetCorrectionX,y:offsetCorrectionY}=getters.getMainViewportCoordinates();let{top,left,bottom,right}=getters.getActiveMainViewport();let{scrollX,scrollY}=getters.getActiveSheetDOMScrollInfo();const{xSplit,ySplit}=getters.getPaneDivisions(sheetId);let canEdgeScroll=false;let timeoutDelay=MAX_DELAY;const x=currentEv.clientX-position.left;colIndex=getters.getColIndex(x);if(only!=="vertical"){const previousX=previousEv.clientX-position.left;const edgeScrollInfoX=getters.getEdgeScrollCol(x,previousX,startingX);if(edgeScrollInfoX.canEdgeScroll){canEdgeScroll=true;timeoutDelay=Math.min(timeoutDelay,edgeScrollInfoX.delay);let newTarget;switch(edgeScrollInfoX.direction){case"reset":colIndex=xSplit;newTarget=xSplit;break;case 1:colIndex=right;newTarget=left+1;break;case-1:colIndex=left-1;while(env.model.getters.isColHidden(sheetId,colIndex)){colIndex--;}
newTarget=colIndex;break;}
scrollX=getters.getColDimensions(sheetId,newTarget).start-offsetCorrectionX;}}
const y=currentEv.clientY-position.top;rowIndex=getters.getRowIndex(y);if(only!=="horizontal"){const previousY=previousEv.clientY-position.top;const edgeScrollInfoY=getters.getEdgeScrollRow(y,previousY,startingY);if(edgeScrollInfoY.canEdgeScroll){canEdgeScroll=true;timeoutDelay=Math.min(timeoutDelay,edgeScrollInfoY.delay);let newTarget;switch(edgeScrollInfoY.direction){case"reset":rowIndex=ySplit;newTarget=ySplit;break;case 1:rowIndex=bottom;newTarget=top+edgeScrollInfoY.direction;break;case-1:rowIndex=top-1;while(env.model.getters.isRowHidden(sheetId,rowIndex)){rowIndex--;}
newTarget=rowIndex;break;}
scrollY=env.model.getters.getRowDimensions(sheetId,newTarget).start-offsetCorrectionY;}}
if(!canEdgeScroll){if(rowIndex===-1){rowIndex=y<0?0:getters.getNumberRows(sheetId)-1;}
if(colIndex===-1&&x<0){colIndex=x<0?0:getters.getNumberCols(sheetId)-1;}}
cbMouseMove(colIndex,rowIndex,currentEv);if(canEdgeScroll){env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:scrollY});timeOutId=setTimeout(()=>{timeOutId=null;onMouseMove(currentEv);},Math.round(timeoutDelay));}
previousEv=currentEv;};const onMouseUp=()=>{clearTimeout(timeOutId);cbMouseUp();};startDnd(onMouseMove,onMouseUp,onMouseDown);}
const LINE_VERTICAL_PADDING=1;const PICKER_PADDING=8;const ITEM_BORDER_WIDTH=1;const ITEM_EDGE_LENGTH=18;const ITEMS_PER_LINE=10;const MAGNIFIER_EDGE=16;const ITEM_GAP=2;const CONTENT_WIDTH=ITEMS_PER_LINE*(ITEM_EDGE_LENGTH+2*ITEM_BORDER_WIDTH)+(ITEMS_PER_LINE-1)*ITEM_GAP;const INNER_GRADIENT_WIDTH=CONTENT_WIDTH-2*ITEM_BORDER_WIDTH;const INNER_GRADIENT_HEIGHT=CONTENT_WIDTH-30-2*ITEM_BORDER_WIDTH;const CONTAINER_WIDTH=CONTENT_WIDTH+2*PICKER_PADDING;css`
  .o-color-picker {
    padding: ${PICKER_PADDING}px 0;
    /** FIXME: this is useless, overiden by the popover container */
    box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
    background-color: white;
    line-height: 1.2;
    overflow-y: auto;
    overflow-x: hidden;
    width: ${CONTAINER_WIDTH}px;

    .o-color-picker-section-name {
      margin: 0px ${ITEM_BORDER_WIDTH}px;
      padding: 4px ${PICKER_PADDING}px;
    }
    .colors-grid {
      display: grid;
      padding: ${LINE_VERTICAL_PADDING}px ${PICKER_PADDING}px;
      grid-template-columns: repeat(${ITEMS_PER_LINE}, 1fr);
      grid-gap: ${ITEM_GAP}px;
    }
    .o-color-picker-toggler-button {
      display: flex;
      .o-color-picker-toggler-sign {
        display: flex;
        margin: auto auto;
        width: 55%;
        height: 55%;
        .o-icon {
          width: 100%;
          height: 100%;
        }
      }
    }
    .o-color-picker-line-item {
      width: ${ITEM_EDGE_LENGTH}px;
      height: ${ITEM_EDGE_LENGTH}px;
      margin: 0px;
      border-radius: 50px;
      border: ${ITEM_BORDER_WIDTH}px solid #666666;
      padding: 0px;
      font-size: 16px;
      background: white;
      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
        outline: 1px solid gray;
        cursor: pointer;
      }
    }
    .o-buttons {
      padding: ${PICKER_PADDING}px;
      display: flex;
      .o-cancel {
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        width: 100%;
        padding: 5px;
        font-size: 14px;
        background: white;
        border-radius: 4px;
        box-sizing: border-box;
        &:hover:enabled {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }
    }
    .o-add-button {
      border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
      padding: 4px;
      background: white;
      border-radius: 4px;
      &:hover:enabled {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .o-separator {
      border-bottom: ${MENU_SEPARATOR_BORDER_WIDTH}px solid ${SEPARATOR_COLOR};
      margin-top: ${MENU_SEPARATOR_PADDING}px;
      margin-bottom: ${MENU_SEPARATOR_PADDING}px;
    }

    .o-custom-selector {
      padding: ${PICKER_PADDING + 2}px ${PICKER_PADDING}px;
      position: relative;
      .o-gradient {
        margin-bottom: ${MAGNIFIER_EDGE / 2}px;
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        box-sizing: border-box;
        width: ${INNER_GRADIENT_WIDTH + 2 * ITEM_BORDER_WIDTH}px;
        height: ${INNER_GRADIENT_HEIGHT + 2 * ITEM_BORDER_WIDTH}px;
        position: relative;
      }

      .magnifier {
        height: ${MAGNIFIER_EDGE}px;
        width: ${MAGNIFIER_EDGE}px;
        box-sizing: border-box;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0px 0px 3px #c0c0c0;
        position: absolute;
        z-index: 2;
      }
      .saturation {
        background: linear-gradient(to right, #fff 0%, transparent 100%);
      }
      .lightness {
        background: linear-gradient(to top, #000 0%, transparent 100%);
      }
      .o-hue-picker {
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        box-sizing: border-box;
        width: 100%;
        height: 12px;
        border-radius: 4px;
        background: linear-gradient(
          to right,
          hsl(0 100% 50%) 0%,
          hsl(0.2turn 100% 50%) 20%,
          hsl(0.3turn 100% 50%) 30%,
          hsl(0.4turn 100% 50%) 40%,
          hsl(0.5turn 100% 50%) 50%,
          hsl(0.6turn 100% 50%) 60%,
          hsl(0.7turn 100% 50%) 70%,
          hsl(0.8turn 100% 50%) 80%,
          hsl(0.9turn 100% 50%) 90%,
          hsl(1turn 100% 50%) 100%
        );
        position: relative;
        cursor: crosshair;
      }
      .o-hue-slider {
        margin-top: -3px;
      }
      .o-custom-input-preview {
        padding: 2px 0px;
        display: flex;
        input {
          box-sizing: border-box;
          width: 50%;
          border-radius: 4px;
          padding: 4px 23px 4px 10px;
          height: 24px;
          border: 1px solid #c0c0c0;
          margin-right: 2px;
        }
        .o-wrong-color {
          /** FIXME bootstrap class instead? */
          outline-color: red;
          border-color: red;
          &:focus {
            outline-style: solid;
            outline-width: 1px;
          }
        }
      }
      .o-custom-input-buttons {
        padding: 2px 0px;
        display: flex;
        justify-content: end;
      }
      .o-color-preview {
        border: 1px solid #c0c0c0;
        border-radius: 4px;
        width: 50%;
      }
    }
  }
`;class ColorPicker extends owl.Component{static template="o-spreadsheet-ColorPicker";static defaultProps={currentColor:""};static components={Popover};COLORS=COLOR_PICKER_DEFAULTS;state=owl.useState({showGradient:false,currentHslaColor:isColorValid(this.props.currentColor)?{...hexToHSLA(this.props.currentColor),a:1}:{h:0,s:100,l:100,a:1},customHexColor:isColorValid(this.props.currentColor)?toHex(this.props.currentColor):"",});get colorPickerStyle(){if(this.props.maxHeight!==undefined&&this.props.maxHeight<=0){return cssPropertiesToCss({display:"none"});}
return"";}
get popoverProps(){return{anchorRect:this.props.anchorRect,maxHeight:this.props.maxHeight,positioning:"BottomLeft",verticalOffset:0,};}
get gradientHueStyle(){const hue=this.state.currentHslaColor?.h||0;return cssPropertiesToCss({background:`hsl(${hue} 100% 50%)`,});}
get sliderStyle(){const hue=this.state.currentHslaColor?.h||0;const delta=Math.round((hue/360)*INNER_GRADIENT_WIDTH);const left=clip(delta,1,INNER_GRADIENT_WIDTH)-ICON_EDGE_LENGTH/2;return cssPropertiesToCss({"margin-left":`${left}px`,});}
get pointerStyle(){const{s,l}=this.state.currentHslaColor||{s:0,l:0};const left=Math.round(INNER_GRADIENT_WIDTH*clip(s/100,0,1));const top=Math.round(INNER_GRADIENT_HEIGHT*clip(1-(2*l)/(200-s),0,1));return cssPropertiesToCss({left:`${-MAGNIFIER_EDGE / 2 + left}px`,top:`${-MAGNIFIER_EDGE / 2 + top}px`,background:hslaToHex(this.state.currentHslaColor),});}
get colorPreviewStyle(){return cssPropertiesToCss({"background-color":hslaToHex(this.state.currentHslaColor),});}
get checkmarkColor(){return chartFontColor(this.props.currentColor);}
get isHexColorInputValid(){return!this.state.customHexColor||isColorValid(this.state.customHexColor);}
setCustomGradient({x,y}){const offsetX=clip(x,0,INNER_GRADIENT_WIDTH);const offsetY=clip(y,0,INNER_GRADIENT_HEIGHT);const deltaX=offsetX/INNER_GRADIENT_WIDTH;const deltaY=offsetY/INNER_GRADIENT_HEIGHT;const s=100*deltaX;const l=100*(1-deltaY)*(1-0.5*deltaX);this.updateColor({s,l});}
setCustomHue(x){const h=Math.round(clip((360*x)/INNER_GRADIENT_WIDTH,0,359));this.updateColor({h});}
updateColor(newHsl){this.state.currentHslaColor={...this.state.currentHslaColor,...newHsl};this.state.customHexColor=hslaToHex(this.state.currentHslaColor);}
onColorClick(color){if(color){this.props.onColorPicked(toHex(color));}}
resetColor(){this.props.onColorPicked("");}
toggleColorPicker(){this.state.showGradient=!this.state.showGradient;}
dragGradientPointer(ev){const initialGradientCoordinates={x:ev.offsetX,y:ev.offsetY};this.setCustomGradient(initialGradientCoordinates);const initialMousePosition={x:ev.clientX,y:ev.clientY};const onMouseMove=(ev)=>{const currentMousePosition={x:ev.clientX,y:ev.clientY};const deltaX=currentMousePosition.x-initialMousePosition.x;const deltaY=currentMousePosition.y-initialMousePosition.y;const currentGradientCoordinates={x:initialGradientCoordinates.x+deltaX,y:initialGradientCoordinates.y+deltaY,};this.setCustomGradient(currentGradientCoordinates);};startDnd(onMouseMove,()=>{});}
dragHuePointer(ev){const initialX=ev.offsetX;const initialMouseX=ev.clientX;this.setCustomHue(initialX);const onMouseMove=(ev)=>{const currentMouseX=ev.clientX;const deltaX=currentMouseX-initialMouseX;const x=initialX+deltaX;this.setCustomHue(x);};startDnd(onMouseMove,()=>{});}
setHexColor(ev){const val=ev.target.value.slice(0,7);this.state.customHexColor=val;if(!isColorValid(val));else{this.state.currentHslaColor={...hexToHSLA(val),a:1};}}
addCustomColor(ev){if(!isHSLAValid(this.state.currentHslaColor)||!isColorValid(this.state.customHexColor)){return;}
this.props.onColorPicked(toHex(this.state.customHexColor));}
isSameColor(color1,color2){return isSameColor(color1,color2);}}
ColorPicker.props={onColorPicked:Function,currentColor:{type:String,optional:true},maxHeight:{type:Number,optional:true},anchorRect:Object,};css`
  .o-color-picker-widget {
    display: flex;
    position: relative;
    align-items: center;

    .o-color-picker-button-style {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 2px;
      padding: 3px;
      border-radius: 2px;
      cursor: pointer;
      &:not([disabled]):hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-color-picker-button {
      height: 30px;
      > span {
        border-bottom: 4px solid;
        height: 16px;
        margin-top: 2px;
      }

      &[disabled] {
        pointer-events: none;
        opacity: 0.3;
      }
    }
  }
`;class ColorPickerWidget extends owl.Component{static template="o-spreadsheet-ColorPickerWidget";static components={ColorPicker};colorPickerButtonRef=owl.useRef("colorPickerButton");get iconStyle(){return this.props.currentColor?`border-color: ${this.props.currentColor}`:"border-bottom-style: hidden";}
get colorPickerAnchorRect(){const button=this.colorPickerButtonRef.el;const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}}
ColorPickerWidget.props={currentColor:{type:String,optional:true},toggleColorPicker:Function,showColorPicker:Boolean,onColorPicked:Function,icon:String,title:{type:String,optional:true},disabled:{type:Boolean,optional:true},dropdownMaxHeight:{type:Number,optional:true},class:{type:String,optional:true},};class LineBarPieDesignPanel extends owl.Component{static template="o-spreadsheet-LineBarPieDesignPanel";static components={ColorPickerWidget};state=owl.useState({title:"",fillColorTool:false,});onClick(ev){this.state.fillColorTool=false;}
setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.onClick);}
toggleColorPicker(){this.state.fillColorTool=!this.state.fillColorTool;}
updateBackgroundColor(color){this.props.updateChart(this.props.figureId,{background:color,});}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
updateSelect(attr,ev){this.props.updateChart(this.props.figureId,{[attr]:ev.target.value,});}}
LineBarPieDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class BarChartDesignPanel extends LineBarPieDesignPanel{static template="o-spreadsheet-BarChartDesignPanel";}
class GaugeChartConfigPanel extends owl.Component{static template="o-spreadsheet-GaugeChartConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({dataRangeDispatchResult:undefined,});dataRange=this.props.definition.dataRange;get configurationErrorMessages(){const cancelledReasons=[...(this.state.dataRangeDispatchResult?.reasons||[])];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isDataRangeInvalid(){return!!this.state.dataRangeDispatchResult?.isCancelledBecause("InvalidGaugeDataRange");}
onDataRangeChanged(ranges){this.dataRange=ranges[0];this.state.dataRangeDispatchResult=this.props.canUpdateChart(this.props.figureId,{dataRange:this.dataRange,});}
updateDataRange(){this.state.dataRangeDispatchResult=this.props.updateChart(this.props.figureId,{dataRange:this.dataRange,});}
getDataRange(){return this.dataRange||"";}}
GaugeChartConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};css`
  .o-gauge-color-set {
    table {
      table-layout: fixed;
      margin-top: 2%;
      display: table;
      text-align: left;
      font-size: 12px;
      line-height: 18px;
      width: 100%;
    }
    th.o-gauge-color-set-colorPicker {
      width: 8%;
    }
    th.o-gauge-color-set-text {
      width: 40%;
    }
    th.o-gauge-color-set-value {
      width: 22%;
    }
    th.o-gauge-color-set-type {
      width: 30%;
    }
    input,
    select {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
  }
`;class GaugeChartDesignPanel extends owl.Component{static template="o-spreadsheet-GaugeChartDesignPanel";static components={ColorPickerWidget,ValidationMessages};state=owl.useState({title:"",openedMenu:undefined,sectionRuleDispatchResult:undefined,sectionRule:deepCopy(this.props.definition.sectionRule),});setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.closeMenus);}
get designErrorMessages(){const cancelledReasons=[...(this.state.sectionRuleDispatchResult?.reasons||[])];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
updateBackgroundColor(color){this.state.openedMenu=undefined;this.props.updateChart(this.props.figureId,{background:color,});}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
isRangeMinInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("EmptyGaugeRangeMin")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinBiggerThanRangeMax"));}
isRangeMaxInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("EmptyGaugeRangeMax")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMaxNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinBiggerThanRangeMax"));}
get isLowerInflectionPointInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerInflectionPointNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerBiggerThanUpper"));}
get isUpperInflectionPointInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeUpperInflectionPointNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerBiggerThanUpper"));}
updateSectionColor(target,color){const sectionRule=deepCopy(this.state.sectionRule);sectionRule.colors[target]=color;this.updateSectionRule(sectionRule);this.closeMenus();}
toggleMenu(menu){const isSelected=this.state.openedMenu===menu;this.closeMenus();if(!isSelected){this.state.openedMenu=menu;}}
updateSectionRule(sectionRule){this.state.sectionRuleDispatchResult=this.props.updateChart(this.props.figureId,{sectionRule,});}
canUpdateSectionRule(sectionRule){this.state.sectionRuleDispatchResult=this.props.canUpdateChart(this.props.figureId,{sectionRule,});}
closeMenus(){this.state.openedMenu=undefined;}}
GaugeChartDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class LineConfigPanel extends LineBarPieConfigPanel{static template="o-spreadsheet-LineConfigPanel";get canTreatLabelsAsText(){const chart=this.env.model.getters.getChart(this.props.figureId);if(chart&&chart instanceof LineChart){return canChartParseLabels(chart.labelRange,this.env.model.getters);}
return false;}
onUpdateLabelsAsText(ev){this.props.updateChart(this.props.figureId,{labelsAsText:ev.target.checked,});}
onUpdateStacked(ev){this.props.updateChart(this.props.figureId,{stacked:ev.target.checked,});}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}
onUpdateCumulative(ev){this.props.updateChart(this.props.figureId,{cumulative:ev.target.checked,});}}
class LineChartDesignPanel extends LineBarPieDesignPanel{static template="o-spreadsheet-LineChartDesignPanel";}
class ScorecardChartConfigPanel extends owl.Component{static template="o-spreadsheet-ScorecardChartConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({keyValueDispatchResult:undefined,baselineDispatchResult:undefined,});keyValue=this.props.definition.keyValue;baseline=this.props.definition.baseline;get errorMessages(){const cancelledReasons=[...(this.state.keyValueDispatchResult?.reasons||[]),...(this.state.baselineDispatchResult?.reasons||[]),];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isKeyValueInvalid(){return!!this.state.keyValueDispatchResult?.isCancelledBecause("InvalidScorecardKeyValue");}
get isBaselineInvalid(){return!!this.state.keyValueDispatchResult?.isCancelledBecause("InvalidScorecardBaseline");}
onKeyValueRangeChanged(ranges){this.keyValue=ranges[0];this.state.keyValueDispatchResult=this.props.canUpdateChart(this.props.figureId,{keyValue:this.keyValue,});}
updateKeyValueRange(){this.state.keyValueDispatchResult=this.props.updateChart(this.props.figureId,{keyValue:this.keyValue,});}
getKeyValueRange(){return this.keyValue||"";}
onBaselineRangeChanged(ranges){this.baseline=ranges[0];this.state.baselineDispatchResult=this.props.canUpdateChart(this.props.figureId,{baseline:this.baseline,});}
updateBaselineRange(){this.state.baselineDispatchResult=this.props.updateChart(this.props.figureId,{baseline:this.baseline,});}
getBaselineRange(){return this.baseline||"";}
updateBaselineMode(ev){this.props.updateChart(this.props.figureId,{baselineMode:ev.target.value});}}
ScorecardChartConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class ScorecardChartDesignPanel extends owl.Component{static template="o-spreadsheet-ScorecardChartDesignPanel";static components={ColorPickerWidget};state=owl.useState({title:"",openedColorPicker:undefined,});setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.closeMenus);}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
translate(term){return _t(term);}
updateBaselineDescr(ev){this.props.updateChart(this.props.figureId,{baselineDescr:ev.target.value});}
toggleColorPicker(colorPickerId){if(this.state.openedColorPicker===colorPickerId){this.state.openedColorPicker=undefined;}
else{this.state.openedColorPicker=colorPickerId;}}
setColor(color,colorPickerId){switch(colorPickerId){case"backgroundColor":this.props.updateChart(this.props.figureId,{background:color});break;case"baselineColorDown":this.props.updateChart(this.props.figureId,{baselineColorDown:color});break;case"baselineColorUp":this.props.updateChart(this.props.figureId,{baselineColorUp:color});break;}
this.closeMenus();}
closeMenus(){this.state.openedColorPicker=undefined;}}
ScorecardChartDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};const chartSidePanelComponentRegistry=new Registry();chartSidePanelComponentRegistry.add("line",{configuration:LineConfigPanel,design:LineChartDesignPanel,}).add("bar",{configuration:BarConfigPanel,design:BarChartDesignPanel,}).add("pie",{configuration:LineBarPieConfigPanel,design:LineBarPieDesignPanel,}).add("gauge",{configuration:GaugeChartConfigPanel,design:GaugeChartDesignPanel,}).add("scorecard",{configuration:ScorecardChartConfigPanel,design:ScorecardChartDesignPanel,});css`
  .o-chart {
    .o-panel {
      display: flex;
      .o-panel-element {
        flex: 1 0 auto;
        padding: 8px 0px;
        text-align: center;
        cursor: pointer;
        border-right: 1px solid darkgray;
        &.inactive {
          background-color: ${BACKGROUND_HEADER_COLOR};
          border-bottom: 1px solid darkgray;
        }
        .fa {
          margin-right: 4px;
        }
      }
      .o-panel-element:last-child {
        border-right: none;
      }
    }
  }
`;class ChartPanel extends owl.Component{static template="o-spreadsheet-ChartPanel";state;get figureId(){return this.state.figureId;}
setup(){const selectedFigureId=this.env.model.getters.getSelectedFigureId();if(!selectedFigureId){this.props.onCloseSidePanel();return;}
this.state=owl.useState({panel:"configuration",figureId:selectedFigureId,});owl.onWillUpdateProps(()=>{const selectedFigureId=this.env.model.getters.getSelectedFigureId();if(selectedFigureId&&selectedFigureId!==this.state.figureId){this.state.figureId=selectedFigureId;}
if(!this.env.model.getters.isChartDefined(this.figureId)){this.props.onCloseSidePanel();return;}});}
updateChart(figureId,updateDefinition){if(figureId!==this.figureId){return;}
const definition={...this.getChartDefinition(),...updateDefinition,};return this.env.model.dispatch("UPDATE_CHART",{definition,id:figureId,sheetId:this.env.model.getters.getFigureSheetId(figureId),});}
canUpdateChart(figureId,updateDefinition){if(figureId!==this.figureId||!this.env.model.getters.isChartDefined(figureId)){return;}
const definition={...this.getChartDefinition(),...updateDefinition,};return this.env.model.canDispatch("UPDATE_CHART",{definition,id:figureId,sheetId:this.env.model.getters.getFigureSheetId(figureId),});}
onTypeChange(type){const context=this.env.model.getters.getContextCreationChart(this.figureId);if(!context){throw new Error("Chart not defined.");}
const definition=getChartDefinitionFromContextCreation(context,type);this.env.model.dispatch("UPDATE_CHART",{definition,id:this.figureId,sheetId:this.env.model.getters.getFigureSheetId(this.figureId),});}
get chartPanel(){const type=this.env.model.getters.getChartType(this.figureId);if(!type){throw new Error("Chart not defined.");}
const chartPanel=chartSidePanelComponentRegistry.get(type);if(!chartPanel){throw new Error(`Component is not defined for type ${type}`);}
return chartPanel;}
getChartDefinition(figureId=this.figureId){return this.env.model.getters.getChartDefinition(figureId);}
get chartTypes(){return getChartTypes();}
activatePanel(panel){this.state.panel=panel;}}
ChartPanel.props={onCloseSidePanel:Function,};css`
  .o-spreadsheet {
    .o-icon {
      .small-text {
        font: bold 9px sans-serif;
      }
      .heavy-text {
        font: bold 16px sans-serif;
      }
    }
  }
`;const ARROW_DOWN='<svg class="o-cf-icon arrow-down" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#DC6965" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"></path></svg>';const ARROW_UP='<svg class="o-cf-icon arrow-up" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#00A04A" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>';const ARROW_RIGHT='<svg class="o-cf-icon arrow-right" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#F0AD4E" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>';const SMILE='<svg class="o-cf-icon smile" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#00A04A" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm4 72.6c-20.8 25-51.5 39.4-84 39.4s-63.2-14.3-84-39.4c-8.5-10.2-23.7-11.5-33.8-3.1-10.2 8.5-11.5 23.6-3.1 33.8 30 36 74.1 56.6 120.9 56.6s90.9-20.6 120.9-56.6c8.5-10.2 7.1-25.3-3.1-33.8-10.1-8.4-25.3-7.1-33.8 3.1z"></path></svg>';const MEH='<svg class="o-cf-icon meh" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#F0AD4E" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm8 144H160c-13.2 0-24 10.8-24 24s10.8 24 24 24h176c13.2 0 24-10.8 24-24s-10.8-24-24-24z"></path></svg>';const FROWN='<svg class="o-cf-icon frown" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#DC6965" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm-80 128c-40.2 0-78 17.7-103.8 48.6-8.5 10.2-7.1 25.3 3.1 33.8 10.2 8.4 25.3 7.1 33.8-3.1 16.6-19.9 41-31.4 66.9-31.4s50.3 11.4 66.9 31.4c8.1 9.7 23.1 11.9 33.8 3.1 10.2-8.5 11.5-23.6 3.1-33.8C326 321.7 288.2 304 248 304z"></path></svg>';const GREEN_DOT='<svg class="o-cf-icon green-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#00A04A" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';const YELLOW_DOT='<svg class="o-cf-icon yellow-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#F0AD4E" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';const RED_DOT='<svg class="o-cf-icon red-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#DC6965" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';function loadIconImage(svg){svg=`<svg xmlns="http://www.w3.org/2000/svg" ${svg.slice(4)}`;const image=new Image();image.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(svg);return image;}
const ICONS={arrowGood:{template:"ARROW_UP",img:loadIconImage(ARROW_UP),},arrowNeutral:{template:"ARROW_RIGHT",img:loadIconImage(ARROW_RIGHT),},arrowBad:{template:"ARROW_DOWN",img:loadIconImage(ARROW_DOWN),},smileyGood:{template:"SMILE",img:loadIconImage(SMILE),},smileyNeutral:{template:"MEH",img:loadIconImage(MEH),},smileyBad:{template:"FROWN",img:loadIconImage(FROWN),},dotGood:{template:"GREEN_DOT",img:loadIconImage(GREEN_DOT),},dotNeutral:{template:"YELLOW_DOT",img:loadIconImage(YELLOW_DOT),},dotBad:{template:"RED_DOT",img:loadIconImage(RED_DOT),},};const ICON_SETS={arrows:{good:"arrowGood",neutral:"arrowNeutral",bad:"arrowBad",},smiley:{good:"smileyGood",neutral:"smileyNeutral",bad:"smileyBad",},dots:{good:"dotGood",neutral:"dotNeutral",bad:"dotBad",},};css`
  .o-icon-picker {
    position: absolute;
    z-index: ${ComponentsImportance.IconPicker};
    box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
    background-color: white;
    padding: 2px 1px;
  }
  .o-cf-icon-line {
    display: flex;
    padding: 3px 6px;
  }
  .o-icon-picker-item {
    margin: 0px 2px;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
      outline: 1px solid gray;
    }
  }
`;class IconPicker extends owl.Component{static template="o-spreadsheet-IconPicker";icons=ICONS;iconSets=ICON_SETS;onIconClick(icon){if(icon){this.props.onIconPicked(icon);}}}
IconPicker.props={onIconPicked:Function,};function useDragAndDropListItems(){let dndHelper;const previousCursor=document.body.style.cursor;let cleanupFns=[];const cleanUp=()=>{dndHelper=undefined;document.body.style.cursor=previousCursor;cleanupFns.forEach((fn)=>fn());cleanupFns=[];};const start=(direction,args)=>{const onChange=()=>{document.body.style.cursor="move";if(!dndHelper)
return;Object.assign(state.itemsStyle,dndHelper.getItemStyles());args.onChange?.();};state.cancel=()=>{state.draggedItemId=undefined;state.itemsStyle={};document.body.style.cursor=previousCursor;args.onCancel?.();};const onDragEnd=(itemId,indexAtEnd)=>{state.draggedItemId=undefined;state.itemsStyle={};document.body.style.cursor=previousCursor;args.onDragEnd?.(itemId,indexAtEnd);cleanUp();};document.body.style.cursor="move";state.draggedItemId=args.draggedItemId;const container=direction==="horizontal"?new HorizontalContainer(args.containerEl):new VerticalContainer(args.containerEl);dndHelper=new DOMDndHelper({...args,container,onChange,onDragEnd,onCancel:state.cancel,});startDnd(dndHelper.onMouseMove.bind(dndHelper),dndHelper.onMouseUp.bind(dndHelper));const onScroll=dndHelper.onScroll.bind(dndHelper);args.containerEl.addEventListener("scroll",onScroll);cleanupFns.push(()=>args.containerEl.removeEventListener("scroll",onScroll));cleanupFns.push(dndHelper.destroy.bind(dndHelper));};owl.onWillUnmount(()=>{cleanUp();});const state=owl.useState({itemsStyle:{},draggedItemId:undefined,start,cancel:()=>{},});return state;}
class DOMDndHelper{draggedItemId;items;container;initialMousePosition;currentMousePosition;initialScroll;minPosition;maxPosition;edgeScrollIntervalId;onChange;onCancel;onDragEnd;deadZone;constructor(args){this.items=args.items.map((item)=>({...item,positionAtStart:item.position}));this.draggedItemId=args.draggedItemId;this.container=args.container;this.onChange=args.onChange;this.onCancel=args.onCancel;this.onDragEnd=args.onDragEnd;this.initialMousePosition=args.initialMousePosition;this.currentMousePosition=args.initialMousePosition;this.initialScroll=this.container.scroll;this.minPosition=this.items[0].position;this.maxPosition=this.items[this.items.length-1].position+this.items[this.items.length-1].size;}
getItemStyles(){const styles={};for(let item of this.items){styles[item.id]=this.getItemStyle(item.id);}
return styles;}
getItemStyle(itemId){const position=this.container.cssPositionProperty;const style={};style.position="relative";style[position]=(this.getItemsPositions()[itemId]||0)+"px";style.transition=`${position} 0.5s`;style["pointer-events"]="none";if(this.draggedItemId===itemId){style.transition=`${position} 0s`;style["z-index"]="1000";}
return cssPropertiesToCss(style);}
onScroll(){this.moveDraggedItemToPosition(this.currentMousePosition+this.scrollOffset);}
onMouseMove(ev){if(ev.button!==0){this.onCancel();return;}
const mousePosition=this.container.getMousePosition(ev);this.currentMousePosition=mousePosition;if(mousePosition<this.container.start||mousePosition>this.container.end){this.startEdgeScroll(mousePosition<this.container.start?-1:1);return;}
else{this.stopEdgeScroll();}
this.moveDraggedItemToPosition(mousePosition+this.scrollOffset);}
moveDraggedItemToPosition(position){const hoveredItemIndex=this.getHoveredItemIndex(position,this.items);const draggedItemIndex=this.items.findIndex((item)=>item.id===this.draggedItemId);const draggedItem=this.items[draggedItemIndex];if(this.deadZone&&this.isInZone(position,this.deadZone)){this.onChange(this.getItemsPositions());return;}
else if(this.isInZone(position,{start:draggedItem.position,end:draggedItem.position+draggedItem.size,})){this.deadZone=undefined;}
if(draggedItemIndex===hoveredItemIndex){this.onChange(this.getItemsPositions());return;}
const startIndex=Math.min(draggedItemIndex,hoveredItemIndex);const endIndex=Math.max(draggedItemIndex,hoveredItemIndex);const direction=Math.sign(hoveredItemIndex-draggedItemIndex);let draggedItemMoveSize=0;for(let i=startIndex;i<=endIndex;i++){if(i===draggedItemIndex){continue;}
this.items[i].position-=direction*draggedItem.size;draggedItemMoveSize+=this.items[i].size;}
draggedItem.position+=direction*draggedItemMoveSize;this.items.sort((item1,item2)=>item1.position-item2.position);this.deadZone=direction>0?{start:position,end:draggedItem.position}:{start:draggedItem.position+draggedItem.size,end:position};this.onChange(this.getItemsPositions());}
onMouseUp(ev){if(ev.button!==0){this.onCancel();}
ev.stopPropagation();ev.preventDefault();const targetItemIndex=this.items.findIndex((item)=>item.id===this.draggedItemId);this.onDragEnd(this.draggedItemId,targetItemIndex);this.stopEdgeScroll();return false;}
startEdgeScroll(direction){if(this.edgeScrollIntervalId)
return;this.edgeScrollIntervalId=window.setInterval(()=>{const offset=direction*3;let newPosition=this.currentMousePosition+offset;if(newPosition<Math.min(this.container.start,this.minPosition)){newPosition=Math.min(this.container.start,this.minPosition);}
else if(newPosition>Math.max(this.container.end,this.maxPosition)){newPosition=Math.max(this.container.end,this.maxPosition);}
this.container.scroll+=offset;},5);}
stopEdgeScroll(){window.clearInterval(this.edgeScrollIntervalId);this.edgeScrollIntervalId=undefined;}
getHoveredItemIndex(mousePosition,items){if(mousePosition<=this.minPosition)
return 0;if(mousePosition>=this.maxPosition)
return items.length-1;return items.findIndex((item)=>item.position+item.size>=mousePosition);}
getItemsPositions(){const positions={};for(let item of this.items){if(item.id!==this.draggedItemId){positions[item.id]=item.position-item.positionAtStart;continue;}
const mouseOffset=this.currentMousePosition-this.initialMousePosition;let start=mouseOffset+this.scrollOffset;start=Math.max(this.minPosition-item.positionAtStart,start);start=Math.min(this.maxPosition-item.positionAtStart-item.size,start);positions[item.id]=start;}
return positions;}
isInZone(position,zone){return position>=zone.start&&position<=zone.end;}
get scrollOffset(){return this.container.scroll-this.initialScroll;}
destroy(){this.stopEdgeScroll();}}
class ContainerWrapper{el;constructor(el){this.el=el;}
get containerRect(){return this.el.getBoundingClientRect();}}
class VerticalContainer extends ContainerWrapper{get start(){return this.containerRect.top;}
get end(){return this.containerRect.bottom;}
get cssPositionProperty(){return"top";}
get scroll(){return this.el.scrollTop;}
set scroll(scroll){this.el.scrollTop=scroll;}
getMousePosition(ev){return ev.clientY;}}
class HorizontalContainer extends ContainerWrapper{get start(){return this.containerRect.left;}
get end(){return this.containerRect.right;}
get cssPositionProperty(){return"left";}
get scroll(){return this.el.scrollLeft;}
set scroll(scroll){this.el.scrollLeft=scroll;}
getMousePosition(ev){return ev.clientX;}}
css`
  .o-cf-preview-list {
    .o-cf-preview {
      &.o-cf-cursor-ptr {
        cursor: pointer;
      }

      border-bottom: 1px solid #ccc;
      height: 60px;
      padding: 10px;
      position: relative;
      cursor: pointer;
      &:hover,
      &.o-cf-dragging {
        background-color: #ebebeb;
      }

      &:not(:hover) .o-cf-delete-button {
        display: none;
      }
      .o-cf-preview-icon {
        border: 1px solid lightgrey;
        position: absolute;
        height: 50px;
        width: 50px;
      }
      .o-cf-preview-description {
        left: 65px;
        margin-bottom: auto;
        margin-right: 8px;
        margin-top: auto;
        position: relative;
        width: 142px;
        .o-cf-preview-description-rule {
          margin-bottom: 4px;
          font-weight: 600;
          color: #303030;
          max-height: 2.8em;
          line-height: 1.4em;
        }
        .o-cf-preview-range {
          font-size: 12px;
        }
      }
      .o-cf-delete {
        left: 90%;
        top: 39%;
        position: absolute;
      }
      &:not(:hover):not(.o-cf-dragging) .o-cf-drag-handle {
        display: none !important;
      }
      .o-cf-drag-handle {
        left: -8px;
        cursor: move;
        .o-icon {
          width: 6px;
          height: 30px;
        }
      }
    }
  }
`;class ConditionalFormatPreviewList extends owl.Component{static template="o-spreadsheet-ConditionalFormatPreviewList";icons=ICONS;dragAndDrop=useDragAndDropListItems();cfListRef=owl.useRef("cfList");setup(){owl.onWillUpdateProps((nextProps)=>{if(!deepEquals(this.props.conditionalFormats,nextProps.conditionalFormats)){this.dragAndDrop.cancel();}});}
getPreviewDivStyle(cf){return this.dragAndDrop.itemsStyle[cf.id]||"";}
getPreviewImageStyle(rule){if(rule.type==="CellIsRule"){return cssPropertiesToCss(cellStyleToCss(rule.style));}
else if(rule.type==="ColorScaleRule"){const minColor=colorNumberString(rule.minimum.color);const midColor=rule.midpoint?colorNumberString(rule.midpoint.color):null;const maxColor=colorNumberString(rule.maximum.color);const baseString="background-image: linear-gradient(to right, ";return midColor?baseString+minColor+", "+midColor+", "+maxColor+")":baseString+minColor+", "+maxColor+")";}
return"";}
getDescription(cf){switch(cf.rule.type){case"CellIsRule":const description=CellIsOperators[cf.rule.operator];if(cf.rule.values.length===1){return`${description} ${cf.rule.values[0]}`;}
if(cf.rule.values.length===2){return _t("%s %s and %s",description,cf.rule.values[0],cf.rule.values[1]);}
return description;case"ColorScaleRule":return CfTerms.ColorScale;case"IconSetRule":return CfTerms.IconSet;}}
deleteConditionalFormat(cf){this.env.model.dispatch("REMOVE_CONDITIONAL_FORMAT",{id:cf.id,sheetId:this.env.model.getters.getActiveSheetId(),});}
onMouseDown(cf,event){if(event.button!==0)
return;const previewRects=Array.from(this.cfListRef.el.children).map((previewEl)=>getBoundingRectAsPOJO(previewEl));const items=this.props.conditionalFormats.map((cf,index)=>({id:cf.id,size:previewRects[index].height,position:previewRects[index].y,}));this.dragAndDrop.start("vertical",{draggedItemId:cf.id,initialMousePosition:event.clientY,items:items,containerEl:this.cfListRef.el,onDragEnd:(cfId,finalIndex)=>this.onDragEnd(cfId,finalIndex),});}
onDragEnd(cfId,finalIndex){const originalIndex=this.props.conditionalFormats.findIndex((sheet)=>sheet.id===cfId);const delta=originalIndex-finalIndex;if(delta!==0){this.env.model.dispatch("CHANGE_CONDITIONAL_FORMAT_PRIORITY",{cfId,delta,sheetId:this.env.model.getters.getActiveSheetId(),});}}}
ConditionalFormatPreviewList.props={conditionalFormats:Array,onPreviewClick:Function,onAddConditionalFormat:Function,};css`
  label {
    vertical-align: middle;
  }
  .o_cf_radio_item {
    margin-right: 10%;
  }
  .radio input:checked {
    color: #e9ecef;
    border-color: #00a09d;
    background-color: #00a09d;
  }
  .o-cf-editor {
    border-bottom: solid;
    border-color: lightgrey;
  }
  .o-cf {
    .o-cf-type-selector {
      *,
      ::after,
      ::before {
        box-sizing: border-box;
      }
      margin-top: 10px;
      display: flex;
    }
    .o-section-subtitle:first-child {
      margin-top: 0px;
    }
    .o-cf-ruleEditor {
      font-size: 12px;
      line-height: 1.5;
      .o-selection-cf {
        margin-bottom: 3%;
      }
      .o-cell-content {
        font-size: 12px;
        font-weight: 500;
        padding: 0 12px;
        margin: 0;
        line-height: 35px;
      }
    }
    .o-cf-error {
      color: red;
      margin-top: 10px;
    }
  }
  .o-cf-cell-is-rule {
    .o-cf-preview-line {
      border: 1px solid darkgrey;
      padding: 10px;
    }
    .o-cell-is-operator {
      margin-bottom: 5px;
    }
    .o-cell-is-value {
      margin-bottom: 5px;
    }
    .o-color-picker-widget .o-color-picker-button {
      pointer-events: all;
      cursor: default;
    }
  }
  .o-cf-color-scale-editor {
    .o-threshold {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      select {
        width: 100%;
      }
      .o-threshold-value {
        margin-left: 2%;
        width: 20%;
        min-width: 0px; // input overflows in Firefox otherwise
      }
      .o-threshold-value:disabled {
        background-color: #edebed;
      }
    }
    .o-cf-preview-gradient {
      border: 1px solid darkgrey;
      padding: 10px;
      border-radius: 4px;
    }
  }
  .o-cf-iconset-rule {
    font-size: 12;
    .o-cf-iconsets {
      display: flex;
      justify-content: space-between;
      .o-cf-iconset {
        border: 1px solid #dadce0;
        border-radius: 4px;
        display: inline-flex;
        padding: 5px 8px;
        width: 25%;
        cursor: pointer;
        justify-content: space-between;
        .o-cf-icon {
          display: inline;
          margin-left: 1%;
          margin-right: 1%;
        }
        svg {
          vertical-align: baseline;
        }
      }
      .o-cf-iconset:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .o-inflection {
      .o-cf-icon-button {
        display: inline-block;
        border: 1px solid #dadce0;
        border-radius: 4px;
        cursor: pointer;
        padding: 1px 2px;
      }
      .o-cf-icon-button:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
      table {
        table-layout: fixed;
        margin-top: 2%;
        display: table;
        text-align: left;
        font-size: 12px;
        line-height: 18px;
        width: 100%;
      }
      th.o-cf-iconset-icons {
        width: 8%;
      }
      th.o-cf-iconset-text {
        width: 28%;
      }
      th.o-cf-iconset-operator {
        width: 14%;
      }
      th.o-cf-iconset-type {
        width: 28%;
      }
      th.o-cf-iconset-value {
        width: 26%;
      }
      input,
      select {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
    }
    .o-cf-iconset-reverse {
      margin-bottom: 2%;
      margin-top: 2%;
      .o-cf-label {
        display: inline-block;
        vertical-align: bottom;
        margin-bottom: 2px;
      }
    }
  }
`;class ConditionalFormattingEditor extends owl.Component{static template="o-spreadsheet-ConditionalFormattingEditor";static components={SelectionInput,IconPicker,ColorPickerWidget,ConditionalFormatPreviewList,};icons=ICONS;cellIsOperators=CellIsOperators;iconSets=ICON_SETS;getTextDecoration=getTextDecoration;colorNumberString=colorNumberString;state;setup(){const cf=this.props.editedCf||{id:this.env.model.uuidGenerator.uuidv4(),ranges:this.env.model.getters.getSelectedZones().map((zone)=>this.env.model.getters.zoneToXC(this.env.model.getters.getActiveSheetId(),zone)),};this.state=owl.useState({currentCF:cf,currentCFType:this.props.editedCf?.rule.type||"CellIsRule",errors:[],rules:this.getDefaultRules(),});if(this.props.editedCf){switch(this.props.editedCf.rule.type){case"CellIsRule":this.state.rules.cellIs=this.props.editedCf.rule;break;case"ColorScaleRule":this.state.rules.colorScale=this.props.editedCf.rule;break;case"IconSetRule":this.state.rules.iconSet=this.props.editedCf.rule;break;}}
owl.useExternalListener(window,"click",this.closeMenus);}
get isRangeValid(){return this.state.errors.includes("EmptyRange");}
errorMessage(error){return CfTerms.Errors[error]||CfTerms.Errors.Unexpected;}
saveConditionalFormat(){if(this.state.currentCF){const invalidRanges=this.state.currentCF.ranges.some((xc)=>!xc.match(rangeReference));if(invalidRanges){this.state.errors=["InvalidRange"];return;}
const sheetId=this.env.model.getters.getActiveSheetId();const locale=this.env.model.getters.getLocale();const result=this.env.model.dispatch("ADD_CONDITIONAL_FORMAT",{cf:{rule:canonicalizeCFRule(this.getEditorRule(),locale),id:this.state.currentCF.id,},ranges:this.state.currentCF.ranges.map((xc)=>this.env.model.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});if(!result.isSuccessful){this.state.errors=result.reasons;}
else{this.props.onExitEdition();}}}
getEditorRule(){switch(this.state.currentCFType){case"CellIsRule":return this.state.rules.cellIs;case"ColorScaleRule":return this.state.rules.colorScale;case"IconSetRule":return this.state.rules.iconSet;}}
getDefaultRules(){return{cellIs:{type:"CellIsRule",operator:"IsNotEmpty",values:[],style:{fillColor:"#b6d7a8"},},colorScale:{type:"ColorScaleRule",minimum:{type:"value",color:0xffffff},midpoint:undefined,maximum:{type:"value",color:0x6aa84f},},iconSet:{type:"IconSetRule",icons:{upper:"arrowGood",middle:"arrowNeutral",lower:"arrowBad",},upperInflectionPoint:{type:"percentage",value:"66",operator:"gt",},lowerInflectionPoint:{type:"percentage",value:"33",operator:"gt",},},};}
changeRuleType(ruleType){if(this.state.currentCFType===ruleType||!this.state.rules){return;}
this.state.errors=[];this.state.currentCFType=ruleType;}
onRangesChanged(ranges){if(this.state.currentCF){this.state.currentCF.ranges=ranges;}}
toggleMenu(menu){const isSelected=this.state.openedMenu===menu;this.closeMenus();if(!isSelected){this.state.openedMenu=menu;}}
closeMenus(){this.state.openedMenu=undefined;}
get isValue1Invalid(){return!!this.state.errors?.includes("FirstArgMissing");}
get isValue2Invalid(){return!!this.state.errors?.includes("SecondArgMissing");}
toggleStyle(tool){const style=this.state.rules.cellIs.style;style[tool]=!style[tool];this.closeMenus();}
onKeydown(event){if(event.key==="F4"){const target=event.target;const update=this.env.model.getters.getCycledReference({start:target.selectionStart??0,end:target.selectionEnd??0},target.value);if(!update){return;}
target.value=update.content;target.setSelectionRange(update.selection.start,update.selection.end);target.dispatchEvent(new Event("input"));}}
setColor(target,color){this.state.rules.cellIs.style[target]=color;this.closeMenus();}
isValueInvalid(threshold){switch(threshold){case"minimum":return(this.state.errors.includes("MinInvalidFormula")||this.state.errors.includes("MinBiggerThanMid")||this.state.errors.includes("MinBiggerThanMax")||this.state.errors.includes("MinNaN"));case"midpoint":return(this.state.errors.includes("MidInvalidFormula")||this.state.errors.includes("MidNaN")||this.state.errors.includes("MidBiggerThanMax"));case"maximum":return(this.state.errors.includes("MaxInvalidFormula")||this.state.errors.includes("MaxNaN"));default:return false;}}
setColorScaleColor(target,color){const point=this.state.rules.colorScale[target];if(point){point.color=Number.parseInt(color.substr(1),16);}
this.closeMenus();}
getPreviewGradient(){const rule=this.state.rules.colorScale;const minColor=colorNumberString(rule.minimum.color);const midColor=colorNumberString(rule.midpoint?.color||DEFAULT_COLOR_SCALE_MIDPOINT_COLOR);const maxColor=colorNumberString(rule.maximum.color);const baseString="background-image: linear-gradient(to right, ";return rule.midpoint===undefined?baseString+minColor+", "+maxColor+")":baseString+minColor+", "+midColor+", "+maxColor+")";}
getThresholdColor(threshold){return threshold?colorNumberString(threshold.color):colorNumberString(DEFAULT_COLOR_SCALE_MIDPOINT_COLOR);}
onMidpointChange(ev){const type=ev.target.value;const rule=this.state.rules.colorScale;if(type==="none"){rule.midpoint=undefined;}
else{rule.midpoint={color:DEFAULT_COLOR_SCALE_MIDPOINT_COLOR,value:"",...rule.midpoint,type,};}}
isInflectionPointInvalid(inflectionPoint){switch(inflectionPoint){case"lowerInflectionPoint":return(this.state.errors.includes("ValueLowerInflectionNaN")||this.state.errors.includes("ValueLowerInvalidFormula")||this.state.errors.includes("LowerBiggerThanUpper"));case"upperInflectionPoint":return(this.state.errors.includes("ValueUpperInflectionNaN")||this.state.errors.includes("ValueUpperInvalidFormula")||this.state.errors.includes("LowerBiggerThanUpper"));default:return true;}}
reverseIcons(){const icons=this.state.rules.iconSet.icons;const upper=icons.upper;icons.upper=icons.lower;icons.lower=upper;}
setIconSet(iconSet){const icons=this.state.rules.iconSet.icons;icons.upper=this.iconSets[iconSet].good;icons.middle=this.iconSets[iconSet].neutral;icons.lower=this.iconSets[iconSet].bad;}
setIcon(target,icon){this.state.rules.iconSet.icons[target]=icon;}}
ConditionalFormattingEditor.props={editedCf:{type:Object,optional:true},onExitEdition:Function,};class ConditionalFormattingPanel extends owl.Component{static template="o-spreadsheet-ConditionalFormattingPanel";static components={ConditionalFormatPreviewList,ConditionalFormattingEditor,};activeSheetId;state=owl.useState({mode:"list",});setup(){this.activeSheetId=this.env.model.getters.getActiveSheetId();const sheetId=this.env.model.getters.getActiveSheetId();const rules=this.env.model.getters.getRulesSelection(sheetId,this.props.selection||[]);if(rules.length===1){const cf=this.conditionalFormats.find((c)=>c.id===rules[0]);if(cf){this.editConditionalFormat(cf);}}
owl.onWillUpdateProps((nextProps)=>{const newActiveSheetId=this.env.model.getters.getActiveSheetId();if(newActiveSheetId!==this.activeSheetId){this.activeSheetId=newActiveSheetId;this.switchToList();}
else if(nextProps.selection!==this.props.selection){const sheetId=this.env.model.getters.getActiveSheetId();const rules=this.env.model.getters.getRulesSelection(sheetId,nextProps.selection||[]);if(rules.length===1){const cf=this.conditionalFormats.find((c)=>c.id===rules[0]);if(cf){this.editConditionalFormat(cf);}}
else{this.switchToList();}}});}
get conditionalFormats(){const cfs=this.env.model.getters.getConditionalFormats(this.env.model.getters.getActiveSheetId());return cfs.map((cf)=>({...cf,rule:localizeCFRule(cf.rule,this.env.model.getters.getLocale()),}));}
switchToList(){this.state.mode="list";this.state.editedCf=undefined;}
addConditionalFormat(){this.state.mode="edit";}
editConditionalFormat(cf){this.state.mode="edit";this.state.editedCf=cf;}}
ConditionalFormattingPanel.props={selection:{type:Object,optional:true},onCloseSidePanel:Function,};css`
  .o-custom-currency {
    .o-format-proposals {
      color: black;
    }
  }
`;class CustomCurrencyPanel extends owl.Component{static template="o-spreadsheet-CustomCurrencyPanel";availableCurrencies;state;setup(){this.availableCurrencies=[];this.state=owl.useState({selectedCurrencyIndex:0,currencyCode:"",currencySymbol:"",selectedFormatIndex:0,});owl.onWillStart(()=>this.updateAvailableCurrencies());}
get formatProposals(){const currency=this.availableCurrencies[this.state.selectedCurrencyIndex];const position=currency.position;const opposite=currency.position==="before"?"after":"before";const symbol=this.state.currencySymbol.trim()?this.state.currencySymbol:"";const code=this.state.currencyCode.trim()?this.state.currencyCode:"";const decimalPlaces=currency.decimalPlaces;if(!symbol&&!code){return[];}
const simple=symbol?createCurrencyFormat({symbol,position,decimalPlaces}):"";const rounded=simple?roundFormat(simple):"";const simpleWithCode=createCurrencyFormat({symbol,position,decimalPlaces,code});const roundedWithCode=roundFormat(simpleWithCode);const simpleOpposite=symbol?createCurrencyFormat({symbol,position:opposite,decimalPlaces}):"";const roundedOpposite=simpleOpposite?roundFormat(simpleOpposite):"";const simpleOppositeWithCode=createCurrencyFormat({symbol,position:opposite,decimalPlaces,code,});const roundedOppositeWithCode=roundFormat(simpleOppositeWithCode);const formats=new Set([rounded,simple,roundedWithCode,simpleWithCode,roundedOpposite,simpleOpposite,roundedOppositeWithCode,simpleOppositeWithCode,]);return[...formats].filter((format)=>format!=="").map((format)=>({format,example:formatValue(1000.0,{format,locale:this.env.model.getters.getLocale()}),}));}
get isSameFormat(){const selectedFormat=this.formatProposals[this.state.selectedFormatIndex];return selectedFormat?selectedFormat.format===this.getCommonFormat():false;}
async updateAvailableCurrencies(){if(currenciesRegistry.getAll().length===0){const currencies=(await this.env.loadCurrencies?.())||[];currencies.forEach((currency,index)=>{currenciesRegistry.add(index.toString(),currency);});}
const emptyCurrency={name:_t(CustomCurrencyTerms.Custom),code:"",symbol:"",decimalPlaces:2,position:"after",};this.availableCurrencies=[emptyCurrency,...currenciesRegistry.getAll()];}
updateSelectCurrency(ev){const target=ev.target;this.state.selectedCurrencyIndex=parseInt(target.value,10);const currency=this.availableCurrencies[this.state.selectedCurrencyIndex];this.state.currencyCode=currency.code;this.state.currencySymbol=currency.symbol;}
updateCode(ev){const target=ev.target;this.state.currencyCode=target.value;this.initAvailableCurrencies();}
updateSymbol(ev){const target=ev.target;this.state.currencySymbol=target.value;this.initAvailableCurrencies();}
updateSelectFormat(ev){const target=ev.target;this.state.selectedFormatIndex=parseInt(target.value,10);}
apply(){const selectedFormat=this.formatProposals[this.state.selectedFormatIndex];this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),format:selectedFormat.format,});}
initAvailableCurrencies(){this.state.selectedCurrencyIndex=0;}
getCommonFormat(){const selectedZones=this.env.model.getters.getSelectedZones();const sheetId=this.env.model.getters.getActiveSheetId();const cells=selectedZones.map((zone)=>this.env.model.getters.getEvaluatedCellsInZone(sheetId,zone)).flat();const firstFormat=cells[0].format;return cells.every((cell)=>cell.format===firstFormat)?firstFormat:undefined;}
currencyDisplayName(currency){return currency.name+(currency.code?` (${currency.code})`:"");}}
CustomCurrencyPanel.props={onCloseSidePanel:Function,};css`
  .o-find-and-replace {
    outline: none;
    height: 100%;
    .o-input-search-container {
      display: flex;
      .o-input-with-count {
        flex-grow: 1;
        width: auto;
      }
      .o-input-without-count {
        width: 100%;
      }
      .o-input-count {
        width: fit-content;
        padding: 4px 0 4px 4px;
      }
    }
  }
`;class FindAndReplacePanel extends owl.Component{static template="o-spreadsheet-FindAndReplacePanel";state=owl.useState(this.initialState());debounceTimeoutId;showFormulaState=false;searchInput=owl.useRef("searchInput");get hasSearchResult(){return this.env.model.getters.getCurrentSelectedMatchIndex()!==null;}
get pendingSearch(){return this.debounceTimeoutId!==undefined;}
setup(){this.showFormulaState=this.env.model.getters.shouldShowFormulas();owl.onMounted(()=>this.searchInput.el?.focus());owl.onWillUnmount(()=>{clearTimeout(this.debounceTimeoutId);this.env.model.dispatch("CLEAR_SEARCH");this.env.model.dispatch("SET_FORMULA_VISIBILITY",{show:this.showFormulaState});});owl.useEffect(()=>{this.state.searchOptions.searchFormulas=this.env.model.getters.shouldShowFormulas();this.searchFormulas();},()=>[this.env.model.getters.shouldShowFormulas()]);}
onInput(ev){this.state.toSearch=ev.target.value;this.debouncedUpdateSearch();}
onKeydownSearch(ev){if(ev.key==="Enter"){ev.preventDefault();ev.stopPropagation();this.onSelectNextCell();}}
onKeydownReplace(ev){if(ev.key==="Enter"){ev.preventDefault();ev.stopPropagation();this.replace();}}
searchFormulas(){this.env.model.dispatch("SET_FORMULA_VISIBILITY",{show:this.state.searchOptions.searchFormulas,});this.updateSearch();}
onSelectPreviousCell(){this.env.model.dispatch("SELECT_SEARCH_PREVIOUS_MATCH");}
onSelectNextCell(){this.env.model.dispatch("SELECT_SEARCH_NEXT_MATCH");}
updateSearch(){this.env.model.dispatch("UPDATE_SEARCH",{toSearch:this.state.toSearch,searchOptions:this.state.searchOptions,});}
debouncedUpdateSearch(){clearTimeout(this.debounceTimeoutId);this.debounceTimeoutId=setTimeout(()=>{this.updateSearch();this.debounceTimeoutId=undefined;},200);}
replace(){this.env.model.dispatch("REPLACE_SEARCH",{replaceWith:this.state.replaceWith,});}
replaceAll(){this.env.model.dispatch("REPLACE_ALL_SEARCH",{replaceWith:this.state.replaceWith,});}
initialState(){return{toSearch:"",replaceWith:"",searchOptions:{matchCase:false,exactMatch:false,searchFormulas:false,},};}}
FindAndReplacePanel.props={onCloseSidePanel:Function,};css`
  .o-more-formats-panel {
    .format-preview {
      height: 48px;
      background-color: white;

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .check-icon {
      width: 24px;
    }
  }
`;const DATE_FORMAT_ACTIONS=createActions([formatNumberFullDateTime,formatNumberFullWeekDayAndMonth,formatNumberDayAndFullMonth,formatNumberShortWeekDay,formatNumberDayAndShortMonth,formatNumberFullMonth,formatNumberShortMonth,formatNumberDate,formatNumberTime,formatNumberDateTime,formatNumberDuration,]);class MoreFormatsPanel extends owl.Component{static template="o-spreadsheet-MoreFormatsPanel";get dateFormatsActions(){return DATE_FORMAT_ACTIONS;}}
MoreFormatsPanel.props={onCloseSidePanel:Function,};css`
  .o-checkbox-selection {
    height: 150px;
  }
`;class RemoveDuplicatesPanel extends owl.Component{static template="o-spreadsheet-RemoveDuplicatesPanel";static components={ValidationMessages};state=owl.useState({hasHeader:false,columns:{},});setup(){owl.onWillUpdateProps(()=>this.updateColumns());}
toggleHasHeader(){this.state.hasHeader=!this.state.hasHeader;}
toggleAllColumns(){const newState=!this.isEveryColumnSelected;for(const index in this.state.columns){this.state.columns[index]=newState;}}
toggleColumn(colIndex){this.state.columns[colIndex]=!this.state.columns[colIndex];}
onRemoveDuplicates(){this.env.model.dispatch("REMOVE_DUPLICATES",{hasHeader:this.state.hasHeader,columns:this.getColsToAnalyze(),});}
getColLabel(colKey){const col=parseInt(colKey);let colLabel=_t("Column %s",numberToLetters(col));if(this.state.hasHeader){const sheetId=this.env.model.getters.getActiveSheetId();const row=this.env.model.getters.getSelectedZone().top;const colHeader=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(colHeader.type!=="empty"){colLabel+=` - ${colHeader.value}`;}}
return colLabel;}
get isEveryColumnSelected(){return Object.values(this.state.columns).every((value)=>value===true);}
get errorMessages(){const cancelledReasons=this.env.model.canDispatch("REMOVE_DUPLICATES",{hasHeader:this.state.hasHeader,columns:this.getColsToAnalyze(),}).reasons;const errors=new Set();for(const reason of cancelledReasons){errors.add(RemoveDuplicateTerms.Errors[reason]||RemoveDuplicateTerms.Errors.Unexpected);}
return Array.from(errors);}
get selectionStatisticalInformation(){const dimension=zoneToDimension(this.env.model.getters.getSelectedZone());return _t("%(row_count)s rows and %(column_count)s columns selected",{row_count:dimension.numberOfRows,column_count:dimension.numberOfCols,});}
get canConfirm(){return this.errorMessages.length===0;}
updateColumns(){const zone=this.env.model.getters.getSelectedZone();const oldColumns=this.state.columns;const newColumns={};for(let i=zone.left;i<=zone.right;i++){newColumns[i]=i in oldColumns?oldColumns[i]:true;}
this.state.columns=newColumns;}
getColsToAnalyze(){return Object.keys(this.state.columns).filter((colIndex)=>this.state.columns[colIndex]).map((colIndex)=>parseInt(colIndex));}}
css`
  .o-locale-preview {
    color: dimgrey;
  }
`;class SettingsPanel extends owl.Component{static template="o-spreadsheet-SettingsPanel";loadedLocales=[];setup(){owl.onWillStart(()=>this.loadLocales());}
onLocaleChange(code){const locale=this.loadedLocales.find((l)=>l.code===code);if(!locale)
return;this.env.model.dispatch("UPDATE_LOCALE",{locale});}
async loadLocales(){this.loadedLocales=(await this.env.loadLocales()).filter(isValidLocale).sort((a,b)=>a.name.localeCompare(b.name));}
get numberFormatPreview(){const locale=this.env.model.getters.getLocale();return formatValue(1234567.89,{format:"#,##0.00",locale});}
get dateFormatPreview(){const locale=this.env.model.getters.getLocale();return formatValue(1.6,{format:locale.dateFormat,locale});}
get dateTimeFormatPreview(){const locale=this.env.model.getters.getLocale();const dateTimeFormat=getDateTimeFormat(locale);return formatValue(1.6,{format:dateTimeFormat,locale});}
get currentLocale(){return this.env.model.getters.getLocale();}
get supportedLocales(){const currentLocale=this.currentLocale;const localeInLoadedLocales=this.loadedLocales.find((l)=>l.code===currentLocale.code);if(!localeInLoadedLocales){const locales=[...this.loadedLocales,currentLocale].sort((a,b)=>a.name.localeCompare(b.name));return locales;}
else if(!deepEquals(currentLocale,localeInLoadedLocales)){const index=this.loadedLocales.indexOf(localeInLoadedLocales);const locales=[...this.loadedLocales];locales[index]=currentLocale;locales.sort((a,b)=>a.name.localeCompare(b.name));return locales;}
return this.loadedLocales;}}
SettingsPanel.props={onCloseSidePanel:Function,};const SplitToColumnsInteractiveContent={SplitIsDestructive:_t("This will overwrite data in the subsequent columns. Split anyway?"),};function interactiveSplitToColumns(env,separator,addNewColumns){let result=env.model.dispatch("SPLIT_TEXT_INTO_COLUMNS",{separator,addNewColumns});if(result.isCancelledBecause("SplitWillOverwriteContent")){env.askConfirmation(SplitToColumnsInteractiveContent.SplitIsDestructive,()=>{result=env.model.dispatch("SPLIT_TEXT_INTO_COLUMNS",{separator,addNewColumns,force:true,});});}
return result;}
const dataValidationEvaluatorRegistry=new Registry();dataValidationEvaluatorRegistry.add("textContains",{type:"textContains",isValueValid:(value,criterion)=>{const strValue=String(value);return strValue.toLowerCase().includes(criterion.values[0].toLowerCase());},getErrorString:(criterion)=>{return _t('The value must be a text that contains "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text contains"),getPreview:(criterion)=>_t('Text contains "%s"',criterion.values[0]),});dataValidationEvaluatorRegistry.add("textNotContains",{type:"textNotContains",isValueValid:(value,criterion)=>{const strValue=String(value);return!strValue.toLowerCase().includes(criterion.values[0].toLowerCase());},getErrorString:(criterion)=>{return _t('The value must be a text that does not contain "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text does not contains"),getPreview:(criterion)=>_t('Text does not contain "%s"',criterion.values[0]),});dataValidationEvaluatorRegistry.add("textIs",{type:"textIs",isValueValid:(value,criterion)=>{const strValue=String(value);return strValue.toLowerCase()===criterion.values[0].toLowerCase();},getErrorString:(criterion)=>{return _t('The value must be exactly "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text is exactly"),getPreview:(criterion)=>_t('Text is exactly "%s"',criterion.values[0]),});const emailRegex=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}$/;dataValidationEvaluatorRegistry.add("textIsEmail",{type:"textIsEmail",isValueValid:(value)=>typeof value==="string"&&emailRegex.test(value),getErrorString:()=>_t("The value must be a valid email address"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Text is valid email"),getPreview:()=>_t("Text is valid email"),});dataValidationEvaluatorRegistry.add("textIsLink",{type:"textIsLink",isValueValid:(value)=>detectLink(value)!==undefined,getErrorString:()=>_t("The value must be a valid link"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Text is valid link"),getPreview:()=>_t("Text is valid link"),});dataValidationEvaluatorRegistry.add("dateIs",{type:"dateIs",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValue===undefined){return false;}
if(["lastWeek","lastMonth","lastYear"].includes(criterion.dateValue)){const today=jsDateToRoundNumber(DateTime.now());return isDateBetween(dateValue,today,criterionValue);}
return areDatesSameDay(dateValue,criterionValue);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be the date %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be %s",DVTerms.DateIs[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is %s",DVTerms.DateIs[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsBefore",{type:"dateIsBefore",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateStrictlyBefore(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date before %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date before %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is before"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is before %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is before %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsOnOrBefore",{type:"dateIsOnOrBefore",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateBefore(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date on or before %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date on or before %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is on or before"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is on or before %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is on or before %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsAfter",{type:"dateIsAfter",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateStrictlyAfter(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date after %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date after %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is after"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is after %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is after %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsOnOrAfter",{type:"dateIsOnOrAfter",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateAfter(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date on or after %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date on or after %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is on or after"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is on or after %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is on or after %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsBetween",{type:"dateIsBetween",isValueValid:(value,criterion)=>{const criterionValues=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return isDateBetween(dateValue,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const criterionValues=getDateCriterionLocalizedValues(criterion,locale);return _t("The value must be a date between %s and %s",criterionValues[0],criterionValues[1]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:()=>2,name:_t("Date is between"),getPreview:(criterion,getters)=>{const values=getDateCriterionFormattedValues(criterion,getters);return _t("Date is between %s and %s",values[0],values[1]);},});dataValidationEvaluatorRegistry.add("dateIsNotBetween",{type:"dateIsNotBetween",isValueValid:(value,criterion)=>{const criterionValues=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return!isDateBetween(dateValue,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const criterionValues=getDateCriterionLocalizedValues(criterion,locale);return _t("The value must be a date not between %s and %s",criterionValues[0],criterionValues[1]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:()=>2,name:_t("Date is not between"),getPreview:(criterion,getters)=>{const values=getDateCriterionFormattedValues(criterion,getters);return _t("Date is not between %s and %s",values[0],values[1]);},});dataValidationEvaluatorRegistry.add("dateIsValid",{type:"dateIsValid",isValueValid:(value)=>{return valueToDateNumber(value,DEFAULT_LOCALE)!==undefined;},getErrorString:()=>_t("The value must be a valid date"),isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Is valid date"),getPreview:()=>_t("Date is valid"),});dataValidationEvaluatorRegistry.add("isEqual",{type:"isEqual",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value===criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is equal to"),getPreview:(criterion)=>_t("Value is equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isNotEqual",{type:"isNotEqual",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value!==criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must not be equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is not equal to"),getPreview:(criterion)=>_t("Value is not equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isGreaterThan",{type:"isGreaterThan",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value>criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be greater than %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is greater than"),getPreview:(criterion)=>_t("Value is greater than %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isGreaterOrEqualTo",{type:"isGreaterOrEqualTo",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value>=criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be greater or equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is greater or equal to"),getPreview:(criterion)=>_t("Value is greater or equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isLessThan",{type:"isLessThan",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value<criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be less than %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is less than"),getPreview:(criterion)=>_t("Value is less than %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isLessOrEqualTo",{type:"isLessOrEqualTo",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value<=criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be less or equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is less or equal to"),getPreview:(criterion)=>_t("Value is less or equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isBetween",{type:"isBetween",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValues=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE);if(criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return isNumberBetween(value,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be between %s and %s",values[0],values[1]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>2,name:_t("Is between"),getPreview:(criterion)=>_t("Value is between %s and %s",criterion.values[0],criterion.values[1]),});dataValidationEvaluatorRegistry.add("isNotBetween",{type:"isNotBetween",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValues=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE);if(criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return!isNumberBetween(value,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must not be between %s and %s",values[0],values[1]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>2,name:_t("Is not between"),getPreview:(criterion)=>_t("Value is not between %s and %s",criterion.values[0],criterion.values[1]),});dataValidationEvaluatorRegistry.add("isBoolean",{type:"isBoolean",isValueValid:(value)=>value===""||typeof value==="boolean",getErrorString:()=>_t("The value must be a boolean"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Checkbox"),getPreview:()=>_t("Checkbox"),});dataValidationEvaluatorRegistry.add("isValueInList",{type:"isValueInList",isValueValid:(value,criterion)=>{if(value===null){return false;}
return criterion.values.map((str)=>str.toLowerCase()).includes(value.toString().toLowerCase());},getErrorString:(criterion)=>_t("The value must be one of: %s",criterion.values.join(", ")),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>undefined,allowedValues:"onlyLiterals",name:_t("Value in list"),getPreview:(criterion)=>_t("Value one of: %s",criterion.values.join(", ")),});dataValidationEvaluatorRegistry.add("isValueInRange",{type:"isValueInList",isValueValid:(value,criterion,getters,sheetId)=>{if(!value){return false;}
const range=getters.getRangeFromSheetXC(sheetId,criterion.values[0]);const criterionValues=getters.getRangeValues(range);return criterionValues.filter(isNotNull).map((value)=>value.toString().toLowerCase()).includes(value.toString().toLowerCase());},getErrorString:(criterion)=>_t("The value must be a value in the range %s",criterion.values[0]),isCriterionValueValid:(value)=>rangeReference.test(value),criterionValueErrorString:DVTerms.CriterionError.validRange,numberOfValues:()=>1,allowedValues:"onlyLiterals",name:_t("Value in range"),getPreview:(criterion)=>_t("Value in range %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("customFormula",{type:"customFormula",isValueValid:(value,criterion)=>{const parsedValue=parseLiteral(criterion.values[0],DEFAULT_LOCALE);if(typeof parsedValue==="number"||typeof parsedValue==="boolean"){return!!parsedValue;}
return false;},getErrorString:()=>_t("The value does not match the custom formula data validation rule"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>1,allowedValues:"onlyFormulas",name:_t("Custom formula"),getPreview:(criterion)=>_t("Custom formula %s",criterion.values[0]),});function getNumberCriterionlocalizedValues(criterion,locale){return criterion.values.map((value)=>value!==undefined?localizeContent(value,locale):CellErrorType.InvalidReference);}
function getDateCriterionLocalizedValues(criterion,locale){const values=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);return values.map((value)=>value!==undefined?formatValue(value,{locale,format:locale.dateFormat}):CellErrorType.InvalidReference);}
function checkValueIsDate(value){const valueAsNumber=valueToDateNumber(value,DEFAULT_LOCALE);return valueAsNumber!==undefined;}
function checkValueIsNumber(value){const valueAsNumber=tryToNumber(value,DEFAULT_LOCALE);return valueAsNumber!==undefined;}
function getDateCriterionFormattedValues(criterion,getters){const locale=getters.getLocale();return criterion.values.map((valueStr)=>{if(valueStr.startsWith("=")){return valueStr;}
const value=parseLiteral(valueStr,locale);if(typeof value==="number"){return formatValue(value,{format:locale.dateFormat,locale});}
return"";});}
function interactiveStopEdition(env){const result=env.model.dispatch("STOP_EDITION");if(result.isCancelledBecause("BlockingValidationRule")){const editedCell=env.model.getters.getCurrentEditedCell();const cellXc=toXC(editedCell.col,editedCell.row);const rule=env.model.getters.getValidationRuleForCell(editedCell);if(!rule){return;}
const evaluator=dataValidationEvaluatorRegistry.get(rule.criterion.type);const errorStr=evaluator.getErrorString(rule.criterion,env.model.getters,editedCell.sheetId);env.raiseError(_t("The data you entered in %s violates the data validation rule set on the cell:\n%s",cellXc,errorStr));env.model.dispatch("CANCEL_EDITION");}}
const SEPARATORS=[{name:_t("Detect automatically"),value:"auto"},{name:_t("Custom separator"),value:"custom"},{name:_t("Space"),value:" "},{name:_t("Comma"),value:","},{name:_t("Semicolon"),value:";"},{name:_t("Line Break"),value:NEWLINE},];class SplitIntoColumnsPanel extends owl.Component{static template="o-spreadsheet-SplitIntoColumnsPanel";static components={ValidationMessages};state=owl.useState({separatorValue:"auto",addNewColumns:false,customSeparator:""});setup(){owl.onWillUpdateProps(()=>{if(this.env.model.getters.getEditionMode()!=="inactive"){this.props.onCloseSidePanel();}});owl.onMounted(()=>{interactiveStopEdition(this.env);});}
onSeparatorChange(value){this.state.separatorValue=value;}
updateCustomSeparator(ev){if(!ev.target)
return;this.state.customSeparator=ev.target.value;}
updateAddNewColumnsCheckbox(ev){if(!ev.target)
return;this.state.addNewColumns=ev.target.checked;}
confirm(){const result=interactiveSplitToColumns(this.env,this.separatorValue,this.state.addNewColumns);if(result.isSuccessful){this.props.onCloseSidePanel();}}
get errorMessages(){const cancelledReasons=this.env.model.canDispatch("SPLIT_TEXT_INTO_COLUMNS",{separator:this.separatorValue,addNewColumns:this.state.addNewColumns,force:true,}).reasons;const errors=new Set();for(const reason of cancelledReasons){switch(reason){case"SplitWillOverwriteContent":case"EmptySplitSeparator":break;default:errors.add(SplitToColumnsTerms.Errors[reason]||SplitToColumnsTerms.Errors.Unexpected);}}
return Array.from(errors);}
get warningMessages(){const warnings=[];const cancelledReasons=this.env.model.canDispatch("SPLIT_TEXT_INTO_COLUMNS",{separator:this.separatorValue,addNewColumns:this.state.addNewColumns,force:false,}).reasons;if(cancelledReasons.includes("SplitWillOverwriteContent")){warnings.push(SplitToColumnsTerms.Errors["SplitWillOverwriteContent"]);}
return warnings;}
get separatorValue(){if(this.state.separatorValue==="custom"){return this.state.customSeparator;}
else if(this.state.separatorValue==="auto"){return this.env.model.getters.getAutomaticSeparator();}
return this.state.separatorValue;}
get separators(){return SEPARATORS;}
get isConfirmDisabled(){return!this.separatorValue||this.errorMessages.length>0;}}
SplitIntoColumnsPanel.props={onCloseSidePanel:Function,};class SelectMenu extends owl.Component{static template="o-spreadsheet-SelectMenu";static components={Menu};selectRef=owl.useRef("select");selectRect=useAbsoluteBoundingRect(this.selectRef);state=owl.useState({isMenuOpen:false,});onClick(){this.state.isMenuOpen=true;}
onMenuClosed(){this.state.isMenuOpen=false;}
get menuPosition(){return{x:this.selectRect.x,y:this.selectRect.y,};}}
SelectMenu.props={menuItems:Array,selectedValue:String,class:{type:String,optional:true},};class DataValidationCriterionForm extends owl.Component{setup(){owl.onMounted(()=>{interactiveStopEdition(this.env);});}
updateCriterion(criterion){const filteredCriterion={...this.props.criterion,...criterion,};this.props.onCriterionChanged(filteredCriterion);}}
DataValidationCriterionForm.props={criterion:Object,onCriterionChanged:Function,};css`
  .o-dv-input {
    .o-invalid {
      background-color: #ffdddd;
    }
    .error-icon {
      right: 7px;
      top: 7px;
    }
  }
`;class DataValidationInput extends owl.Component{static template="o-spreadsheet-DataValidationInput";static defaultProps={value:"",onKeyDown:()=>{},focused:false,onBlur:()=>{},};inputRef=owl.useRef("input");setup(){owl.useEffect(()=>{if(this.props.focused){this.inputRef.el.focus();}},()=>[this.props.focused,this.inputRef.el]);}
state=owl.useState({shouldDisplayError:!!this.props.value,});onValueChanged(ev){this.state.shouldDisplayError=true;this.props.onValueChanged(ev.target.value);}
get placeholder(){const evaluator=dataValidationEvaluatorRegistry.get(this.props.criterionType);if(evaluator.allowedValues==="onlyFormulas"){return _t("Formula");}
else if(evaluator.allowedValues==="onlyLiterals"){return _t("Value");}
return _t("Value or formula");}
get errorMessage(){if(!this.state.shouldDisplayError){return undefined;}
return this.env.model.getters.getDataValidationInvalidCriterionValueMessage(this.props.criterionType,canonicalizeContent(this.props.value,this.env.model.getters.getLocale()));}}
DataValidationInput.props={value:{type:String,optional:true},criterionType:String,onValueChanged:Function,onKeyDown:{type:Function,optional:true},focused:{type:Boolean,optional:true},onBlur:{type:Function,optional:true},onFocus:{type:Function,optional:true},};const DATES_VALUES={today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("in the past week"),lastMonth:_t("in the past month"),lastYear:_t("in the past year"),exactDate:_t("exact date"),};class DataValidationDateCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationDateCriterion";static components={DataValidationInput};setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.dateValue===undefined){this.updateCriterion({dateValue:"exactDate"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onValueChanged(value){this.updateCriterion({values:[value]});}
onDateValueChanged(ev){const dateValue=ev.target.value;this.updateCriterion({dateValue});}
get dateValues(){return Object.keys(DATES_VALUES).map((key)=>({value:key,title:DATES_VALUES[key],}));}}
class DataValidationDoubleInputCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationDoubleInput";static components={DataValidationInput};onFirstValueChanged(value){const values=this.props.criterion.values;this.updateCriterion({values:[value,values[1]],});}
onSecondValueChanged(value){const values=this.props.criterion.values;this.updateCriterion({values:[values[0],value],});}}
class DataValidationSingleInputCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationSingleInput";static components={DataValidationInput};onValueChanged(value){const criterion=deepCopy(this.props.criterion);criterion.values[0]=value;this.updateCriterion(criterion);}}
css`
  .o-dv-list-item-delete {
    color: #666666;
    cursor: pointer;
  }
`;class DataValidationListCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationListCriterionForm";static components={DataValidationInput};state=owl.useState({numberOfValues:Math.max(this.props.criterion.values.length,2),});setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.displayStyle===undefined){this.updateCriterion({displayStyle:"arrow"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onValueChanged(value,index){const values=[...this.displayedValues];values[index]=value;this.updateCriterion({values});}
onAddAnotherValue(){this.state.numberOfValues++;}
removeItem(index){const values=[...this.displayedValues];values.splice(index,1);this.state.numberOfValues--;this.updateCriterion({values});}
onChangedDisplayStyle(ev){const displayStyle=ev.target.value;this.updateCriterion({displayStyle});}
onKeyDown(ev,index){if((ev.key==="Enter"||ev.key==="Tab")&&index===this.state.numberOfValues-1){this.onAddAnotherValue();this.state.focusedValueIndex=index+1;ev.preventDefault();}
else if(ev.key==="Enter"){this.state.focusedValueIndex=index+1;}}
onBlurInput(){this.state.focusedValueIndex=undefined;}
get displayedValues(){const values=[];for(let i=0;i<this.state.numberOfValues;i++){values.push(this.props.criterion.values[i]||"");}
return values;}}
class DataValidationValueInRangeCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationValueInRangeCriterionForm";static components={SelectionInput};setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.displayStyle===undefined){this.updateCriterion({displayStyle:"arrow"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onRangeChanged(rangeXc){this.updateCriterion({values:[rangeXc]});}
onChangedDisplayStyle(ev){const displayStyle=ev.target.value;this.updateCriterion({displayStyle});}}
const dvCriterionCategoriesSequences={list:10,text:20,date:30,number:40,misc:50,};const dataValidationPanelCriteriaRegistry=new Registry();dataValidationPanelCriteriaRegistry.add("textContains",{type:"textContains",component:DataValidationSingleInputCriterionForm,category:"text",sequence:10,});dataValidationPanelCriteriaRegistry.add("textNotContains",{type:"textNotContains",component:DataValidationSingleInputCriterionForm,category:"text",sequence:20,});dataValidationPanelCriteriaRegistry.add("textIs",{type:"textIs",component:DataValidationSingleInputCriterionForm,category:"text",sequence:30,});dataValidationPanelCriteriaRegistry.add("textIsEmail",{type:"textIsEmail",component:undefined,category:"text",sequence:40,});dataValidationPanelCriteriaRegistry.add("textIsLink",{type:"textIsLink",component:undefined,category:"text",sequence:50,});dataValidationPanelCriteriaRegistry.add("dateIs",{type:"dateIs",component:DataValidationDateCriterionForm,category:"date",sequence:20,});dataValidationPanelCriteriaRegistry.add("dateIsBefore",{type:"dateIsBefore",component:DataValidationDateCriterionForm,category:"date",sequence:30,});dataValidationPanelCriteriaRegistry.add("dateIsOnOrBefore",{type:"dateIsOnOrBefore",component:DataValidationDateCriterionForm,category:"date",sequence:40,});dataValidationPanelCriteriaRegistry.add("dateIsAfter",{type:"dateIsAfter",component:DataValidationDateCriterionForm,category:"date",sequence:50,});dataValidationPanelCriteriaRegistry.add("dateIsOnOrAfter",{type:"dateIsOnOrAfter",component:DataValidationDateCriterionForm,category:"date",sequence:60,});dataValidationPanelCriteriaRegistry.add("dateIsBetween",{type:"dateIsBetween",component:DataValidationDoubleInputCriterionForm,category:"date",sequence:70,});dataValidationPanelCriteriaRegistry.add("dateIsNotBetween",{type:"dateIsNotBetween",component:DataValidationDoubleInputCriterionForm,category:"date",sequence:80,});dataValidationPanelCriteriaRegistry.add("dateIsValid",{type:"dateIsValid",component:undefined,category:"date",sequence:10,});dataValidationPanelCriteriaRegistry.add("isEqual",{type:"isEqual",component:DataValidationSingleInputCriterionForm,category:"number",sequence:10,});dataValidationPanelCriteriaRegistry.add("isNotEqual",{type:"isNotEqual",component:DataValidationSingleInputCriterionForm,category:"number",sequence:20,});dataValidationPanelCriteriaRegistry.add("isGreaterThan",{type:"isGreaterThan",component:DataValidationSingleInputCriterionForm,category:"number",sequence:50,});dataValidationPanelCriteriaRegistry.add("isGreaterOrEqualTo",{type:"isGreaterOrEqualTo",component:DataValidationSingleInputCriterionForm,category:"number",sequence:60,});dataValidationPanelCriteriaRegistry.add("isLessThan",{type:"isLessThan",component:DataValidationSingleInputCriterionForm,category:"number",sequence:30,});dataValidationPanelCriteriaRegistry.add("isLessOrEqualTo",{type:"isLessOrEqualTo",component:DataValidationSingleInputCriterionForm,category:"number",sequence:40,});dataValidationPanelCriteriaRegistry.add("isBetween",{type:"isBetween",component:DataValidationDoubleInputCriterionForm,category:"number",sequence:70,});dataValidationPanelCriteriaRegistry.add("isNotBetween",{type:"isNotBetween",component:DataValidationDoubleInputCriterionForm,category:"number",sequence:80,});dataValidationPanelCriteriaRegistry.add("isBoolean",{type:"isBoolean",component:undefined,category:"misc",sequence:10,});dataValidationPanelCriteriaRegistry.add("isValueInList",{type:"isValueInList",component:DataValidationListCriterionForm,category:"list",sequence:10,});dataValidationPanelCriteriaRegistry.add("isValueInRange",{type:"isValueInRange",component:DataValidationValueInRangeCriterionForm,category:"list",sequence:20,});dataValidationPanelCriteriaRegistry.add("customFormula",{type:"customFormula",component:DataValidationSingleInputCriterionForm,category:"misc",sequence:20,});function getDataValidationCriterionMenuItems(callback){const items=dataValidationPanelCriteriaRegistry.getAll().sort((a,b)=>{if(a.category===b.category){return a.sequence-b.sequence;}
return dvCriterionCategoriesSequences[a.category]-dvCriterionCategoriesSequences[b.category];});const actionSpecs=items.map((item,index)=>{const evaluator=dataValidationEvaluatorRegistry.get(item.type);return{name:evaluator.name,id:item.type,separator:item.category!==items[index+1]?.category,execute:()=>callback(item.type),};});return createActions(actionSpecs);}
css`
  .o-sidePanel .o-sidePanelBody .o-dv-form {
    .o-section {
      padding: 16px 16px 0 16px;
    }
  }
`;class DataValidationEditor extends owl.Component{static template="o-spreadsheet-DataValidationEditor";static components={SelectionInput,SelectMenu};state=owl.useState({rule:this.defaultDataValidationRule});setup(){if(this.props.rule){const sheetId=this.env.model.getters.getActiveSheetId();this.state.rule={...this.props.rule,ranges:this.props.rule.ranges.map((range)=>this.env.model.getters.getRangeString(range,sheetId)),};this.state.rule.criterion.type=this.props.rule.criterion.type;}}
onCriterionTypeChanged(type){this.state.rule.criterion.type=type;}
onRangesChanged(ranges){this.state.rule.ranges=ranges;}
onCriterionChanged(criterion){this.state.rule.criterion=criterion;}
changeRuleIsBlocking(ev){const isBlocking=ev.target.value;this.state.rule.isBlocking=isBlocking==="true";}
onSave(){if(!this.canSave){return;}
this.env.model.dispatch("ADD_DATA_VALIDATION_RULE",this.dispatchPayload);this.props.onExit();}
get canSave(){return this.env.model.canDispatch("ADD_DATA_VALIDATION_RULE",this.dispatchPayload).isSuccessful;}
get dispatchPayload(){const rule={...this.state.rule,ranges:undefined};const locale=this.env.model.getters.getLocale();const criterion=rule.criterion;const criterionEvaluator=dataValidationEvaluatorRegistry.get(criterion.type);const sheetId=this.env.model.getters.getActiveSheetId();const values=criterion.values.slice(0,criterionEvaluator.numberOfValues(criterion)).map((value)=>value?.trim()).filter((value)=>value!==""&&value!==undefined).map((value)=>canonicalizeContent(value,locale));rule.criterion={...criterion,values};return{sheetId,ranges:this.state.rule.ranges.map((xc)=>this.env.model.getters.getRangeDataFromXc(sheetId,xc)),rule,};}
get dvCriterionMenuItems(){return getDataValidationCriterionMenuItems((type)=>this.onCriterionTypeChanged(type));}
get selectedCriterionName(){const selectedType=this.state.rule.criterion.type;return dataValidationEvaluatorRegistry.get(selectedType).name;}
get defaultDataValidationRule(){const sheetId=this.env.model.getters.getActiveSheetId();const ranges=this.env.model.getters.getSelectedZones().map((zone)=>zoneToXc(this.env.model.getters.getUnboundedZone(sheetId,zone)));return{id:this.env.model.uuidGenerator.uuidv4(),criterion:{type:"textContains",values:[""]},ranges,};}
get criterionComponent(){return dataValidationPanelCriteriaRegistry.get(this.state.rule.criterion.type).component;}}
DataValidationEditor.props={rule:{type:Object,optional:true},onExit:Function,};css`
  .o-sidePanel {
    .o-dv-preview {
      height: 70px;
      box-sizing: border-box;
      cursor: pointer;
      border-bottom: 1px solid ${FIGURE_BORDER_COLOR};

      .o-dv-container {
        min-width: 0; // otherwise flex won't shrink correctly
      }

      .o-dv-preview-description {
        font-size: 13px;
      }

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }

      &:not(:hover) .o-dv-preview-delete {
        display: none !important;
      }
    }
  }
`;class DataValidationPreview extends owl.Component{static template="o-spreadsheet-DataValidationPreview";deleteDataValidation(){const sheetId=this.env.model.getters.getActiveSheetId();this.env.model.dispatch("REMOVE_DATA_VALIDATION_RULE",{sheetId,id:this.props.rule.id});}
get rangesString(){const sheetId=this.env.model.getters.getActiveSheetId();return this.props.rule.ranges.map((range)=>this.env.model.getters.getRangeString(range,sheetId)).join(", ");}
get descriptionString(){return dataValidationEvaluatorRegistry.get(this.props.rule.criterion.type).getPreview(this.props.rule.criterion,this.env.model.getters);}}
DataValidationPreview.props={onClick:Function,rule:Object,};class DataValidationPanel extends owl.Component{static template="o-spreadsheet-DataValidationPanel";static components={DataValidationPreview,DataValidationEditor};state=owl.useState({mode:"list",activeRule:undefined});onPreviewClick(id){const sheetId=this.env.model.getters.getActiveSheetId();const rule=this.env.model.getters.getDataValidationRule(sheetId,id);if(rule){this.state.mode="edit";this.state.activeRule=rule;}}
addDataValidationRule(){this.state.mode="edit";this.state.activeRule=undefined;}
onExitEditMode(){this.state.mode="list";this.state.activeRule=undefined;}
localizeDVRule(rule){if(!rule)
return rule;const locale=this.env.model.getters.getLocale();return localizeDataValidationRule(rule,locale);}
get validationRules(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getDataValidationRules(sheetId);}}
DataValidationPanel.props={onCloseSidePanel:Function,};const sidePanelRegistry=new Registry();sidePanelRegistry.add("ConditionalFormatting",{title:_t("Conditional formatting"),Body:ConditionalFormattingPanel,});sidePanelRegistry.add("ChartPanel",{title:_t("Chart"),Body:ChartPanel,});sidePanelRegistry.add("FindAndReplace",{title:_t("Find and Replace"),Body:FindAndReplacePanel,});sidePanelRegistry.add("CustomCurrency",{title:_t("Custom currency format"),Body:CustomCurrencyPanel,});sidePanelRegistry.add("SplitToColumns",{title:_t("Split text into columns"),Body:SplitIntoColumnsPanel,});sidePanelRegistry.add("Settings",{title:_t("Spreadsheet settings"),Body:SettingsPanel,});sidePanelRegistry.add("RemoveDuplicates",{title:_t("Remove duplicates"),Body:RemoveDuplicatesPanel,});sidePanelRegistry.add("DataValidation",{title:_t("Data validation"),Body:DataValidationPanel,});sidePanelRegistry.add("MoreFormats",{title:_t("More date formats"),Body:MoreFormatsPanel,});class TopBarComponentRegistry extends Registry{mapping={};uuidGenerator=new UuidGenerator();add(name,value){const component={...value,id:this.uuidGenerator.uuidv4()};return super.add(name,component);}}
const topbarComponentRegistry=new TopBarComponentRegistry();const ANCHOR_SIZE=8;const BORDER_WIDTH=1;const ACTIVE_BORDER_WIDTH=2;css`
  div.o-figure {
    box-sizing: border-box;
    position: absolute;
    width: 100%;
    height: 100%;
    user-select: none;

    &:focus {
      outline: none;
    }
  }

  div.o-figure-border {
    box-sizing: border-box;
    z-index: 1;
  }

  .o-figure-wrapper {
    position: absolute;
    box-sizing: content-box;

    .o-fig-anchor {
      z-index: ${ComponentsImportance.FigureAnchor};
      position: absolute;
      width: ${ANCHOR_SIZE}px;
      height: ${ANCHOR_SIZE}px;
      background-color: #1a73e8;
      outline: ${BORDER_WIDTH}px solid white;

      &.o-top {
        cursor: n-resize;
      }
      &.o-topRight {
        cursor: ne-resize;
      }
      &.o-right {
        cursor: e-resize;
      }
      &.o-bottomRight {
        cursor: se-resize;
      }
      &.o-bottom {
        cursor: s-resize;
      }
      &.o-bottomLeft {
        cursor: sw-resize;
      }
      &.o-left {
        cursor: w-resize;
      }
      &.o-topLeft {
        cursor: nw-resize;
      }
    }

    .o-figure-menu {
      right: 0px;
      top: 0px;
      display: none;
    }

    .o-figure-menu-item {
      cursor: pointer;
    }

    .o-figure.active:focus,
    .o-figure:hover {
      .o-figure-menu {
        display: flex;
      }
    }
  }
`;class FigureComponent extends owl.Component{static template="o-spreadsheet-FigureComponent";static components={Menu};static defaultProps={onFigureDeleted:()=>{},onMouseDown:()=>{},onClickAnchor:()=>{},};menuState=owl.useState({isOpen:false,position:null,menuItems:[]});figureRef=owl.useRef("figure");menuButtonRef=owl.useRef("menuButton");menuButtonRect=useAbsoluteBoundingRect(this.menuButtonRef);borderWidth;get isSelected(){return this.env.model.getters.getSelectedFigureId()===this.props.figure.id;}
get figureRegistry(){return figureRegistry;}
getBorderWidth(){if(this.env.isDashboard())
return 0;return this.isSelected?ACTIVE_BORDER_WIDTH:this.borderWidth;}
get borderStyle(){const borderWidth=this.getBorderWidth();const borderColor=this.isSelected?SELECTION_BORDER_COLOR:FIGURE_BORDER_COLOR;return`border: ${borderWidth}px solid ${borderColor};`;}
get wrapperStyle(){const{x,y,width,height}=this.props.figure;return cssPropertiesToCss({left:`${x}px`,top:`${y}px`,width:`${width}px`,height:`${height}px`,"z-index":String(ComponentsImportance.Figure+(this.isSelected?1:0)),});}
getResizerPosition(resizer){const anchorCenteringOffset=(ANCHOR_SIZE-ACTIVE_BORDER_WIDTH)/2;let style={};if(resizer.includes("top")){style.top=`${-anchorCenteringOffset}px`;}
else if(resizer.includes("bottom")){style.bottom=`${-anchorCenteringOffset}px`;}
else{style.bottom=`calc(50% - ${anchorCenteringOffset}px)`;}
if(resizer.includes("left")){style.left=`${-anchorCenteringOffset}px`;}
else if(resizer.includes("right")){style.right=`${-anchorCenteringOffset}px`;}
else{style.right=`calc(50% - ${anchorCenteringOffset}px)`;}
return cssPropertiesToCss(style);}
setup(){const borderWidth=figureRegistry.get(this.props.figure.tag).borderWidth;this.borderWidth=borderWidth!==undefined?borderWidth:BORDER_WIDTH;owl.useEffect((selectedFigureId,thisFigureId,el)=>{if(selectedFigureId===thisFigureId){el?.focus({preventScroll:true});}},()=>[this.env.model.getters.getSelectedFigureId(),this.props.figure.id,this.figureRef.el]);owl.onWillUnmount(()=>{this.props.onFigureDeleted();});}
clickAnchor(dirX,dirY,ev){this.props.onClickAnchor(dirX,dirY,ev);}
onMouseDown(ev){this.props.onMouseDown(ev);}
onKeyDown(ev){const figure=this.props.figure;switch(ev.key){case"Delete":this.env.model.dispatch("DELETE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,});this.props.onFigureDeleted();ev.stopPropagation();ev.preventDefault();ev.stopPropagation();break;case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"ArrowUp":const deltaMap={ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],};const delta=deltaMap[ev.key];this.env.model.dispatch("UPDATE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,x:figure.x+delta[0],y:figure.y+delta[1],});ev.stopPropagation();ev.preventDefault();ev.stopPropagation();break;}}
onContextMenu(ev){if(this.env.isDashboard())
return;const position={x:ev.clientX,y:ev.clientY,};this.openContextMenu(position);}
showMenu(){const{x,y,width}=this.menuButtonRect;const menuPosition={x:x>=MENU_WIDTH?x-MENU_WIDTH:x+width,y:y,};this.openContextMenu(menuPosition);}
openContextMenu(position){this.menuState.isOpen=true;this.menuState.position=position;this.menuState.menuItems=figureRegistry.get(this.props.figure.tag).menuBuilder(this.props.figure.id,this.props.onFigureDeleted,this.env);}}
FigureComponent.props={figure:Object,style:{type:String,optional:true},onFigureDeleted:{type:Function,optional:true},onMouseDown:{type:Function,optional:true},onClickAnchor:{type:Function,optional:true},};const ToggleGroupInteractiveContent={CannotHideAllRows:_t("Cannot hide all the rows of a sheet."),CannotHideAllColumns:_t("Cannot hide all the columns of a sheet."),};function interactiveToggleGroup(env,sheetId,dimension,start,end){const group=env.model.getters.getHeaderGroup(sheetId,dimension,start,end);if(!group){return;}
const command=group.isFolded?"UNFOLD_HEADER_GROUP":"FOLD_HEADER_GROUP";const result=env.model.dispatch(command,{sheetId,dimension,start:group.start,end:group.end,});if(!result.isSuccessful){if(result.isCancelledBecause("NotEnoughElements")){const errorMessage=dimension==="ROW"?ToggleGroupInteractiveContent.CannotHideAllRows:ToggleGroupInteractiveContent.CannotHideAllColumns;env.raiseError(errorMessage);}}}
function createHeaderGroupContainerContextMenu(sheetId,dimension){return createActions([{id:"unfold_all",name:dimension==="ROW"?_t("Expand all row groups"):_t("Expand all column groups"),execute:(env)=>{env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension});},},{id:"fold_all",name:dimension==="ROW"?_t("Collapse all row groups"):_t("Collapse all column groups"),execute:(env)=>{env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension});},},]);}
function getHeaderGroupContextMenu(sheetId,dimension,start,end){const groupActions=createActions([{id:"toggle_group",name:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const groupIsFolded=env.model.getters.isGroupFolded(sheetId,dimension,start,end);if(groupIsFolded){return dimension==="ROW"?_t("Expand row group"):_t("Expand column group");}
else{return dimension==="ROW"?_t("Collapse row group"):_t("Collapse column group");}},execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();interactiveToggleGroup(env,sheetId,dimension,start,end);},},{id:"remove_group",name:dimension==="ROW"?_t("Remove row group"):_t("Remove column group"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension,start,end});},separator:true,},]);return[...groupActions,...createHeaderGroupContainerContextMenu(sheetId,dimension)];}
const groupHeadersMenuRegistry=new MenuItemRegistry();groupHeadersMenuRegistry.add("group_columns",{sequence:10,...groupColumns,isVisible:()=>true,isEnabled:groupColumns.isVisible,}).add("group_rows",{sequence:20,...groupRows,isVisible:()=>true,isEnabled:groupRows.isVisible,});const unGroupHeadersMenuRegistry=new MenuItemRegistry();unGroupHeadersMenuRegistry.add("ungroup_columns",{sequence:10,...ungroupColumns,isEnabled:(env)=>canUngroupHeaders(env,"COL"),}).add("ungroup_rows",{sequence:20,...ungroupRows,isEnabled:(env)=>canUngroupHeaders(env,"ROW"),});css`
  .o-autofill {
    position: absolute;
    height: ${AUTOFILL_EDGE_LENGTH}px;
    width: ${AUTOFILL_EDGE_LENGTH}px;
    border: 1px solid white;
    box-sizing: border-box !important;
    background-color: #1a73e8;
  }

  .o-autofill-handler {
    position: absolute;
    height: ${AUTOFILL_EDGE_LENGTH}px;
    width: ${AUTOFILL_EDGE_LENGTH}px;
    &:hover {
      cursor: crosshair;
    }
  }

  .o-autofill-nextvalue {
    position: absolute;
    background-color: #ffffff;
    border: 1px solid black;
    padding: 5px;
    font-size: 12px;
    pointer-events: none;
    white-space: nowrap;
  }
`;class Autofill extends owl.Component{static template="o-spreadsheet-Autofill";state=owl.useState({position:{left:0,top:0},handler:false,});get style(){const{left,top}=this.props.position;return cssPropertiesToCss({top:`${top}px`,left:`${left}px`,visibility:this.props.isVisible?"visible":"hidden",});}
get handlerStyle(){const{left,top}=this.state.handler?this.state.position:this.props.position;return cssPropertiesToCss({top:`${top}px`,left:`${left}px`,});}
get styleNextValue(){const{left,top}=this.state.position;return cssPropertiesToCss({top:`${top + 5}px`,left:`${left + 15}px`,});}
getTooltip(){const tooltip=this.env.model.getters.getAutofillTooltip();if(tooltip&&!tooltip.component){tooltip.component=TooltipComponent;}
return tooltip;}
onMouseDown(ev){this.state.handler=true;let lastCol;let lastRow;const start={left:ev.clientX-this.props.position.left,top:ev.clientY-this.props.position.top,};const onMouseUp=()=>{this.state.handler=false;this.state.position={...this.props.position};this.env.model.dispatch("AUTOFILL");};const onMouseMove=(col,row,ev)=>{this.state.position={left:ev.clientX-start.left,top:ev.clientY-start.top,};if(lastCol!==col||lastRow!==row){const activeSheetId=this.env.model.getters.getActiveSheetId();const numberOfCols=this.env.model.getters.getNumberCols(activeSheetId);const numberOfRows=this.env.model.getters.getNumberRows(activeSheetId);lastCol=col===-1?lastCol:clip(col,0,numberOfCols);lastRow=row===-1?lastRow:clip(row,0,numberOfRows);if(lastCol!==undefined&&lastRow!==undefined){this.env.model.dispatch("AUTOFILL_SELECT",{col:lastCol,row:lastRow});}}};dragAndDropBeyondTheViewport(this.env,onMouseMove,onMouseUp);}
onDblClick(){this.env.model.dispatch("AUTOFILL_AUTO");}}
Autofill.props={position:Object,isVisible:Boolean,};class TooltipComponent extends owl.Component{static template=owl.xml`
    <div t-esc="props.content"/>
  `;}
TooltipComponent.props={content:String,};css`
  .o-client-tag {
    position: absolute;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    font-size: ${DEFAULT_FONT_SIZE};
    color: white;
    pointer-events: none;
  }
`;class ClientTag extends owl.Component{static template="o-spreadsheet-ClientTag";get tagStyle(){const{col,row,color}=this.props;const{height}=this.env.model.getters.getSheetViewDimensionWithHeaders();const{x,y}=this.env.model.getters.getVisibleRect({left:col,top:row,right:col,bottom:row,});return cssPropertiesToCss({bottom:`${height - y + 15}px`,left:`${x - 1}px`,border:`1px solid ${color}`,"background-color":color,});}}
ClientTag.props={active:Boolean,name:String,color:String,col:Number,row:Number,};function getHtmlContentFromPattern(pattern,value,highlightColor,className){const pendingHtmlContent=[];pattern=pattern.toLowerCase();for(const patternChar of pattern){const index=value.toLocaleLowerCase().indexOf(patternChar);if(index===-1){continue;}
pendingHtmlContent.push({value:value.slice(0,index),color:""},{value:value[index],color:highlightColor,class:className});value=value.slice(index+1);}
pendingHtmlContent.push({value});const htmlContent=pendingHtmlContent.filter((content)=>content.value);return htmlContent;}
css`
  .o-autocomplete-dropdown {
    pointer-events: auto;
    cursor: pointer;
    background-color: #fff;
    max-width: 400px;

    .o-autocomplete-value-focus {
      background-color: #f2f2f2;
    }

    & > div {
      padding: 1px 5px 5px 5px;
      .o-autocomplete-description {
        padding-left: 5px;
        font-size: 11px;
      }
    }
  }
`;class TextValueProvider extends owl.Component{static template="o-spreadsheet-TextValueProvider";autoCompleteListRef=owl.useRef("autoCompleteList");setup(){owl.useEffect(()=>{const selectedIndex=this.props.selectedIndex;if(selectedIndex===undefined){return;}
const selectedElement=this.autoCompleteListRef.el?.children[selectedIndex];selectedElement?.scrollIntoView?.({block:"nearest"});},()=>[this.props.selectedIndex,this.autoCompleteListRef.el]);}}
TextValueProvider.props={values:Array,selectedIndex:{type:Number,optional:true},getHtmlContent:Function,onValueSelected:Function,onValueHovered:Function,};class ContentEditableHelper{el;constructor(el){this.el=el;}
updateEl(el){this.el=el;}
selectRange(start,end){let selection=window.getSelection();const{start:currentStart,end:currentEnd}=this.getCurrentSelection();if(currentStart===start&&currentEnd===end){return;}
const currentRange=selection.getRangeAt(0);let range;if(this.el.contains(currentRange.startContainer)){range=currentRange;}
else{range=document.createRange();selection.removeAllRanges();selection.addRange(range);}
if(start===end&&start===0){range.setStart(this.el,0);range.setEnd(this.el,0);}
else{const textLength=this.getText().length;if(start<0||end>textLength){console.warn(`wrong selection asked start ${start}, end ${end}, text content length ${textLength}`);if(start<0)
start=0;if(end>textLength)
end=textLength;if(start>textLength)
start=textLength;}
let startNode=this.findChildAtCharacterIndex(start);let endNode=this.findChildAtCharacterIndex(end);range.setStart(startNode.node,startNode.offset);selection.extend(endNode.node,endNode.offset);}}
findChildAtCharacterIndex(offset){let it=iterateChildren(this.el);let current,previous;let usedCharacters=offset;let isFirstParagraph=true;do{current=it.next();if(!current.done&&!current.value.hasChildNodes()){if(current.value.textContent&&current.value.textContent.length<usedCharacters){usedCharacters-=current.value.textContent.length;}
else if(current.value.textContent&&current.value.textContent.length>=usedCharacters){it.return(current.value);}
previous=current.value;}
if(!current.done&&current.value.nodeName==="P"){if(isFirstParagraph){isFirstParagraph=false;}
else{usedCharacters--;}}}while(!current.done&&usedCharacters);if(current.value){return{node:current.value,offset:usedCharacters};}
return{node:previous,offset:usedCharacters};}
setText(contents){if(contents.length===0){this.removeAll();return;}
const childElements=Array.from(this.el.childNodes);const contentLength=contents.length;for(let i=0;i<contentLength;i++){const line=contents[i];const childElement=childElements[i];let newChild=false;let p;if(childElement&&childElement.nodeName==="P"){p=childElement;}
else{newChild=true;p=document.createElement("p");}
const lineLength=line.length;const existingChildren=Array.from(p.childNodes);for(let j=0;j<lineLength;j++){const content=line[j];const child=existingChildren[j];const childIsSpan=child&&"tagName"in child&&child.tagName==="SPAN";if(childIsSpan&&compareContentToSpanElement(content,child)){continue;}
if(!content.value&&!content.class){if(child)
p.removeChild(child);continue;}
const span=document.createElement("span");span.innerText=content.value;span.style.color=content.color||"";if(content.class){span.classList.add(content.class);}
if(child){p.replaceChild(span,child);}
else{p.appendChild(span);}}
if(existingChildren.length>lineLength){for(let i=lineLength;i<existingChildren.length;i++){p.removeChild(existingChildren[i]);}}
if(!p.hasChildNodes()){const span=document.createElement("span");span.appendChild(document.createElement("br"));p.appendChild(span);}
if(newChild){if(childElement){this.el.replaceChild(p,childElement);}
else{this.el.appendChild(p);}}}
if(childElements.length>contentLength){for(let i=contentLength;i<childElements.length;i++){this.el.removeChild(childElements[i]);}}}
scrollSelectionIntoView(){const focusedNode=document.getSelection()?.focusNode;if(!focusedNode||!this.el.contains(focusedNode))
return;const element=focusedNode instanceof HTMLElement?focusedNode:focusedNode.parentElement;element?.scrollIntoView({block:"nearest"});}
removeSelection(){let selection=window.getSelection();selection.removeAllRanges();}
removeAll(){if(this.el){while(this.el.firstChild){this.el.removeChild(this.el.firstChild);}}}
getCurrentSelection(){let{startElement,endElement,startSelectionOffset,endSelectionOffset}=this.getStartAndEndSelection();let startSizeBefore=this.findSelectionIndex(startElement,startSelectionOffset);let endSizeBefore=this.findSelectionIndex(endElement,endSelectionOffset);return{start:startSizeBefore,end:endSizeBefore,};}
findSelectionIndex(nodeToFind,nodeOffset){let usedCharacters=0;let it=iterateChildren(this.el);let current=it.next();let isFirstParagraph=true;while(!current.done&&current.value!==nodeToFind){if(!current.value.hasChildNodes()){if(current.value.textContent){usedCharacters+=current.value.textContent.length;}}
if(current.value.nodeName==="P"||(current.value.nodeName==="DIV"&&current.value!==this.el)){if(isFirstParagraph){isFirstParagraph=false;}
else{usedCharacters++;}}
current=it.next();}
if(current.value!==nodeToFind){return 0;}
else{if(!current.value.hasChildNodes()){usedCharacters+=nodeOffset;}
else{const children=[...current.value.childNodes].slice(0,nodeOffset);usedCharacters+=children.reduce((acc,child,index)=>{if(child.textContent!==null){let chars=child.textContent.length;if(child.nodeName==="P"&&index!==children.length-1){chars++;}
return acc+chars;}
else{return acc;}},0);}}
if(nodeToFind.nodeName==="P"&&!isFirstParagraph&&nodeToFind.textContent===""){usedCharacters++;}
return usedCharacters;}
getStartAndEndSelection(){const selection=document.getSelection();return{startElement:selection.anchorNode||this.el,startSelectionOffset:selection.anchorOffset,endElement:selection.focusNode||this.el,endSelectionOffset:selection.focusOffset,};}
getText(){let text="";let it=iterateChildren(this.el);let current=it.next();let isFirstParagraph=true;while(!current.done){if(!current.value.hasChildNodes()){text+=current.value.textContent;}
if(current.value.nodeName==="P"||(current.value.nodeName==="DIV"&&current.value!==this.el)){if(isFirstParagraph){isFirstParagraph=false;}
else{text+=NEWLINE;}}
current=it.next();}
return text;}}
function compareContentToSpanElement(content,node){const contentColor=content.color?toHex(content.color):"";const nodeColor=node.style?.color?toHex(node.style.color):"";const sameColor=contentColor===nodeColor;const sameClass=deepEquals([content.class],[...node.classList]);const sameContent=node.innerText===content.value;return sameColor&&sameClass&&sameContent;}
css`
  .o-formula-assistant {
    background: #ffffff;
    .o-formula-assistant-head {
      background-color: #f2f2f2;
      padding: 10px;
    }
    .o-formula-assistant-core {
      border-bottom: 1px solid gray;
    }
    .o-formula-assistant-arg-description {
      font-size: 85%;
    }
    .o-formula-assistant-focus {
      div:first-child,
      span {
        color: ${COMPOSER_ASSISTANT_COLOR};
        text-shadow: 0px 0px 1px ${COMPOSER_ASSISTANT_COLOR};
      }
      div:last-child {
        color: black;
      }
    }
    .o-formula-assistant-gray {
      color: gray;
    }
  }
`;class FunctionDescriptionProvider extends owl.Component{static template="o-spreadsheet-FunctionDescriptionProvider";assistantState=owl.useState({allowCellSelectionBehind:false,});timeOutId=0;setup(){owl.onWillUnmount(()=>{if(this.timeOutId){clearTimeout(this.timeOutId);}});}
getContext(){return this.props;}
onMouseMove(){this.assistantState.allowCellSelectionBehind=true;if(this.timeOutId){clearTimeout(this.timeOutId);}
this.timeOutId=setTimeout(()=>{this.assistantState.allowCellSelectionBehind=false;},2000);}
get formulaArgSeparator(){return this.env.model.getters.getLocale().formulaArgSeparator+" ";}}
FunctionDescriptionProvider.props={functionName:String,functionDescription:Object,argToFocus:Number,};const functions$2=functionRegistry.content;const ASSISTANT_WIDTH=300;const AUTOCOMPLETE_ENTRIES=10;const selectionIndicatorClass="selector-flag";const selectionIndicatorColor="#a9a9a9";const selectionIndicator="␣";const functionColor="#4a4e4d";const operatorColor="#3da4ab";const tokenColors={OPERATOR:operatorColor,NUMBER:"#02c39a",STRING:"#00a82d",FUNCTION:functionColor,DEBUGGER:operatorColor,LEFT_PAREN:functionColor,RIGHT_PAREN:functionColor,ARG_SEPARATOR:functionColor,MATCHING_PAREN:"#000000",};css`
  .o-composer-container {
    .o-composer {
      overflow-y: auto;
      overflow-x: hidden;
      word-break: break-all;
      padding-right: 2px;

      box-sizing: border-box;
      font-family: ${DEFAULT_FONT};

      caret-color: black;
      padding-left: 3px;
      padding-right: 3px;
      outline: none;

      p {
        margin-bottom: 0px;

        span {
          white-space: pre-wrap;
          &.${selectionIndicatorClass}:after {
            content: "${selectionIndicator}";
            color: ${selectionIndicatorColor};
          }
        }
      }
    }

    .o-composer-assistant {
      position: absolute;
      margin: 1px 4px;
      pointer-events: none;
      overflow: auto;

      .o-semi-bold {
        /** FIXME: to remove in favor of Bootstrap
        * 'fw-semibold' when we upgrade to Bootstrap 5.2
        */
        font-weight: 600 !important;
      }
    }
  }
`;class Composer extends owl.Component{static template="o-spreadsheet-Composer";static components={TextValueProvider,FunctionDescriptionProvider};static defaultProps={inputStyle:"",isDefaultFocus:false,};composerRef=owl.useRef("o_composer");contentHelper=new ContentEditableHelper(this.composerRef.el);composerState=owl.useState({positionStart:0,positionEnd:0,});autoCompleteState=owl.useState({showProvider:false,values:[],selectedIndex:undefined,type:"function",getHtmlContent:()=>[],});functionDescriptionState=owl.useState({showDescription:false,functionName:"",functionDescription:{},argToFocus:0,});compositionActive=false;get assistantStyle(){const assistantStyle={};assistantStyle["min-width"]=`${this.props.rect?.width || ASSISTANT_WIDTH}px`;if(this.autoCompleteState.type==="function"){assistantStyle.width=`${ASSISTANT_WIDTH}px`;}
if(this.props.delimitation&&this.props.rect){const{x:cellX,y:cellY,height:cellHeight}=this.props.rect;const remainingHeight=this.props.delimitation.height-(cellY+cellHeight);assistantStyle["max-height"]=`${remainingHeight}px`;if(cellY>remainingHeight){const availableSpaceAbove=cellY;assistantStyle["max-height"]=`${availableSpaceAbove}px`;assistantStyle.top=`-3px`;assistantStyle.transform=`translate(0, -100%)`;}
if(cellX+ASSISTANT_WIDTH>this.props.delimitation.width){assistantStyle.right=`0px`;}}
return cssPropertiesToCss(assistantStyle);}
shouldProcessInputEvents=false;tokens=[];keyMapping={ArrowUp:this.processArrowKeys,ArrowDown:this.processArrowKeys,ArrowLeft:this.processArrowKeys,ArrowRight:this.processArrowKeys,Enter:this.processEnterKey,Escape:this.processEscapeKey,F2:()=>console.warn("Not implemented"),F4:this.processF4Key,Tab:(ev)=>this.processTabKey(ev),};keyCodeMapping={NumpadDecimal:this.processNumpadDecimal,};setup(){owl.onMounted(()=>{const el=this.composerRef.el;if(this.props.isDefaultFocus){this.env.focusableElement.setFocusableElement(el);}
this.contentHelper.updateEl(el);this.processTokenAtCursor();});owl.useEffect(()=>{this.processContent();});owl.onPatched(()=>{if(this.env.model.getters.getEditionMode()==="inactive"){this.processTokenAtCursor();}});}
processArrowKeys(ev){if(this.env.model.getters.isSelectingForComposer()||this.env.model.getters.getEditionMode()==="inactive"){this.functionDescriptionState.showDescription=false;ev.preventDefault();ev.stopPropagation();updateSelectionWithArrowKeys(ev,this.env.model.selection);return;}
const content=this.env.model.getters.getCurrentContent();if(this.props.focus==="cellFocus"&&!this.autoCompleteState.showProvider&&!content.startsWith("=")){interactiveStopEdition(this.env);return;}
ev.stopPropagation();this.handleArrowKeysForAutocomplete(ev);}
handleArrowKeysForAutocomplete(ev){if(["ArrowUp","ArrowDown"].includes(ev.key)&&this.autoCompleteState.showProvider){ev.preventDefault();if(this.autoCompleteState.selectedIndex===undefined){this.autoCompleteState.selectedIndex=0;return;}
if(ev.key==="ArrowUp"){this.autoCompleteState.selectedIndex--;if(this.autoCompleteState.selectedIndex<0){this.autoCompleteState.selectedIndex=this.autoCompleteState.values.length-1;}}
else{this.autoCompleteState.selectedIndex=(this.autoCompleteState.selectedIndex+1)%this.autoCompleteState.values.length;}}}
processTabKey(ev){ev.preventDefault();ev.stopPropagation();if(this.env.model.getters.getEditionMode()!=="inactive"){const state=this.autoCompleteState;if(state.showProvider&&state.selectedIndex!==undefined){const autoCompleteValue=this.autoCompleteState.values[state.selectedIndex]?.text;if(autoCompleteValue){this.autoComplete(autoCompleteValue);return;}}
interactiveStopEdition(this.env);}
const direction=ev.shiftKey?"left":"right";this.env.model.selection.moveAnchorCell(direction,1);}
processEnterKey(ev){ev.preventDefault();ev.stopPropagation();if(ev.altKey||ev.ctrlKey){this.composerRef.el?.dispatchEvent(new InputEvent("input",{inputType:"insertParagraph",bubbles:true,isComposing:false}));return;}
const state=this.autoCompleteState;if(state.showProvider&&state.selectedIndex!==undefined){const autoCompleteValue=this.autoCompleteState.values[state.selectedIndex]?.text;if(autoCompleteValue){this.autoComplete(autoCompleteValue);return;}}
interactiveStopEdition(this.env);const direction=ev.shiftKey?"up":"down";this.env.model.selection.moveAnchorCell(direction,1);}
processEscapeKey(){this.env.model.dispatch("CANCEL_EDITION");}
processF4Key(){this.env.model.dispatch("CYCLE_EDITION_REFERENCES");this.processContent();}
processNumpadDecimal(ev){ev.stopPropagation();ev.preventDefault();const locale=this.env.model.getters.getLocale();const selection=this.contentHelper.getCurrentSelection();const currentContent=this.env.model.getters.getCurrentContent();const content=currentContent.slice(0,selection.start)+
locale.decimalSeparator+
currentContent.slice(selection.end);this.env.model.dispatch("SET_CURRENT_CONTENT",{content,selection:{start:selection.start+1,end:selection.start+1},});this.processContent();}
onCompositionStart(){this.compositionActive=true;}
onCompositionEnd(){this.compositionActive=false;}
onKeydown(ev){if(this.env.model.getters.getEditionMode()==="inactive"){return;}
let handler=this.keyMapping[ev.key]||this.keyCodeMapping[ev.code];if(handler){handler.call(this,ev);}
else{ev.stopPropagation();}}
onPaste(ev){if(this.env.model.getters.getEditionMode()!=="inactive"){ev.stopPropagation();}}
onInput(ev){if(!this.shouldProcessInputEvents){return;}
if(ev.inputType==="insertFromPaste"&&this.env.model.getters.getEditionMode()==="inactive"){return;}
ev.stopPropagation();let content;if(this.env.model.getters.getEditionMode()==="inactive"){content=ev.data||"";}
else{content=this.contentHelper.getText();}
if(this.props.focus==="inactive"){return this.props.onComposerCellFocused?.(content);}
let selection=this.contentHelper.getCurrentSelection();if(ev.inputType==="insertParagraph"){const start=Math.min(selection.start,selection.end);const end=Math.max(selection.start,selection.end);content=content.slice(0,start)+NEWLINE+content.slice(end);selection={start:start+1,end:start+1};}
this.env.model.dispatch("STOP_COMPOSER_RANGE_SELECTION");this.env.model.dispatch("SET_CURRENT_CONTENT",{content,selection,});this.processTokenAtCursor();}
onKeyup(ev){if(this.contentHelper.el===document.activeElement){if(this.autoCompleteState.showProvider&&["ArrowUp","ArrowDown"].includes(ev.key)){return;}
if(this.env.model.getters.isSelectingForComposer()&&ev.key?.startsWith("Arrow")){return;}
const{start:oldStart,end:oldEnd}=this.env.model.getters.getComposerSelection();const{start,end}=this.contentHelper.getCurrentSelection();if(start!==oldStart||end!==oldEnd){this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start,end});}
this.processTokenAtCursor();}}
showFunctionAutocomplete(searchTerm){const searchTermUpperCase=searchTerm.toUpperCase();if(!this.env.model.getters.getCurrentContent().startsWith("=")||searchTermUpperCase==="TRUE"||searchTermUpperCase==="FALSE"){return;}
this.autoCompleteState.showProvider=true;this.autoCompleteState.type="function";let values=Object.entries(functionRegistry.content).filter(([_,{hidden}])=>!hidden).map(([text,{description}])=>{return{text,description,};}).sort((a,b)=>{return a.text.length-b.text.length||a.text.localeCompare(b.text);});if(searchTerm){values=fuzzyLookup(searchTerm,values,(t)=>t.text).slice(0,AUTOCOMPLETE_ENTRIES);}
this.autoCompleteState.values=values.slice(0,AUTOCOMPLETE_ENTRIES);this.autoCompleteState.getHtmlContent=(value)=>getHtmlContentFromPattern(searchTerm,value,COMPOSER_ASSISTANT_COLOR,"o-semi-bold");this.autoCompleteState.selectedIndex=0;}
updateAutoCompleteIndex(index){this.autoCompleteState.selectedIndex=clip(0,index,10);}
onMousedown(ev){if(ev.button>0){return;}
this.contentHelper.removeSelection();}
onClick(){if(this.env.model.getters.isReadonly()){return;}
const newSelection=this.contentHelper.getCurrentSelection();this.env.model.dispatch("STOP_COMPOSER_RANGE_SELECTION");this.props.onComposerContentFocused();if(this.props.focus==="inactive");this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",newSelection);this.processTokenAtCursor();}
onDblClick(){if(this.env.model.getters.isReadonly()){return;}
const composerContent=this.env.model.getters.getCurrentContent();const isValidFormula=composerContent.startsWith("=");if(isValidFormula){const tokens=this.env.model.getters.getCurrentTokens();const currentSelection=this.contentHelper.getCurrentSelection();if(currentSelection.start===currentSelection.end)
return;const currentSelectedText=composerContent.substring(currentSelection.start,currentSelection.end);const token=tokens.filter((token)=>token.value.includes(currentSelectedText)&&token.start<=currentSelection.start&&token.end>=currentSelection.end)[0];if(!token){return;}
if(token.type==="REFERENCE"){this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start:token.start,end:token.end,});}}}
onContextMenu(ev){if(this.env.model.getters.getEditionMode()==="inactive"){this.props.onInputContextMenu?.(ev);}}
processContent(){if(this.compositionActive){return;}
this.shouldProcessInputEvents=false;if(this.props.focus!=="inactive"){this.contentHelper.el.focus();}
const content=this.getContentLines();this.contentHelper.setText(content);if(content.length!==0&&content.length[0]!==0){if(this.props.focus!=="inactive"){const{start,end}=this.env.model.getters.getComposerSelection();this.contentHelper.selectRange(start,end);}
this.contentHelper.scrollSelectionIntoView();}
this.shouldProcessInputEvents=true;}
getContentLines(){let value=this.env.model.getters.getCurrentContent();const isValidFormula=value.startsWith("=");if(value===""){return[];}
else if(isValidFormula&&this.props.focus!=="inactive"){return this.splitHtmlContentIntoLines(this.getColoredTokens());}
return this.splitHtmlContentIntoLines([{value}]);}
getColoredTokens(){const tokens=this.env.model.getters.getCurrentTokens();const tokenAtCursor=this.env.model.getters.getTokenAtCursor();const result=[];const{end,start}=this.env.model.getters.getComposerSelection();for(const token of tokens){switch(token.type){case"OPERATOR":case"NUMBER":case"ARG_SEPARATOR":case"STRING":result.push({value:token.value,color:tokenColors[token.type]||"#000"});break;case"REFERENCE":const{xc,sheetName}=splitReference(token.value);result.push({value:token.value,color:this.rangeColor(xc,sheetName)||"#000"});break;case"SYMBOL":const value=token.value;const upperCaseValue=value.toUpperCase();if(upperCaseValue==="TRUE"||upperCaseValue==="FALSE"){result.push({value:token.value,color:tokenColors.NUMBER});}
else if(upperCaseValue in functionRegistry.content){result.push({value:token.value,color:tokenColors.FUNCTION});}
else{result.push({value:token.value,color:"#000"});}
break;case"LEFT_PAREN":case"RIGHT_PAREN":if(tokenAtCursor&&["LEFT_PAREN","RIGHT_PAREN"].includes(tokenAtCursor.type)&&tokenAtCursor.parenIndex&&tokenAtCursor.parenIndex===token.parenIndex){result.push({value:token.value,color:tokenColors.MATCHING_PAREN});}
else{result.push({value:token.value,color:tokenColors[token.type]||"#000"});}
break;default:result.push({value:token.value,color:"#000"});break;}
if(this.env.model.getters.showSelectionIndicator()&&end===start&&end===token.end){result[result.length-1].class=selectionIndicatorClass;}}
return result;}
splitHtmlContentIntoLines(contents){const contentSplitInLines=[];let currentLine=[];for(const content of contents){if(content.value.includes(NEWLINE)){const lines=content.value.split(NEWLINE);const lastLine=lines.pop();for(const line of lines){currentLine.push({color:content.color,value:line});contentSplitInLines.push(currentLine);currentLine=[];}
currentLine.push({...content,value:lastLine});}
else{currentLine.push(content);}}
if(currentLine.length){contentSplitInLines.push(currentLine);}
const filteredLines=[];for(const line of contentSplitInLines){if(line.every(this.isContentEmpty)){filteredLines.push([line[0]]);}
else{filteredLines.push(line.filter((content)=>!this.isContentEmpty(content)));}}
return filteredLines;}
isContentEmpty(content){return!(content.value||content.class);}
rangeColor(xc,sheetName){if(this.props.focus==="inactive"){return undefined;}
const highlights=this.env.model.getters.getHighlights();const refSheet=sheetName?this.env.model.getters.getSheetIdByName(sheetName):this.env.model.getters.getCurrentEditedCell()?.sheetId;const highlight=highlights.find((highlight)=>{if(highlight.sheetId!==refSheet)
return false;const range=this.env.model.getters.getRangeFromSheetXC(refSheet,xc);let zone=range.zone;zone=getZoneArea(zone)===1?this.env.model.getters.expandZone(refSheet,zone):zone;return isEqual(zone,highlight.zone);});return highlight&&highlight.color?highlight.color:undefined;}
processTokenAtCursor(){let content=this.env.model.getters.getCurrentContent();this.autoCompleteState.showProvider=false;this.functionDescriptionState.showDescription=false;const dataValidationAutocompleteValues=this.env.model.getters.getAutoCompleteDataValidationValues();if(!content.startsWith("=")&&dataValidationAutocompleteValues.length){this.showDataValidationAutocomplete(dataValidationAutocompleteValues);}
if(content.startsWith("=")){const token=this.env.model.getters.getTokenAtCursor();if(!token){return;}
if(token.type==="SYMBOL"){this.showFunctionAutocomplete(token.value);return;}
const tokenContext=token.functionContext;const parentFunction=tokenContext?.parent.toUpperCase();if(tokenContext&&parentFunction&&parentFunction in functions$2&&token.type!=="UNKNOWN"){const description=functions$2[parentFunction];const argPosition=tokenContext.argPosition;this.functionDescriptionState.functionName=parentFunction;this.functionDescriptionState.functionDescription=description;this.functionDescriptionState.argToFocus=description.getArgToFocus(argPosition+1)-1;this.functionDescriptionState.showDescription=true;}}}
autoComplete(value){if(!value){return;}
if(this.autoCompleteState.type==="function"){const tokenAtCursor=this.env.model.getters.getTokenAtCursor();if(tokenAtCursor){let start=tokenAtCursor.end;let end=tokenAtCursor.end;if(["SYMBOL","FUNCTION"].includes(tokenAtCursor.type)){start=tokenAtCursor.start;}
const tokens=this.env.model.getters.getCurrentTokens();if(tokens.length){value+="(";const currentTokenIndex=tokens.map((token)=>token.start).indexOf(tokenAtCursor.start);if(currentTokenIndex+1<tokens.length){const nextToken=tokens[currentTokenIndex+1];if(nextToken.type==="LEFT_PAREN"){end++;}}}
this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start,end});}
this.env.model.dispatch("REPLACE_COMPOSER_CURSOR_SELECTION",{text:value});}
else{this.env.model.dispatch("SET_CURRENT_CONTENT",{content:value});this.env.model.dispatch("STOP_EDITION");}
this.processTokenAtCursor();}
showDataValidationAutocomplete(values){this.autoCompleteState.showProvider=true;this.autoCompleteState.type="dataValidation";this.autoCompleteState.selectedIndex=undefined;this.autoCompleteState.values=values.map((value)=>({text:value,description:""}));this.autoCompleteState.getHtmlContent=(value)=>[{value}];}}
Composer.props={inputStyle:{type:String,optional:true},rect:{type:Object,optional:true},delimitation:{type:Object,optional:true},focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerCellFocused:{type:Function,optional:true},onComposerContentFocused:Function,isDefaultFocus:{type:Boolean,optional:true},onInputContextMenu:{type:Function,optional:true},};const COMPOSER_BORDER_WIDTH=3*0.4*window.devicePixelRatio||1;const GRID_CELL_REFERENCE_TOP_OFFSET=28;css`
  div.o-grid-composer {
    z-index: ${ComponentsImportance.GridComposer};
    box-sizing: border-box;
    position: absolute;
    border: ${COMPOSER_BORDER_WIDTH}px solid ${SELECTION_BORDER_COLOR};

    display: flex;
    align-items: center;
  }

  div.o-cell-reference {
    position: absolute;
    z-index: ${ComponentsImportance.GridComposer};
    background: ${SELECTION_BORDER_COLOR};
    color: white;
    font-size: 12px;
    line-height: 14px;
    padding: 6px 7px;
    border-radius: 4px;
  }
`;class GridComposer extends owl.Component{static template="o-spreadsheet-GridComposer";static components={Composer};rect=this.defaultRect;isEditing=false;isCellReferenceVisible;get defaultRect(){return{x:0,y:0,width:0,height:0};}
setup(){owl.onWillUpdateProps(()=>{this.updateComponentPosition();this.updateCellReferenceVisibility();});}
get shouldDisplayCellReference(){return this.isCellReferenceVisible;}
get cellReference(){if(!this.env.model.getters.getCurrentEditedCell()){return"";}
const{col,row,sheetId}=this.env.model.getters.getCurrentEditedCell();const prefixSheet=sheetId!==this.env.model.getters.getActiveSheetId();return`${prefixSheet ? getCanonicalSheetName(this.env.model.getters.getSheetName(sheetId)) + "!" : ""}${toXC(col, row)}`;}
get cellReferenceStyle(){const{x:left,y:top}=this.rect;return cssPropertiesToCss({left:`${left - COMPOSER_BORDER_WIDTH}px`,top:`${top - GRID_CELL_REFERENCE_TOP_OFFSET}px`,});}
get composerProps(){const{width,height}=this.env.model.getters.getSheetViewDimensionWithHeaders();return{rect:{...this.rect},delimitation:{width,height,},focus:this.props.focus,isDefaultFocus:true,onComposerContentFocused:this.props.onComposerContentFocused,onComposerCellFocused:this.props.onComposerCellFocused,onInputContextMenu:this.props.onInputContextMenu,};}
get containerStyle(){if(this.env.model.getters.getEditionMode()==="inactive"||!this.rect){return`
        position: absolute;
        z-index: -1000;
      `;}
const isFormula=this.env.model.getters.getCurrentContent().startsWith("=");const cell=this.env.model.getters.getActiveCell();const position=this.env.model.getters.getActivePosition();const style=this.env.model.getters.getCellComputedStyle(position);const{x:left,y:top,width,height}=this.rect;const background=(!isFormula&&style.fillColor)||"#ffffff";const color=(!isFormula&&style.textColor)||"#000000";const fontSize=(!isFormula&&style.fontSize)||10;const fontWeight=!isFormula&&style.bold?"bold":undefined;const fontStyle=!isFormula&&style.italic?"italic":"normal";const textDecoration=!isFormula?getTextDecoration(style):"none";let textAlign="left";if(!isFormula){textAlign=style.align||cell.defaultAlign;}
const maxHeight=this.props.gridDims.height-this.rect.y;const maxWidth=this.props.gridDims.width-this.rect.x;return cssPropertiesToCss({left:`${left - 1}px`,top:`${top}px`,"min-width":`${width + 1}px`,"min-height":`${height + 1}px`,"max-width":`${maxWidth}px`,"max-height":`${maxHeight}px`,background,color,"font-size":`${fontSizeInPixels(fontSize)}px`,"font-weight":fontWeight,"font-style":fontStyle,"text-decoration":textDecoration,"text-align":textAlign,});}
updateComponentPosition(){const isEditing=this.env.model.getters.getEditionMode()!=="inactive";if(this.isEditing!==isEditing){this.isEditing=isEditing;if(!isEditing){this.rect=this.defaultRect;this.env.focusableElement.focus();return;}
const position=this.env.model.getters.getActivePosition();const zone=this.env.model.getters.expandZone(position.sheetId,positionToZone(position));this.rect=this.env.model.getters.getVisibleRect(zone);}}
updateCellReferenceVisibility(){if(this.env.model.getters.getEditionMode()==="inactive"){this.isCellReferenceVisible=false;return;}
if(this.isCellReferenceVisible){return;}
const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect(zone);if(!deepEquals(rect,this.rect)||sheetId!==this.env.model.getters.getCurrentEditedCell().sheetId){this.isCellReferenceVisible=true;}}}
GridComposer.props={focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerContentFocused:Function,gridDims:Object,onComposerCellFocused:Function,onInputContextMenu:Function,};const CSS$1=css`
  .o-grid-cell-icon {
    width: ${GRID_ICON_EDGE_LENGTH}px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
  }
`;class GridCellIcon extends owl.Component{static style=CSS$1;static template="o-spreadsheet-GridCellIcon";get iconStyle(){const cellPosition=this.props.cellPosition;const merge=this.env.model.getters.getMerge(cellPosition);const zone=merge||positionToZone(cellPosition);const rect=this.env.model.getters.getVisibleRectWithoutHeaders(zone);const x=this.getIconHorizontalPosition(rect,cellPosition);const y=this.getIconVerticalPosition(rect,cellPosition);return cssPropertiesToCss({top:`${y + (this.props.offset?.y || 0)}px`,left:`${x + (this.props.offset?.x || 0)}px`,});}
getIconVerticalPosition(rect,cellPosition){const start=rect.y;const end=rect.y+rect.height;const cell=this.env.model.getters.getCell(cellPosition);const align=this.props.verticalAlign||cell?.style?.verticalAlign||DEFAULT_VERTICAL_ALIGN;switch(align){case"bottom":return end-GRID_ICON_MARGIN-GRID_ICON_EDGE_LENGTH;case"top":return start+GRID_ICON_MARGIN;default:const centeringOffset=Math.floor((end-start-GRID_ICON_EDGE_LENGTH)/2);return end-GRID_ICON_EDGE_LENGTH-centeringOffset;}}
getIconHorizontalPosition(rect,cellPosition){const start=rect.x;const end=rect.x+rect.width;const cell=this.env.model.getters.getCell(cellPosition);const evaluatedCell=this.env.model.getters.getEvaluatedCell(cellPosition);const align=this.props.horizontalAlign||cell?.style?.align||evaluatedCell.defaultAlign;switch(align){case"right":return end-GRID_ICON_MARGIN-GRID_ICON_EDGE_LENGTH;case"left":return start+GRID_ICON_MARGIN;default:const centeringOffset=Math.floor((end-start-GRID_ICON_EDGE_LENGTH)/2);return end-GRID_ICON_EDGE_LENGTH-centeringOffset;}}
isPositionVisible(position){const rect=this.env.model.getters.getVisibleRect(positionToZone(position));return!(rect.width===0||rect.height===0);}}
GridCellIcon.props={cellPosition:Object,horizontalAlign:{type:String,optional:true},verticalAlign:{type:String,optional:true},offset:{type:Object,optional:true},slots:Object,};const CSS=css`
  .o-filter-icon {
    color: ${FILTERS_COLOR};
    display: flex;
    align-items: center;
    justify-content: center;
    width: ${GRID_ICON_EDGE_LENGTH}px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
  }
  .o-filter-icon:hover {
    background: ${FILTERS_COLOR};
    color: #fff;
  }
`;class FilterIcon extends owl.Component{static style=CSS;static template="o-spreadsheet-FilterIcon";onClick(){const position=this.props.cellPosition;const activePopoverType=this.env.model.getters.getPersistentPopoverTypeAtPosition(position);if(activePopoverType&&activePopoverType==="FilterMenu"){this.env.model.dispatch("CLOSE_CELL_POPOVER");return;}
const{col,row}=position;this.env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"FilterMenu",});}
get isFilterActive(){return this.env.model.getters.isFilterActive(this.props.cellPosition);}}
FilterIcon.props={cellPosition:Object,};class FilterIconsOverlay extends owl.Component{static template="o-spreadsheet-FilterIconsOverlay";static components={GridCellIcon,FilterIcon,};static defaultProps={gridPosition:{x:0,y:0},};getFilterHeadersPositions(){const sheetId=this.env.model.getters.getActiveSheetId();const headerPositions=this.env.model.getters.getFilterHeaders(sheetId);return headerPositions.map((position)=>({sheetId,...position}));}}
FilterIconsOverlay.props={gridPosition:{type:Object,optional:true},};const CHECKBOX_WIDTH=15;const MARGIN=(GRID_ICON_EDGE_LENGTH-CHECKBOX_WIDTH)/2;css`
  .o-dv-checkbox {
    box-sizing: border-box !important;
    width: ${CHECKBOX_WIDTH}px;
    height: ${CHECKBOX_WIDTH}px;
    accent-color: #808080;
    margin: ${MARGIN}px;
    /** required to prevent the checkbox position to be sensible to the font-size (affects Firefox) */
    position: absolute;
  }
`;class DataValidationCheckbox extends owl.Component{static template="o-spreadsheet-DataValidationCheckbox";onCheckboxChange(ev){const newValue=ev.target.checked;const{sheetId,col,row}=this.props.cellPosition;const cellContent=newValue?"TRUE":"FALSE";this.env.model.dispatch("UPDATE_CELL",{sheetId,col,row,content:cellContent});}
get checkBoxValue(){return!!this.env.model.getters.getEvaluatedCell(this.props.cellPosition).value;}
get isDisabled(){const cell=this.env.model.getters.getCell(this.props.cellPosition);return this.env.model.getters.isReadonly()||!!cell?.isFormula;}}
DataValidationCheckbox.props={cellPosition:Object,};const ICON_WIDTH=13;css`
  .o-dv-list-icon {
    color: #808080;
    border-radius: 1px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
    width: ${GRID_ICON_EDGE_LENGTH}px;

    &:hover {
      color: #ffffff;
      background-color: #808080;
    }

    svg {
      width: ${ICON_WIDTH}px;
      height: ${ICON_WIDTH}px;
    }
  }
`;class DataValidationListIcon extends owl.Component{static template="o-spreadsheet-DataValidationListIcon";onClick(){const{col,row}=this.props.cellPosition;this.env.model.selection.selectCell(col,row);this.env.startCellEdition();}}
DataValidationListIcon.props={cellPosition:Object,};class DataValidationOverlay extends owl.Component{static template="o-spreadsheet-DataValidationOverlay";static components={GridCellIcon,DataValidationCheckbox,DataValidationListIcon};get checkBoxCellPositions(){return this.env.model.getters.getVisibleCellPositions().filter(this.env.model.getters.isCellValidCheckbox);}
get listIconsCellPositions(){if(this.env.model.getters.isReadonly()){return[];}
return this.env.model.getters.getVisibleCellPositions().filter(this.env.model.getters.cellHasListDataValidationIcon);}}
DataValidationOverlay.props={};function internalFigureToScreen(getters,fig){return{...fig,...internalToScreenCoordinates(getters,{x:fig.x,y:fig.y})};}
function screenFigureToInternal(getters,fig){return{...fig,...screenCoordinatesToInternal(getters,{x:fig.x,y:fig.y})};}
function internalToScreenCoordinates(getters,{x,y}){const{x:viewportX,y:viewportY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();x=x<viewportX?x:x-scrollX;y=y<viewportY?y:y-scrollY;return{x,y};}
function screenCoordinatesToInternal(getters,{x,y}){const{x:viewportX,y:viewportY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();x=viewportX&&x<viewportX?x:x+scrollX;y=viewportY&&y<viewportY?y:y+scrollY;return{x,y};}
function dragFigureForMove({x:mouseX,y:mouseY},{x:mouseInitialX,y:mouseInitialY},initialFigure,{x:viewportX,y:viewportY},{maxX,maxY},{scrollX,scrollY}){const minX=viewportX?0:-scrollX;const minY=viewportY?0:-scrollY;const deltaX=mouseX-mouseInitialX;const newX=clamp(initialFigure.x+deltaX,minX,maxX-initialFigure.width-scrollX);const deltaY=mouseY-mouseInitialY;const newY=clamp(initialFigure.y+deltaY,minY,maxY-initialFigure.height-scrollY);return{...initialFigure,x:newX,y:newY};}
function clamp(value,min,max){return Math.min(Math.max(value,min),max);}
function dragFigureForResize(initialFigure,dirX,dirY,{x:mouseX,y:mouseY},{x:mouseInitialX,y:mouseInitialY},keepRatio,minFigSize,{scrollX,scrollY}){let{x,y,width,height}=initialFigure;if(keepRatio&&dirX!=0&&dirY!=0){const deltaX=Math.min(dirX*(mouseInitialX-mouseX),initialFigure.width-minFigSize);const deltaY=Math.min(dirY*(mouseInitialY-mouseY),initialFigure.height-minFigSize);const fraction=Math.min(deltaX/initialFigure.width,deltaY/initialFigure.height);width=initialFigure.width*(1-fraction);height=initialFigure.height*(1-fraction);if(dirX<0){x=initialFigure.x+initialFigure.width*fraction;}
if(dirY<0){y=initialFigure.y+initialFigure.height*fraction;}}
else{const deltaX=Math.max(dirX*(mouseX-mouseInitialX),minFigSize-initialFigure.width);const deltaY=Math.max(dirY*(mouseY-mouseInitialY),minFigSize-initialFigure.height);width=initialFigure.width+deltaX;height=initialFigure.height+deltaY;if(dirX<0){x=initialFigure.x-deltaX;}
if(dirY<0){y=initialFigure.y-deltaY;}}
if(x+scrollX<=0){width=width+x+scrollX;x=-scrollX;}
if(y+scrollY<=0){height=height+y+scrollY;y=-scrollY;}
return{...initialFigure,x,y,width,height};}
const SNAP_MARGIN=5;function snapForMove(getters,figureToSnap,otherFigures){const snappedFigure={...figureToSnap};const verticalSnapLine=getSnapLine(getters,snappedFigure,["hCenter","right","left"],otherFigures,["hCenter","right","left"]);const horizontalSnapLine=getSnapLine(getters,snappedFigure,["vCenter","bottom","top"],otherFigures,["vCenter","bottom","top"]);const{y:viewportY,x:viewportX}=getters.getMainViewportCoordinates();const{scrollY,scrollX}=getters.getActiveSheetScrollInfo();if(horizontalSnapLine){snappedFigure.y-=horizontalSnapLine.snapOffset;const isBaseFigFrozenY=figureToSnap.y<viewportY;const isSnappedFrozenY=snappedFigure.y<viewportY;if(isBaseFigFrozenY&&!isSnappedFrozenY)
snappedFigure.y+=scrollY;else if(!isBaseFigFrozenY&&isSnappedFrozenY)
snappedFigure.y-=scrollY;}
if(verticalSnapLine){snappedFigure.x-=verticalSnapLine.snapOffset;const isBaseFigFrozenX=figureToSnap.x<viewportX;const isSnappedFrozenX=snappedFigure.x<viewportX;if(isBaseFigFrozenX&&!isSnappedFrozenX)
snappedFigure.x+=scrollX;else if(!isBaseFigFrozenX&&isSnappedFrozenX)
snappedFigure.x-=scrollX;}
return{snappedFigure,verticalSnapLine,horizontalSnapLine};}
function snapForResize(getters,resizeDirX,resizeDirY,figureToSnap,otherFigures){const snappedFigure={...figureToSnap};const verticalSnapLine=getSnapLine(getters,snappedFigure,[resizeDirX===-1?"left":"right"],otherFigures,["right","left"]);if(verticalSnapLine){if(resizeDirX===1){snappedFigure.width-=verticalSnapLine.snapOffset;}
else if(resizeDirX===-1){snappedFigure.x-=verticalSnapLine.snapOffset;snappedFigure.width+=verticalSnapLine.snapOffset;}}
const horizontalSnapLine=getSnapLine(getters,snappedFigure,[resizeDirY===-1?"top":"bottom"],otherFigures,["bottom","top"]);if(horizontalSnapLine){if(resizeDirY===1){snappedFigure.height-=horizontalSnapLine.snapOffset;}
else if(resizeDirY===-1){snappedFigure.y-=horizontalSnapLine.snapOffset;snappedFigure.height+=horizontalSnapLine.snapOffset;}}
snappedFigure.x=Math.round(snappedFigure.x);snappedFigure.y=Math.round(snappedFigure.y);snappedFigure.height=Math.round(snappedFigure.height);snappedFigure.width=Math.round(snappedFigure.width);return{snappedFigure,verticalSnapLine,horizontalSnapLine};}
function getVisibleAxes(getters,figure,axesTypes){const axes=axesTypes.map((axisType)=>getAxis(figure,axisType));return axes.filter((axis)=>isAxisVisible(getters,figure,axis)).map((axis)=>getAxisScreenPosition(getters,figure,axis));}
function getAxisScreenPosition(getters,figure,figureAxis){const screenFigure=internalFigureToScreen(getters,figure);return getAxis(screenFigure,figureAxis.axisType);}
function isAxisVisible(getters,figure,axis){const{x:mainViewportX,y:mainViewportY}=getters.getMainViewportCoordinates();const axisStartEndPositions=[];switch(axis.axisType){case"top":case"bottom":case"vCenter":if(figure.y<mainViewportY)
return true;axisStartEndPositions.push({x:figure.x,y:axis.position});axisStartEndPositions.push({x:figure.x+figure.width,y:axis.position});break;case"left":case"right":case"hCenter":if(figure.x<mainViewportX)
return true;axisStartEndPositions.push({x:axis.position,y:figure.y});axisStartEndPositions.push({x:axis.position,y:figure.y+figure.height});break;}
return axisStartEndPositions.some(getters.isPositionVisible);}
function getSnapLine(getters,figureToSnap,figAxesTypes,otherFigures,otherAxesTypes){const axesOfFigure=getVisibleAxes(getters,figureToSnap,figAxesTypes);let closestMatch=undefined;for(const otherFigure of otherFigures){const axesOfOtherFig=getVisibleAxes(getters,otherFigure,otherAxesTypes);for(const axisOfFigure of axesOfFigure){for(const axisOfOtherFig of axesOfOtherFig){if(!canSnap(axisOfFigure.position,axisOfOtherFig.position))
continue;const snapOffset=axisOfFigure.position-axisOfOtherFig.position;if(closestMatch&&snapOffset===closestMatch.snapOffset){closestMatch.matchedFigIds.push(otherFigure.id);}
else if(!closestMatch||Math.abs(snapOffset)<=Math.abs(closestMatch.snapOffset)){closestMatch={matchedFigIds:[otherFigure.id],snapOffset,snappedAxisType:axisOfFigure.axisType,position:axisOfOtherFig.position,};}}}}
return closestMatch;}
function canSnap(axisPosition1,axisPosition2){return Math.abs(axisPosition1-axisPosition2)<=SNAP_MARGIN;}
function getAxis(fig,axisType){let position=0;switch(axisType){case"top":position=fig.y;break;case"bottom":position=fig.y+fig.height-FIGURE_BORDER_WIDTH;break;case"vCenter":position=fig.y+Math.floor(fig.height/2)-FIGURE_BORDER_WIDTH;break;case"left":position=fig.x;break;case"right":position=fig.x+fig.width-FIGURE_BORDER_WIDTH;break;case"hCenter":position=fig.x+Math.floor(fig.width/2)-FIGURE_BORDER_WIDTH;break;}
return{position,axisType:axisType};}
css`
  .o-figure-snap-line {
    position: relative;
    z-index: ${ComponentsImportance.FigureSnapLine};
    &.vertical {
      width: 0px;
      border-left: 1px dashed black;
    }
    &.horizontal {
      border-top: 1px dashed black;
      height: 0px;
    }
  }
  .o-figure-container {
    -webkit-user-select: none; // safari
    user-select: none;
  }
`;class FiguresContainer extends owl.Component{static template="o-spreadsheet-FiguresContainer";static components={FigureComponent};dnd=owl.useState({draggedFigure:undefined,horizontalSnap:undefined,verticalSnap:undefined,});setup(){owl.onMounted(()=>{this.render();});}
getVisibleFigures(){const visibleFigures=this.env.model.getters.getVisibleFigures();if(this.dnd.draggedFigure&&!visibleFigures.some((figure)=>figure.id===this.dnd.draggedFigure?.id)){visibleFigures.push(this.env.model.getters.getFigure(this.env.model.getters.getActiveSheetId(),this.dnd.draggedFigure?.id));}
return visibleFigures;}
get containers(){const visibleFigures=this.getVisibleFigures();const containers=[];for(const containerType of["topLeft","topRight","bottomLeft","bottomRight",]){const containerFigures=visibleFigures.filter((figure)=>this.getFigureContainer(figure)===containerType);if(containerFigures.length>0){containers.push({type:containerType,figures:containerFigures,style:this.getContainerStyle(containerType),inverseViewportStyle:this.getInverseViewportPositionStyle(containerType),});}}
if(this.dnd.draggedFigure){containers.push({type:"dnd",figures:[this.getDndFigure()],style:this.getContainerStyle("dnd"),inverseViewportStyle:this.getInverseViewportPositionStyle("dnd"),});}
return containers;}
getContainerStyle(container){return this.rectToCss(this.getContainerRect(container));}
rectToCss(rect){return cssPropertiesToCss({left:`${rect.x}px`,top:`${rect.y}px`,width:`${rect.width}px`,height:`${rect.height}px`,});}
getContainerRect(container){const{width:viewWidth,height:viewHeight}=this.env.model.getters.getMainViewportRect();const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();const x=["bottomRight","topRight"].includes(container)?viewportX:0;const width=viewWidth-x;const y=["bottomRight","bottomLeft"].includes(container)?viewportY:0;const height=viewHeight-y;return{x,y,width,height};}
getInverseViewportPositionStyle(container){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();const left=["bottomRight","topRight"].includes(container)?-(viewportX+scrollX):0;const top=["bottomRight","bottomLeft"].includes(container)?-(viewportY+scrollY):0;return cssPropertiesToCss({left:`${left}px`,top:`${top}px`,});}
getFigureContainer(figure){const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();if(figure.id===this.dnd.draggedFigure?.id){return"dnd";}
else if(figure.x<viewportX&&figure.y<viewportY){return"topLeft";}
else if(figure.x<viewportX){return"bottomLeft";}
else if(figure.y<viewportY){return"topRight";}
else{return"bottomRight";}}
startDraggingFigure(figure,ev){if(ev.button>0||this.env.model.getters.isReadonly()){return;}
const selectResult=this.env.model.dispatch("SELECT_FIGURE",{id:figure.id});if(!selectResult.isSuccessful){return;}
const sheetId=this.env.model.getters.getActiveSheetId();const initialMousePosition={x:ev.clientX,y:ev.clientY};const maxDimensions={maxX:this.env.model.getters.getColDimensions(sheetId,this.env.model.getters.getNumberCols(sheetId)-1).end,maxY:this.env.model.getters.getRowDimensions(sheetId,this.env.model.getters.getNumberRows(sheetId)-1).end,};const{x,y}=internalFigureToScreen(this.env.model.getters,figure);const initialFig={...figure,x,y};const onMouseMove=(ev)=>{const getters=this.env.model.getters;const currentMousePosition={x:ev.clientX,y:ev.clientY};const draggedFigure=dragFigureForMove(currentMousePosition,initialMousePosition,initialFig,this.env.model.getters.getMainViewportCoordinates(),maxDimensions,getters.getActiveSheetScrollInfo());const otherFigures=this.getOtherFigures(figure.id);const internalDragged=screenFigureToInternal(getters,draggedFigure);const snapResult=snapForMove(getters,internalDragged,otherFigures);this.dnd.draggedFigure=internalFigureToScreen(getters,snapResult.snappedFigure);this.dnd.horizontalSnap=this.getSnap(snapResult.horizontalSnapLine);this.dnd.verticalSnap=this.getSnap(snapResult.verticalSnapLine);};const onMouseUp=(ev)=>{if(!this.dnd.draggedFigure){return;}
let{x,y}=screenFigureToInternal(this.env.model.getters,this.dnd.draggedFigure);this.dnd.draggedFigure=undefined;this.dnd.horizontalSnap=undefined;this.dnd.verticalSnap=undefined;this.env.model.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,x,y});};startDnd(onMouseMove,onMouseUp);}
startResize(figure,dirX,dirY,ev){ev.stopPropagation();const initialMousePosition={x:ev.clientX,y:ev.clientY};const{x,y}=internalFigureToScreen(this.env.model.getters,figure);const initialFig={...figure,x,y};const keepRatio=figureRegistry.get(figure.tag).keepRatio||false;const minFigSize=figureRegistry.get(figure.tag).minFigSize||MIN_FIG_SIZE;const onMouseMove=(ev)=>{const currentMousePosition={x:ev.clientX,y:ev.clientY};const draggedFigure=dragFigureForResize(initialFig,dirX,dirY,currentMousePosition,initialMousePosition,keepRatio,minFigSize,this.env.model.getters.getActiveSheetScrollInfo());const otherFigures=this.getOtherFigures(figure.id);const snapResult=snapForResize(this.env.model.getters,dirX,dirY,draggedFigure,otherFigures);this.dnd.draggedFigure=snapResult.snappedFigure;this.dnd.horizontalSnap=this.getSnap(snapResult.horizontalSnapLine);this.dnd.verticalSnap=this.getSnap(snapResult.verticalSnapLine);};const onMouseUp=(ev)=>{if(!this.dnd.draggedFigure){return;}
let{x,y}=screenFigureToInternal(this.env.model.getters,this.dnd.draggedFigure);const update={x,y};if(dirX){update.width=this.dnd.draggedFigure.width;}
if(dirY){update.height=this.dnd.draggedFigure.height;}
this.env.model.dispatch("UPDATE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,...update,});this.dnd.draggedFigure=undefined;this.dnd.horizontalSnap=undefined;this.dnd.verticalSnap=undefined;};startDnd(onMouseMove,onMouseUp);}
getOtherFigures(figId){return this.getVisibleFigures().filter((f)=>f.id!==figId);}
getDndFigure(){const figure=this.getVisibleFigures().find((fig)=>fig.id===this.dnd.draggedFigure?.id);if(!figure)
throw new Error("Dnd figure not found");return{...figure,...this.dnd.draggedFigure,};}
getFigureStyle(figure){if(figure.id!==this.dnd.draggedFigure?.id)
return"";return cssPropertiesToCss({opacity:"0.9",cursor:"grabbing",});}
getSnap(snapLine){if(!snapLine||!this.dnd.draggedFigure)
return undefined;const figureVisibleRects=snapLine.matchedFigIds.map((id)=>this.getVisibleFigures().find((fig)=>fig.id===id)).filter(isDefined$1).map((fig)=>{const figOnSCreen=internalFigureToScreen(this.env.model.getters,fig);const container=this.getFigureContainer(fig);return rectIntersection(figOnSCreen,this.getContainerRect(container));}).filter(isDefined$1);const containerRect=rectUnion(this.dnd.draggedFigure,...figureVisibleRects);return{line:snapLine,containerStyle:this.rectToCss(containerRect),lineStyle:this.getSnapLineStyle(snapLine,containerRect),};}
getSnapLineStyle(snapLine,containerRect){if(!snapLine)
return"";if(["top","vCenter","bottom"].includes(snapLine.snappedAxisType)){return cssPropertiesToCss({top:`${snapLine.position - containerRect.y}px`,left:`0px`,width:`100%`,});}
else{return cssPropertiesToCss({top:`0px`,left:`${snapLine.position - containerRect.x}px`,height:`100%`,});}}}
FiguresContainer.props={onFigureDeleted:Function,};css`
  .o-grid-add-rows {
    input {
      box-sizing: border-box;
      width: 60px;
      height: 30px;
    }

    .o-validation-error {
      display: inline-block !important;
      margin-top: 0;
      margin-left: 8px;
    }
  }
`;class GridAddRowsFooter extends owl.Component{static template="o-spreadsheet-GridAddRowsFooter";static components={ValidationMessages};inputRef=owl.useRef("inputRef");state=owl.useState({inputValue:"100",errorFlag:false,});setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});}
get addRowsPosition(){const activeSheetId=this.env.model.getters.getActiveSheetId();const{numberOfRows}=this.env.model.getters.getSheetSize(activeSheetId);const{scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const rowDimensions=this.env.model.getters.getRowDimensions(activeSheetId,numberOfRows-1);const top=rowDimensions.end-scrollY;return cssPropertiesToCss({top:`${top}px`,});}
get errorMessages(){return[_t("Please enter a number between 0 and 10000.")];}
onKeydown(ev){if(ev.key.toUpperCase()==="ESCAPE"){this.props.focusGrid();}
else if(ev.key.toUpperCase()==="ENTER"){this.onConfirm();}}
onInput(ev){const value=ev.target.value;this.state.inputValue=value;const quantity=Number(value);this.state.errorFlag=Number.isNaN(quantity)||quantity<=0||quantity>10000;}
onConfirm(){if(this.state.errorFlag){return;}
const quantity=Number(this.state.inputValue);const activeSheetId=this.env.model.getters.getActiveSheetId();const rowNumber=this.env.model.getters.getNumberRows(activeSheetId);this.env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:activeSheetId,position:"after",base:rowNumber-1,quantity,dimension:"ROW",});this.props.focusGrid();const{scrollX}=this.env.model.getters.getActiveSheetDOMScrollInfo();const{end}=this.env.model.getters.getRowDimensions(activeSheetId,rowNumber+quantity-1);this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:end,});}
onExternalClick(ev){if(this.inputRef.el!==document.activeElement||ev.target===this.inputRef.el){return;}
this.props.focusGrid();}}
GridAddRowsFooter.props={focusGrid:Function,};function useRefListener(ref,...listener){owl.useEffect((el)=>{el?.addEventListener(...listener);return()=>el?.removeEventListener(...listener);},()=>[ref.el]);}
function useInterval(callback,delay){let intervalId;const{setInterval,clearInterval}=window;owl.useEffect(()=>{intervalId=setInterval(callback,delay);return()=>clearInterval(intervalId);},()=>[delay]);return{pause:()=>{clearInterval(intervalId);intervalId=undefined;},resume:()=>{if(intervalId===undefined){intervalId=setInterval(callback,delay);}},};}
const CURSOR_SVG=`
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="16"><path d="M6.5.4c1.3-.8 2.9-.1 3.8 1.4l2.9 5.1c.2.4.9 1.6-.4 2.3l-1.6.9 1.8 3.1c.2.4.1 1-.2 1.2l-1.6 1c-.3.1-.9 0-1.1-.4l-1.8-3.1-1.6 1c-.6.4-1.7 0-2.2-.8L0 4.3"/><path fill="#fff" d="M9.1 2a1.4 1.1 60 0 0-1.7-.6L5.5 2.5l.9 1.6-1 .6-.9-1.6-.6.4 1.8 3.1-1.3.7-1.8-3.1-1 .6 3.8 6.6 6.8-3.98M3.9 8.8 10.82 5l.795 1.4-6.81 3.96"/></svg>
`;css`
  .o-paint-format-cursor {
    cursor: url("data:image/svg+xml,${encodeURIComponent(CURSOR_SVG)}"), auto;
  }
`;function useCellHovered(env,gridRef,callback){let hoveredPosition={col:undefined,row:undefined,};const{Date}=window;let x=0;let y=0;let lastMoved=0;function getPosition(){const col=env.model.getters.getColIndex(x);const row=env.model.getters.getRowIndex(y);return{col,row};}
const{pause,resume}=useInterval(checkTiming,200);function checkTiming(){const{col,row}=getPosition();const delta=Date.now()-lastMoved;if(delta>300&&(col!==hoveredPosition.col||row!==hoveredPosition.row)){setPosition(undefined,undefined);}
if(delta>300){if(col<0||row<0){return;}
setPosition(col,row);}}
function updateMousePosition(e){if(gridRef.el===e.target){x=e.offsetX;y=e.offsetY;lastMoved=Date.now();}}
function recompute(){const{col,row}=getPosition();if(col!==hoveredPosition.col||row!==hoveredPosition.row){setPosition(undefined,undefined);}}
function onMouseLeave(e){const x=e.offsetX;const y=e.offsetY;const gridRect=getBoundingRectAsPOJO(gridRef.el);if(y<0||y>gridRect.height||x<0||x>gridRect.width){return updateMousePosition(e);}
else{return pause();}}
useRefListener(gridRef,"mousemove",updateMousePosition);useRefListener(gridRef,"mouseleave",onMouseLeave);useRefListener(gridRef,"mouseenter",resume);useRefListener(gridRef,"mousedown",recompute);owl.useExternalListener(window,"click",handleGlobalClick);function handleGlobalClick(e){const target=e.target;const grid=gridRef.el;if(!grid.contains(target)){setPosition(undefined,undefined);}}
function setPosition(col,row){if(col!==hoveredPosition.col||row!==hoveredPosition.row){hoveredPosition.col=col;hoveredPosition.row=row;callback({col,row});}}
return hoveredPosition;}
function useTouchMove(gridRef,handler,canMoveUp){let x=null;let y=null;function onTouchStart(ev){if(ev.touches.length!==1)
return;x=ev.touches[0].clientX;y=ev.touches[0].clientY;}
function onTouchEnd(){x=null;y=null;}
function onTouchMove(ev){if(ev.touches.length!==1)
return;if(canMoveUp()){ev.preventDefault();ev.stopPropagation();}
const currentX=ev.touches[0].clientX;const currentY=ev.touches[0].clientY;handler(x-currentX,y-currentY);x=currentX;y=currentY;}
useRefListener(gridRef,"touchstart",onTouchStart);useRefListener(gridRef,"touchend",onTouchEnd);useRefListener(gridRef,"touchmove",onTouchMove);}
class GridOverlay extends owl.Component{static template="o-spreadsheet-GridOverlay";static components={FiguresContainer,DataValidationOverlay,GridAddRowsFooter};static defaultProps={onCellHovered:()=>{},onCellDoubleClicked:()=>{},onCellClicked:()=>{},onCellRightClicked:()=>{},onGridResized:()=>{},onFigureDeleted:()=>{},};gridOverlay=owl.useRef("gridOverlay");gridOverlayRect=useAbsoluteBoundingRect(this.gridOverlay);setup(){useCellHovered(this.env,this.gridOverlay,this.props.onCellHovered);const resizeObserver=new ResizeObserver(()=>{const boundingRect=this.gridOverlayEl.getBoundingClientRect();this.props.onGridResized({x:boundingRect.left,y:boundingRect.top,height:this.gridOverlayEl.clientHeight,width:this.gridOverlayEl.clientWidth,});});owl.onMounted(()=>{resizeObserver.observe(this.gridOverlayEl);});owl.onWillUnmount(()=>{resizeObserver.disconnect();});useTouchMove(this.gridOverlay,this.props.onGridMoved,()=>{const{scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();return scrollY>0;});}
get gridOverlayEl(){if(!this.gridOverlay.el){throw new Error("GridOverlay el is not defined.");}
return this.gridOverlay.el;}
get style(){return this.props.gridOverlayDimensions;}
get isPaintingFormat(){return this.env.model.getters.isPaintingFormat();}
onMouseDown(ev){if(ev.button>0){return;}
const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellClicked(col,row,{expandZone:ev.shiftKey,addZone:isCtrlKey(ev),});}
onDoubleClick(ev){const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellDoubleClicked(col,row);}
onContextMenu(ev){const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellRightClicked(col,row,{x:ev.clientX,y:ev.clientY});}
getCartesianCoordinates(ev){const x=ev.clientX-this.gridOverlayRect.x;const y=ev.clientY-this.gridOverlayRect.y;const colIndex=this.env.model.getters.getColIndex(x);const rowIndex=this.env.model.getters.getRowIndex(y);return[colIndex,rowIndex];}}
GridOverlay.props={onCellHovered:{type:Function,optional:true},onCellDoubleClicked:{type:Function,optional:true},onCellClicked:{type:Function,optional:true},onCellRightClicked:{type:Function,optional:true},onGridResized:{type:Function,optional:true},onFigureDeleted:{type:Function,optional:true},onGridMoved:Function,gridOverlayDimensions:String,};class GridPopover extends owl.Component{static template="o-spreadsheet-GridPopover";static components={Popover};zIndex=ComponentsImportance.GridPopover;get cellPopover(){const popover=this.env.model.getters.getCellPopover(this.props.hoveredCell);if(!popover.isOpen){return{isOpen:false};}
const anchorRect=popover.anchorRect;return{...popover,anchorRect:{...anchorRect,x:anchorRect.x+this.props.gridRect.x,y:anchorRect.y+this.props.gridRect.y,},};}}
GridPopover.props={hoveredCell:Object,onClosePopover:Function,onMouseWheel:Function,gridRect:Object,};class AbstractResizer extends owl.Component{PADDING=0;MAX_SIZE_MARGIN=0;MIN_ELEMENT_SIZE=0;lastSelectedElementIndex=null;state=owl.useState({resizerIsActive:false,isResizing:false,isMoving:false,isSelecting:false,waitingForMove:false,activeElement:0,draggerLinePosition:0,draggerShadowPosition:0,draggerShadowThickness:0,delta:0,base:0,position:"before",});_computeHandleDisplay(ev){const position=this._getEvOffset(ev);const elementIndex=this._getElementIndex(position);if(elementIndex<0){return;}
const dimensions=this._getDimensionsInViewport(elementIndex);if(position-dimensions.start<this.PADDING&&elementIndex!==this._getViewportOffset()){this.state.resizerIsActive=true;this.state.draggerLinePosition=dimensions.start;this.state.activeElement=this._getPreviousVisibleElement(elementIndex);}
else if(dimensions.end-position<this.PADDING){this.state.resizerIsActive=true;this.state.draggerLinePosition=dimensions.end;this.state.activeElement=elementIndex;}
else{this.state.resizerIsActive=false;}}
_computeGrabDisplay(ev){const index=this._getElementIndex(this._getEvOffset(ev));const activeElements=this._getActiveElements();const selectedZoneStart=this._getSelectedZoneStart();const selectedZoneEnd=this._getSelectedZoneEnd();if(activeElements.has(selectedZoneStart)){if(selectedZoneStart<=index&&index<=selectedZoneEnd){this.state.waitingForMove=true;return;}}
this.state.waitingForMove=false;}
onMouseMove(ev){if(this.state.isResizing||this.state.isMoving||this.state.isSelecting){return;}
this._computeHandleDisplay(ev);this._computeGrabDisplay(ev);}
onMouseLeave(){this.state.resizerIsActive=this.state.isResizing;this.state.waitingForMove=false;}
onDblClick(ev){this._fitElementSize(this.state.activeElement);this.state.isResizing=false;this._computeHandleDisplay(ev);this._computeGrabDisplay(ev);}
onMouseDown(ev){this.state.isResizing=true;this.state.delta=0;const initialPosition=this._getClientPosition(ev);const styleValue=this.state.draggerLinePosition;const size=this._getElementSize(this.state.activeElement);const minSize=styleValue-size+this.MIN_ELEMENT_SIZE;const maxSize=this._getMaxSize();const onMouseUp=(ev)=>{this.state.isResizing=false;if(this.state.delta!==0){this._updateSize();}};const onMouseMove=(ev)=>{this.state.delta=this._getClientPosition(ev)-initialPosition;this.state.draggerLinePosition=styleValue+this.state.delta;if(this.state.draggerLinePosition<minSize){this.state.draggerLinePosition=minSize;this.state.delta=this.MIN_ELEMENT_SIZE-size;}
if(this.state.draggerLinePosition>maxSize){this.state.draggerLinePosition=maxSize;this.state.delta=maxSize-styleValue;}};startDnd(onMouseMove,onMouseUp);}
select(ev){if(ev.button>0){return;}
const index=this._getElementIndex(this._getEvOffset(ev));if(index<0){return;}
if(this.state.waitingForMove===true){if(!this.env.model.getters.isGridSelectionActive()){this._selectElement(index,false);}
else{this.startMovement(ev);}
return;}
if(this.env.model.getters.getEditionMode()==="editing"){this.env.model.selection.getBackToDefault();}
this.startSelection(ev,index);}
startMovement(ev){this.state.waitingForMove=false;this.state.isMoving=true;const startDimensions=this._getDimensionsInViewport(this._getSelectedZoneStart());const endDimensions=this._getDimensionsInViewport(this._getSelectedZoneEnd());const defaultPosition=startDimensions.start;this.state.draggerLinePosition=defaultPosition;this.state.base=this._getSelectedZoneStart();this.state.draggerShadowPosition=defaultPosition;this.state.draggerShadowThickness=endDimensions.end-startDimensions.start;const mouseMoveMovement=(col,row)=>{let elementIndex=this._getType()==="COL"?col:row;if(elementIndex>=0){const dimensions=this._getDimensionsInViewport(elementIndex);if(elementIndex<=this._getSelectedZoneStart()){this.state.draggerLinePosition=dimensions.start;this.state.draggerShadowPosition=dimensions.start;this.state.base=elementIndex;this.state.position="before";}
else if(this._getSelectedZoneEnd()<elementIndex){this.state.draggerLinePosition=dimensions.end;this.state.draggerShadowPosition=dimensions.end-this.state.draggerShadowThickness;this.state.base=elementIndex;this.state.position="after";}
else{this.state.draggerLinePosition=startDimensions.start;this.state.draggerShadowPosition=startDimensions.start;this.state.base=this._getSelectedZoneStart();}}};const mouseUpMovement=()=>{this.state.isMoving=false;if(this.state.base!==this._getSelectedZoneStart()){this._moveElements();}
this._computeGrabDisplay(ev);};dragAndDropBeyondTheViewport(this.env,mouseMoveMovement,mouseUpMovement);}
startSelection(ev,index){this.state.isSelecting=true;if(ev.shiftKey){this._increaseSelection(index);}
else{this._selectElement(index,isCtrlKey(ev));}
this.lastSelectedElementIndex=index;const mouseMoveSelect=(col,row)=>{let newIndex=this._getType()==="COL"?col:row;if(newIndex!==this.lastSelectedElementIndex&&newIndex!==-1){this._increaseSelection(newIndex);this.lastSelectedElementIndex=newIndex;}};const mouseUpSelect=()=>{this.state.isSelecting=false;this.lastSelectedElementIndex=null;this._computeGrabDisplay(ev);};dragAndDropBeyondTheViewport(this.env,mouseMoveSelect,mouseUpSelect);}
onMouseUp(ev){this.lastSelectedElementIndex=null;}
onContextMenu(ev){ev.preventDefault();const index=this._getElementIndex(this._getEvOffset(ev));if(index<0)
return;if(!this._getActiveElements().has(index)){this._selectElement(index,false);}
const type=this._getType();this.props.onOpenContextMenu(type,ev.clientX,ev.clientY);}}
css`
  .o-col-resizer {
    position: absolute;
    top: 0;
    left: ${HEADER_WIDTH}px;
    right: 0;
    height: ${HEADER_HEIGHT}px;
    &.o-dragging {
      cursor: grabbing;
    }
    &.o-grab {
      cursor: grab;
    }
    .dragging-col-line {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      width: 2px;
      height: 10000px;
      background-color: black;
    }
    .dragging-col-shadow {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      height: 10000px;
      background-color: black;
      opacity: 0.1;
    }
    .o-handle {
      position: absolute;
      height: ${HEADER_HEIGHT}px;
      width: 4px;
      cursor: e-resize;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .dragging-resizer {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      margin-left: 2px;
      width: 1px;
      height: 10000px;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .o-unhide {
      width: ${UNHIDE_ICON_EDGE_LENGTH}px;
      height: ${UNHIDE_ICON_EDGE_LENGTH}px;
      position: absolute;
      overflow: hidden;
      border-radius: 2px;
      top: calc(${HEADER_HEIGHT}px / 2 - ${UNHIDE_ICON_EDGE_LENGTH}px / 2);
    }
    .o-unhide:hover {
      z-index: ${ComponentsImportance.Grid + 1};
      background-color: lightgrey;
    }
    .o-unhide > svg {
      position: relative;
      top: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
    }
  }
`;AbstractResizer.props={onOpenContextMenu:Function,};class ColResizer extends AbstractResizer{static template="o-spreadsheet-ColResizer";colResizerRef;setup(){super.setup();this.colResizerRef=owl.useRef("colResizer");this.PADDING=15;this.MAX_SIZE_MARGIN=90;this.MIN_ELEMENT_SIZE=MIN_COL_WIDTH;}
_getEvOffset(ev){return ev.offsetX;}
_getViewportOffset(){return this.env.model.getters.getActiveMainViewport().left;}
_getClientPosition(ev){return ev.clientX;}
_getElementIndex(position){return this.env.model.getters.getColIndex(position);}
_getSelectedZoneStart(){return this.env.model.getters.getSelectedZone().left;}
_getSelectedZoneEnd(){return this.env.model.getters.getSelectedZone().right;}
_getEdgeScroll(position){return this.env.model.getters.getEdgeScrollCol(position,position,position);}
_getDimensionsInViewport(index){return this.env.model.getters.getColDimensionsInViewport(this.env.model.getters.getActiveSheetId(),index);}
_getElementSize(index){return this.env.model.getters.getColSize(this.env.model.getters.getActiveSheetId(),index);}
_getMaxSize(){return this.colResizerRef.el.clientWidth;}
_updateSize(){const index=this.state.activeElement;const size=this.state.delta+this._getElementSize(index);const cols=this.env.model.getters.getActiveCols();this.env.model.dispatch("RESIZE_COLUMNS_ROWS",{dimension:"COL",sheetId:this.env.model.getters.getActiveSheetId(),elements:cols.has(index)?[...cols]:[index],size,});}
_moveElements(){const elements=[];const start=this._getSelectedZoneStart();const end=this._getSelectedZoneEnd();for(let colIndex=start;colIndex<=end;colIndex++){elements.push(colIndex);}
const result=this.env.model.dispatch("MOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"COL",base:this.state.base,elements,position:this.state.position,});if(!result.isSuccessful&&result.reasons.includes("WillRemoveExistingMerge")){this.env.raiseError(MergeErrorMessage);}}
_selectElement(index,addDistinctHeader){this.env.model.selection.selectColumn(index,addDistinctHeader?"newAnchor":"overrideSelection");}
_increaseSelection(index){this.env.model.selection.selectColumn(index,"updateAnchor");}
_fitElementSize(index){const cols=this.env.model.getters.getActiveCols();this.env.model.dispatch("AUTORESIZE_COLUMNS",{sheetId:this.env.model.getters.getActiveSheetId(),cols:cols.has(index)?[...cols]:[index],});}
_getType(){return"COL";}
_getActiveElements(){return this.env.model.getters.getActiveCols();}
_getPreviousVisibleElement(index){const sheetId=this.env.model.getters.getActiveSheetId();let row;for(row=index-1;row>=0;row--){if(!this.env.model.getters.isColHidden(sheetId,row)){break;}}
return row;}
unhide(hiddenElements){this.env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),elements:hiddenElements,dimension:"COL",});}
unhideStyleValue(hiddenIndex){return this._getDimensionsInViewport(hiddenIndex).start;}}
css`
  .o-row-resizer {
    position: absolute;
    top: ${HEADER_HEIGHT}px;
    left: 0;
    right: 0;
    width: ${HEADER_WIDTH}px;
    height: 100%;
    &.o-dragging {
      cursor: grabbing;
    }
    &.o-grab {
      cursor: grab;
    }
    .dragging-row-line {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      width: 10000px;
      height: 2px;
      background-color: black;
    }
    .dragging-row-shadow {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      width: 10000px;
      background-color: black;
      opacity: 0.1;
    }
    .o-handle {
      position: absolute;
      height: 4px;
      width: ${HEADER_WIDTH}px;
      cursor: n-resize;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .dragging-resizer {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      margin-top: 2px;
      width: 10000px;
      height: 1px;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .o-unhide {
      width: ${UNHIDE_ICON_EDGE_LENGTH}px;
      height: ${UNHIDE_ICON_EDGE_LENGTH}px;
      position: absolute;
      overflow: hidden;
      border-radius: 2px;
      left: calc(${HEADER_WIDTH}px - ${UNHIDE_ICON_EDGE_LENGTH}px - 2px);
    }
    .o-unhide > svg {
      position: relative;
      left: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
      top: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
    }
    .o-unhide:hover {
      z-index: ${ComponentsImportance.Grid + 1};
      background-color: lightgrey;
    }
  }
`;ColResizer.props={onOpenContextMenu:Function,};class RowResizer extends AbstractResizer{static template="o-spreadsheet-RowResizer";setup(){super.setup();this.rowResizerRef=owl.useRef("rowResizer");this.PADDING=5;this.MAX_SIZE_MARGIN=60;this.MIN_ELEMENT_SIZE=MIN_ROW_HEIGHT;}
rowResizerRef;_getEvOffset(ev){return ev.offsetY;}
_getViewportOffset(){return this.env.model.getters.getActiveMainViewport().top;}
_getClientPosition(ev){return ev.clientY;}
_getElementIndex(position){return this.env.model.getters.getRowIndex(position);}
_getSelectedZoneStart(){return this.env.model.getters.getSelectedZone().top;}
_getSelectedZoneEnd(){return this.env.model.getters.getSelectedZone().bottom;}
_getEdgeScroll(position){return this.env.model.getters.getEdgeScrollRow(position,position,position);}
_getDimensionsInViewport(index){return this.env.model.getters.getRowDimensionsInViewport(this.env.model.getters.getActiveSheetId(),index);}
_getElementSize(index){return this.env.model.getters.getRowSize(this.env.model.getters.getActiveSheetId(),index);}
_getMaxSize(){return this.rowResizerRef.el.clientHeight;}
_updateSize(){const index=this.state.activeElement;const size=this.state.delta+this._getElementSize(index);const rows=this.env.model.getters.getActiveRows();this.env.model.dispatch("RESIZE_COLUMNS_ROWS",{dimension:"ROW",sheetId:this.env.model.getters.getActiveSheetId(),elements:rows.has(index)?[...rows]:[index],size,});}
_moveElements(){const elements=[];const start=this._getSelectedZoneStart();const end=this._getSelectedZoneEnd();for(let rowIndex=start;rowIndex<=end;rowIndex++){elements.push(rowIndex);}
const result=this.env.model.dispatch("MOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",base:this.state.base,elements,position:this.state.position,});if(!result.isSuccessful&&result.reasons.includes("WillRemoveExistingMerge")){this.env.raiseError(MergeErrorMessage);}}
_selectElement(index,addDistinctHeader){this.env.model.selection.selectRow(index,addDistinctHeader?"newAnchor":"overrideSelection");}
_increaseSelection(index){this.env.model.selection.selectRow(index,"updateAnchor");}
_fitElementSize(index){const rows=this.env.model.getters.getActiveRows();this.env.model.dispatch("AUTORESIZE_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),rows:rows.has(index)?[...rows]:[index],});}
_getType(){return"ROW";}
_getActiveElements(){return this.env.model.getters.getActiveRows();}
_getPreviousVisibleElement(index){const sheetId=this.env.model.getters.getActiveSheetId();let row;for(row=index-1;row>=0;row--){if(!this.env.model.getters.isRowHidden(sheetId,row)){break;}}
return row;}
unhide(hiddenElements){this.env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",elements:hiddenElements,});}
unhideStyleValue(hiddenIndex){return this._getDimensionsInViewport(hiddenIndex).start;}}
css`
  .o-overlay {
    .all {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      width: ${HEADER_WIDTH}px;
      height: ${HEADER_HEIGHT}px;
    }
  }
`;RowResizer.props={onOpenContextMenu:Function,};class HeadersOverlay extends owl.Component{static template="o-spreadsheet-HeadersOverlay";static components={ColResizer,RowResizer};selectAll(){this.env.model.selection.selectAll();}}
HeadersOverlay.props={onOpenContextMenu:Function,};function useGridDrawing(refName,model,canvasSize){const canvasRef=owl.useRef(refName);owl.useEffect(drawGrid);function drawGrid(){const canvas=canvasRef.el;const dpr=window.devicePixelRatio||1;const ctx=canvas.getContext("2d",{alpha:false});const thinLineWidth=0.4*dpr;const renderingContext={ctx,dpr,thinLineWidth,};const{width,height}=canvasSize();canvas.style.width=`${width}px`;canvas.style.height=`${height}px`;canvas.width=width*dpr;canvas.height=height*dpr;canvas.setAttribute("style",`width:${width}px;height:${height}px;`);ctx.translate(-CANVAS_SHIFT,-CANVAS_SHIFT);ctx.scale(dpr,dpr);model.drawGrid(renderingContext);}}
function useWheelHandler(handler){function normalize(val,deltaMode){return val*(deltaMode===0?1:DEFAULT_CELL_HEIGHT);}
const onMouseWheel=(ev)=>{const deltaX=normalize(ev.shiftKey&&!isMacOS()?ev.deltaY:ev.deltaX,ev.deltaMode);const deltaY=normalize(ev.shiftKey&&!isMacOS()?ev.deltaX:ev.deltaY,ev.deltaMode);handler(deltaX,deltaY);};return onMouseWheel;}
css`
  .o-border {
    position: absolute;
    &:hover {
      cursor: grab;
    }
  }
  .o-moving {
    cursor: grabbing;
  }
`;class Border extends owl.Component{static template="o-spreadsheet-Border";get style(){const isTop=["n","w","e"].includes(this.props.orientation);const isLeft=["n","w","s"].includes(this.props.orientation);const isHorizontal=["n","s"].includes(this.props.orientation);const isVertical=["w","e"].includes(this.props.orientation);const z=this.props.zone;const margin=2;const rect=this.env.model.getters.getVisibleRect(z);const left=rect.x;const right=rect.x+rect.width-2*margin;const top=rect.y;const bottom=rect.y+rect.height-2*margin;const lineWidth=4;const leftValue=isLeft?left:right;const topValue=isTop?top:bottom;const widthValue=isHorizontal?right-left:lineWidth;const heightValue=isVertical?bottom-top:lineWidth;return cssPropertiesToCss({left:`${leftValue}px`,top:`${topValue}px`,width:`${widthValue}px`,height:`${heightValue}px`,});}
onMouseDown(ev){this.props.onMoveHighlight(ev.clientX,ev.clientY);}}
Border.props={zone:Object,orientation:String,isMoving:Boolean,onMoveHighlight:Function,};css`
  .o-corner {
    position: absolute;
    height: 6px;
    width: 6px;
    border: 1px solid white;
  }
  .o-corner-nw,
  .o-corner-se {
    &:hover {
      cursor: nwse-resize;
    }
  }
  .o-corner-ne,
  .o-corner-sw {
    &:hover {
      cursor: nesw-resize;
    }
  }
  .o-resizing {
    cursor: grabbing;
  }
`;class Corner extends owl.Component{static template="o-spreadsheet-Corner";isTop=this.props.orientation[0]==="n";isLeft=this.props.orientation[1]==="w";get style(){const z=this.props.zone;const col=this.isLeft?z.left:z.right;const row=this.isTop?z.top:z.bottom;const rect=this.env.model.getters.getVisibleRect({left:col,right:col,top:row,bottom:row,});if(rect.width*rect.height===0){return`display:none`;}
const leftValue=this.isLeft?rect.x:rect.x+rect.width;const topValue=this.isTop?rect.y:rect.y+rect.height;return cssPropertiesToCss({left:`${leftValue - AUTOFILL_EDGE_LENGTH / 2}px`,top:`${topValue - AUTOFILL_EDGE_LENGTH / 2}px`,"background-color":this.props.color,});}
onMouseDown(ev){this.props.onResizeHighlight(this.isLeft,this.isTop);}}
Corner.props={zone:Object,color:String,orientation:String,isResizing:Boolean,onResizeHighlight:Function,};css`
  .o-highlight {
    z-index: ${ComponentsImportance.Highlight};
  }
`;class Highlight extends owl.Component{static template="o-spreadsheet-Highlight";static components={Corner,Border,};highlightState=owl.useState({shiftingMode:"none",});onResizeHighlight(isLeft,isTop){const activeSheetId=this.env.model.getters.getActiveSheetId();this.highlightState.shiftingMode="isResizing";const z=this.props.zone;const pivotCol=isLeft?z.right:z.left;const pivotRow=isTop?z.bottom:z.top;let lastCol=isLeft?z.left:z.right;let lastRow=isTop?z.top:z.bottom;let currentZone=z;this.env.model.dispatch("START_CHANGE_HIGHLIGHT",{zone:currentZone});const mouseMove=(col,row)=>{if(lastCol!==col||lastRow!==row){lastCol=clip(col===-1?lastCol:col,0,this.env.model.getters.getNumberCols(activeSheetId)-1);lastRow=clip(row===-1?lastRow:row,0,this.env.model.getters.getNumberRows(activeSheetId)-1);let newZone={left:Math.min(pivotCol,lastCol),top:Math.min(pivotRow,lastRow),right:Math.max(pivotCol,lastCol),bottom:Math.max(pivotRow,lastRow),};if(!isEqual(newZone,currentZone)){this.env.model.selection.selectZone({cell:{col:newZone.left,row:newZone.top},zone:newZone,},{unbounded:true});currentZone=newZone;}}};const mouseUp=()=>{this.highlightState.shiftingMode="none";};dragAndDropBeyondTheViewport(this.env,mouseMove,mouseUp);}
onMoveHighlight(clientX,clientY){this.highlightState.shiftingMode="isMoving";const z=this.props.zone;const position=gridOverlayPosition();const activeSheetId=this.env.model.getters.getActiveSheetId();const initCol=this.env.model.getters.getColIndex(clientX-position.left);const initRow=this.env.model.getters.getRowIndex(clientY-position.top);const deltaColMin=-z.left;const deltaColMax=this.env.model.getters.getNumberCols(activeSheetId)-z.right-1;const deltaRowMin=-z.top;const deltaRowMax=this.env.model.getters.getNumberRows(activeSheetId)-z.bottom-1;let currentZone=z;this.env.model.dispatch("START_CHANGE_HIGHLIGHT",{zone:currentZone});let lastCol=initCol;let lastRow=initRow;const mouseMove=(col,row)=>{if(lastCol!==col||lastRow!==row){lastCol=col===-1?lastCol:col;lastRow=row===-1?lastRow:row;const deltaCol=clip(lastCol-initCol,deltaColMin,deltaColMax);const deltaRow=clip(lastRow-initRow,deltaRowMin,deltaRowMax);let newZone={left:z.left+deltaCol,top:z.top+deltaRow,right:z.right+deltaCol,bottom:z.bottom+deltaRow,};if(!isEqual(newZone,currentZone)){this.env.model.selection.selectZone({cell:{col:newZone.left,row:newZone.top},zone:newZone,},{unbounded:true});currentZone=newZone;}}};const mouseUp=()=>{this.highlightState.shiftingMode="none";};dragAndDropBeyondTheViewport(this.env,mouseMove,mouseUp);}}
Highlight.props={zone:Object,color:String,};let ScrollBar$1=class ScrollBar{direction;el;constructor(el,direction){this.el=el;this.direction=direction;}
get scroll(){return this.direction==="horizontal"?this.el.scrollLeft:this.el.scrollTop;}
set scroll(value){if(this.direction==="horizontal"){this.el.scrollLeft=value;}
else{this.el.scrollTop=value;}}};css`
  .o-scrollbar {
    position: absolute;
    overflow: auto;
    z-index: ${ComponentsImportance.ScrollBar};
    background-color: ${BACKGROUND_GRAY_COLOR};

    &.corner {
      right: 0px;
      bottom: 0px;
      height: ${SCROLLBAR_WIDTH}px;
      width: ${SCROLLBAR_WIDTH}px;
      border-top: 1px solid #e2e3e3;
      border-left: 1px solid #e2e3e3;
    }
  }
`;class ScrollBar extends owl.Component{static template=owl.xml`
    <div
        t-attf-class="o-scrollbar {{props.direction}}"
        t-on-scroll="onScroll"
        t-ref="scrollbar"
        t-att-style="positionCss">
      <div t-att-style="sizeCss"/>
    </div>
  `;static defaultProps={width:1,height:1,};scrollbarRef;scrollbar;setup(){this.scrollbarRef=owl.useRef("scrollbar");this.scrollbar=new ScrollBar$1(this.scrollbarRef.el,this.props.direction);owl.onMounted(()=>{this.scrollbar.el=this.scrollbarRef.el;});owl.useEffect(()=>{if(this.scrollbar.scroll!==this.props.offset){this.scrollbar.scroll=this.props.offset;}},()=>[this.scrollbar.scroll,this.props.offset]);}
get sizeCss(){return cssPropertiesToCss({width:`${this.props.width}px`,height:`${this.props.height}px`,});}
get positionCss(){return cssPropertiesToCss(this.props.position);}
onScroll(ev){if(this.props.offset!==this.scrollbar.scroll){this.props.onScroll(this.scrollbar.scroll);}}}
ScrollBar.props={width:{type:Number,optional:true},height:{type:Number,optional:true},direction:String,position:Object,offset:Number,onScroll:Function,};class HorizontalScrollBar extends owl.Component{static components={ScrollBar};static template=owl.xml`
      <ScrollBar
        t-if="isDisplayed"
        width="width"
        position="position"
        offset="offset"
        direction="'horizontal'"
        onScroll.bind="onScroll"
      />`;static defaultProps={leftOffset:0,};get offset(){return this.env.model.getters.getActiveSheetDOMScrollInfo().scrollX;}
get width(){return this.env.model.getters.getMainViewportRect().width;}
get isDisplayed(){const{xRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());return xRatio<1;}
get position(){const{x}=this.env.model.getters.getMainViewportRect();return{left:`${this.props.leftOffset + x}px`,bottom:"0px",height:`${SCROLLBAR_WIDTH}px`,right:`0px`,};}
onScroll(offset){const{scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:offset,offsetY:scrollY,});}}
HorizontalScrollBar.props={leftOffset:{type:Number,optional:true},};class VerticalScrollBar extends owl.Component{static components={ScrollBar};static template=owl.xml`
    <ScrollBar
      t-if="isDisplayed"
      height="height"
      position="position"
      offset="offset"
      direction="'vertical'"
      onScroll.bind="onScroll"
    />`;static defaultProps={topOffset:0,};get offset(){return this.env.model.getters.getActiveSheetDOMScrollInfo().scrollY;}
get height(){return this.env.model.getters.getMainViewportRect().height;}
get isDisplayed(){const{yRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());return yRatio<1;}
get position(){const{y}=this.env.model.getters.getMainViewportRect();return{top:`${this.props.topOffset + y}px`,right:"0px",width:`${SCROLLBAR_WIDTH}px`,bottom:`0px`,};}
onScroll(offset){const{scrollX}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:offset,});}}
VerticalScrollBar.props={topOffset:{type:Number,optional:true},};const registries$1={ROW:rowMenuRegistry,COL:colMenuRegistry,CELL:cellMenuRegistry,GROUP_HEADERS:groupHeadersMenuRegistry,UNGROUP_HEADERS:unGroupHeadersMenuRegistry,};const MODIFIER_KEYS=["Shift","Control","Alt","Meta"];class Grid extends owl.Component{static template="o-spreadsheet-Grid";static components={GridComposer,GridOverlay,GridPopover,HeadersOverlay,Menu,Autofill,ClientTag,Highlight,Popover,VerticalScrollBar,HorizontalScrollBar,FilterIconsOverlay,};HEADER_HEIGHT=HEADER_HEIGHT;HEADER_WIDTH=HEADER_WIDTH;menuState;gridRef;onMouseWheel;canvasPosition;hoveredCell;setup(){this.menuState=owl.useState({isOpen:false,position:null,menuItems:[],});this.gridRef=owl.useRef("grid");this.canvasPosition=useAbsoluteBoundingRect(this.gridRef);this.hoveredCell=owl.useState({col:undefined,row:undefined});owl.useChildSubEnv({getPopoverContainerRect:()=>this.getGridRect()});owl.useExternalListener(document.body,"cut",this.copy.bind(this,true));owl.useExternalListener(document.body,"copy",this.copy.bind(this,false));owl.useExternalListener(document.body,"paste",this.paste);owl.onMounted(()=>this.focusDefaultElement());this.props.exposeFocus(()=>this.focusDefaultElement());useGridDrawing("canvas",this.env.model,()=>this.env.model.getters.getSheetViewDimensionWithHeaders());owl.useEffect(()=>this.focusDefaultElement(),()=>[this.env.model.getters.getActiveSheetId()]);this.onMouseWheel=useWheelHandler((deltaX,deltaY)=>{this.moveCanvas(deltaX,deltaY);this.hoveredCell.col=undefined;this.hoveredCell.row=undefined;});}
onCellHovered({col,row}){this.hoveredCell.col=col;this.hoveredCell.row=row;}
get gridOverlayDimensions(){return cssPropertiesToCss({top:`${HEADER_HEIGHT}px`,left:`${HEADER_WIDTH}px`,height:`calc(100% - ${HEADER_HEIGHT + SCROLLBAR_WIDTH}px)`,width:`calc(100% - ${HEADER_WIDTH + SCROLLBAR_WIDTH}px)`,});}
onClosePopover(){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
this.focusDefaultElement();}
keyDownMapping={ENTER:()=>{const cell=this.env.model.getters.getActiveCell();cell.type===CellValueType.empty?this.props.onGridComposerCellFocused():this.props.onComposerContentFocused();},TAB:()=>this.env.model.selection.moveAnchorCell("right",1),"SHIFT+TAB":()=>this.env.model.selection.moveAnchorCell("left",1),F2:()=>{const cell=this.env.model.getters.getActiveCell();cell.type===CellValueType.empty?this.props.onGridComposerCellFocused():this.props.onComposerContentFocused();},DELETE:()=>{this.env.model.dispatch("DELETE_CONTENT",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});},BACKSPACE:()=>{this.env.model.dispatch("DELETE_CONTENT",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});},ESCAPE:()=>{if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
else if(this.menuState.isOpen){this.closeMenu();}
else if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("CANCEL_PAINT_FORMAT");}
else{this.env.model.dispatch("CLEAN_CLIPBOARD_HIGHLIGHT");}},"CTRL+A":()=>this.env.model.selection.loopSelection(),"CTRL+Z":()=>this.env.model.dispatch("REQUEST_UNDO"),"CTRL+Y":()=>this.env.model.dispatch("REQUEST_REDO"),F4:()=>this.env.model.dispatch("REQUEST_REDO"),"CTRL+B":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{bold:!this.env.model.getters.getCurrentStyle().bold},}),"CTRL+I":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{italic:!this.env.model.getters.getCurrentStyle().italic},}),"CTRL+U":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{underline:!this.env.model.getters.getCurrentStyle().underline},}),"CTRL+O":()=>CREATE_IMAGE(this.env),"ALT+=":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const mainSelectedZone=this.env.model.getters.getSelectedZone();const{anchor}=this.env.model.getters.getSelection();const sums=this.env.model.getters.getAutomaticSums(sheetId,mainSelectedZone,anchor.cell);if(this.env.model.getters.isSingleCellOrMerge(sheetId,mainSelectedZone)||(this.env.model.getters.isEmpty(sheetId,mainSelectedZone)&&sums.length<=1)){const zone=sums[0]?.zone;const zoneXc=zone?this.env.model.getters.zoneToXC(sheetId,sums[0].zone):"";const formula=`=SUM(${zoneXc})`;this.props.onGridComposerCellFocused(formula,{start:5,end:5+zoneXc.length});}
else{this.env.model.dispatch("SUM_SELECTION");}},"ALT+ENTER":()=>{const cell=this.env.model.getters.getActiveCell();if(cell.link){openLink(cell.link,this.env);}},"CTRL+HOME":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const{col,row}=this.env.model.getters.getNextVisibleCellPosition({sheetId,col:0,row:0,});this.env.model.selection.selectCell(col,row);},"CTRL+END":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const col=this.env.model.getters.findVisibleHeader(sheetId,"COL",this.env.model.getters.getNumberCols(sheetId)-1,0);const row=this.env.model.getters.findVisibleHeader(sheetId,"ROW",this.env.model.getters.getNumberRows(sheetId)-1,0);this.env.model.selection.selectCell(col,row);},"SHIFT+ ":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const newZone={...this.env.model.getters.getSelectedZone(),left:0,right:this.env.model.getters.getNumberCols(sheetId)-1,};const position=this.env.model.getters.getActivePosition();this.env.model.selection.selectZone({cell:position,zone:newZone});},"CTRL+ ":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const newZone={...this.env.model.getters.getSelectedZone(),top:0,bottom:this.env.model.getters.getNumberRows(sheetId)-1,};const position=this.env.model.getters.getActivePosition();this.env.model.selection.selectZone({cell:position,zone:newZone});},"CTRL+D":async()=>this.env.model.dispatch("COPY_PASTE_CELLS_ABOVE"),"CTRL+R":async()=>this.env.model.dispatch("COPY_PASTE_CELLS_ON_LEFT"),"CTRL+SHIFT+E":()=>this.setHorizontalAlign("center"),"CTRL+SHIFT+L":()=>this.setHorizontalAlign("left"),"CTRL+SHIFT+R":()=>this.setHorizontalAlign("right"),"CTRL+SHIFT+V":()=>PASTE_VALUE_ACTION(this.env),"CTRL+SHIFT+<":()=>this.clearFormatting(),"CTRL+<":()=>this.clearFormatting(),"CTRL+SHIFT+ ":()=>{this.env.model.selection.selectAll();},"CTRL+ALT+=":()=>{const activeCols=this.env.model.getters.getActiveCols();const activeRows=this.env.model.getters.getActiveRows();const isSingleSelection=this.env.model.getters.getSelectedZones().length===1;const areFullCols=activeCols.size>0&&isSingleSelection;const areFullRows=activeRows.size>0&&isSingleSelection;if(areFullCols&&!areFullRows){INSERT_COLUMNS_BEFORE_ACTION(this.env);}
else if(areFullRows&&!areFullCols){INSERT_ROWS_BEFORE_ACTION(this.env);}},"CTRL+ALT+-":()=>{const columns=[...this.env.model.getters.getActiveCols()];const rows=[...this.env.model.getters.getActiveRows()];if(columns.length>0&&rows.length===0){this.env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});}
else if(rows.length>0&&columns.length===0){this.env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});}},"SHIFT+PAGEDOWN":()=>{this.env.model.dispatch("ACTIVATE_NEXT_SHEET");},"SHIFT+PAGEUP":()=>{this.env.model.dispatch("ACTIVATE_PREVIOUS_SHEET");},PAGEDOWN:()=>this.env.model.dispatch("SHIFT_VIEWPORT_DOWN"),PAGEUP:()=>this.env.model.dispatch("SHIFT_VIEWPORT_UP"),"CTRL+K":()=>INSERT_LINK(this.env),"ALT+SHIFT+ARROWRIGHT":()=>this.processHeaderGroupingKey("right"),"ALT+SHIFT+ARROWLEFT":()=>this.processHeaderGroupingKey("left"),"ALT+SHIFT+ARROWUP":()=>this.processHeaderGroupingKey("up"),"ALT+SHIFT+ARROWDOWN":()=>this.processHeaderGroupingKey("down"),};focusDefaultElement(){if(!this.env.model.getters.getSelectedFigureId()&&this.env.model.getters.getEditionMode()==="inactive"){this.env.focusableElement.focus();}}
get gridEl(){if(!this.gridRef.el){throw new Error("Grid el is not defined.");}
return this.gridRef.el;}
getAutofillPosition(){const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect(zone);return{left:rect.x+rect.width-AUTOFILL_EDGE_LENGTH/2,top:rect.y+rect.height-AUTOFILL_EDGE_LENGTH/2,};}
get isAutofillVisible(){const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect({left:zone.right,right:zone.right,top:zone.bottom,bottom:zone.bottom,});return!(rect.width===0||rect.height===0);}
onGridResized({height,width}){this.env.model.dispatch("RESIZE_SHEETVIEW",{width:width,height:height,gridOffsetX:HEADER_WIDTH,gridOffsetY:HEADER_HEIGHT,});}
moveCanvas(deltaX,deltaY){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX+deltaX,offsetY:scrollY+deltaY,});}
getClientPositionKey(client){return`${client.id}-${client.position?.sheetId}-${client.position?.col}-${client.position?.row}`;}
isCellHovered(col,row){return this.hoveredCell.col===col&&this.hoveredCell.row===row;}
getGridRect(){return{...this.canvasPosition,...this.env.model.getters.getSheetViewDimensionWithHeaders()};}
onCellClicked(col,row,{addZone,expandZone}){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
if(this.env.model.getters.getEditionMode()==="editing"){interactiveStopEdition(this.env);}
if(expandZone){this.env.model.selection.setAnchorCorner(col,row);}
else if(addZone){this.env.model.selection.addCellToSelection(col,row);}
else{this.env.model.selection.selectCell(col,row);}
let prevCol=col;let prevRow=row;const onMouseMove=(col,row,ev)=>{ev.preventDefault();if((col!==prevCol&&col!=-1)||(row!==prevRow&&row!=-1)){prevCol=col===-1?prevCol:col;prevRow=row===-1?prevRow:row;this.env.model.selection.setAnchorCorner(prevCol,prevRow);}};const onMouseUp=()=>{if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("PASTE",{target:this.env.model.getters.getSelectedZones(),});}};dragAndDropBeyondTheViewport(this.env,onMouseMove,onMouseUp);}
onCellDoubleClicked(col,row){const sheetId=this.env.model.getters.getActiveSheetId();({col,row}=this.env.model.getters.getMainCellPosition({sheetId,col,row}));const cell=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.empty){this.props.onGridComposerCellFocused();}
else{this.props.onComposerContentFocused();}}
closeOpenedPopover(){this.env.model.dispatch("CLOSE_CELL_POPOVER");}
processArrows(ev){ev.preventDefault();ev.stopPropagation();if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
updateSelectionWithArrowKeys(ev,this.env.model.selection);if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("PASTE",{target:this.env.model.getters.getSelectedZones(),});}}
onKeydown(ev){let keyDownString="";if(!MODIFIER_KEYS.includes(ev.key)){if(isCtrlKey(ev))
keyDownString+="CTRL+";if(ev.altKey)
keyDownString+="ALT+";if(ev.shiftKey)
keyDownString+="SHIFT+";}
keyDownString+=ev.key.toUpperCase();let handler=this.keyDownMapping[keyDownString];if(handler){ev.preventDefault();ev.stopPropagation();handler();return;}
if(ev.key.startsWith("Arrow")){this.processArrows(ev);return;}}
onInputContextMenu(ev){ev.preventDefault();const lastZone=this.env.model.getters.getSelectedZone();const{left:col,top:row}=lastZone;let type="CELL";interactiveStopEdition(this.env);if(this.env.model.getters.getActiveCols().has(col)){type="COL";}
else if(this.env.model.getters.getActiveRows().has(row)){type="ROW";}
const{x,y,width}=this.env.model.getters.getVisibleRect(lastZone);const gridRect=this.getGridRect();this.toggleContextMenu(type,gridRect.x+x+width,gridRect.y+y);}
onCellRightClicked(col,row,{x,y}){const zones=this.env.model.getters.getSelectedZones();const lastZone=zones[zones.length-1];let type="CELL";if(!isInside(col,row,lastZone)){this.env.model.selection.getBackToDefault();this.env.model.selection.selectCell(col,row);}
else{if(this.env.model.getters.getActiveCols().has(col)){type="COL";}
else if(this.env.model.getters.getActiveRows().has(row)){type="ROW";}}
this.toggleContextMenu(type,x,y);}
toggleContextMenu(type,x,y){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
this.menuState.isOpen=true;this.menuState.position={x,y};this.menuState.menuItems=registries$1[type].getMenuItems();}
copy(cut,ev){if(!this.gridEl.contains(document.activeElement)){return;}
const clipboardData=ev.clipboardData;if(!clipboardData){this.displayWarningCopyPasteNotSupported();return;}
if(this.env.model.getters.getEditionMode()!=="inactive"){return;}
if(cut){interactiveCut(this.env);}
else{this.env.model.dispatch("COPY");}
const content=this.env.model.getters.getClipboardContent();for(const type in content){clipboardData.setData(type,content[type]);}
ev.preventDefault();}
async paste(ev){if(!this.gridEl.contains(document.activeElement)){return;}
const clipboardData=ev.clipboardData;if(!clipboardData){this.displayWarningCopyPasteNotSupported();return;}
if(clipboardData.types.indexOf(ClipboardMIMEType.PlainText)>-1){const content=clipboardData.getData(ClipboardMIMEType.PlainText);const target=this.env.model.getters.getSelectedZones();const clipboardString=this.env.model.getters.getClipboardTextContent();const isCutOperation=this.env.model.getters.isCutOperation();if(clipboardString===content){interactivePaste(this.env,target);}
else{interactivePasteFromOS(this.env,target,content);}
if(isCutOperation){await this.env.clipboard.write({[ClipboardMIMEType.PlainText]:""});}}}
displayWarningCopyPasteNotSupported(){this.env.raiseError(_t("Copy/Paste is not supported in this browser."));}
clearFormatting(){this.env.model.dispatch("CLEAR_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});}
setHorizontalAlign(align){this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{align},});}
closeMenu(){this.menuState.isOpen=false;this.focusDefaultElement();}
processHeaderGroupingKey(direction){if(this.env.model.getters.getSelectedZones().length!==1){return;}
const selectingRows=this.env.model.getters.getActiveRows().size>0;const selectingCols=this.env.model.getters.getActiveCols().size>0;if(selectingCols&&selectingRows){this.processHeaderGroupingEventOnWholeSheet(direction);}
else if(selectingCols){this.processHeaderGroupingEventOnHeaders(direction,"COL");}
else if(selectingRows){this.processHeaderGroupingEventOnHeaders(direction,"ROW");}
else{this.processHeaderGroupingEventOnGrid(direction);}}
processHeaderGroupingEventOnHeaders(direction,dimension){const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();const start=dimension==="COL"?zone.left:zone.top;const end=dimension==="COL"?zone.right:zone.bottom;switch(direction){case"right":this.env.model.dispatch("GROUP_HEADERS",{sheetId,dimension:dimension,start,end});break;case"left":this.env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension:dimension,start,end});break;case"down":this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension,zone});break;case"up":this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension,zone});break;}}
processHeaderGroupingEventOnWholeSheet(direction){const sheetId=this.env.model.getters.getActiveSheetId();if(direction==="up"){this.env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"ROW"});this.env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"COL"});}
else if(direction==="down"){this.env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"ROW"});this.env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"COL"});}}
processHeaderGroupingEventOnGrid(direction){const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();switch(direction){case"down":this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"ROW",zone:zone,});this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"COL",zone:zone,});break;case"up":this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"ROW",zone:zone,});this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"COL",zone:zone,});break;case"right":{const{x,y,width}=this.env.model.getters.getVisibleRect(zone);const gridRect=this.getGridRect();this.toggleContextMenu("GROUP_HEADERS",x+width+gridRect.x,y+gridRect.y);break;}
case"left":{if(!canUngroupHeaders(this.env,"COL")&&!canUngroupHeaders(this.env,"ROW")){return;}
const{x,y,width}=this.env.model.getters.getVisibleRect(zone);const gridRect=this.getGridRect();this.toggleContextMenu("UNGROUP_HEADERS",x+width+gridRect.x,y+gridRect.y);break;}}}}
Grid.props={sidePanelIsOpen:Boolean,exposeFocus:Function,focusComposer:String,onComposerContentFocused:Function,onGridComposerCellFocused:Function,};class XMLString{xmlString;constructor(xmlString){this.xmlString=xmlString;}
toString(){return this.xmlString;}}
const XLSX_CHART_TYPES=["areaChart","area3DChart","lineChart","line3DChart","stockChart","radarChart","scatterChart","pieChart","pie3DChart","doughnutChart","barChart","bar3DChart","ofPieChart","surfaceChart","surface3DChart","bubbleChart",];const AUTO_COLOR="000000";const XLSX_ICONSET_MAP={arrow:"3Arrows",smiley:"3Symbols",dot:"3TrafficLights1",};const NAMESPACE={styleSheet:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",sst:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",Relationships:"http://schemas.openxmlformats.org/package/2006/relationships",Types:"http://schemas.openxmlformats.org/package/2006/content-types",worksheet:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",workbook:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",drawing:"http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing",table:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",revision:"http://schemas.microsoft.com/office/spreadsheetml/2014/revision",revision3:"http://schemas.microsoft.com/office/spreadsheetml/2016/revision3",markupCompatibility:"http://schemas.openxmlformats.org/markup-compatibility/2006",};const DRAWING_NS_A="http://schemas.openxmlformats.org/drawingml/2006/main";const DRAWING_NS_C="http://schemas.openxmlformats.org/drawingml/2006/chart";const CONTENT_TYPES={workbook:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml",sheet:"application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml",sharedStrings:"application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml",styles:"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml",drawing:"application/vnd.openxmlformats-officedocument.drawing+xml",chart:"application/vnd.openxmlformats-officedocument.drawingml.chart+xml",themes:"application/vnd.openxmlformats-officedocument.theme+xml",table:"application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml",pivot:"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotTable+xml",externalLink:"application/vnd.openxmlformats-officedocument.spreadsheetml.externalLink+xml",};const XLSX_RELATION_TYPE={document:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument",sheet:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet",sharedStrings:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings",styles:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles",drawing:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing",chart:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/chart",theme:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme",table:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/table",hyperlink:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink",image:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image",};const RELATIONSHIP_NSR="http://schemas.openxmlformats.org/officeDocument/2006/relationships";const HEIGHT_FACTOR=0.75;const WIDTH_FACTOR=0.143;const EXCEL_DEFAULT_COL_WIDTH=8.43;const EXCEL_DEFAULT_ROW_HEIGHT=12.75;const EXCEL_IMPORT_DEFAULT_NUMBER_OF_COLS=30;const EXCEL_IMPORT_DEFAULT_NUMBER_OF_ROWS=100;const FIRST_NUMFMT_ID=164;const FORCE_DEFAULT_ARGS_FUNCTIONS={FLOOR:[{type:"NUMBER",value:1}],CEILING:[{type:"NUMBER",value:1}],ROUND:[{type:"NUMBER",value:0}],ROUNDUP:[{type:"NUMBER",value:0}],ROUNDDOWN:[{type:"NUMBER",value:0}],};const NON_RETROCOMPATIBLE_FUNCTIONS=["ACOT","ACOTH","AGGREGATE","ARABIC","BASE","BETA.DIST","BETA.INV","BINOM.DIST","BINOM.DIST.RANGE","BINOM.INV","BITAND","BITLSHIFT","BITOR","BITRSHIFT","BITXOR","CEILING.MATH","CEILING.PRECISE","CHISQ.DIST","CHISQ.DIST.RT","CHISQ.INV","CHISQ.INV.RT","CHISQ.TEST","COMBINA","CONCAT","CONFIDENCE.NORM","CONFIDENCE.T","COT","COTH","COVARIANCE.P","COVARIANCE.S","CSC","CSCH","DAYS","DECIMAL","ERF.PRECISE","ERFC.PRECISE","EXPON.DIST","F.DIST","F.DIST.RT","F.INV","F.INV.RT","F.TEST","FILTERXML","FLOOR.MATH","FLOOR.PRECISE","FORECAST.ETS","FORECAST.ETS.CONFINT","FORECAST.ETS.SEASONALITY","FORECAST.ETS.STAT","FORECAST.LINEAR","FORMULATEXT","GAMMA","GAMMA.DIST","GAMMA.INV","GAMMALN.PRECISE","GAUSS","HYPGEOM.DIST","IFNA","IFS","IMCOSH","IMCOT","IMCSC","IMCSCH","IMSEC","IMSECH","IMSINH","IMTAN","ISFORMULA","ISOWEEKNUM","LOGNORM.DIST","LOGNORM.INV","MAXIFS","MINIFS","MODE.MULT","MODE.SNGL","MUNIT","NEGBINOM.DIST","NORM.DIST","NORM.INV","NORM.S.DIST","NORM.S.INV","NUMBERVALUE","PDURATION","PERCENTILE.EXC","PERCENTILE.INC","PERCENTRANK.EXC","PERCENTRANK.INC","PERMUTATIONA","PHI","POISSON.DIST","QUARTILE.EXC","QUARTILE.INC","QUERYSTRING","RANK.AVG","RANK.EQ","RRI","SEC","SECH","SHEET","SHEETS","SKEW.P","STDEV.P","STDEV.S","SWITCH","T.DIST","T.DIST.2T","T.DIST.RT","T.INV","T.INV.2T","T.TEST","TEXTJOIN","UNICHAR","UNICODE","VAR.P","VAR.S","WEBSERVICE","WEIBULL.DIST","XOR","Z.TEST",];const CONTENT_TYPES_FILE="[Content_Types].xml";var WarningTypes;(function(WarningTypes){WarningTypes["DiagonalBorderNotSupported"]="Diagonal Borders";WarningTypes["BorderStyleNotSupported"]="Border style";WarningTypes["FillStyleNotSupported"]="Fill Style";WarningTypes["FontNotSupported"]="Font";WarningTypes["HorizontalAlignmentNotSupported"]="Horizontal Alignment";WarningTypes["VerticalAlignmentNotSupported"]="Vertical Alignments";WarningTypes["MultipleRulesCfNotSupported"]="Multiple rules conditional formats";WarningTypes["CfTypeNotSupported"]="Conditional format type";WarningTypes["CfFormatBorderNotSupported"]="Borders in conditional formats";WarningTypes["CfFormatAlignmentNotSupported"]="Alignment in conditional formats";WarningTypes["CfFormatNumFmtNotSupported"]="Num formats in conditional formats";WarningTypes["CfIconSetEmptyIconNotSupported"]="IconSets with empty icons";WarningTypes["BadlyFormattedHyperlink"]="Badly formatted hyperlink";WarningTypes["NumFmtIdNotSupported"]="Number format";})(WarningTypes||(WarningTypes={}));class XLSXImportWarningManager{_parsingWarnings=new Set();_conversionWarnings=new Set();addParsingWarning(warning){this._parsingWarnings.add(warning);}
addConversionWarning(warning){this._conversionWarnings.add(warning);}
get warnings(){return[...this._parsingWarnings,...this._conversionWarnings];}
generateNotSupportedWarning(type,name,supported){let warning=`${type} ${name ? '"' + name + '" is' : "are"} not yet supported. `;if(supported){warning+=`Only ${supported.join(", ")} are currently supported.`;}
if(!this._conversionWarnings.has(warning)){this._conversionWarnings.add(warning);}}}
const SUPPORTED_BORDER_STYLES=["thin"];const SUPPORTED_HORIZONTAL_ALIGNMENTS=["general","left","center","right",];const SUPPORTED_VERTICAL_ALIGNMENTS=["top","center","bottom"];const SUPPORTED_FONTS=["Arial"];const SUPPORTED_FILL_PATTERNS=["solid"];const SUPPORTED_CF_TYPES=["expression","cellIs","colorScale","iconSet","containsText","notContainsText","beginsWith","endsWith","containsBlanks","notContainsBlanks",];const CELL_TYPE_CONVERSION_MAP={b:"boolean",d:"date",e:"error",inlineStr:"inlineStr",n:"number",s:"sharedString",str:"str",};const BORDER_STYLE_CONVERSION_MAP={dashDot:"thin",dashDotDot:"thin",dashed:"dashed",dotted:"dotted",double:"thin",hair:"thin",medium:"medium",mediumDashDot:"thin",mediumDashDotDot:"thin",mediumDashed:"thin",none:undefined,slantDashDot:"thin",thick:"thick",thin:"thin",};const H_ALIGNMENT_CONVERSION_MAP={general:undefined,left:"left",center:"center",right:"right",fill:"left",justify:"left",centerContinuous:"center",distributed:"center",};const V_ALIGNMENT_CONVERSION_MAP={top:"top",center:"middle",bottom:"bottom",justify:"middle",distributed:"middle",};const V_ALIGNMENT_EXPORT_CONVERSION_MAP={top:"top",middle:"center",bottom:"bottom",};function convertCFCellIsOperator(xlsxCfOperator){return(xlsxCfOperator.slice(0,1).toUpperCase()+
xlsxCfOperator.slice(1));}
const CF_TYPE_CONVERSION_MAP={aboveAverage:undefined,expression:undefined,cellIs:undefined,colorScale:undefined,dataBar:undefined,iconSet:undefined,top10:undefined,uniqueValues:undefined,duplicateValues:undefined,containsText:"ContainsText",notContainsText:"NotContains",beginsWith:"BeginsWith",endsWith:"EndsWith",containsBlanks:"IsEmpty",notContainsBlanks:"IsNotEmpty",containsErrors:undefined,notContainsErrors:undefined,timePeriod:undefined,};const CF_THRESHOLD_CONVERSION_MAP={num:"number",percent:"percentage",max:"value",min:"value",percentile:"percentile",formula:"formula",};const ICON_SET_CONVERSION_MAP={NoIcons:undefined,"3Arrows":"arrows","3ArrowsGray":"arrows","3Symbols":"smiley","3Symbols2":"smiley","3Signs":"dots","3Flags":"dots","3TrafficLights1":"dots","3TrafficLights2":"dots","4Arrows":"arrows","4ArrowsGray":"arrows","4RedToBlack":"dots","4Rating":"smiley","4TrafficLights":"dots","5Arrows":"arrows","5ArrowsGray":"arrows","5Rating":"smiley","5Quarters":"dots","3Stars":"smiley","3Triangles":"arrows","5Boxes":"dots",};const DRAWING_LEGEND_POSITION_CONVERSION_MAP={b:"bottom",t:"top",l:"left",r:"right",tr:"right",};const CHART_TYPE_CONVERSION_MAP={areaChart:undefined,area3DChart:undefined,lineChart:"line",line3DChart:undefined,stockChart:undefined,radarChart:undefined,scatterChart:undefined,pieChart:"pie",pie3DChart:undefined,doughnutChart:"pie",barChart:"bar",bar3DChart:undefined,ofPieChart:undefined,surfaceChart:undefined,surface3DChart:undefined,bubbleChart:undefined,};const SUBTOTAL_FUNCTION_CONVERSION_MAP={"1":"AVERAGE","2":"COUNT","3":"COUNTA","4":"MAX","5":"MIN","6":"PRODUCT","7":"STDEV","8":"STDEVP","9":"SUM","10":"VAR","11":"VARP","101":"AVERAGE","102":"COUNT","103":"COUNTA","104":"MAX","105":"MIN","106":"PRODUCT","107":"STDEV","108":"STDEVP","109":"SUM","110":"VAR","111":"VARP",};const XLSX_FORMATS_CONVERSION_MAP={0:"",1:"0",2:"0.00",3:"#,#00",4:"#,##0.00",9:"0%",10:"0.00%",11:undefined,12:undefined,13:undefined,14:"m/d/yyyy",15:"m/d/yyyy",16:"m/d/yyyy",17:"m/d/yyyy",18:"hh:mm:ss a",19:"hh:mm:ss a",20:"hhhh:mm:ss",21:"hhhh:mm:ss",22:"m/d/yy h:mm",37:undefined,38:undefined,39:undefined,40:undefined,45:"hhhh:mm:ss",46:"hhhh:mm:ss",47:"hhhh:mm:ss",48:undefined,49:undefined,};const XLSX_FORMAT_MAP={"0":1,"0.00":2,"#,#00":3,"#,##0.00":4,"0%":9,"0.00%":10,"0.00E+00":11,"# ?/?":12,"# ??/??":13,"mm-dd-yy":14,"d-mm-yy":15,"mm-yy":16,"mmm-yy":17,"h:mm AM/PM":18,"h:mm:ss AM/PM":19,"h:mm":20,"h:mm:ss":21,"m/d/yy h:mm":22,"#,##0 ;(#,##0)":37,"#,##0 ;[Red](#,##0)":38,"#,##0.00;(#,##0.00)":39,"#,##0.00;[Red](#,##0.00)":40,"mm:ss":45,"[h]:mm:ss":46,"mmss.0":47,"##0.0E+0":48,"@":49,"hh:mm:ss a":19,};const XLSX_INDEXED_COLORS={0:"000000",1:"FFFFFF",2:"FF0000",3:"00FF00",4:"0000FF",5:"FFFF00",6:"FF00FF",7:"00FFFF",8:"000000",9:"FFFFFF",10:"FF0000",11:"00FF00",12:"0000FF",13:"FFFF00",14:"FF00FF",15:"00FFFF",16:"800000",17:"008000",18:"000080",19:"808000",20:"800080",21:"008080",22:"C0C0C0",23:"808080",24:"9999FF",25:"993366",26:"FFFFCC",27:"CCFFFF",28:"660066",29:"FF8080",30:"0066CC",31:"CCCCFF",32:"000080",33:"FF00FF",34:"FFFF00",35:"00FFFF",36:"800080",37:"800000",38:"008080",39:"0000FF",40:"00CCFF",41:"CCFFFF",42:"CCFFCC",43:"FFFF99",44:"99CCFF",45:"FF99CC",46:"CC99FF",47:"FFCC99",48:"3366FF",49:"33CCCC",50:"99CC00",51:"FFCC00",52:"FF9900",53:"FF6600",54:"666699",55:"969696",56:"003366",57:"339966",58:"003300",59:"333300",60:"993300",61:"993366",62:"333399",63:"333333",64:"000000",65:"FFFFFF",};const IMAGE_MIMETYPE_TO_EXTENSION_MAPPING={"image/avif":"avif","image/bmp":"bmp","image/gif":"gif","image/vnd.microsoft.icon":"ico","image/jpeg":"jpeg","image/png":"png","image/tiff":"tiff","image/webp":"webp",};const IMAGE_EXTENSION_TO_MIMETYPE_MAPPING={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",ico:"image/vnd.microsoft.icon",jpeg:"image/jpeg",png:"image/png",tiff:"image/tiff",webp:"image/webp",jpg:"image/jpeg",};function convertColor(xlsxColor){if(!xlsxColor){return undefined;}
let rgb;if(xlsxColor.rgb){rgb=xlsxColor.rgb;}
else if(xlsxColor.auto){rgb=AUTO_COLOR;}
else if(xlsxColor.indexed){rgb=XLSX_INDEXED_COLORS[xlsxColor.indexed];}
else{return undefined;}
rgb=xlsxColorToHEXA(rgb);if(xlsxColor.tint){rgb=applyTint(rgb,xlsxColor.tint);}
rgb=rgb.toUpperCase();if(rgb.length===9&&rgb.endsWith("FF")){rgb=rgb.slice(0,7);}
return rgb;}
function xlsxColorToHEXA(color){if(color.length===6)
return"#"+color+"FF";return"#"+color.slice(2)+color.slice(0,2);}
function applyTint(color,tint){const rgba=colorToRGBA(color);const hsla=rgbaToHSLA(rgba);if(tint<0){hsla.l=hsla.l*(1+tint);}
if(tint>0){hsla.l=hsla.l*(1-tint)+(100-100*(1-tint));}
return rgbaToHex(hslaToRGBA(hsla));}
function hexaToInt(hex){if(hex.length===9){hex=hex.slice(0,7);}
return parseInt(hex.replace("#",""),16);}
function getRelativePath(from,to){const fromPathParts=from.split("/");const toPathParts=to.split("/");let relPath="";let startIndex=0;for(let i=0;i<fromPathParts.length-1;i++){if(fromPathParts[i]===toPathParts[i]){startIndex++;}
else{relPath+="../";}}
relPath+=toPathParts.slice(startIndex).join("/");return relPath;}
function arrayToObject(array,indexOffset=0){const obj={};for(let i=0;i<array.length;i++){if(array[i]){obj[i+indexOffset]=array[i];}}
return obj;}
function objectToArray(obj){const arr=[];for(let key of Object.keys(obj).map(Number)){arr[key]=obj[key];}
return arr;}
function fixXlsxUnicode(str){return str.replace(/_x([0-9a-zA-Z]{4})_/g,(match,code)=>{return String.fromCharCode(parseInt(code,16));});}
const XLSX_DATE_FORMAT_REGEX=/^(yy|yyyy|m{1,5}|d{1,4}|h{1,2}|s{1,2}|am\/pm|a\/m|\s|-|\/|\.|:)+$/i;function convertXlsxFormat(numFmtId,formats,warningManager){if(numFmtId===0){return undefined;}
let format=XLSX_FORMATS_CONVERSION_MAP[numFmtId]||formats.find((f)=>f.id===numFmtId)?.format;if(format){try{let convertedFormat=format.replace(/(.*?);.*/,"$1");convertedFormat=convertedFormat.replace(/\[(.*)-[A-Z0-9]{3}\]/g,"[$1]");convertedFormat=convertedFormat.replace(/\[\$\]/g,"");const numberOfQuotes=convertedFormat.match(/"/g)?.length||0;const numberOfOpenBrackets=convertedFormat.match(/\[/g)?.length||0;if(numberOfQuotes/2+numberOfOpenBrackets>1){throw new Error("Multiple escaped blocks in format");}
convertedFormat=convertedFormat.replace(/"(.*)"/g,"[$$$1]");convertedFormat=convertedFormat.replace(/_.{1}/g,"");convertedFormat=convertedFormat.replace(/\*.{1}/g,"");convertedFormat=convertedFormat.replace(/\\ /g," ");convertedFormat=convertedFormat.replace(/\\./g,(match)=>match[1]);if(isXlsxDateFormat(convertedFormat)){convertedFormat=convertDateFormat$1(convertedFormat);}
if(isFormatSupported(convertedFormat)){return convertedFormat;}}
catch(e){}}
warningManager.generateNotSupportedWarning(WarningTypes.NumFmtIdNotSupported,format||`nmFmtId ${numFmtId}`);return undefined;}
function isFormatSupported(format){try{formatValue(0,{format,locale:DEFAULT_LOCALE});return true;}
catch(e){return false;}}
function isXlsxDateFormat(format){return XLSX_DATE_FORMAT_REGEX.test(format);}
function convertDateFormat$1(format){format=format.toLowerCase();format=format.replace(/mmmmm/g,"mmm");format=format.replace(/am\/pm|a\/m/g,"a");format=format.replace(/hhhh/g,"hh");format=format.replace(/\bh\b/g,"hh");return format;}
function convertBorders(data,warningManager){const borderArray=data.borders.map((border)=>{addBorderWarnings(border,warningManager);const b={top:convertBorderDescr$1(border.top,warningManager),bottom:convertBorderDescr$1(border.bottom,warningManager),left:convertBorderDescr$1(border.left,warningManager),right:convertBorderDescr$1(border.right,warningManager),};Object.keys(b).forEach((key)=>b[key]===undefined&&delete b[key]);return b;});return arrayToObject(borderArray,1);}
function convertBorderDescr$1(borderDescr,warningManager){if(!borderDescr)
return undefined;addBorderDescrWarnings(borderDescr,warningManager);const style=BORDER_STYLE_CONVERSION_MAP[borderDescr.style];return style?{style,color:convertColor(borderDescr.color)}:undefined;}
function convertStyles(data,warningManager){const stylesArray=data.styles.map((style)=>{return convertStyle({fontStyle:data.fonts[style.fontId],fillStyle:data.fills[style.fillId],alignment:style.alignment,},warningManager);});return arrayToObject(stylesArray,1);}
function convertStyle(styleStruct,warningManager){addStyleWarnings(styleStruct?.fontStyle,styleStruct?.fillStyle,warningManager);addHorizontalAlignmentWarnings(styleStruct?.alignment?.horizontal,warningManager);addVerticalAlignmentWarnings(styleStruct?.alignment?.vertical,warningManager);return{bold:styleStruct.fontStyle?.bold,italic:styleStruct.fontStyle?.italic,strikethrough:styleStruct.fontStyle?.strike,underline:styleStruct.fontStyle?.underline,verticalAlign:styleStruct.alignment?.vertical?V_ALIGNMENT_CONVERSION_MAP[styleStruct.alignment.vertical]:undefined,align:styleStruct.alignment?.horizontal?H_ALIGNMENT_CONVERSION_MAP[styleStruct.alignment.horizontal]:undefined,fillColor:styleStruct.fillStyle?.patternType==="solid"?convertColor(styleStruct.fillStyle?.fgColor):convertColor(styleStruct.fillStyle?.bgColor),textColor:convertColor(styleStruct.fontStyle?.color),fontSize:styleStruct.fontStyle?.size,wrapping:styleStruct.alignment?.wrapText?"wrap":"overflow",};}
function convertFormats(data,warningManager){const formats=[];for(let style of data.styles){const format=convertXlsxFormat(style.numFmtId,data.numFmts,warningManager);if(format){formats[style.numFmtId]=format;}}
return arrayToObject(formats,1);}
function addStyleWarnings(font,fill,warningManager){if(font&&font.name&&!SUPPORTED_FONTS.includes(font.name)){warningManager.generateNotSupportedWarning(WarningTypes.FontNotSupported,font.name,SUPPORTED_FONTS);}
if(fill&&fill.patternType&&!SUPPORTED_FILL_PATTERNS.includes(fill.patternType)){warningManager.generateNotSupportedWarning(WarningTypes.FillStyleNotSupported,fill.patternType,SUPPORTED_FILL_PATTERNS);}}
function addBorderDescrWarnings(borderDescr,warningManager){if(!SUPPORTED_BORDER_STYLES.includes(borderDescr.style)){warningManager.generateNotSupportedWarning(WarningTypes.BorderStyleNotSupported,borderDescr.style,SUPPORTED_BORDER_STYLES);}}
function addBorderWarnings(border,warningManager){if(border.diagonal){warningManager.generateNotSupportedWarning(WarningTypes.DiagonalBorderNotSupported);}}
function addHorizontalAlignmentWarnings(alignment,warningManager){if(alignment&&!SUPPORTED_HORIZONTAL_ALIGNMENTS.includes(alignment)){warningManager.generateNotSupportedWarning(WarningTypes.HorizontalAlignmentNotSupported,alignment,SUPPORTED_HORIZONTAL_ALIGNMENTS);}}
function addVerticalAlignmentWarnings(alignment,warningManager){if(alignment&&!SUPPORTED_VERTICAL_ALIGNMENTS.includes(alignment)){warningManager.generateNotSupportedWarning(WarningTypes.VerticalAlignmentNotSupported,alignment,SUPPORTED_VERTICAL_ALIGNMENTS);}}
function convertConditionalFormats(xlsxCfs,dxfs,warningManager){const cfs=[];let cfId=1;for(let cf of xlsxCfs){if(cf.cfRules.length===0)
continue;addCfConversionWarnings(cf,dxfs,warningManager);const rule=cf.cfRules[0];let operator;const values=[];if(rule.dxfId===undefined&&!(rule.type==="colorScale"||rule.type==="iconSet"))
continue;switch(rule.type){case"aboveAverage":case"containsErrors":case"notContainsErrors":case"dataBar":case"duplicateValues":case"expression":case"top10":case"uniqueValues":case"timePeriod":continue;case"colorScale":const colorScale=convertColorScale(cfId++,cf);if(colorScale){cfs.push(colorScale);}
continue;case"iconSet":const iconSet=convertIconSet(cfId++,cf,warningManager);if(iconSet){cfs.push(iconSet);}
continue;case"containsText":case"notContainsText":case"beginsWith":case"endsWith":if(!rule.text)
continue;operator=CF_TYPE_CONVERSION_MAP[rule.type];values.push(rule.text);break;case"containsBlanks":case"notContainsBlanks":operator=CF_TYPE_CONVERSION_MAP[rule.type];break;case"cellIs":if(!rule.operator||!rule.formula||rule.formula.length===0)
continue;operator=convertCFCellIsOperator(rule.operator);values.push(rule.formula[0]);if(rule.formula.length===2){values.push(rule.formula[1]);}
break;}
if(operator&&rule.dxfId!==undefined){cfs.push({id:(cfId++).toString(),ranges:cf.sqref,stopIfTrue:rule.stopIfTrue,rule:{type:"CellIsRule",operator:operator,values:values,style:convertStyle({fontStyle:dxfs[rule.dxfId].font,fillStyle:dxfs[rule.dxfId].fill},warningManager),},});}}
return cfs;}
function convertColorScale(id,xlsxCf){const scale=xlsxCf.cfRules[0].colorScale;if(!scale||scale.cfvos.length!==scale.colors.length||scale.cfvos.length<2||scale.cfvos.length>3){return undefined;}
const thresholds=[];for(let i=0;i<scale.cfvos.length;i++){thresholds.push({color:hexaToInt(convertColor(scale.colors[i])||"#FFFFFF"),type:CF_THRESHOLD_CONVERSION_MAP[scale.cfvos[i].type],value:scale.cfvos[i].value,});}
const minimum=thresholds[0];const maximum=thresholds.length===2?thresholds[1]:thresholds[2];const midpoint=thresholds.length===3?thresholds[1]:undefined;return{id:id.toString(),stopIfTrue:xlsxCf.cfRules[0].stopIfTrue,ranges:xlsxCf.sqref,rule:{type:"ColorScaleRule",minimum,midpoint,maximum},};}
function convertIconSet(id,xlsxCf,warningManager){const xlsxIconSet=xlsxCf.cfRules[0].iconSet;if(!xlsxIconSet)
return undefined;let cfVos=xlsxIconSet.cfvos;let cfIcons=xlsxIconSet.cfIcons;if(cfVos.length<3||(cfIcons&&cfIcons.length<3)){return undefined;}
if(cfVos.length>3){cfVos=[cfVos[0],cfVos[Math.floor(cfVos.length/2)],cfVos[cfVos.length-1]];}
if(cfIcons&&cfIcons.length>3){cfIcons=[cfIcons[0],cfIcons[Math.floor(cfIcons.length/2)],cfIcons[cfIcons.length-1]];}
const thresholds=[];for(let i=1;i<=2;i++){const type=CF_THRESHOLD_CONVERSION_MAP[cfVos[i].type];if(type==="value"){return undefined;}
thresholds.push({value:cfVos[i].value||"",operator:cfVos[i].gte?"ge":"gt",type:type,});}
let icons={lower:cfIcons?convertIcons(cfIcons[0].iconSet,cfIcons[0].iconId):convertIcons(xlsxIconSet.iconSet,0),middle:cfIcons?convertIcons(cfIcons[1].iconSet,cfIcons[1].iconId):convertIcons(xlsxIconSet.iconSet,1),upper:cfIcons?convertIcons(cfIcons[2].iconSet,cfIcons[2].iconId):convertIcons(xlsxIconSet.iconSet,2),};if(xlsxIconSet.reverse){icons={upper:icons.lower,middle:icons.middle,lower:icons.upper};}
for(let key of Object.keys(icons)){if(!icons[key]){warningManager.generateNotSupportedWarning(WarningTypes.CfIconSetEmptyIconNotSupported);switch(key){case"upper":icons[key]=ICON_SETS.dots.good;break;case"middle":icons[key]=ICON_SETS.dots.neutral;break;case"lower":icons[key]=ICON_SETS.dots.bad;break;}}}
return{id:id.toString(),stopIfTrue:xlsxCf.cfRules[0].stopIfTrue,ranges:xlsxCf.sqref,rule:{type:"IconSetRule",icons:icons,upperInflectionPoint:thresholds[1],lowerInflectionPoint:thresholds[0],},};}
function convertIcons(xlsxIconSet,index){const iconSet=ICON_SET_CONVERSION_MAP[xlsxIconSet];if(!iconSet)
return"";return index===0?ICON_SETS[iconSet].bad:index===1?ICON_SETS[iconSet].neutral:ICON_SETS[iconSet].good;}
function addCfConversionWarnings(cf,dxfs,warningManager){if(cf.cfRules.length>1){warningManager.generateNotSupportedWarning(WarningTypes.MultipleRulesCfNotSupported);}
if(!SUPPORTED_CF_TYPES.includes(cf.cfRules[0].type)){warningManager.generateNotSupportedWarning(WarningTypes.CfTypeNotSupported,cf.cfRules[0].type);}
if(cf.cfRules[0].dxfId){const dxf=dxfs[cf.cfRules[0].dxfId];if(dxf.border){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatBorderNotSupported);}
if(dxf.alignment){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatAlignmentNotSupported);}
if(dxf.numFmt){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatNumFmtNotSupported);}}}
function convertOperator(operator){switch(operator){case"IsNotEmpty":return"notContainsBlanks";case"IsEmpty":return"containsBlanks";case"NotContains":return"notContainsBlanks";default:return operator.charAt(0).toLowerCase()+operator.slice(1);}}
function convertHeightToExcel(height){return Math.round(HEIGHT_FACTOR*height*100)/100;}
function convertWidthToExcel(width){return Math.round(WIDTH_FACTOR*width*100)/100;}
function convertHeightFromExcel(height){if(!height)
return height;return Math.round((height/HEIGHT_FACTOR)*100)/100;}
function convertWidthFromExcel(width){if(!width)
return width;return Math.round((width/WIDTH_FACTOR)*100)/100;}
function extractStyle(cell,data){let style={};if(cell.style){style=data.styles[cell.style];}
const format=extractFormat(cell,data);const styles={font:{size:style?.fontSize||DEFAULT_FONT_SIZE,color:{rgb:style?.textColor?style.textColor:"000000"},family:2,name:"Arial",},fill:style?.fillColor?{fgColor:{rgb:style.fillColor},}:{reservedAttribute:"none"},numFmt:format?{format:format,id:0}:undefined,border:cell.border||0,alignment:{horizontal:style.align,vertical:style.verticalAlign?V_ALIGNMENT_EXPORT_CONVERSION_MAP[style.verticalAlign]:undefined,wrapText:style.wrapping==="wrap",},};styles.font["strike"]=!!style?.strikethrough||undefined;styles.font["underline"]=!!style?.underline||undefined;styles.font["bold"]=!!style?.bold||undefined;styles.font["italic"]=!!style?.italic||undefined;return styles;}
function extractFormat(cell,data){if(cell.format){return data.formats[cell.format];}
return undefined;}
function normalizeStyle(construct,styles){const numFmtId=convertFormat(styles["numFmt"],construct.numFmts);const style={fontId:pushElement(styles.font,construct.fonts),fillId:pushElement(styles.fill,construct.fills),borderId:styles.border,numFmtId,alignment:{vertical:styles.alignment.vertical,horizontal:styles.alignment.horizontal,wrapText:styles.alignment.wrapText,},};return pushElement(style,construct.styles);}
function convertFormat(format,numFmtStructure){if(!format){return 0;}
let formatId=XLSX_FORMAT_MAP[format.format];if(!formatId){formatId=pushElement(format,numFmtStructure)+FIRST_NUMFMT_ID;}
return formatId;}
function addRelsToFile(relsFiles,path,rel){let relsFile=relsFiles.find((file)=>file.path===path);let id;if(!relsFile){id="rId1";relsFiles.push({path,rels:[{...rel,id}]});}
else{id=`rId${(relsFile.rels.length + 1).toString()}`;relsFile.rels.push({...rel,id,});}
return id;}
function pushElement(property,propertyList){let len=propertyList.length;const operator=typeof property==="object"?deepEquals:(a,b)=>a===b;for(let i=0;i<len;i++){if(operator(property,propertyList[i])){return i;}}
propertyList[propertyList.length]=property;return propertyList.length-1;}
const chartIds=[];function convertChartId(chartId){const xlsxId=chartIds.findIndex((id)=>id===chartId);if(xlsxId===-1){chartIds.push(chartId);return chartIds.length;}
return xlsxId+1;}
const imageIds=[];function convertImageId(imageId){const xlsxId=imageIds.findIndex((id)=>id===imageId);if(xlsxId===-1){imageIds.push(imageId);return imageIds.length;}
return xlsxId+1;}
function convertDotValueToEMU(value){const DPI=96;return Math.round((value*914400)/DPI);}
function getRangeSize(reference,defaultSheetIndex,data){let xc=reference;let sheetName=undefined;({xc,sheetName}=splitReference(reference));let rangeSheetIndex;if(sheetName){const index=data.sheets.findIndex((sheet)=>sheet.name===sheetName);if(index<0){throw new Error("Unable to find a sheet with the name "+sheetName);}
rangeSheetIndex=index;}
else{rangeSheetIndex=Number(defaultSheetIndex);}
const zone=toUnboundedZone(xc);if(zone.right===undefined){zone.right=data.sheets[rangeSheetIndex].colNumber;}
if(zone.bottom===undefined){zone.bottom=data.sheets[rangeSheetIndex].rowNumber;}
return(zone.right-zone.left+1)*(zone.bottom-zone.top+1);}
function convertEMUToDotValue(value){const DPI=96;return Math.round((value*DPI)/914400);}
function getColPosition(colIndex,sheetData){let position=0;for(let i=0;i<colIndex;i++){const colAtIndex=sheetData.cols.find((col)=>i>=col.min&&i<=col.max);if(colAtIndex?.width){position+=colAtIndex.width;}
else if(sheetData.sheetFormat?.defaultColWidth){position+=sheetData.sheetFormat.defaultColWidth;}
else{position+=EXCEL_DEFAULT_COL_WIDTH;}}
return position/WIDTH_FACTOR;}
function getRowPosition(rowIndex,sheetData){let position=0;for(let i=0;i<rowIndex;i++){const rowAtIndex=sheetData.rows[i];if(rowAtIndex?.height){position+=rowAtIndex.height;}
else if(sheetData.sheetFormat?.defaultRowHeight){position+=sheetData.sheetFormat.defaultRowHeight;}
else{position+=EXCEL_DEFAULT_ROW_HEIGHT;}}
return position/HEIGHT_FACTOR;}
function convertFigures(sheetData){let id=1;return sheetData.figures.map((figure)=>convertFigure(figure,(id++).toString(),sheetData)).filter(isDefined$1);}
function convertFigure(figure,id,sheetData){const x1=getColPosition(figure.anchors[0].col,sheetData)+
convertEMUToDotValue(figure.anchors[0].colOffset);const x2=getColPosition(figure.anchors[1].col,sheetData)+
convertEMUToDotValue(figure.anchors[1].colOffset);const y1=getRowPosition(figure.anchors[0].row,sheetData)+
convertEMUToDotValue(figure.anchors[0].rowOffset);const y2=getRowPosition(figure.anchors[1].row,sheetData)+
convertEMUToDotValue(figure.anchors[1].rowOffset);const figureData={id,x:x1,y:y1};if(isChartData(figure.data)){return{...figureData,width:x2-x1,height:y2-y1,tag:"chart",data:convertChartData(figure.data),};}
else if(isImageData(figure.data)){return{...figureData,width:convertEMUToDotValue(figure.data.size.cx),height:convertEMUToDotValue(figure.data.size.cy),tag:"image",data:{path:figure.data.imageSrc,mimetype:figure.data.mimetype,},};}
return undefined;}
function isChartData(data){return"dataSets"in data;}
function isImageData(data){return"imageSrc"in data;}
function convertChartData(chartData){const dataSetsHaveTitle=chartData.dataSets[0].label!==undefined;const labelRange=chartData.labelRange?convertExcelRangeToSheetXC(chartData.labelRange,dataSetsHaveTitle):undefined;let dataSets=chartData.dataSets.map((data)=>convertExcelRangeToSheetXC(data.range,dataSetsHaveTitle));if(chartData.type==="pie"){dataSets.reverse();}
return{dataSets,dataSetsHaveTitle,labelRange,title:chartData.title||"",type:chartData.type,background:convertColor({rgb:chartData.backgroundColor})||"#FFFFFF",verticalAxisPosition:chartData.verticalAxisPosition,legendPosition:chartData.legendPosition,stacked:chartData.stacked||false,aggregated:false,cumulative:chartData.cumulative||false,labelsAsText:false,};}
function convertExcelRangeToSheetXC(range,dataSetsHaveTitle){let{sheetName,xc}=splitReference(range);if(sheetName){sheetName=getCanonicalSheetName(sheetName)+"!";}
else{sheetName="";}
let zone=toUnboundedZone(xc);if(dataSetsHaveTitle&&zone.bottom!==undefined&&zone.right!==undefined){const height=zone.bottom-zone.top+1;const width=zone.right-zone.left+1;if(height===1){zone={...zone,left:zone.left-1};}
else if(width===1){zone={...zone,top:zone.top-1};}}
const dataXC=zoneToXc(zone);return sheetName+dataXC;}
const externalReferenceRegex=new RegExp(/'?\[([0-9]*)\](.*)'?!(\$?[a-zA-Z]*\$?[0-9]*)/g);const subtotalRegex=new RegExp(/SUBTOTAL\(([0-9]*),/g);const cellRegex=new RegExp(cellReference.source,"ig");function convertFormulasContent(sheet,data){const sfMap=getSharedFormulasMap(sheet);for(let cell of sheet.rows.map((row)=>row.cells).flat()){if(cell?.formula){cell.formula.content=cell.formula.sharedIndex!==undefined&&!cell.formula.content?"="+adaptFormula(cell.xc,sfMap[cell.formula.sharedIndex]):"="+cell.formula.content;cell.formula.content=convertFormula(cell.formula.content,data);}}}
function getSharedFormulasMap(sheet){const formulas={};for(let row of sheet.rows){for(let cell of row.cells){if(cell.formula&&cell.formula.sharedIndex!==undefined&&cell.formula.content){formulas[cell.formula.sharedIndex]={refCellXc:cell.xc,formula:cell.formula.content};}}}
return formulas;}
function convertFormula(formula,data){formula=formula.replace("_xlfn.","");formula=formula.replace(/#REF!/g,"#REF");formula=formula.replace(subtotalRegex,(match,functionId)=>{const convertedFunction=SUBTOTAL_FUNCTION_CONVERSION_MAP[functionId];return convertedFunction?convertedFunction+"(":match;});formula=formula.replace(externalReferenceRegex,(match,externalRefId,sheetName,cellRef)=>{externalRefId=Number(externalRefId)-1;cellRef=cellRef.replace(/\$/g,"");const sheetIndex=data.externalBooks[externalRefId].sheetNames.findIndex((name)=>name===sheetName);if(sheetIndex===-1){return match;}
const externalDataset=data.externalBooks[externalRefId].datasets.find((dataset)=>dataset.sheetId===sheetIndex)?.data;if(!externalDataset){return match;}
const datasetValue=externalDataset&&externalDataset[cellRef];const convertedValue=Number(datasetValue)?datasetValue:`"${datasetValue}"`;return convertedValue||match;});return formula;}
function adaptFormula(targetCell,sf){const refPosition=toCartesian(sf.refCellXc);let newFormula=sf.formula.slice();let match;do{match=cellRegex.exec(newFormula);if(match){const formulaPosition=toCartesian(match[0].replace("$",""));const targetPosition=toCartesian(targetCell);const rangePart={colFixed:match[0].startsWith("$"),rowFixed:match[0].includes("$",1),};const offset={col:targetPosition.col-refPosition.col,row:targetPosition.row-refPosition.row,};const offsettedPosition={col:rangePart.colFixed?formulaPosition.col:formulaPosition.col+offset.col,row:rangePart.rowFixed?formulaPosition.row:formulaPosition.row+offset.row,};newFormula=newFormula.slice(0,match.index)+
toXC(offsettedPosition.col,offsettedPosition.row,rangePart)+
newFormula.slice(match.index+match[0].length);}}while(match);return newFormula;}
function convertSheets(data,warningManager){return data.sheets.map((sheet)=>{convertFormulasContent(sheet,data);const sheetDims=getSheetDims(sheet);const sheetOptions=sheet.sheetViews[0];return{id:sheet.sheetName,areGridLinesVisible:sheetOptions?sheetOptions.showGridLines:true,name:sheet.sheetName,colNumber:sheetDims[0],rowNumber:sheetDims[1],cells:convertCells(sheet,data,sheetDims,warningManager),merges:sheet.merges,cols:convertCols(sheet,sheetDims[0]),rows:convertRows(sheet,sheetDims[1]),conditionalFormats:convertConditionalFormats(sheet.cfs,data.dxfs,warningManager),figures:convertFigures(sheet),isVisible:sheet.isVisible,panes:sheetOptions?{xSplit:sheetOptions.pane.xSplit,ySplit:sheetOptions.pane.ySplit}:{xSplit:0,ySplit:0},filterTables:[],};});}
function convertCols(sheet,numberOfCols){const cols={};for(let i=1;i<numberOfCols+1;i++){const col=sheet.cols.find((col)=>col.min<=i&&i<=col.max);let colSize;if(col&&col.width)
colSize=col.width;else if(sheet.sheetFormat?.defaultColWidth)
colSize=sheet.sheetFormat.defaultColWidth;else
colSize=EXCEL_DEFAULT_COL_WIDTH;cols[i-1]={size:convertWidthFromExcel(colSize),isHidden:col?.hidden};}
return cols;}
function convertRows(sheet,numberOfRows){const rows={};for(let i=1;i<numberOfRows+1;i++){const row=sheet.rows.find((row)=>row.index===i);let rowSize;if(row&&row.height)
rowSize=row.height;else if(sheet.sheetFormat?.defaultRowHeight)
rowSize=sheet.sheetFormat.defaultRowHeight;else
rowSize=EXCEL_DEFAULT_ROW_HEIGHT;rows[i-1]={size:convertHeightFromExcel(rowSize),isHidden:row?.hidden};}
return rows;}
function convertSharedStrings(xlsxSharedStrings){return xlsxSharedStrings.map((str)=>str.replace(/\n/g,""));}
function convertCells(sheet,data,sheetDims,warningManager){const cells={};const sharedStrings=convertSharedStrings(data.sharedStrings);const hyperlinkMap=sheet.hyperlinks.reduce((map,link)=>{map[link.xc]=link;return map;},{});for(let row of sheet.rows){for(let cell of row.cells){cells[cell.xc]={content:getCellValue(cell,hyperlinkMap,sharedStrings,warningManager),style:cell.styleIndex?cell.styleIndex+1:undefined,border:cell.styleIndex?data.styles[cell.styleIndex].borderId+1:undefined,format:cell.styleIndex?data.styles[cell.styleIndex].numFmtId+1:undefined,};}}
for(let row of sheet.rows.filter((row)=>row.styleIndex)){for(let colIndex=1;colIndex<=sheetDims[0];colIndex++){const xc=toXC(colIndex-1,row.index-1);let cell=cells[xc];if(!cell){cell={};cells[xc]=cell;}
cell.style=cell.style?cell.style:row.styleIndex+1;cell.border=cell.border?cell.border:data.styles[row.styleIndex].borderId+1;cell.format=cell.format?cell.format:data.styles[row.styleIndex].numFmtId+1;}}
for(let col of sheet.cols.filter((col)=>col.styleIndex)){for(let colIndex=col.min;colIndex<=Math.min(col.max,sheetDims[0]);colIndex++){for(let rowIndex=1;rowIndex<=sheetDims[1];rowIndex++){const xc=toXC(colIndex-1,rowIndex-1);let cell=cells[xc];if(!cell){cell={};cells[xc]=cell;}
cell.style=cell.style?cell.style:col.styleIndex+1;cell.border=cell.border?cell.border:data.styles[col.styleIndex].borderId+1;cell.format=cell.format?cell.format:data.styles[col.styleIndex].numFmtId+1;}}}
return cells;}
function getCellValue(cell,hyperLinksMap,sharedStrings,warningManager){let cellValue;switch(cell.type){case"sharedString":const ssIndex=parseInt(cell.value,10);cellValue=sharedStrings[ssIndex];break;case"boolean":cellValue=Number(cell.value)?"TRUE":"FALSE";break;case"date":case"error":case"inlineStr":case"number":case"str":cellValue=cell.value;break;}
if(cellValue&&hyperLinksMap[cell.xc]){cellValue=convertHyperlink(hyperLinksMap[cell.xc],cellValue,warningManager);}
if(cell.formula){cellValue=cell.formula.content;}
return cellValue;}
function convertHyperlink(link,cellValue,warningManager){const label=link.display||cellValue;if(!link.relTarget&&!link.location){warningManager.generateNotSupportedWarning(WarningTypes.BadlyFormattedHyperlink);}
const url=link.relTarget?link.relTarget:buildSheetLink(splitReference(link.location).sheetName);return markdownLink(label,url);}
function getSheetDims(sheet){const dims=[0,0];for(let row of sheet.rows){dims[0]=Math.max(dims[0],largeMax(row.cells.map((cell)=>toCartesian(cell.xc).col)));dims[1]=Math.max(dims[1],row.index);}
dims[0]=Math.max(dims[0],EXCEL_IMPORT_DEFAULT_NUMBER_OF_COLS);dims[1]=Math.max(dims[1],EXCEL_IMPORT_DEFAULT_NUMBER_OF_ROWS);return dims;}
const TABLE_HEADER_STYLE={fillColor:"#000000",textColor:"#ffffff",bold:true,};const TABLE_HIGHLIGHTED_CELL_STYLE={bold:true,};const TABLE_BORDER_STYLE={style:"thin",color:"#000000FF"};function convertTables(convertedData,xlsxData){for(const xlsxSheet of xlsxData.sheets){for(const table of xlsxSheet.tables){const sheet=convertedData.sheets.find((sheet)=>sheet.name===xlsxSheet.sheetName);if(!sheet||!table.autoFilter)
continue;if(!sheet.filterTables)
sheet.filterTables=[];sheet.filterTables.push({range:table.ref});}}
applyTableStyle(convertedData,xlsxData);convertTableFormulaReferences(convertedData.sheets,xlsxData.sheets);}
function applyTableStyle(convertedData,xlsxData){const styles=objectToArray(convertedData.styles);const borders=objectToArray(convertedData.borders);for(let xlsxSheet of xlsxData.sheets){for(let table of xlsxSheet.tables){const sheet=convertedData.sheets.find((sheet)=>sheet.name===xlsxSheet.sheetName);if(!sheet)
continue;const tableZone=toZone(table.ref);for(let i=0;i<table.headerRowCount;i++){applyStyleToZone(TABLE_HEADER_STYLE,{...tableZone,bottom:tableZone.top+i},sheet.cells,styles);}
for(let i=0;i<table.totalsRowCount;i++){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,top:tableZone.bottom-i},sheet.cells,styles);}
if(table.style?.showFirstColumn){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,right:tableZone.left},sheet.cells,styles);}
if(table.style?.showLastColumn){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,left:tableZone.right},sheet.cells,styles);}
for(let col=tableZone.left;col<=tableZone.right;col++){for(let row=tableZone.top;row<=tableZone.bottom;row++){const xc=toXC(col,row);const cell=sheet.cells[xc];const border={left:col===tableZone.left||table.style?.showColumnStripes?TABLE_BORDER_STYLE:undefined,right:col===tableZone.right?TABLE_BORDER_STYLE:undefined,top:row===tableZone.top||table.style?.showRowStripes||row>tableZone.bottom-table.totalsRowCount?TABLE_BORDER_STYLE:undefined,bottom:row===tableZone.bottom?TABLE_BORDER_STYLE:undefined,};const newBorder=cell?.border?{...borders[cell.border],...border}:border;let borderIndex=borders.findIndex((border)=>deepEquals(border,newBorder));if(borderIndex===-1){borderIndex=borders.length;borders.push(newBorder);}
if(cell){cell.border=borderIndex;}
else{sheet.cells[xc]={border:borderIndex};}}}}}
convertedData.styles=arrayToObject(styles);convertedData.borders=arrayToObject(borders);}
function applyStyleToZone(appliedStyle,zone,cells,styles){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const xc=toXC(col,row);const cell=cells[xc];const newStyle=cell?.style?{...styles[cell.style],...appliedStyle}:appliedStyle;let styleIndex=styles.findIndex((style)=>deepEquals(style,newStyle));if(styleIndex===-1){styleIndex=styles.length;styles.push(newStyle);}
if(cell){cell.style=styleIndex;}
else{cells[xc]={style:styleIndex};}}}}
function convertTableFormulaReferences(convertedSheets,xlsxSheets){for(let sheet of convertedSheets){const tables=xlsxSheets.find((s)=>s.sheetName===sheet.name).tables;for(let table of tables){const tabRef=table.name+"[";for(let position of positions(toZone(table.ref))){const xc=toXC(position.col,position.row);const cell=sheet.cells[xc];if(cell&&cell.content&&cell.content.startsWith("=")){let refIndex;while((refIndex=cell.content.indexOf(tabRef))!==-1){let reference=cell.content.slice(refIndex+tabRef.length);let endIndex=reference.indexOf("]");if(reference.startsWith(`[`)){endIndex=reference.indexOf("]",endIndex+1);endIndex=reference.indexOf("]",endIndex+1);}
reference=reference.slice(0,endIndex);const convertedRef=convertTableReference(reference,table,xc);cell.content=cell.content.slice(0,refIndex)+
convertedRef+
cell.content.slice(tabRef.length+refIndex+endIndex+1);}}}}}}
function convertTableReference(expr,table,cellXc){const refElements=expr.split(",");const tableZone=toZone(table.ref);const refZone={...tableZone};let isReferencedZoneValid=true;if(refElements.length===1){const colRelativeIndex=table.cols.findIndex((col)=>col.name===refElements[0]);refZone.left=refZone.right=colRelativeIndex+tableZone.left;if(table.headerRowCount){refZone.top+=table.headerRowCount;}
if(table.totalsRowCount){refZone.bottom-=1;}}
else{switch(refElements[0].slice(1,refElements[0].length-1)){case"#All":refZone.top=table.headerRowCount?tableZone.top+table.headerRowCount:tableZone.top;refZone.bottom=tableZone.bottom;break;case"#Data":refZone.top=table.headerRowCount?tableZone.top+table.headerRowCount:tableZone.top;refZone.bottom=table.totalsRowCount?tableZone.bottom+1:tableZone.bottom;break;case"#This Row":refZone.top=refZone.bottom=toCartesian(cellXc).row;break;case"#Headers":refZone.top=refZone.bottom=tableZone.top;if(!table.headerRowCount){isReferencedZoneValid=false;}
break;case"#Totals":refZone.top=refZone.bottom=tableZone.bottom;if(!table.totalsRowCount){isReferencedZoneValid=false;}
break;}
const colRef=refElements[1].slice(1,refElements[1].length-1);const colRelativeIndex=table.cols.findIndex((col)=>col.name===colRef);refZone.left=refZone.right=colRelativeIndex+tableZone.left;}
if(!isReferencedZoneValid){return INCORRECT_RANGE_STRING;}
return refZone.top!==refZone.bottom?zoneToXc(refZone):toXC(refZone.left,refZone.top);}
function createXMLFile(doc,path,contentType){return{content:new XMLSerializer().serializeToString(doc),path,contentType,};}
function xmlEscape(str){return(String(str).replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,""));}
function formatAttributes(attrs){return new XMLString(attrs.map(([key,val])=>`${key}="${xmlEscape(val)}"`).join(" "));}
function parseXML(xmlString,mimeType="text/xml"){const document=new DOMParser().parseFromString(xmlString.toString(),mimeType);const parserError=document.querySelector("parsererror");if(parserError){const errorString=parserError.innerHTML;const lineNumber=parseInt(errorString.split(":")[0],10);const xmlStringArray=xmlString.toString().trim().split("\n");const xmlPreview=xmlStringArray.slice(Math.max(lineNumber-3,0),Math.min(lineNumber+2,xmlStringArray.length)).join("\n");throw new Error(`XML string could not be parsed: ${errorString}\n${xmlPreview}`);}
return document;}
function convertBorderDescr(descr){if(!descr){return undefined;}
return{style:descr.style,color:{rgb:descr.color},};}
function getDefaultXLSXStructure(data){const xlsxBorders=Object.values(data.borders).map((border)=>{return{left:convertBorderDescr(border.left),right:convertBorderDescr(border.right),bottom:convertBorderDescr(border.bottom),top:convertBorderDescr(border.top),};});const borders=[{},...xlsxBorders];return{relsFiles:[],sharedStrings:[],styles:[{fontId:0,fillId:0,numFmtId:0,borderId:0,alignment:{vertical:"bottom"},},],fonts:[{size:DEFAULT_FONT_SIZE,family:2,color:{rgb:"000000"},name:"Calibri",},],fills:[{reservedAttribute:"none"},{reservedAttribute:"gray125"}],borders,numFmts:[],dxfs:[],};}
function createOverride(partName,contentType){return escapeXml`
    <Override ContentType="${contentType}" PartName="${partName}" />
  `;}
function createDefaultXMLElement(extension,contentType){return escapeXml`
    <Default Extension="${extension}" ContentType="${contentType}" />
  `;}
function joinXmlNodes(xmlNodes){return new XMLString(xmlNodes.join("\n"));}
function escapeXml(strings,...expressions){let str=[strings[0]];for(let i=0;i<expressions.length;i++){const value=expressions[i]instanceof XMLString?expressions[i]:xmlEscape(expressions[i]);str.push(value+strings[i+1]);}
return new XMLString(concat(str));}
function removeTagEscapedNamespaces(tag){return tag.replace(/NAMESPACE.*NAMESPACE(.*)/,"$1");}
function escapeTagNamespaces(str){return str.replaceAll(/(<\/?)([a-zA-Z0-9]+):([a-zA-Z0-9]+)/g,"$1"+"NAMESPACE"+"$2"+"NAMESPACE"+"$3");}
function escapeQueryNameSpaces(query){return query.replaceAll(/([a-zA-Z0-9]+):([a-zA-Z0-9]+)/g,"NAMESPACE"+"$1"+"NAMESPACE"+"$2");}
class AttributeValue{value;constructor(value){this.value=value;}
asString(){return fixXlsxUnicode(String(this.value));}
asBool(){if(this.value==="true")
return true;if(this.value==="false")
return false;return Boolean(Number(this.value));}
asNum(){return Number(this.value);}}
class XlsxBaseExtractor{rootFile;xlsxFileStructure;warningManager;relationships;currentFile=undefined;constructor(rootFile,xlsxStructure,warningManager){this.rootFile=rootFile;this.currentFile=rootFile.file.fileName;this.xlsxFileStructure=xlsxStructure;this.warningManager=warningManager;this.relationships={};if(rootFile.rels){this.extractRelationships(rootFile.rels).map((rel)=>{this.relationships[rel.id]=rel;});}}
extractRelationships(relFile){return this.mapOnElements({parent:relFile.xml,query:"Relationship"},(relationshipElement)=>{return{id:this.extractAttr(relationshipElement,"Id",{required:true}).asString(),target:this.extractAttr(relationshipElement,"Target",{required:true}).asString(),type:this.extractAttr(relationshipElement,"Type",{required:true}).asString(),};});}
getListOfXMLFiles(){const XMLFiles=Object.entries(this.xlsxFileStructure).filter(([key])=>key!=="images").map(([_,value])=>value).flat().filter(isDefined$1);return XMLFiles;}
mapOnElements(args,fct){const ret=[];const oldWorkingDocument=this.currentFile;let elements;if(args.children){const children=this.querySelector(args.parent,args.query)?.children;elements=children?children:[];}
else{elements=this.querySelectorAll(args.parent,args.query);}
if(elements){for(let element of elements){try{ret.push(fct(element));}
catch(e){this.catchErrorOnElement(e,element);}}}
this.currentFile=oldWorkingDocument;return ret;}
catchErrorOnElement(error,onElement){const errorMsg=onElement?`Error when parsing an element <${onElement.tagName}> of file ${this.currentFile}, skip this element. \n${error.stack}`:`Error when parsing file ${this.currentFile}.`;this.warningManager.addParsingWarning([errorMsg,error.message].join("\n"));}
extractAttr(e,attName,optionalArgs){const attribute=e.attributes[attName];if(!attribute)
this.handleMissingValue(e,`attribute "${attName}"`,optionalArgs);const value=attribute?.value?attribute.value:optionalArgs?.default;return(value===undefined?undefined:new AttributeValue(value));}
extractTextContent(element,optionalArgs){if(optionalArgs?.default!==undefined&&typeof optionalArgs.default!=="string"){throw new Error("extractTextContent default value should be a string");}
const shouldPreserveSpaces=element?.attributes["xml:space"]?.value==="preserve";let textContent=element?.textContent;if(!element||textContent===null){this.handleMissingValue(element,`text content`,optionalArgs);}
if(textContent){textContent=shouldPreserveSpaces?textContent:textContent.trim();}
return(textContent?fixXlsxUnicode(textContent):optionalArgs?.default);}
extractChildAttr(e,childRef,attName,optionalArgs){let child;if(typeof childRef==="number"){child=e.children[childRef];}
else{child=this.querySelector(e,childRef);}
if(!child){this.handleMissingValue(e,typeof childRef==="number"?`child at index ${childRef}`:`child <${childRef}>`,optionalArgs);}
const value=child?this.extractAttr(child,attName,optionalArgs)?.asString():optionalArgs?.default;return(value!==undefined?new AttributeValue(value):undefined);}
extractChildTextContent(e,childRef,optionalArgs){if(optionalArgs?.default!==undefined&&typeof optionalArgs.default!=="string"){throw new Error("extractTextContent default value should be a string");}
let child=this.querySelector(e,childRef);if(!child){this.handleMissingValue(e,`child <${childRef}>`,optionalArgs);}
return(child?this.extractTextContent(child,optionalArgs):optionalArgs?.default);}
handleMissingValue(parentElement,missingElementName,optionalArgs){if(optionalArgs?.required){if(optionalArgs?.default){this.warningManager.addParsingWarning(`Missing required ${missingElementName} in element <${parentElement.tagName}> of ${this.currentFile}, replacing it by the default value ${optionalArgs.default}`);}
else{throw new Error(`Missing required ${missingElementName} in element <${parentElement.tagName}> of ${this.currentFile}, and no default value was set`);}}}
extractColor(colorElement,theme,defaultColor){if(!colorElement){return defaultColor?{rgb:defaultColor}:undefined;}
const themeIndex=this.extractAttr(colorElement,"theme")?.asString();let rgb;if(themeIndex!==undefined){if(!theme||!theme.clrScheme){throw new Error("Color referencing a theme but no theme was provided");}
rgb=this.getThemeColor(themeIndex,theme.clrScheme);}
else{rgb=this.extractAttr(colorElement,"rgb")?.asString();}
const color={rgb,auto:this.extractAttr(colorElement,"auto")?.asBool(),indexed:this.extractAttr(colorElement,"indexed")?.asNum(),tint:this.extractAttr(colorElement,"tint")?.asNum(),};return color;}
getTargetXmlFile(relationship){if(!relationship)
throw new Error("Undefined target file");const target=this.processRelationshipTargetName(relationship.target);const f=this.getListOfXMLFiles().find((f)=>f.file.fileName.endsWith(target));if(!f||!f.file)
throw new Error("Cannot find target file");return f;}
getTargetImageFile(relationship){if(!relationship)
throw new Error("Undefined target file");const target=this.processRelationshipTargetName(relationship.target);const f=this.xlsxFileStructure.images.find((f)=>f.fileName.endsWith(target));if(!f)
throw new Error("Cannot find target file");return f;}
querySelector(element,query){const escapedQuery=escapeQueryNameSpaces(query);return element.querySelector(escapedQuery);}
querySelectorAll(element,query){const escapedQuery=escapeQueryNameSpaces(query);return element.querySelectorAll(escapedQuery);}
getThemeColor(colorId,clrScheme){switch(colorId){case"0":return"FFFFFF";case"1":return"000000";case"2":return clrScheme["3"].value;case"3":return clrScheme["2"].value;default:return clrScheme[colorId].value;}}
processRelationshipTargetName(targetName){return targetName.replace(/\.+\//,"");}}
class XlsxMiscExtractor extends XlsxBaseExtractor{getTheme(){const clrScheme=this.mapOnElements({query:"a:clrScheme",parent:this.rootFile.file.xml,children:true},(element)=>{return{name:element.tagName,value:this.extractChildAttr(element,0,"val",{required:true,default:AUTO_COLOR,}).asString(),lastClr:this.extractChildAttr(element,0,"lastClr",{default:AUTO_COLOR,}).asString(),};});return{clrScheme};}
getSharedStrings(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"si"},(ssElement)=>{if(ssElement.children[0].tagName==="t"){return this.extractTextContent(ssElement)||"";}
else{return this.mapOnElements({parent:ssElement,query:"t"},(textElement)=>{return this.extractTextContent(textElement)||"";}).join("");}});}}
class XlsxCfExtractor extends XlsxBaseExtractor{theme;constructor(sheetFile,xlsxStructure,warningManager,theme){super(sheetFile,xlsxStructure,warningManager);this.theme=theme;}
extractConditionalFormattings(){const cfs=this.mapOnElements({parent:this.rootFile.file.xml,query:"worksheet > conditionalFormatting"},(cfElement)=>{return{sqref:this.extractAttr(cfElement,"sqref",{required:true}).asString().split(" "),pivot:this.extractAttr(cfElement,"pivot")?.asBool(),cfRules:this.extractCFRules(cfElement,this.theme),};});cfs.push(...this.mapOnElements({parent:this.rootFile.file.xml,query:"extLst x14:conditionalFormatting"},(cfElement)=>{return{sqref:this.extractChildTextContent(cfElement,"xm:sqref",{required:true}).split(" "),pivot:this.extractAttr(cfElement,"xm:pivot")?.asBool(),cfRules:this.extractCFRules(cfElement,this.theme),};}));return cfs;}
extractCFRules(cfElement,theme){return this.mapOnElements({parent:cfElement,query:"cfRule, x14:cfRule"},(cfRuleElement)=>{const cfType=this.extractAttr(cfRuleElement,"type",{required:true,}).asString();if(cfType==="dataBar"){throw new Error("Databars conditional formats are not supported.");}
return{type:cfType,priority:this.extractAttr(cfRuleElement,"priority",{required:true}).asNum(),colorScale:this.extractCfColorScale(cfRuleElement,theme),formula:this.extractCfFormula(cfRuleElement),iconSet:this.extractCfIconSet(cfRuleElement),dxfId:this.extractAttr(cfRuleElement,"dxfId")?.asNum(),stopIfTrue:this.extractAttr(cfRuleElement,"stopIfTrue")?.asBool(),aboveAverage:this.extractAttr(cfRuleElement,"aboveAverage")?.asBool(),percent:this.extractAttr(cfRuleElement,"percent")?.asBool(),bottom:this.extractAttr(cfRuleElement,"bottom")?.asBool(),operator:this.extractAttr(cfRuleElement,"operator")?.asString(),text:this.extractAttr(cfRuleElement,"text")?.asString(),timePeriod:this.extractAttr(cfRuleElement,"timePeriod")?.asString(),rank:this.extractAttr(cfRuleElement,"rank")?.asNum(),stdDev:this.extractAttr(cfRuleElement,"stdDev")?.asNum(),equalAverage:this.extractAttr(cfRuleElement,"equalAverage")?.asBool(),};});}
extractCfFormula(cfRulesElement){return this.mapOnElements({parent:cfRulesElement,query:"formula"},(cfFormulaElements)=>{return this.extractTextContent(cfFormulaElements,{required:true});});}
extractCfColorScale(cfRulesElement,theme){const colorScaleElement=this.querySelector(cfRulesElement,"colorScale");if(!colorScaleElement)
return undefined;return{colors:this.mapOnElements({parent:colorScaleElement,query:"color"},(colorElement)=>{return this.extractColor(colorElement,theme,"ffffff");}),cfvos:this.extractCFVos(colorScaleElement),};}
extractCfIconSet(cfRulesElement){const iconSetElement=this.querySelector(cfRulesElement,"iconSet, x14:iconSet");if(!iconSetElement)
return undefined;return{iconSet:this.extractAttr(iconSetElement,"iconSet",{default:"3TrafficLights1",}).asString(),showValue:this.extractAttr(iconSetElement,"showValue",{default:true}).asBool(),percent:this.extractAttr(iconSetElement,"percent",{default:true}).asBool(),reverse:this.extractAttr(iconSetElement,"reverse")?.asBool(),custom:this.extractAttr(iconSetElement,"custom")?.asBool(),cfvos:this.extractCFVos(iconSetElement),cfIcons:this.extractCfIcons(iconSetElement),};}
extractCfIcons(iconSetElement){const icons=this.mapOnElements({parent:iconSetElement,query:"cfIcon, x14:cfIcon"},(cfIconElement)=>{return{iconSet:this.extractAttr(cfIconElement,"iconSet",{required:true,}).asString(),iconId:this.extractAttr(cfIconElement,"iconId",{required:true}).asNum(),};});return icons.length===0?undefined:icons;}
extractCFVos(parent){return this.mapOnElements({parent,query:"cfvo, x14:cfvo"},(cfVoElement)=>{return{type:this.extractAttr(cfVoElement,"type",{required:true,}).asString(),gte:this.extractAttr(cfVoElement,"gte",{default:true})?.asBool(),value:cfVoElement.attributes["val"]?this.extractAttr(cfVoElement,"val")?.asString():this.extractChildTextContent(cfVoElement,"f, xm:f"),};});}}
class XlsxChartExtractor extends XlsxBaseExtractor{extractChart(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"c:chartSpace"},(rootChartElement)=>{const chartType=this.getChartType(rootChartElement);if(!CHART_TYPE_CONVERSION_MAP[chartType]){throw new Error(`Unsupported chart type ${chartType}`);}
const chartTitle=this.mapOnElements({parent:rootChartElement,query:"c:title a:t"},(textElement)=>{return textElement.textContent||"";}).join("");const barChartGrouping=this.extractChildAttr(rootChartElement,"c:grouping","val",{default:"clustered",}).asString();return{title:chartTitle,type:CHART_TYPE_CONVERSION_MAP[chartType],dataSets:this.extractChartDatasets(this.querySelector(rootChartElement,`c:${chartType}`)),labelRange:this.extractChildTextContent(rootChartElement,"c:ser c:cat c:f"),backgroundColor:this.extractChildAttr(rootChartElement,"c:chartSpace > c:spPr a:srgbClr","val",{default:"ffffff",}).asString(),verticalAxisPosition:this.extractChildAttr(rootChartElement,"c:valAx > c:axPos","val",{default:"l",}).asString()==="r"?"right":"left",legendPosition:DRAWING_LEGEND_POSITION_CONVERSION_MAP[this.extractChildAttr(rootChartElement,"c:legendPos","val",{default:"b",}).asString()],stacked:barChartGrouping==="stacked",fontColor:"000000",};})[0];}
extractChartDatasets(chartElement){return this.mapOnElements({parent:chartElement,query:"c:ser"},(chartDataElement)=>{return{label:this.extractChildTextContent(chartDataElement,"c:tx c:f"),range:this.extractChildTextContent(chartDataElement,"c:val c:f",{required:true}),};});}
getChartType(chartElement){const plotAreaElement=this.querySelector(chartElement,"c:plotArea");if(!plotAreaElement){throw new Error("Missing plot area in the chart definition.");}
for(let child of plotAreaElement.children){const tag=removeTagEscapedNamespaces(child.tagName);if(XLSX_CHART_TYPES.some((chartType)=>chartType===tag)){return tag;}}
throw new Error("Unknown chart type");}}
class XlsxFigureExtractor extends XlsxBaseExtractor{extractFigures(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"xdr:wsDr",children:true},(figureElement)=>{const anchorType=removeTagEscapedNamespaces(figureElement.tagName);if(anchorType!=="twoCellAnchor"){throw new Error("Only twoCellAnchor are supported for xlsx drawings.");}
const chartElement=this.querySelector(figureElement,"c:chart");const imageElement=this.querySelector(figureElement,"a:blip");if(!chartElement&&!imageElement){throw new Error("Only chart and image figures are currently supported.");}
return{anchors:[this.extractFigureAnchor("xdr:from",figureElement),this.extractFigureAnchor("xdr:to",figureElement),],data:chartElement?this.extractChart(chartElement):this.extractImage(figureElement),};});}
extractFigureAnchor(anchorTag,figureElement){const anchor=this.querySelector(figureElement,anchorTag);if(!anchor){throw new Error(`Missing anchor element ${anchorTag}`);}
return{col:Number(this.extractChildTextContent(anchor,"xdr:col",{required:true})),colOffset:Number(this.extractChildTextContent(anchor,"xdr:colOff",{required:true})),row:Number(this.extractChildTextContent(anchor,"xdr:row",{required:true})),rowOffset:Number(this.extractChildTextContent(anchor,"xdr:rowOff",{required:true})),};}
extractChart(chartElement){const chartId=this.extractAttr(chartElement,"r:id",{required:true}).asString();const chartFile=this.getTargetXmlFile(this.relationships[chartId]);const chartDefinition=new XlsxChartExtractor(chartFile,this.xlsxFileStructure,this.warningManager).extractChart();if(!chartDefinition){throw new Error("Unable to extract chart definition");}
return chartDefinition;}
extractImage(figureElement){const imageElement=this.querySelector(figureElement,"a:blip");const imageId=this.extractAttr(imageElement,"r:embed",{required:true}).asString();const image=this.getTargetImageFile(this.relationships[imageId]);if(!image){throw new Error("Unable to extract image");}
const shapePropertyElement=this.querySelector(figureElement,"a:xfrm");const extension=image.fileName.split(".").at(-1);return{imageSrc:image.imageSrc,mimetype:extension?IMAGE_EXTENSION_TO_MIMETYPE_MAPPING[extension]:undefined,size:{cx:this.extractChildAttr(shapePropertyElement,"a:ext","cx",{required:true}).asNum(),cy:this.extractChildAttr(shapePropertyElement,"a:ext","cy",{required:true}).asNum(),},};}}
class XlsxPivotExtractor extends XlsxBaseExtractor{getPivotTable(){return this.mapOnElements({query:":root",parent:this.rootFile.file.xml},(pivotElement)=>{return{displayName:this.extractAttr(pivotElement,"name",{required:true}).asString(),id:this.extractAttr(pivotElement,"name",{required:true}).asString(),ref:this.extractChildAttr(pivotElement,"location","ref",{required:true,}).asString(),headerRowCount:this.extractChildAttr(pivotElement,"location","firstDataRow",{default:0,}).asNum(),totalsRowCount:1,cols:[],style:{showFirstColumn:true,showRowStripes:true,},};})[0];}}
class XlsxTableExtractor extends XlsxBaseExtractor{getTable(){return this.mapOnElements({query:"table",parent:this.rootFile.file.xml},(tableElement)=>{return{displayName:this.extractAttr(tableElement,"displayName",{required:true,}).asString(),name:this.extractAttr(tableElement,"name")?.asString(),id:this.extractAttr(tableElement,"id",{required:true}).asString(),ref:this.extractAttr(tableElement,"ref",{required:true}).asString(),headerRowCount:this.extractAttr(tableElement,"headerRowCount",{default:1,}).asNum(),totalsRowCount:this.extractAttr(tableElement,"totalsRowCount",{default:0,}).asNum(),cols:this.extractTableCols(tableElement),style:this.extractTableStyleInfo(tableElement),autoFilter:this.extractTableAutoFilter(tableElement),};})[0];}
extractTableCols(tableElement){return this.mapOnElements({query:"tableColumn",parent:tableElement},(tableColElement)=>{return{id:this.extractAttr(tableColElement,"id",{required:true}).asString(),name:this.extractAttr(tableColElement,"name",{required:true}).asString(),colFormula:this.extractChildTextContent(tableColElement,"calculatedColumnFormula"),};});}
extractTableStyleInfo(tableElement){return this.mapOnElements({query:"tableStyleInfo",parent:tableElement},(tableStyleElement)=>{return{name:this.extractAttr(tableStyleElement,"name")?.asString(),showFirstColumn:this.extractAttr(tableStyleElement,"showFirstColumn")?.asBool(),showLastColumn:this.extractAttr(tableStyleElement,"showLastColumn")?.asBool(),showRowStripes:this.extractAttr(tableStyleElement,"showRowStripes")?.asBool(),showColumnStripes:this.extractAttr(tableStyleElement,"showColumnStripes")?.asBool(),};})[0];}
extractTableAutoFilter(tableElement){return this.mapOnElements({query:"autoFilter",parent:tableElement},(autoFilterElement)=>{return{columns:this.extractFilterColumns(autoFilterElement),zone:this.extractAttr(autoFilterElement,"ref",{required:true}).asString(),};})[0];}
extractFilterColumns(autoFilterElement){return this.mapOnElements({query:"tableColumn",parent:autoFilterElement},(filterColumnElement)=>{return{colId:this.extractAttr(autoFilterElement,"colId",{required:true}).asNum(),hiddenButton:this.extractAttr(autoFilterElement,"hiddenButton",{default:false,}).asBool(),filters:this.extractSimpleFilter(filterColumnElement),};});}
extractSimpleFilter(filterColumnElement){return this.mapOnElements({query:"filter",parent:filterColumnElement},(filterColumnElement)=>{return{val:this.extractAttr(filterColumnElement,"val",{required:true}).asString(),};});}}
class XlsxSheetExtractor extends XlsxBaseExtractor{theme;constructor(sheetFile,xlsxStructure,warningManager,theme){super(sheetFile,xlsxStructure,warningManager);this.theme=theme;}
getSheet(){return this.mapOnElements({query:"worksheet",parent:this.rootFile.file.xml},(sheetElement)=>{const sheetWorkbookInfo=this.getSheetWorkbookInfo();return{sheetName:this.extractSheetName(),sheetViews:this.extractSheetViews(sheetElement),sheetFormat:this.extractSheetFormat(sheetElement),cols:this.extractCols(sheetElement),rows:this.extractRows(sheetElement),sharedFormulas:this.extractSharedFormulas(sheetElement),merges:this.extractMerges(sheetElement),cfs:this.extractConditionalFormats(),figures:this.extractFigures(sheetElement),hyperlinks:this.extractHyperLinks(sheetElement),tables:[...this.extractTables(sheetElement),...this.extractPivotTables()],isVisible:sheetWorkbookInfo.state==="visible"?true:false,};})[0];}
extractSheetViews(worksheet){return this.mapOnElements({parent:worksheet,query:"sheetView"},(sheetViewElement)=>{const paneElement=this.querySelector(sheetViewElement,"pane");return{tabSelected:this.extractAttr(sheetViewElement,"tabSelected",{default:false,}).asBool(),showFormulas:this.extractAttr(sheetViewElement,"showFormulas",{default:false,}).asBool(),showGridLines:this.extractAttr(sheetViewElement,"showGridLines",{default:true,}).asBool(),showRowColHeaders:this.extractAttr(sheetViewElement,"showRowColHeaders",{default:true,}).asBool(),pane:{xSplit:paneElement?this.extractAttr(paneElement,"xSplit",{default:0}).asNum():0,ySplit:paneElement?this.extractAttr(paneElement,"ySplit",{default:0}).asNum():0,},};});}
extractSheetName(){const relativePath=getRelativePath(this.xlsxFileStructure.workbook.file.fileName,this.rootFile.file.fileName);const workbookRels=this.extractRelationships(this.xlsxFileStructure.workbook.rels);const relId=workbookRels.find((rel)=>rel.target===relativePath).id;for(let sheetElement of this.querySelectorAll(this.xlsxFileStructure.workbook.file.xml,"sheet")){if(sheetElement.attributes["r:id"].value===relId){return sheetElement.attributes["name"].value;}}
throw new Error("Missing sheet name");}
getSheetWorkbookInfo(){const relativePath=getRelativePath(this.xlsxFileStructure.workbook.file.fileName,this.rootFile.file.fileName);const workbookRels=this.extractRelationships(this.xlsxFileStructure.workbook.rels);const relId=workbookRels.find((rel)=>rel.target===relativePath).id;const workbookSheets=this.mapOnElements({parent:this.xlsxFileStructure.workbook.file.xml,query:"sheet"},(sheetElement)=>{return{relationshipId:this.extractAttr(sheetElement,"r:id",{required:true}).asString(),sheetId:this.extractAttr(sheetElement,"sheetId",{required:true}).asString(),sheetName:this.extractAttr(sheetElement,"name",{required:true}).asString(),state:this.extractAttr(sheetElement,"state",{default:"visible",}).asString(),};});const info=workbookSheets.find((info)=>info.relationshipId===relId);if(!info){throw new Error("Cannot find corresponding workbook sheet");}
return info;}
extractConditionalFormats(){return new XlsxCfExtractor(this.rootFile,this.xlsxFileStructure,this.warningManager,this.theme).extractConditionalFormattings();}
extractFigures(worksheet){const figures=this.mapOnElements({parent:worksheet,query:"drawing"},(drawingElement)=>{const drawingId=this.extractAttr(drawingElement,"r:id",{required:true})?.asString();const drawingFile=this.getTargetXmlFile(this.relationships[drawingId]);const figures=new XlsxFigureExtractor(drawingFile,this.xlsxFileStructure,this.warningManager).extractFigures();return figures;})[0];return figures||[];}
extractTables(worksheet){return this.mapOnElements({query:"tablePart",parent:worksheet},(tablePartElement)=>{const tableId=this.extractAttr(tablePartElement,"r:id",{required:true})?.asString();const tableFile=this.getTargetXmlFile(this.relationships[tableId]);const tableExtractor=new XlsxTableExtractor(tableFile,this.xlsxFileStructure,this.warningManager);return tableExtractor.getTable();});}
extractPivotTables(){try{return Object.values(this.relationships).filter((relationship)=>relationship.type.endsWith("pivotTable")).map((pivotRelationship)=>{const pivotFile=this.getTargetXmlFile(pivotRelationship);const pivot=new XlsxPivotExtractor(pivotFile,this.xlsxFileStructure,this.warningManager).getPivotTable();return pivot;});}
catch(e){this.catchErrorOnElement(e);return[];}}
extractMerges(worksheet){return this.mapOnElements({parent:worksheet,query:"mergeCell"},(mergeElement)=>{return this.extractAttr(mergeElement,"ref",{required:true}).asString();});}
extractSheetFormat(worksheet){const formatElement=this.querySelector(worksheet,"sheetFormatPr");if(!formatElement)
return undefined;return{defaultColWidth:this.extractAttr(formatElement,"defaultColWidth",{default:EXCEL_DEFAULT_COL_WIDTH.toString(),}).asNum(),defaultRowHeight:this.extractAttr(formatElement,"defaultRowHeight",{default:EXCEL_DEFAULT_ROW_HEIGHT.toString(),}).asNum(),};}
extractCols(worksheet){return this.mapOnElements({parent:worksheet,query:"cols col"},(colElement)=>{return{width:this.extractAttr(colElement,"width")?.asNum(),customWidth:this.extractAttr(colElement,"customWidth")?.asBool(),bestFit:this.extractAttr(colElement,"bestFit")?.asBool(),hidden:this.extractAttr(colElement,"hidden")?.asBool(),min:this.extractAttr(colElement,"min",{required:true})?.asNum(),max:this.extractAttr(colElement,"max",{required:true})?.asNum(),styleIndex:this.extractAttr(colElement,"style")?.asNum(),};});}
extractRows(worksheet){return this.mapOnElements({parent:worksheet,query:"sheetData row"},(rowElement)=>{return{index:this.extractAttr(rowElement,"r",{required:true})?.asNum(),cells:this.extractCells(rowElement),height:this.extractAttr(rowElement,"ht")?.asNum(),customHeight:this.extractAttr(rowElement,"customHeight")?.asBool(),hidden:this.extractAttr(rowElement,"hidden")?.asBool(),styleIndex:this.extractAttr(rowElement,"s")?.asNum(),};});}
extractCells(row){return this.mapOnElements({parent:row,query:"c"},(cellElement)=>{return{xc:this.extractAttr(cellElement,"r",{required:true})?.asString(),styleIndex:this.extractAttr(cellElement,"s")?.asNum(),type:CELL_TYPE_CONVERSION_MAP[this.extractAttr(cellElement,"t",{default:"n"})?.asString()],value:this.extractChildTextContent(cellElement,"v"),formula:this.extractCellFormula(cellElement),};});}
extractCellFormula(cellElement){const formulaElement=this.querySelector(cellElement,"f");if(!formulaElement)
return undefined;return{content:this.extractTextContent(formulaElement),sharedIndex:this.extractAttr(formulaElement,"si")?.asNum(),ref:this.extractAttr(formulaElement,"ref")?.asString(),};}
extractHyperLinks(worksheet){return this.mapOnElements({parent:worksheet,query:"hyperlink"},(linkElement)=>{const relId=this.extractAttr(linkElement,"r:id")?.asString();return{xc:this.extractAttr(linkElement,"ref",{required:true})?.asString(),location:this.extractAttr(linkElement,"location")?.asString(),display:this.extractAttr(linkElement,"display")?.asString(),relTarget:relId?this.relationships[relId].target:undefined,};});}
extractSharedFormulas(worksheet){const sfElements=this.querySelectorAll(worksheet,`f[si][ref]`);const sfMap={};for(let sfElement of sfElements){const index=this.extractAttr(sfElement,"si",{required:true}).asNum();const formula=this.extractTextContent(sfElement,{required:true});sfMap[index]=formula;}
const sfs=[];for(let i=0;i<Object.keys(sfMap).length;i++){if(!sfMap[i]){this.warningManager.addParsingWarning(`Missing shared formula ${i}, replacing it by empty formula`);sfs.push("");}
else{sfs.push(sfMap[i]);}}
return sfs;}}
class XlsxStyleExtractor extends XlsxBaseExtractor{theme;constructor(xlsxStructure,warningManager,theme){super(xlsxStructure.styles,xlsxStructure,warningManager);this.theme=theme;}
getNumFormats(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"numFmt"},(numFmtElement)=>{return this.extractNumFormats(numFmtElement);});}
extractNumFormats(numFmtElement){return{id:this.extractAttr(numFmtElement,"numFmtId",{required:true,}).asNum(),format:this.extractAttr(numFmtElement,"formatCode",{required:true,default:"",}).asString(),};}
getFonts(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"font"},(font)=>{return this.extractFont(font);});}
extractFont(fontElement){const name=this.extractChildAttr(fontElement,"name","val",{default:"Arial",}).asString();const size=this.extractChildAttr(fontElement,"sz","val",{default:DEFAULT_FONT_SIZE.toString(),}).asNum();const color=this.extractColor(this.querySelector(fontElement,`color`),this.theme);const italicElement=this.querySelector(fontElement,`i`)||undefined;const italic=italicElement&&italicElement.attributes["val"]?.value!=="0";const boldElement=this.querySelector(fontElement,`b`)||undefined;const bold=boldElement&&boldElement.attributes["val"]?.value!=="0";const strikeElement=this.querySelector(fontElement,`strike`)||undefined;const strike=strikeElement&&strikeElement.attributes["val"]?.value!=="0";const underlineElement=this.querySelector(fontElement,`u`)||undefined;const underline=underlineElement&&underlineElement.attributes["val"]?.value!=="none";return{name,size,color,italic,bold,underline,strike};}
getFills(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"fill"},(fillElement)=>{return this.extractFill(fillElement);});}
extractFill(fillElement){const fillChild=fillElement.children[0];if(fillChild.tagName==="patternFill"){return{patternType:fillChild.attributes["patternType"]?.value,bgColor:this.extractColor(this.querySelector(fillChild,"bgColor"),this.theme),fgColor:this.extractColor(this.querySelector(fillChild,"fgColor"),this.theme),};}
else{return{patternType:"solid",fgColor:this.extractColor(this.querySelectorAll(fillChild,"color")[1],this.theme),};}}
getBorders(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"border"},(borderElement)=>{return this.extractBorder(borderElement);});}
extractBorder(borderElement){const border={left:this.extractSingleBorder(borderElement,"left",this.theme),right:this.extractSingleBorder(borderElement,"right",this.theme),top:this.extractSingleBorder(borderElement,"top",this.theme),bottom:this.extractSingleBorder(borderElement,"bottom",this.theme),diagonal:this.extractSingleBorder(borderElement,"diagonal",this.theme),};if(border.diagonal){border.diagonalUp=this.extractAttr(borderElement,"diagonalUp")?.asBool();border.diagonalDown=this.extractAttr(borderElement,"diagonalDown")?.asBool();}
return border;}
extractSingleBorder(borderElement,direction,theme){const directionElement=this.querySelector(borderElement,direction);if(!directionElement||!directionElement.attributes["style"])
return undefined;return{style:this.extractAttr(directionElement,"style",{required:true,default:"thin",}).asString(),color:this.extractColor(directionElement.children[0],theme,"000000"),};}
extractAlignment(alignmentElement){return{horizontal:this.extractAttr(alignmentElement,"horizontal",{default:"general",}).asString(),vertical:this.extractAttr(alignmentElement,"vertical",{default:"bottom",}).asString(),textRotation:this.extractAttr(alignmentElement,"textRotation")?.asNum(),wrapText:this.extractAttr(alignmentElement,"wrapText")?.asBool(),indent:this.extractAttr(alignmentElement,"indent")?.asNum(),relativeIndent:this.extractAttr(alignmentElement,"relativeIndent")?.asNum(),justifyLastLine:this.extractAttr(alignmentElement,"justifyLastLine")?.asBool(),shrinkToFit:this.extractAttr(alignmentElement,"shrinkToFit")?.asBool(),readingOrder:this.extractAttr(alignmentElement,"readingOrder")?.asNum(),};}
getDxfs(){return this.mapOnElements({query:"dxf",parent:this.rootFile.file.xml},(dxfElement)=>{const fontElement=this.querySelector(dxfElement,"font");const fillElement=this.querySelector(dxfElement,"fill");const borderElement=this.querySelector(dxfElement,"border");const numFmtElement=this.querySelector(dxfElement,"numFmt");const alignmentElement=this.querySelector(dxfElement,"alignment");return{font:fontElement?this.extractFont(fontElement):undefined,fill:fillElement?this.extractFill(fillElement):undefined,numFmt:numFmtElement?this.extractNumFormats(numFmtElement):undefined,alignment:alignmentElement?this.extractAlignment(alignmentElement):undefined,border:borderElement?this.extractBorder(borderElement):undefined,};});}
getStyles(){return this.mapOnElements({query:"cellXfs xf",parent:this.rootFile.file.xml},(styleElement)=>{const alignmentElement=this.querySelector(styleElement,"alignment");return{fontId:this.extractAttr(styleElement,"fontId",{required:true,default:0,}).asNum(),fillId:this.extractAttr(styleElement,"fillId",{required:true,default:0,}).asNum(),borderId:this.extractAttr(styleElement,"borderId",{required:true,default:0,}).asNum(),numFmtId:this.extractAttr(styleElement,"numFmtId",{required:true,default:0,}).asNum(),alignment:alignmentElement?this.extractAlignment(alignmentElement):undefined,};});}}
class XlsxExternalBookExtractor extends XlsxBaseExtractor{getExternalBook(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"externalBook"},(bookElement)=>{return{rId:this.extractAttr(bookElement,"r:id",{required:true}).asString(),sheetNames:this.mapOnElements({parent:bookElement,query:"sheetName"},(sheetNameElement)=>{return this.extractAttr(sheetNameElement,"val",{required:true}).asString();}),datasets:this.extractExternalSheetData(bookElement),};})[0];}
extractExternalSheetData(externalBookElement){return this.mapOnElements({parent:externalBookElement,query:"sheetData"},(sheetDataElement)=>{const cellsData=this.mapOnElements({parent:sheetDataElement,query:"cell"},(cellElement)=>{return{xc:this.extractAttr(cellElement,"r",{required:true}).asString(),value:this.extractChildTextContent(cellElement,"v",{required:true}),};});const dataMap={};for(let cell of cellsData){dataMap[cell.xc]=cell.value;}
return{sheetId:this.extractAttr(sheetDataElement,"sheetId",{required:true}).asNum(),data:dataMap,};});}}
function getXLSXFilesOfType(contentType,xmls){const paths=getPathsOfContent(contentType,xmls);return getXlsxFile(paths,xmls);}
function getXlsxFile(files,xmls){const ret=[];for(let file of files){const rels=getRelationFile(file,xmls);ret.push({file:{fileName:file,xml:xmls[file]},rels:rels?{fileName:rels,xml:xmls[rels]}:undefined,});}
return ret;}
function getPathsOfContent(contentType,xmls){const xml=xmls[CONTENT_TYPES_FILE];const sheetItems=xml.querySelectorAll(`Override[ContentType="${contentType}"]`);const paths=[];for(let item of sheetItems){const file=item?.attributes["PartName"].value;paths.push(file.substring(1));}
return paths;}
function getRelationFile(file,xmls){if(file===CONTENT_TYPES_FILE){return"_rels/.rels";}
let relsFile="";const pathParts=file.split("/");for(let i=0;i<pathParts.length-1;i++){relsFile+=pathParts[i]+"/";}
relsFile+="_rels/";relsFile+=pathParts[pathParts.length-1]+".rels";if(!xmls[relsFile]){relsFile=undefined;}
return relsFile;}
const EXCEL_IMPORT_VERSION=12;class XlsxReader{warningManager;xmls;images;constructor(files){this.warningManager=new XLSXImportWarningManager();this.xmls={};this.images=[];for(let key of Object.keys(files)){if(key.endsWith(".xml")||key.endsWith(".rels")){const contentString=escapeTagNamespaces(files[key]);this.xmls[key]=parseXML(new XMLString(contentString));}
else if(key.includes("media/image")){this.images.push({fileName:key,imageSrc:files[key]["imageSrc"],});}}}
convertXlsx(){const xlsxData=this.getXlsxData();const convertedData=this.convertImportedData(xlsxData);return convertedData;}
getXlsxData(){const xlsxFileStructure=this.buildXlsxFileStructure();const theme=xlsxFileStructure.theme?new XlsxMiscExtractor(xlsxFileStructure.theme,xlsxFileStructure,this.warningManager).getTheme():undefined;const sharedStrings=xlsxFileStructure.sharedStrings?new XlsxMiscExtractor(xlsxFileStructure.sharedStrings,xlsxFileStructure,this.warningManager).getSharedStrings():[];const sheets=xlsxFileStructure.sheets.sort((a,b)=>a.file.fileName.localeCompare(b.file.fileName,undefined,{numeric:true})).map((sheetFile)=>{return new XlsxSheetExtractor(sheetFile,xlsxFileStructure,this.warningManager,theme).getSheet();});const externalBooks=xlsxFileStructure.externalLinks.map((externalLinkFile)=>{return new XlsxExternalBookExtractor(externalLinkFile,xlsxFileStructure,this.warningManager).getExternalBook();});const styleExtractor=new XlsxStyleExtractor(xlsxFileStructure,this.warningManager,theme);return{fonts:styleExtractor.getFonts(),fills:styleExtractor.getFills(),borders:styleExtractor.getBorders(),dxfs:styleExtractor.getDxfs(),numFmts:styleExtractor.getNumFormats(),styles:styleExtractor.getStyles(),sheets:sheets,sharedStrings,externalBooks,};}
buildXlsxFileStructure(){const xlsxFileStructure={sheets:getXLSXFilesOfType(CONTENT_TYPES.sheet,this.xmls),workbook:getXLSXFilesOfType(CONTENT_TYPES.workbook,this.xmls)[0],styles:getXLSXFilesOfType(CONTENT_TYPES.styles,this.xmls)[0],sharedStrings:getXLSXFilesOfType(CONTENT_TYPES.sharedStrings,this.xmls)[0],theme:getXLSXFilesOfType(CONTENT_TYPES.themes,this.xmls)[0],charts:getXLSXFilesOfType(CONTENT_TYPES.chart,this.xmls),figures:getXLSXFilesOfType(CONTENT_TYPES.drawing,this.xmls),tables:getXLSXFilesOfType(CONTENT_TYPES.table,this.xmls),pivots:getXLSXFilesOfType(CONTENT_TYPES.pivot,this.xmls),externalLinks:getXLSXFilesOfType(CONTENT_TYPES.externalLink,this.xmls),images:this.images,};if(!xlsxFileStructure.workbook.rels){throw Error(_t("Cannot find workbook relations file"));}
return xlsxFileStructure;}
convertImportedData(data){const convertedData={version:EXCEL_IMPORT_VERSION,sheets:convertSheets(data,this.warningManager),styles:convertStyles(data,this.warningManager),formats:convertFormats(data,this.warningManager),borders:convertBorders(data,this.warningManager),entities:{},revisionId:DEFAULT_REVISION_ID,};convertTables(convertedData,data);Object.keys(data.styles).map((key)=>{data.styles[key]=removeFalsyAttributes(data.styles[key]);});return convertedData;}}
var State;(function(State){State[State["LeftRef"]=0]="LeftRef";State[State["RightRef"]=1]="RightRef";State[State["Separator"]=2]="Separator";State[State["FullColumnSeparator"]=3]="FullColumnSeparator";State[State["FullRowSeparator"]=4]="FullRowSeparator";State[State["RightColumnRef"]=5]="RightColumnRef";State[State["RightRowRef"]=6]="RightRowRef";State[State["Found"]=7]="Found";})(State||(State={}));const goTo=(state,guard=()=>true)=>[{goTo:state,guard,},];const goToMulti=(state,guard=()=>true)=>({goTo:state,guard,});const machine={[State.LeftRef]:{REFERENCE:goTo(State.Separator),NUMBER:goTo(State.FullRowSeparator),SYMBOL:[goToMulti(State.FullColumnSeparator,(token)=>isColReference(token.value)),goToMulti(State.FullRowSeparator,(token)=>isRowReference(token.value)),],},[State.FullColumnSeparator]:{SPACE:goTo(State.FullColumnSeparator),OPERATOR:goTo(State.RightColumnRef,(token)=>token.value===":"),},[State.FullRowSeparator]:{SPACE:goTo(State.FullRowSeparator),OPERATOR:goTo(State.RightRowRef,(token)=>token.value===":"),},[State.Separator]:{SPACE:goTo(State.Separator),OPERATOR:goTo(State.RightRef,(token)=>token.value===":"),},[State.RightRef]:{SPACE:goTo(State.RightRef),NUMBER:goTo(State.Found),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),SYMBOL:goTo(State.Found,(token)=>isColHeader(token.value)||isRowHeader(token.value)),},[State.RightColumnRef]:{SPACE:goTo(State.RightColumnRef),SYMBOL:goTo(State.Found,(token)=>isColHeader(token.value)),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),},[State.RightRowRef]:{SPACE:goTo(State.RightRowRef),NUMBER:goTo(State.Found),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),SYMBOL:goTo(State.Found,(token)=>isRowHeader(token.value)),},[State.Found]:{},};function matchReference(tokens){let head=0;let transitions=machine[State.LeftRef];const matchedTokens=[];while(transitions!==undefined){const token=tokens[head++];if(!token){return null;}
const transition=transitions[token.type]?.find((transition)=>transition.guard(token));const nextState=transition?transition.goTo:undefined;switch(nextState){case undefined:return null;case State.Found:matchedTokens.push(token);tokens.splice(0,head);return{type:"REFERENCE",value:concat(matchedTokens.map((token)=>token.value)),};default:transitions=machine[nextState];matchedTokens.push(token);break;}}
return null;}
function rangeTokenize(formula,locale=DEFAULT_LOCALE){const tokens=tokenize(formula,locale);const result=[];while(tokens.length){result.push(matchReference(tokens)||tokens.shift());}
return result;}
function normalizeV9(formula){const tokens=rangeTokenize(formula);let dependencies=[];let noRefFormula="".concat(...tokens.map((token)=>{if(token.type==="REFERENCE"&&cellReference.test(token.value)){const value=token.value.trim();if(!dependencies.includes(value)){dependencies.push(value);}
return`${FORMULA_REF_IDENTIFIER}${dependencies.indexOf(value)}${FORMULA_REF_IDENTIFIER}`;}
else{return token.value;}}));return{text:noRefFormula,dependencies};}
const CURRENT_VERSION=14;const INITIAL_SHEET_ID="Sheet1";function load(data,verboseImport){if(!data){return createEmptyWorkbookData();}
if(data["[Content_Types].xml"]){const reader=new XlsxReader(data);data=reader.convertXlsx();if(verboseImport){for(let parsingError of reader.warningManager.warnings.sort()){console.warn(parsingError);}}}
if("version"in data){if(data.version<CURRENT_VERSION){data=migrate(data);}}
data=repairData(data);return data;}
function migrate(data){const index=MIGRATIONS.findIndex((m)=>m.from===data.version);for(let i=index;i<MIGRATIONS.length;i++){data=MIGRATIONS[i].applyMigration(data);}
return data;}
const MIGRATIONS=[{description:"add the `activeSheet` field on data",from:1,to:2,applyMigration(data){if(data.sheets&&data.sheets[0]){data.activeSheet=data.sheets[0].name;}
return data;},},{description:"add an id field in each sheet",from:2,to:3,applyMigration(data){if(data.sheets&&data.sheets.length){for(let sheet of data.sheets){sheet.id=sheet.id||sheet.name;}}
return data;},},{description:"activeSheet is now an id, not the name of a sheet",from:3,to:4,applyMigration(data){if(data.sheets&&data.activeSheet){const activeSheet=data.sheets.find((s)=>s.name===data.activeSheet);data.activeSheet=activeSheet.id;}
return data;},},{description:"add figures object in each sheets",from:4,to:5,applyMigration(data){for(let sheet of data.sheets||[]){sheet.figures=sheet.figures||[];}
return data;},},{description:"normalize the content of the cell if it is a formula to avoid parsing all the formula that vary only by the cells they use",from:5,to:6,applyMigration(data){for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){cell.formula=normalizeV9(cell.content);}}}
return data;},},{description:"transform chart data structure",from:6,to:7,applyMigration(data){for(let sheet of data.sheets||[]){for(let f in sheet.figures||[]){const{dataSets,...newData}=sheet.figures[f].data;const newDataSets=[];for(let ds of dataSets){if(ds.labelCell){const dataRange=toZone(ds.dataRange);const newRange=ds.labelCell+":"+toXC(dataRange.right,dataRange.bottom);newDataSets.push(newRange);}
else{newDataSets.push(ds.dataRange);}}
newData.dataSetsHaveTitle=Boolean(dataSets[0].labelCell);newData.dataSets=newDataSets;sheet.figures[f].data=newData;}}
return data;},},{description:"remove single quotes in sheet names",from:7,to:8,applyMigration(data){const namesTaken=[];const globalForbiddenInExcel=new RegExp(FORBIDDEN_IN_EXCEL_REGEX,"g");for(let sheet of data.sheets||[]){if(!sheet.name){continue;}
const oldName=sheet.name;const escapedName=oldName.replace(globalForbiddenInExcel,"_");let i=1;let newName=escapedName;while(namesTaken.includes(newName)){newName=`${escapedName}${i}`;i++;}
sheet.name=newName;namesTaken.push(newName);const replaceName=(str)=>{if(str===undefined){return str;}
let newString=str.replace(oldName,newName);let currentString=str;while(currentString!==newString){currentString=newString;newString=currentString.replace(oldName,newName);}
return currentString;};for(let xc in sheet.cells){const cell=sheet.cells[xc];if(cell.formula){cell.formula.dependencies=cell.formula.dependencies.map(replaceName);}}
for(let figure of sheet.figures||[]){if(figure.type==="chart"){const dataSets=figure.data.dataSets.map(replaceName);const labelRange=replaceName(figure.data.labelRange);figure.data={...figure.data,dataSets,labelRange};}}
for(let cf of sheet.conditionalFormats||[]){cf.ranges=cf.ranges.map(replaceName);for(const thresholdName of["minimum","maximum","midpoint","upperInflectionPoint","lowerInflectionPoint",]){if(cf.rule[thresholdName]?.type==="formula"){cf.rule[thresholdName].value=replaceName(cf.rule[thresholdName].value);}}}}
return data;},},{description:"transform chart data structure with design attributes",from:8,to:9,applyMigration(data){for(const sheet of data.sheets||[]){for(const chart of sheet.figures||[]){chart.data.background=BACKGROUND_CHART_COLOR;chart.data.verticalAxisPosition="left";chart.data.legendPosition="top";chart.data.stacked=false;}}
return data;},},{description:"de-normalize formula to reduce exported json size (~30%)",from:9,to:10,applyMigration(data){for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.formula){let{text,dependencies}=cell.formula;for(let[index,d]of Object.entries(dependencies)){const stringPosition=`\\${FORMULA_REF_IDENTIFIER}${index}\\${FORMULA_REF_IDENTIFIER}`;text=text.replace(new RegExp(stringPosition,"g"),d);}
cell.content=text;delete cell.formula;}}}
return data;},},{description:"normalize the formats of the cells",from:10,to:11,applyMigration(data){const formats={};for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.format){cell.format=getItemId(cell.format,formats);}}}
data.formats=formats;return data;},},{description:"Add isVisible to sheets",from:11,to:12,applyMigration(data){for(let sheet of data.sheets||[]){sheet.isVisible=true;}
return data;},},{description:"Fix datafilter duplication",from:12,to:12.5,applyMigration(data){return fixOverlappingFilters(data);},},{description:"Change Border description structure",from:12.5,to:13,applyMigration(data){for(const borderId in data.borders){const border=data.borders[borderId];for(const position in border){if(Array.isArray(border[position])){border[position]={style:border[position][0],color:border[position][1],};}}}
return data;},},{description:"Add locale to spreadsheet settings",from:13,to:14,applyMigration(data){if(!data.settings){data.settings={};}
if(!data.settings.locale){data.settings.locale=DEFAULT_LOCALE;}
return data;},},{description:"Fix datafilter duplication (post saas-16.4)",from:14,to:14.5,applyMigration(data){return fixOverlappingFilters(data);},},];function repairData(data){data=forceUnicityOfFigure(data);data=setDefaults(data);return data;}
function forceUnicityOfFigure(data){if(data.uniqueFigureIds){return data;}
const figureIds=new Set();const uuidGenerator=new UuidGenerator();for(const sheet of data.sheets||[]){for(const figure of sheet.figures||[]){if(figureIds.has(figure.id)){figure.id+=uuidGenerator.uuidv4();}
figureIds.add(figure.id);}}
data.uniqueFigureIds=true;return data;}
function setDefaults(partialData){const data=Object.assign(createEmptyWorkbookData(),partialData,{version:CURRENT_VERSION,});data.sheets=data.sheets?data.sheets.map((s,i)=>Object.assign(createEmptySheet(`Sheet${i + 1}`,`Sheet${i + 1}`),s)):[];if(data.sheets.length===0){data.sheets.push(createEmptySheet(INITIAL_SHEET_ID,"Sheet1"));}
if(!isValidLocale(data.settings.locale)){data.settings.locale=DEFAULT_LOCALE;}
return data;}
function repairInitialMessages(data,initialMessages){initialMessages=fixTranslatedSheetIds(data,initialMessages);initialMessages=dropCommands(initialMessages,"SORT_CELLS");initialMessages=dropCommands(initialMessages,"SET_DECIMAL");initialMessages=fixChartDefinitions(data,initialMessages);return initialMessages;}
function fixTranslatedSheetIds(data,initialMessages){if(Object.keys(data).length!==0){return initialMessages;}
const sheetIds=[];const messages=[];const fixSheetId=(cmd)=>{if(cmd.type==="CREATE_SHEET"){sheetIds.push(cmd.sheetId);}
else if("sheetId"in cmd&&!sheetIds.includes(cmd.sheetId)){return{...cmd,sheetId:INITIAL_SHEET_ID};}
return cmd;};for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){messages.push({...message,commands:message.commands.map(fixSheetId),});}
else{messages.push(message);}}
return messages;}
function dropCommands(initialMessages,commandType){const messages=[];for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){messages.push({...message,commands:message.commands.filter((command)=>command.type!==commandType),});}
else{messages.push(message);}}
return messages;}
function fixChartDefinitions(data,initialMessages){const messages=[];const map={};for(const sheet of data.sheets||[]){sheet.figures?.forEach((figure)=>{if(figure.tag==="chart"){map[figure.id]=figure.data;}});}
for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){const commands=[];for(const cmd of message.commands){let command=cmd;switch(cmd.type){case"CREATE_CHART":map[cmd.id]=cmd.definition;break;case"UPDATE_CHART":if(!map[cmd.id]){console.log(`Fix chart definition: chart with id ${cmd.id} not found.`);continue;}
const definition=map[cmd.id];const newDefinition={...definition,...cmd.definition};command={...cmd,definition:newDefinition};map[cmd.id]=newDefinition;break;}
commands.push(command);}
messages.push({...message,commands,});}
else{messages.push(message);}}
return messages;}
function fixOverlappingFilters(data){for(let sheet of data.sheets||[]){let knownDataFilterZones=[];for(let filterTable of sheet.filterTables||[]){const zone=toZone(filterTable.range);const intersectZoneIndex=knownDataFilterZones.findIndex((knownZone)=>overlap(knownZone,zone));if(intersectZoneIndex!==-1){knownDataFilterZones[intersectZoneIndex]=zone;}
else{knownDataFilterZones.push(zone);}}
sheet.filterTables=knownDataFilterZones.map((zone)=>({range:zoneToXc(zone),}));}
return data;}
function createEmptySheet(sheetId,name){return{id:sheetId,name,colNumber:26,rowNumber:100,cells:{},cols:{},rows:{},merges:[],conditionalFormats:[],figures:[],filterTables:[],isVisible:true,};}
function createEmptyWorkbookData(sheetName="Sheet1"){const data={version:CURRENT_VERSION,sheets:[createEmptySheet(INITIAL_SHEET_ID,sheetName)],entities:{},styles:{},formats:{},borders:{},revisionId:DEFAULT_REVISION_ID,uniqueFigureIds:true,settings:{locale:DEFAULT_LOCALE},};return data;}
function createEmptyExcelSheet(sheetId,name){return{...createEmptySheet(sheetId,name),charts:[],images:[],};}
function createEmptyExcelWorkbookData(){return{...createEmptyWorkbookData(),sheets:[createEmptyExcelSheet(INITIAL_SHEET_ID,"Sheet1")],};}
class BasePlugin{static getters=[];history;dispatch;constructor(stateObserver,dispatch){this.history=Object.assign(Object.create(stateObserver),{update:stateObserver.addChange.bind(stateObserver,this),selectCell:()=>{},});this.dispatch=dispatch;}
exportForExcel(data){}
allowDispatch(command){return"Success";}
beforeHandle(command){}
handle(command){}
finalize(){}
batchValidations(...validations){return(toValidate)=>validations.map((validation)=>validation.call(this,toValidate)).flat();}
chainValidations(...validations){return(toValidate)=>{for(const validation of validations){let results=validation.call(this,toValidate);if(!Array.isArray(results)){results=[results];}
const cancelledReasons=results.filter((result)=>result!=="Success");if(cancelledReasons.length){return cancelledReasons;}}
return"Success";};}
checkValidations(command,...validations){return this.batchValidations(...validations)(command);}}
class CorePlugin extends BasePlugin{getters;uuidGenerator;constructor({getters,stateObserver,range,dispatch,uuidGenerator}){super(stateObserver,dispatch);range.addRangeProvider(this.adaptRanges.bind(this));this.getters=getters;this.uuidGenerator=uuidGenerator;}
import(data){}
export(data){}
adaptRanges(applyChange,sheetId){}
garbageCollectExternalResources(){}}
class BordersPlugin extends CorePlugin{static getters=["getCellBorder","getBordersColors"];borders={};allowDispatch(cmd){switch(cmd.type){case"SET_BORDER":return this.checkBordersUnchanged(cmd);default:return"Success";}}
handle(cmd){switch(cmd.type){case"ADD_MERGE":for(const zone of cmd.target){this.addBordersToMerge(cmd.sheetId,zone);}
break;case"DUPLICATE_SHEET":const borders=this.borders[cmd.sheetId];if(borders){const bordersCopy=borders.slice().map((col)=>col?.slice().map((border)=>({...border})));this.history.update("borders",cmd.sheetIdTo,bordersCopy);}
break;case"DELETE_SHEET":const allBorders={...this.borders};delete allBorders[cmd.sheetId];this.history.update("borders",allBorders);break;case"SET_BORDER":this.setBorder(cmd.sheetId,cmd.col,cmd.row,cmd.border);break;case"SET_ZONE_BORDERS":if(cmd.border){const target=cmd.target.map((zone)=>this.getters.expandZone(cmd.sheetId,zone));this.setBorders(cmd.sheetId,target,cmd.border.position,cmd.border.color===""?undefined:{style:cmd.border.style||DEFAULT_BORDER_DESC.style,color:cmd.border.color||DEFAULT_BORDER_DESC.color,});}
break;case"CLEAR_FORMATTING":this.clearBorders(cmd.sheetId,cmd.target);break;case"REMOVE_COLUMNS_ROWS":for(let el of cmd.elements){if(cmd.dimension==="COL"){this.shiftBordersHorizontally(cmd.sheetId,el+1,-1);}
else{this.shiftBordersVertically(cmd.sheetId,el+1,-1);}}
break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.handleAddColumns(cmd);}
else{this.handleAddRows(cmd);}
break;}}
handleAddColumns(cmd){let colLeftOfInsertion;let colRightOfInsertion;if(cmd.position==="before"){this.shiftBordersHorizontally(cmd.sheetId,cmd.base,cmd.quantity,{moveFirstLeftBorder:true,});colLeftOfInsertion=cmd.base-1;colRightOfInsertion=cmd.base+cmd.quantity;}
else{this.shiftBordersHorizontally(cmd.sheetId,cmd.base+1,cmd.quantity,{moveFirstLeftBorder:false,});colLeftOfInsertion=cmd.base;colRightOfInsertion=cmd.base+cmd.quantity+1;}
this.ensureColumnBorderContinuity(cmd.sheetId,colLeftOfInsertion,colRightOfInsertion);}
handleAddRows(cmd){let rowAboveInsertion;let rowBelowInsertion;if(cmd.position==="before"){this.shiftBordersVertically(cmd.sheetId,cmd.base,cmd.quantity,{moveFirstTopBorder:true,});rowAboveInsertion=cmd.base-1;rowBelowInsertion=cmd.base+cmd.quantity;}
else{this.shiftBordersVertically(cmd.sheetId,cmd.base+1,cmd.quantity,{moveFirstTopBorder:false,});rowAboveInsertion=cmd.base;rowBelowInsertion=cmd.base+cmd.quantity+1;}
this.ensureRowBorderContinuity(cmd.sheetId,rowAboveInsertion,rowBelowInsertion);}
getCellBorder({sheetId,col,row}){const border={top:this.borders[sheetId]?.[col]?.[row]?.horizontal,bottom:this.borders[sheetId]?.[col]?.[row+1]?.horizontal,left:this.borders[sheetId]?.[col]?.[row]?.vertical,right:this.borders[sheetId]?.[col+1]?.[row]?.vertical,};if(!border.bottom&&!border.left&&!border.right&&!border.top){return null;}
return border;}
getBordersColors(sheetId){const colors=[];const sheetBorders=this.borders[sheetId];if(sheetBorders){for(const borders of sheetBorders.filter(isDefined$1)){for(const cellBorder of borders){if(cellBorder?.horizontal){colors.push(cellBorder.horizontal.color);}
if(cellBorder?.vertical){colors.push(cellBorder.vertical.color);}}}}
return colors;}
ensureColumnBorderContinuity(sheetId,leftColumn,rightColumn){const targetCols=range(leftColumn+1,rightColumn);for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const leftBorder=this.getCellBorder({sheetId,col:leftColumn,row});const rightBorder=this.getCellBorder({sheetId,col:rightColumn,row});if(leftBorder&&rightBorder){const commonSides=this.getCommonSides(leftBorder,rightBorder);for(let col of targetCols){this.addBorder(sheetId,col,row,commonSides);}}}}
ensureRowBorderContinuity(sheetId,topRow,bottomRow){const targetRows=range(topRow+1,bottomRow);for(let col=0;col<this.getters.getNumberCols(sheetId);col++){const aboveBorder=this.getCellBorder({sheetId,col,row:topRow});const belowBorder=this.getCellBorder({sheetId,col,row:bottomRow});if(aboveBorder&&belowBorder){const commonSides=this.getCommonSides(aboveBorder,belowBorder);for(let row of targetRows){this.addBorder(sheetId,col,row,commonSides);}}}}
getCommonSides(border1,border2){const commonBorder={};for(let side of["top","bottom","left","right"]){if(border1[side]&&border1[side]===border2[side]){commonBorder[side]=border1[side];}}
return commonBorder;}
getColumnsWithBorders(sheetId){const sheetBorders=this.borders[sheetId];if(!sheetBorders)
return[];return Object.keys(sheetBorders).map((index)=>parseInt(index,10));}
getRowsRange(sheetId){const sheetBorders=this.borders[sheetId];if(!sheetBorders)
return[];return range(0,this.getters.getNumberRows(sheetId)+1);}
shiftBordersHorizontally(sheetId,start,delta,{moveFirstLeftBorder}={}){const borders=this.borders[sheetId];if(!borders)
return;if(delta<0){this.moveBordersOfColumn(sheetId,start,delta,"vertical",{destructive:false,});}
this.getColumnsWithBorders(sheetId).filter((col)=>col>=start).sort((a,b)=>(delta<0?a-b:b-a)).forEach((col)=>{if((col===start&&moveFirstLeftBorder)||col!==start){this.moveBordersOfColumn(sheetId,col,delta,"vertical");}
this.moveBordersOfColumn(sheetId,col,delta,"horizontal");});}
shiftBordersVertically(sheetId,start,delta,{moveFirstTopBorder}={}){const borders=this.borders[sheetId];if(!borders)
return;if(delta<0){this.moveBordersOfRow(sheetId,start,delta,"horizontal",{destructive:false,});}
this.getRowsRange(sheetId).filter((row)=>row>=start).sort((a,b)=>(delta<0?a-b:b-a)).forEach((row)=>{if((row===start&&moveFirstTopBorder)||row!==start){this.moveBordersOfRow(sheetId,row,delta,"horizontal");}
this.moveBordersOfRow(sheetId,row,delta,"vertical");});}
moveBordersOfRow(sheetId,row,delta,borderDirection,{destructive}={destructive:true}){const borders=this.borders[sheetId];if(!borders)
return;this.getColumnsWithBorders(sheetId).forEach((col)=>{const targetBorder=borders[col]?.[row+delta]?.[borderDirection];const movedBorder=borders[col]?.[row]?.[borderDirection];this.history.update("borders",sheetId,col,row+delta,borderDirection,destructive?movedBorder:movedBorder||targetBorder);this.history.update("borders",sheetId,col,row,borderDirection,undefined);});}
moveBordersOfColumn(sheetId,col,delta,borderDirection,{destructive}={destructive:true}){const borders=this.borders[sheetId];if(!borders)
return;this.getRowsRange(sheetId).forEach((row)=>{const targetBorder=borders[col+delta]?.[row]?.[borderDirection];const movedBorder=borders[col]?.[row]?.[borderDirection];this.history.update("borders",sheetId,col+delta,row,borderDirection,destructive?movedBorder:movedBorder||targetBorder);this.history.update("borders",sheetId,col,row,borderDirection,undefined);});}
setBorder(sheetId,col,row,border,override=true){if(override||!this.borders?.[sheetId]?.[col]?.[row]?.vertical){this.history.update("borders",sheetId,col,row,"vertical",border?.left);}
if(override||!this.borders?.[sheetId]?.[col]?.[row]?.horizontal){this.history.update("borders",sheetId,col,row,"horizontal",border?.top);}
if(override||!this.borders?.[sheetId]?.[col+1]?.[row]?.vertical){this.history.update("borders",sheetId,col+1,row,"vertical",border?.right);}
if(override||!this.borders?.[sheetId]?.[col]?.[row+1]?.horizontal){this.history.update("borders",sheetId,col,row+1,"horizontal",border?.bottom);}}
clearBorders(sheetId,zones){for(let zone of zones){for(let row=zone.top;row<=zone.bottom;row++){this.history.update("borders",sheetId,zone.right+1,row,"vertical",undefined);for(let col=zone.left;col<=zone.right;col++){this.history.update("borders",sheetId,col,row,undefined);}}
for(let col=zone.left;col<=zone.right;col++){this.history.update("borders",sheetId,col,zone.bottom+1,"horizontal",undefined);}}}
addBorder(sheetId,col,row,border){this.setBorder(sheetId,col,row,{...this.getCellBorder({sheetId,col,row}),...border,});}
setBorders(sheetId,zones,position,border){if(position==="clear"){return this.clearBorders(sheetId,zones);}
for(let zone of zones){if(position==="h"||position==="hv"||position==="all"){for(let row=zone.top+1;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,row,{top:border});}}}
if(position==="v"||position==="hv"||position==="all"){for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left+1;col<=zone.right;col++){this.addBorder(sheetId,col,row,{left:border});}}}
if(position==="left"||position==="all"||position==="external"){for(let row=zone.top;row<=zone.bottom;row++){this.addBorder(sheetId,zone.left,row,{left:border});}}
if(position==="right"||position==="all"||position==="external"){for(let row=zone.top;row<=zone.bottom;row++){this.addBorder(sheetId,zone.right+1,row,{left:border});}}
if(position==="top"||position==="all"||position==="external"){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,zone.top,{top:border});}}
if(position==="bottom"||position==="all"||position==="external"){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,zone.bottom+1,{top:border});}}}}
addBordersToMerge(sheetId,zone){const{left,right,top,bottom}=zone;const bordersTopLeft=this.getCellBorder({sheetId,col:left,row:top});const bordersBottomRight=this.getCellBorder({sheetId,col:right,row:bottom});this.clearBorders(sheetId,[zone]);if(bordersTopLeft?.top){this.setBorders(sheetId,[{...zone,bottom:top}],"top",bordersTopLeft.top);}
if(bordersTopLeft?.left){this.setBorders(sheetId,[{...zone,right:left}],"left",bordersTopLeft.left);}
if(bordersBottomRight?.bottom){this.setBorders(sheetId,[{...zone,top:bottom}],"bottom",bordersBottomRight.bottom);}
else if(bordersTopLeft?.bottom){this.setBorders(sheetId,[{...zone,top:bottom}],"bottom",bordersTopLeft.bottom);}
if(bordersBottomRight?.right){this.setBorders(sheetId,[{...zone,left:right}],"right",bordersBottomRight.right);}
else if(bordersTopLeft?.right){this.setBorders(sheetId,[{...zone,left:right}],"right",bordersTopLeft.right);}}
checkBordersUnchanged(cmd){const currentBorder=this.getCellBorder(cmd);const areAllNewBordersUndefined=!cmd.border?.bottom&&!cmd.border?.left&&!cmd.border?.right&&!cmd.border?.top;if((!currentBorder&&areAllNewBordersUndefined)||deepEquals(currentBorder,cmd.border)){return"NoChanges";}
return"Success";}
import(data){if(Object.keys(data.borders||{}).length){for(let sheet of data.sheets){for(const xc in sheet.cells){const cell=sheet.cells[xc];if(cell?.border){const border=data.borders[cell.border];const{col,row}=toCartesian(xc);this.setBorder(sheet.id,col,row,border,false);}}}}
for(let sheetData of data.sheets){if(sheetData.merges){for(let merge of sheetData.merges){this.addBordersToMerge(sheetData.id,toZone(merge));}}}}
export(data){const borders={};for(let sheet of data.sheets){for(let col=0;col<sheet.colNumber;col++){for(let row=0;row<sheet.rowNumber;row++){const border=this.getCellBorder({sheetId:sheet.id,col,row});if(border){const xc=toXC(col,row);const cell=sheet.cells[xc];const borderId=getItemId(border,borders);if(cell){cell.border=borderId;}
else{sheet.cells[xc]={border:borderId};}}}}}
data.borders=borders;}
exportForExcel(data){this.export(data);}}
class FunctionCodeBuilder{scope;code="";constructor(scope=new Scope()){this.scope=scope;}
append(...lines){this.code+=lines.map((line)=>line.toString()).join("\n")+"\n";}
return(expression){return new FunctionCodeImpl(this.scope,this.code,expression);}
toString(){return indentCode(this.code);}}
class FunctionCodeImpl{scope;returnExpression;code;constructor(scope,code,returnExpression){this.scope=scope;this.returnExpression=returnExpression;this.code=indentCode(code);}
toString(){return this.code;}
wrapInClosure(){const closureName=this.scope.nextVariableName();const code=new FunctionCodeBuilder(this.scope);code.append(`const ${closureName} = () => {`);code.append(this.code);code.append(`return ${this.returnExpression};`);code.append(`}`);return code.return(closureName);}
assignResultToVariable(){if(this.scope.isAlreadyDeclared(this.returnExpression)){return this;}
const variableName=this.scope.nextVariableName();const code=new FunctionCodeBuilder(this.scope);code.append(this.code);code.append(`const ${variableName} = ${this.returnExpression};`);return code.return(variableName);}}
class Scope{nextId=1;declaredVariables=new Set();nextVariableName(){const name=`_${this.nextId++}`;this.declaredVariables.add(name);return name;}
isAlreadyDeclared(name){return this.declaredVariables.has(name);}}
function splitLines(str){return str.split("\n").map((line)=>line.trim()).filter((line)=>line!=="");}
function indentCode(code){let result="";let indentLevel=0;const lines=splitLines(code);for(const line of lines){if(line.startsWith("}")){indentLevel--;}
result+="\t".repeat(indentLevel)+line+"\n";if(line.endsWith("{")){indentLevel++;}}
return result.trim();}
const functionRegex=/[a-zA-Z0-9\_]+(\.[a-zA-Z0-9\_]+)*/;const UNARY_OPERATORS_PREFIX=["-","+"];const UNARY_OPERATORS_POSTFIX=["%"];const ASSOCIATIVE_OPERATORS=["*","+","&"];const OP_PRIORITY={"^":30,"%":30,"*":20,"/":20,"+":15,"-":15,"&":13,">":10,"<>":10,">=":10,"<":10,"<=":10,"=":10,};function parseOperand(tokens){const current=tokens.shift();if(!current){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
switch(current.type){case"DEBUGGER":const next=parseExpression(tokens,1000);next.debug=true;return next;case"NUMBER":return{type:"NUMBER",value:parseNumber(current.value,DEFAULT_LOCALE)};case"STRING":return{type:"STRING",value:removeStringQuotes(current.value)};case"INVALID_REFERENCE":throw new InvalidReferenceError();case"REFERENCE":if(tokens[0]?.value===":"&&tokens[1]?.type==="REFERENCE"){tokens.shift();const rightReference=tokens.shift();return{type:"REFERENCE",value:`${current.value}:${rightReference?.value}`,};}
return{type:"REFERENCE",value:current.value,};case"SYMBOL":const value=current.value;const nextToken=tokens[0];if(nextToken?.type==="LEFT_PAREN"&&functionRegex.test(current.value)){const args=parseFunctionArgs(tokens);return{type:"FUNCALL",value:value,args};}
const upperCaseValue=value.toUpperCase();if(upperCaseValue==="TRUE"||upperCaseValue==="FALSE"){return{type:"BOOLEAN",value:upperCaseValue==="TRUE"};}
throw new BadExpressionError(_t("Invalid formula"));case"LEFT_PAREN":const result=parseExpression(tokens);consumeOrThrow(tokens,"RIGHT_PAREN",_t("Missing closing parenthesis"));return result;case"OPERATOR":const operator=current.value;if(UNARY_OPERATORS_PREFIX.includes(operator)){return{type:"UNARY_OPERATION",value:operator,operand:parseExpression(tokens,OP_PRIORITY[operator]),};}
throw new BadExpressionError(_t("Unexpected token: %s",current.value));default:throw new BadExpressionError(_t("Unexpected token: %s",current.value));}}
function parseFunctionArgs(tokens){consumeOrThrow(tokens,"LEFT_PAREN",_t("Missing opening parenthesis"));const nextToken=tokens[0];if(nextToken?.type==="RIGHT_PAREN"){consumeOrThrow(tokens,"RIGHT_PAREN");return[];}
const args=[];args.push(parseOneFunctionArg(tokens));while(tokens[0]?.type!=="RIGHT_PAREN"){consumeOrThrow(tokens,"ARG_SEPARATOR",_t("Wrong function call"));args.push(parseOneFunctionArg(tokens));}
consumeOrThrow(tokens,"RIGHT_PAREN");return args;}
function parseOneFunctionArg(tokens){const nextToken=tokens[0];if(nextToken?.type==="ARG_SEPARATOR"||nextToken?.type==="RIGHT_PAREN"){return{type:"EMPTY",value:""};}
return parseExpression(tokens);}
function consumeOrThrow(tokens,type,message=DEFAULT_ERROR_MESSAGE){const token=tokens.shift();if(!token||token.type!==type){throw new BadExpressionError(message);}}
function parseExpression(tokens,parent_priority=0){if(tokens.length===0){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
let left=parseOperand(tokens);while(tokens[0]?.type==="OPERATOR"&&OP_PRIORITY[tokens[0].value]>parent_priority){const operator=tokens.shift().value;if(UNARY_OPERATORS_POSTFIX.includes(operator)){left={type:"UNARY_OPERATION",value:operator,operand:left,postfix:true,};}
else{const right=parseExpression(tokens,OP_PRIORITY[operator]);left={type:"BIN_OPERATION",value:operator,left,right,};}}
return left;}
function parse(str){return parseTokens(tokenize(str));}
function parseTokens(tokens){tokens=tokens.filter((x)=>x.type!=="SPACE");if(tokens[0].value==="="){tokens.splice(0,1);}
const result=parseExpression(tokens);if(tokens.length){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
return result;}
function convertAstNodes(ast,type,fn){return mapAst(ast,(ast)=>{if(ast.type===type){return fn(ast);}
return ast;});}
function iterateAstNodes(ast){return Array.from(astIterator(ast));}
function*astIterator(ast){yield ast;switch(ast.type){case"FUNCALL":for(const arg of ast.args){yield*astIterator(arg);}
break;case"UNARY_OPERATION":yield*astIterator(ast.operand);break;case"BIN_OPERATION":yield*astIterator(ast.left);yield*astIterator(ast.right);break;}}
function mapAst(ast,fn){ast=fn(ast);switch(ast.type){case"FUNCALL":return{...ast,args:ast.args.map((child)=>mapAst(child,fn)),};case"UNARY_OPERATION":return{...ast,operand:mapAst(ast.operand,fn),};case"BIN_OPERATION":return{...ast,right:mapAst(ast.right,fn),left:mapAst(ast.left,fn),};default:return ast;}}
function astToFormula(ast){switch(ast.type){case"FUNCALL":const args=ast.args.map((arg)=>astToFormula(arg));return`${ast.value}(${args.join(",")})`;case"NUMBER":return ast.value.toString();case"REFERENCE":return ast.value;case"STRING":return`"${ast.value}"`;case"BOOLEAN":return ast.value?"TRUE":"FALSE";case"UNARY_OPERATION":return ast.postfix?leftOperandToFormula(ast)+ast.value:ast.value+rightOperandToFormula(ast);case"BIN_OPERATION":return leftOperandToFormula(ast)+ast.value+rightOperandToFormula(ast);default:return ast.value;}}
function leftOperandToFormula(operationAST){const mainOperator=operationAST.value;const leftOperation="left"in operationAST?operationAST.left:operationAST.operand;const leftOperator=leftOperation.value;const needParenthesis=leftOperation.type==="BIN_OPERATION"&&OP_PRIORITY[leftOperator]<OP_PRIORITY[mainOperator];return needParenthesis?`(${astToFormula(leftOperation)})`:astToFormula(leftOperation);}
function rightOperandToFormula(operationAST){const mainOperator=operationAST.value;const rightOperation="right"in operationAST?operationAST.right:operationAST.operand;const rightPriority=OP_PRIORITY[rightOperation.value];const mainPriority=OP_PRIORITY[mainOperator];let needParenthesis=false;if(rightOperation.type!=="BIN_OPERATION"){needParenthesis=false;}
else if(rightPriority<mainPriority){needParenthesis=true;}
else if(rightPriority===mainPriority&&!ASSOCIATIVE_OPERATORS.includes(mainOperator)){needParenthesis=true;}
return needParenthesis?`(${astToFormula(rightOperation)})`:astToFormula(rightOperation);}
const functions$1=functionRegistry.content;const OPERATOR_MAP={"=":"EQ","+":"ADD","-":"MINUS","*":"MULTIPLY","/":"DIVIDE",">=":"GTE","<>":"NE",">":"GT","<=":"LTE","<":"LT","^":"POWER","&":"CONCATENATE",};const UNARY_OPERATOR_MAP={"-":"UMINUS","+":"UPLUS","%":"UNARY.PERCENT",};const functionCache={};function compile(formula){const tokens=rangeTokenize(formula);return compileTokens(tokens);}
function compileTokens(tokens){const{dependencies,constantValues}=formulaArguments(tokens);const cacheKey=compilationCacheKey(tokens,dependencies,constantValues);if(!functionCache[cacheKey]){const ast=parseTokens([...tokens]);const scope=new Scope();if(ast.type==="BIN_OPERATION"&&ast.value===":"){throw new BadExpressionError(_t("Invalid formula"));}
if(ast.type==="EMPTY"){throw new BadExpressionError(_t("Invalid formula"));}
const compiledAST=compileAST(ast);const code=new FunctionCodeBuilder();code.append(`// ${cacheKey}`);code.append(compiledAST);code.append(`return ${compiledAST.returnExpression};`);let baseFunction=new Function("deps","ref","range","ctx",code.toString());functionCache[cacheKey]={execute:baseFunction,};function compileFunctionArgs(ast){const{args}=ast;const functionName=ast.value.toUpperCase();const functionDefinition=functions$1[functionName];if(!functionDefinition){throw new UnknownFunctionError(ast.value);}
assertEnoughArgs(ast);const compiledArgs=[];for(let i=0;i<args.length;i++){const argToFocus=functionDefinition.getArgToFocus(i+1)-1;const argDefinition=functionDefinition.args[argToFocus];const currentArg=args[i];const argTypes=argDefinition.type||[];const isMeta=argTypes.includes("META");const isLazy=argDefinition.lazy;const hasRange=argTypes.some((t)=>isRangeType(t));const isRangeOnly=argTypes.every((t)=>isRangeType(t));if(isRangeOnly){if(!isRangeInput(currentArg)){throw new BadExpressionError(_t("Function %s expects the parameter %s to be reference to a cell or range, not a %s.",functionName,(i+1).toString(),currentArg.type.toLowerCase()));}}
const compiledAST=compileAST(currentArg,isMeta,hasRange,{functionName,paramIndex:i+1,});compiledArgs.push(isLazy?compiledAST.wrapInClosure():compiledAST);}
return compiledArgs;}
function compileAST(ast,isMeta=false,hasRange=false,referenceVerification={}){const code=new FunctionCodeBuilder(scope);if(ast.type!=="REFERENCE"&&!(ast.type==="BIN_OPERATION"&&ast.value===":")){if(isMeta){throw new BadExpressionError(_t("Argument must be a reference to a cell or range."));}}
if(ast.debug){code.append("debugger;");}
switch(ast.type){case"BOOLEAN":return code.return(`{ value: ${ast.value} }`);case"NUMBER":return code.return(`{ value: this.constantValues.numbers[${constantValues.numbers.indexOf(ast.value)}] }`);case"STRING":return code.return(`{ value: this.constantValues.strings[${constantValues.strings.indexOf(ast.value)}] }`);case"REFERENCE":const referenceIndex=dependencies.indexOf(ast.value);if(hasRange){return code.return(`range(deps[${referenceIndex}])`);}
else{return code.return(`ref(deps[${referenceIndex}], ${isMeta ? "true" : "false"}, "${referenceVerification.functionName || OPERATOR_MAP["="]}",  ${referenceVerification.paramIndex})`);}
case"FUNCALL":const args=compileFunctionArgs(ast).map((arg)=>arg.assignResultToVariable());code.append(...args);const fnName=ast.value.toUpperCase();code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${args.map((arg) => arg.returnExpression)})`);case"UNARY_OPERATION":{const fnName=UNARY_OPERATOR_MAP[ast.value];const operand=compileAST(ast.operand,false,false,{functionName:fnName,}).assignResultToVariable();code.append(operand);code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${operand.returnExpression})`);}
case"BIN_OPERATION":{const fnName=OPERATOR_MAP[ast.value];const left=compileAST(ast.left,false,false,{functionName:fnName,}).assignResultToVariable();const right=compileAST(ast.right,false,false,{functionName:fnName,}).assignResultToVariable();code.append(left);code.append(right);code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${left.returnExpression}, ${right.returnExpression})`);}
case"EMPTY":return code.return("undefined");}}}
const compiledFormula={execute:functionCache[cacheKey].execute,dependencies,constantValues,tokens,};return compiledFormula;}
function compilationCacheKey(tokens,dependencies,constantValues){return concat(tokens.map((token)=>{switch(token.type){case"STRING":const value=removeStringQuotes(token.value);return`|S${constantValues.strings.indexOf(value)}|`;case"NUMBER":return`|N${constantValues.numbers.indexOf(parseNumber(token.value, DEFAULT_LOCALE))}|`;case"REFERENCE":case"INVALID_REFERENCE":return`|${dependencies.indexOf(token.value)}|`;case"SPACE":return"";default:return token.value;}}));}
function formulaArguments(tokens){const constantValues={numbers:[],strings:[],};const dependencies=[];for(const token of tokens){switch(token.type){case"INVALID_REFERENCE":case"REFERENCE":dependencies.push(token.value);break;case"STRING":const value=removeStringQuotes(token.value);if(!constantValues.strings.includes(value)){constantValues.strings.push(value);}
break;case"NUMBER":{const value=parseNumber(token.value,DEFAULT_LOCALE);if(!constantValues.numbers.includes(value)){constantValues.numbers.push(value);}
break;}}}
return{dependencies,constantValues,};}
function assertEnoughArgs(ast){const nbrArg=ast.args.length;const functionName=ast.value.toUpperCase();const functionDefinition=functions$1[functionName];if(nbrArg<functionDefinition.minArgRequired){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected %s minimum, but got %s instead.",functionName,functionDefinition.minArgRequired.toString(),nbrArg.toString()));}
if(nbrArg>functionDefinition.maxArgPossible){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected %s maximum, but got %s instead.",functionName,functionDefinition.maxArgPossible.toString(),nbrArg.toString()));}
const repeatableArgs=functionDefinition.nbrArgRepeating;if(repeatableArgs>1){const unrepeatableArgs=functionDefinition.args.length-repeatableArgs;const repeatingArgs=nbrArg-unrepeatableArgs;if(repeatingArgs%repeatableArgs!==0){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected all arguments after position %s to be supplied by groups of %s arguments",functionName,unrepeatableArgs.toString(),repeatableArgs.toString()));}}}
function isRangeType(type){return type.startsWith("RANGE");}
function isRangeInput(arg){if(arg.type==="REFERENCE"){return true;}
if(arg.type==="FUNCALL"){const fnDef=functions$1[arg.value.toUpperCase()];return fnDef&&isRangeType(fnDef.returns[0]);}
return false;}
function enrichTokens(tokens){let current=0;return tokens.map((x)=>{const len=x.value.toString().length;const token=Object.assign({},x,{start:current,end:current+len,length:len,});current=token.end;return token;});}
function mapParenthesis(tokens){let maxParen=1;const stack=[];return tokens.map((token)=>{if(token.type==="LEFT_PAREN"){stack.push(maxParen);token.parenIndex=maxParen;maxParen++;}
else if(token.type==="RIGHT_PAREN"){token.parenIndex=stack.pop();}
return token;});}
function mapParentFunction(tokens){let stack=[];let functionStarted="";const res=tokens.map((token,i)=>{if(!["SPACE","LEFT_PAREN"].includes(token.type)){functionStarted="";}
switch(token.type){case"SYMBOL":functionStarted=token.value;break;case"LEFT_PAREN":stack.push({parent:functionStarted,argPosition:0});functionStarted="";break;case"RIGHT_PAREN":stack.pop();break;case"ARG_SEPARATOR":if(stack.length){stack[stack.length-1].argPosition++;}
break;}
if(stack.length){const functionContext=stack[stack.length-1];if(functionContext.parent){token.functionContext=Object.assign({},functionContext);}}
return token;});return res;}
function composerTokenize(formula,locale){const tokens=rangeTokenize(formula,locale);return mapParentFunction(mapParenthesis(enrichTokens(tokens)));}
const functions=functionRegistry.content;function isExportableToExcel(tokens){try{const nonExportableFunctions=iterateAstNodes(parseTokens(tokens)).filter((ast)=>ast.type==="FUNCALL"&&!functions[ast.value.toUpperCase()]?.isExported);return nonExportableFunctions.length===0;}
catch(error){return false;}}
class CellPlugin extends CorePlugin{static getters=["zoneToXC","getCells","getFormulaCellContent","getTranslatedCellFormula","getCellStyle","getCellById",];nextId=1;cells={};adaptRanges(applyChange,sheetId){for(const sheet of Object.keys(this.cells)){for(const cell of Object.values(this.cells[sheet]||{})){if(cell.isFormula){for(const range of cell.compiledFormula.dependencies){if(!sheetId||range.sheetId===sheetId){const change=applyChange(range);if(change.changeType!=="NONE"){this.history.update("cells",sheet,cell.id,"compiledFormula","dependencies",cell.compiledFormula.dependencies.indexOf(range),change.range);}}}}}}}
allowDispatch(cmd){switch(cmd.type){case"UPDATE_CELL":return this.checkValidations(cmd,this.checkCellOutOfSheet,this.checkUselessUpdateCell);case"CLEAR_CELL":return this.checkValidations(cmd,this.checkCellOutOfSheet,this.checkUselessClearCell);default:return"Success";}}
handle(cmd){switch(cmd.type){case"SET_FORMATTING":if("style"in cmd){this.setStyle(cmd.sheetId,cmd.target,cmd.style);}
if("format"in cmd&&cmd.format!==undefined){this.setFormatter(cmd.sheetId,cmd.target,cmd.format);}
break;case"CLEAR_FORMATTING":this.clearFormatting(cmd.sheetId,cmd.target);break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.handleAddColumnsRows(cmd,this.copyColumnStyle.bind(this));}
else{this.handleAddColumnsRows(cmd,this.copyRowStyle.bind(this));}
break;case"UPDATE_CELL":this.updateCell(cmd.sheetId,cmd.col,cmd.row,cmd);break;case"CLEAR_CELL":this.dispatch("UPDATE_CELL",{sheetId:cmd.sheetId,col:cmd.col,row:cmd.row,content:"",style:null,format:"",});break;}}
setFormatter(sheetId,zones,format){for(let zone of zones){for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){this.dispatch("UPDATE_CELL",{sheetId,col,row,format,});}}}}
clearFormatting(sheetId,zones){for(let zone of zones){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){this.dispatch("UPDATE_CELL",{sheetId,col,row,style:null,format:"",});}}}}
handleAddColumnsRows(cmd,fn){let insertedElements;let styleReference;if(cmd.position==="before"){insertedElements=range(cmd.base,cmd.base+cmd.quantity);styleReference=cmd.base+cmd.quantity;}
else{insertedElements=range(cmd.base+1,cmd.base+cmd.quantity+1);styleReference=cmd.base;}
fn(cmd.sheetId,styleReference,insertedElements);}
import(data){for(let sheet of data.sheets){for(let xc in sheet.cells){const cellData=sheet.cells[xc];const{col,row}=toCartesian(xc);if(cellData?.content||cellData?.format||cellData?.style){const cell=this.importCell(sheet.id,cellData,data.styles,data.formats);this.history.update("cells",sheet.id,cell.id,cell);this.dispatch("UPDATE_CELL_POSITION",{cellId:cell.id,col,row,sheetId:sheet.id,});}}}}
export(data){const styles={};const formats={};for(let _sheet of data.sheets){const cells={};const positions=Object.keys(this.cells[_sheet.id]||{}).map((cellId)=>this.getters.getCellPosition(cellId)).sort((a,b)=>(a.col===b.col?a.row-b.row:a.col-b.col));for(const position of positions){const cell=this.getters.getCell(position);const xc=toXC(position.col,position.row);const style=this.removeDefaultStyleValues(cell.style);cells[xc]={style:Object.keys(style).length?getItemId(style,styles):undefined,format:cell.format?getItemId(cell.format,formats):undefined,content:cell.content||undefined,};}
_sheet.cells=cells;}
data.styles=styles;data.formats=formats;}
importCell(sheetId,cellData,normalizedStyles,normalizedFormats){const style=(cellData.style&&normalizedStyles[cellData.style])||undefined;const format=(cellData.format&&normalizedFormats[cellData.format])||undefined;const cellId=this.getNextUid();return this.createCell(cellId,cellData?.content||"",format,style,sheetId);}
exportForExcel(data){this.export(data);}
removeDefaultStyleValues(style){const cleanedStyle={...style};for(const property in DEFAULT_STYLE){if(cleanedStyle[property]===DEFAULT_STYLE[property]){delete cleanedStyle[property];}}
return cleanedStyle;}
getCells(sheetId){return this.cells[sheetId]||{};}
getCellById(cellId){const position=this.getters.getCellPosition(cellId);const sheet=this.cells[position.sheetId];return sheet[cellId];}
getFormulaCellContent(sheetId,compiledFormula,dependencies,useFixedReference=false){const ranges=dependencies||compiledFormula.dependencies;let rangeIndex=0;return concat(compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const range=ranges[rangeIndex++];return this.getters.getRangeString(range,sheetId,{useFixedReference});}
return token.value;}));}
getTranslatedCellFormula(sheetId,offsetX,offsetY,compiledFormula){const adaptedDependencies=this.getters.createAdaptedRanges(compiledFormula.dependencies,offsetX,offsetY,sheetId);return this.getFormulaCellContent(sheetId,compiledFormula,adaptedDependencies);}
getCellStyle(position){return this.getters.getCell(position)?.style||{};}
zoneToXC(sheetId,zone,fixedParts=[{colFixed:false,rowFixed:false}]){zone=this.getters.expandZone(sheetId,zone);const topLeft=toXC(zone.left,zone.top,fixedParts[0]);const botRight=toXC(zone.right,zone.bottom,fixedParts.length>1?fixedParts[1]:fixedParts[0]);const cellTopLeft=this.getters.getMainCellPosition({sheetId,col:zone.left,row:zone.top,});const cellBotRight=this.getters.getMainCellPosition({sheetId,col:zone.right,row:zone.bottom,});const sameCell=cellTopLeft.col===cellBotRight.col&&cellTopLeft.row===cellBotRight.row;if(topLeft!=botRight&&!sameCell){return topLeft+":"+botRight;}
return topLeft;}
setStyle(sheetId,target,style){for(let zone of target){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const cell=this.getters.getCell({sheetId,col,row});this.dispatch("UPDATE_CELL",{sheetId,col,row,style:style?{...cell?.style,...style}:undefined,});}}}}
copyColumnStyle(sheetId,refColumn,targetCols){for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const format=this.getFormat(sheetId,refColumn,row);if(format.style||format.format){for(let col of targetCols){this.dispatch("UPDATE_CELL",{sheetId,col,row,...format});}}}}
copyRowStyle(sheetId,refRow,targetRows){for(let col=0;col<this.getters.getNumberCols(sheetId);col++){const format=this.getFormat(sheetId,col,refRow);if(format.style||format.format){for(let row of targetRows){this.dispatch("UPDATE_CELL",{sheetId,col,row,...format});}}}}
getFormat(sheetId,col,row){const format={};const position=this.getters.getMainCellPosition({sheetId,col,row});const cell=this.getters.getCell(position);if(cell){if(cell.style){format["style"]=cell.style;}
if(cell.format){format["format"]=cell.format;}}
return format;}
getNextUid(){const id=this.nextId.toString();this.history.update("nextId",this.nextId+1);return id;}
updateCell(sheetId,col,row,after){const before=this.getters.getCell({sheetId,col,row});const hasContent="content"in after||"formula"in after;const afterContent=hasContent?replaceSpecialSpaces(after?.content):before?.content||"";let style;if(after.style!==undefined){style=after.style||undefined;}
else{style=before?before.style:undefined;}
const format="format"in after?after.format:before&&before.format;if(((hasContent&&!afterContent&&!after.formula)||(!hasContent&&(!before||before.content==="")))&&!style&&!format){if(before){this.history.update("cells",sheetId,before.id,undefined);this.dispatch("UPDATE_CELL_POSITION",{cellId:undefined,col,row,sheetId,});}
return;}
const cellId=before?.id||this.getNextUid();const cell=this.createCell(cellId,afterContent,format,style,sheetId);this.history.update("cells",sheetId,cell.id,cell);this.dispatch("UPDATE_CELL_POSITION",{cellId:cell.id,col,row,sheetId});}
createCell(id,content,format,style,sheetId){if(!content.startsWith("=")){return this.createLiteralCell(id,content,format,style);}
try{return this.createFormulaCell(id,content,format,style,sheetId);}
catch(error){return this.createErrorFormula(id,content,format,style,error);}}
createLiteralCell(id,content,format,style){const locale=this.getters.getLocale();return{id,content:parseLiteral(content,locale).toString(),style,format:format||detectDateFormat(content,locale)||detectNumberFormat(content),isFormula:false,};}
createFormulaCell(id,content,format,style,sheetId){const compiledFormula=compile(content);if(compiledFormula.dependencies.length){return this.createFormulaCellWithDependencies(id,compiledFormula,format,style,sheetId);}
return{id,content,style,format,isFormula:true,compiledFormula:{...compiledFormula,dependencies:[],},};}
createFormulaCellWithDependencies(id,compiledFormula,format,style,sheetId){const dependencies=[];for(const xc of compiledFormula.dependencies){dependencies.push(this.getters.getRangeFromSheetXC(sheetId,xc));}
return new FormulaCellWithDependencies(id,compiledFormula,format,style,dependencies,sheetId,this.getters.getRangeString);}
createErrorFormula(id,content,format,style,error){return{id,content,style,format,isFormula:true,compiledFormula:{tokens:tokenize(content),dependencies:[],execute:function(){throw error;},},};}
checkCellOutOfSheet(cmd){const{sheetId,col,row}=cmd;const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"InvalidSheetId";const sheetZone=this.getters.getSheetZone(sheetId);return isInside(col,row,sheetZone)?"Success":"TargetOutOfSheet";}
checkUselessClearCell(cmd){const cell=this.getters.getCell(cmd);if(!cell)
return"NoChanges";if(!cell.content&&!cell.style&&!cell.format){return"NoChanges";}
return"Success";}
checkUselessUpdateCell(cmd){const cell=this.getters.getCell(cmd);const hasContent="content"in cmd||"formula"in cmd;const hasStyle="style"in cmd;const hasFormat="format"in cmd;if((!hasContent||cell?.content===cmd.content)&&(!hasStyle||deepEquals(cell?.style,cmd.style))&&(!hasFormat||cell?.format===cmd.format)){return"NoChanges";}
return"Success";}}
class FormulaCellWithDependencies{id;format;style;sheetId;getRangeString;isFormula=true;compiledFormula;constructor(id,compiledFormula,format,style,dependencies,sheetId,getRangeString){this.id=id;this.format=format;this.style=style;this.sheetId=sheetId;this.getRangeString=getRangeString;let rangeIndex=0;const tokens=compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const index=rangeIndex++;return new RangeReferenceToken(dependencies,index,this.sheetId,this.getRangeString);}
return token;});this.compiledFormula={...compiledFormula,dependencies,tokens,};}
get content(){return concat(this.compiledFormula.tokens.map((token)=>token.value));}
get contentWithFixedReferences(){let rangeIndex=0;return concat(this.compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const index=rangeIndex++;return this.getRangeString(this.compiledFormula.dependencies[index],this.sheetId,{useFixedReference:true,});}
return token.value;}));}}
class RangeReferenceToken{ranges;rangeIndex;sheetId;getRangeString;type="REFERENCE";constructor(ranges,rangeIndex,sheetId,getRangeString){this.ranges=ranges;this.rangeIndex=rangeIndex;this.sheetId=sheetId;this.getRangeString=getRangeString;}
get value(){const range=this.ranges[this.rangeIndex];return this.getRangeString(range,this.sheetId);}}
class ChartPlugin extends CorePlugin{static getters=["isChartDefined","getChartDefinition","getChartType","getChartIds","getChart","getContextCreationChart",];charts={};createChart=chartFactory(this.getters);validateChartDefinition=(cmd)=>validateChartDefinition(this,cmd.definition);adaptRanges(applyChange){for(const[chartId,chart]of Object.entries(this.charts)){this.history.update("charts",chartId,chart?.updateRanges(applyChange));}}
allowDispatch(cmd){switch(cmd.type){case"CREATE_CHART":return this.checkValidations(cmd,this.chainValidations(this.validateChartDefinition,this.checkChartDuplicate));case"UPDATE_CHART":return this.checkValidations(cmd,this.chainValidations(this.validateChartDefinition,this.checkChartExists));default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_CHART":this.addFigure(cmd.id,cmd.sheetId,cmd.position,cmd.size);this.addChart(cmd.id,cmd.definition);break;case"UPDATE_CHART":{this.addChart(cmd.id,cmd.definition);break;}
case"DUPLICATE_SHEET":{const sheetFiguresFrom=this.getters.getFigures(cmd.sheetId);for(const fig of sheetFiguresFrom){if(fig.tag==="chart"){const figureIdBase=fig.id.split(FIGURE_ID_SPLITTER).pop();const duplicatedFigureId=`${cmd.sheetIdTo}${FIGURE_ID_SPLITTER}${figureIdBase}`;const chart=this.charts[fig.id]?.copyForSheetId(cmd.sheetIdTo);if(chart){this.dispatch("CREATE_CHART",{id:duplicatedFigureId,position:{x:fig.x,y:fig.y},size:{width:fig.width,height:fig.height},definition:chart.getDefinition(),sheetId:cmd.sheetIdTo,});}}}
break;}
case"DELETE_FIGURE":this.history.update("charts",cmd.id,undefined);break;case"DELETE_SHEET":for(let id of this.getChartIds(cmd.sheetId)){this.history.update("charts",id,undefined);}
break;}}
getContextCreationChart(figureId){return this.charts[figureId]?.getContextCreation();}
getChart(figureId){return this.charts[figureId];}
getChartType(figureId){const type=this.charts[figureId]?.type;if(!type){throw new Error("Chart not defined.");}
return type;}
isChartDefined(figureId){return figureId in this.charts&&this.charts!==undefined;}
getChartIds(sheetId){return Object.entries(this.charts).filter(([,chart])=>chart?.sheetId===sheetId).map(([id])=>id);}
getChartDefinition(figureId){const definition=this.charts[figureId]?.getDefinition();if(!definition){throw new Error(`There is no chart with the given figureId: ${figureId}`);}
return definition;}
import(data){for(let sheet of data.sheets){if(sheet.figures){for(let figure of sheet.figures){if(figure.tag==="chart"){this.charts[figure.id]=this.createChart(figure.id,figure.data,sheet.id);}}}}}
export(data){if(data.sheets){for(let sheet of data.sheets){const sheetFigures=this.getters.getFigures(sheet.id);const figures=[];for(let sheetFigure of sheetFigures){const figure=sheetFigure;if(figure&&figure.tag==="chart"){const data=this.charts[figure.id]?.getDefinition();if(data){figure.data=data;figures.push(figure);}}
else{figures.push(figure);}}
sheet.figures=figures;}}}
addFigure(id,sheetId,position={x:0,y:0},size={width:DEFAULT_FIGURE_WIDTH,height:DEFAULT_FIGURE_HEIGHT,}){if(this.getters.getFigure(sheetId,id)){return;}
const figure={id,x:position.x,y:position.y,width:size.width,height:size.height,tag:"chart",};this.dispatch("CREATE_FIGURE",{sheetId,figure});}
addChart(id,definition){const sheetId=this.getters.getFigureSheetId(id);if(sheetId){this.history.update("charts",id,this.createChart(id,definition,sheetId));}}
checkChartDuplicate(cmd){return this.getters.getFigureSheetId(cmd.id)?"DuplicatedChartId":"Success";}
checkChartExists(cmd){return this.getters.getFigureSheetId(cmd.id)?"Success":"ChartDoesNotExist";}}
function stringToNumber(value){return value===""?NaN:Number(value);}
class ConditionalFormatPlugin extends CorePlugin{static getters=["getConditionalFormats","getRulesSelection","getRulesByCell","getAdaptedCfRanges",];cfRules={};loopThroughRangesOfSheet(sheetId,applyChange){for(const rule of this.cfRules[sheetId]){for(const range of rule.ranges){const change=applyChange(range);switch(change.changeType){case"REMOVE":let copy=rule.ranges.slice();copy.splice(rule.ranges.indexOf(range),1);if(copy.length>=1){this.history.update("cfRules",sheetId,this.cfRules[sheetId].indexOf(rule),"ranges",copy);}
else{this.removeConditionalFormatting(rule.id,sheetId);}
break;case"RESIZE":case"MOVE":case"CHANGE":this.history.update("cfRules",sheetId,this.cfRules[sheetId].indexOf(rule),"ranges",rule.ranges.indexOf(range),change.range);break;}}}}
adaptRanges(applyChange,sheetId){if(sheetId){this.loopThroughRangesOfSheet(sheetId,applyChange);}
else{for(const sheetId of Object.keys(this.cfRules)){this.loopThroughRangesOfSheet(sheetId,applyChange);}}}
allowDispatch(cmd){switch(cmd.type){case"ADD_CONDITIONAL_FORMAT":return this.checkValidations(cmd,this.checkCFRule,this.checkEmptyRange);case"CHANGE_CONDITIONAL_FORMAT_PRIORITY":return this.checkValidPriorityChange(cmd.cfId,cmd.delta,cmd.sheetId);}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.cfRules[cmd.sheetId]=[];break;case"DUPLICATE_SHEET":this.history.update("cfRules",cmd.sheetIdTo,[]);for(const cf of this.getConditionalFormats(cmd.sheetId)){this.addConditionalFormatting(cf,cmd.sheetIdTo);}
break;case"DELETE_SHEET":const cfRules=Object.assign({},this.cfRules);delete cfRules[cmd.sheetId];this.history.update("cfRules",cfRules);break;case"ADD_CONDITIONAL_FORMAT":const cf={...cmd.cf,ranges:cmd.ranges.map((rangeData)=>this.getters.getRangeString(this.getters.getRangeFromRangeData(rangeData),cmd.sheetId)),};this.addConditionalFormatting(cf,cmd.sheetId);break;case"REMOVE_CONDITIONAL_FORMAT":this.removeConditionalFormatting(cmd.id,cmd.sheetId);break;case"CHANGE_CONDITIONAL_FORMAT_PRIORITY":this.changeCFPriority(cmd.cfId,cmd.delta,cmd.sheetId);break;}}
import(data){for(let sheet of data.sheets){this.cfRules[sheet.id]=sheet.conditionalFormats.map((rule)=>this.mapToConditionalFormatInternal(sheet.id,rule));}}
export(data){if(data.sheets){for(let sheet of data.sheets){if(this.cfRules[sheet.id]){sheet.conditionalFormats=this.cfRules[sheet.id].map((rule)=>this.mapToConditionalFormat(sheet.id,rule));}}}}
exportForExcel(data){if(data.sheets){for(let sheet of data.sheets){if(this.cfRules[sheet.id]){sheet.conditionalFormats=this.cfRules[sheet.id].map((rule)=>this.mapToConditionalFormat(sheet.id,rule,{useFixedReference:true}));}}}}
getConditionalFormats(sheetId){return this.cfRules[sheetId]?.map((cf)=>this.mapToConditionalFormat(sheetId,cf))||[];}
getRulesSelection(sheetId,selection){const ruleIds=new Set();selection.forEach((zone)=>{const zoneRuleId=this.getRulesByZone(sheetId,zone);zoneRuleId.forEach((ruleId)=>{ruleIds.add(ruleId);});});return Array.from(ruleIds);}
getRulesByZone(sheetId,zone){const ruleIds=new Set();for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cellRules=this.getRulesByCell(sheetId,col,row);cellRules.forEach((rule)=>{ruleIds.add(rule.id);});}}
return ruleIds;}
getRulesByCell(sheetId,cellCol,cellRow){const rules=[];for(let cf of this.cfRules[sheetId]){for(let range of cf.ranges){if(isInside(cellCol,cellRow,range.zone)){rules.push(cf);}}}
return new Set(rules.map((rule)=>{return this.mapToConditionalFormat(sheetId,rule);}));}
getAdaptedCfRanges(sheetId,cf,toAdd,toRemove){if(toAdd.length===0&&toRemove.length===0){return;}
const rules=this.getters.getConditionalFormats(sheetId);const replaceIndex=rules.findIndex((c)=>c.id===cf.id);let currentRanges=[];if(replaceIndex>-1){currentRanges=rules[replaceIndex].ranges;}
currentRanges=currentRanges.concat(toAdd);return recomputeZones(currentRanges,toRemove);}
mapToConditionalFormat(sheetId,cf,{useFixedReference}={useFixedReference:false}){return{...cf,ranges:cf.ranges.map((range)=>{return this.getters.getRangeString(range,sheetId,{useFixedReference});}),};}
mapToConditionalFormatInternal(sheet,cf){const conditionalFormat={...cf,ranges:cf.ranges.map((range)=>{return this.getters.getRangeFromSheetXC(sheet,range);}),};return conditionalFormat;}
addConditionalFormatting(cf,sheet){const currentCF=this.cfRules[sheet].slice();const replaceIndex=currentCF.findIndex((c)=>c.id===cf.id);const newCF=this.mapToConditionalFormatInternal(sheet,cf);if(replaceIndex>-1){currentCF.splice(replaceIndex,1,newCF);}
else{currentCF.push(newCF);}
this.history.update("cfRules",sheet,currentCF);}
checkValidPriorityChange(cfId,delta,sheetId){if(!this.cfRules[sheetId])
return"InvalidSheetId";const ruleIndex=this.cfRules[sheetId].findIndex((cf)=>cf.id===cfId);if(ruleIndex===-1)
return"InvalidConditionalFormatId";const cfIndex2=ruleIndex-delta;if(cfIndex2<0||cfIndex2>=this.cfRules[sheetId].length){return"InvalidConditionalFormatId";}
return"Success";}
checkEmptyRange(cmd){return cmd.ranges.length?"Success":"EmptyRange";}
checkCFRule(cmd){const rule=cmd.cf.rule;switch(rule.type){case"CellIsRule":return this.checkValidations(rule,this.checkOperatorArgsNumber(2,["Between","NotBetween"]),this.checkOperatorArgsNumber(1,["BeginsWith","ContainsText","EndsWith","GreaterThan","GreaterThanOrEqual","LessThan","LessThanOrEqual","NotContains",]),this.checkOperatorArgsNumber(0,["IsEmpty","IsNotEmpty"]));case"ColorScaleRule":{return this.checkValidations(rule,this.chainValidations(this.checkThresholds(this.checkFormulaCompilation)),this.chainValidations(this.checkThresholds(this.checkNaN),this.batchValidations(this.checkMinBiggerThanMax,this.checkMinBiggerThanMid,this.checkMidBiggerThanMax)));}
case"IconSetRule":{return this.checkValidations(rule,this.chainValidations(this.checkInflectionPoints(this.checkNaN),this.checkLowerBiggerThanUpper),this.chainValidations(this.checkInflectionPoints(this.checkFormulaCompilation)));}}
return"Success";}
checkOperatorArgsNumber(expectedNumber,operators){if(expectedNumber>2){throw new Error("Checking more than 2 arguments is currently not supported. Add the appropriate CommandResult if you want to.");}
return(rule)=>{if(operators.includes(rule.operator)){const errors=[];const isEmpty=(value)=>value===undefined||value==="";if(expectedNumber>=1&&isEmpty(rule.values[0])){errors.push("FirstArgMissing");}
if(expectedNumber>=2&&isEmpty(rule.values[1])){errors.push("SecondArgMissing");}
return errors.length?errors:"Success";}
return"Success";};}
checkNaN(threshold,thresholdName){if(["number","percentage","percentile"].includes(threshold.type)&&(threshold.value===""||isNaN(threshold.value))){switch(thresholdName){case"min":return"MinNaN";case"max":return"MaxNaN";case"mid":return"MidNaN";case"upperInflectionPoint":return"ValueUpperInflectionNaN";case"lowerInflectionPoint":return"ValueLowerInflectionNaN";}}
return"Success";}
checkFormulaCompilation(threshold,thresholdName){if(threshold.type!=="formula")
return"Success";try{compile(threshold.value||"");}
catch(error){switch(thresholdName){case"min":return"MinInvalidFormula";case"max":return"MaxInvalidFormula";case"mid":return"MidInvalidFormula";case"upperInflectionPoint":return"ValueUpperInvalidFormula";case"lowerInflectionPoint":return"ValueLowerInvalidFormula";}}
return"Success";}
checkThresholds(check){return this.batchValidations((rule)=>check(rule.minimum,"min"),(rule)=>check(rule.maximum,"max"),(rule)=>(rule.midpoint?check(rule.midpoint,"mid"):"Success"));}
checkInflectionPoints(check){return this.batchValidations((rule)=>check(rule.lowerInflectionPoint,"lowerInflectionPoint"),(rule)=>check(rule.upperInflectionPoint,"upperInflectionPoint"));}
checkLowerBiggerThanUpper(rule){const minValue=rule.lowerInflectionPoint.value;const maxValue=rule.upperInflectionPoint.value;if(["number","percentage","percentile"].includes(rule.lowerInflectionPoint.type)&&rule.lowerInflectionPoint.type===rule.upperInflectionPoint.type&&Number(minValue)>Number(maxValue)){return"LowerBiggerThanUpper";}
return"Success";}
checkMinBiggerThanMax(rule){const minValue=rule.minimum.value;const maxValue=rule.maximum.value;if(["number","percentage","percentile"].includes(rule.minimum.type)&&rule.minimum.type===rule.maximum.type&&stringToNumber(minValue)>=stringToNumber(maxValue)){return"MinBiggerThanMax";}
return"Success";}
checkMidBiggerThanMax(rule){const midValue=rule.midpoint?.value;const maxValue=rule.maximum.value;if(rule.midpoint&&["number","percentage","percentile"].includes(rule.midpoint.type)&&rule.midpoint.type===rule.maximum.type&&stringToNumber(midValue)>=stringToNumber(maxValue)){return"MidBiggerThanMax";}
return"Success";}
checkMinBiggerThanMid(rule){const minValue=rule.minimum.value;const midValue=rule.midpoint?.value;if(rule.midpoint&&["number","percentage","percentile"].includes(rule.midpoint.type)&&rule.minimum.type===rule.midpoint.type&&stringToNumber(minValue)>=stringToNumber(midValue)){return"MinBiggerThanMid";}
return"Success";}
removeConditionalFormatting(id,sheet){const cfIndex=this.cfRules[sheet].findIndex((s)=>s.id===id);if(cfIndex!==-1){const currentCF=this.cfRules[sheet].slice();currentCF.splice(cfIndex,1);this.history.update("cfRules",sheet,currentCF);}}
changeCFPriority(cfId,delta,sheetId){const currentIndex=this.cfRules[sheetId].findIndex((s)=>s.id===cfId);const cf=this.cfRules[sheetId][currentIndex];const targetIndex=currentIndex-delta;const cfRules=[...this.cfRules[sheetId]];cfRules.splice(currentIndex,1);cfRules.splice(targetIndex,0,cf);this.history.update("cfRules",sheetId,cfRules);}}
class DataValidationPlugin extends CorePlugin{static getters=["cellHasListDataValidationIcon","getDataValidationRule","getDataValidationRules","getValidationRuleForCell",];rules={};adaptRanges(applyChange,sheetId){const sheetIds=sheetId?[sheetId]:Object.keys(this.rules);for(const sheetId of sheetIds){this.loopThroughRangesOfSheet(sheetId,applyChange);}}
loopThroughRangesOfSheet(sheetId,applyChange){const rules=this.rules[sheetId];for(let ruleIndex=rules.length-1;ruleIndex>=0;ruleIndex--){const rule=this.rules[sheetId][ruleIndex];for(let rangeIndex=rule.ranges.length-1;rangeIndex>=0;rangeIndex--){const range=rule.ranges[rangeIndex];const change=applyChange(range);switch(change.changeType){case"REMOVE":if(rule.ranges.length===1){this.removeDataValidationRule(sheetId,rule.id);}
else{const copy=rule.ranges.slice();copy.splice(rangeIndex,1);this.history.update("rules",sheetId,ruleIndex,"ranges",copy);}
break;case"RESIZE":case"MOVE":case"CHANGE":this.history.update("rules",sheetId,ruleIndex,"ranges",rangeIndex,change.range);break;}}}}
allowDispatch(cmd){switch(cmd.type){case"ADD_DATA_VALIDATION_RULE":return this.checkValidations(cmd,this.chainValidations(this.checkCriterionTypeIsValid,this.checkCriterionHasValidNumberOfValues,this.checkCriterionValuesAreValid));case"REMOVE_DATA_VALIDATION_RULE":if(!this.rules[cmd.sheetId].find((rule)=>rule.id===cmd.id)){return"UnknownDataValidationRule";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("rules",cmd.sheetId,[]);break;case"DUPLICATE_SHEET":{const rules=deepCopy(this.rules[cmd.sheetId]).map((rule)=>({...rule,ranges:rule.ranges.map((range)=>copyRangeWithNewSheetId(cmd.sheetId,cmd.sheetIdTo,range)),}));this.history.update("rules",cmd.sheetIdTo,rules);break;}
case"DELETE_SHEET":{const rules={...this.rules};delete rules[cmd.sheetId];this.history.update("rules",rules);break;}
case"REMOVE_DATA_VALIDATION_RULE":{this.removeDataValidationRule(cmd.sheetId,cmd.id);break;}
case"ADD_DATA_VALIDATION_RULE":{const ranges=cmd.ranges.map((range)=>this.getters.getRangeFromRangeData(range));this.addDataValidationRule(cmd.sheetId,{...cmd.rule,ranges});break;}}}
getDataValidationRules(sheetId){return this.rules[sheetId];}
getDataValidationRule(sheetId,id){return this.rules[sheetId].find((rule)=>rule.id===id);}
getValidationRuleForCell({sheetId,col,row}){if(!this.rules[sheetId]){return undefined;}
for(const rule of this.rules[sheetId]){for(const range of rule.ranges){if(isInside(col,row,range.zone)){return rule;}}}
return undefined;}
cellHasListDataValidationIcon(cellPosition){const rule=this.getValidationRuleForCell(cellPosition);if(!rule)
return false;return((rule.criterion.type==="isValueInList"||rule.criterion.type==="isValueInRange")&&rule.criterion.displayStyle==="arrow");}
addDataValidationRule(sheetId,newRule){const rules=this.rules[sheetId];if(newRule.criterion.type==="isBoolean"){this.setCenterStyleToBooleanCells(newRule);}
else if(newRule.criterion.type==="isValueInList"){newRule.criterion.values=Array.from(new Set(newRule.criterion.values));}
const adaptedRules=this.removeRangesFromRules(sheetId,newRule.ranges,rules);const ruleIndex=adaptedRules.findIndex((rule)=>rule.id===newRule.id);if(ruleIndex!==-1){adaptedRules[ruleIndex]=newRule;this.history.update("rules",sheetId,adaptedRules);}
else{this.history.update("rules",sheetId,[...adaptedRules,newRule]);}}
removeRangesFromRules(sheetId,ranges,rules){rules=deepCopy(rules);const rangesXcs=ranges.map((range)=>this.getters.getRangeString(range,sheetId));for(const rule of rules){const ruleRanges=rule.ranges.map((range)=>this.getters.getRangeString(range,sheetId));rule.ranges=recomputeZones(ruleRanges,rangesXcs).map((xc)=>this.getters.getRangeFromSheetXC(sheetId,xc));}
return rules.filter((rule)=>rule.ranges.length>0);}
removeDataValidationRule(sheetId,ruleId){const rules=this.rules[sheetId];const newRules=rules.filter((rule)=>rule.id!==ruleId);this.history.update("rules",sheetId,newRules);}
setCenterStyleToBooleanCells(rule){for(const position of getCellPositionsInRanges(rule.ranges)){const cell=this.getters.getCell(position);const{sheetId,col,row}=position;const style={...cell?.style,align:cell?.style?.align??"center",verticalAlign:cell?.style?.verticalAlign??"middle",};this.dispatch("UPDATE_CELL",{sheetId,col,row,style});}}
import(data){for(const sheet of data.sheets){this.rules[sheet.id]=[];if(!sheet.dataValidationRules){continue;}
for(const rule of sheet.dataValidationRules){this.rules[sheet.id].push({...rule,ranges:rule.ranges.map((range)=>this.getters.getRangeFromSheetXC(sheet.id,range)),});}}}
export(data){if(!data.sheets){return;}
for(const sheet of data.sheets){sheet.dataValidationRules=[];for(const rule of this.rules[sheet.id]){sheet.dataValidationRules.push({...rule,ranges:rule.ranges.map((range)=>this.getters.getRangeString(range,sheet.id)),});}}}
checkCriterionTypeIsValid(cmd){return dataValidationEvaluatorRegistry.contains(cmd.rule.criterion.type)?"Success":"UnknownDataValidationCriterionType";}
checkCriterionHasValidNumberOfValues(cmd){const criterion=cmd.rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);const expectedNumberOfValues=evaluator.numberOfValues(criterion);if(expectedNumberOfValues!==undefined&&criterion.values.length!==expectedNumberOfValues){return"InvalidNumberOfCriterionValues";}
return"Success";}
checkCriterionValuesAreValid(cmd){const criterion=cmd.rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);if(criterion.values.some((value)=>{if(value.startsWith("=")){return evaluator.allowedValues==="onlyLiterals";}
else if(evaluator.allowedValues==="onlyFormulas"){return true;}
else{return!evaluator.isCriterionValueValid(value);}})){return"InvalidDataValidationCriterionValue";}
return"Success";}}
class FigurePlugin extends CorePlugin{static getters=["getFigures","getFigure","getFigureSheetId"];figures={};allowDispatch(cmd){switch(cmd.type){case"CREATE_FIGURE":return this.checkFigureDuplicate(cmd.figure.id);case"UPDATE_FIGURE":case"DELETE_FIGURE":return this.checkFigureExists(cmd.sheetId,cmd.id);default:return"Success";}}
beforeHandle(cmd){switch(cmd.type){case"DELETE_SHEET":this.getters.getFigures(cmd.sheetId).forEach((figure)=>{this.dispatch("DELETE_FIGURE",{id:figure.id,sheetId:cmd.sheetId});});break;}}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.figures[cmd.sheetId]={};break;case"DELETE_SHEET":this.deleteSheet(cmd.sheetId);break;case"CREATE_FIGURE":this.addFigure(cmd.figure,cmd.sheetId);break;case"UPDATE_FIGURE":const{type,sheetId,...update}=cmd;const figure=update;this.updateFigure(sheetId,figure);break;case"DELETE_FIGURE":this.removeFigure(cmd.id,cmd.sheetId);break;case"REMOVE_COLUMNS_ROWS":this.onRowColDelete(cmd.sheetId,cmd.dimension);}}
onRowColDelete(sheetId,dimension){dimension==="ROW"?this.onRowDeletion(sheetId):this.onColDeletion(sheetId);}
onRowDeletion(sheetId){const numHeader=this.getters.getNumberRows(sheetId);let gridHeight=0;for(let i=0;i<numHeader;i++){gridHeight+=this.getters.getUserRowSize(sheetId,i)||DEFAULT_CELL_HEIGHT;}
const figures=this.getters.getFigures(sheetId);for(const figure of figures){const newY=Math.min(figure.y,gridHeight-figure.height);if(newY!==figure.y){this.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,y:newY});}}}
onColDeletion(sheetId){const numHeader=this.getters.getNumberCols(sheetId);let gridWidth=0;for(let i=0;i<numHeader;i++){gridWidth+=this.getters.getColSize(sheetId,i);}
const figures=this.getters.getFigures(sheetId);for(const figure of figures){const newX=Math.min(figure.x,gridWidth-figure.width);if(newX!==figure.x){this.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,x:newX});}}}
updateFigure(sheetId,figure){if(!("id"in figure)){return;}
for(const[key,value]of Object.entries(figure)){switch(key){case"x":case"y":if(value!==undefined){this.history.update("figures",sheetId,figure.id,key,Math.max(value,0));}
break;case"width":case"height":if(value!==undefined){this.history.update("figures",sheetId,figure.id,key,value);}
break;}}}
addFigure(figure,sheetId){this.history.update("figures",sheetId,figure.id,figure);}
deleteSheet(sheetId){this.history.update("figures",sheetId,undefined);}
removeFigure(id,sheetId){this.history.update("figures",sheetId,id,undefined);}
checkFigureExists(sheetId,figureId){if(this.figures[sheetId]?.[figureId]===undefined){return"FigureDoesNotExist";}
return"Success";}
checkFigureDuplicate(figureId){if(Object.values(this.figures).find((sheet)=>sheet?.[figureId])){return"DuplicatedFigureId";}
return"Success";}
getFigures(sheetId){return Object.values(this.figures[sheetId]||{}).filter(isDefined$1);}
getFigure(sheetId,figureId){return this.figures[sheetId]?.[figureId];}
getFigureSheetId(figureId){return Object.keys(this.figures).find((sheetId)=>this.figures[sheetId]?.[figureId]!==undefined);}
import(data){for(let sheet of data.sheets){const figures={};sheet.figures.forEach((figure)=>{figures[figure.id]=figure;});this.figures[sheet.id]=figures;}}
export(data){for(const sheet of data.sheets){for(const figure of this.getFigures(sheet.id)){const data=undefined;sheet.figures.push({...figure,data});}}}
exportForExcel(data){this.export(data);}}
class FilterTable{id;zone;filters;constructor(zone){this.filters=[];this.zone=zone;const uuid=new UuidGenerator();this.id=uuid.uuidv4();for(const i of range(zone.left,zone.right+1)){const filterZone={...this.zone,left:i,right:i};this.filters.push(new Filter(uuid.uuidv4(),filterZone));}}
get contentZone(){if(this.zone.bottom===this.zone.top){return undefined;}
return{...this.zone,top:this.zone.top+1};}
getFilterId(col){return this.filters.find((filter)=>filter.col===col)?.id;}
clone(){return new FilterTable(this.zone);}}
class Filter{id;zoneWithHeaders;constructor(id,zone){if(zone.left!==zone.right){throw new Error("Can only define a filter on a single column");}
this.id=id;this.zoneWithHeaders=zone;}
get col(){return this.zoneWithHeaders.left;}
get filteredZone(){const zone=this.zoneWithHeaders;if(zone.bottom===zone.top){return undefined;}
return{...zone,top:zone.top+1};}}
class FiltersPlugin extends CorePlugin{static getters=["doesZonesContainFilter","getFilter","getFilters","getFilterTable","getFilterTables","getFilterTablesInZone","getFilterId","getFilterHeaders","isFilterHeader",];tables={};allowDispatch(cmd){switch(cmd.type){case"CREATE_FILTER_TABLE":if(!areZonesContinuous(...cmd.target)){return"NonContinuousTargets";}
const zone=union(...cmd.target);const checkFilterOverlap=()=>{if(this.getFilterTables(cmd.sheetId).some((filter)=>overlap(filter.zone,zone))){return"FilterOverlap";}
return"Success";};const checkMergeInFilter=()=>{const mergesInTarget=this.getters.getMergesInZone(cmd.sheetId,zone);for(let merge of mergesInTarget){if(overlap(zone,merge)){return"MergeInFilter";}}
return"Success";};return this.checkValidations(cmd,checkFilterOverlap,checkMergeInFilter);case"ADD_MERGE":for(let merge of cmd.target){for(let filterTable of this.getFilterTables(cmd.sheetId)){if(overlap(filterTable.zone,merge)){return"MergeInFilter";}}}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("tables",cmd.sheetId,{});break;case"DELETE_SHEET":const filterTables={...this.tables};delete filterTables[cmd.sheetId];this.history.update("tables",filterTables);break;case"DUPLICATE_SHEET":const tables={};for(const filterTable of Object.values(this.tables[cmd.sheetId]||{})){if(filterTable){const newFilterTable=deepCopy(filterTable);tables[newFilterTable.id]=newFilterTable;}}
this.history.update("tables",cmd.sheetIdTo,tables);break;case"ADD_COLUMNS_ROWS":this.onAddColumnsRows(cmd);break;case"REMOVE_COLUMNS_ROWS":this.onDeleteColumnsRows(cmd);break;case"CREATE_FILTER_TABLE":{const zone=union(...cmd.target);const newFilterTable=this.createFilterTable(zone);this.history.update("tables",cmd.sheetId,newFilterTable.id,newFilterTable);break;}
case"REMOVE_FILTER_TABLE":{const tables={};for(const filterTable of this.getFilterTables(cmd.sheetId)){if(cmd.target.every((zone)=>!intersection(zone,filterTable.zone))){tables[filterTable.id]=filterTable;}}
this.history.update("tables",cmd.sheetId,tables);break;}
case"UPDATE_CELL":{const sheetId=cmd.sheetId;for(let table of this.getFilterTables(sheetId)){if(this.canUpdateCellCmdExtendTable(cmd,table)){this.extendTableDown(sheetId,table);}}
break;}}}
getFilters(sheetId){return this.getFilterTables(sheetId).map((filterTable)=>filterTable.filters).flat();}
getFilterTables(sheetId){return this.tables[sheetId]?Object.values(this.tables[sheetId]).filter(isDefined$1):[];}
getFilter(position){return this.getFilterTable(position)?.filters.find((filter)=>filter.col===position.col);}
getFilterId(position){return this.getFilter(position)?.id;}
getFilterTable({sheetId,col,row}){return this.getFilterTables(sheetId).find((filterTable)=>isInside(col,row,filterTable.zone));}
getFilterTablesInZone(sheetId,zone){return this.getFilterTables(sheetId).filter((filterTable)=>isZoneInside(filterTable.zone,zone));}
doesZonesContainFilter(sheetId,zones){for(const zone of zones){for(const filterTable of this.getFilterTables(sheetId)){if(intersection(zone,filterTable.zone)){return true;}}}
return false;}
getFilterHeaders(sheetId){const headers=[];for(let filterTable of this.getFilterTables(sheetId)){const zone=filterTable.zone;const row=zone.top;for(let col=zone.left;col<=zone.right;col++){headers.push({col,row});}}
return headers;}
isFilterHeader({sheetId,col,row}){const headers=this.getFilterHeaders(sheetId);return headers.some((header)=>header.col===col&&header.row===row);}
onAddColumnsRows(cmd){for(const filterTable of this.getFilterTables(cmd.sheetId)){const zone=expandZoneOnInsertion(filterTable.zone,cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);const filters=[];for(const filter of filterTable.filters){const filterZone=expandZoneOnInsertion(filter.zoneWithHeaders,cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);filters.push(new Filter(filter.id,filterZone));}
if(filters.length<zoneToDimension(zone).numberOfCols){for(let col=zone.left;col<=zone.right;col++){if(!filters.find((filter)=>filter.col===col)){filters.push(new Filter(this.uuidGenerator.uuidv4(),{...zone,left:col,right:col}));}}
filters.sort((f1,f2)=>f1.col-f2.col);}
this.history.update("tables",cmd.sheetId,filterTable.id,"zone",zone);this.history.update("tables",cmd.sheetId,filterTable.id,"filters",filters);}}
onDeleteColumnsRows(cmd){for(const table of this.getFilterTables(cmd.sheetId)){if(cmd.dimension==="ROW"&&cmd.elements.includes(table.zone.top)){const tables={...this.tables[cmd.sheetId]};delete tables[table.id];this.history.update("tables",cmd.sheetId,tables);continue;}
const zone=reduceZoneOnDeletion(table.zone,cmd.dimension==="COL"?"left":"top",cmd.elements);if(!zone){const tables={...this.tables[cmd.sheetId]};delete tables[table.id];this.history.update("tables",cmd.sheetId,tables);}
else{if(zoneToXc(zone)!==zoneToXc(table.zone)){const filters=[];for(const filter of table.filters){const newFilterZone=reduceZoneOnDeletion(filter.zoneWithHeaders,cmd.dimension==="COL"?"left":"top",cmd.elements);if(newFilterZone){filters.push(new Filter(filter.id,newFilterZone));}}
this.history.update("tables",cmd.sheetId,table.id,"zone",zone);this.history.update("tables",cmd.sheetId,table.id,"filters",filters);}}}}
createFilterTable(zone){return new FilterTable(zone);}
extendTableDown(sheetId,table){const newZone={...table.zone,bottom:table.zone.bottom+1};this.history.update("tables",sheetId,table.id,"zone",newZone);for(let filterIndex=0;filterIndex<table.filters.length;filterIndex++){const filter=table.filters[filterIndex];const newFilterZone={...filter.zoneWithHeaders,bottom:filter.zoneWithHeaders.bottom+1,};this.history.update("tables",sheetId,table.id,"filters",filterIndex,"zoneWithHeaders",newFilterZone);}
return;}
canUpdateCellCmdExtendTable({content:newCellContent,sheetId,col,row},table){if(!newCellContent){return;}
const zone=table.zone;if(!(zone.bottom+1===row&&col>=zone.left&&col<=zone.right)){return false;}
for(const col of range(zone.left,zone.right+1)){const position={sheetId,col,row};const cellContent=this.getters.getCell(position)?.content;if(cellContent){return false;}
if(this.getters.getFilter(position)){return false;}
if(this.getters.isInMerge(position)){return false;}}
return true;}
import(data){for(const sheet of data.sheets){for(const filterTableData of sheet.filterTables||[]){const table=this.createFilterTable(toZone(filterTableData.range));this.history.update("tables",sheet.id,table.id,table);}}}
export(data){for(const sheet of data.sheets){for(const filterTable of this.getFilterTables(sheet.id)){sheet.filterTables.push({range:zoneToXc(filterTable.zone),});}}}
exportForExcel(data){for(const sheet of data.sheets){for(const filterTable of this.getFilterTables(sheet.id)){if(zoneToDimension(filterTable.zone).numberOfRows===1){continue;}
sheet.filterTables.push({range:zoneToXc(filterTable.zone),filters:[],});}}}}
class HeaderSizePlugin extends CorePlugin{static getters=["getUserRowSize","getColSize"];sizes={};handle(cmd){switch(cmd.type){case"CREATE_SHEET":{this.history.update("sizes",cmd.sheetId,{COL:[],ROW:[]});break;}
case"DUPLICATE_SHEET":this.history.update("sizes",cmd.sheetIdTo,deepCopy(this.sizes[cmd.sheetId]));break;case"DELETE_SHEET":const sizes={...this.sizes};delete sizes[cmd.sheetId];this.history.update("sizes",sizes);break;case"REMOVE_COLUMNS_ROWS":{const arr=this.sizes[cmd.sheetId][cmd.dimension];const sizes=removeIndexesFromArray(arr,cmd.elements);this.history.update("sizes",cmd.sheetId,cmd.dimension,sizes);break;}
case"ADD_COLUMNS_ROWS":{let sizes=[...this.sizes[cmd.sheetId][cmd.dimension]];const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);const baseSize=sizes[cmd.base];sizes.splice(addIndex,0,...Array(cmd.quantity).fill(baseSize));this.history.update("sizes",cmd.sheetId,cmd.dimension,sizes);break;}
case"RESIZE_COLUMNS_ROWS":if(cmd.dimension==="ROW"){for(const el of cmd.elements){this.history.update("sizes",cmd.sheetId,cmd.dimension,el,cmd.size||undefined);}}
else{for(const el of cmd.elements){this.history.update("sizes",cmd.sheetId,cmd.dimension,el,cmd.size||undefined);}}
break;}
return;}
getColSize(sheetId,index){return Math.round(this.sizes[sheetId]?.["COL"][index]||DEFAULT_CELL_WIDTH);}
getUserRowSize(sheetId,index){const rowSize=this.sizes[sheetId]?.["ROW"][index];return rowSize?Math.round(rowSize):undefined;}
import(data){for(let sheet of data.sheets){const sizes={COL:Array(sheet.colNumber).fill(undefined),ROW:Array(sheet.rowNumber).fill(undefined),};for(let[rowIndex,row]of Object.entries(sheet.rows)){if(row.size){sizes["ROW"][rowIndex]=row.size;}}
for(let[colIndex,col]of Object.entries(sheet.cols)){if(col.size){sizes["COL"][colIndex]=col.size;}}
this.sizes[sheet.id]=sizes;}
return;}
exportForExcel(data){this.exportData(data,true);}
export(data){this.exportData(data);}
exportData(data,exportDefaults=false){for(let sheet of data.sheets){if(sheet.rows===undefined){sheet.rows={};}
for(const row of range(0,this.getters.getNumberRows(sheet.id))){if(exportDefaults||this.sizes[sheet.id]["ROW"][row]){sheet.rows[row]={...sheet.rows[row],size:this.getUserRowSize(sheet.id,row)??DEFAULT_CELL_HEIGHT,};}}
if(sheet.cols===undefined){sheet.cols={};}
for(let col of range(0,this.getters.getNumberCols(sheet.id))){if(exportDefaults||this.sizes[sheet.id]["COL"][col]){sheet.cols[col]={...sheet.cols[col],size:this.getColSize(sheet.id,col)};}}}}}
class HeaderVisibilityPlugin extends CorePlugin{static getters=["checkElementsIncludeAllVisibleHeaders","getHiddenColsGroups","getHiddenRowsGroups","isHeaderHiddenByUser","isRowHiddenByUser","isColHiddenByUser",];hiddenHeaders={};allowDispatch(cmd){switch(cmd.type){case"HIDE_COLUMNS_ROWS":{if(!this.getters.tryGetSheet(cmd.sheetId)){return"InvalidSheetId";}
const hiddenGroup=cmd.dimension==="COL"?this.getHiddenColsGroups(cmd.sheetId):this.getHiddenRowsGroups(cmd.sheetId);const elements=cmd.dimension==="COL"?this.getters.getNumberCols(cmd.sheetId):this.getters.getNumberRows(cmd.sheetId);const hiddenElements=new Set((hiddenGroup||[]).flat().concat(cmd.elements));if(hiddenElements.size>=elements){return"TooManyHiddenElements";}
else if(largeMin(cmd.elements)<0||largeMax(cmd.elements)>elements){return"InvalidHeaderIndex";}
else{return"Success";}}
case"REMOVE_COLUMNS_ROWS":if(!this.getters.tryGetSheet(cmd.sheetId)){return"InvalidSheetId";}
if(this.checkElementsIncludeAllVisibleHeaders(cmd.sheetId,cmd.dimension,cmd.elements)){return"NotEnoughElements";}
return"Success";}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":const hiddenHeaders={COL:Array(this.getters.getNumberCols(cmd.sheetId)).fill(false),ROW:Array(this.getters.getNumberRows(cmd.sheetId)).fill(false),};this.history.update("hiddenHeaders",cmd.sheetId,hiddenHeaders);break;case"DUPLICATE_SHEET":this.history.update("hiddenHeaders",cmd.sheetIdTo,deepCopy(this.hiddenHeaders[cmd.sheetId]));break;case"DELETE_SHEET":this.history.update("hiddenHeaders",cmd.sheetId,undefined);break;case"REMOVE_COLUMNS_ROWS":{const hiddenHeaders=[...this.hiddenHeaders[cmd.sheetId][cmd.dimension]];for(let el of[...cmd.elements].sort((a,b)=>b-a)){hiddenHeaders.splice(el,1);}
this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,hiddenHeaders);break;}
case"ADD_COLUMNS_ROWS":{const hiddenHeaders=[...this.hiddenHeaders[cmd.sheetId][cmd.dimension]];const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);hiddenHeaders.splice(addIndex,0,...Array(cmd.quantity).fill(false));this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,hiddenHeaders);break;}
case"HIDE_COLUMNS_ROWS":for(let el of cmd.elements){this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,el,true);}
break;case"UNHIDE_COLUMNS_ROWS":for(let el of cmd.elements){this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,el,false);}
break;}
return;}
checkElementsIncludeAllVisibleHeaders(sheetId,dimension,elements){const visibleHeaders=this.getAllVisibleHeaders(sheetId,dimension);return includesAll(elements,visibleHeaders);}
isHeaderHiddenByUser(sheetId,dimension,index){return dimension==="COL"?this.isColHiddenByUser(sheetId,index):this.isRowHiddenByUser(sheetId,index);}
isRowHiddenByUser(sheetId,index){return this.hiddenHeaders[sheetId].ROW[index]||this.getters.isRowFolded(sheetId,index);}
isColHiddenByUser(sheetId,index){return this.hiddenHeaders[sheetId].COL[index]||this.getters.isColFolded(sheetId,index);}
getHiddenColsGroups(sheetId){const consecutiveIndexes=[[]];const hiddenCols=this.hiddenHeaders[sheetId].COL;for(let col=0;col<hiddenCols.length;col++){const isColHidden=hiddenCols[col];if(isColHidden){consecutiveIndexes[consecutiveIndexes.length-1].push(col);}
else{if(consecutiveIndexes[consecutiveIndexes.length-1].length!==0){consecutiveIndexes.push([]);}}}
if(consecutiveIndexes[consecutiveIndexes.length-1].length===0){consecutiveIndexes.pop();}
return consecutiveIndexes;}
getHiddenRowsGroups(sheetId){const consecutiveIndexes=[[]];const hiddenCols=this.hiddenHeaders[sheetId].ROW;for(let row=0;row<hiddenCols.length;row++){const isRowHidden=hiddenCols[row];if(isRowHidden){consecutiveIndexes[consecutiveIndexes.length-1].push(row);}
else{if(consecutiveIndexes[consecutiveIndexes.length-1].length!==0){consecutiveIndexes.push([]);}}}
if(consecutiveIndexes[consecutiveIndexes.length-1].length===0){consecutiveIndexes.pop();}
return consecutiveIndexes;}
getAllVisibleHeaders(sheetId,dimension){const headers=range(0,this.getters.getNumberHeaders(sheetId,dimension));const foldedHeaders=[];this.getters.getHeaderGroups(sheetId,dimension).forEach((group)=>{if(group.isFolded){foldedHeaders.push(...range(group.start,group.end+1));}});return headers.filter((i)=>{return!this.hiddenHeaders[sheetId][dimension][i]&&!foldedHeaders.includes(i);});}
import(data){for(let sheet of data.sheets){this.hiddenHeaders[sheet.id]={COL:[],ROW:[]};for(let row=0;row<sheet.rowNumber;row++){this.hiddenHeaders[sheet.id].ROW[row]=Boolean(sheet.rows[row]?.isHidden);}
for(let col=0;col<sheet.colNumber;col++){this.hiddenHeaders[sheet.id].COL[col]=Boolean(sheet.cols[col]?.isHidden);}}
return;}
exportForExcel(data){this.exportData(data,true);}
export(data){this.exportData(data);}
exportData(data,exportDefaults=false){for(let sheet of data.sheets){if(sheet.rows===undefined){sheet.rows={};}
for(let row=0;row<this.getters.getNumberRows(sheet.id);row++){if(exportDefaults||this.hiddenHeaders[sheet.id]["ROW"][row]){if(sheet.rows[row]===undefined){sheet.rows[row]={};}
sheet.rows[row].isHidden=this.hiddenHeaders[sheet.id]["ROW"][row];}}
if(sheet.cols===undefined){sheet.cols={};}
for(let col=0;col<this.getters.getNumberCols(sheet.id);col++){if(exportDefaults||this.hiddenHeaders[sheet.id]["COL"][col]){if(sheet.cols[col]===undefined){sheet.cols[col]={};}
sheet.cols[col].isHidden=this.hiddenHeaders[sheet.id]["COL"][col];}}}}}
class ImagePlugin extends CorePlugin{static getters=["getImage","getImagePath","getImageSize"];fileStore;images={};syncedImages=new Set();constructor(config){super(config);this.fileStore=config.external.fileStore;}
allowDispatch(cmd){switch(cmd.type){case"CREATE_IMAGE":if(this.getters.getFigure(cmd.sheetId,cmd.figureId)){return"InvalidFigureId";}
return"Success";default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_IMAGE":this.addImage(cmd.figureId,cmd.sheetId,cmd.position,cmd.size);this.history.update("images",cmd.sheetId,cmd.figureId,cmd.definition);this.syncedImages.add(cmd.definition.path);break;case"DUPLICATE_SHEET":{const sheetFiguresFrom=this.getters.getFigures(cmd.sheetId);for(const fig of sheetFiguresFrom){if(fig.tag==="image"){const figureIdBase=fig.id.split(FIGURE_ID_SPLITTER).pop();const duplicatedFigureId=`${cmd.sheetIdTo}${FIGURE_ID_SPLITTER}${figureIdBase}`;const image=this.getImage(fig.id);if(image){const size={width:fig.width,height:fig.height};this.dispatch("CREATE_IMAGE",{sheetId:cmd.sheetIdTo,figureId:duplicatedFigureId,position:{x:fig.x,y:fig.y},size,definition:deepCopy(image),});}}}
break;}
case"DELETE_FIGURE":this.history.update("images",cmd.sheetId,cmd.id,undefined);break;case"DELETE_SHEET":this.history.update("images",cmd.sheetId,undefined);break;}}
garbageCollectExternalResources(){const images=new Set(this.getAllImages().map((image)=>image.path));for(const path of this.syncedImages){if(!images.has(path)){this.fileStore?.delete(path);}}}
getImage(figureId){for(const sheet of Object.values(this.images)){if(sheet&&sheet[figureId]){return sheet[figureId];}}
throw new Error(`There is no image with the given figureId: ${figureId}`);}
getImagePath(figureId){return this.getImage(figureId).path;}
getImageSize(figureId){return this.getImage(figureId).size;}
addImage(id,sheetId,position,size){const figure={id,x:position.x,y:position.y,width:size.width,height:size.height,tag:"image",};this.dispatch("CREATE_FIGURE",{sheetId,figure});}
import(data){for(const sheet of data.sheets){const images=(sheet.figures||[]).filter((figure)=>figure.tag==="image");for(const image of images){this.history.update("images",sheet.id,image.id,image.data);this.syncedImages.add(image.data.path);}}}
export(data){for(const sheet of data.sheets){const images=sheet.figures.filter((figure)=>figure.tag==="image");for(const image of images){image.data=this.images[sheet.id]?.[image.id];}}}
exportForExcel(data){for(const sheet of data.sheets){if(!sheet.images){sheet.images=[];}
const figures=this.getters.getFigures(sheet.id);const images=[];for(const figure of figures){if(figure?.tag==="image"){const image=this.getImage(figure.id);if(image){images.push({...figure,data:deepCopy(image),});}}}
sheet.images=[...sheet.images,...images];}}
getAllImages(){const images=[];for(const sheetId in this.images){images.push(...Object.values(this.images[sheetId]||{}).filter(isDefined$1));}
return images;}}
class MergePlugin extends CorePlugin{static getters=["isInMerge","isInSameMerge","isMergeHidden","getMainCellPosition","getBottomLeftCell","expandZone","doesIntersectMerge","doesColumnsHaveCommonMerges","doesRowsHaveCommonMerges","getMerges","getMerge","getMergesInZone","isSingleCellOrMerge","getSelectionRangeString","isMainCellPosition",];nextId=1;merges={};mergeCellMap={};allowDispatch(cmd){const force="force"in cmd?!!cmd.force:false;switch(cmd.type){case"ADD_MERGE":if(force){return this.checkValidations(cmd,this.checkFrozenPanes);}
return this.checkValidations(cmd,this.checkDestructiveMerge,this.checkOverlap,this.checkFrozenPanes);case"UPDATE_CELL":return this.checkMergedContentUpdate(cmd);case"REMOVE_MERGE":return this.checkMergeExists(cmd);default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("merges",cmd.sheetId,{});this.history.update("mergeCellMap",cmd.sheetId,{});break;case"DELETE_SHEET":this.history.update("merges",cmd.sheetId,{});this.history.update("mergeCellMap",cmd.sheetId,{});break;case"DUPLICATE_SHEET":const merges=this.merges[cmd.sheetId];if(!merges)
break;for(const range of Object.values(merges).filter(isDefined$1)){this.addMerge(cmd.sheetIdTo,range.zone);}
break;case"ADD_MERGE":for(const zone of cmd.target){this.addMerge(cmd.sheetId,zone);}
break;case"REMOVE_MERGE":for(const zone of cmd.target){this.removeMerge(cmd.sheetId,zone);}
break;}}
adaptRanges(applyChange,sheetId){const sheetIds=sheetId?[sheetId]:Object.keys(this.merges);for(const sheetId of sheetIds){this.applyRangeChangeOnSheet(sheetId,applyChange);}}
getMerges(sheetId){return Object.keys(this.merges[sheetId]||{}).map((mergeId)=>this.getMergeById(sheetId,parseInt(mergeId,10))).filter(isDefined$1);}
getMerge({sheetId,col,row}){const sheetMap=this.mergeCellMap[sheetId];const mergeId=sheetMap?col in sheetMap&&sheetMap[col]?.[row]:undefined;return mergeId?this.getMergeById(sheetId,mergeId):undefined;}
getMergesInZone(sheetId,zone){const sheetMap=this.mergeCellMap[sheetId];if(!sheetMap)
return[];const mergeIds=new Set();for(const{col,row}of positions(zone)){const mergeId=sheetMap[col]?.[row];if(mergeId){mergeIds.add(mergeId);}}
return Array.from(mergeIds).map((mergeId)=>this.getMergeById(sheetId,mergeId)).filter(isDefined$1);}
getSelectionRangeString(range,forSheetId){const rangeImpl=RangeImpl.fromRange(range,this.getters);const expandedZone=this.getters.expandZone(rangeImpl.sheetId,rangeImpl.zone);const expandedRange=rangeImpl.clone({zone:{...expandedZone,bottom:rangeImpl.isFullCol?undefined:expandedZone.bottom,right:rangeImpl.isFullRow?undefined:expandedZone.right,},});const rangeString=this.getters.getRangeString(expandedRange,forSheetId);if(this.isSingleCellOrMerge(rangeImpl.sheetId,rangeImpl.zone)){const{sheetName,xc}=splitReference(rangeString);return`${sheetName !== undefined ? getCanonicalSheetName(sheetName) + "!" : ""}${xc.split(":")[0]}`;}
return rangeString;}
doesIntersectMerge(sheetId,zone){return positions(zone).some(({col,row})=>this.getMerge({sheetId,col,row})!==undefined);}
doesColumnsHaveCommonMerges(sheetId,colA,colB){const sheet=this.getters.getSheet(sheetId);for(let row=0;row<this.getters.getNumberRows(sheetId);row++){if(this.isInSameMerge(sheet.id,colA,row,colB,row)){return true;}}
return false;}
doesRowsHaveCommonMerges(sheetId,rowA,rowB){const sheet=this.getters.getSheet(sheetId);for(let col=0;col<=this.getters.getNumberCols(sheetId);col++){if(this.isInSameMerge(sheet.id,col,rowA,col,rowB)){return true;}}
return false;}
expandZone(sheetId,zone){let{left,right,top,bottom}=zone;let result={left,right,top,bottom};for(let id in this.merges[sheetId]){const merge=this.getMergeById(sheetId,parseInt(id));if(merge&&overlap(merge,result)){result=union(merge,result);}}
return isEqual(result,zone)?result:this.expandZone(sheetId,result);}
isInSameMerge(sheetId,colA,rowA,colB,rowB){const mergeA=this.getMerge({sheetId,col:colA,row:rowA});const mergeB=this.getMerge({sheetId,col:colB,row:rowB});if(!mergeA||!mergeB){return false;}
return isEqual(mergeA,mergeB);}
isInMerge({sheetId,col,row}){const sheetMap=this.mergeCellMap[sheetId];return sheetMap?col in sheetMap&&Boolean(sheetMap[col]?.[row]):false;}
getMainCellPosition(position){if(!this.isInMerge(position)){return position;}
const mergeTopLeftPos=this.getMerge(position).topLeft;return{sheetId:position.sheetId,col:mergeTopLeftPos.col,row:mergeTopLeftPos.row};}
getBottomLeftCell(position){if(!this.isInMerge(position)){return position;}
const{bottom,left}=this.getMerge(position);return{sheetId:position.sheetId,col:left,row:bottom};}
isMergeHidden(sheetId,merge){const hiddenColsGroups=this.getters.getHiddenColsGroups(sheetId);const hiddenRowsGroups=this.getters.getHiddenRowsGroups(sheetId);for(let group of hiddenColsGroups){if(merge.left>=group[0]&&merge.right<=group[group.length-1]){return true;}}
for(let group of hiddenRowsGroups){if(merge.top>=group[0]&&merge.bottom<=group[group.length-1]){return true;}}
return false;}
isSingleCellOrMerge(sheetId,zone){const merge=this.getMerge({sheetId,col:zone.left,row:zone.top});if(merge){return isEqual(zone,merge);}
const{numberOfCols,numberOfRows}=zoneToDimension(zone);return numberOfCols===1&&numberOfRows===1;}
isMainCellPosition(position){return deepEquals(this.getMainCellPosition(position),position);}
isMergeDestructive(sheetId,zone){let{left,right,top,bottom}=zone;right=clip(right,0,this.getters.getNumberCols(sheetId)-1);bottom=clip(bottom,0,this.getters.getNumberRows(sheetId)-1);for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){if(col!==left||row!==top){const cell=this.getters.getCell({sheetId,col,row});if(cell&&cell.content!==""){return true;}}}}
return false;}
getMergeById(sheetId,mergeId){const range=this.merges[sheetId]?.[mergeId];return range!==undefined?rangeToMerge(mergeId,range):undefined;}
checkDestructiveMerge({sheetId,target}){const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"Success";const isDestructive=target.some((zone)=>this.isMergeDestructive(sheetId,zone));return isDestructive?"MergeIsDestructive":"Success";}
checkOverlap({target}){for(const zone of target){for(const zone2 of target){if(zone!==zone2&&overlap(zone,zone2)){return"MergeOverlap";}}}
return"Success";}
checkFrozenPanes({sheetId,target}){const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"Success";const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);for(const zone of target){if((zone.left<xSplit&&zone.right>=xSplit)||(zone.top<ySplit&&zone.bottom>=ySplit)){return"FrozenPaneOverlap";}}
return"Success";}
checkMergedContentUpdate(cmd){const{col,row,content}=cmd;if(content===undefined){return"Success";}
const{col:mainCol,row:mainRow}=this.getMainCellPosition(cmd);if(mainCol===col&&mainRow===row){return"Success";}
return"CellIsMerged";}
checkMergeExists(cmd){const{sheetId,target}=cmd;for(const zone of target){const{left,top}=zone;const merge=this.getMerge({sheetId,col:left,row:top});if(merge===undefined||!isEqual(zone,merge)){return"InvalidTarget";}}
return"Success";}
addMerge(sheetId,zone){let{left,right,top,bottom}=zone;right=clip(right,0,this.getters.getNumberCols(sheetId)-1);bottom=clip(bottom,0,this.getters.getNumberRows(sheetId)-1);const tl=toXC(left,top);const br=toXC(right,bottom);if(tl===br){return;}
const topLeft=this.getters.getCell({sheetId,col:left,row:top});let id=this.nextId++;this.history.update("merges",sheetId,id,this.getters.getRangeFromSheetXC(sheetId,zoneToXc({left,top,right,bottom})));let previousMerges=new Set();for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){if(col!==left||row!==top){this.dispatch("UPDATE_CELL",{sheetId,col,row,style:topLeft?topLeft.style:null,content:"",});}
const merge=this.getMerge({sheetId,col,row});if(merge){previousMerges.add(merge.id);}
this.history.update("mergeCellMap",sheetId,col,row,id);}}
for(let mergeId of previousMerges){const{top,bottom,left,right}=this.getMergeById(sheetId,mergeId);for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){const position={sheetId,col,row};const merge=this.getMerge(position);if(!merge||merge.id!==id){this.history.update("mergeCellMap",sheetId,col,row,undefined);this.dispatch("CLEAR_CELL",position);}}}
this.history.update("merges",sheetId,mergeId,undefined);}}
removeMerge(sheetId,zone){const{left,top,bottom,right}=zone;const merge=this.getMerge({sheetId,col:left,row:top});if(merge===undefined||!isEqual(zone,merge)){return;}
this.history.update("merges",sheetId,merge.id,undefined);for(let r=top;r<=bottom;r++){for(let c=left;c<=right;c++){this.history.update("mergeCellMap",sheetId,c,r,undefined);}}}
applyRangeChangeOnSheet(sheetId,applyChange){const merges=Object.entries(this.merges[sheetId]||{});for(const[mergeId,range]of merges){if(range){const currentZone=range.zone;const result=applyChange(range);switch(result.changeType){case"NONE":break;case"REMOVE":this.removeMerge(sheetId,currentZone);break;default:const{numberOfCols,numberOfRows}=zoneToDimension(result.range.zone);if(numberOfCols===1&&numberOfRows===1){this.removeMerge(sheetId,currentZone);}
else{this.history.update("merges",sheetId,parseInt(mergeId,10),result.range);}
break;}}}
this.history.update("mergeCellMap",sheetId,{});for(const merge of this.getMerges(sheetId)){for(const{col,row}of positions(merge)){this.history.update("mergeCellMap",sheetId,col,row,merge.id);}}}
import(data){const sheets=data.sheets||[];for(let sheetData of sheets){this.history.update("merges",sheetData.id,{});this.history.update("mergeCellMap",sheetData.id,{});if(sheetData.merges){this.importMerges(sheetData.id,sheetData.merges);}}}
importMerges(sheetId,merges){for(let merge of merges){this.addMerge(sheetId,toZone(merge));}}
export(data){for(let sheetData of data.sheets){const merges=this.merges[sheetData.id];if(merges){sheetData.merges.push(...exportMerges(merges));}}}
exportForExcel(data){this.export(data);}}
function exportMerges(merges){return Object.entries(merges).map(([mergeId,range])=>(range?rangeToMerge(parseInt(mergeId,10),range):undefined)).filter(isDefined$1).map((merge)=>toXC(merge.left,merge.top)+":"+toXC(merge.right,merge.bottom));}
function rangeToMerge(mergeId,range){return{...range.zone,topLeft:{col:range.zone.left,row:range.zone.top},id:mergeId,};}
class RangeAdapter{getters;providers=[];constructor(getters){this.getters=getters;}
static getters=["getRangeString","getRangeFromSheetXC","createAdaptedRanges","getRangeDataFromXc","getRangeDataFromZone","getRangeFromRangeData","getRangeFromZone",];allowDispatch(cmd){if(cmd.type==="MOVE_RANGES"){return cmd.target.length===1?"Success":"InvalidZones";}
return"Success";}
beforeHandle(command){}
handle(cmd){switch(cmd.type){case"REMOVE_COLUMNS_ROWS":{let start=cmd.dimension==="COL"?"left":"top";let end=cmd.dimension==="COL"?"right":"bottom";let dimension=cmd.dimension==="COL"?"columns":"rows";const elements=[...cmd.elements];elements.sort((a,b)=>b-a);const groups=groupConsecutive(elements);this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
let newRange=range;let changeType="NONE";for(let group of groups){const min=largeMin(group);const max=largeMax(group);if(range.zone[start]<=min&&min<=range.zone[end]){const toRemove=Math.min(range.zone[end],max)-min+1;changeType="RESIZE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-toRemove);}
else if(range.zone[start]>=min&&range.zone[end]<=max){changeType="REMOVE";newRange=range.clone({...this.getInvalidRange()});}
else if(range.zone[start]<=max&&range.zone[end]>=max){const toRemove=max-range.zone[start]+1;changeType="RESIZE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-toRemove);newRange=this.createAdaptedRange(newRange,dimension,"MOVE",-(range.zone[start]-min));}
else if(min<range.zone[start]){changeType="MOVE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-(max-min+1));}}
if(changeType!=="NONE"){return{changeType,range:newRange};}
return{changeType:"NONE"};},cmd.sheetId);break;}
case"ADD_COLUMNS_ROWS":{let start=cmd.dimension==="COL"?"left":"top";let end=cmd.dimension==="COL"?"right":"bottom";let dimension=cmd.dimension==="COL"?"columns":"rows";this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
if(cmd.position==="after"){if(range.zone[start]<=cmd.base&&cmd.base<range.zone[end]){return{changeType:"RESIZE",range:this.createAdaptedRange(range,dimension,"RESIZE",cmd.quantity),};}
if(cmd.base<range.zone[start]){return{changeType:"MOVE",range:this.createAdaptedRange(range,dimension,"MOVE",cmd.quantity),};}}
else{if(range.zone[start]<cmd.base&&cmd.base<=range.zone[end]){return{changeType:"RESIZE",range:this.createAdaptedRange(range,dimension,"RESIZE",cmd.quantity),};}
if(cmd.base<=range.zone[start]){return{changeType:"MOVE",range:this.createAdaptedRange(range,dimension,"MOVE",cmd.quantity),};}}
return{changeType:"NONE"};},cmd.sheetId);break;}
case"DELETE_SHEET":{this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
const invalidSheetName=this.getters.getSheetName(cmd.sheetId);range=range.clone({...this.getInvalidRange(),invalidSheetName,});return{changeType:"REMOVE",range};},cmd.sheetId);break;}
case"RENAME_SHEET":{this.executeOnAllRanges((range)=>{if(range.sheetId===cmd.sheetId){return{changeType:"CHANGE",range};}
if(cmd.name&&range.invalidSheetName===cmd.name){const invalidSheetName=undefined;const sheetId=cmd.sheetId;const newRange=range.clone({sheetId,invalidSheetName});return{changeType:"CHANGE",range:newRange};}
return{changeType:"NONE"};});break;}
case"MOVE_RANGES":{const originZone=cmd.target[0];this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId||!isZoneInside(range.zone,originZone)){return{changeType:"NONE"};}
const targetSheetId=cmd.targetSheetId;const offsetX=cmd.col-originZone.left;const offsetY=cmd.row-originZone.top;const adaptedRange=this.createAdaptedRange(range,"both","MOVE",[offsetX,offsetY]);const prefixSheet=cmd.sheetId===targetSheetId?adaptedRange.prefixSheet:true;return{changeType:"MOVE",range:adaptedRange.clone({sheetId:targetSheetId,prefixSheet}),};});break;}}}
finalize(){}
verifyRangeRemoved(adaptRange){return(range)=>{const result=adaptRange(range);if(result.changeType!=="NONE"&&!isZoneValid(result.range.zone)){return{range:result.range,changeType:"REMOVE"};}
return result;};}
createAdaptedRange(range,dimension,operation,by){const zone=createAdaptedZone(range.unboundedZone,dimension,operation,by);const adaptedRange=range.clone({zone});return adaptedRange;}
executeOnAllRanges(adaptRange,sheetId){const func=this.verifyRangeRemoved(adaptRange);for(const provider of this.providers){provider(func,sheetId);}}
addRangeProvider(provider){this.providers.push(provider);}
createAdaptedRanges(ranges,offsetX,offsetY,sheetId){const rangesImpl=ranges.map((range)=>RangeImpl.fromRange(range,this.getters));return rangesImpl.map((range)=>{if(!isZoneValid(range.zone)){return range;}
const copySheetId=range.prefixSheet?range.sheetId:sheetId;const unboundZone={...range.unboundedZone,left:range.isFullRow&&!range.unboundedZone.hasHeader?range.unboundedZone.left:range.unboundedZone.left+(range.parts[0].colFixed?0:offsetX),right:range.isFullRow?range.unboundedZone.right:range.unboundedZone.right+
((range.parts[1]||range.parts[0]).colFixed?0:offsetX),top:range.isFullCol&&!range.unboundedZone.hasHeader?range.unboundedZone.top:range.unboundedZone.top+(range.parts[0].rowFixed?0:offsetY),bottom:range.isFullCol?range.unboundedZone.bottom:range.unboundedZone.bottom+
((range.parts[1]||range.parts[0]).rowFixed?0:offsetY),};return range.clone({sheetId:copySheetId,zone:unboundZone}).orderZone();});}
getRangeFromSheetXC(defaultSheetId,sheetXC){if(!rangeReference.test(sheetXC)){return new RangeImpl({sheetId:"",zone:{left:-1,top:-1,right:-1,bottom:-1},parts:[],invalidXc:sheetXC,prefixSheet:false,},this.getters.getSheetSize);}
let sheetName;let xc=sheetXC;let prefixSheet=false;if(sheetXC.includes("!")){({xc,sheetName}=splitReference(sheetXC));if(sheetName){prefixSheet=true;}}
const zone=toUnboundedZone(xc);const parts=RangeImpl.getRangeParts(xc,zone);const invalidSheetName=sheetName&&!this.getters.getSheetIdByName(sheetName)?sheetName:undefined;const sheetId=this.getters.getSheetIdByName(sheetName)||defaultSheetId;const rangeInterface={prefixSheet,zone,sheetId,invalidSheetName,parts};return new RangeImpl(rangeInterface,this.getters.getSheetSize).orderZone();}
getRangeString(range,forSheetId,options={useFixedReference:false}){if(!range){return INCORRECT_RANGE_STRING;}
if(range.invalidXc){return range.invalidXc;}
if(range.zone.bottom-range.zone.top<0||range.zone.right-range.zone.left<0){return INCORRECT_RANGE_STRING;}
if(range.zone.left<0||range.zone.top<0){return INCORRECT_RANGE_STRING;}
const rangeImpl=RangeImpl.fromRange(range,this.getters);let prefixSheet=rangeImpl.sheetId!==forSheetId||rangeImpl.invalidSheetName||rangeImpl.prefixSheet;let sheetName="";if(prefixSheet){if(rangeImpl.invalidSheetName){sheetName=rangeImpl.invalidSheetName;}
else{sheetName=getCanonicalSheetName(this.getters.getSheetName(rangeImpl.sheetId));}}
if(prefixSheet&&!sheetName){return INCORRECT_RANGE_STRING;}
let rangeString=this.getRangePartString(rangeImpl,0,options);if(rangeImpl.parts&&rangeImpl.parts.length===2){if(rangeImpl.zone.top!==rangeImpl.zone.bottom||rangeImpl.zone.left!==rangeImpl.zone.right||rangeImpl.parts[0].rowFixed||rangeImpl.parts[0].colFixed||rangeImpl.parts[1].rowFixed||rangeImpl.parts[1].colFixed){rangeString+=":";rangeString+=this.getRangePartString(rangeImpl,1,options);}}
return`${prefixSheet ? sheetName + "!" : ""}${rangeString}`;}
getRangeDataFromXc(sheetId,xc){return this.getters.getRangeFromSheetXC(sheetId,xc).rangeData;}
getRangeDataFromZone(sheetId,zone){return{_sheetId:sheetId,_zone:zone};}
getRangeFromZone(sheetId,zone){return new RangeImpl({sheetId,zone,parts:[{colFixed:false,rowFixed:false},{colFixed:false,rowFixed:false},],prefixSheet:false,},this.getters.getSheetSize);}
getRangeFromRangeData(data){const rangeInterface={prefixSheet:false,zone:data._zone,sheetId:data._sheetId,invalidSheetName:undefined,parts:[{colFixed:false,rowFixed:false},{colFixed:false,rowFixed:false},],};return new RangeImpl(rangeInterface,this.getters.getSheetSize);}
getRangePartString(range,part,options={useFixedReference:false}){const colFixed=range.parts&&range.parts[part]?.colFixed?"$":"";const col=part===0?numberToLetters(range.zone.left):numberToLetters(range.zone.right);const rowFixed=range.parts&&range.parts[part]?.rowFixed?"$":"";const row=part===0?String(range.zone.top+1):String(range.zone.bottom+1);let str="";if(range.isFullCol&&!options.useFixedReference){if(part===0&&range.unboundedZone.hasHeader){str=colFixed+col+rowFixed+row;}
else{str=colFixed+col;}}
else if(range.isFullRow&&!options.useFixedReference){if(part===0&&range.unboundedZone.hasHeader){str=colFixed+col+rowFixed+row;}
else{str=rowFixed+row;}}
else{str=colFixed+col+rowFixed+row;}
return str;}
getInvalidRange(){return{parts:[],prefixSheet:false,zone:{left:-1,top:-1,right:-1,bottom:-1},sheetId:"",invalidXc:INCORRECT_RANGE_STRING,};}}
class SheetPlugin extends CorePlugin{static getters=["getSheetName","tryGetSheetName","getSheet","tryGetSheet","getSheetIdByName","getSheetIds","getVisibleSheetIds","isSheetVisible","getEvaluationSheets","doesHeaderExist","doesHeadersExist","getCell","getCellPosition","getColsZone","getRowCells","getRowsZone","getNumberCols","getNumberRows","getNumberHeaders","getGridLinesVisibility","getNextSheetName","getSheetSize","getSheetZone","getPaneDivisions","checkZonesExistInSheet","getCommandZones","getUnboundedZone","checkElementsIncludeAllNonFrozenHeaders",];sheetIdsMapName={};orderedSheetIds=[];sheets={};cellPosition={};allowDispatch(cmd){const genericChecks=this.chainValidations(this.checkSheetExists,this.checkZonesAreInSheet)(cmd);if(genericChecks!=="Success"){return genericChecks;}
switch(cmd.type){case"HIDE_SHEET":{if(this.getVisibleSheetIds().length===1){return"NotEnoughSheets";}
return"Success";}
case"CREATE_SHEET":{return this.checkValidations(cmd,this.checkSheetName,this.checkSheetPosition);}
case"MOVE_SHEET":try{const currentIndex=this.orderedSheetIds.findIndex((id)=>id===cmd.sheetId);this.findIndexOfTargetSheet(currentIndex,cmd.delta);return"Success";}
catch(e){return"WrongSheetMove";}
case"RENAME_SHEET":return this.isRenameAllowed(cmd);case"DELETE_SHEET":return this.orderedSheetIds.length>1?"Success":"NotEnoughSheets";case"ADD_COLUMNS_ROWS":if(!this.doesHeaderExist(cmd.sheetId,cmd.dimension,cmd.base)){return"InvalidHeaderIndex";}
else if(cmd.quantity<=0){return"InvalidQuantity";}
return"Success";case"REMOVE_COLUMNS_ROWS":{const min=largeMin(cmd.elements);const max=largeMax(cmd.elements);if(min<0||!this.doesHeaderExist(cmd.sheetId,cmd.dimension,max)){return"InvalidHeaderIndex";}
else if(this.checkElementsIncludeAllNonFrozenHeaders(cmd.sheetId,cmd.dimension,cmd.elements)){return"NotEnoughElements";}
else{return"Success";}}
case"FREEZE_ROWS":{return this.checkValidations(cmd,this.checkRowFreezeQuantity,this.checkRowFreezeOverlapMerge);}
case"FREEZE_COLUMNS":{return this.checkValidations(cmd,this.checkColFreezeQuantity,this.checkColFreezeOverlapMerge);}
default:return"Success";}}
handle(cmd){switch(cmd.type){case"SET_GRID_LINES_VISIBILITY":this.setGridLinesVisibility(cmd.sheetId,cmd.areGridLinesVisible);break;case"DELETE_CONTENT":this.clearZones(cmd.sheetId,cmd.target);break;case"CREATE_SHEET":const sheet=this.createSheet(cmd.sheetId,cmd.name||this.getNextSheetName(),cmd.cols||26,cmd.rows||100,cmd.position);this.history.update("sheetIdsMapName",sheet.name,sheet.id);break;case"MOVE_SHEET":this.moveSheet(cmd.sheetId,cmd.delta);break;case"RENAME_SHEET":this.renameSheet(this.sheets[cmd.sheetId],cmd.name);break;case"HIDE_SHEET":this.hideSheet(cmd.sheetId);break;case"SHOW_SHEET":this.showSheet(cmd.sheetId);break;case"DUPLICATE_SHEET":this.duplicateSheet(cmd.sheetId,cmd.sheetIdTo);break;case"DELETE_SHEET":this.deleteSheet(this.sheets[cmd.sheetId]);break;case"REMOVE_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.removeColumns(this.sheets[cmd.sheetId],[...cmd.elements]);}
else{this.removeRows(this.sheets[cmd.sheetId],[...cmd.elements]);}
break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.addColumns(this.sheets[cmd.sheetId],cmd.base,cmd.position,cmd.quantity);}
else{this.addRows(this.sheets[cmd.sheetId],cmd.base,cmd.position,cmd.quantity);}
break;case"UPDATE_CELL_POSITION":this.updateCellPosition(cmd);break;case"FREEZE_COLUMNS":this.setPaneDivisions(cmd.sheetId,cmd.quantity,"COL");break;case"FREEZE_ROWS":this.setPaneDivisions(cmd.sheetId,cmd.quantity,"ROW");break;case"UNFREEZE_ROWS":this.setPaneDivisions(cmd.sheetId,0,"ROW");break;case"UNFREEZE_COLUMNS":this.setPaneDivisions(cmd.sheetId,0,"COL");break;case"UNFREEZE_COLUMNS_ROWS":this.setPaneDivisions(cmd.sheetId,0,"COL");this.setPaneDivisions(cmd.sheetId,0,"ROW");}}
import(data){for(let sheet of data.sheets){this.sheetIdsMapName[sheet.name]=sheet.id;}
for(let sheetData of data.sheets){const name=sheetData.name||_t("Sheet")+(Object.keys(this.sheets).length+1);const{colNumber,rowNumber}=this.getImportedSheetSize(sheetData);const sheet={id:sheetData.id,name:name,numberOfCols:colNumber,rows:createDefaultRows(rowNumber),areGridLinesVisible:sheetData.areGridLinesVisible===undefined?true:sheetData.areGridLinesVisible,isVisible:sheetData.isVisible,panes:{xSplit:sheetData.panes?.xSplit||0,ySplit:sheetData.panes?.ySplit||0,},};this.orderedSheetIds.push(sheet.id);this.sheets[sheet.id]=sheet;}}
exportSheets(data){data.sheets=this.orderedSheetIds.filter(isDefined$1).map((id)=>{const sheet=this.sheets[id];const sheetData={id:sheet.id,name:sheet.name,colNumber:sheet.numberOfCols,rowNumber:this.getters.getNumberRows(sheet.id),rows:{},cols:{},merges:[],cells:{},conditionalFormats:[],figures:[],filterTables:[],areGridLinesVisible:sheet.areGridLinesVisible===undefined?true:sheet.areGridLinesVisible,isVisible:sheet.isVisible,};if(sheet.panes.xSplit||sheet.panes.ySplit){sheetData.panes=sheet.panes;}
return sheetData;});}
export(data){this.exportSheets(data);}
exportForExcel(data){this.exportSheets(data);}
getGridLinesVisibility(sheetId){return this.getSheet(sheetId).areGridLinesVisible;}
tryGetSheet(sheetId){return this.sheets[sheetId];}
getSheet(sheetId){const sheet=this.sheets[sheetId];if(!sheet){throw new Error(`Sheet ${sheetId} not found.`);}
return sheet;}
isSheetVisible(sheetId){return this.getSheet(sheetId).isVisible;}
getSheetName(sheetId){return this.getSheet(sheetId).name;}
tryGetSheetName(sheetId){return this.tryGetSheet(sheetId)?.name;}
getSheetIdByName(name){if(name){const unquotedName=getUnquotedSheetName(name);for(const key in this.sheetIdsMapName){if(key.toUpperCase()===unquotedName.toUpperCase()){return this.sheetIdsMapName[key];}}}
return undefined;}
getSheetIds(){return this.orderedSheetIds;}
getVisibleSheetIds(){return this.orderedSheetIds.filter(this.isSheetVisible.bind(this));}
getEvaluationSheets(){return this.sheets;}
doesHeaderExist(sheetId,dimension,index){return dimension==="COL"?index>=0&&index<this.getNumberCols(sheetId):index>=0&&index<this.getNumberRows(sheetId);}
doesHeadersExist(sheetId,dimension,headerIndexes){return headerIndexes.every((index)=>this.doesHeaderExist(sheetId,dimension,index));}
getRow(sheetId,index){const row=this.getSheet(sheetId).rows[index];if(!row){throw new Error(`Row ${row} not found.`);}
return row;}
getCell({sheetId,col,row}){const sheet=this.tryGetSheet(sheetId);const cellId=sheet?.rows[row]?.cells[col];if(cellId===undefined){return undefined;}
return this.getters.getCellById(cellId);}
getColsZone(sheetId,start,end){return{top:0,bottom:this.getNumberRows(sheetId)-1,left:start,right:end,};}
getRowCells(sheetId,row){return Object.values(this.getSheet(sheetId).rows[row]?.cells).filter(isDefined$1);}
getRowsZone(sheetId,start,end){return{top:start,bottom:end,left:0,right:this.getSheet(sheetId).numberOfCols-1,};}
getCellPosition(cellId){const cell=this.cellPosition[cellId];if(!cell){throw new Error(`asking for a cell position that doesn't exist, cell id: ${cellId}`);}
return cell;}
getNumberCols(sheetId){return this.getSheet(sheetId).numberOfCols;}
getNumberRows(sheetId){return this.getSheet(sheetId).rows.length;}
getNumberHeaders(sheetId,dimension){return dimension==="COL"?this.getNumberCols(sheetId):this.getNumberRows(sheetId);}
getNextSheetName(baseName="Sheet"){let i=1;const names=this.orderedSheetIds.map(this.getSheetName.bind(this));let name=`${baseName}${i}`;while(names.includes(name)){name=`${baseName}${i}`;i++;}
return name;}
getSheetSize(sheetId){return{numberOfRows:this.getNumberRows(sheetId),numberOfCols:this.getNumberCols(sheetId),};}
getSheetZone(sheetId){return{top:0,left:0,bottom:this.getNumberRows(sheetId)-1,right:this.getNumberCols(sheetId)-1,};}
getUnboundedZone(sheetId,zone){const isFullRow=zone.left===0&&zone.right===this.getNumberCols(sheetId)-1;const isFullCol=zone.top===0&&zone.bottom===this.getNumberRows(sheetId)-1;return{...zone,bottom:isFullCol?undefined:zone.bottom,right:isFullRow&&!isFullCol?undefined:zone.right,};}
getPaneDivisions(sheetId){return this.getSheet(sheetId).panes;}
setPaneDivisions(sheetId,base,dimension){const panes={...this.getPaneDivisions(sheetId)};if(dimension==="COL"){panes.xSplit=base;}
else if(dimension==="ROW"){panes.ySplit=base;}
this.history.update("sheets",sheetId,"panes",panes);}
checkElementsIncludeAllNonFrozenHeaders(sheetId,dimension,elements){const paneDivisions=this.getters.getPaneDivisions(sheetId);const startIndex=dimension==="ROW"?paneDivisions.ySplit:paneDivisions.xSplit;const endIndex=this.getters.getNumberHeaders(sheetId,dimension);if(!startIndex){return false;}
const indicesToCheck=range(startIndex,endIndex);return includesAll(elements,indicesToCheck);}
getCommandZones(cmd){const zones=[];if("zone"in cmd){zones.push(cmd.zone);}
if("target"in cmd){zones.push(...cmd.target);}
if("ranges"in cmd){zones.push(...cmd.ranges.map((rangeData)=>this.getters.getRangeFromRangeData(rangeData).zone));}
if("col"in cmd&&"row"in cmd){zones.push({top:cmd.row,left:cmd.col,bottom:cmd.row,right:cmd.col});}
return zones;}
checkZonesExistInSheet(sheetId,zones){if(!zones.every(isZoneValid))
return"InvalidRange";if(zones.length){const sheetZone=this.getSheetZone(sheetId);return zones.every((zone)=>isZoneInside(zone,sheetZone))?"Success":"TargetOutOfSheet";}
return"Success";}
updateCellPosition(cmd){const{sheetId,cellId,col,row}=cmd;if(cellId){this.setNewPosition(cellId,sheetId,col,row);}
else{this.clearPosition(sheetId,col,row);}}
setNewPosition(cellId,sheetId,col,row){const currentPosition=this.cellPosition[cellId];if(currentPosition){this.clearPosition(sheetId,currentPosition.col,currentPosition.row);}
this.history.update("cellPosition",cellId,{row:row,col:col,sheetId:sheetId,});this.history.update("sheets",sheetId,"rows",row,"cells",col,cellId);}
clearPosition(sheetId,col,row){const cellId=this.sheets[sheetId]?.rows[row].cells[col];if(cellId){this.history.update("cellPosition",cellId,undefined);this.history.update("sheets",sheetId,"rows",row,"cells",col,undefined);}}
setGridLinesVisibility(sheetId,areGridLinesVisible){this.history.update("sheets",sheetId,"areGridLinesVisible",areGridLinesVisible);}
clearZones(sheetId,zones){for(let zone of zones){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const cell=this.sheets[sheetId].rows[row].cells[col];if(cell){this.dispatch("UPDATE_CELL",{sheetId:sheetId,content:"",col,row,});}}}}}
createSheet(id,name,colNumber,rowNumber,position){const sheet={id,name,numberOfCols:colNumber,rows:createDefaultRows(rowNumber),areGridLinesVisible:true,isVisible:true,panes:{xSplit:0,ySplit:0,},};const orderedSheetIds=this.orderedSheetIds.slice();orderedSheetIds.splice(position,0,sheet.id);const sheets=this.sheets;this.history.update("orderedSheetIds",orderedSheetIds);this.history.update("sheets",Object.assign({},sheets,{[sheet.id]:sheet}));return sheet;}
moveSheet(sheetId,delta){const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.findIndex((id)=>id===sheetId);const sheet=orderedSheetIds.splice(currentIndex,1);let index=this.findIndexOfTargetSheet(currentIndex,delta);orderedSheetIds.splice(index,0,sheet[0]);this.history.update("orderedSheetIds",orderedSheetIds);}
findIndexOfTargetSheet(currentIndex,deltaIndex){while(deltaIndex!=0&&0<=currentIndex&&currentIndex<=this.orderedSheetIds.length){if(deltaIndex>0){currentIndex++;if(this.isSheetVisible(this.orderedSheetIds[currentIndex])){deltaIndex--;}}
else if(deltaIndex<0){currentIndex--;if(this.isSheetVisible(this.orderedSheetIds[currentIndex])){deltaIndex++;}}}
if(deltaIndex===0){return currentIndex;}
throw new Error(_t("There is not enough visible sheets"));}
checkSheetName(cmd){const originalSheetName=this.getters.tryGetSheetName(cmd.sheetId);if(originalSheetName!==undefined&&cmd.name===originalSheetName){return"UnchangedSheetName";}
const{orderedSheetIds,sheets}=this;const name=cmd.name&&cmd.name.trim().toLowerCase();if(orderedSheetIds.find((id)=>sheets[id]?.name.toLowerCase()===name&&id!==cmd.sheetId)){return"DuplicatedSheetName";}
if(FORBIDDEN_IN_EXCEL_REGEX.test(name)){return"ForbiddenCharactersInSheetName";}
return"Success";}
checkSheetPosition(cmd){const{orderedSheetIds}=this;if(cmd.position>orderedSheetIds.length||cmd.position<0){return"WrongSheetPosition";}
return"Success";}
checkRowFreezeQuantity(cmd){return cmd.quantity>=1&&cmd.quantity<this.getNumberRows(cmd.sheetId)?"Success":"InvalidFreezeQuantity";}
checkColFreezeQuantity(cmd){return cmd.quantity>=1&&cmd.quantity<this.getNumberCols(cmd.sheetId)?"Success":"InvalidFreezeQuantity";}
checkRowFreezeOverlapMerge(cmd){const merges=this.getters.getMerges(cmd.sheetId);for(let merge of merges){if(merge.top<cmd.quantity&&cmd.quantity<=merge.bottom){return"MergeOverlap";}}
return"Success";}
checkColFreezeOverlapMerge(cmd){const merges=this.getters.getMerges(cmd.sheetId);for(let merge of merges){if(merge.left<cmd.quantity&&cmd.quantity<=merge.right){return"MergeOverlap";}}
return"Success";}
isRenameAllowed(cmd){const name=cmd.name&&cmd.name.trim().toLowerCase();if(!name){return"MissingSheetName";}
return this.checkSheetName(cmd);}
renameSheet(sheet,name){const oldName=sheet.name;this.history.update("sheets",sheet.id,"name",name.trim());const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);delete sheetIdsMapName[oldName];sheetIdsMapName[name]=sheet.id;this.history.update("sheetIdsMapName",sheetIdsMapName);}
hideSheet(sheetId){this.history.update("sheets",sheetId,"isVisible",false);}
showSheet(sheetId){this.history.update("sheets",sheetId,"isVisible",true);}
duplicateSheet(fromId,toId){const sheet=this.getSheet(fromId);const toName=this.getDuplicateSheetName(sheet.name);const newSheet=deepCopy(sheet);newSheet.id=toId;newSheet.name=toName;for(let col=0;col<=newSheet.numberOfCols;col++){for(let row=0;row<=newSheet.rows.length;row++){if(newSheet.rows[row]){newSheet.rows[row].cells[col]=undefined;}}}
const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.indexOf(fromId);orderedSheetIds.splice(currentIndex+1,0,newSheet.id);this.history.update("orderedSheetIds",orderedSheetIds);this.history.update("sheets",Object.assign({},this.sheets,{[newSheet.id]:newSheet}));for(const cell of Object.values(this.getters.getCells(fromId))){const{col,row}=this.getCellPosition(cell.id);this.dispatch("UPDATE_CELL",{sheetId:newSheet.id,col,row,content:cell.content,format:cell.format,style:cell.style,});}
const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);sheetIdsMapName[newSheet.name]=newSheet.id;this.history.update("sheetIdsMapName",sheetIdsMapName);}
getDuplicateSheetName(sheetName){let i=1;const names=this.orderedSheetIds.map(this.getSheetName.bind(this));const baseName=_t("Copy of %s",sheetName);let name=baseName.toString();while(names.includes(name)){name=`${baseName} (${i})`;i++;}
return name;}
deleteSheet(sheet){const name=sheet.name;const sheets=Object.assign({},this.sheets);delete sheets[sheet.id];this.history.update("sheets",sheets);const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.indexOf(sheet.id);orderedSheetIds.splice(currentIndex,1);this.history.update("orderedSheetIds",orderedSheetIds);const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);delete sheetIdsMapName[name];this.history.update("sheetIdsMapName",sheetIdsMapName);}
removeColumns(sheet,columns){columns.sort((a,b)=>b-a);for(let column of columns){this.moveCellOnColumnsDeletion(sheet,column);}
const numberOfCols=this.sheets[sheet.id].numberOfCols;this.history.update("sheets",sheet.id,"numberOfCols",numberOfCols-columns.length);const count=columns.filter((col)=>col<sheet.panes.xSplit).length;if(count){this.setPaneDivisions(sheet.id,sheet.panes.xSplit-count,"COL");}}
removeRows(sheet,rows){rows.sort((a,b)=>b-a);for(let group of groupConsecutive(rows)){const from=group[group.length-1];const to=group[0];this.moveCellOnRowsDeletion(sheet,from,to);this.updateRowsStructureOnDeletion(sheet,from,to);}
const count=rows.filter((row)=>row<sheet.panes.ySplit).length;if(count){this.setPaneDivisions(sheet.id,sheet.panes.ySplit-count,"ROW");}}
addColumns(sheet,column,position,quantity){const index=position==="before"?column:column+1;this.moveCellsOnAddition(sheet,index,quantity,"columns");const numberOfCols=this.sheets[sheet.id].numberOfCols;this.history.update("sheets",sheet.id,"numberOfCols",numberOfCols+quantity);if(index<sheet.panes.xSplit){this.setPaneDivisions(sheet.id,sheet.panes.xSplit+quantity,"COL");}}
addRows(sheet,row,position,quantity){const index=position==="before"?row:row+1;this.addEmptyRows(sheet,quantity);this.moveCellsOnAddition(sheet,index,quantity,"rows");if(index<sheet.panes.ySplit){this.setPaneDivisions(sheet.id,sheet.panes.ySplit+quantity,"ROW");}}
moveCellOnColumnsDeletion(sheet,deletedColumn){for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){if(colIndex===deletedColumn){this.dispatch("CLEAR_CELL",{sheetId:sheet.id,col:colIndex,row:rowIndex,});}
if(colIndex>deletedColumn){this.dispatch("UPDATE_CELL_POSITION",{sheetId:sheet.id,cellId:cellId,col:colIndex-1,row:rowIndex,});}}}}}
moveCellsOnAddition(sheet,addedElement,quantity,dimension){const commands=[];for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];if(dimension!=="rows"||rowIndex>=addedElement){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){if(dimension==="rows"||colIndex>=addedElement){commands.push({type:"UPDATE_CELL_POSITION",sheetId:sheet.id,cellId:cellId,col:colIndex+(dimension==="columns"?quantity:0),row:rowIndex+(dimension==="rows"?quantity:0),});}}}}}
for(let cmd of commands.reverse()){this.dispatch(cmd.type,cmd);}}
moveCellOnRowsDeletion(sheet,deleteFromRow,deleteToRow){const numberRows=deleteToRow-deleteFromRow+1;for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];if(rowIndex>=deleteFromRow&&rowIndex<=deleteToRow){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){this.dispatch("CLEAR_CELL",{sheetId:sheet.id,col:colIndex,row:rowIndex,});}}}
if(rowIndex>deleteToRow){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){this.dispatch("UPDATE_CELL_POSITION",{sheetId:sheet.id,cellId:cellId,col:colIndex,row:rowIndex-numberRows,});}}}}}
updateRowsStructureOnDeletion(sheet,deleteFromRow,deleteToRow){const rows=[];const cellsQueue=sheet.rows.map((row)=>row.cells).reverse();for(let i in sheet.rows){const row=Number(i);if(row>=deleteFromRow&&row<=deleteToRow){continue;}
rows.push({cells:cellsQueue.pop(),});}
this.history.update("sheets",sheet.id,"rows",rows);}
addEmptyRows(sheet,quantity){const rows=sheet.rows.slice();for(let i=0;i<quantity;i++){rows.push({cells:{},});}
this.history.update("sheets",sheet.id,"rows",rows);}
getImportedSheetSize(data){const positions=Object.keys(data.cells).map(toCartesian);let rowNumber=data.rowNumber;let colNumber=data.colNumber;for(let{col,row}of positions){rowNumber=Math.max(rowNumber,row+1);colNumber=Math.max(colNumber,col+1);}
return{rowNumber,colNumber};}
checkSheetExists(cmd){if(cmd.type!=="CREATE_SHEET"&&"sheetId"in cmd&&this.sheets[cmd.sheetId]===undefined){return"InvalidSheetId";}
else if(cmd.type==="CREATE_SHEET"&&this.sheets[cmd.sheetId]!==undefined){return"DuplicatedSheetId";}
return"Success";}
checkZonesAreInSheet(cmd){if(!("sheetId"in cmd))
return"Success";return this.checkZonesExistInSheet(cmd.sheetId,this.getCommandZones(cmd));}}
class HeaderGroupingPlugin extends CorePlugin{static getters=["getHeaderGroups","getGroupsLayers","getVisibleGroupLayers","getHeaderGroup","getHeaderGroupsInZone","isGroupFolded","isRowFolded","isColFolded",];groups={};allowDispatch(cmd){switch(cmd.type){case"GROUP_HEADERS":{const{start,end}=cmd;if(!this.getters.doesHeadersExist(cmd.sheetId,cmd.dimension,[start,end])){return"InvalidHeaderGroupStartEnd";}
if(start>end){return"InvalidHeaderGroupStartEnd";}
if(this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,start,end)){return"HeaderGroupAlreadyExists";}
break;}
case"UNGROUP_HEADERS":{const{start,end}=cmd;if(!this.getters.doesHeadersExist(cmd.sheetId,cmd.dimension,[start,end])){return"InvalidHeaderGroupStartEnd";}
if(start>end){return"InvalidHeaderGroupStartEnd";}
break;}
case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUP":const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(!group){return"UnknownHeaderGroup";}
const numberOfHeaders=this.getters.getNumberHeaders(cmd.sheetId,cmd.dimension);const willHideAllHeaders=range(0,numberOfHeaders).every((i)=>(i>=group.start&&i<=group.end)||this.getters.isHeaderHiddenByUser(cmd.sheetId,cmd.dimension,i));if(willHideAllHeaders){return"NotEnoughElements";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("groups",cmd.sheetId,{ROW:[],COL:[]});break;case"GROUP_HEADERS":this.groupHeaders(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);break;case"UNGROUP_HEADERS":{this.unGroupHeaders(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);break;}
case"DUPLICATE_SHEET":{const groups=deepCopy(this.groups[cmd.sheetId]);this.history.update("groups",cmd.sheetIdTo,groups);break;}
case"DELETE_SHEET":{const groups={...this.groups};delete groups[cmd.sheetId];this.history.update("groups",groups);break;}
case"ADD_COLUMNS_ROWS":const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);this.moveGroupsOnHeaderInsertion(cmd.sheetId,cmd.dimension,addIndex,cmd.quantity);break;case"REMOVE_COLUMNS_ROWS":this.moveGroupsOnHeaderDeletion(cmd.sheetId,cmd.dimension,cmd.elements);break;case"UNFOLD_HEADER_GROUP":{const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(group){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_HEADER_GROUP":{const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(group){this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"UNFOLD_ALL_HEADER_GROUPS":{const groups=this.getters.getHeaderGroups(cmd.sheetId,cmd.dimension);for(const group of groups){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_ALL_HEADER_GROUPS":{const groups=this.getters.getHeaderGroups(cmd.sheetId,cmd.dimension);for(const group of groups){this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":{const action=cmd.type==="UNFOLD_HEADER_GROUPS_IN_ZONE"?"unfold":"fold";const layers=this.getGroupsLayers(cmd.sheetId,cmd.dimension);if(action==="fold"){layers.reverse();}
const groups=layers.flat();const start=cmd.dimension==="ROW"?cmd.zone.top:cmd.zone.left;const end=cmd.dimension==="ROW"?cmd.zone.bottom:cmd.zone.right;const groupsToToggle=new Set();for(let header=start;header<=end;header++){const matchedGroups=groups.filter((g)=>g.start-1<=header&&header<=g.end);for(const group of matchedGroups){if((action==="fold"&&group.isFolded)||(action==="unfold"&&!group.isFolded)){continue;}
groupsToToggle.add(group);break;}}
for(const group of groupsToToggle){if(action==="unfold"){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
else{this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}}
break;}}}
getHeaderGroups(sheetId,dim){return this.groups[sheetId][dim];}
getHeaderGroup(sheetId,dim,start,end){return this.getHeaderGroups(sheetId,dim).find((group)=>group.start===start&&group.end===end);}
getHeaderGroupsInZone(sheetId,dim,zone){return this.getHeaderGroups(sheetId,dim).filter((group)=>{const start=dim==="ROW"?zone.top:zone.left;const end=dim==="ROW"?zone.bottom:zone.right;return this.doGroupOverlap(group,start,end);});}
getGroupsLayers(sheetId,dimension){const groups=this.getHeaderGroups(sheetId,dimension);return this.bricksFallingAlgorithm(groups,0,0);}
getVisibleGroupLayers(sheetId,dimension){const layers=this.getGroupsLayers(sheetId,dimension);for(const layer of layers){for(let k=layer.length-1;k>=0;k--){const group=layer[k];if(group.start===0){continue;}
const headersInGroup=range(group.start-1,group.end+1);if(headersInGroup.every((i)=>this.getters.isHeaderHiddenByUser(sheetId,dimension,i))){layer.splice(k,1);}}}
return layers.filter((layer)=>layer.length>0);}
isGroupFolded(sheetId,dimension,start,end){return this.getHeaderGroup(sheetId,dimension,start,end)?.isFolded||false;}
isRowFolded(sheetId,row){const groups=this.getters.getHeaderGroups(sheetId,"ROW");return groups.some((group)=>group.start<=row&&row<=group.end&&group.isFolded);}
isColFolded(sheetId,col){const groups=this.getters.getHeaderGroups(sheetId,"COL");return groups.some((group)=>group.start<=col&&col<=group.end&&group.isFolded);}
getGroupId(group){return`${group.start}-${group.end}}`;}
bricksFallingAlgorithm(groups,start,end,delta=0){const isGroupFolded={};for(const group of groups){isGroupFolded[this.getGroupId(group)]=group.isFolded;}
const brickPileSize={};for(const group of groups){for(let i=group.start;i<=group.end;i++){brickPileSize[i]=brickPileSize[i]?brickPileSize[i]+1:1;}}
for(let i=start;i<=end;i++){brickPileSize[i]=brickPileSize[i]?brickPileSize[i]+delta:delta;}
const numberOfLayers=Math.max(...Object.values(brickPileSize),0);const groupLayers=Array.from({length:numberOfLayers},()=>[]);const maxHeader=Math.max(end,...groups.map((group)=>group.end));const minHeader=Math.min(start,...groups.map((group)=>group.start));for(let header=minHeader;header<=maxHeader;header++){const pileSize=brickPileSize[header]||0;for(let layer=0;layer<pileSize;layer++){const currentGroup=groupLayers[layer].at(-1);if(currentGroup&&isConsecutive([currentGroup.end,header])){currentGroup.end++;}
else{const newGroup={start:header,end:header};groupLayers[layer].push(newGroup);}}}
for(const layer of groupLayers){for(const group of layer){group.isFolded=isGroupFolded[this.getGroupId(group)];}}
return groupLayers;}
groupHeaders(sheetId,dimension,start,end){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=this.bricksFallingAlgorithm(groups,start,end,+1).flat();this.history.update("groups",sheetId,dimension,this.removeDuplicateGroups(newGroups));}
unGroupHeaders(sheetId,dimension,start,end){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=this.bricksFallingAlgorithm(groups,start,end,-1).flat();this.history.update("groups",sheetId,dimension,this.removeDuplicateGroups(newGroups));}
moveGroupsOnHeaderInsertion(sheetId,dim,index,count){const groups=this.groups[sheetId][dim];for(let i=0;i<groups.length;i++){const group=groups[i];const[start,end]=moveHeaderIndexesOnHeaderAddition(index,count,[group.start,group.end,]);if(start!==group.start||end!==group.end){this.history.update("groups",sheetId,dim,i,{...group,start,end});}}}
moveGroupsOnHeaderDeletion(sheetId,dimension,deletedElements){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=[];for(const group of groups){const headersInGroup=range(group.start,group.end+1);const headersAfterDeletion=moveHeaderIndexesOnHeaderDeletion(deletedElements,headersInGroup);if(headersAfterDeletion.length===0){continue;}
newGroups.push({...group,start:Math.min(...headersAfterDeletion),end:Math.max(...headersAfterDeletion),});}
this.history.update("groups",sheetId,dimension,this.bricksFallingAlgorithm(newGroups,0,0).flat());}
doGroupOverlap(group,start,end){return group.start<=end&&group.end>=start;}
removeDuplicateGroups(groups){const newGroups={};for(const group of groups){newGroups[this.getGroupId(group)]=group;}
return Object.values(newGroups);}
findGroupWithStartEnd(sheetId,dimension,start,end){return this.getHeaderGroups(sheetId,dimension).find((group)=>group.start===start&&group.end===end);}
foldHeaderGroup(sheetId,dim,groupToFold){const index=this.getGroupIndex(sheetId,dim,groupToFold.start,groupToFold.end);if(index===undefined){return;}
this.history.update("groups",sheetId,dim,index,"isFolded",true);const groups=this.getters.getHeaderGroups(sheetId,dim);for(let i=0;i<groups.length;i++){const group=groups[i];if(group.start===groupToFold.start&&group.end<=groupToFold.end){this.history.update("groups",sheetId,dim,i,"isFolded",true);}}}
unfoldHeaderGroup(sheetId,dim,groupToUnfold){const index=this.getGroupIndex(sheetId,dim,groupToUnfold.start,groupToUnfold.end);if(index===undefined){return;}
this.history.update("groups",sheetId,dim,index,"isFolded",false);const groups=this.getters.getHeaderGroups(sheetId,dim);for(let i=0;i<groups.length;i++){const group=groups[i];if(group.start===groupToUnfold.start&&group.end>=groupToUnfold.end){this.history.update("groups",sheetId,dim,i,"isFolded",false);}}}
getGroupIndex(sheetId,dimension,start,end){const index=this.groups[sheetId][dimension].findIndex((group)=>group.start===start&&group.end===end);return index===-1?undefined:index;}
import(data){for(const sheet of data.sheets){this.groups[sheet.id]={ROW:[],COL:[]};if(!sheet.headerGroups){continue;}
for(const dim of["ROW","COL"]){for(const groupData of sheet.headerGroups[dim]||[]){this.groups[sheet.id][dim].push({...groupData});}}}}
export(data){for(const sheet of data.sheets){sheet.headerGroups=this.groups[sheet.id];}}}
class SettingsPlugin extends CorePlugin{static getters=["getLocale"];locale=DEFAULT_LOCALE;allowDispatch(cmd){switch(cmd.type){case"UPDATE_LOCALE":return isValidLocale(cmd.locale)?"Success":"InvalidLocale";}
return"Success";}
handle(cmd){switch(cmd.type){case"UPDATE_LOCALE":const oldLocale=this.locale;const newLocale=cmd.locale;this.history.update("locale",newLocale);this.changeCellsDateFormatWithLocale(oldLocale,newLocale);break;}}
getLocale(){return this.locale;}
changeCellsDateFormatWithLocale(oldLocale,newLocale){for(const sheetId of this.getters.getSheetIds()){for(const[cellId,cell]of Object.entries(this.getters.getCells(sheetId))){let formatToApply;if(cell.format===oldLocale.dateFormat){formatToApply=newLocale.dateFormat;}
if(cell.format===oldLocale.timeFormat){formatToApply=newLocale.timeFormat;}
if(cell.format===getDateTimeFormat(oldLocale)){formatToApply=getDateTimeFormat(newLocale);}
if(formatToApply){const{col,row,sheetId}=this.getters.getCellPosition(cellId);this.dispatch("UPDATE_CELL",{col,row,sheetId,format:formatToApply,});}}}}
import(data){this.locale=data.settings?.locale??DEFAULT_LOCALE;}
export(data){data.settings={locale:this.locale,};}}
class UIPlugin extends BasePlugin{static layers=[];getters;ui;selection;constructor({getters,stateObserver,dispatch,uiActions,selection}){super(stateObserver,dispatch);this.getters=getters;this.ui=uiActions;this.selection=selection;}
drawGrid(ctx,layer){}}
const functionMap=functionRegistry.mapping;function buildCompilationParameters(context,getters,computeCell){const builder=new CompilationParametersBuilder(context,getters,computeCell);return builder.getParameters();}
class CompilationParametersBuilder{getters;computeCell;evalContext;rangeCache={};constructor(context,getters,computeCell){this.getters=getters;this.computeCell=computeCell;this.evalContext=Object.assign(Object.create(functionMap),context,{getters:this.getters,locale:this.getters.getLocale(),});}
getParameters(){return[this.refFn.bind(this),this.range.bind(this),this.evalContext];}
refFn(range,isMeta,functionName,paramNumber){this.assertRangeValid(range);if(isMeta){return{value:zoneToXc(range.zone)};}
if(range.zone.bottom!==range.zone.top||range.zone.left!==range.zone.right){throw new Error(paramNumber?_t("Function %s expects the parameter %s to be a single value or a single cell reference, not a range.",functionName.toString(),paramNumber.toString()):_t("Function %s expects its parameters to be single values or single cell references, not ranges.",functionName.toString()));}
const position={sheetId:range.sheetId,col:range.zone.left,row:range.zone.top};return this.readCell(position);}
readCell(position){if(!this.getters.tryGetSheet(position.sheetId)){throw new Error(_t("Invalid sheet name"));}
const evaluatedCell=this.getEvaluatedCellIfNotEmpty(position);if(evaluatedCell===undefined){return{value:null,format:this.getters.getCell(position)?.format};}
if(evaluatedCell.type===CellValueType.error){throw evaluatedCell.error;}
return evaluatedCell;}
getEvaluatedCellIfNotEmpty(position){const evaluatedCell=this.computeCell(position);if(evaluatedCell.type===CellValueType.empty){const cell=this.getters.getCell(position);if(!cell||(!cell.isFormula&&cell.content==="")){return undefined;}}
return evaluatedCell;}
range(range){this.assertRangeValid(range);const sheetId=range.sheetId;const zone=range.zone;const sheetZone=this.getters.getSheetZone(sheetId);const _zone=intersection(zone,sheetZone);if(!_zone){return[[]];}
const{top,left,bottom,right}=zone;const cacheKey=`${sheetId}-${top}-${left}-${bottom}-${right}`;if(cacheKey in this.rangeCache){const result=this.rangeCache[cacheKey];if(result instanceof EvaluationError){throw result;}
return result;}
const height=_zone.bottom-_zone.top+1;const width=_zone.right-_zone.left+1;const matrix=new Array(width);for(let col=_zone.left;col<=_zone.right;col++){const colIndex=col-_zone.left;matrix[colIndex]=new Array(height);for(let row=_zone.top;row<=_zone.bottom;row++){const evaluatedCell=this.getEvaluatedCellIfNotEmpty({sheetId,col,row});if(evaluatedCell?.type===CellValueType.error){this.rangeCache[cacheKey]=evaluatedCell.error;throw evaluatedCell.error;}
const rowIndex=row-_zone.top;matrix[colIndex][rowIndex]=this.readCell({sheetId,col,row});}}
this.rangeCache[cacheKey]=matrix;return matrix;}
assertRangeValid(range){if(!isZoneValid(range.zone)){throw new InvalidReferenceError();}
if(range.invalidSheetName){throw new Error(_t("Invalid sheet name: %s",range.invalidSheetName));}}}
function quickselect(arr,k,left,right,compare){quickselectStep(arr,k,left||0,right||(arr.length-1),compare||defaultCompare);}
function quickselectStep(arr,k,left,right,compare){while(right>left){if(right-left>600){var n=right-left+1;var m=k-left+1;var z=Math.log(n);var s=0.5*Math.exp(2*z/3);var sd=0.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);var newLeft=Math.max(left,Math.floor(k-m*s/n+sd));var newRight=Math.min(right,Math.floor(k+(n-m)*s/n+sd));quickselectStep(arr,k,newLeft,newRight,compare);}
var t=arr[k];var i=left;var j=right;swap(arr,left,k);if(compare(arr[right],t)>0)swap(arr,left,right);while(i<j){swap(arr,i,j);i++;j--;while(compare(arr[i],t)<0)i++;while(compare(arr[j],t)>0)j--;}
if(compare(arr[left],t)===0)swap(arr,left,j);else{j++;swap(arr,j,right);}
if(j<=k)left=j+1;if(k<=j)right=j-1;}}
function swap(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp;}
function defaultCompare(a,b){return a<b?-1:a>b?1:0;}
class RBush{constructor(maxEntries=9){this._maxEntries=Math.max(4,maxEntries);this._minEntries=Math.max(2,Math.ceil(this._maxEntries*0.4));this.clear();}
all(){return this._all(this.data,[]);}
search(bbox){let node=this.data;const result=[];if(!intersects(bbox,node))return result;const toBBox=this.toBBox;const nodesToSearch=[];while(node){for(let i=0;i<node.children.length;i++){const child=node.children[i];const childBBox=node.leaf?toBBox(child):child;if(intersects(bbox,childBBox)){if(node.leaf)result.push(child);else if(contains(bbox,childBBox))this._all(child,result);else nodesToSearch.push(child);}}
node=nodesToSearch.pop();}
return result;}
collides(bbox){let node=this.data;if(!intersects(bbox,node))return false;const nodesToSearch=[];while(node){for(let i=0;i<node.children.length;i++){const child=node.children[i];const childBBox=node.leaf?this.toBBox(child):child;if(intersects(bbox,childBBox)){if(node.leaf||contains(bbox,childBBox))return true;nodesToSearch.push(child);}}
node=nodesToSearch.pop();}
return false;}
load(data){if(!(data&&data.length))return this;if(data.length<this._minEntries){for(let i=0;i<data.length;i++){this.insert(data[i]);}
return this;}
let node=this._build(data.slice(),0,data.length-1,0);if(!this.data.children.length){this.data=node;}else if(this.data.height===node.height){this._splitRoot(this.data,node);}else{if(this.data.height<node.height){const tmpNode=this.data;this.data=node;node=tmpNode;}
this._insert(node,this.data.height-node.height-1,true);}
return this;}
insert(item){if(item)this._insert(item,this.data.height-1);return this;}
clear(){this.data=createNode([]);return this;}
remove(item,equalsFn){if(!item)return this;let node=this.data;const bbox=this.toBBox(item);const path=[];const indexes=[];let i,parent,goingUp;while(node||path.length){if(!node){node=path.pop();parent=path[path.length-1];i=indexes.pop();goingUp=true;}
if(node.leaf){const index=findItem(item,node.children,equalsFn);if(index!==-1){node.children.splice(index,1);path.push(node);this._condense(path);return this;}}
if(!goingUp&&!node.leaf&&contains(node,bbox)){path.push(node);indexes.push(i);i=0;parent=node;node=node.children[0];}else if(parent){i++;node=parent.children[i];goingUp=false;}else node=null;}
return this;}
toBBox(item){return item;}
compareMinX(a,b){return a.minX-b.minX;}
compareMinY(a,b){return a.minY-b.minY;}
toJSON(){return this.data;}
fromJSON(data){this.data=data;return this;}
_all(node,result){const nodesToSearch=[];while(node){if(node.leaf)result.push(...node.children);else nodesToSearch.push(...node.children);node=nodesToSearch.pop();}
return result;}
_build(items,left,right,height){const N=right-left+1;let M=this._maxEntries;let node;if(N<=M){node=createNode(items.slice(left,right+1));calcBBox(node,this.toBBox);return node;}
if(!height){height=Math.ceil(Math.log(N)/Math.log(M));M=Math.ceil(N/Math.pow(M,height-1));}
node=createNode([]);node.leaf=false;node.height=height;const N2=Math.ceil(N/M);const N1=N2*Math.ceil(Math.sqrt(M));multiSelect(items,left,right,N1,this.compareMinX);for(let i=left;i<=right;i+=N1){const right2=Math.min(i+N1-1,right);multiSelect(items,i,right2,N2,this.compareMinY);for(let j=i;j<=right2;j+=N2){const right3=Math.min(j+N2-1,right2);node.children.push(this._build(items,j,right3,height-1));}}
calcBBox(node,this.toBBox);return node;}
_chooseSubtree(bbox,node,level,path){while(true){path.push(node);if(node.leaf||path.length-1===level)break;let minArea=Infinity;let minEnlargement=Infinity;let targetNode;for(let i=0;i<node.children.length;i++){const child=node.children[i];const area=bboxArea(child);const enlargement=enlargedArea(bbox,child)-area;if(enlargement<minEnlargement){minEnlargement=enlargement;minArea=area<minArea?area:minArea;targetNode=child;}else if(enlargement===minEnlargement){if(area<minArea){minArea=area;targetNode=child;}}}
node=targetNode||node.children[0];}
return node;}
_insert(item,level,isNode){const bbox=isNode?item:this.toBBox(item);const insertPath=[];const node=this._chooseSubtree(bbox,this.data,level,insertPath);node.children.push(item);extend(node,bbox);while(level>=0){if(insertPath[level].children.length>this._maxEntries){this._split(insertPath,level);level--;}else break;}
this._adjustParentBBoxes(bbox,insertPath,level);}
_split(insertPath,level){const node=insertPath[level];const M=node.children.length;const m=this._minEntries;this._chooseSplitAxis(node,m,M);const splitIndex=this._chooseSplitIndex(node,m,M);const newNode=createNode(node.children.splice(splitIndex,node.children.length-splitIndex));newNode.height=node.height;newNode.leaf=node.leaf;calcBBox(node,this.toBBox);calcBBox(newNode,this.toBBox);if(level)insertPath[level-1].children.push(newNode);else this._splitRoot(node,newNode);}
_splitRoot(node,newNode){this.data=createNode([node,newNode]);this.data.height=node.height+1;this.data.leaf=false;calcBBox(this.data,this.toBBox);}
_chooseSplitIndex(node,m,M){let index;let minOverlap=Infinity;let minArea=Infinity;for(let i=m;i<=M-m;i++){const bbox1=distBBox(node,0,i,this.toBBox);const bbox2=distBBox(node,i,M,this.toBBox);const overlap=intersectionArea(bbox1,bbox2);const area=bboxArea(bbox1)+bboxArea(bbox2);if(overlap<minOverlap){minOverlap=overlap;index=i;minArea=area<minArea?area:minArea;}else if(overlap===minOverlap){if(area<minArea){minArea=area;index=i;}}}
return index||M-m;}
_chooseSplitAxis(node,m,M){const compareMinX=node.leaf?this.compareMinX:compareNodeMinX;const compareMinY=node.leaf?this.compareMinY:compareNodeMinY;const xMargin=this._allDistMargin(node,m,M,compareMinX);const yMargin=this._allDistMargin(node,m,M,compareMinY);if(xMargin<yMargin)node.children.sort(compareMinX);}
_allDistMargin(node,m,M,compare){node.children.sort(compare);const toBBox=this.toBBox;const leftBBox=distBBox(node,0,m,toBBox);const rightBBox=distBBox(node,M-m,M,toBBox);let margin=bboxMargin(leftBBox)+bboxMargin(rightBBox);for(let i=m;i<M-m;i++){const child=node.children[i];extend(leftBBox,node.leaf?toBBox(child):child);margin+=bboxMargin(leftBBox);}
for(let i=M-m-1;i>=m;i--){const child=node.children[i];extend(rightBBox,node.leaf?toBBox(child):child);margin+=bboxMargin(rightBBox);}
return margin;}
_adjustParentBBoxes(bbox,path,level){for(let i=level;i>=0;i--){extend(path[i],bbox);}}
_condense(path){for(let i=path.length-1,siblings;i>=0;i--){if(path[i].children.length===0){if(i>0){siblings=path[i-1].children;siblings.splice(siblings.indexOf(path[i]),1);}else this.clear();}else calcBBox(path[i],this.toBBox);}}}
function findItem(item,items,equalsFn){if(!equalsFn)return items.indexOf(item);for(let i=0;i<items.length;i++){if(equalsFn(item,items[i]))return i;}
return-1;}
function calcBBox(node,toBBox){distBBox(node,0,node.children.length,toBBox,node);}
function distBBox(node,k,p,toBBox,destNode){if(!destNode)destNode=createNode(null);destNode.minX=Infinity;destNode.minY=Infinity;destNode.maxX=-Infinity;destNode.maxY=-Infinity;for(let i=k;i<p;i++){const child=node.children[i];extend(destNode,node.leaf?toBBox(child):child);}
return destNode;}
function extend(a,b){a.minX=Math.min(a.minX,b.minX);a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,b.maxY);return a;}
function compareNodeMinX(a,b){return a.minX-b.minX;}
function compareNodeMinY(a,b){return a.minY-b.minY;}
function bboxArea(a){return(a.maxX-a.minX)*(a.maxY-a.minY);}
function bboxMargin(a){return(a.maxX-a.minX)+(a.maxY-a.minY);}
function enlargedArea(a,b){return(Math.max(b.maxX,a.maxX)-Math.min(b.minX,a.minX))*(Math.max(b.maxY,a.maxY)-Math.min(b.minY,a.minY));}
function intersectionArea(a,b){const minX=Math.max(a.minX,b.minX);const minY=Math.max(a.minY,b.minY);const maxX=Math.min(a.maxX,b.maxX);const maxY=Math.min(a.maxY,b.maxY);return Math.max(0,maxX-minX)*Math.max(0,maxY-minY);}
function contains(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY;}
function intersects(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY;}
function createNode(children){return{children,height:1,leaf:true,minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};}
function multiSelect(arr,left,right,n,compare){const stack=[left,right];while(stack.length){right=stack.pop();left=stack.pop();if(right-left<=n)continue;const mid=left+Math.ceil((right-left)/n/2)*n;quickselect(arr,mid,left,right,compare);stack.push(left,mid,mid,right);}}
class SpreadsheetRTree{rTrees={};constructor(items=[]){const rangesPerSheet={};for(const item of items){const sheetId=item.boundingBox.sheetId;if(!rangesPerSheet[sheetId]){rangesPerSheet[sheetId]=[];}
rangesPerSheet[sheetId].push(item);}
for(const sheetId in rangesPerSheet){this.rTrees[sheetId]=new ZoneRBush();this.rTrees[sheetId].load(rangesPerSheet[sheetId]);}}
insert(item){const sheetId=item.boundingBox.sheetId;if(!this.rTrees[sheetId]){this.rTrees[sheetId]=new ZoneRBush();}
this.rTrees[sheetId].insert(item);}
search({zone,sheetId}){if(!this.rTrees[sheetId]){return[];}
return this.rTrees[sheetId].search({minX:zone.left,minY:zone.top,maxX:zone.right,maxY:zone.bottom,});}
remove(item){const sheetId=item.boundingBox.sheetId;if(!this.rTrees[sheetId]){return;}
this.rTrees[sheetId].remove(item,this.rtreeItemComparer);}
rtreeItemComparer(left,right){return(left.data==right.data&&left.boundingBox.sheetId===right.boundingBox.sheetId&&left.boundingBox?.zone.left===right.boundingBox.zone.left&&left.boundingBox?.zone.top===right.boundingBox.zone.top&&left.boundingBox?.zone.right===right.boundingBox.zone.right&&left.boundingBox?.zone.bottom===right.boundingBox.zone.bottom);}}
class ZoneRBush extends RBush{toBBox({boundingBox}){const zone=boundingBox.zone;return{minX:zone.left,minY:zone.top,maxX:zone.right,maxY:zone.bottom,};}
compareMinX(a,b){return a.boundingBox.zone.left-b.boundingBox.zone.left;}
compareMinY(a,b){return a.boundingBox.zone.top-b.boundingBox.zone.top;}}
class FormulaDependencyGraph{encoder;dependencies=new Map();rTree;constructor(encoder,data=[]){this.encoder=encoder;this.rTree=new SpreadsheetRTree(data);}
removeAllDependencies(formulaPositionId){const ranges=this.dependencies.get(formulaPositionId);if(!ranges){return;}
for(const range of ranges){this.rTree.remove(range);}
this.dependencies.delete(formulaPositionId);}
addDependencies(formulaPositionId,dependencies){const rTreeItems=dependencies.map(({sheetId,zone})=>({data:formulaPositionId,boundingBox:{zone,sheetId,},}));for(const item of rTreeItems){this.rTree.insert(item);}
const existingDependencies=this.dependencies.get(formulaPositionId);if(existingDependencies){existingDependencies.push(...rTreeItems);}
else{this.dependencies.set(formulaPositionId,rTreeItems);}}
getCellsDependingOn(ranges){const visited=new JetSet();const queue=Array.from(ranges).reverse();while(queue.length>0){const range=queue.pop();visited.addMany(this.encoder.encodeBoundingBox(range));const impactedPositionIds=this.rTree.search(range).map((dep)=>dep.data);for(const positionId of impactedPositionIds){if(!visited.has(positionId)){queue.push(this.encoder.decodeToBoundingBox(positionId));}}}
visited.deleteMany(ranges.flatMap((r)=>this.encoder.encodeBoundingBox(r)));return visited;}}
class SpreadingRelation{resultsToArrayFormulas=new Map();arrayFormulasToResults=new Map();getFormulaPositionsSpreadingOn(resultPositionId){return this.resultsToArrayFormulas.get(resultPositionId)||EMPTY_ARRAY;}
getArrayResultPositionIds(formulasPositionId){return this.arrayFormulasToResults.get(formulasPositionId)||EMPTY_ARRAY;}
removeNode(positionId){this.resultsToArrayFormulas.delete(positionId);this.arrayFormulasToResults.delete(positionId);}
addRelation({arrayFormulaPositionId,resultPositionId,}){if(!this.resultsToArrayFormulas.has(resultPositionId)){this.resultsToArrayFormulas.set(resultPositionId,new Set());}
this.resultsToArrayFormulas.get(resultPositionId)?.add(arrayFormulaPositionId);if(!this.arrayFormulasToResults.has(arrayFormulaPositionId)){this.arrayFormulasToResults.set(arrayFormulaPositionId,new Set());}
this.arrayFormulasToResults.get(arrayFormulaPositionId)?.add(resultPositionId);}
hasArrayFormulaResult(positionId){return this.resultsToArrayFormulas.has(positionId);}
isArrayFormula(positionId){return this.arrayFormulasToResults.has(positionId);}}
const EMPTY_ARRAY=[];const MAX_ITERATION=30;class Evaluator{context;getters;compilationParams;encoder=new PositionBitsEncoder();evaluatedCells=new Map();formulaDependencies=lazy(new FormulaDependencyGraph(this.encoder));blockedArrayFormulas=new Set();spreadingRelations=new SpreadingRelation();constructor(context,getters){this.context=context;this.getters=getters;this.compilationParams=buildCompilationParameters(this.context,this.getters,this.computeAndSave.bind(this));}
getEvaluatedCell(position){return(this.evaluatedCells.get(this.encoder.encode(position))||createEvaluatedCell("",{locale:this.getters.getLocale()}));}
getSpreadPositionsOf(position){const positionId=this.encoder.encode(position);if(!this.spreadingRelations.isArrayFormula(positionId)){return[];}
return Array.from(this.spreadingRelations.getArrayResultPositionIds(positionId)).map((positionId)=>this.encoder.decode(positionId));}
getArrayFormulaSpreadingOn(position){const positionId=this.encoder.encode(position);const formulaPosition=this.getArrayFormulaSpreadingOnId(positionId);return formulaPosition!==undefined?this.encoder.decode(formulaPosition):undefined;}
getEvaluatedPositions(){return[...this.evaluatedCells.keys()].map((p)=>this.encoder.decode(p));}
getArrayFormulaSpreadingOnId(positionId){if(!this.spreadingRelations.hasArrayFormulaResult(positionId)){return undefined;}
const arrayFormulas=this.spreadingRelations.getFormulaPositionsSpreadingOn(positionId);return Array.from(arrayFormulas).find((positionId)=>!this.blockedArrayFormulas.has(positionId));}
updateDependencies(position){const positionId=this.encoder.encode(position);this.formulaDependencies().removeAllDependencies(positionId);const dependencies=this.getDirectDependencies(positionId);this.formulaDependencies().addDependencies(positionId,dependencies);}
updateCompilationParameters(){this.compilationParams=buildCompilationParameters(this.context,this.getters,this.computeAndSave.bind(this));}
evaluateCells(positions){const cells=positions.map((p)=>this.encoder.encode(p));const cellsToCompute=new JetSet(cells);const arrayFormulasPositionIds=this.getArrayFormulasImpactedByChangesOf(cells);cellsToCompute.addMany(this.getCellsDependingOn(cells));cellsToCompute.addMany(arrayFormulasPositionIds);cellsToCompute.addMany(this.getCellsDependingOn(arrayFormulasPositionIds));this.evaluate(cellsToCompute);}
getArrayFormulasImpactedByChangesOf(positionIds){const impactedPositionIds=new JetSet();for(const positionId of positionIds){const content=this.getCell(positionId)?.content;const arrayFormulaPositionId=this.getArrayFormulaSpreadingOnId(positionId);if(arrayFormulaPositionId!==undefined){impactedPositionIds.add(arrayFormulaPositionId);}
if(!content){impactedPositionIds.addMany(this.getArrayFormulasBlockedByOrSpreadingOn(positionId));}}
return impactedPositionIds;}
buildDependencyGraph(){this.blockedArrayFormulas=new Set();this.spreadingRelations=new SpreadingRelation();this.formulaDependencies=lazy(()=>{const dependencies=[...this.getAllCells()].flatMap((positionId)=>this.getDirectDependencies(positionId).filter((range)=>!range.invalidSheetName&&!range.invalidXc).map((range)=>({data:positionId,boundingBox:{zone:range.zone,sheetId:range.sheetId,},})));return new FormulaDependencyGraph(this.encoder,dependencies);});}
evaluateAllCells(){this.evaluatedCells=new Map();this.evaluate(this.getAllCells());}
evaluateFormula(sheetId,formulaString){const compiledFormula=compile(formulaString);const ranges=compiledFormula.dependencies.map((xc)=>this.getters.getRangeFromSheetXC(sheetId,xc));this.updateCompilationParameters();const array=compiledFormula.execute(ranges,...this.compilationParams);if(isMatrix(array)){return matrixMap(array,(cell)=>cell.value);}
return array.value;}
getAllCells(){const positionIds=new JetSet();for(const sheetId of this.getters.getSheetIds()){const cellIds=this.getters.getCells(sheetId);for(const cellId in cellIds){positionIds.add(this.encoder.encode(this.getters.getCellPosition(cellId)));}}
return positionIds;}
getArrayFormulasBlockedByOrSpreadingOn(positionId){if(!this.spreadingRelations.hasArrayFormulaResult(positionId)){return[];}
const arrayFormulas=this.spreadingRelations.getFormulaPositionsSpreadingOn(positionId);const cells=new JetSet(arrayFormulas);cells.addMany(this.getCellsDependingOn(arrayFormulas));return cells;}
nextPositionsToUpdate=new JetSet();cellsBeingComputed=new Set();evaluate(cells){this.cellsBeingComputed=new Set();this.nextPositionsToUpdate=cells;let currentIteration=0;while(this.nextPositionsToUpdate.size&&currentIteration++<MAX_ITERATION){this.updateCompilationParameters();const positionIds=Array.from(this.nextPositionsToUpdate);this.nextPositionsToUpdate.clear();for(let i=0;i<positionIds.length;++i){const cell=positionIds[i];this.evaluatedCells.delete(cell);}
for(let i=0;i<positionIds.length;++i){const cell=positionIds[i];this.setEvaluatedCell(cell,this.computeCell(cell));}}}
setEvaluatedCell(positionId,evaluatedCell){this.evaluatedCells.set(positionId,evaluatedCell);}
computeCell(positionId){const evaluation=this.evaluatedCells.get(positionId);if(evaluation){return evaluation;}
if(!this.blockedArrayFormulas.has(positionId)){this.invalidateSpreading(positionId);}
const cell=this.getCell(positionId);if(cell===undefined){return createEvaluatedCell("",{locale:this.getters.getLocale()});}
const cellId=cell.id;try{if(this.cellsBeingComputed.has(cellId)){throw new CircularDependencyError();}
this.cellsBeingComputed.add(cellId);return cell.isFormula?this.computeFormulaCell(cell):evaluateLiteral(cell.content,{format:cell.format,locale:this.getters.getLocale()});}
catch(e){return this.handleError(e,cell);}
finally{this.cellsBeingComputed.delete(cellId);}}
computeAndSave(position){const positionId=this.encoder.encode(position);const evaluatedCell=this.computeCell(positionId);if(!this.evaluatedCells.has(positionId)){this.setEvaluatedCell(positionId,evaluatedCell);}
return evaluatedCell;}
handleError(e,cell){if(!(e instanceof EvaluationError)){e=new EvaluationError(CellErrorType.GenericError,e.message);}
const __lastFnCalled=this.compilationParams[2].__lastFnCalled||"";e.message=e.message.replace("[[FUNCTION_NAME]]",__lastFnCalled);return errorCell(e);}
computeFormulaCell(cellData){const cellId=cellData.id;this.compilationParams[2].__originCellXC=()=>{const position=this.compilationParams[2].getters.getCellPosition(cellId);return toXC(position.col,position.row);};const formulaReturn=cellData.compiledFormula.execute(cellData.compiledFormula.dependencies,...this.compilationParams);if(!isMatrix(formulaReturn)){return createEvaluatedCell(formulaReturn.value,{format:cellData.format||formulaReturn.format,locale:this.getters.getLocale(),});}
const formulaPosition=this.getters.getCellPosition(cellId);this.assertSheetHasEnoughSpaceToSpreadFormulaResult(formulaPosition,formulaReturn);const nbColumns=formulaReturn.length;const nbRows=formulaReturn[0].length;forEachSpreadPositionInMatrix(nbColumns,nbRows,this.updateSpreadRelation(formulaPosition));forEachSpreadPositionInMatrix(nbColumns,nbRows,this.checkCollision(formulaPosition));forEachSpreadPositionInMatrix(nbColumns,nbRows,this.spreadValues(formulaPosition,formulaReturn));return createEvaluatedCell(formulaReturn[0][0].value,{format:cellData.format||formulaReturn[0][0]?.format,locale:this.getters.getLocale(),});}
assertSheetHasEnoughSpaceToSpreadFormulaResult({sheetId,col,row},matrixResult){const numberOfCols=this.getters.getNumberCols(sheetId);const numberOfRows=this.getters.getNumberRows(sheetId);const enoughCols=col+matrixResult.length<=numberOfCols;const enoughRows=row+matrixResult[0].length<=numberOfRows;if(enoughCols&&enoughRows){return;}
if(enoughCols){throw new Error(_t("Result couldn't be automatically expanded. Please insert more rows."));}
if(enoughRows){throw new Error(_t("Result couldn't be automatically expanded. Please insert more columns."));}
throw new Error(_t("Result couldn't be automatically expanded. Please insert more columns and rows."));}
updateSpreadRelation({sheetId,col,row,}){const arrayFormulaPositionId=this.encoder.encode({sheetId,col,row});return(i,j)=>{const position={sheetId,col:i+col,row:j+row};const resultPositionId=this.encoder.encode(position);this.spreadingRelations.addRelation({resultPositionId,arrayFormulaPositionId});};}
checkCollision({sheetId,col,row}){const formulaPositionId=this.encoder.encode({sheetId,col,row});return(i,j)=>{const position={sheetId:sheetId,col:i+col,row:j+row};const rawCell=this.getters.getCell(position);if(rawCell?.content||this.getters.getEvaluatedCell(position).type!==CellValueType.empty){this.blockedArrayFormulas.add(formulaPositionId);throw new Error(_t("Array result was not expanded because it would overwrite data in %s.",toXC(position.col,position.row)));}
this.blockedArrayFormulas.delete(formulaPositionId);};}
spreadValues({sheetId,col,row},matrixResult){return(i,j)=>{const position={sheetId,col:i+col,row:j+row};const cell=this.getters.getCell(position);const format=cell?.format;const evaluatedCell=createEvaluatedCell(matrixResult[i][j].value,{format:format||matrixResult[i][j]?.format,locale:this.getters.getLocale(),});const positionId=this.encoder.encode(position);this.setEvaluatedCell(positionId,evaluatedCell);this.nextPositionsToUpdate.addMany(this.getCellsDependingOn([positionId]));};}
invalidateSpreading(positionId){if(!this.spreadingRelations.isArrayFormula(positionId)){return;}
for(const child of this.spreadingRelations.getArrayResultPositionIds(positionId)){const content=this.getCell(child)?.content;if(content){continue;}
this.evaluatedCells.delete(child);this.nextPositionsToUpdate.addMany(this.getCellsDependingOn([child]));this.nextPositionsToUpdate.addMany(this.getArrayFormulasBlockedByOrSpreadingOn(child));}
this.spreadingRelations.removeNode(positionId);}
getDirectDependencies(positionId){const cell=this.getCell(positionId);if(!cell?.isFormula){return[];}
return cell.compiledFormula.dependencies;}
getCellsDependingOn(positionIds){const ranges=[];for(const positionId of positionIds){ranges.push(this.encoder.decodeToBoundingBox(positionId));}
return this.formulaDependencies().getCellsDependingOn(ranges);}
getCell(positionId){return this.getters.getCell(this.encoder.decode(positionId));}}
function forEachSpreadPositionInMatrix(nbColumns,nbRows,callback){for(let i=0;i<nbColumns;++i){for(let j=0;j<nbRows;++j){if(i===0&&j===0){continue;}
callback(i,j);}}}
class PositionBitsEncoder{sheetMapping={};inverseSheetMapping=new Map();constructor(){try{o_spreadsheet.__DEBUG__=o_spreadsheet.__DEBUG__||{};o_spreadsheet.__DEBUG__.decodePosition=this.decode.bind(this);o_spreadsheet.__DEBUG__.encodePosition=this.encode.bind(this);}
catch(error){}}
encode({sheetId,col,row}){return(this.encodeSheet(sheetId)<<42n)|(BigInt(col)<<21n)|BigInt(row);}
encodeBoundingBox({sheetId,zone}){const positions=[];forEachPositionsInZone(zone,(col,row)=>{positions.push(this.encode({sheetId,col,row}));});return positions;}
decode(id){const row=Number(id&2097151n);const col=Number((id>>21n)&2097151n);const sheetId=this.decodeSheet(id>>42n);return{sheetId,col,row};}
decodeToBoundingBox(id){const{sheetId,col,row}=this.decode(id);return{sheetId,zone:{left:col,top:row,right:col,bottom:row}};}
encodeSheet(sheetId){const sheetKey=this.sheetMapping[sheetId];if(sheetKey===undefined){const newSheetKey=BigInt(Object.keys(this.sheetMapping).length);this.sheetMapping[sheetId]=newSheetKey;this.inverseSheetMapping.set(newSheetKey,sheetId);return newSheetKey;}
return sheetKey;}
decodeSheet(sheetKey){const sheetId=this.inverseSheetMapping.get(sheetKey);if(sheetId===undefined){throw new Error("Sheet id not found");}
return sheetId;}}
class EvaluationPlugin extends UIPlugin{static getters=["evaluateFormula","getCorrespondingFormulaCell","getRangeFormattedValues","getRangeValues","getRangeFormats","getEvaluatedCell","getEvaluatedCells","getEvaluatedCellsInZone","getSpreadPositionsOf","getArrayFormulaSpreadingOn","isEmpty",];shouldRebuildDependenciesGraph=true;evaluator;positionsToUpdate=[];constructor(config){super(config);this.evaluator=new Evaluator(config.custom,this.getters);}
beforeHandle(cmd){if(invalidateDependenciesCommands.has(cmd.type)){this.shouldRebuildDependenciesGraph=true;}}
handle(cmd){switch(cmd.type){case"UPDATE_CELL":if(!("content"in cmd||"format"in cmd)||this.shouldRebuildDependenciesGraph){return;}
this.positionsToUpdate.push(cmd);if("content"in cmd){this.evaluator.updateDependencies(cmd);}
break;case"EVALUATE_CELLS":this.evaluator.evaluateAllCells();break;}}
finalize(){if(this.shouldRebuildDependenciesGraph){this.evaluator.buildDependencyGraph();this.evaluator.evaluateAllCells();this.shouldRebuildDependenciesGraph=false;}
else if(this.positionsToUpdate.length){this.evaluator.evaluateCells(this.positionsToUpdate);}
this.positionsToUpdate=[];}
evaluateFormula(sheetId,formulaString){try{return this.evaluator.evaluateFormula(sheetId,formulaString);}
catch(error){return error instanceof EvaluationError?error.errorType:CellErrorType.GenericError;}}
getRangeFormattedValues(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.formattedValue);}
getRangeValues(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.value);}
getRangeFormats(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.format);}
getEvaluatedCell(position){return this.evaluator.getEvaluatedCell(position);}
getEvaluatedCells(sheetId){const rawCells=this.getters.getCells(sheetId)||{};const record={};for(let cellId of Object.keys(rawCells)){const position=this.getters.getCellPosition(cellId);record[cellId]=this.getEvaluatedCell(position);}
return record;}
getEvaluatedCellsInZone(sheetId,zone){return positions(zone).map(({col,row})=>this.getters.getEvaluatedCell({sheetId,col,row}));}
getSpreadPositionsOf(position){return this.evaluator.getSpreadPositionsOf(position);}
getArrayFormulaSpreadingOn(position){return this.evaluator.getArrayFormulaSpreadingOn(position);}
isEmpty(sheetId,zone){return positions(zone).map(({col,row})=>this.getEvaluatedCell({sheetId,col,row})).every((cell)=>cell.type===CellValueType.empty);}
exportForExcel(data){for(const position of this.evaluator.getEvaluatedPositions()){const evaluatedCell=this.evaluator.getEvaluatedCell(position);const xc=toXC(position.col,position.row);const value=evaluatedCell.value;let isFormula=false;let newContent=undefined;let newFormat=undefined;let isExported=true;const formulaCell=this.getCorrespondingFormulaCell(position);if(formulaCell){isExported=isExportableToExcel(formulaCell.compiledFormula.tokens);isFormula=isExported;if(!isExported){newContent=value.toString();newFormat=evaluatedCell.format;}}
const exportedSheetData=data.sheets.find((sheet)=>sheet.id===position.sheetId);const exportedCellData=exportedSheetData.cells[xc]||{};const format=newFormat?getItemId(newFormat,data.formats):exportedCellData.format;let content;if(isFormula&&formulaCell instanceof FormulaCellWithDependencies){content=this.getters.getFormulaCellContent(exportedSheetData.id,formulaCell.compiledFormula,formulaCell.compiledFormula.dependencies,true);}
else{content=!isExported?newContent:exportedCellData.content;}
exportedSheetData.cells[xc]={...exportedCellData,value,isFormula,content,format};}}
getCorrespondingFormulaCell(position){const cell=this.getters.getCell(position);if(cell&&cell.isFormula){return isBadExpression(cell.compiledFormula.tokens)?undefined:cell;}
else if(cell&&cell.content){return undefined;}
const spreadingFormulaPosition=this.getArrayFormulaSpreadingOn(position);if(spreadingFormulaPosition===undefined){return undefined;}
const spreadingFormulaCell=this.getters.getCell(spreadingFormulaPosition);if(spreadingFormulaCell?.isFormula){return spreadingFormulaCell;}
return undefined;}}
function isBadExpression(tokens){try{compileTokens(tokens);return false;}
catch(error){return true;}}
function sortWithClusters(colorsToSort){const clusters=[{leadColor:rgba(255,0,0),colors:[]},{leadColor:rgba(255,128,0),colors:[]},{leadColor:rgba(128,128,0),colors:[]},{leadColor:rgba(128,255,0),colors:[]},{leadColor:rgba(0,255,0),colors:[]},{leadColor:rgba(0,255,128),colors:[]},{leadColor:rgba(0,255,255),colors:[]},{leadColor:rgba(0,127,255),colors:[]},{leadColor:rgba(0,0,255),colors:[]},{leadColor:rgba(127,0,255),colors:[]},{leadColor:rgba(128,0,128),colors:[]},{leadColor:rgba(255,0,128),colors:[]},];for(const color of colorsToSort.map(colorToRGBA)){let currentDistance=500;let currentIndex=0;clusters.forEach((cluster,clusterIndex)=>{const distance=colorDistance(color,cluster.leadColor);if(currentDistance>distance){currentDistance=distance;currentIndex=clusterIndex;}});clusters[currentIndex].colors.push(color);}
return clusters.map((cluster)=>cluster.colors.sort((a,b)=>rgbaToHSLA(a).s-rgbaToHSLA(b).s)).flat().map(rgbaToHex);}
function colorDistance(color1,color2){return Math.sqrt(Math.pow(color1.r-color2.r,2)+
Math.pow(color1.g-color2.g,2)+
Math.pow(color1.b-color2.b,2));}
class CustomColorsPlugin extends UIPlugin{customColors={};shouldUpdateColors=false;static getters=["getCustomColors"];handle(cmd){switch(cmd.type){case"UPDATE_CELL":case"UPDATE_CHART":case"CREATE_CHART":case"ADD_CONDITIONAL_FORMAT":case"SET_BORDER":case"SET_ZONE_BORDERS":case"SET_FORMATTING":this.history.update("shouldUpdateColors",true);}}
finalize(){if(this.shouldUpdateColors){this.history.update("shouldUpdateColors",false);for(const color of this.getCustomColors()){this.tryToAddColor(color);}}}
getCustomColors(){let usedColors=[];for(const sheetId of this.getters.getSheetIds()){usedColors=usedColors.concat(this.getColorsFromCells(sheetId),this.getFormattingColors(sheetId),this.getChartColors(sheetId));}
return sortWithClusters([...new Set([...new Set([...usedColors,...Object.keys(this.customColors)])].filter(isColorValid).map(toHex)),]).filter((color)=>!COLOR_PICKER_DEFAULTS.includes(color));}
getColorsFromCells(sheetId){const cells=Object.values(this.getters.getCells(sheetId));const colors=new Set();for(const cell of cells){if(cell.style?.textColor){colors.add(cell.style.textColor);}
if(cell.style?.fillColor){colors.add(cell.style.fillColor);}}
for(const color of this.getters.getBordersColors(sheetId)){colors.add(color);}
return[...colors];}
getFormattingColors(sheetId){const formats=this.getters.getConditionalFormats(sheetId);const formatColors=[];for(const format of formats){const rule=format.rule;if(rule.type==="CellIsRule"){formatColors.push(rule.style.textColor);formatColors.push(rule.style.fillColor);}
else if(rule.type==="ColorScaleRule"){formatColors.push(colorNumberString(rule.minimum.color));formatColors.push(rule.midpoint?colorNumberString(rule.midpoint.color):undefined);formatColors.push(colorNumberString(rule.maximum.color));}}
return formatColors.filter(isDefined$1);}
getChartColors(sheetId){const charts=this.getters.getChartIds(sheetId).map((cid)=>this.getters.getChart(cid));let chartsColors=new Set();for(let chart of charts){if(chart===undefined){continue;}
const background=chart.getDefinition().background;if(background!==undefined){chartsColors.add(background);}
switch(chart.type){case"gauge":const colors=chart.sectionRule.colors;chartsColors.add(colors.lowerColor);chartsColors.add(colors.middleColor);chartsColors.add(colors.upperColor);break;case"scorecard":const scoreChart=chart;chartsColors.add(scoreChart.baselineColorDown);chartsColors.add(scoreChart.baselineColorUp);break;}}
return[...chartsColors];}
tryToAddColor(color){const formattedColor=toHex(color);if(color&&!COLOR_PICKER_DEFAULTS.includes(formattedColor)){this.history.update("customColors",formattedColor,true);}}}
class EvaluationChartPlugin extends UIPlugin{static getters=["getChartRuntime","getStyleOfSingleCellChart"];charts={};createRuntimeChart=chartRuntimeFactory(this.getters);handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)||invalidateCFEvaluationCommands.has(cmd.type)||cmd.type==="EVALUATE_CELLS"||cmd.type==="UPDATE_CELL"){for(const chartId in this.charts){this.charts[chartId]=undefined;}}
switch(cmd.type){case"UPDATE_CHART":case"CREATE_CHART":case"DELETE_FIGURE":this.charts[cmd.id]=undefined;break;case"DELETE_SHEET":for(let chartId in this.charts){if(!this.getters.isChartDefined(chartId)){this.charts[chartId]=undefined;}}
break;}}
getChartRuntime(figureId){if(!this.charts[figureId]){const chart=this.getters.getChart(figureId);if(!chart){throw new Error(`No chart for the given id: ${figureId}`);}
this.charts[figureId]=this.createRuntimeChart(chart);}
return this.charts[figureId];}
getStyleOfSingleCellChart(chartBackground,mainRange){if(chartBackground)
return{background:chartBackground,fontColor:chartFontColor(chartBackground)};if(!mainRange){return{background:BACKGROUND_CHART_COLOR,fontColor:chartFontColor(BACKGROUND_CHART_COLOR),};}
const col=mainRange.zone.left;const row=mainRange.zone.top;const sheetId=mainRange.sheetId;const style=this.getters.getCellComputedStyle({sheetId,col,row});const background=style.fillColor||BACKGROUND_CHART_COLOR;return{background,fontColor:style.textColor||chartFontColor(background),};}
exportForExcel(data){for(const sheet of data.sheets){if(!sheet.images){sheet.images=[];}
const sheetFigures=this.getters.getFigures(sheet.id);const figures=[];for(const figure of sheetFigures){if(!figure||figure.tag!=="chart"){continue;}
const figureId=figure.id;const figureData=this.getters.getChart(figureId)?.getDefinitionForExcel();if(figureData){figures.push({...figure,data:figureData,});}
else{const chart=this.getters.getChart(figureId);if(!chart){continue;}
const type=this.getters.getChartType(figureId);const runtime=this.getters.getChartRuntime(figureId);const img=chartToImage(runtime,figure,type);sheet.images.push({...figure,tag:"image",data:{mimetype:"image/png",path:img,size:{width:figure.width,height:figure.height},},});}}
sheet.charts=figures;}}}
class EvaluationConditionalFormatPlugin extends UIPlugin{static getters=["getConditionalIcon","getCellComputedStyle"];isStale=true;computedStyles={};computedIcons={};handle(cmd){if(invalidateCFEvaluationCommands.has(cmd.type)||(cmd.type==="UPDATE_CELL"&&"content"in cmd)){this.isStale=true;}}
finalize(){if(this.isStale){for(const sheetId of this.getters.getSheetIds()){this.computedStyles[sheetId]=lazy(()=>this.getComputedStyles(sheetId));this.computedIcons[sheetId]=lazy(()=>this.getComputedIcons(sheetId));}
this.isStale=false;}}
getCellComputedStyle(position){const{sheetId,col,row}=position;const cell=this.getters.getCell(position);const styles=this.computedStyles[sheetId]();const cfStyle=styles&&styles[col]?.[row];const computedStyle={...cell?.style,...cfStyle,};const evaluatedCell=this.getters.getEvaluatedCell(position);if(evaluatedCell.link&&!computedStyle.textColor){computedStyle.textColor=LINK_COLOR;}
if(this.getters.isFilterHeader(position)){computedStyle.bold=true;}
return computedStyle;}
getConditionalIcon({sheetId,col,row}){const icons=this.computedIcons[sheetId]();return icons&&icons[col]?.[row];}
getComputedStyles(sheetId){const computedStyle={};for(let cf of this.getters.getConditionalFormats(sheetId).reverse()){switch(cf.rule.type){case"ColorScaleRule":for(let range of cf.ranges){this.applyColorScale(sheetId,range,cf.rule,computedStyle);}
break;case"CellIsRule":const formulas=cf.rule.values.map((value)=>value.startsWith("=")?compile(value):undefined);for(let ref of cf.ranges){const zone=this.getters.getRangeFromSheetXC(sheetId,ref).zone;for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const predicate=this.rulePredicate[cf.rule.type];const target={sheetId,col,row};const values=cf.rule.values.map((value,i)=>{const compiledFormula=formulas[i];if(compiledFormula){return this.getters.getTranslatedCellFormula(sheetId,col-zone.left,row-zone.top,{...compiledFormula,dependencies:compiledFormula.dependencies.map((d)=>this.getters.getRangeFromSheetXC(sheetId,d)),});}
return value;});if(predicate&&predicate(target,{...cf.rule,values})){if(!computedStyle[col])
computedStyle[col]=[];computedStyle[col][row]=Object.assign(computedStyle[col]?.[row]||{},cf.rule.style);}}}}
break;}}
return computedStyle;}
getComputedIcons(sheetId){const computedIcons={};for(let cf of this.getters.getConditionalFormats(sheetId).reverse()){if(cf.rule.type!=="IconSetRule")
continue;for(let range of cf.ranges){this.applyIcon(sheetId,range,cf.rule,computedIcons);}}
return computedIcons;}
parsePoint(sheetId,range,threshold,functionName){const rangeValues=this.getters.getEvaluatedCellsInZone(sheetId,this.getters.getRangeFromSheetXC(sheetId,range).zone).filter((cell)=>cell.type===CellValueType.number).map((cell)=>cell.value);switch(threshold.type){case"value":const result=functionName==="max"?largeMax(rangeValues):largeMin(rangeValues);return result;case"number":return Number(threshold.value);case"percentage":const min=largeMin(rangeValues);const max=largeMax(rangeValues);const delta=max-min;return min+(delta*Number(threshold.value))/100;case"percentile":return percentile(rangeValues,Number(threshold.value)/100,true);case"formula":const value=threshold.value&&this.getters.evaluateFormula(sheetId,threshold.value);return typeof value==="number"?value:null;default:return null;}}
applyIcon(sheetId,range,rule,computedIcons){const lowerInflectionPoint=this.parsePoint(sheetId,range,rule.lowerInflectionPoint);const upperInflectionPoint=this.parsePoint(sheetId,range,rule.upperInflectionPoint);if(lowerInflectionPoint===null||upperInflectionPoint===null||lowerInflectionPoint>upperInflectionPoint){return;}
const zone=this.getters.getRangeFromSheetXC(sheetId,range).zone;const iconSet=[rule.icons.upper,rule.icons.middle,rule.icons.lower];for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type!==CellValueType.number){continue;}
const icon=this.computeIcon(cell.value,upperInflectionPoint,rule.upperInflectionPoint.operator,lowerInflectionPoint,rule.lowerInflectionPoint.operator,iconSet);if(!computedIcons[col]){computedIcons[col]=[];}
computedIcons[col][row]=icon;}}}
computeIcon(value,upperInflectionPoint,upperOperator,lowerInflectionPoint,lowerOperator,icons){if((upperOperator==="ge"&&value>=upperInflectionPoint)||(upperOperator==="gt"&&value>upperInflectionPoint)){return icons[0];}
else if((lowerOperator==="ge"&&value>=lowerInflectionPoint)||(lowerOperator==="gt"&&value>lowerInflectionPoint)){return icons[1];}
return icons[2];}
applyColorScale(sheetId,range,rule,computedStyle){const minValue=this.parsePoint(sheetId,range,rule.minimum,"min");const midValue=rule.midpoint?this.parsePoint(sheetId,range,rule.midpoint):null;const maxValue=this.parsePoint(sheetId,range,rule.maximum,"max");if(minValue===null||maxValue===null||minValue>=maxValue||(midValue&&(minValue>=midValue||midValue>=maxValue))){return;}
const zone=this.getters.getRangeFromSheetXC(sheetId,range).zone;const colorCellArgs=[];if(rule.midpoint&&midValue){colorCellArgs.push({minValue,minColor:rule.minimum.color,colorDiffUnit:this.computeColorDiffUnits(minValue,midValue,rule.minimum.color,rule.midpoint.color),});colorCellArgs.push({minValue:midValue,minColor:rule.midpoint.color,colorDiffUnit:this.computeColorDiffUnits(midValue,maxValue,rule.midpoint.color,rule.maximum.color),});}
else{colorCellArgs.push({minValue,minColor:rule.minimum.color,colorDiffUnit:this.computeColorDiffUnits(minValue,maxValue,rule.minimum.color,rule.maximum.color),});}
for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.number){const value=clip(cell.value,minValue,maxValue);let color;if(colorCellArgs.length===2&&midValue){color=value<=midValue?this.colorCell(value,colorCellArgs[0].minValue,colorCellArgs[0].minColor,colorCellArgs[0].colorDiffUnit):this.colorCell(value,colorCellArgs[1].minValue,colorCellArgs[1].minColor,colorCellArgs[1].colorDiffUnit);}
else{color=this.colorCell(value,colorCellArgs[0].minValue,colorCellArgs[0].minColor,colorCellArgs[0].colorDiffUnit);}
if(!computedStyle[col])
computedStyle[col]=[];computedStyle[col][row]=computedStyle[col]?.[row]||{};computedStyle[col][row].fillColor=colorNumberString(color);}}}}
computeColorDiffUnits(minValue,maxValue,minColor,maxColor){const deltaValue=maxValue-minValue;const deltaColorR=((minColor>>16)%256)-((maxColor>>16)%256);const deltaColorG=((minColor>>8)%256)-((maxColor>>8)%256);const deltaColorB=(minColor%256)-(maxColor%256);const colorDiffUnitR=deltaColorR/deltaValue;const colorDiffUnitG=deltaColorG/deltaValue;const colorDiffUnitB=deltaColorB/deltaValue;return[colorDiffUnitR,colorDiffUnitG,colorDiffUnitB];}
colorCell(value,minValue,minColor,colorDiffUnit){const[colorDiffUnitR,colorDiffUnitG,colorDiffUnitB]=colorDiffUnit;const r=Math.round(((minColor>>16)%256)-colorDiffUnitR*(value-minValue));const g=Math.round(((minColor>>8)%256)-colorDiffUnitG*(value-minValue));const b=Math.round((minColor%256)-colorDiffUnitB*(value-minValue));return(r<<16)|(g<<8)|b;}
rulePredicate={CellIsRule:(target,rule)=>{const cell=this.getters.getEvaluatedCell(target);if(cell.type===CellValueType.error){return false;}
const[value0,value1]=rule.values.map((val)=>{if(val.startsWith("=")){return this.getters.evaluateFormula(target.sheetId,val)??"";}
return parseLiteral(val,DEFAULT_LOCALE);});if(isMatrix(value0)||isMatrix(value1)){return false;}
switch(rule.operator){case"IsEmpty":return cell.value.toString().trim()==="";case"IsNotEmpty":return cell.value.toString().trim()!=="";case"BeginsWith":if(value0===""){return false;}
return cell.value.toString().startsWith(value0.toString());case"EndsWith":if(value0===""){return false;}
return cell.value.toString().endsWith(value0.toString());case"Between":return cell.value>=value0&&cell.value<=value1;case"NotBetween":return!(cell.value>=value0&&cell.value<=value1);case"ContainsText":return cell.value.toString().indexOf(value0.toString())>-1;case"NotContains":return!cell.value||cell.value.toString().indexOf(value0.toString())===-1;case"GreaterThan":return cell.value>value0;case"GreaterThanOrEqual":return cell.value>=value0;case"LessThan":return cell.value<value0;case"LessThanOrEqual":return cell.value<=value0;case"NotEqual":if(value0===""){return false;}
return cell.value!==value0;case"Equal":if(value0===""){return true;}
return cell.value===value0;default:console.warn(_t("Not implemented operator %s for kind of conditional formatting:  %s",rule.operator,rule.type));}
return false;},};}
const VALID_RESULT={isValid:true};class EvaluationDataValidationPlugin extends UIPlugin{static getters=["getDataValidationInvalidCriterionValueMessage","getInvalidDataValidationMessage","getValidationResultForCellValue","isCellValidCheckbox","isDataValidationInvalid",];validationResults={};handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)||cmd.type==="EVALUATE_CELLS"||(cmd.type==="UPDATE_CELL"&&"content"in cmd)){this.validationResults={};return;}
switch(cmd.type){case"ADD_DATA_VALIDATION_RULE":case"REMOVE_DATA_VALIDATION_RULE":delete this.validationResults[cmd.sheetId];break;}}
isDataValidationInvalid(cellPosition){return!this.getValidationResultForCell(cellPosition).isValid;}
getInvalidDataValidationMessage(cellPosition){const validationResult=this.getValidationResultForCell(cellPosition);return validationResult.isValid?undefined:validationResult.error;}
getDataValidationInvalidCriterionValueMessage(criterionType,value){const evaluator=dataValidationEvaluatorRegistry.get(criterionType);if(value.startsWith("=")){return evaluator.allowedValues==="onlyLiterals"?_t("The value must not be a formula"):undefined;}
else if(evaluator.allowedValues==="onlyFormulas"){return _t("The value must be a formula");}
return evaluator.isCriterionValueValid(value)?undefined:evaluator.criterionValueErrorString;}
isCellValidCheckbox(cellPosition){if(!this.getters.isMainCellPosition(cellPosition)){return false;}
const rule=this.getters.getValidationRuleForCell(cellPosition);if(!rule||rule.criterion.type!=="isBoolean"){return false;}
return this.getValidationResultForCell(cellPosition).isValid;}
getValidationResultForCellValue(cellValue,cellPosition){const rule=this.getters.getValidationRuleForCell(cellPosition);if(!rule){return VALID_RESULT;}
const error=this.getRuleErrorForCellValue(cellValue,cellPosition,rule);return error?{error,rule,isValid:false}:VALID_RESULT;}
getValidationResultForCell(cellPosition){const{col,row,sheetId}=cellPosition;if(!this.validationResults[sheetId]){this.validationResults[sheetId]=this.computeSheetValidationResults(sheetId);}
return this.validationResults[sheetId][col]?.[row]?.()||VALID_RESULT;}
computeSheetValidationResults(sheetId){const validationResults={};const ranges=this.getters.getDataValidationRules(sheetId).map((rule)=>rule.ranges);for(const cellPosition of getCellPositionsInRanges(ranges.flat())){const{col,row}=cellPosition;if(!validationResults[col]){validationResults[col]=[];}
validationResults[col][row]=lazy(()=>{const evaluatedCell=this.getters.getEvaluatedCell(cellPosition);if(evaluatedCell.type===CellValueType.empty){return VALID_RESULT;}
return this.getValidationResultForCellValue(evaluatedCell.value,cellPosition);});}
return validationResults;}
getRuleErrorForCellValue(cellValue,cellPosition,rule){const{sheetId}=cellPosition;const criterion=rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);const offset=this.getCellOffsetInRule(cellPosition,rule);const evaluatedCriterionValues=this.getEvaluatedCriterionValues(sheetId,offset,criterion);const evaluatedCriterion={...criterion,values:evaluatedCriterionValues};if(evaluator.isValueValid(cellValue,evaluatedCriterion,this.getters,sheetId)){return undefined;}
return evaluator.getErrorString(evaluatedCriterion,this.getters,sheetId);}
getCellOffsetInRule(cellPosition,rule){const range=rule.ranges.find((range)=>isInside(cellPosition.col,cellPosition.row,range.zone));if(!range){throw new Error("The cell is not in any range of the rule");}
return{col:cellPosition.col-range.zone.left,row:cellPosition.row-range.zone.top,};}
getEvaluatedCriterionValues(sheetId,offset,criterion){return criterion.values.map((value)=>{if(!value.startsWith("=")){return value;}
try{const formula=compile(value);const translatedFormula=this.getters.getTranslatedCellFormula(sheetId,offset.col,offset.row,{...formula,dependencies:formula.dependencies.map((d)=>this.getters.getRangeFromSheetXC(sheetId,d)),});const evaluated=this.getters.evaluateFormula(sheetId,translatedFormula);return evaluated&&!isMatrix(evaluated)?evaluated.toString():"";}
catch(e){return e instanceof EvaluationError?e.errorType:CellErrorType.GenericError;}});}}
class HeaderSizeUIPlugin extends UIPlugin{static getters=["getRowSize","getHeaderSize"];tallestCellInRow={};ctx=document.createElement("canvas").getContext("2d");handle(cmd){switch(cmd.type){case"START":for(const sheetId of this.getters.getSheetIds()){this.initializeSheet(sheetId);}
break;case"CREATE_SHEET":{this.initializeSheet(cmd.sheetId);break;}
case"DUPLICATE_SHEET":{const tallestCells=deepCopy(this.tallestCellInRow[cmd.sheetId]);this.history.update("tallestCellInRow",cmd.sheetIdTo,tallestCells);break;}
case"DELETE_SHEET":const tallestCells={...this.tallestCellInRow};delete tallestCells[cmd.sheetId];this.history.update("tallestCellInRow",tallestCells);break;case"REMOVE_COLUMNS_ROWS":{if(cmd.dimension==="COL"){return;}
const tallestCells=removeIndexesFromArray(this.tallestCellInRow[cmd.sheetId],cmd.elements);this.history.update("tallestCellInRow",cmd.sheetId,tallestCells);break;}
case"ADD_COLUMNS_ROWS":{if(cmd.dimension==="COL"){return;}
const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);const newCells=Array(cmd.quantity).fill(undefined);const newTallestCells=insertItemsAtIndex(this.tallestCellInRow[cmd.sheetId],newCells,addIndex);this.history.update("tallestCellInRow",cmd.sheetId,newTallestCells);break;}
case"RESIZE_COLUMNS_ROWS":{const sheetId=cmd.sheetId;if(cmd.dimension==="ROW"){for(const row of cmd.elements){const tallestCell=this.getRowTallestCell(sheetId,row);this.history.update("tallestCellInRow",sheetId,row,tallestCell);}}
else{for(const row of range(0,this.getters.getNumberRows(sheetId))){for(const col of cmd.elements){this.updateRowSizeForCellChange(sheetId,row,col);}}}}
break;case"UPDATE_CELL":this.updateRowSizeForCellChange(cmd.sheetId,cmd.row,cmd.col);break;case"ADD_MERGE":case"REMOVE_MERGE":for(const target of cmd.target){for(const position of positions(target)){this.updateRowSizeForCellChange(cmd.sheetId,position.row,position.col);}}}
return;}
getRowSize(sheetId,row){return Math.round(this.getters.getUserRowSize(sheetId,row)??this.tallestCellInRow[sheetId][row]?.size??DEFAULT_CELL_HEIGHT);}
getHeaderSize(sheetId,dimension,index){if(this.getters.isHeaderHidden(sheetId,dimension,index)){return 0;}
return dimension==="ROW"?this.getRowSize(sheetId,index):this.getters.getColSize(sheetId,index);}
updateRowSizeForCellChange(sheetId,row,col){const tallestCellInRow=this.tallestCellInRow[sheetId]?.[row];if(tallestCellInRow?.cell.col===col){const newTallestCell=this.getRowTallestCell(sheetId,row);this.history.update("tallestCellInRow",sheetId,row,newTallestCell);}
const updatedCellHeight=this.getCellHeight({sheetId,col,row});if(updatedCellHeight<=DEFAULT_CELL_HEIGHT){return;}
if((!tallestCellInRow&&updatedCellHeight>DEFAULT_CELL_HEIGHT)||(tallestCellInRow&&updatedCellHeight>tallestCellInRow.size)){const newTallestCell={cell:{sheetId,col,row},size:updatedCellHeight};this.history.update("tallestCellInRow",sheetId,row,newTallestCell);}}
initializeSheet(sheetId){const tallestCells=[];for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const tallestCell=this.getRowTallestCell(sheetId,row);tallestCells.push(tallestCell);}
this.history.update("tallestCellInRow",sheetId,tallestCells);}
getCellHeight(position){if(this.isInMultiRowMerge(position)){return DEFAULT_CELL_HEIGHT;}
const cell=this.getters.getCell(position);const colSize=this.getters.getColSize(position.sheetId,position.col);return getDefaultCellHeight(this.ctx,cell,colSize);}
isInMultiRowMerge(position){const merge=this.getters.getMerge(position);return!!merge&&merge.bottom!==merge.top;}
getRowTallestCell(sheetId,row){const userRowSize=this.getters.getUserRowSize(sheetId,row);if(userRowSize!==undefined){return undefined;}
const cellIds=this.getters.getRowCells(sheetId,row);let maxHeight=0;let tallestCell=undefined;for(let i=0;i<cellIds.length;i++){const cell=this.getters.getCellById(cellIds[i]);if(!cell){continue;}
const position=this.getters.getCellPosition(cell.id);const cellHeight=this.getCellHeight(position);if(cellHeight>maxHeight&&cellHeight>DEFAULT_CELL_HEIGHT){maxHeight=cellHeight;tallestCell={cell:position,size:cellHeight};}}
if(tallestCell&&tallestCell.size>DEFAULT_CELL_HEIGHT){return tallestCell;}
return undefined;}}
class AutofillGenerator{cells;getters;index=0;direction;constructor(cells,getters,direction){this.cells=cells;this.getters=getters;this.direction=direction;}
next(){const genCell=this.cells[this.index++%this.cells.length];const rule=genCell.rule;const{cellData,tooltip}=autofillModifiersRegistry.get(rule.type).apply(rule,genCell.data,this.getters,this.direction);return{cellData,tooltip,origin:{col:genCell.data.col,row:genCell.data.row,},};}}
class AutofillPlugin extends UIPlugin{static layers=[5];static getters=["getAutofillTooltip"];autofillZone;steps;lastCellSelected={};direction;tooltip;allowDispatch(cmd){switch(cmd.type){case"AUTOFILL_SELECT":const sheetId=this.getters.getActiveSheetId();this.lastCellSelected.col=cmd.col===-1?this.lastCellSelected.col:clip(cmd.col,0,this.getters.getNumberCols(sheetId));this.lastCellSelected.row=cmd.row===-1?this.lastCellSelected.row:clip(cmd.row,0,this.getters.getNumberRows(sheetId));if(this.lastCellSelected.col!==undefined&&this.lastCellSelected.row!==undefined){return"Success";}
return"InvalidAutofillSelection";case"AUTOFILL_AUTO":const zone=this.getters.getSelectedZone();return zone.top===zone.bottom?"Success":"CancelledForUnknownReason";}
return"Success";}
handle(cmd){switch(cmd.type){case"AUTOFILL":this.autofill(true);break;case"AUTOFILL_SELECT":this.select(cmd.col,cmd.row);break;case"AUTOFILL_AUTO":this.autofillAuto();break;case"AUTOFILL_CELL":this.autoFillMerge(cmd.originCol,cmd.originRow,cmd.col,cmd.row);const sheetId=this.getters.getActiveSheetId();this.dispatch("UPDATE_CELL",{sheetId,col:cmd.col,row:cmd.row,style:cmd.style||null,content:cmd.content||"",format:cmd.format||"",});this.dispatch("SET_BORDER",{sheetId,col:cmd.col,row:cmd.row,border:cmd.border,});this.autofillCF(cmd.originCol,cmd.originRow,cmd.col,cmd.row);this.autofillDV(cmd.originCol,cmd.originRow,cmd.col,cmd.row);}}
getAutofillTooltip(){return this.tooltip;}
autofill(apply){if(!this.autofillZone||!this.steps||this.direction===undefined){this.tooltip=undefined;return;}
const source=this.getters.getSelectedZone();const target=this.autofillZone;switch(this.direction){case"down":for(let col=source.left;col<=source.right;col++){const xcs=[];for(let row=source.top;row<=source.bottom;row++){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let row=target.top;row<=target.bottom;row++){this.computeNewCell(generator,col,row,apply);}}
break;case"up":for(let col=source.left;col<=source.right;col++){const xcs=[];for(let row=source.bottom;row>=source.top;row--){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let row=target.bottom;row>=target.top;row--){this.computeNewCell(generator,col,row,apply);}}
break;case"left":for(let row=source.top;row<=source.bottom;row++){const xcs=[];for(let col=source.right;col>=source.left;col--){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let col=target.right;col>=target.left;col--){this.computeNewCell(generator,col,row,apply);}}
break;case"right":for(let row=source.top;row<=source.bottom;row++){const xcs=[];for(let col=source.left;col<=source.right;col++){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let col=target.left;col<=target.right;col++){this.computeNewCell(generator,col,row,apply);}}
break;}
if(apply){this.autofillZone=undefined;this.selection.resizeAnchorZone(this.direction,this.steps);this.lastCellSelected={};this.direction=undefined;this.steps=0;this.tooltip=undefined;}}
select(col,row){const source=this.getters.getSelectedZone();if(isInside(col,row,source)){this.autofillZone=undefined;return;}
this.direction=this.getDirection(col,row);switch(this.direction){case"up":this.saveZone(row,source.top-1,source.left,source.right);this.steps=source.top-row;break;case"down":this.saveZone(source.bottom+1,row,source.left,source.right);this.steps=row-source.bottom;break;case"left":this.saveZone(source.top,source.bottom,col,source.left-1);this.steps=source.left-col;break;case"right":this.saveZone(source.top,source.bottom,source.right+1,col);this.steps=col-source.right;break;}
this.autofill(false);}
autofillAuto(){const zone=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();let col=zone.left;let row=zone.bottom;if(col>0){let leftPosition={sheetId,col:col-1,row};while(this.getters.getCorrespondingFormulaCell(leftPosition)||this.getters.getCell(leftPosition)?.content){row+=1;leftPosition={sheetId,col:col-1,row};}}
if(row===zone.bottom){col=zone.right;if(col<=this.getters.getNumberCols(sheetId)){let rightPosition={sheetId,col:col+1,row};while(this.getters.getCorrespondingFormulaCell(rightPosition)||this.getters.getCell(rightPosition)?.content){row+=1;rightPosition={sheetId,col:col+1,row};}}}
if(row!==zone.bottom){this.select(zone.left,row-1);this.autofill(true);}}
computeNewCell(generator,col,row,apply){const{cellData,tooltip,origin}=generator.next();const{content,style,border,format}=cellData;this.tooltip=tooltip;if(apply){this.dispatch("AUTOFILL_CELL",{originCol:origin.col,originRow:origin.row,col,row,content,style,border,format,});}}
getRule(cell,cells){const rules=autofillRulesRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);const rule=rules.find((rule)=>rule.condition(cell,cells));return rule&&rule.generateRule(cell,cells);}
createGenerator(source){const nextCells=[];const cellsData=[];const sheetId=this.getters.getActiveSheetId();for(let xc of source){const{col,row}=toCartesian(xc);const cell=this.getters.getCell({sheetId,col,row});cellsData.push({col,row,cell,sheetId,});}
const cells=cellsData.map((cellData)=>cellData.cell);for(let cellData of cellsData){let rule={type:"COPY_MODIFIER"};if(cellData&&cellData.cell){const newRule=this.getRule(cellData.cell,cells);rule=newRule||rule;}
const border=this.getters.getCellBorder(cellData)||undefined;nextCells.push({data:{...cellData,border},rule,});}
return new AutofillGenerator(nextCells,this.getters,this.direction);}
saveZone(top,bottom,left,right){this.autofillZone={top,bottom,left,right};}
getDirection(col,row){const source=this.getters.getSelectedZone();const position={up:{number:source.top-row,value:"up"},down:{number:row-source.bottom,value:"down"},left:{number:source.left-col,value:"left"},right:{number:col-source.right,value:"right"},};if(Object.values(position).map((x)=>(x.number>0?1:0)).reduce((acc,value)=>acc+value)===1){return Object.values(position).find((x)=>(x.number>0?1:0)).value;}
const first=position.up.number>0?"up":"down";const second=position.left.number>0?"left":"right";return Math.abs(position[first].number)>=Math.abs(position[second].number)?position[first].value:position[second].value;}
autoFillMerge(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const position={sheetId,col,row};const originPosition={sheetId,col:originCol,row:originRow};if(this.getters.isInMerge(position)&&!this.getters.isInMerge(originPosition)){const zone=this.getters.getMerge(position);if(zone){this.dispatch("REMOVE_MERGE",{sheetId,target:[zone],});}}
const originMerge=this.getters.getMerge(originPosition);if(originMerge?.topLeft.col===originCol&&originMerge?.topLeft.row===originRow){this.dispatch("ADD_MERGE",{sheetId,target:[{top:row,bottom:row+originMerge.bottom-originMerge.top,left:col,right:col+originMerge.right-originMerge.left,},],});}}
autofillCF(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const cfOrigin=this.getters.getRulesByCell(sheetId,originCol,originRow);for(const cf of cfOrigin){const newCfRanges=this.getters.getAdaptedCfRanges(sheetId,cf,[toXC(col,row)],[]);if(newCfRanges){this.dispatch("ADD_CONDITIONAL_FORMAT",{cf:deepCopy(cf),ranges:newCfRanges.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}}}
autofillDV(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const cellPosition={sheetId,col:originCol,row:originRow};const dvOrigin=this.getters.getValidationRuleForCell(cellPosition);if(!dvOrigin){return;}
const dvRangesXcs=dvOrigin.ranges.map((range)=>this.getters.getRangeString(range,sheetId));const newDvRanges=recomputeZones(dvRangesXcs.concat(toXC(col,row)),[]);this.dispatch("ADD_DATA_VALIDATION_RULE",{rule:dvOrigin,ranges:newDvRanges.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}
drawGrid(renderingContext){if(!this.autofillZone){return;}
const{ctx,thinLineWidth}=renderingContext;const{x,y,width,height}=this.getters.getVisibleRect(this.autofillZone);if(width>0&&height>0){ctx.strokeStyle="black";ctx.lineWidth=thinLineWidth;ctx.setLineDash([3]);ctx.strokeRect(x,y,width,height);ctx.setLineDash([]);}}}
class AutomaticSumPlugin extends UIPlugin{static getters=["getAutomaticSums"];handle(cmd){switch(cmd.type){case"SUM_SELECTION":const sheetId=this.getters.getActiveSheetId();const{zones,anchor}=this.getters.getSelection();for(const zone of zones){const sums=this.getAutomaticSums(sheetId,zone,anchor.cell);this.dispatchCellUpdates(sheetId,sums);}
break;}}
getAutomaticSums(sheetId,zone,anchor){return this.shouldFindData(sheetId,zone)?this.sumAdjacentData(sheetId,zone,anchor):this.sumData(sheetId,zone);}
sumData(sheetId,zone){const dimensions=this.dimensionsToSum(sheetId,zone);const sums=this.sumDimensions(sheetId,zone,dimensions).filter(({zone})=>!this.getters.isEmpty(sheetId,zone));if(dimensions.has("ROW")&&dimensions.has("COL")){sums.push(this.sumTotal(zone));}
return sums;}
sumAdjacentData(sheetId,zone,anchor){const{col,row}=isInside(anchor.col,anchor.row,zone)?anchor:{col:zone.left,row:zone.top};const dataZone=this.findAdjacentData(sheetId,col,row);if(!dataZone){return[];}
if(this.getters.isSingleCellOrMerge(sheetId,zone)||isOneDimensional(union(dataZone,zone))){return[{position:{col,row},zone:dataZone}];}
else{return this.sumDimensions(sheetId,union(dataZone,zone),this.transpose(this.dimensionsToSum(sheetId,zone)));}}
findAdjacentData(sheetId,col,row){const sheet=this.getters.getSheet(sheetId);const mainCellPosition=this.getters.getMainCellPosition({sheetId,col,row});const zone=this.findSuitableZoneToSum(sheet,mainCellPosition.col,mainCellPosition.row);if(zone){return this.getters.expandZone(sheetId,zone);}
return undefined;}
findSuitableZoneToSum(sheet,col,row){const topCell=this.getters.getEvaluatedCell({sheetId:sheet.id,col,row:row-1});const leftCell=this.getters.getEvaluatedCell({sheetId:sheet.id,col:col-1,row});if(this.isNumber(leftCell)&&!this.isNumber(topCell)){return this.findHorizontalZone(sheet,col,row);}
const verticalZone=this.findVerticalZone(sheet,col,row);if(this.isZoneValid(verticalZone)){return verticalZone;}
const horizontalZone=this.findHorizontalZone(sheet,col,row);if(this.isZoneValid(horizontalZone)){return horizontalZone;}
return undefined;}
findVerticalZone(sheet,col,row){const zone={top:0,bottom:row-1,left:col,right:col,};const top=this.reduceZoneStart(sheet,zone,zone.bottom);return{...zone,top};}
findHorizontalZone(sheet,col,row){const zone={top:row,bottom:row,left:0,right:col-1,};const left=this.reduceZoneStart(sheet,zone,zone.right);return{...zone,left};}
reduceZoneStart(sheet,zone,end){const cells=this.getters.getEvaluatedCellsInZone(sheet.id,zone);const cellPositions=range(end,-1,-1);const invalidCells=cellPositions.filter((position)=>cells[position]&&!cells[position].isAutoSummable);const maxValidPosition=largeMax(invalidCells);const numberSequences=groupConsecutive(cellPositions.filter((position)=>this.isNumber(cells[position])));const firstSequence=numberSequences[0]||[];if(largeMax(firstSequence)<maxValidPosition){return Infinity;}
return largeMin(firstSequence);}
shouldFindData(sheetId,zone){return this.getters.isEmpty(sheetId,zone)||this.getters.isSingleCellOrMerge(sheetId,zone);}
isNumber(cell){return cell.type===CellValueType.number&&!(cell.format&&isDateTimeFormat(cell.format));}
isZoneValid(zone){return zone.bottom>=zone.top&&zone.right>=zone.left;}
lastColIsEmpty(sheetId,zone){return this.getters.isEmpty(sheetId,{...zone,left:zone.right});}
lastRowIsEmpty(sheetId,zone){return this.getters.isEmpty(sheetId,{...zone,top:zone.bottom});}
dimensionsToSum(sheetId,zone){const dimensions=new Set();if(isOneDimensional(zone)){dimensions.add(zoneToDimension(zone).numberOfCols===1?"COL":"ROW");return dimensions;}
if(this.lastColIsEmpty(sheetId,zone)){dimensions.add("ROW");}
if(this.lastRowIsEmpty(sheetId,zone)){dimensions.add("COL");}
if(dimensions.size===0){dimensions.add("COL");}
return dimensions;}
sumDimensions(sheetId,zone,dimensions){return[...(dimensions.has("COL")?this.sumColumns(zone,sheetId):[]),...(dimensions.has("ROW")?this.sumRows(zone,sheetId):[]),];}
sumTotal(zone){const{bottom,right}=zone;return{position:{col:right,row:bottom},zone:{...zone,top:bottom,right:right-1},};}
sumColumns(zone,sheetId){const target=this.nextEmptyRow(sheetId,{...zone,bottom:zone.bottom-1});zone={...zone,bottom:Math.min(zone.bottom,target.bottom-1)};return positions(target).map((position)=>({position,zone:{...zone,right:position.col,left:position.col},}));}
sumRows(zone,sheetId){const target=this.nextEmptyCol(sheetId,{...zone,right:zone.right-1});zone={...zone,right:Math.min(zone.right,target.right-1)};return positions(target).map((position)=>({position,zone:{...zone,top:position.row,bottom:position.row},}));}
dispatchCellUpdates(sheetId,sums){for(const sum of sums){const{col,row}=sum.position;this.dispatch("UPDATE_CELL",{sheetId,col,row,content:`=SUM(${this.getters.zoneToXC(sheetId, sum.zone)})`,});}}
nextEmptyRow(sheetId,zone){let start=zone.bottom+1;const{left,right}=zone;while(!this.getters.isEmpty(sheetId,{bottom:start,top:start,left,right})){start++;}
return{...zone,top:start,bottom:start,};}
nextEmptyCol(sheetId,zone){let start=zone.right+1;const{top,bottom}=zone;while(!this.getters.isEmpty(sheetId,{left:start,right:start,top,bottom})){start++;}
return{...zone,left:start,right:start,};}
transpose(dimensions){return new Set([...dimensions.values()].map((dimension)=>(dimension==="COL"?"ROW":"COL")));}}
class CellPopoverPlugin extends UIPlugin{static getters=["getCellPopover","getPersistentPopoverTypeAtPosition","hasOpenedPopover",];persistentPopover;allowDispatch(cmd){switch(cmd.type){case"OPEN_CELL_POPOVER":try{cellPopoverRegistry.get(cmd.popoverType);}
catch(error){return"InvalidCellPopover";}
return"Success";default:return"Success";}}
handle(cmd){switch(cmd.type){case"ACTIVATE_SHEET":this.persistentPopover=undefined;break;case"OPEN_CELL_POPOVER":this.persistentPopover={col:cmd.col,row:cmd.row,sheetId:this.getters.getActiveSheetId(),type:cmd.popoverType,};break;case"CLOSE_CELL_POPOVER":this.persistentPopover=undefined;break;}}
getCellPopover({col,row}){const sheetId=this.getters.getActiveSheetId();if(this.persistentPopover&&this.getters.isVisibleInViewport(this.persistentPopover)){const position=this.getters.getMainCellPosition(this.persistentPopover);const popover=cellPopoverRegistry.get(this.persistentPopover.type).onOpen?.(position,this.getters);return!popover?.isOpen?{isOpen:false}:{...popover,anchorRect:this.computePopoverAnchorRect(this.persistentPopover),};}
if(col===undefined||row===undefined||!this.getters.isVisibleInViewport({sheetId,col,row})){return{isOpen:false};}
const position=this.getters.getMainCellPosition({sheetId,col,row});const popover=cellPopoverRegistry.getAll().map((matcher)=>matcher.onHover?.(position,this.getters)).find((popover)=>popover?.isOpen);return!popover?.isOpen?{isOpen:false}:{...popover,anchorRect:this.computePopoverAnchorRect(position),};}
hasOpenedPopover(){return this.persistentPopover!==undefined;}
getPersistentPopoverTypeAtPosition({col,row}){if(this.persistentPopover&&this.persistentPopover.col===col&&this.persistentPopover.row===row){return this.persistentPopover.type;}
return undefined;}
computePopoverAnchorRect({col,row}){const sheetId=this.getters.getActiveSheetId();const merge=this.getters.getMerge({sheetId,col,row});if(merge){return this.getters.getVisibleRect(merge);}
return this.getters.getVisibleRect(positionToZone({col,row}));}}
class EventBus{subscriptions={};on(type,owner,callback){if(!callback){throw new Error("Missing callback");}
if(!this.subscriptions[type]){this.subscriptions[type]=[];}
this.subscriptions[type].push({owner,callback,});}
trigger(type,payload){const subs=this.subscriptions[type]||[];for(let i=0,iLen=subs.length;i<iLen;i++){const sub=subs[i];sub.callback.call(sub.owner,payload);}}
off(eventType,owner){const subs=this.subscriptions[eventType];if(subs){this.subscriptions[eventType]=subs.filter((s)=>s.owner!==owner);}}
clear(){this.subscriptions={};}}
otRegistry.addTransformation("ADD_COLUMNS_ROWS",["ADD_COLUMNS_ROWS"],addHeadersTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["ADD_COLUMNS_ROWS"],addHeadersTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["CREATE_CHART","UPDATE_CHART"],updateChartRangesTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["CREATE_CHART","UPDATE_CHART"],updateChartRangesTransformation);otRegistry.addTransformation("DELETE_SHEET",["MOVE_RANGES"],transformTargetSheetId);otRegistry.addTransformation("DELETE_FIGURE",["UPDATE_FIGURE","UPDATE_CHART"],updateChartFigure);otRegistry.addTransformation("CREATE_SHEET",["CREATE_SHEET"],createSheetTransformation);otRegistry.addTransformation("ADD_MERGE",["ADD_MERGE","REMOVE_MERGE","CREATE_FILTER_TABLE"],mergeTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["FREEZE_COLUMNS","FREEZE_ROWS"],freezeTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["FREEZE_COLUMNS","FREEZE_ROWS"],freezeTransformation);otRegistry.addTransformation("CREATE_FILTER_TABLE",["CREATE_FILTER_TABLE","ADD_MERGE"],createTableTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["GROUP_HEADERS","UNGROUP_HEADERS","FOLD_HEADER_GROUP","UNFOLD_HEADER_GROUP"],groupHeadersTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["GROUP_HEADERS","UNGROUP_HEADERS","FOLD_HEADER_GROUP","UNFOLD_HEADER_GROUP"],groupHeadersTransformation);function transformTargetSheetId(toTransform,executed){const deletedSheetId=executed.sheetId;if(toTransform.targetSheetId===deletedSheetId||toTransform.sheetId===deletedSheetId){return undefined;}
return toTransform;}
function updateChartFigure(toTransform,executed){if(toTransform.id===executed.id){return undefined;}
return toTransform;}
function updateChartRangesTransformation(toTransform,executed){return{...toTransform,definition:transformDefinition(toTransform.definition,executed),};}
function createSheetTransformation(toTransform,executed){if(toTransform.name===executed.name){return{...toTransform,name:toTransform.name?.match(/\d+/)?toTransform.name.replace(/\d+/,(n)=>(parseInt(n)+1).toString()):`${toTransform.name}~`,position:toTransform.position+1,};}
return toTransform;}
function mergeTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
const target=[];for(const zone1 of toTransform.target){for(const zone2 of executed.target){if(!overlap(zone1,zone2)){target.push({...zone1});}}}
if(target.length){return{...toTransform,target};}
return undefined;}
function freezeTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
const dimension=toTransform.type==="FREEZE_COLUMNS"?"COL":"ROW";if(dimension!==executed.dimension){return toTransform;}
let quantity=toTransform["quantity"];if(executed.type==="REMOVE_COLUMNS_ROWS"){const executedElements=[...executed.elements].sort((a,b)=>b-a);for(let removedElement of executedElements){if(quantity>removedElement){quantity--;}}}
if(executed.type==="ADD_COLUMNS_ROWS"){const executedBase=executed.position==="before"?executed.base-1:executed.base;quantity=quantity>executedBase?quantity+executed.quantity:quantity;}
return quantity>0?{...toTransform,quantity}:undefined;}
function createTableTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
for(const cmdTarget of toTransform.target){for(const executedCmdTarget of executed.target){if(overlap(executedCmdTarget,cmdTarget)){return undefined;}}}
return toTransform;}
function addHeadersTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId||toTransform.dimension!==executed.dimension){return toTransform;}
let result=undefined;if(executed.type==="REMOVE_COLUMNS_ROWS"){result=moveHeaderIndexesOnHeaderDeletion(executed.elements,[toTransform.base])[0];}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);result=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,[toTransform.base])[0];}
if(result===undefined){return undefined;}
return{...toTransform,base:result};}
function groupHeadersTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId||toTransform.dimension!==executed.dimension){return toTransform;}
const elementsToTransform=range(toTransform.start,toTransform.end+1);let results=[];if(executed.type==="REMOVE_COLUMNS_ROWS"){results=moveHeaderIndexesOnHeaderDeletion(executed.elements,elementsToTransform);}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);results=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,elementsToTransform);}
if(results.length===0){return undefined;}
return{...toTransform,start:Math.min(...results),end:Math.max(...results)};}
const transformations=[{match:isSheetDependent,fn:transformSheetId},{match:isTargetDependent,fn:transformTarget},{match:isZoneDependent,fn:transformZoneDependentCommand},{match:isPositionDependent,fn:transformPosition},{match:isHeadersDependant,fn:transformHeaders},{match:isRangeDependant,fn:transformRangesDependentCommand},];function transform(toTransform,executed){const specificTransform=otRegistry.getTransformation(toTransform.type,executed.type);return specificTransform?specificTransform(toTransform,executed):genericTransform(toTransform,executed);}
function transformAll(toTransform,executed){let transformedCommands=[...toTransform];for(const executedCommand of executed){transformedCommands=transformedCommands.map((cmd)=>transform(cmd,executedCommand)).filter(isDefined$1);}
return transformedCommands;}
function genericTransform(cmd,executed){for(const{match,fn}of transformations){if(match(cmd)){const result=fn(cmd,executed);if(result==="SKIP_TRANSFORMATION"){continue;}
if(result==="IGNORE_COMMAND"){return undefined;}
cmd=result;}}
return cmd;}
function transformSheetId(toTransform,executed){if(!("sheetId"in executed)){return toTransform;}
const deleteSheet=executed.type==="DELETE_SHEET"&&executed.sheetId;if(toTransform.sheetId===deleteSheet){return"IGNORE_COMMAND";}
else if(toTransform.type==="CREATE_SHEET"||executed.type==="CREATE_SHEET"||toTransform.sheetId!==executed.sheetId){return toTransform;}
return"SKIP_TRANSFORMATION";}
function transformTarget(cmd,executed){const transformSheetResult=transformSheetId(cmd,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":cmd;}
const target=[];for(const zone of cmd.target){const newZone=transformZone(zone,executed);if(newZone){target.push(newZone);}}
if(!target.length){return"IGNORE_COMMAND";}
return{...cmd,target};}
function transformZoneDependentCommand(cmd,executed){const transformSheetResult=transformSheetId(cmd,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":cmd;}
const newZone=transformZone(cmd.zone,executed);if(newZone){return{...cmd,zone:newZone};}
return"IGNORE_COMMAND";}
function transformRangesDependentCommand(toTransform,executed){if(!("sheetId"in executed)){return toTransform;}
const ranges=toTransform.ranges.map((range)=>transformRangeData(range,executed)).filter(isDefined$1);if(!ranges.length){return"IGNORE_COMMAND";}
return{...toTransform,ranges};}
function transformHeaders(toTransform,executed){const transformSheetResult=transformSheetId(toTransform,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":toTransform;}
if(executed.type!=="ADD_COLUMNS_ROWS"&&executed.type!=="REMOVE_COLUMNS_ROWS"){return"SKIP_TRANSFORMATION";}
if(executed.dimension!==toTransform.dimension){return toTransform;}
let result=[];if(executed.type==="REMOVE_COLUMNS_ROWS"){result=moveHeaderIndexesOnHeaderDeletion(executed.elements,toTransform.elements);}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);result=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,toTransform.elements);}
if(result.length===0){return"IGNORE_COMMAND";}
return{...toTransform,elements:result};}
function transformPosition(toTransform,executed){const transformSheetResult=transformSheetId(toTransform,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":toTransform;}
if(executed.type==="ADD_COLUMNS_ROWS"||executed.type==="REMOVE_COLUMNS_ROWS"){return transformPositionWithGrid(toTransform,executed);}
if(executed.type==="ADD_MERGE"){return transformPositionWithMerge(toTransform,executed);}
return"SKIP_TRANSFORMATION";}
function transformPositionWithGrid(toTransform,executed){const field=executed.dimension==="COL"?"col":"row";let base=toTransform[field];if(executed.type==="REMOVE_COLUMNS_ROWS"){const elements=[...executed.elements].sort((a,b)=>b-a);if(elements.includes(base)){return"IGNORE_COMMAND";}
for(let removedElement of elements){if(base>=removedElement){base--;}}}
if(executed.type==="ADD_COLUMNS_ROWS"){if(base>executed.base||(base===executed.base&&executed.position==="before")){base=base+executed.quantity;}}
return{...toTransform,[field]:base};}
function transformPositionWithMerge(toTransform,executed){for(const zone of executed.target){const sameTopLeft=toTransform.col===zone.left&&toTransform.row===zone.top;if(!sameTopLeft&&isInside(toTransform.col,toTransform.row,zone)){return"IGNORE_COMMAND";}}
return toTransform;}
class Revision{rootCommand;timestamp;id;clientId;_commands=[];_changes=[];constructor(id,clientId,commands,rootCommand,changes,timestamp){this.rootCommand=rootCommand;this.timestamp=timestamp;this.id=id;this.clientId=clientId;this._commands=[...commands];this._changes=changes?[...changes]:[];}
setChanges(changes){this._changes=changes;}
get commands(){return this._commands;}
get changes(){return this._changes;}}
class ClientDisconnectedError extends Error{}
class Session extends EventBus{revisions;transportService;serverRevisionId;clients={};clientId="local";debouncedMove;pendingMessages=[];waitingAck=false;waitingUndoRedoAck=false;isReplayingInitialRevisions=false;processedRevisions=new Set();uuidGenerator=new UuidGenerator();lastLocalOperation;constructor(revisions,transportService,serverRevisionId=DEFAULT_REVISION_ID){super();this.revisions=revisions;this.transportService=transportService;this.serverRevisionId=serverRevisionId;this.debouncedMove=debounce(this._move.bind(this),DEBOUNCE_TIME);}
canApplyOptimisticUpdate(){return!this.waitingUndoRedoAck;}
save(rootCommand,commands,changes){if(!commands.length||!changes.length||!this.canApplyOptimisticUpdate())
return;const revision=new Revision(this.uuidGenerator.uuidv4(),this.clientId,commands,rootCommand,changes,Date.now());this.revisions.append(revision.id,revision);if(rootCommand.type!=="REQUEST_REDO"){this.lastLocalOperation=revision;}
this.trigger("new-local-state-update",{id:revision.id});this.sendUpdateMessage({type:"REMOTE_REVISION",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:revision.id,clientId:revision.clientId,commands:revision.commands,});}
undo(revisionId){this.waitingUndoRedoAck=true;this.sendUpdateMessage({type:"REVISION_UNDONE",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:this.uuidGenerator.uuidv4(),undoneRevisionId:revisionId,});}
redo(revisionId){this.waitingUndoRedoAck=true;this.sendUpdateMessage({type:"REVISION_REDONE",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:this.uuidGenerator.uuidv4(),redoneRevisionId:revisionId,});}
move(position){this.debouncedMove(position);}
join(client){if(client){this.clients[client.id]=client;this.clientId=client.id;}
else{this.clients["local"]={id:"local",name:"local"};this.clientId="local";}
this.transportService.onNewMessage(this.clientId,this.onMessageReceived.bind(this));}
loadInitialMessages(messages){this.isReplayingInitialRevisions=true;for(const message of messages){this.onMessageReceived(message);}
this.isReplayingInitialRevisions=false;}
leave(){delete this.clients[this.clientId];this.transportService.leave(this.clientId);this.transportService.sendMessage({type:"CLIENT_LEFT",clientId:this.clientId,version:MESSAGE_VERSION,});}
snapshot(data){const snapshotId=this.uuidGenerator.uuidv4();this.transportService.sendMessage({type:"SNAPSHOT",nextRevisionId:snapshotId,serverRevisionId:this.serverRevisionId,data:{...data,revisionId:snapshotId},version:MESSAGE_VERSION,});}
getClient(){const client=this.clients[this.clientId];if(!client){throw new ClientDisconnectedError("The client left the session");}
return client;}
getConnectedClients(){return new Set(Object.values(this.clients).filter(isDefined$1));}
getRevisionId(){return this.serverRevisionId;}
isFullySynchronized(){return this.pendingMessages.length===0;}
getLastLocalNonEmptyRevision(){return this.lastLocalOperation;}
_move(position){if(!this.clients[this.clientId])
return;const currentPosition=this.clients[this.clientId]?.position;if(currentPosition?.col===position.col&&currentPosition.row===position.row&&currentPosition.sheetId===position.sheetId){return;}
const type=currentPosition?"CLIENT_MOVED":"CLIENT_JOINED";const client=this.getClient();this.clients[this.clientId]={...client,position};this.transportService.sendMessage({type,version:MESSAGE_VERSION,client:{...client,position},});}
onMessageReceived(message){if(this.isAlreadyProcessed(message))
return;if(this.isWrongServerRevisionId(message)){this.trigger("unexpected-revision-id");return;}
switch(message.type){case"CLIENT_MOVED":this.onClientMoved(message);break;case"CLIENT_JOINED":this.onClientJoined(message);break;case"CLIENT_LEFT":this.onClientLeft(message);break;case"REVISION_REDONE":{this.revisions.redo(message.redoneRevisionId,message.nextRevisionId,message.serverRevisionId);this.trigger("revision-redone",{revisionId:message.redoneRevisionId,commands:this.revisions.get(message.redoneRevisionId).commands,});break;}
case"REVISION_UNDONE":this.revisions.undo(message.undoneRevisionId,message.nextRevisionId,message.serverRevisionId);this.trigger("revision-undone",{revisionId:message.undoneRevisionId,commands:this.revisions.get(message.undoneRevisionId).commands,});break;case"REMOTE_REVISION":const{clientId,commands,timestamp}=message;const revision=new Revision(message.nextRevisionId,clientId,commands,undefined,undefined,timestamp);if(revision.clientId!==this.clientId){this.revisions.insert(revision.id,revision,message.serverRevisionId);const pendingCommands=this.pendingMessages.filter((msg)=>msg.type==="REMOTE_REVISION").map((msg)=>msg.commands).flat();this.trigger("remote-revision-received",{commands:transformAll(commands,pendingCommands),});}
break;case"SNAPSHOT_CREATED":{const revision=new Revision(message.nextRevisionId,"server",[],undefined,undefined,Date.now());this.revisions.insert(revision.id,revision,message.serverRevisionId);this.dropPendingHistoryMessages();this.trigger("snapshot");this.lastLocalOperation=undefined;break;}}
this.acknowledge(message);this.trigger("collaborative-event-received");}
onClientMoved(message){if(message.client.id!==this.clientId){this.clients[message.client.id]=message.client;}}
onClientJoined(message){if(message.client.id!==this.clientId){this.clients[message.client.id]=message.client;const client=this.clients[this.clientId];if(client){const{position}=client;if(position){this.transportService.sendMessage({type:"CLIENT_MOVED",version:MESSAGE_VERSION,client:{...client,position},});}}}}
onClientLeft(message){if(message.clientId!==this.clientId){delete this.clients[message.clientId];}}
sendUpdateMessage(message){this.pendingMessages.push(message);if(this.waitingAck){return;}
this.waitingAck=true;this.sendPendingMessage();}
sendPendingMessage(){let message=this.pendingMessages[0];if(!message)
return;if(message.type==="REMOTE_REVISION"){const revision=this.revisions.get(message.nextRevisionId);if(revision.commands.length===0){this.revisions.drop(revision.id);const revisionIds=this.pendingMessages.filter((message)=>message.type==="REMOTE_REVISION").map((message)=>message.nextRevisionId);this.trigger("pending-revisions-dropped",{revisionIds});this.waitingAck=false;this.waitingUndoRedoAck=false;this.pendingMessages=[];return;}
message={...message,clientId:revision.clientId,commands:revision.commands,};}
if(this.isReplayingInitialRevisions){throw new Error(`Trying to send a new revision while replaying initial revision. This can lead to endless dispatches every time the spreadsheet is open.
      ${JSON.stringify(message)}`);}
this.transportService.sendMessage({...message,serverRevisionId:this.serverRevisionId,});}
acknowledge(message){if(message.type==="REVISION_UNDONE"||message.type==="REVISION_REDONE"){this.waitingUndoRedoAck=false;}
switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":case"SNAPSHOT_CREATED":this.waitingAck=false;this.pendingMessages=this.pendingMessages.filter((msg)=>msg.nextRevisionId!==message.nextRevisionId);this.serverRevisionId=message.nextRevisionId;this.processedRevisions.add(message.nextRevisionId);this.sendPendingMessage();break;}}
isAlreadyProcessed(message){if(message.type==="CLIENT_MOVED"&&message.client.id===this.clientId){return true;}
switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":return this.processedRevisions.has(message.nextRevisionId);default:return false;}}
isWrongServerRevisionId(message){switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":case"SNAPSHOT_CREATED":return message.serverRevisionId!==this.serverRevisionId;default:return false;}}
dropPendingHistoryMessages(){this.waitingUndoRedoAck=false;this.pendingMessages=this.pendingMessages.filter(({type})=>type!=="REVISION_REDONE"&&type!=="REVISION_UNDONE");}}
function randomChoice(arr){return arr[Math.floor(Math.random()*arr.length)];}
const colors=["#ff851b","#0074d9","#7fdbff","#b10dc9","#39cccc","#f012be","#3d9970","#111111","#ff4136","#aaaaaa","#85144b","#001f3f",];class CollaborativePlugin extends UIPlugin{static getters=["getClientsToDisplay","getClient","getConnectedClients","isFullySynchronized",];static layers=[6];availableColors=new Set(colors);colors={};session;constructor(config){super(config);this.session=config.session;}
isPositionValid(position){return(position.row<this.getters.getNumberRows(position.sheetId)&&position.col<this.getters.getNumberCols(position.sheetId));}
chooseNewColor(){if(this.availableColors.size===0){this.availableColors=new Set(colors);}
const color=randomChoice([...this.availableColors.values()]);this.availableColors.delete(color);return color;}
getClient(){return this.session.getClient();}
getConnectedClients(){return this.session.getConnectedClients();}
isFullySynchronized(){return this.session.isFullySynchronized();}
getClientsToDisplay(){try{this.getters.getClient();}
catch(e){if(e instanceof ClientDisconnectedError){return[];}
else{throw e;}}
const sheetId=this.getters.getActiveSheetId();const clients=[];for(const client of this.getters.getConnectedClients()){if(client.id!==this.getters.getClient().id&&client.position&&client.position.sheetId===sheetId&&this.isPositionValid(client.position)){const position=client.position;if(!this.colors[client.id]){this.colors[client.id]=this.chooseNewColor();}
const color=this.colors[client.id];clients.push({...client,position,color});}}
return clients;}
drawGrid(renderingContext){if(this.getters.isDashboard()){return;}
const{ctx,thinLineWidth}=renderingContext;const activeSheetId=this.getters.getActiveSheetId();for(const client of this.getClientsToDisplay()){const{row,col}=client.position;const zone=this.getters.expandZone(activeSheetId,{top:row,bottom:row,left:col,right:col,});const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width<=0||height<=0){continue;}
const color=client.color;const cellBackgroundColor=`${color}10`;ctx.fillStyle=cellBackgroundColor;ctx.lineWidth=4*thinLineWidth;ctx.strokeStyle=color;ctx.globalCompositeOperation="multiply";ctx.fillRect(x,y,width,height);ctx.globalCompositeOperation="source-over";ctx.strokeRect(x,y,width,height);ctx.font=`bold ${DEFAULT_FONT_SIZE + 1}px ${DEFAULT_FONT}`;}}}
class ClipboardCellsAbstractState{getters;dispatch;selection;operation;sheetId;constructor(operation,getters,dispatch,selection){this.getters=getters;this.dispatch=dispatch;this.selection=selection;this.operation=operation;this.sheetId=getters.getActiveSheetId();}
isCutAllowed(target){return"Success";}
isPasteAllowed(target,clipboardOption){return"Success";}
addMissingDimensions(width,height,col,row){const sheetId=this.getters.getActiveSheetId();const missingRows=height+row-this.getters.getNumberRows(sheetId);if(missingRows>0){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"ROW",base:this.getters.getNumberRows(sheetId)-1,sheetId,quantity:missingRows,position:"after",});}
const missingCols=width+col-this.getters.getNumberCols(sheetId);if(missingCols>0){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:this.getters.getNumberCols(sheetId)-1,sheetId,quantity:missingCols,position:"after",});}}
isColRowDirtyingClipboard(position,dimension){return false;}
drawClipboard(renderingContext){}}
class ClipboardCellsState extends ClipboardCellsAbstractState{cells;copiedTables;zones;uuidGenerator=new UuidGenerator();constructor(zones,operation,getters,dispatch,selection){super(operation,getters,dispatch,selection);if(!zones.length){this.cells=[[]];this.zones=[];this.copiedTables=[];return;}
const lefts=new Set(zones.map((z)=>z.left));const rights=new Set(zones.map((z)=>z.right));const tops=new Set(zones.map((z)=>z.top));const bottoms=new Set(zones.map((z)=>z.bottom));const areZonesCompatible=(tops.size===1&&bottoms.size===1)||(lefts.size===1&&rights.size===1);const clippedZones=areZonesCompatible?mergeOverlappingZones(zones):[zones[zones.length-1]];const cellsPosition=clippedZones.map((zone)=>positions(zone)).flat();const columnsIndex=[...new Set(cellsPosition.map((p)=>p.col))].sort((a,b)=>a-b);const rowsIndex=[...new Set(cellsPosition.map((p)=>p.row))].sort((a,b)=>a-b);const cellsInClipboard=[];const sheetId=getters.getActiveSheetId();for(let row of rowsIndex){let cellsInRow=[];for(let col of columnsIndex){const position={col,row,sheetId};const spreader=getters.getArrayFormulaSpreadingOn(position);let cell=getters.getCell(position);const evaluatedCell=getters.getEvaluatedCell(position);if(spreader){const isSpreaderCopied=rowsIndex.includes(spreader.row)&&columnsIndex.includes(spreader.col);const content=isSpreaderCopied?"":formatValue(evaluatedCell.value,{locale:getters.getLocale()});cell={id:cell?.id||"",style:cell?.style,format:evaluatedCell.format,content,isFormula:false,};}
cellsInRow.push({cell,border:getters.getCellBorder(position)||undefined,evaluatedCell,position,});}
cellsInClipboard.push(cellsInRow);}
const tables=[];for(const zone of zones){for(const table of this.getters.getFilterTablesInZone(sheetId,zone)){const values=[];for(const col of range(table.zone.left,table.zone.right+1)){values.push(this.getters.getFilterValues({sheetId,col,row:table.zone.top}));}
tables.push({filtersValues:values,zone:table.zone});}}
this.cells=cellsInClipboard;this.zones=clippedZones;this.copiedTables=tables;}
isCutAllowed(target){if(target.length!==1){return"WrongCutSelection";}
return"Success";}
isPasteAllowed(target,clipboardOption){const sheetId=this.getters.getActiveSheetId();if(this.operation==="CUT"&&clipboardOption?.pasteOption!==undefined){return"WrongPasteOption";}
if(target.length>1){if(this.cells.length>1||this.cells[0].length>1){return"WrongPasteSelection";}}
const clipboardHeight=this.cells.length;const clipboardWidth=this.cells[0].length;for(let zone of this.getPasteZones(target)){if(this.getters.doesIntersectMerge(sheetId,zone)){if(target.length>1||!this.getters.isSingleCellOrMerge(sheetId,target[0])||clipboardHeight*clipboardWidth!==1){return"WillRemoveExistingMerge";}}}
const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);for(const zone of this.getPasteZones(target)){if((zone.left<xSplit&&zone.right>=xSplit)||(zone.top<ySplit&&zone.bottom>=ySplit)){return"FrozenPaneOverlap";}}
return"Success";}
paste(target,options){if(this.operation==="COPY"){this.pasteFromCopy(target,options);}
else{this.pasteFromCut(target,options);}
const height=this.cells.length;const width=this.cells[0].length;const isCutOperation=this.operation==="CUT";if(options?.selectTarget){this.selectPastedZone(width,height,isCutOperation,target);}}
pasteFromCopy(target,options){if(target.length===1){const height=this.cells.length;const width=this.cells[0].length;const pasteZones=this.pastedZones(target,width,height);for(const zone of pasteZones){this.pasteZone(zone.left,zone.top,options);}}
else{for(const zone of target){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){this.pasteZone(col,row,options);}}}}
if(options?.pasteOption===undefined){this.pasteCopiedTables(target);}}
pasteFromCut(target,options){this.clearClippedZones();const selection=target[0];this.pasteZone(selection.left,selection.top,options);this.dispatch("MOVE_RANGES",{target:this.zones,sheetId:this.sheetId,targetSheetId:this.getters.getActiveSheetId(),col:selection.left,row:selection.top,});for(const filterTable of this.copiedTables){this.dispatch("REMOVE_FILTER_TABLE",{sheetId:this.sheetId,target:[filterTable.zone],});}
this.pasteCopiedTables(target);}
pastedZones(target,originWidth,originHeight){const selection=target[0];const repeatHorizontally=Math.max(1,Math.floor((selection.right+1-selection.left)/originWidth));const repeatVertically=Math.max(1,Math.floor((selection.bottom+1-selection.top)/originHeight));const zones=[];for(let x=0;x<repeatHorizontally;x++){for(let y=0;y<repeatVertically;y++){const top=selection.top+y*originHeight;const left=selection.left+x*originWidth;zones.push({left,top,bottom:top+originHeight-1,right:left+originWidth-1,});}}
return zones;}
getPasteZones(target){const cells=this.cells;if(!cells.length||!cells[0].length){return target;}
const pasteZones=[];const height=cells.length;const width=cells[0].length;const selection=target[target.length-1];const col=selection.left;const row=selection.top;const repetitionCol=Math.max(1,Math.floor((selection.right+1-col)/width));const repetitionRow=Math.max(1,Math.floor((selection.bottom+1-row)/height));for(let x=1;x<=repetitionCol;x++){for(let y=1;y<=repetitionRow;y++){pasteZones.push({left:col,top:row,right:col-1+x*width,bottom:row-1+y*height,});}}
return pasteZones;}
selectPastedZone(width,height,isCutOperation,target){const selection=target[0];const col=selection.left;const row=selection.top;if(height>1||width>1||isCutOperation){const zones=this.pastedZones(target,width,height);const newZone=isCutOperation?zones[0]:union(...zones);this.selection.selectZone({cell:{col,row},zone:newZone},{scrollIntoView:false});}}
clearClippedZones(){for(const row of this.cells){for(const cell of row){if(cell?.cell){this.dispatch("CLEAR_CELL",cell.position);}}}
this.dispatch("CLEAR_FORMATTING",{sheetId:this.sheetId,target:this.zones,});}
pasteZone(col,row,clipboardOptions){const height=this.cells.length;const width=this.cells[0].length;const shouldPasteCF=clipboardOptions?.pasteOption!=="onlyValue"&&clipboardOptions?.shouldPasteCF;const shouldPasteDV=!clipboardOptions?.pasteOption;const sheetId=this.getters.getActiveSheetId();this.addMissingDimensions(width,height,col,row);for(let r=0;r<height;r++){const rowCells=this.cells[r];for(let c=0;c<width;c++){const origin=rowCells[c];if(!origin){continue;}
const position={col:col+c,row:row+r,sheetId:sheetId};if(this.operation!=="CUT"){this.pasteMergeIfExist(origin.position,position);}
this.pasteCell(origin,position,this.operation,clipboardOptions);if(shouldPasteCF){this.pasteCf(origin.position,position);}
if(shouldPasteDV){this.pasteDataValidation(origin.position,position);}}}}
pasteCell(origin,target,operation,clipboardOption){const{sheetId,col,row}=target;const targetCell=this.getters.getEvaluatedCell(target);if(clipboardOption?.pasteOption==="onlyValue"){const locale=this.getters.getLocale();const content=formatValue(origin.evaluatedCell.value,{locale});this.dispatch("UPDATE_CELL",{...target,content});return;}
const targetBorders=this.getters.getCellBorder(target);const originBorders=origin.border;const border={top:targetBorders?.top||originBorders?.top,bottom:targetBorders?.bottom||originBorders?.bottom,left:targetBorders?.left||originBorders?.left,right:targetBorders?.right||originBorders?.right,};this.dispatch("SET_BORDER",{sheetId,col,row,border});if(clipboardOption?.pasteOption==="onlyFormat"){this.dispatch("UPDATE_CELL",{...target,style:origin.cell?.style??null,format:origin.cell?.format??origin.evaluatedCell.format??targetCell.format,});return;}
const content=origin.cell&&origin.cell.isFormula&&operation==="COPY"?this.getters.getTranslatedCellFormula(sheetId,col-origin.position.col,row-origin.position.row,origin.cell.compiledFormula):origin.cell?.content;if(content!==""||origin.cell?.format||origin.cell?.style){this.dispatch("UPDATE_CELL",{...target,content,style:origin.cell?.style||null,format:origin.cell?.format,});}
else if(targetCell){this.dispatch("CLEAR_CELL",target);}}
pasteMergeIfExist(origin,target){let{sheetId,col,row}=origin;const{col:mainCellColOrigin,row:mainCellRowOrigin}=this.getters.getMainCellPosition(origin);if(mainCellColOrigin===col&&mainCellRowOrigin===row){const merge=this.getters.getMerge(origin);if(!merge){return;}
({sheetId,col,row}=target);this.dispatch("ADD_MERGE",{sheetId,force:true,target:[{left:col,top:row,right:col+merge.right-merge.left,bottom:row+merge.bottom-merge.top,},],});}}
pasteCopiedTables(target){const sheetId=this.getters.getActiveSheetId();const selection=target[0];const cutZone=this.zones[0];const cutOffset=[selection.left-cutZone.left,selection.top-cutZone.top,];for(const table of this.copiedTables){const newTableZone=createAdaptedZone(table.zone,"both","MOVE",cutOffset);this.dispatch("CREATE_FILTER_TABLE",{sheetId,target:[newTableZone]});for(const i of range(0,table.filtersValues.length)){this.dispatch("UPDATE_FILTER",{sheetId,col:newTableZone.left+i,row:newTableZone.top,hiddenValues:table.filtersValues[i],});}}}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:this.getPlainTextContent(),[ClipboardMIMEType.Html]:this.getHTMLContent(),};}
getPlainTextContent(){return(this.cells.map((cells)=>{return cells.map((c)=>this.getters.shouldShowFormulas()&&c?.cell?.isFormula?c.cell?.content||"":c?.evaluatedCell?.formattedValue||"").join("\t");}).join("\n")||"\t");}
getHTMLContent(){if(this.cells.length===1&&this.cells[0].length===1){if(!this.cells[0][0]){return"";}
return this.getters.getCellText(this.cells[0][0].position);}
let htmlTable='<table border="1" style="border-collapse:collapse">';for(const row of this.cells){htmlTable+="<tr>";for(const cell of row){if(!cell){continue;}
const cssStyle=cssPropertiesToCss(cellStyleToCss(this.getters.getCellComputedStyle(cell.position)));const cellText=this.getters.getCellText(cell.position);htmlTable+=`<td style="${cssStyle}">`+xmlEscape(cellText)+"</td>";}
htmlTable+="</tr>";}
htmlTable+="</table>";return htmlTable;}
isColRowDirtyingClipboard(position,dimension){if(!this.zones){return false;}
for(let zone of this.zones){if(dimension==="COL"&&position<=zone.right){return true;}
if(dimension==="ROW"&&position<=zone.bottom){return true;}}
return false;}
drawClipboard(renderingContext){const{ctx,thinLineWidth}=renderingContext;if(this.sheetId!==this.getters.getActiveSheetId()||!this.zones||!this.zones.length){return;}
ctx.setLineDash([8,5]);ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=3.3*thinLineWidth;for(const zone of this.zones){const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width>0&&height>0){ctx.strokeRect(x,y,width,height);}}}
pasteCf(origin,target){const xc=toXC(target.col,target.row);for(let rule of this.getters.getConditionalFormats(origin.sheetId)){for(let range of rule.ranges){if(isInside(origin.col,origin.row,this.getters.getRangeFromSheetXC(origin.sheetId,range).zone)){const cf=rule;const toRemoveRange=[];if(this.operation==="CUT"){toRemoveRange.push(toXC(origin.col,origin.row));}
if(origin.sheetId===target.sheetId){this.adaptCFRules(origin.sheetId,cf,[xc],toRemoveRange);}
else{this.adaptCFRules(origin.sheetId,cf,[],toRemoveRange);const cfToCopyTo=this.getCFToCopyTo(target.sheetId,cf);this.adaptCFRules(target.sheetId,cfToCopyTo,[xc],[]);}}}}}
adaptCFRules(sheetId,cf,toAdd,toRemove){const newRangesXC=this.getters.getAdaptedCfRanges(sheetId,cf,toAdd,toRemove);if(!newRangesXC){return;}
if(newRangesXC.length===0){this.dispatch("REMOVE_CONDITIONAL_FORMAT",{id:cf.id,sheetId});return;}
this.dispatch("ADD_CONDITIONAL_FORMAT",{cf:{id:cf.id,rule:cf.rule,stopIfTrue:cf.stopIfTrue,},ranges:newRangesXC.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}
getCFToCopyTo(targetSheetId,originCF){const cfInTarget=this.getters.getConditionalFormats(targetSheetId).find((cf)=>cf.stopIfTrue===originCF.stopIfTrue&&deepEquals(cf.rule,originCF.rule));return cfInTarget?cfInTarget:{...originCF,id:this.uuidGenerator.uuidv4(),ranges:[]};}
pasteDataValidation(origin,target){const rule=this.getters.getValidationRuleForCell(origin);if(!rule){return;}
const xc=toXC(target.col,target.row);for(const range of rule.ranges){if(isInside(origin.col,origin.row,range.zone)){const toRemoveRange=[];if(this.operation==="CUT"){toRemoveRange.push(toXC(origin.col,origin.row));}
if(origin.sheetId===target.sheetId){this.adaptDataValidationRule(origin.sheetId,rule,[xc],toRemoveRange);}
else{this.adaptDataValidationRule(origin.sheetId,rule,[],toRemoveRange);let copyToRule=this.getDataValidationRuleToCopyTo(target.sheetId,rule);this.adaptDataValidationRule(target.sheetId,copyToRule,[xc],[]);}}}}
getDataValidationRuleToCopyTo(targetSheetId,originRule){const ruleInTargetSheet=this.getters.getDataValidationRules(targetSheetId).find((rule)=>deepEquals(originRule.criterion,rule.criterion)&&originRule.isBlocking===rule.isBlocking);return ruleInTargetSheet?ruleInTargetSheet:{...originRule,id:this.uuidGenerator.uuidv4(),ranges:[]};}
adaptDataValidationRule(sheetId,rule,toAdd,toRemove){const dvRangesXcs=rule.ranges.map((range)=>this.getters.getRangeString(range,sheetId));const newRangesXC=recomputeZones([...dvRangesXcs,...toAdd],toRemove);if(newRangesXC.length===0){this.dispatch("REMOVE_DATA_VALIDATION_RULE",{sheetId,id:rule.id});return;}
this.dispatch("ADD_DATA_VALIDATION_RULE",{rule,ranges:newRangesXC.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}}
class DataCleanupPlugin extends UIPlugin{allowDispatch(cmd){switch(cmd.type){case"REMOVE_DUPLICATES":return this.checkValidations(cmd,this.chainValidations(this.checkSingleRangeSelected,this.checkNoMergeInZone,this.checkRangeContainsValues,this.checkColumnsIncludedInZone),this.chainValidations(this.checkNoColumnProvided,this.checkColumnsAreUnique));}
return"Success";}
handle(cmd){switch(cmd.type){case"REMOVE_DUPLICATES":this.removeDuplicates(cmd.columns,cmd.hasHeader);break;case"TRIM_WHITESPACE":this.trimWhitespace();break;}}
removeDuplicates(columnsToAnalyze,hasHeader){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();if(hasHeader){zone.top+=1;}
const uniqueRowsIndexes=this.getUniqueRowsIndexes(sheetId,zone.top,zone.bottom,columnsToAnalyze);const numberOfUniqueRows=uniqueRowsIndexes.length;if(numberOfUniqueRows===zoneToDimension(zone).numberOfRows){this.notifyRowsRemovedAndRemaining(0,numberOfUniqueRows);return;}
const rowsToKeep=uniqueRowsIndexes.map((rowIndex)=>({left:zone.left,top:rowIndex,right:zone.right,bottom:rowIndex,}));const state=new ClipboardCellsState(rowsToKeep,"COPY",this.getters,this.dispatch,this.selection);for(const{col,row}of positions(zone)){this.dispatch("CLEAR_CELL",{col,row,sheetId});}
const zonePasted={left:zone.left,top:zone.top,right:zone.left,bottom:zone.top,};state.paste([zonePasted]);const remainingZone={left:zone.left,top:zone.top-(hasHeader?1:0),right:zone.right,bottom:zone.top+numberOfUniqueRows-1,};this.selection.selectZone({cell:{col:remainingZone.left,row:remainingZone.top},zone:remainingZone,});const removedRows=zone.bottom-zone.top+1-numberOfUniqueRows;this.notifyRowsRemovedAndRemaining(removedRows,numberOfUniqueRows);}
getUniqueRowsIndexes(sheetId,top,bottom,columns){const uniqueRows=new Map();for(const row of range(top,bottom+1)){const cellsValuesInRow=columns.map((col)=>{return this.getters.getEvaluatedCell({sheetId,col,row,}).value;});const isRowUnique=!Object.values(uniqueRows).some((uniqueRow)=>deepEquals(uniqueRow,cellsValuesInRow));if(isRowUnique){uniqueRows[row]=cellsValuesInRow;}}
return Object.keys(uniqueRows).map((key)=>parseInt(key));}
notifyRowsRemovedAndRemaining(removedRows,remainingRows){this.ui.notifyUI({type:"info",text:_t("%s duplicate rows found and removed.\n%s unique rows remain.",removedRows.toString(),remainingRows.toString()),sticky:false,});}
checkSingleRangeSelected(){const zones=this.getters.getSelectedZones();if(zones.length!==1){return"MoreThanOneRangeSelected";}
return"Success";}
checkNoMergeInZone(){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();const mergesInZone=this.getters.getMergesInZone(sheetId,zone);if(mergesInZone.length>0){return"WillRemoveExistingMerge";}
return"Success";}
checkRangeContainsValues(cmd){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();if(cmd.hasHeader){zone.top+=1;}
const evaluatedCells=this.getters.getEvaluatedCellsInZone(sheetId,zone);if(evaluatedCells.every((evaluatedCel)=>evaluatedCel.type==="empty")){return"EmptyTarget";}
return"Success";}
checkNoColumnProvided(cmd){if(cmd.columns.length===0){return"NoColumnsProvided";}
return"Success";}
checkColumnsIncludedInZone(cmd){const zone=this.getters.getSelectedZone();const columnsToAnalyze=cmd.columns;if(columnsToAnalyze.some((colIndex)=>colIndex<zone.left||colIndex>zone.right)){return"ColumnsNotIncludedInZone";}
return"Success";}
checkColumnsAreUnique(cmd){if(cmd.columns.length!==new Set(cmd.columns).size){return"DuplicatesColumnsSelected";}
return"Success";}
trimWhitespace(){const zones=this.getters.getSelectedZones();const sheetId=this.getters.getActiveSheetId();let count=0;for(const{col,row}of zones.map(positions).flat()){const cell=this.getters.getCell({col,row,sheetId});if(!cell){continue;}
const trimmedContent=trimContent(cell.content);if(trimmedContent!==cell.content){count+=1;this.dispatch("UPDATE_CELL",{sheetId,col,row,content:trimmedContent,});}}
const text=count?_t("Trimmed whitespace from %s cells.",count):_t("No selected cells had whitespace trimmed.");this.ui.notifyUI({type:"info",text:text,sticky:false,});}}
const BORDER_COLOR="#8B008B";const BACKGROUND_COLOR="#8B008B33";var Direction;(function(Direction){Direction[Direction["previous"]=-1]="previous";Direction[Direction["current"]=0]="current";Direction[Direction["next"]=1]="next";})(Direction||(Direction={}));class FindAndReplacePlugin extends UIPlugin{static layers=[3];static getters=["getSearchMatches","getCurrentSelectedMatchIndex"];searchMatches=[];selectedMatchIndex=null;currentSearchRegex=null;searchOptions={matchCase:false,exactMatch:false,searchFormulas:false,};toSearch="";isSearchDirty=false;handle(cmd){switch(cmd.type){case"UPDATE_SEARCH":this.updateSearch(cmd.toSearch,cmd.searchOptions);break;case"CLEAR_SEARCH":this.clearSearch();break;case"SELECT_SEARCH_PREVIOUS_MATCH":this.selectNextCell(Direction.previous);break;case"SELECT_SEARCH_NEXT_MATCH":this.selectNextCell(Direction.next);break;case"REPLACE_SEARCH":this.replace(cmd.replaceWith);break;case"REPLACE_ALL_SEARCH":this.replaceAll(cmd.replaceWith);break;case"UNDO":case"REDO":case"REMOVE_FILTER_TABLE":case"UPDATE_FILTER":case"REMOVE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"EVALUATE_CELLS":case"UPDATE_CELL":this.isSearchDirty=true;break;case"ACTIVATE_SHEET":this.refreshSearch();break;}}
finalize(){if(this.isSearchDirty){this.refreshSearch();this.isSearchDirty=false;}}
getSearchMatches(){return this.searchMatches;}
getCurrentSelectedMatchIndex(){return this.selectedMatchIndex;}
updateSearch(toSearch,searchOptions){this.searchOptions=searchOptions;if(toSearch!==this.toSearch){this.selectedMatchIndex=null;}
this.toSearch=toSearch;this.updateRegex();this.refreshSearch();}
refreshSearch(){const matches=this.findMatches();this.searchMatches=matches;this.selectNextCell(Direction.current);}
updateRegex(){let searchValue=escapeRegExp(this.toSearch);const flags=!this.searchOptions.matchCase?"i":"";if(this.searchOptions.exactMatch){searchValue=`^${searchValue}$`;}
this.currentSearchRegex=RegExp(searchValue,flags);}
findMatches(){const sheetId=this.getters.getActiveSheetId();const cells=this.getters.getCells(sheetId);const matches=[];if(this.toSearch&&this.currentSearchRegex){for(const cell of Object.values(cells)){const{col,row}=this.getters.getCellPosition(cell.id);const cellPosition={sheetId,col,row};const isColHidden=this.getters.isColHidden(sheetId,col);const isRowHidden=this.getters.isRowHidden(sheetId,row);if(isColHidden||isRowHidden){continue;}
if(this.currentSearchRegex.test(this.getSearchableString(cellPosition))){const match={col,row,selected:false};matches.push(match);}
for(const spreadPosition of this.getters.getSpreadPositionsOf(cellPosition)){if(this.currentSearchRegex.test(this.getSearchableString(spreadPosition))){const match={col:spreadPosition.col,row:spreadPosition.row,selected:false,};matches.push(match);}}}}
return matches.sort(this.sortByRowThenColumn);}
sortByRowThenColumn(a,b){if(a.row===b.row){return a.col-b.col;}
return a.row>b.row?1:-1;}
selectNextCell(indexChange){const matches=this.searchMatches;if(!matches.length){this.selectedMatchIndex=null;return;}
let nextIndex;if(this.selectedMatchIndex===null){nextIndex=0;}
else{nextIndex=this.selectedMatchIndex+indexChange;}
nextIndex=((nextIndex%matches.length)+matches.length)%matches.length;this.selectedMatchIndex=nextIndex;this.selection.selectCell(matches[nextIndex].col,matches[nextIndex].row);for(let index=0;index<this.searchMatches.length;index++){this.searchMatches[index].selected=index===this.selectedMatchIndex;}}
clearSearch(){this.toSearch="";this.searchMatches=[];this.selectedMatchIndex=null;this.currentSearchRegex=null;this.searchOptions={matchCase:false,exactMatch:false,searchFormulas:false,};}
replaceMatch(selectedMatch,replaceWith){if(!this.currentSearchRegex){return;}
const sheetId=this.getters.getActiveSheetId();const position={sheetId,...selectedMatch};const cell=this.getters.getCell(position);if(!cell?.content){return;}
if(cell?.isFormula&&!this.searchOptions.searchFormulas){return;}
const replaceRegex=new RegExp(this.currentSearchRegex.source,this.currentSearchRegex.flags+"g");const toReplace=this.getSearchableString(position);const content=toReplace.replace(replaceRegex,replaceWith);const canonicalContent=canonicalizeNumberContent(content,this.getters.getLocale());this.dispatch("UPDATE_CELL",{...position,content:canonicalContent});}
replace(replaceWith){if(this.selectedMatchIndex===null){return;}
const selectedMatch=this.searchMatches[this.selectedMatchIndex];this.replaceMatch(selectedMatch,replaceWith);this.selectNextCell(Direction.next);}
replaceAll(replaceWith){const matchCount=this.searchMatches.length;for(let i=0;i<matchCount;i++){this.replaceMatch(this.searchMatches[i],replaceWith);}}
getSearchableString(position){return this.getters.getCellText(position,this.searchOptions.searchFormulas);}
drawGrid(renderingContext){const{ctx}=renderingContext;const sheetId=this.getters.getActiveSheetId();for(const match of this.searchMatches){const merge=this.getters.getMerge({sheetId,col:match.col,row:match.row});const left=merge?merge.left:match.col;const right=merge?merge.right:match.col;const top=merge?merge.top:match.row;const bottom=merge?merge.bottom:match.row;const{x,y,width,height}=this.getters.getVisibleRect({top,left,right,bottom});if(width>0&&height>0){ctx.fillStyle=BACKGROUND_COLOR;ctx.fillRect(x,y,width,height);if(match.selected){ctx.strokeStyle=BORDER_COLOR;ctx.strokeRect(x,y,width,height);}}}}}
class FormatPlugin extends UIPlugin{handle(cmd){switch(cmd.type){case"SET_DECIMAL":this.setDecimal(cmd.sheetId,cmd.target,cmd.step);break;}}
setDecimal(sheetId,zones,step){for(const zone of zones){for(const position of positions(zone)){const numberFormat=this.getCellNumberFormat({sheetId,...position});if(numberFormat!==undefined){this.getters.getLocale();const newFormat=changeDecimalPlaces(numberFormat,step);this.dispatch("SET_FORMATTING",{sheetId,target:[positionToZone(position)],format:newFormat,});}}}}
getCellNumberFormat(position){for(const pos of[position]){const cell=this.getters.getEvaluatedCell(pos);if(cell.type===CellValueType.number&&!(cell.format&&isDateTimeFormat(cell.format))){return cell.format||createDefaultFormat(cell.value);}}
return undefined;}}
class HeaderVisibilityUIPlugin extends UIPlugin{static getters=["getNextVisibleCellPosition","findVisibleHeader","findLastVisibleColRowIndex","findFirstVisibleColRowIndex","isRowHidden","isColHidden","isHeaderHidden",];isRowHidden(sheetId,index){return(this.getters.isRowHiddenByUser(sheetId,index)||this.getters.isRowFiltered(sheetId,index));}
isColHidden(sheetId,index){return this.getters.isColHiddenByUser(sheetId,index);}
isHeaderHidden(sheetId,dimension,index){return dimension==="COL"?this.isColHidden(sheetId,index):this.isRowHidden(sheetId,index);}
getNextVisibleCellPosition({sheetId,col,row}){return{sheetId,col:this.findVisibleHeader(sheetId,"COL",col,this.getters.getNumberCols(sheetId)-1),row:this.findVisibleHeader(sheetId,"ROW",row,this.getters.getNumberRows(sheetId)-1),};}
findVisibleHeader(sheetId,dimension,from,to){if(from<=to){for(let i=from;i<=to;i++){if(this.getters.doesHeaderExist(sheetId,dimension,i)&&!this.isHeaderHidden(sheetId,dimension,i)){return i;}}}
if(from>to){for(let i=from;i>=to;i--){if(this.getters.doesHeaderExist(sheetId,dimension,i)&&!this.isHeaderHidden(sheetId,dimension,i)){return i;}}}
return undefined;}
findLastVisibleColRowIndex(sheetId,dimension,{last,first}){const lastVisibleIndex=range(last,first,-1).find((index)=>!this.isHeaderHidden(sheetId,dimension,index));return lastVisibleIndex||first;}
findFirstVisibleColRowIndex(sheetId,dimension){const numberOfHeaders=this.getters.getNumberHeaders(sheetId,dimension);for(let i=0;i<numberOfHeaders;i++){if(dimension==="COL"&&!this.isColHidden(sheetId,i)){return i;}
if(dimension==="ROW"&&!this.isRowHidden(sheetId,i)){return i;}}
return undefined;}
exportForExcel(data){for(const sheetData of data.sheets){for(const[row,rowData]of Object.entries(sheetData.rows)){const isHidden=this.isRowHidden(sheetData.id,Number(row));rowData.isHidden=isHidden;}}}}
class HighlightPlugin extends UIPlugin{static layers=[1];static getters=["getHighlights"];getHighlights(){return this.prepareHighlights(this.getters.getComposerHighlights().concat(this.getters.getSelectionInputHighlights()));}
prepareHighlights(highlights){return highlights.filter((x)=>x.zone.top>=0&&x.zone.left>=0&&x.zone.bottom<this.getters.getNumberRows(x.sheetId)&&x.zone.right<this.getters.getNumberCols(x.sheetId)).map((highlight)=>{const{numberOfRows,numberOfCols}=zoneToDimension(highlight.zone);const zone=numberOfRows*numberOfCols===1?this.getters.expandZone(highlight.sheetId,highlight.zone):highlight.zone;return{...highlight,zone,};});}
drawGrid(renderingContext){const{ctx,thinLineWidth}=renderingContext;const sheetId=this.getters.getActiveSheetId();const lineWidth=3*thinLineWidth;ctx.lineWidth=lineWidth;const highlights=this.getHighlights();for(let h of highlights.filter((highlight,index)=>highlights.findIndex((h)=>isEqual(h.zone,highlight.zone)&&h.sheetId===sheetId)===index)){const{x,y,width,height}=this.getters.getVisibleRect(h.zone);if(width>0&&height>0){ctx.strokeStyle=h.color;ctx.strokeRect(x+lineWidth/2,y+lineWidth/2,width-lineWidth,height-lineWidth);ctx.globalCompositeOperation="source-over";ctx.fillStyle=h.color+"20";ctx.fillRect(x+lineWidth,y+lineWidth,width-2*lineWidth,height-2*lineWidth);}}}}
class RendererPlugin extends UIPlugin{static layers=[0,7];static getters=["getColDimensionsInViewport","getRowDimensionsInViewport"];boxes=[];getColDimensionsInViewport(sheetId,col){const left=largeMin(this.getters.getSheetViewVisibleCols());const start=this.getters.getColRowOffsetInViewport("COL",left,col);const size=this.getters.getColSize(sheetId,col);const isColHidden=this.getters.isColHidden(sheetId,col);return{start,size:size,end:start+(isColHidden?0:size),};}
getRowDimensionsInViewport(sheetId,row){const top=largeMin(this.getters.getSheetViewVisibleRows());const start=this.getters.getColRowOffsetInViewport("ROW",top,row);const size=this.getters.getRowSize(sheetId,row);const isRowHidden=this.getters.isRowHidden(sheetId,row);return{start,size:size,end:start+(isRowHidden?0:size),};}
getHeaderOffset(dimension,start,index){let size=this.getters.getColRowOffsetInViewport(dimension,start,index);if(!this.getters.isDashboard()){size+=dimension==="ROW"?HEADER_HEIGHT:HEADER_WIDTH;}
return size;}
drawGrid(renderingContext,layer){switch(layer){case 0:this.boxes=this.getGridBoxes();this.drawBackground(renderingContext);this.drawOverflowingCellBackground(renderingContext);this.drawCellBackground(renderingContext);this.drawBorders(renderingContext);this.drawTexts(renderingContext);this.drawIcon(renderingContext);this.drawFrozenPanes(renderingContext);break;case 7:if(!this.getters.isDashboard()){this.drawHeaders(renderingContext);this.drawFrozenPanesHeaders(renderingContext);}
break;}}
drawBackground(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{width,height}=this.getters.getSheetViewDimensionWithHeaders();ctx.fillStyle="#ffffff";ctx.fillRect(0,0,width+CANVAS_SHIFT,height+CANVAS_SHIFT);const areGridLinesVisible=!this.getters.isDashboard()&&this.getters.getGridLinesVisibility(this.getters.getActiveSheetId());const inset=areGridLinesVisible?0.1*thinLineWidth:0;if(areGridLinesVisible){for(const box of this.boxes){ctx.strokeStyle=CELL_BORDER_COLOR;ctx.lineWidth=thinLineWidth;ctx.strokeRect(box.x+inset,box.y+inset,box.width-2*inset,box.height-2*inset);}}}
drawCellBackground(renderingContext){const{ctx}=renderingContext;for(const box of this.boxes){let style=box.style;if(style.fillColor&&style.fillColor!=="#ffffff"){ctx.fillStyle=style.fillColor||"#ffffff";ctx.fillRect(box.x,box.y,box.width,box.height);}
if(box.isError){ctx.fillStyle="red";ctx.beginPath();ctx.moveTo(box.x+box.width-5,box.y);ctx.lineTo(box.x+box.width,box.y);ctx.lineTo(box.x+box.width,box.y+5);ctx.fill();}}}
drawOverflowingCellBackground(renderingContext){const{ctx,thinLineWidth}=renderingContext;for(const box of this.boxes){if(box.content&&box.isOverflow){const align=box.content.align||"left";let x;let width;const y=box.y+thinLineWidth/2;const height=box.height-thinLineWidth;const clipWidth=Math.min(box.clipRect?.width||Infinity,box.content.width);if(align==="left"){x=box.x+thinLineWidth/2;width=clipWidth-2*thinLineWidth;}
else if(align==="right"){x=box.x+box.width-thinLineWidth/2;width=-clipWidth+2*thinLineWidth;}
else{x=(box.clipRect?.x||box.x+box.width/2-box.content.width/2)+thinLineWidth/2;width=clipWidth-2*thinLineWidth;}
ctx.fillStyle="#ffffff";ctx.fillRect(x,y,width,height);}}}
drawBorders(renderingContext){const{ctx}=renderingContext;for(let box of this.boxes){const border=box.border;if(border){const{x,y,width,height}=box;if(border.left){drawBorder(border.left,x,y,x,y+height);}
if(border.top){drawBorder(border.top,x,y,x+width,y);}
if(border.right){drawBorder(border.right,x+width,y,x+width,y+height);}
if(border.bottom){drawBorder(border.bottom,x,y+height,x+width,y+height);}}}
function drawBorder({style,color},x1,y1,x2,y2){ctx.strokeStyle=color;switch(style){case"medium":ctx.lineWidth=2;x1+=y1===y2?-0.5:0.5;x2+=y1===y2?1.5:0.5;y1+=x1===x2?-0.5:0.5;y2+=x1===x2?1.5:0.5;break;case"thick":ctx.lineWidth=3;if(y1===y2){x1--;x2++;}
if(x1===x2){y1--;y2++;}
break;case"dashed":ctx.lineWidth=1;ctx.setLineDash([1,3]);break;case"dotted":ctx.lineWidth=1;if(y1===y2){x1+=0.5;x2+=0.5;}
if(x1===x2){y1+=0.5;y2+=0.5;}
ctx.setLineDash([1,1]);break;case"thin":default:ctx.lineWidth=1;break;}
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.lineWidth=1;ctx.setLineDash([]);}}
drawTexts(renderingContext){const{ctx}=renderingContext;ctx.textBaseline="top";let currentFont;for(let box of this.boxes){if(box.content){const style=box.style||{};const align=box.content.align||"left";const font=computeTextFont(style);if(font!==currentFont){currentFont=font;ctx.font=font;}
ctx.fillStyle=style.textColor||"#000";let x=box.x;if(align==="left"){x+=MIN_CELL_TEXT_MARGIN+(box.image?box.image.size+MIN_CF_ICON_MARGIN:0);}
else if(align==="right"){x+=box.width-
MIN_CELL_TEXT_MARGIN-
(box.hasIcon?GRID_ICON_EDGE_LENGTH+GRID_ICON_MARGIN:0);}
else{x+=box.width/2;}
ctx.textAlign=align;if(box.clipRect){ctx.save();ctx.beginPath();const{x,y,width,height}=box.clipRect;ctx.rect(x,y,width,height);ctx.clip();}
const textLineHeight=computeTextFontSizeInPixels(style);const numberOfLines=box.content.textLines.length;let y=this.computeTextYCoordinate(box,textLineHeight,numberOfLines);for(let brokenLine of box.content.textLines){drawDecoratedText(ctx,brokenLine,{x:Math.round(x),y:Math.round(y)},style.underline,style.strikethrough);y+=MIN_CELL_TEXT_MARGIN+textLineHeight;}
if(box.clipRect){ctx.restore();}}}}
drawIcon(renderingContext){const{ctx}=renderingContext;for(const box of this.boxes){if(box.image){const icon=box.image.image;if(box.image.clipIcon){ctx.save();ctx.beginPath();const{x,y,width,height}=box.image.clipIcon;ctx.rect(x,y,width,height);ctx.clip();}
const iconSize=box.image.size;const y=this.computeTextYCoordinate(box,iconSize);ctx.drawImage(icon,box.x+MIN_CF_ICON_MARGIN,y,iconSize,iconSize);if(box.image.clipIcon){ctx.restore();}}}}
computeTextYCoordinate(box,textLineHeight,numberOfLines=1){const y=box.y+1;const textHeight=computeTextLinesHeight(textLineHeight,numberOfLines);const hasEnoughSpaces=box.height>textHeight+MIN_CELL_TEXT_MARGIN*2;const verticalAlign=box.verticalAlign||DEFAULT_VERTICAL_ALIGN;if(hasEnoughSpaces){if(verticalAlign==="middle"){return y+(box.height-textHeight)/2;}
if(verticalAlign==="bottom"){return y+box.height-textHeight-MIN_CELL_TEXT_MARGIN;}}
return y+MIN_CELL_TEXT_MARGIN;}
drawHeaders(renderingContext){const{ctx,thinLineWidth}=renderingContext;const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const{width,height}=this.getters.getSheetViewDimensionWithHeaders();const selection=this.getters.getSelectedZones();const selectedCols=getZonesCols(selection);const selectedRows=getZonesRows(selection);const sheetId=this.getters.getActiveSheetId();const numberOfCols=this.getters.getNumberCols(sheetId);const numberOfRows=this.getters.getNumberRows(sheetId);const activeCols=this.getters.getActiveCols();const activeRows=this.getters.getActiveRows();ctx.font=`400 ${HEADER_FONT_SIZE}px ${DEFAULT_FONT}`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.lineWidth=thinLineWidth;ctx.strokeStyle="#333";for(let col=left;col<=right;col++){const colZone={left:col,right:col,top:0,bottom:numberOfRows-1};const{x,width}=this.getters.getVisibleRect(colZone);const colHasFilter=this.getters.doesZonesContainFilter(sheetId,[colZone]);const isColActive=activeCols.has(col);const isColSelected=selectedCols.has(col);if(isColActive){ctx.fillStyle=colHasFilter?FILTERS_COLOR:BACKGROUND_HEADER_ACTIVE_COLOR;}
else if(isColSelected){ctx.fillStyle=colHasFilter?BACKGROUND_HEADER_SELECTED_FILTER_COLOR:BACKGROUND_HEADER_SELECTED_COLOR;}
else{ctx.fillStyle=colHasFilter?BACKGROUND_HEADER_FILTER_COLOR:BACKGROUND_HEADER_COLOR;}
ctx.fillRect(x,0,width,HEADER_HEIGHT);}
for(let row=top;row<=bottom;row++){const rowZone={top:row,bottom:row,left:0,right:numberOfCols-1};const{y,height}=this.getters.getVisibleRect(rowZone);const rowHasFilter=this.getters.doesZonesContainFilter(sheetId,[rowZone]);const isRowActive=activeRows.has(row);const isRowSelected=selectedRows.has(row);if(isRowActive){ctx.fillStyle=rowHasFilter?FILTERS_COLOR:BACKGROUND_HEADER_ACTIVE_COLOR;}
else if(isRowSelected){ctx.fillStyle=rowHasFilter?BACKGROUND_HEADER_SELECTED_FILTER_COLOR:BACKGROUND_HEADER_SELECTED_COLOR;}
else{ctx.fillStyle=rowHasFilter?BACKGROUND_HEADER_FILTER_COLOR:BACKGROUND_HEADER_COLOR;}
ctx.fillRect(0,y,HEADER_WIDTH,height);}
ctx.beginPath();ctx.moveTo(HEADER_WIDTH,0);ctx.lineTo(HEADER_WIDTH,height);ctx.moveTo(0,HEADER_HEIGHT);ctx.lineTo(width,HEADER_HEIGHT);ctx.strokeStyle=HEADER_BORDER_COLOR;ctx.stroke();ctx.beginPath();for(const i of visibleCols){const colSize=this.getters.getColSize(sheetId,i);const colName=numberToLetters(i);ctx.fillStyle=activeCols.has(i)?"#fff":TEXT_HEADER_COLOR;let colStart=this.getHeaderOffset("COL",left,i);ctx.fillText(colName,colStart+colSize/2,HEADER_HEIGHT/2);ctx.moveTo(colStart+colSize,0);ctx.lineTo(colStart+colSize,HEADER_HEIGHT);}
for(const i of visibleRows){const rowSize=this.getters.getRowSize(sheetId,i);ctx.fillStyle=activeRows.has(i)?"#fff":TEXT_HEADER_COLOR;let rowStart=this.getHeaderOffset("ROW",top,i);ctx.fillText(String(i+1),HEADER_WIDTH/2,rowStart+rowSize/2);ctx.moveTo(0,rowStart+rowSize);ctx.lineTo(HEADER_WIDTH,rowStart+rowSize);}
ctx.stroke();}
drawFrozenPanesHeaders(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const widthCorrection=this.getters.isDashboard()?0:HEADER_WIDTH;const heightCorrection=this.getters.isDashboard()?0:HEADER_HEIGHT;ctx.lineWidth=6*thinLineWidth;ctx.strokeStyle=FROZEN_PANE_HEADER_BORDER_COLOR;ctx.beginPath();if(offsetCorrectionX){ctx.moveTo(widthCorrection+offsetCorrectionX,0);ctx.lineTo(widthCorrection+offsetCorrectionX,heightCorrection);}
if(offsetCorrectionY){ctx.moveTo(0,heightCorrection+offsetCorrectionY);ctx.lineTo(widthCorrection,heightCorrection+offsetCorrectionY);}
ctx.stroke();}
drawFrozenPanes(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const viewport={left,right,top,bottom};const rect=this.getters.getVisibleRect(viewport);const widthCorrection=this.getters.isDashboard()?0:HEADER_WIDTH;const heightCorrection=this.getters.isDashboard()?0:HEADER_HEIGHT;ctx.lineWidth=6*thinLineWidth;ctx.strokeStyle=FROZEN_PANE_BORDER_COLOR;ctx.beginPath();if(offsetCorrectionX){ctx.moveTo(widthCorrection+offsetCorrectionX,heightCorrection);ctx.lineTo(widthCorrection+offsetCorrectionX,rect.height+heightCorrection);}
if(offsetCorrectionY){ctx.moveTo(widthCorrection,heightCorrection+offsetCorrectionY);ctx.lineTo(rect.width+widthCorrection,heightCorrection+offsetCorrectionY);}
ctx.stroke();}
findNextEmptyCol(base,max,row){const sheetId=this.getters.getActiveSheetId();let col=base;while(col<max){const position={sheetId,col:col+1,row};const nextCell=this.getters.getEvaluatedCell(position);const nextCellBorder=this.getters.getCellBorderWithFilterBorder(position);const cellHasIcon=this.getters.doesCellHaveGridIcon(position);const cellHasCheckbox=this.getters.isCellValidCheckbox(position);if(nextCell.type!==CellValueType.empty||this.getters.isInMerge(position)||nextCellBorder?.left||cellHasIcon||cellHasCheckbox){return col;}
col++;}
return col;}
findPreviousEmptyCol(base,min,row){const sheetId=this.getters.getActiveSheetId();let col=base;while(col>min){const position={sheetId,col:col-1,row};const previousCell=this.getters.getEvaluatedCell(position);const previousCellBorder=this.getters.getCellBorderWithFilterBorder(position);const cellHasIcon=this.getters.doesCellHaveGridIcon(position);const cellHasCheckbox=this.getters.isCellValidCheckbox(position);if(previousCell.type!==CellValueType.empty||this.getters.isInMerge(position)||previousCellBorder?.right||cellHasIcon||cellHasCheckbox){return col;}
col--;}
return col;}
computeCellAlignment(position,isOverflowing){const cell=this.getters.getCell(position);if(cell?.isFormula&&this.getters.shouldShowFormulas()){return"left";}
const{align}=this.getters.getCellStyle(position);const evaluatedCell=this.getters.getEvaluatedCell(position);if(isOverflowing&&evaluatedCell.type===CellValueType.number){return align!=="center"?"left":align;}
return align||evaluatedCell.defaultAlign;}
createZoneBox(sheetId,zone,viewport){const{left,right}=viewport;const col=zone.left;const row=zone.top;const position={sheetId,col,row};const cell=this.getters.getEvaluatedCell(position);const showFormula=this.getters.shouldShowFormulas();const{x,y,width,height}=this.getters.getVisibleRect(zone);const{verticalAlign}=this.getters.getCellStyle(position);const box={x,y,width,height,border:this.getters.getCellBorderWithFilterBorder(position)||undefined,style:this.getters.getCellComputedStyle(position),verticalAlign,isError:(cell.type===CellValueType.error&&cell.error.isVerbose)||this.getters.isDataValidationInvalid(position),};if(cell.type===CellValueType.empty||this.getters.isCellValidCheckbox(position)){return box;}
const cfIcon=this.getters.getConditionalIcon(position);const fontSizePX=computeTextFontSizeInPixels(box.style);const iconBoxWidth=cfIcon?MIN_CF_ICON_MARGIN+fontSizePX:0;if(cfIcon){box.image={type:"icon",size:fontSizePX,clipIcon:{x:box.x,y:box.y,width:Math.min(iconBoxWidth,width),height},image:ICONS[cfIcon].img,};}
box.hasIcon=this.getters.doesCellHaveGridIcon(position);const headerIconWidth=box.hasIcon?GRID_ICON_EDGE_LENGTH+GRID_ICON_MARGIN:0;const style=this.getters.getCellComputedStyle(position);const wrapping=style.wrapping||"overflow";const maxWidth=wrapping==="wrap"&&!showFormula?width-2*MIN_CELL_TEXT_MARGIN:undefined;const multiLineText=this.getters.getCellMultiLineText(position,maxWidth);const textWidth=Math.max(...multiLineText.map((line)=>this.getters.getTextWidth(line,style)+MIN_CELL_TEXT_MARGIN));const contentWidth=iconBoxWidth+textWidth+headerIconWidth;const align=this.computeCellAlignment(position,contentWidth>width);box.content={textLines:multiLineText,width:wrapping==="overflow"?textWidth:width,align,};const isOverflowing=contentWidth>width||fontSizePX>height;if(cfIcon||box.hasIcon){box.clipRect={x:box.x+iconBoxWidth,y:box.y,width:Math.max(0,width-iconBoxWidth-headerIconWidth),height,};}
else if(isOverflowing&&wrapping==="overflow"){let nextColIndex,previousColIndex;const isCellInMerge=this.getters.isInMerge(position);if(isCellInMerge){nextColIndex=this.getters.getMerge(position).right;previousColIndex=col;}
else{nextColIndex=this.findNextEmptyCol(col,right,row);previousColIndex=this.findPreviousEmptyCol(col,left,row);box.isOverflow=true;}
switch(align){case"left":{const emptyZoneOnTheLeft=positionToZone({col:nextColIndex,row});const{x,y,width,height}=this.getters.getVisibleRect(union(zone,emptyZoneOnTheLeft));if(width<contentWidth||fontSizePX>height||multiLineText.length>1){box.clipRect={x,y,width,height};}
break;}
case"right":{const emptyZoneOnTheRight=positionToZone({col:previousColIndex,row});const{x,y,width,height}=this.getters.getVisibleRect(union(zone,emptyZoneOnTheRight));if(width<contentWidth||fontSizePX>height||multiLineText.length>1){box.clipRect={x,y,width,height};}
break;}
case"center":{const emptyZone={...zone,left:previousColIndex,right:nextColIndex,};const{x,y,height,width}=this.getters.getVisibleRect(emptyZone);const halfContentWidth=contentWidth/2;const boxMiddle=box.x+box.width/2;if(x+width<boxMiddle+halfContentWidth||x>boxMiddle-halfContentWidth||fontSizePX>height||multiLineText.length>1){const clipX=x>boxMiddle-halfContentWidth?x:boxMiddle-halfContentWidth;const clipWidth=x+width-clipX;box.clipRect={x:clipX,y,width:clipWidth,height};}
break;}}}
else if(wrapping==="clip"||wrapping==="wrap"||multiLineText.length>1){box.clipRect={x:box.x,y:box.y,width,height,};}
return box;}
getGridBoxes(){const boxes=[];const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const viewport={left,right,top,bottom};const sheetId=this.getters.getActiveSheetId();for(const row of visibleRows){for(const col of visibleCols){const position={sheetId,col,row};if(this.getters.isInMerge(position)){continue;}
boxes.push(this.createZoneBox(sheetId,positionToZone(position),viewport));}}
for(const merge of this.getters.getMerges(sheetId)){if(this.getters.isMergeHidden(sheetId,merge)){continue;}
if(overlap(merge,viewport)){const box=this.createZoneBox(sheetId,merge,viewport);const borderBottomRight=this.getters.getCellBorder({sheetId,col:merge.right,row:merge.bottom,});box.border={...box.border,bottom:borderBottomRight?borderBottomRight.bottom:undefined,right:borderBottomRight?borderBottomRight.right:undefined,};box.isMerge=true;boxes.push(box);}}
return boxes;}}
class SelectionInputPlugin extends UIPlugin{inputHasSingleRange;static layers=[1];static getters=[];ranges=[];focusedRangeIndex=null;inputSheetId;constructor(config,initialRanges,inputHasSingleRange){if(inputHasSingleRange&&initialRanges.length>1){throw new Error("Input with a single range cannot be instantiated with several range references.");}
super(config);this.inputHasSingleRange=inputHasSingleRange;this.insertNewRange(0,initialRanges);this.inputSheetId=this.getters.getActiveSheetId();if(this.ranges.length===0){this.insertNewRange(this.ranges.length,[""]);this.focusLast();}}
handleEvent(event){if(this.focusedRangeIndex===null){return;}
const inputSheetId=this.inputSheetId;const activeSheetId=this.getters.getActiveSheetId();const zone=event.options.unbounded?this.getters.getUnboundedZone(activeSheetId,event.anchor.zone):event.anchor.zone;const range=this.getters.getRangeFromZone(activeSheetId,zone);const willAddNewRange=event.mode==="newAnchor"&&!this.inputHasSingleRange&&this.ranges[this.focusedRangeIndex].xc.trim()!=="";if(willAddNewRange){const xc=this.getters.getSelectionRangeString(range,inputSheetId);this.insertNewRange(this.ranges.length,[xc]);this.focusLast();}
else{let parts=range.parts;const previousXc=this.ranges[this.focusedRangeIndex].xc.trim();if(previousXc){parts=this.getters.getRangeFromSheetXC(inputSheetId,previousXc).parts;}
const newRange=range.clone({parts});const xc=this.getters.getSelectionRangeString(newRange,inputSheetId);this.setRange(this.focusedRangeIndex,[xc]);}}
handle(cmd){switch(cmd.type){case"UNFOCUS_SELECTION_INPUT":this.unfocus();break;case"FOCUS_RANGE":this.focus(this.getIndex(cmd.rangeId));break;case"CHANGE_RANGE":{const index=this.getIndex(cmd.rangeId);if(index!==null&&this.focusedRangeIndex!==index){this.focus(index);}
if(index!==null){const valueWithoutLeadingComma=cmd.value.replace(/^,+/,"");const values=valueWithoutLeadingComma.split(",").map((reference)=>reference.trim());this.setRange(index,values);}
break;}
case"ADD_EMPTY_RANGE":this.insertNewRange(this.ranges.length,[""]);this.focusLast();break;case"ADD_RANGE":this.insertNewRange(this.ranges.length,[cmd.value]);this.focusLast();break;case"REMOVE_RANGE":const index=this.getIndex(cmd.rangeId);if(index!==null){this.removeRange(index);}
break;case"ACTIVATE_SHEET":{if(cmd.sheetIdFrom!==cmd.sheetIdTo){const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:cmd.sheetIdTo,col:0,row:0,});const zone=this.getters.expandZone(cmd.sheetIdTo,positionToZone({col,row}));this.selection.resetAnchor(this,{cell:{col,row},zone});}
break;}
case"START_CHANGE_HIGHLIGHT":const activeSheetId=this.getters.getActiveSheetId();const newZone=this.getters.expandZone(activeSheetId,cmd.zone);const focusIndex=this.ranges.findIndex((range)=>{const{xc,sheetName:sheet}=splitReference(range.xc);const sheetName=sheet||this.getters.getSheetName(this.inputSheetId);if(this.getters.getSheetName(activeSheetId)!==sheetName){return false;}
const refRange=this.getters.getRangeFromSheetXC(activeSheetId,xc);return isEqual(this.getters.expandZone(activeSheetId,refRange.zone),newZone);});if(focusIndex!==-1){this.focus(focusIndex);const{left,top}=newZone;this.selection.resetAnchor(this,{cell:{col:left,row:top},zone:newZone});}
break;}}
getSelectionInputValue(){return this.cleanInputs(this.ranges.map((range)=>{return range.xc?range.xc:"";}));}
getSelectionInputHighlights(){return this.ranges.map((input)=>this.inputToHighlights(input)).flat();}
focus(index){this.focusedRangeIndex=index;}
focusLast(){this.focus(this.ranges.length-1);}
unfocus(){this.focusedRangeIndex=null;}
setContent(index,xc){this.ranges[index]={...this.ranges[index],xc,};}
insertNewRange(index,values){const currentMaxId=Math.max(0,...this.ranges.map((range)=>Number(range.id)));this.ranges.splice(index,0,...values.map((xc,i)=>({xc,id:currentMaxId+i+1,color:colors$1[(currentMaxId+i)%colors$1.length],})));}
setRange(index,values){const[,...additionalValues]=values;this.setContent(index,values[0]);this.insertNewRange(index+1,additionalValues);if(additionalValues.length){this.focus(index+additionalValues.length);}}
removeRange(index){this.ranges.splice(index,1);if(this.focusedRangeIndex!==null){this.focusLast();}}
inputToHighlights({xc,color}){const XCs=this.cleanInputs([xc]).filter((range)=>this.getters.isRangeValid(range)).filter((reference)=>this.shouldBeHighlighted(this.inputSheetId,reference));return XCs.map((xc)=>{const{sheetName}=splitReference(xc);return{zone:this.getters.getRangeFromSheetXC(this.inputSheetId,xc).zone,sheetId:(sheetName&&this.getters.getSheetIdByName(sheetName))||this.inputSheetId,color,};});}
cleanInputs(ranges){return ranges.map((xc)=>xc.split(",")).flat().map((xc)=>xc.trim()).filter((xc)=>xc!=="");}
shouldBeHighlighted(inputSheetId,reference){const{sheetName}=splitReference(reference);const sheetId=this.getters.getSheetIdByName(sheetName);const activeSheetId=this.getters.getActiveSheet().id;const valid=this.getters.isRangeValid(reference);return(valid&&(sheetId===activeSheetId||(sheetId===undefined&&activeSheetId===inputSheetId)));}
getIndex(rangeId){const index=this.ranges.findIndex((range)=>range.id===rangeId);return index>=0?index:null;}}
class SelectionInputsManagerPlugin extends UIPlugin{config;static layers=[1];static getters=["getSelectionInput","getSelectionInputValue","isRangeValid","getSelectionInputHighlights",];inputs={};focusedInputId=null;get currentInput(){return this.focusedInputId?this.inputs[this.focusedInputId]:null;}
constructor(config){super(config);this.config=config;}
allowDispatch(cmd){switch(cmd.type){case"FOCUS_RANGE":case"CHANGE_RANGE":case"ADD_EMPTY_RANGE":case"REMOVE_RANGE":if(!this.inputs[cmd.id]){return"InvalidInputId";}}
switch(cmd.type){case"FOCUS_RANGE":const index=this.currentInput?.getIndex(cmd.rangeId);if(this.focusedInputId===cmd.id&&this.currentInput?.focusedRangeIndex===index){return"InputAlreadyFocused";}
break;case"ADD_RANGE":case"ADD_EMPTY_RANGE":const input=this.inputs[cmd.id];if(input.inputHasSingleRange&&input.ranges.length===1){return"MaximumRangesReached";}
break;case"REMOVE_RANGE":if(this.inputs[cmd.id].ranges.length===1){return"MinimumRangesReached";}
break;case"CHANGE_RANGE":{const input=this.inputs[cmd.id];if(input.inputHasSingleRange&&cmd.value.split(",").length>1){return"MaximumRangesReached";}
break;}}
return"Success";}
handle(cmd){switch(cmd.type){case"ENABLE_NEW_SELECTION_INPUT":this.initInput(cmd.id,cmd.initialRanges||[],cmd.hasSingleRange);break;case"DISABLE_SELECTION_INPUT":if(this.focusedInputId===cmd.id){this.unfocus();}
delete this.inputs[cmd.id];break;case"UNFOCUS_SELECTION_INPUT":this.unfocus();break;case"ADD_RANGE":case"ADD_EMPTY_RANGE":case"REMOVE_RANGE":if(cmd.id!==this.focusedInputId){const input=this.inputs[cmd.id];this.selection.capture(input,{cell:{col:0,row:0},zone:positionToZone({col:0,row:0})},{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});this.focusedInputId=cmd.id;}
break;case"FOCUS_RANGE":case"CHANGE_RANGE":const input=this.inputs[cmd.id];const range=input.ranges.find((range)=>range.id===cmd.rangeId);if(range){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getRangeFromSheetXC(sheetId,range?.xc||"A1").zone;this.selection.capture(input,{cell:{col:zone.left,row:zone.top},zone},{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});}
this.focusedInputId=cmd.id;break;}
this.currentInput?.handle(cmd);}
getSelectionInput(id){if(!this.inputs[id]){return[];}
return this.inputs[id].ranges.map((input,index)=>Object.assign({},input,{color:this.focusedInputId===id&&this.inputs[id].focusedRangeIndex!==null&&this.isRangeValid(input.xc)?input.color:null,isFocused:this.focusedInputId===id&&this.inputs[id].focusedRangeIndex===index,}));}
isRangeValid(reference){if(!reference){return false;}
const{xc,sheetName}=splitReference(reference);return(xc.match(rangeReference)!==null&&(!sheetName||this.getters.getSheetIdByName(sheetName)!==undefined));}
getSelectionInputValue(id){return this.inputs[id].getSelectionInputValue();}
getSelectionInputHighlights(){if(!this.focusedInputId){return[];}
return this.inputs[this.focusedInputId].getSelectionInputHighlights();}
initInput(id,initialRanges,inputHasSingleRange=false){if(this.inputs[id]){this.unfocus();}
this.inputs[id]=new SelectionInputPlugin(this.config,initialRanges,inputHasSingleRange);if(initialRanges.length===0){const input=this.inputs[id];const anchor={zone:positionToZone({col:0,row:0}),cell:{col:0,row:0},};this.selection.capture(input,anchor,{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});this.focusedInputId=id;}}
unfocus(){this.selection.release(this.currentInput);this.focusedInputId=null;}}
class SortPlugin extends UIPlugin{static getters=["getContiguousZone"];allowDispatch(cmd){switch(cmd.type){case"SORT_CELLS":if(!isInside(cmd.col,cmd.row,cmd.zone)){throw new Error(_t("The anchor must be part of the provided zone"));}
return this.checkValidations(cmd,this.checkMerge,this.checkMergeSizes);}
return"Success";}
handle(cmd){switch(cmd.type){case"SORT_CELLS":this.sortZone(cmd.sheetId,cmd,cmd.zone,cmd.sortDirection,cmd.sortOptions||{});break;}}
checkMerge({sheetId,zone}){if(!this.getters.doesIntersectMerge(sheetId,zone)){return"Success";}
const singleCells=positions(zone).some(({col,row})=>!this.getters.isInMerge({sheetId,col,row}));if(singleCells){return"InvalidSortZone";}
return"Success";}
checkMergeSizes({sheetId,zone}){if(!this.getters.doesIntersectMerge(sheetId,zone)){return"Success";}
const merges=this.getters.getMerges(sheetId).filter((merge)=>overlap(merge,zone));const mergeDimension=zoneToDimension(merges[0]);let[widthFirst,heightFirst]=[mergeDimension.numberOfCols,mergeDimension.numberOfRows];if(!merges.every((merge)=>{let[widthCurrent,heightCurrent]=[merge.right-merge.left+1,merge.bottom-merge.top+1,];return widthCurrent===widthFirst&&heightCurrent===heightFirst;})){return"InvalidSortZone";}
return"Success";}
expand(sheetId,z){const{left,right,top,bottom}=this.getters.expandZone(sheetId,z);return{left:Math.max(0,left),right:Math.min(this.getters.getNumberCols(sheetId)-1,right),top:Math.max(0,top),bottom:Math.min(this.getters.getNumberRows(sheetId)-1,bottom),};}
checkExpandedValues(sheetId,z){const expandedZone=this.expand(sheetId,z);let cell;if(this.getters.doesIntersectMerge(sheetId,expandedZone)){const{left,right,top,bottom}=expandedZone;for(let c=left;c<=right;c++){for(let r=top;r<=bottom;r++){const{col,row}=this.getters.getMainCellPosition({sheetId,col:c,row:r});cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.formattedValue){return true;}}}}
else{for(let cell of this.getters.getEvaluatedCellsInZone(sheetId,expandedZone)){if(cell.formattedValue){return true;}}}
return false;}
getContiguousZone(sheetId,zone){let{top,bottom,left,right}=zone;let canExpand;let stop=false;while(!stop){stop=true;if(top>0){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:right+1,top:top-1,bottom:top-1,});if(canExpand){stop=false;top--;}}
if(left>0){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:left-1,top:top-1,bottom:bottom+1,});if(canExpand){stop=false;left--;}}
if(right<this.getters.getNumberCols(sheetId)-1){canExpand=this.checkExpandedValues(sheetId,{left:right+1,right:right+1,top:top-1,bottom:bottom+1,});if(canExpand){stop=false;right++;}}
if(bottom<this.getters.getNumberRows(sheetId)-1){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:right+1,top:bottom+1,bottom:bottom+1,});if(canExpand){stop=false;bottom++;}}}
return{left,right,top,bottom};}
hasHeader(sheetId,items){if(items[0].length===1)
return false;let cells=items.map((col)=>col.map(({col,row})=>this.getters.getEvaluatedCell({sheetId,col,row}).type));const topLeft=cells[0][0];if(topLeft===CellValueType.empty){cells=cells.slice(1);}
if(cells.some((item)=>item[0]===CellValueType.empty)){return false;}
else if(cells.some((item)=>item[1]!==CellValueType.empty&&item[0]!==item[1])){return true;}
else{return false;}}
sortZone(sheetId,anchor,zone,sortDirection,options){const[stepX,stepY]=this.mainCellsSteps(sheetId,zone);let sortingCol=this.getters.getMainCellPosition({sheetId,col:anchor.col,row:anchor.row,}).col;let sortZone=Object.assign({},zone);let cellPositions=this.mainCells(sheetId,zone);if(!options.sortHeaders&&this.hasHeader(sheetId,cellPositions)){sortZone.top+=stepY;}
cellPositions=this.mainCells(sheetId,sortZone);const sortingCells=cellPositions[sortingCol-sortZone.left];const sortedIndexOfSortTypeCells=sortCells(sortingCells.map((position)=>this.getters.getEvaluatedCell(position)),sortDirection,Boolean(options.emptyCellAsZero));const sortedIndex=sortedIndexOfSortTypeCells.map((x)=>x.index);const[width,height]=[cellPositions.length,cellPositions[0].length];const updateCellCommands=[];for(let c=0;c<width;c++){for(let r=0;r<height;r++){let{col,row,sheetId}=cellPositions[c][sortedIndex[r]];const cell=this.getters.getCell({sheetId,col,row});let newCol=sortZone.left+c*stepX;let newRow=sortZone.top+r*stepY;let newCellValues={sheetId:sheetId,col:newCol,row:newRow,content:"",};if(cell){let content=cell.content;if(cell.isFormula){const position=this.getters.getCellPosition(cell.id);content=this.getters.getTranslatedCellFormula(sheetId,0,newRow-position.row,cell.compiledFormula);}
newCellValues.style=cell.style;newCellValues.content=content;newCellValues.format=cell.format;}
updateCellCommands.push(newCellValues);}}
updateCellCommands.forEach((cmdPayload)=>this.dispatch("UPDATE_CELL",cmdPayload));}
mainCellsSteps(sheetId,zone){const merge=this.getters.getMerge({sheetId,col:zone.left,row:zone.top});const stepX=merge?merge.right-merge.left+1:1;const stepY=merge?merge.bottom-merge.top+1:1;return[stepX,stepY];}
mainCells(sheetId,zone){const[stepX,stepY]=this.mainCellsSteps(sheetId,zone);const cells=[];const cols=range(zone.left,zone.right+1,stepX);const rows=range(zone.top,zone.bottom+1,stepY);for(const col of cols){const colCells=[];cells.push(colCells);for(const row of rows){colCells.push({sheetId,col,row});}}
return cells;}}
class UIOptionsPlugin extends UIPlugin{static getters=["shouldShowFormulas"];showFormulas=false;handle(cmd){switch(cmd.type){case"SET_FORMULA_VISIBILITY":this.showFormulas=cmd.show;break;}}
shouldShowFormulas(){return this.showFormulas;}}
class SheetUIPlugin extends UIPlugin{static getters=["doesCellHaveGridIcon","getCellWidth","getTextWidth","getCellText","getCellMultiLineText",];ctx=document.createElement("canvas").getContext("2d");allowDispatch(cmd){return this.chainValidations(this.checkSheetExists,this.checkZonesAreInSheet)(cmd);}
handle(cmd){switch(cmd.type){case"AUTORESIZE_COLUMNS":for(let col of cmd.cols){const size=this.getColMaxWidth(cmd.sheetId,col);if(size!==0){this.dispatch("RESIZE_COLUMNS_ROWS",{elements:[col],dimension:"COL",size,sheetId:cmd.sheetId,});}}
break;case"AUTORESIZE_ROWS":for(let row of cmd.rows){this.dispatch("RESIZE_COLUMNS_ROWS",{elements:[row],dimension:"ROW",size:null,sheetId:cmd.sheetId,});}
break;}}
getCellWidth(position){const style=this.getters.getCellComputedStyle(position);let contentWidth=0;const content=this.getters.getEvaluatedCell(position).formattedValue;if(content){const multiLineText=splitTextToWidth(this.ctx,content,style,undefined);contentWidth+=Math.max(...multiLineText.map((line)=>computeTextWidth(this.ctx,line,style)));}
const icon=this.getters.getConditionalIcon(position);if(icon){contentWidth+=computeIconWidth(style);}
if(this.getters.doesCellHaveGridIcon(position)){contentWidth+=ICON_EDGE_LENGTH+GRID_ICON_MARGIN;}
if(contentWidth===0){return 0;}
contentWidth+=2*PADDING_AUTORESIZE_HORIZONTAL;if(style.wrapping==="wrap"){const colWidth=this.getters.getColSize(this.getters.getActiveSheetId(),position.col);return Math.min(colWidth,contentWidth);}
return contentWidth;}
getTextWidth(text,style){return computeTextWidth(this.ctx,text,style);}
getCellText(position,showFormula=false){const cell=this.getters.getCell(position);if(showFormula&&cell?.isFormula){return localizeFormula(cell.content,this.getters.getLocale());}
else{return this.getters.getEvaluatedCell(position).formattedValue;}}
getCellMultiLineText(position,width){const style=this.getters.getCellStyle(position);const text=this.getters.getCellText(position,this.getters.shouldShowFormulas());return splitTextToWidth(this.ctx,text,style,width);}
doesCellHaveGridIcon(position){const isFilterHeader=this.getters.isFilterHeader(position);const hasListIcon=!this.getters.isReadonly()&&this.getters.cellHasListDataValidationIcon(position);return isFilterHeader||hasListIcon;}
getColMaxWidth(sheetId,index){const cellsPositions=positions(this.getters.getColsZone(sheetId,index,index));const sizes=cellsPositions.map((position)=>this.getCellWidth({sheetId,...position}));return Math.max(0,largeMax(sizes));}
checkSheetExists(cmd){if("sheetId"in cmd&&this.getters.tryGetSheet(cmd.sheetId)===undefined){return"InvalidSheetId";}
return"Success";}
checkZonesAreInSheet(cmd){const sheetId="sheetId"in cmd?cmd.sheetId:this.getters.tryGetActiveSheetId();const zones=this.getters.getCommandZones(cmd);if(!sheetId&&zones.length>0){return"NoActiveSheet";}
if(sheetId&&zones.length>0){return this.getters.checkZonesExistInSheet(sheetId,zones);}
return"Success";}}
const genericRepeatsTransforms=[repeatSheetDependantCommand,repeatTargetDependantCommand,repeatPositionDependantCommand,];function repeatSheetDependantCommand(getters,command){if(!("sheetId"in command))
return command;return{...deepCopy(command),sheetId:getters.getActiveSheetId()};}
function repeatTargetDependantCommand(getters,command){if(!("target"in command)||!Array.isArray(command.target))
return command;return{...deepCopy(command),target:getters.getSelectedZones(),};}
function repeatZoneDependantCommand(getters,command){if(!("zone"in command))
return command;return{...deepCopy(command),zone:getters.getSelectedZone(),};}
function repeatPositionDependantCommand(getters,command){if(!("row"in command)||!("col"in command))
return command;const{col,row}=getters.getActivePosition();return{...deepCopy(command),col,row};}
const uuidGenerator=new UuidGenerator();function repeatCreateChartCommand(getters,cmd){return{...repeatSheetDependantCommand(getters,cmd),id:uuidGenerator.uuidv4(),};}
function repeatCreateImageCommand(getters,cmd){return{...repeatSheetDependantCommand(getters,cmd),figureId:uuidGenerator.uuidv4(),};}
function repeatCreateFigureCommand(getters,cmd){const newCmd=repeatSheetDependantCommand(getters,cmd);newCmd.figure.id=uuidGenerator.uuidv4();return newCmd;}
function repeatCreateSheetCommand(getters,cmd){const newCmd=deepCopy(cmd);newCmd.sheetId=uuidGenerator.uuidv4();const sheetName=cmd.name||getters.getSheet(getters.getActiveSheetId()).name;const namePrefix=sheetName.match(/(.+?)\d*$/)?.[1]||sheetName;newCmd.name=getters.getNextSheetName(namePrefix);return newCmd;}
function repeatAddColumnsRowsCommand(getters,cmd){const currentPosition=getters.getActivePosition();return{...repeatSheetDependantCommand(getters,cmd),base:cmd.dimension==="COL"?currentPosition.col:currentPosition.row,};}
function repeatHeaderElementCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),elements:cmd.dimension==="COL"?range(currentSelection.left,currentSelection.right+1):range(currentSelection.top,currentSelection.bottom+1),};}
function repeatInsertOrDeleteCellCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...deepCopy(cmd),zone:currentSelection,};}
function repeatAutoResizeCommand(getters,cmd){const newCmd=deepCopy(cmd);const currentSelection=getters.getSelectedZone();const{top,bottom,left,right}=currentSelection;if("cols"in newCmd){newCmd.cols=range(left,right+1);}
else if("rows"in newCmd){newCmd.rows=range(top,bottom+1);}
return newCmd;}
function repeatSortCellsCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),col:currentSelection.left,row:currentSelection.top,zone:currentSelection,};}
function repeatPasteCommand(getters,cmd){return{type:"REPEAT_PASTE",pasteOption:deepCopy(cmd.pasteOption),target:getters.getSelectedZones(),};}
function repeatGroupHeadersCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),start:cmd.dimension==="COL"?currentSelection.left:currentSelection.top,end:cmd.dimension==="COL"?currentSelection.right:currentSelection.bottom,};}
const repeatCommandTransformRegistry=new Registry();repeatCommandTransformRegistry.add("UPDATE_CELL",genericRepeat);repeatCommandTransformRegistry.add("CLEAR_CELL",genericRepeat);repeatCommandTransformRegistry.add("DELETE_CONTENT",genericRepeat);repeatCommandTransformRegistry.add("ADD_MERGE",genericRepeat);repeatCommandTransformRegistry.add("REMOVE_MERGE",genericRepeat);repeatCommandTransformRegistry.add("SET_FORMATTING",genericRepeat);repeatCommandTransformRegistry.add("CLEAR_FORMATTING",genericRepeat);repeatCommandTransformRegistry.add("SET_BORDER",genericRepeat);repeatCommandTransformRegistry.add("CREATE_FILTER_TABLE",genericRepeat);repeatCommandTransformRegistry.add("REMOVE_FILTER_TABLE",genericRepeat);repeatCommandTransformRegistry.add("HIDE_SHEET",genericRepeat);repeatCommandTransformRegistry.add("ADD_COLUMNS_ROWS",repeatAddColumnsRowsCommand);repeatCommandTransformRegistry.add("REMOVE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("HIDE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("RESIZE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("CREATE_SHEET",repeatCreateSheetCommand);repeatCommandTransformRegistry.add("CREATE_FIGURE",repeatCreateFigureCommand);repeatCommandTransformRegistry.add("CREATE_CHART",repeatCreateChartCommand);repeatCommandTransformRegistry.add("CREATE_IMAGE",repeatCreateImageCommand);repeatCommandTransformRegistry.add("GROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNGROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNGROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNFOLD_HEADER_GROUPS_IN_ZONE",repeatZoneDependantCommand);repeatCommandTransformRegistry.add("FOLD_HEADER_GROUPS_IN_ZONE",repeatZoneDependantCommand);const repeatLocalCommandTransformRegistry=new Registry();repeatLocalCommandTransformRegistry.add("STOP_EDITION",repeatLocalCommandChildren);repeatLocalCommandTransformRegistry.add("PASTE",repeatPasteCommand);repeatLocalCommandTransformRegistry.add("INSERT_CELL",repeatInsertOrDeleteCellCommand);repeatLocalCommandTransformRegistry.add("DELETE_CELL",repeatInsertOrDeleteCellCommand);repeatLocalCommandTransformRegistry.add("AUTORESIZE_COLUMNS",repeatAutoResizeCommand);repeatLocalCommandTransformRegistry.add("AUTORESIZE_ROWS",repeatAutoResizeCommand);repeatLocalCommandTransformRegistry.add("SORT_CELLS",repeatSortCellsCommand);repeatLocalCommandTransformRegistry.add("SUM_SELECTION",genericRepeat);repeatLocalCommandTransformRegistry.add("SET_DECIMAL",genericRepeat);function genericRepeat(getters,command){let transformedCommand=deepCopy(command);for(const repeatTransform of genericRepeatsTransforms){transformedCommand=repeatTransform(getters,transformedCommand);}
return transformedCommand;}
function repeatCoreCommand(getters,command){if(!command){return undefined;}
const isRepeatable=repeatCommandTransformRegistry.contains(command.type);if(!isRepeatable){return undefined;}
const transform=repeatCommandTransformRegistry.get(command.type);return transform(getters,command);}
function repeatLocalCommand(getters,command,childCommands){const isRepeatable=repeatLocalCommandTransformRegistry.contains(command.type);if(!isRepeatable){return undefined;}
const repeatTransform=repeatLocalCommandTransformRegistry.get(command.type);return repeatTransform(getters,command,childCommands);}
function repeatLocalCommandChildren(getters,cmd,childCommands){return childCommands.map((childCommand)=>repeatCoreCommand(getters,childCommand)).filter(isDefined$1);}
function canRepeatRevision(revision){if(!revision||!revision.rootCommand||typeof revision.rootCommand!=="object"){return false;}
if(isCoreCommand(revision.rootCommand)){return repeatCommandTransformRegistry.contains(revision.rootCommand.type);}
return repeatLocalCommandTransformRegistry.contains(revision.rootCommand.type);}
function repeatRevision(revision,getters){if(!revision.rootCommand||typeof revision.rootCommand!=="object"){return undefined;}
if(isCoreCommand(revision.rootCommand)){return repeatCoreCommand(getters,revision.rootCommand);}
return repeatLocalCommand(getters,revision.rootCommand,revision.commands);}
class HistoryPlugin extends UIPlugin{static getters=["canUndo","canRedo"];undoStack=[];redoStack=[];session;constructor(config){super(config);this.session=config.session;this.session.on("new-local-state-update",this,this.onNewLocalStateUpdate);this.session.on("pending-revisions-dropped",this,({revisionIds})=>this.drop(revisionIds));this.session.on("snapshot",this,()=>{this.undoStack=[];this.redoStack=[];});}
allowDispatch(cmd){switch(cmd.type){case"REQUEST_UNDO":if(!this.canUndo()){return"EmptyUndoStack";}
break;case"REQUEST_REDO":if(!this.canRedo()){return"EmptyRedoStack";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"REQUEST_UNDO":case"REQUEST_REDO":this.requestHistoryChange(cmd.type==="REQUEST_UNDO"?"UNDO":"REDO");}}
finalize(){}
requestHistoryChange(type){const id=type==="UNDO"?this.undoStack.pop():this.redoStack.pop();if(!id){const lastNonRedoRevision=this.getPossibleRevisionToRepeat();if(!lastNonRedoRevision){return;}
const repeatedCommands=repeatRevision(lastNonRedoRevision,this.getters);if(!repeatedCommands){return;}
if(!Array.isArray(repeatedCommands)){this.dispatch(repeatedCommands.type,repeatedCommands);return;}
for(const command of repeatedCommands){this.dispatch(command.type,command);}
return;}
if(type==="UNDO"){this.session.undo(id);this.redoStack.push(id);}
else{this.session.redo(id);this.undoStack.push(id);}}
canUndo(){return this.undoStack.length>0;}
canRedo(){if(this.redoStack.length>0)
return true;const lastNonRedoRevision=this.getPossibleRevisionToRepeat();return canRepeatRevision(lastNonRedoRevision);}
drop(revisionIds){this.undoStack=this.undoStack.filter((id)=>!revisionIds.includes(id));this.redoStack=[];}
onNewLocalStateUpdate({id}){this.undoStack.push(id);this.redoStack=[];if(this.undoStack.length>MAX_HISTORY_STEPS){this.undoStack.shift();}}
getPossibleRevisionToRepeat(){return this.session.getLastLocalNonEmptyRevision();}}
class SplitToColumnsPlugin extends UIPlugin{static getters=["getAutomaticSeparator"];allowDispatch(cmd){switch(cmd.type){case"SPLIT_TEXT_INTO_COLUMNS":return this.chainValidations(this.batchValidations(this.checkSingleColSelected,this.checkNonEmptySelector),this.batchValidations(this.checkNotOverwritingContent,this.checkSeparatorInSelection))(cmd);}
return"Success";}
handle(cmd){switch(cmd.type){case"SPLIT_TEXT_INTO_COLUMNS":this.splitIntoColumns(cmd);break;}}
getAutomaticSeparator(){const cells=this.getters.getSelectedCells();for(const cell of cells){if(cell.value&&cell.type===CellValueType.text){const separator=this.getAutoSeparatorForString(cell.value);if(separator){return separator;}}}
return" ";}
getAutoSeparatorForString(str){const separators=[NEWLINE,";",","," ","."];for(const separator of separators){if(str.includes(separator)){return separator;}}
return;}
splitIntoColumns({separator,addNewColumns}){const selection=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();const splitted=this.getSplittedCols(selection,separator);if(addNewColumns){this.addColsToAvoidCollisions(selection,splitted);}
this.removeMergesInSplitZone(selection,splitted);this.addColumnsToNotOverflowSheet(selection,splitted);for(let i=0;i<splitted.length;i++){const row=selection.top+i;const splittedContent=splitted[i];const col=selection.left;const mainCell=this.getters.getCell({sheetId,col,row});if(splittedContent.length===1&&splittedContent[0]===mainCell?.content){continue;}
for(const[index,content]of splittedContent.entries()){this.dispatch("UPDATE_CELL",{sheetId,col:col+index,row,content:canonicalizeNumberContent(content,this.getters.getLocale()),format:"",style:mainCell?.style||null,});}}}
getSplittedCols(selection,separator){if(!separator){throw new Error("Separator cannot be empty");}
const sheetId=this.getters.getActiveSheetId();const splitted=[];for(const row of range(selection.top,selection.bottom+1)){const text=this.getters.getEvaluatedCell({sheetId,col:selection.left,row,}).formattedValue;splitted.push(this.splitAndRemoveTrailingEmpty(text,separator));}
return splitted;}
splitAndRemoveTrailingEmpty(string,separator){const splitted=string.split(separator);while(splitted.length>1&&splitted[splitted.length-1]===""){splitted.pop();}
return splitted;}
willSplittedColsOverwriteContent(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();for(const row of range(selection.top,selection.bottom+1)){const splittedText=splittedCols[row-selection.top];for(let i=1;i<splittedText.length;i++){const cell=this.getters.getCell({sheetId,col:selection.left+i,row});if(cell&&cell.content){return true;}}}
return false;}
removeMergesInSplitZone(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();const colsInSplitZone=Math.max(...splittedCols.map((s)=>s.length));const splitZone={...selection,right:selection.left+colsInSplitZone-1};const merges=this.getters.getMergesInZone(sheetId,splitZone);this.dispatch("REMOVE_MERGE",{sheetId,target:merges});}
addColsToAvoidCollisions(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();let colsToAdd=0;for(const row of range(selection.top,selection.bottom+1)){const cellPosition={sheetId,col:selection.left,row};const splittedText=splittedCols[row-selection.top];const colsToAddInRow=this.getColsToAddToAvoidCollision(cellPosition,splittedText);colsToAdd=Math.max(colsToAdd,colsToAddInRow);}
if(colsToAdd){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:selection.left,sheetId,quantity:colsToAdd,position:"after",});}}
getColsToAddToAvoidCollision(cellPosition,splittedText){const maxColumnsToSpread=splittedText.length;for(let i=1;i<maxColumnsToSpread;i++){const col=cellPosition.col+i;const cell=this.getters.getCell({...cellPosition,col});if(cell&&cell.content){return maxColumnsToSpread-i;}}
return 0;}
addColumnsToNotOverflowSheet(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();const maxColumnsToSpread=Math.max(...splittedCols.map((s)=>s.length-1));const maxColIndex=this.getters.getNumberCols(sheetId)-1;if(selection.left+maxColumnsToSpread>maxColIndex){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:maxColIndex,sheetId,quantity:selection.left+maxColumnsToSpread-maxColIndex,position:"after",});}}
checkSingleColSelected(){if(!this.getters.isSingleColSelected()){return"MoreThanOneColumnSelected";}
return"Success";}
checkNonEmptySelector(cmd){if(cmd.separator===""){return"EmptySplitSeparator";}
return"Success";}
checkNotOverwritingContent(cmd){if(cmd.addNewColumns||cmd.force){return"Success";}
const selection=this.getters.getSelectedZones()[0];const splitted=this.getSplittedCols(selection,cmd.separator);if(this.willSplittedColsOverwriteContent(selection,splitted)){return"SplitWillOverwriteContent";}
return"Success";}
checkSeparatorInSelection({separator}){const cells=this.getters.getSelectedCells();for(const cell of cells){if(cell.formattedValue.includes(separator)){return"Success";}}
return"NoSplitSeparatorInSelection";}}
class ClipboardFigureState{operation;getters;dispatch;sheetId;copiedFigure;copiedFigureContent;constructor(operation,getters,dispatch){this.operation=operation;this.getters=getters;this.dispatch=dispatch;this.sheetId=getters.getActiveSheetId();const copiedFigureId=getters.getSelectedFigureId();if(!copiedFigureId){throw new Error(`No figure selected`);}
const figure=getters.getFigure(this.sheetId,copiedFigureId);if(!figure){throw new Error(`No figure for the given id: ${copiedFigureId}`);}
this.copiedFigure={...figure};switch(figure.tag){case"chart":this.copiedFigureContent=new ClipboardFigureChart(dispatch,getters,this.sheetId,copiedFigureId);break;case"image":this.copiedFigureContent=new ClipboardFigureImage(dispatch,getters,this.sheetId,copiedFigureId);break;default:throw new Error(`Unknow tag '${figure.tag}' for the given figure id: ${copiedFigureId}`);}}
isCutAllowed(target){return"Success";}
isPasteAllowed(target,option){if(target.length===0){return"EmptyTarget";}
if(option?.pasteOption!==undefined){return"WrongFigurePasteOption";}
return"Success";}
paste(target){const sheetId=this.getters.getActiveSheetId();const{width,height}=this.copiedFigure;const numCols=this.getters.getNumberCols(sheetId);const numRows=this.getters.getNumberRows(sheetId);const targetX=this.getters.getColDimensions(sheetId,target[0].left).start;const targetY=this.getters.getRowDimensions(sheetId,target[0].top).start;const maxX=this.getters.getColDimensions(sheetId,numCols-1).end;const maxY=this.getters.getRowDimensions(sheetId,numRows-1).end;const position={x:maxX<width?0:Math.min(targetX,maxX-width),y:maxY<height?0:Math.min(targetY,maxY-height),};const newId=new UuidGenerator().uuidv4();this.copiedFigureContent.paste(sheetId,newId,position,{height,width});if(this.operation==="CUT"){this.dispatch("DELETE_FIGURE",{sheetId:this.copiedFigureContent.sheetId,id:this.copiedFigure.id,});}
this.dispatch("SELECT_FIGURE",{id:newId});}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:"\t"};}
isColRowDirtyingClipboard(position,dimension){return false;}
drawClipboard(renderingContext){}}
class ClipboardFigureChart{dispatch;sheetId;copiedChart;constructor(dispatch,getters,sheetId,copiedFigureId){this.dispatch=dispatch;this.sheetId=sheetId;const chart=getters.getChart(copiedFigureId);if(!chart){throw new Error(`No chart for the given id: ${copiedFigureId}`);}
this.copiedChart=chart.copyInSheetId(sheetId);}
paste(sheetId,figureId,position,size){const copy=this.copiedChart.copyInSheetId(sheetId);this.dispatch("CREATE_CHART",{id:figureId,sheetId,position,size,definition:copy.getDefinition(),});}}
class ClipboardFigureImage{dispatch;sheetId;copiedImage;constructor(dispatch,getters,sheetId,copiedFigureId){this.dispatch=dispatch;this.sheetId=sheetId;const image=getters.getImage(copiedFigureId);this.copiedImage=deepCopy(image);}
paste(sheetId,figureId,position,size){const copy=deepCopy(this.copiedImage);this.dispatch("CREATE_IMAGE",{figureId,sheetId,position,size,definition:copy,});}}
function canonicalizeNumberValue(content,locale){return content.startsWith("=")?canonicalizeFormula(content,locale):canonicalizeNumberLiteral(content,locale);}
function canonicalizeFormula(formula,locale){return _localizeFormula(formula,locale,DEFAULT_LOCALE);}
function _localizeFormula(formula,fromLocale,toLocale){if(fromLocale.formulaArgSeparator===toLocale.formulaArgSeparator&&fromLocale.decimalSeparator===toLocale.decimalSeparator){return formula;}
const tokens=tokenize(formula,fromLocale);let localizedFormula="";for(const token of tokens){if(token.type==="NUMBER"){localizedFormula+=token.value.replace(fromLocale.decimalSeparator,toLocale.decimalSeparator);}
else if(token.type==="ARG_SEPARATOR"){localizedFormula+=toLocale.formulaArgSeparator;}
else{localizedFormula+=token.value;}}
return localizedFormula;}
class ClipboardOsState extends ClipboardCellsAbstractState{values;constructor(content,getters,dispatch,selection){super("COPY",getters,dispatch,selection);this.values=content.replace(/\r/g,"").split("\n").map((vals)=>vals.split("\t"));}
isPasteAllowed(target,clipboardOption){const sheetId=this.getters.getActiveSheetId();const pasteZone=this.getPasteZone(target);if(this.getters.doesIntersectMerge(sheetId,pasteZone)){return"WillRemoveExistingMerge";}
return"Success";}
paste(target,clipboardOption){if(clipboardOption?.pasteOption==="onlyFormat"){return;}
const values=this.values;const pasteZone=this.getPasteZone(target);const{left:activeCol,top:activeRow}=pasteZone;const{numberOfCols,numberOfRows}=zoneToDimension(pasteZone);const sheetId=this.getters.getActiveSheetId();const locale=this.getters.getLocale();this.addMissingDimensions(numberOfCols,numberOfRows,activeCol,activeRow);for(let i=0;i<values.length;i++){for(let j=0;j<values[i].length;j++){this.dispatch("UPDATE_CELL",{row:activeRow+i,col:activeCol+j,content:canonicalizeNumberValue(values[i][j],locale),sheetId,});}}
const zone={left:activeCol,top:activeRow,right:activeCol+numberOfCols-1,bottom:activeRow+numberOfRows-1,};this.selection.selectZone({cell:{col:activeCol,row:activeRow},zone},{scrollIntoView:false});}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:this.values.map((values)=>values.join("\t")).join("\n"),};}
getPasteZone(target){const height=this.values.length;const width=largeMax(this.values.map((a)=>a.length));const{left:activeCol,top:activeRow}=target[0];return{top:activeRow,left:activeCol,bottom:activeRow+height-1,right:activeCol+width-1,};}}
class ClipboardPlugin extends UIPlugin{static layers=[2];static getters=["getClipboardContent","getClipboardTextContent","isCutOperation","isPaintingFormat",];status="invisible";state;lastPasteState;paintFormatStatus="inactive";originSheetId;allowDispatch(cmd){switch(cmd.type){case"CUT":const zones=this.getters.getSelectedZones();const state=this.getClipboardState(zones,cmd.type);return state.isCutAllowed(zones);case"PASTE":if(!this.state){return"EmptyClipboard";}
const pasteOption=cmd.pasteOption||(this.paintFormatStatus!=="inactive"?"onlyFormat":undefined);return this.state.isPasteAllowed(cmd.target,{pasteOption});case"PASTE_FROM_OS_CLIPBOARD":{const state=new ClipboardOsState(cmd.text,this.getters,this.dispatch,this.selection);return state.isPasteAllowed(cmd.target,{pasteOption:cmd.pasteOption});}
case"COPY_PASTE_CELLS_ABOVE":{const zones=this.getters.getSelectedZones();if(zones.length>1||(zones[0].top===0&&zones[0].bottom===0)){return"InvalidCopyPasteSelection";}
break;}
case"COPY_PASTE_CELLS_ON_LEFT":{const zones=this.getters.getSelectedZones();if(zones.length>1||(zones[0].left===0&&zones[0].right===0)){return"InvalidCopyPasteSelection";}
break;}
case"INSERT_CELL":{const{cut,paste}=this.getInsertCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");return state.isPasteAllowed(paste);}
case"DELETE_CELL":{const{cut,paste}=this.getDeleteCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");return state.isPasteAllowed(paste);}
case"ACTIVATE_PAINT_FORMAT":{if(this.paintFormatStatus!=="inactive"){return"AlreadyInPaintingFormatMode";}}}
return"Success";}
handle(cmd){switch(cmd.type){case"COPY":case"CUT":const zones=this.getters.getSelectedZones();this.state=this.getClipboardState(zones,cmd.type);this.status="visible";this.originSheetId=this.getters.getActiveSheetId();break;case"PASTE":if(!this.state){break;}
const pasteOption=cmd.pasteOption||(this.paintFormatStatus!=="inactive"?"onlyFormat":undefined);this.state.paste(cmd.target,{pasteOption,shouldPasteCF:true,selectTarget:true});if(this.state.operation==="CUT"){this.state=undefined;}
this.lastPasteState=this.state;if(this.paintFormatStatus==="oneOff"){this.paintFormatStatus="inactive";}
this.status="invisible";break;case"COPY_PASTE_CELLS_ABOVE":{const zone=this.getters.getSelectedZone();const multipleRowsInSelection=zone.top!==zone.bottom;const copyTarget={...zone,bottom:multipleRowsInSelection?zone.top:zone.top-1,top:multipleRowsInSelection?zone.top:zone.top-1,};const state=this.getClipboardStateForCopyCells([copyTarget],"COPY");state.paste([zone],{pasteOption:undefined,shouldPasteCF:true,selectTarget:true,});}
break;case"COPY_PASTE_CELLS_ON_LEFT":{const zone=this.getters.getSelectedZone();const multipleColsInSelection=zone.left!==zone.right;const copyTarget={...zone,right:multipleColsInSelection?zone.left:zone.left-1,left:multipleColsInSelection?zone.left:zone.left-1,};const state=this.getClipboardStateForCopyCells([copyTarget],"COPY");state.paste([zone],{pasteOption:undefined,shouldPasteCF:true,selectTarget:true,});}
break;case"CLEAN_CLIPBOARD_HIGHLIGHT":this.status="invisible";break;case"DELETE_CELL":{const{cut,paste}=this.getDeleteCellsTargets(cmd.zone,cmd.shiftDimension);if(!isZoneValid(cut[0])){for(const{col,row}of positions(cmd.zone)){this.dispatch("CLEAR_CELL",{col,row,sheetId:this.getters.getActiveSheetId()});}
break;}
const state=this.getClipboardStateForCopyCells(cut,"CUT");state.paste(paste);break;}
case"INSERT_CELL":{const{cut,paste}=this.getInsertCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");state.paste(paste);break;}
case"ADD_COLUMNS_ROWS":{this.status="invisible";if(this.state?.operation!=="CUT"){return;}
const isClipboardDirty=this.state.isColRowDirtyingClipboard(cmd.position==="before"?cmd.base:cmd.base+1,cmd.dimension);if(isClipboardDirty){this.state=undefined;}
break;}
case"REMOVE_COLUMNS_ROWS":{this.status="invisible";if(this.state?.operation!=="CUT"){return;}
for(let el of cmd.elements){const isClipboardDirty=this.state.isColRowDirtyingClipboard(el,cmd.dimension);if(isClipboardDirty){this.state=undefined;break;}}
this.status="invisible";break;}
case"PASTE_FROM_OS_CLIPBOARD":this.state=new ClipboardOsState(cmd.text,this.getters,this.dispatch,this.selection);this.state.paste(cmd.target,{pasteOption:cmd.pasteOption});this.lastPasteState=this.state;this.status="invisible";break;case"REPEAT_PASTE":{this.lastPasteState?.paste(cmd.target,{pasteOption:cmd.pasteOption,shouldPasteCF:true,selectTarget:true,});break;}
case"ACTIVATE_PAINT_FORMAT":{const zones=this.getters.getSelectedZones();this.state=this.getClipboardStateForCopyCells(zones,"COPY");this.status="visible";if(cmd.persistent){this.paintFormatStatus="persistent";}
else{this.paintFormatStatus="oneOff";}
break;}
case"DELETE_SHEET":if(this.state?.operation!=="CUT"){return;}
if(this.originSheetId===cmd.sheetId){this.state=undefined;this.status="invisible";}
break;case"CANCEL_PAINT_FORMAT":{this.paintFormatStatus="inactive";this.status="invisible";break;}
default:if(isCoreCommand(cmd)){this.status="invisible";}}}
getClipboardContent(){return this.state?.getClipboardContent()||{[ClipboardMIMEType.PlainText]:"\t"};}
getClipboardTextContent(){return this.state?.getClipboardContent()[ClipboardMIMEType.PlainText]||"\t";}
isCutOperation(){return this.state?this.state.operation==="CUT":false;}
isPaintingFormat(){return this.paintFormatStatus!=="inactive";}
getDeleteCellsTargets(zone,dimension){const sheetId=this.getters.getActiveSheetId();let cut;if(dimension==="COL"){cut={...zone,left:zone.right+1,right:this.getters.getNumberCols(sheetId)-1,};}
else{cut={...zone,top:zone.bottom+1,bottom:this.getters.getNumberRows(sheetId)-1,};}
return{cut:[cut],paste:[zone]};}
getInsertCellsTargets(zone,dimension){const sheetId=this.getters.getActiveSheetId();let cut;let paste;if(dimension==="COL"){cut={...zone,right:this.getters.getNumberCols(sheetId)-1,};paste={...zone,left:zone.right+1,right:zone.right+1,};}
else{cut={...zone,bottom:this.getters.getNumberRows(sheetId)-1,};paste={...zone,top:zone.bottom+1,bottom:this.getters.getNumberRows(sheetId)-1};}
return{cut:[cut],paste:[paste]};}
getClipboardStateForCopyCells(zones,operation){return new ClipboardCellsState(zones,operation,this.getters,this.dispatch,this.selection);}
getClipboardState(zones,operation){const selectedFigureId=this.getters.getSelectedFigureId();if(selectedFigureId){return new ClipboardFigureState(operation,this.getters,this.dispatch);}
return new ClipboardCellsState(zones,operation,this.getters,this.dispatch,this.selection);}
drawGrid(renderingContext){if(this.status!=="visible"||!this.state){return;}
this.state.drawClipboard(renderingContext);}}
function loopThroughReferenceType(token){if(token.type!=="REFERENCE")
return token;const{xc,sheetName}=splitReference(token.value);const[left,right]=xc.split(":");const sheetRef=sheetName?`${getCanonicalSheetName(sheetName)}!`:"";const updatedLeft=getTokenNextReferenceType(left);const updatedRight=right?`:${getTokenNextReferenceType(right)}`:"";return{...token,value:sheetRef+updatedLeft+updatedRight};}
function getTokenNextReferenceType(xc){switch(getReferenceType(xc)){case"none":xc=setXcToReferenceType(xc,"colrow");break;case"colrow":xc=setXcToReferenceType(xc,"row");break;case"row":xc=setXcToReferenceType(xc,"col");break;case"col":xc=setXcToReferenceType(xc,"none");break;}
return xc;}
function setXcToReferenceType(xc,referenceType){xc=xc.replace(/\$/g,"");let indexOfNumber;switch(referenceType){case"col":return"$"+xc;case"row":indexOfNumber=xc.search(/[0-9]/);return xc.slice(0,indexOfNumber)+"$"+xc.slice(indexOfNumber);case"colrow":indexOfNumber=xc.search(/[0-9]/);if(indexOfNumber===-1||indexOfNumber===0){return"$"+xc;}
xc=xc.slice(0,indexOfNumber)+"$"+xc.slice(indexOfNumber);return"$"+xc;case"none":return xc;}}
function getReferenceType(xcCell){if(isColAndRowFixed(xcCell)){return"colrow";}
else if(isColFixed(xcCell)){return"col";}
else if(isRowFixed(xcCell)){return"row";}
return"none";}
function isColFixed(xc){return xc.startsWith("$");}
function isRowFixed(xc){return xc.includes("$",1);}
function isColAndRowFixed(xc){return xc.startsWith("$")&&xc.length>1&&xc.slice(1).includes("$");}
const CELL_DELETED_MESSAGE=_t("The cell you are trying to edit has been deleted.");class EditionPlugin extends UIPlugin{static getters=["getEditionMode","isSelectingForComposer","showSelectionIndicator","getCurrentContent","getComposerSelection","getCurrentTokens","getTokenAtCursor","getComposerHighlights","getCurrentEditedCell","getCycledReference","getAutoCompleteDataValidationValues",];col=0;row=0;mode="inactive";sheetId="";currentContent="";currentTokens=[];selectionStart=0;selectionEnd=0;initialContent="";colorIndexByRange={};allowDispatch(cmd){switch(cmd.type){case"CHANGE_COMPOSER_CURSOR_SELECTION":return this.validateSelection(this.currentContent.length,cmd.start,cmd.end);case"SET_CURRENT_CONTENT":if(cmd.selection){return this.validateSelection(cmd.content.length,cmd.selection.start,cmd.selection.end);}
break;case"START_EDITION":if(cmd.selection){const content=cmd.text||this.getComposerContent(this.getters.getActivePosition());return this.validateSelection(content.length,cmd.selection.start,cmd.selection.end);}
break;case"STOP_EDITION":if(this.mode==="inactive"){return"Success";}
return this.checkDataValidation(cmd);}
return"Success";}
handleEvent(event){const sheetId=this.getters.getActiveSheetId();let unboundedZone;if(event.options.unbounded){unboundedZone=this.getters.getUnboundedZone(sheetId,event.anchor.zone);}
else{unboundedZone=event.anchor.zone;}
switch(event.mode){case"newAnchor":if(this.mode==="selecting"){this.insertSelectedRange(unboundedZone);}
break;default:if(this.mode==="selecting"){this.replaceSelectedRange(unboundedZone);}
else{this.updateComposerRange(event.previousAnchor.zone,unboundedZone);}
break;}}
handle(cmd){switch(cmd.type){case"CHANGE_COMPOSER_CURSOR_SELECTION":this.selectionStart=cmd.start;this.selectionEnd=cmd.end;break;case"STOP_COMPOSER_RANGE_SELECTION":if(this.isSelectingForComposer()){this.mode="editing";}
break;case"START_EDITION":if(this.mode!=="inactive"&&cmd.text){this.setContent(cmd.text,cmd.selection);}
else{this.startEdition(cmd.text,cmd.selection);}
this.updateRangeColor();break;case"STOP_EDITION":this.stopEdition();this.colorIndexByRange={};break;case"CANCEL_EDITION":this.cancelEditionAndActivateSheet();this.resetContent();this.colorIndexByRange={};break;case"SET_CURRENT_CONTENT":this.setContent(cmd.content,cmd.selection,true);this.updateRangeColor();break;case"REPLACE_COMPOSER_CURSOR_SELECTION":this.replaceSelection(cmd.text);break;case"SELECT_FIGURE":this.cancelEditionAndActivateSheet();this.resetContent();break;case"ADD_COLUMNS_ROWS":this.onAddElements(cmd);break;case"REMOVE_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.onColumnsRemoved(cmd);}
else{this.onRowsRemoved(cmd);}
break;case"START_CHANGE_HIGHLIGHT":const{left,top}=cmd.zone;if(this.isSelectingForComposer()){this.mode="editing";}
this.selection.resetAnchor(this,{cell:{col:left,row:top},zone:cmd.zone});break;case"ACTIVATE_SHEET":if(!this.currentContent.startsWith("=")){this.cancelEdition();this.resetContent();}
if(cmd.sheetIdFrom!==cmd.sheetIdTo){const activePosition=this.getters.getActivePosition();const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:cmd.sheetIdTo,col:activePosition.col,row:activePosition.row,});const zone=this.getters.expandZone(cmd.sheetIdTo,positionToZone({col,row}));this.selection.resetAnchor(this,{cell:{col,row},zone});}
break;case"DELETE_SHEET":case"UNDO":case"REDO":const sheetIdExists=!!this.getters.tryGetSheet(this.sheetId);if(!sheetIdExists&&this.mode!=="inactive"){this.sheetId=this.getters.getActiveSheetId();this.cancelEditionAndActivateSheet();this.resetContent();this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);}
break;case"CYCLE_EDITION_REFERENCES":this.cycleReferences();break;}}
getEditionMode(){return this.mode;}
getCurrentContent(){if(this.mode==="inactive"){return this.getComposerContent(this.getters.getActivePosition());}
return this.currentContent;}
getComposerSelection(){return{start:this.selectionStart,end:this.selectionEnd,};}
getCurrentEditedCell(){return{sheetId:this.sheetId,col:this.col,row:this.row,};}
isSelectingForComposer(){return this.mode==="selecting";}
showSelectionIndicator(){return this.isSelectingForComposer()&&this.canStartComposerRangeSelection();}
getCurrentTokens(){return this.currentTokens;}
getTokenAtCursor(){const start=Math.min(this.selectionStart,this.selectionEnd);const end=Math.max(this.selectionStart,this.selectionEnd);if(start===end&&end===0){return undefined;}
else{return this.currentTokens.find((t)=>t.start<=start&&t.end>=end);}}
getCycledReference(selection,content){const locale=this.getters.getLocale();const currentTokens=content.startsWith("=")?composerTokenize(content,locale):[];const tokens=currentTokens.filter((t)=>(t.start<=selection.start&&t.end>=selection.start)||(t.start>=selection.start&&t.start<selection.end));const refTokens=tokens.filter((token)=>token.type==="REFERENCE");if(refTokens.length===0){return;}
const updatedReferences=tokens.map(loopThroughReferenceType).map((token)=>token.value).join("");const start=tokens[0].start;const end=tokens[tokens.length-1].end;const newContent=content.slice(0,start)+updatedReferences+content.slice(end);const lengthDiff=newContent.length-content.length;const startOfTokens=refTokens[0].start;const endOfTokens=refTokens[refTokens.length-1].end+lengthDiff;const newSelection={start:startOfTokens,end:endOfTokens};if(refTokens.length===1&&selection.start===selection.end){newSelection.start=newSelection.end;}
return{content:newContent,selection:newSelection};}
getInitialComposerContent(){return this.initialContent;}
cycleReferences(){const updated=this.getCycledReference(this.getComposerSelection(),this.currentContent);if(updated===undefined){return;}
this.dispatch("SET_CURRENT_CONTENT",{content:updated.content,selection:updated.selection,});}
validateSelection(length,start,end){return start>=0&&start<=length&&end>=0&&end<=length?"Success":"WrongComposerSelection";}
onColumnsRemoved(cmd){if(cmd.elements.includes(this.col)&&this.mode!=="inactive"){this.dispatch("CANCEL_EDITION");this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);return;}
const{top,left}=updateSelectionOnDeletion({left:this.col,right:this.col,top:this.row,bottom:this.row},"left",[...cmd.elements]);this.col=left;this.row=top;}
onRowsRemoved(cmd){if(cmd.elements.includes(this.row)&&this.mode!=="inactive"){this.dispatch("CANCEL_EDITION");this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);return;}
const{top,left}=updateSelectionOnDeletion({left:this.col,right:this.col,top:this.row,bottom:this.row},"top",[...cmd.elements]);this.col=left;this.row=top;}
onAddElements(cmd){const{top,left}=updateSelectionOnInsertion({left:this.col,right:this.col,top:this.row,bottom:this.row},cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);this.col=left;this.row=top;}
startComposerRangeSelection(){if(this.sheetId===this.getters.getActiveSheetId()){const zone=positionToZone({col:this.col,row:this.row});this.selection.resetAnchor(this,{cell:{col:this.col,row:this.row},zone});}
this.mode="selecting";}
startEdition(str,selection){const evaluatedCell=this.getters.getActiveCell();const locale=this.getters.getLocale();if(str&&evaluatedCell.format?.includes("%")&&isNumber(str,locale)){selection=selection||{start:str.length,end:str.length};str=`${str}%`;}
const{col,row,sheetId}=this.getters.getActivePosition();this.col=col;this.sheetId=sheetId;this.row=row;this.initialContent=this.getComposerContent({sheetId,col,row});this.mode="editing";this.setContent(str||this.initialContent,selection);this.colorIndexByRange={};const zone=positionToZone({col:this.col,row:this.row});this.selection.capture(this,{cell:{col:this.col,row:this.row},zone},{handleEvent:this.handleEvent.bind(this),release:()=>{this.stopEdition();},});}
stopEdition(){if(this.mode!=="inactive"){this.cancelEditionAndActivateSheet();const col=this.col;const row=this.row;let content=this.getCurrentCanonicalContent();const didChange=this.initialContent!==content;if(!didChange){return;}
if(content){const sheetId=this.getters.getActiveSheetId();const cell=this.getters.getEvaluatedCell({sheetId,col:this.col,row:this.row});if(content.startsWith("=")){const left=this.currentTokens.filter((t)=>t.type==="LEFT_PAREN").length;const right=this.currentTokens.filter((t)=>t.type==="RIGHT_PAREN").length;const missing=left-right;if(missing>0){content+=concat(new Array(missing).fill(")"));}}
else if(cell.link){content=markdownLink(content,cell.link.url);}
this.dispatch("UPDATE_CELL",{sheetId:this.sheetId,col,row,content,});}
else{this.dispatch("UPDATE_CELL",{sheetId:this.sheetId,content:"",col,row,});}
this.setContent("");}}
getCurrentCanonicalContent(){return canonicalizeNumberContent(this.currentContent,this.getters.getLocale());}
cancelEditionAndActivateSheet(){if(this.mode==="inactive"){return;}
this.cancelEdition();const sheetId=this.getters.getActiveSheetId();if(sheetId!==this.sheetId){this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.getters.getActiveSheetId(),sheetIdTo:this.sheetId,});}}
getComposerContent(position){const locale=this.getters.getLocale();const cell=this.getters.getCell(position);if(cell?.isFormula){return localizeFormula(cell.content,locale);}
const{format,value,type,formattedValue}=this.getters.getEvaluatedCell(position);switch(type){case CellValueType.text:case CellValueType.empty:return value;case CellValueType.boolean:return formattedValue;case CellValueType.error:return cell?.content||"";case CellValueType.number:if(format&&isDateTimeFormat(format)){if(parseDateTime(formattedValue,locale)!==null){return formattedValue;}
const timeFormat=Number.isInteger(value)?locale.dateFormat:getDateTimeFormat(locale);return formatValue(value,{locale,format:timeFormat});}
return this.numberComposerContent(value,format,locale);}}
numberComposerContent(value,format,locale){if(format?.includes("%")){return`${numberToString(value * 100, locale.decimalSeparator)}%`;}
return numberToString(value,locale.decimalSeparator);}
cancelEdition(){if(this.mode==="inactive"){return;}
this.mode="inactive";this.selection.release(this);}
resetContent(){this.setContent(this.initialContent||"");}
setContent(text,selection,raise){const isNewCurrentContent=this.currentContent!==text;this.currentContent=text;if(selection){this.selectionStart=selection.start;this.selectionEnd=selection.end;}
else{this.selectionStart=this.selectionEnd=text.length;}
if(isNewCurrentContent||this.mode!=="inactive"){const locale=this.getters.getLocale();this.currentTokens=text.startsWith("=")?composerTokenize(text,locale):[];if(this.currentTokens.length>100){if(raise){this.ui.raiseBlockingErrorUI(_t("This formula has over 100 parts. It can't be processed properly, consider splitting it into multiple cells"));}}}
if(this.canStartComposerRangeSelection()){this.startComposerRangeSelection();}}
insertSelectedRange(zone){const start=Math.min(this.selectionStart,this.selectionEnd);const ref=this.getZoneReference(zone);if(this.canStartComposerRangeSelection()){this.insertText(ref,start);}
else{this.insertText(","+ref,start);}}
replaceSelectedRange(zone){const ref=this.getZoneReference(zone);const currentToken=this.getTokenAtCursor();const start=currentToken?.type==="REFERENCE"?currentToken.start:this.selectionStart;this.replaceText(ref,start,this.selectionEnd);}
updateComposerRange(oldZone,newZone){const activeSheetId=this.getters.getActiveSheetId();const tokentAtCursor=this.getTokenAtCursor();const tokens=tokentAtCursor?[tokentAtCursor,...this.currentTokens]:this.currentTokens;const previousRefToken=tokens.filter((token)=>token.type==="REFERENCE").find((token)=>{const{xc,sheetName:sheet}=splitReference(token.value);const sheetName=sheet||this.getters.getSheetName(this.sheetId);if(this.getters.getSheetName(activeSheetId)!==sheetName){return false;}
const refRange=this.getters.getRangeFromSheetXC(activeSheetId,xc);return isEqual(this.getters.expandZone(activeSheetId,refRange.zone),oldZone);});if(!previousRefToken){throw new Error("Previous range not found");}
const previousRange=this.getters.getRangeFromSheetXC(activeSheetId,previousRefToken.value);this.selectionStart=previousRefToken.start;this.selectionEnd=this.selectionStart+previousRefToken.value.length;const newRange=this.getters.getRangeFromZone(activeSheetId,newZone);const newRef=this.getRangeReference(newRange,previousRange.parts);this.replaceSelection(newRef);}
getZoneReference(zone){const inputSheetId=this.getters.getCurrentEditedCell().sheetId;const sheetId=this.getters.getActiveSheetId();const range=this.getters.getRangeFromZone(sheetId,zone);return this.getters.getSelectionRangeString(range,inputSheetId);}
getRangeReference(range,fixedParts){let _fixedParts=[...fixedParts];const newRange=range.clone({parts:_fixedParts});return this.getters.getSelectionRangeString(newRange,this.getters.getCurrentEditedCell().sheetId);}
replaceSelection(text){const start=Math.min(this.selectionStart,this.selectionEnd);const end=Math.max(this.selectionStart,this.selectionEnd);this.replaceText(text,start,end);}
replaceText(text,start,end){this.currentContent=this.currentContent.slice(0,start)+
this.currentContent.slice(end,this.currentContent.length);this.insertText(text,start);}
insertText(text,start){const content=this.currentContent.slice(0,start)+text+this.currentContent.slice(start);const end=start+text.length;this.dispatch("SET_CURRENT_CONTENT",{content,selection:{start:end,end},});}
updateRangeColor(){if(!this.currentContent.startsWith("=")||this.mode==="inactive"){return;}
const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const XCs=this.getReferencedRanges().map((range)=>this.getters.getRangeString(range,editionSheetId));const colorsToKeep={};for(const xc of XCs){if(this.colorIndexByRange[xc]!==undefined){colorsToKeep[xc]=this.colorIndexByRange[xc];}}
const usedIndexes=new Set(Object.values(colorsToKeep));let currentIndex=0;const nextIndex=()=>{while(usedIndexes.has(currentIndex))
currentIndex++;usedIndexes.add(currentIndex);return currentIndex;};for(const xc of XCs){const colorIndex=xc in colorsToKeep?colorsToKeep[xc]:nextIndex();colorsToKeep[xc]=colorIndex;}
this.colorIndexByRange=colorsToKeep;}
getComposerHighlights(){if(!this.currentContent.startsWith("=")||this.mode==="inactive"){return[];}
const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const rangeColor=(rangeString)=>{const colorIndex=this.colorIndexByRange[rangeString];return colors$1[colorIndex%colors$1.length];};return this.getReferencedRanges().map((range)=>{const rangeString=this.getters.getRangeString(range,editionSheetId);return{zone:range.zone,color:rangeColor(rangeString),sheetId:range.sheetId,};});}
getReferencedRanges(){const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const referenceRanges=this.currentTokens.filter((token)=>token.type==="REFERENCE").map((token)=>this.getters.getRangeFromSheetXC(editionSheetId,token.value));return referenceRanges.filter((range)=>!range.invalidSheetName&&!range.invalidXc);}
getAutoCompleteDataValidationValues(){if(this.mode==="inactive"){return[];}
const rule=this.getters.getValidationRuleForCell(this.getCurrentEditedCell());if(!rule||(rule.criterion.type!=="isValueInList"&&rule.criterion.type!=="isValueInRange")){return[];}
let values;if(rule.criterion.type==="isValueInList"){values=rule.criterion.values;}
else{const range=this.getters.getRangeFromSheetXC(this.sheetId,rule.criterion.values[0]);values=Array.from(new Set(this.getters.getRangeValues(range).filter(isNotNull).map((value)=>value.toString()).filter((val)=>val!=="")));}
const composerContent=this.getCurrentContent();if(composerContent&&composerContent!==this.getInitialComposerContent()){const filteredValues=fuzzyLookup(composerContent,values,(val)=>val);values=filteredValues.length?filteredValues:values;}
return values;}
canStartComposerRangeSelection(){if(this.currentContent.startsWith("=")){const tokenAtCursor=this.getTokenAtCursor();if(!tokenAtCursor){return false;}
const tokenIdex=this.currentTokens.map((token)=>token.start).indexOf(tokenAtCursor.start);let count=tokenIdex;let currentToken=tokenAtCursor;while(!["ARG_SEPARATOR","LEFT_PAREN","OPERATOR"].includes(currentToken.type)||POSTFIX_UNARY_OPERATORS.includes(currentToken.value)){if(currentToken.type!=="SPACE"||count<1){return false;}
count--;currentToken=this.currentTokens[count];}
count=tokenIdex+1;currentToken=this.currentTokens[count];while(currentToken&&!["ARG_SEPARATOR","RIGHT_PAREN","OPERATOR"].includes(currentToken.type)){if(currentToken.type!=="SPACE"){return false;}
count++;currentToken=this.currentTokens[count];}
return true;}
return false;}
checkDataValidation(cmd){const cellPosition={sheetId:this.sheetId,col:this.col,row:this.row};try{const content=this.getCurrentCanonicalContent();const cellValue=content.startsWith("=")?this.getters.evaluateFormula(this.sheetId,content):parseLiteral(content,this.getters.getLocale());if(isMatrix(cellValue)){return"Success";}
const validationResult=this.getters.getValidationResultForCellValue(cellValue,cellPosition);if(!validationResult.isValid&&validationResult.rule.isBlocking){return"BlockingValidationRule";}
return"Success";}
catch(e){const rule=this.getters.getValidationRuleForCell(cellPosition);return rule?.isBlocking?"BlockingValidationRule":"Success";}}}
class FilterEvaluationPlugin extends UIPlugin{static getters=["getCellBorderWithFilterBorder","getFilterValues","isRowFiltered","isFilterActive",];filterValues={};hiddenRows={};isEvaluationDirty=false;allowDispatch(cmd){switch(cmd.type){case"UPDATE_FILTER":if(!this.getters.getFilterId(cmd)){return"FilterNotFound";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"UNDO":case"REDO":case"UPDATE_CELL":case"EVALUATE_CELLS":case"ACTIVATE_SHEET":case"REMOVE_FILTER_TABLE":case"ADD_COLUMNS_ROWS":case"REMOVE_COLUMNS_ROWS":this.isEvaluationDirty=true;break;case"START":for(const sheetId of this.getters.getSheetIds()){this.filterValues[sheetId]={};for(const filter of this.getters.getFilters(sheetId)){this.filterValues[sheetId][filter.id]=[];}}
break;case"CREATE_SHEET":this.filterValues[cmd.sheetId]={};break;case"HIDE_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"GROUP_HEADERS":case"UNGROUP_HEADERS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_ALL_HEADER_GROUPS":case"UNFOLD_ALL_HEADER_GROUPS":this.updateHiddenRows(cmd.sheetId);break;case"UPDATE_FILTER":this.updateFilter(cmd);this.updateHiddenRows(cmd.sheetId);break;case"DUPLICATE_SHEET":const filterValues={};for(const newFilter of this.getters.getFilters(cmd.sheetIdTo)){const zone=newFilter.zoneWithHeaders;filterValues[newFilter.id]=this.getFilterValues({sheetId:cmd.sheetId,col:zone.left,row:zone.top,});}
this.filterValues[cmd.sheetIdTo]=filterValues;break;}}
finalize(){if(this.isEvaluationDirty){for(const sheetId of this.getters.getSheetIds()){this.updateHiddenRows(sheetId);}
this.isEvaluationDirty=false;}}
isRowFiltered(sheetId,row){return!!this.hiddenRows[sheetId]?.has(row);}
getCellBorderWithFilterBorder(position){const{sheetId,col,row}=position;let filterBorder=undefined;for(let filters of this.getters.getFilterTables(sheetId)){const zone=filters.zone;if(isInside(col,row,zone)){const visibleZone=this.intersectZoneWithViewport(sheetId,zone);filterBorder={top:row===visibleZone.top?DEFAULT_FILTER_BORDER_DESC:undefined,bottom:row===visibleZone.bottom?DEFAULT_FILTER_BORDER_DESC:undefined,left:col===visibleZone.left?DEFAULT_FILTER_BORDER_DESC:undefined,right:col===visibleZone.right?DEFAULT_FILTER_BORDER_DESC:undefined,};}}
const cellBorder=this.getters.getCellBorder(position);const border={...filterBorder,...removeFalsyAttributes(cellBorder||{})};return isObjectEmptyRecursive(border)?null:border;}
getFilterValues(position){const id=this.getters.getFilterId(position);const sheetId=position.sheetId;if(!id||!this.filterValues[sheetId])
return[];return this.filterValues[sheetId][id]||[];}
isFilterActive(position){const id=this.getters.getFilterId(position);const sheetId=position.sheetId;return Boolean(id&&this.filterValues[sheetId]?.[id]?.length);}
intersectZoneWithViewport(sheetId,zone){return{left:this.getters.findVisibleHeader(sheetId,"COL",zone.left,zone.right),right:this.getters.findVisibleHeader(sheetId,"COL",zone.right,zone.left),top:this.getters.findVisibleHeader(sheetId,"ROW",zone.top,zone.bottom),bottom:this.getters.findVisibleHeader(sheetId,"ROW",zone.bottom,zone.top),};}
updateFilter({col,row,hiddenValues,sheetId}){const id=this.getters.getFilterId({sheetId,col,row});if(!id)
return;if(!this.filterValues[sheetId])
this.filterValues[sheetId]={};this.filterValues[sheetId][id]=hiddenValues;}
updateHiddenRows(sheetId){const filters=this.getters.getFilters(sheetId).sort((filter1,filter2)=>filter1.zoneWithHeaders.top-filter2.zoneWithHeaders.top);const hiddenRows=new Set();for(let filter of filters){if(hiddenRows.has(filter.zoneWithHeaders.top)||this.getters.isRowHiddenByUser(sheetId,filter.zoneWithHeaders.top)){continue;}
const filteredValues=this.filterValues[sheetId]?.[filter.id]?.map(toLowerCase);if(!filteredValues||!filter.filteredZone)
continue;for(let row=filter.filteredZone.top;row<=filter.filteredZone.bottom;row++){const value=this.getCellValueAsString(sheetId,filter.col,row);if(filteredValues.includes(value)){hiddenRows.add(row);}}}
this.hiddenRows[sheetId]=hiddenRows;}
getCellValueAsString(sheetId,col,row){const value=this.getters.getEvaluatedCell({sheetId,col,row}).formattedValue;return value.toLowerCase();}
exportForExcel(data){for(const sheetData of data.sheets){const sheetId=sheetData.id;for(const tableData of sheetData.filterTables){const tableZone=toZone(tableData.range);const filters=[];const headerNames=[];for(const i of range(0,zoneToDimension(tableZone).numberOfCols)){const position={sheetId:sheetData.id,col:tableZone.left+i,row:tableZone.top,};const filteredValues=this.getFilterValues(position);const filter=this.getters.getFilter(position);if(!filter)
continue;const valuesInFilterZone=filter.filteredZone?positions(filter.filteredZone).map((position)=>this.getters.getEvaluatedCell({sheetId,...position}).formattedValue):[];if(filteredValues.length){const xlsxDisplayedValues=valuesInFilterZone.filter((val)=>val).filter((val)=>!filteredValues.includes(val));filters.push({colId:i,displayedValues:[...new Set(xlsxDisplayedValues)],displayBlanks:!filteredValues.includes("")&&valuesInFilterZone.some((val)=>!val),});}
const headerPosition={col:filter.col,row:filter.zoneWithHeaders.top,sheetId};const headerString=this.getters.getEvaluatedCell(headerPosition).formattedValue;const headerName=this.getUniqueColNameForExcel(i,headerString,headerNames);headerNames.push(headerName);sheetData.cells[toXC(headerPosition.col,headerPosition.row)]={...sheetData.cells[toXC(headerPosition.col,headerPosition.row)],content:headerName,value:headerName,isFormula:false,};}
tableData.filters=filters;}}}
getUniqueColNameForExcel(colIndex,colName,usedColNames){if(!colName){colName=`Column${colIndex}`;}
let currentColName=colName;let i=2;while(usedColNames.includes(currentColName)){currentColName=colName+String(i);i++;}
return currentColName;}}
const selectionStatisticFunctions=[{name:_t("Sum"),types:[CellValueType.number],compute:(values,locale)=>SUM.compute.bind({locale})([values]),},{name:_t("Avg"),types:[CellValueType.number],compute:(values,locale)=>AVERAGE.compute.bind({locale})([values]),},{name:_t("Min"),types:[CellValueType.number],compute:(values,locale)=>MIN.compute.bind({locale})([values]),},{name:_t("Max"),types:[CellValueType.number],compute:(values,locale)=>MAX.compute.bind({locale})([values]),},{name:_t("Count"),types:[CellValueType.number,CellValueType.text,CellValueType.boolean,CellValueType.error],compute:(values,locale)=>COUNTA.compute.bind({locale})([values]),},{name:_t("Count Numbers"),types:[CellValueType.number,CellValueType.text,CellValueType.boolean,CellValueType.error],compute:(values,locale)=>COUNT.compute.bind({locale})([values]),},];class GridSelectionPlugin extends UIPlugin{static layers=[6];static getters=["getActiveSheet","getActiveSheetId","getActiveCell","getActiveCols","getActiveRows","getCurrentStyle","getSelectedZones","getSelectedZone","getSelectedCells","getStatisticFnResults","getAggregate","getSelectedFigureId","getSelection","getActivePosition","getSheetPosition","isSelected","isSingleColSelected","getElementsFromSelection","tryGetActiveSheetId","isGridSelectionActive",];gridSelection={anchor:{cell:{col:0,row:0},zone:{top:0,left:0,bottom:0,right:0},},zones:[{top:0,left:0,bottom:0,right:0}],};selectedFigureId=null;sheetsData={};moveClient;activeSheet=null;constructor(config){super(config);this.moveClient=config.moveClient;}
allowDispatch(cmd){switch(cmd.type){case"ACTIVATE_SHEET":try{this.getters.getSheet(cmd.sheetIdTo);break;}
catch(error){return"InvalidSheetId";}
case"MOVE_COLUMNS_ROWS":return this.isMoveElementAllowed(cmd);}
return"Success";}
handleEvent(event){const anchor=event.anchor;let zones=[];switch(event.mode){case"overrideSelection":zones=[anchor.zone];break;case"updateAnchor":zones=[...this.gridSelection.zones];const index=zones.findIndex((z)=>isEqual(z,event.previousAnchor.zone));if(index>=0){zones[index]=anchor.zone;}
break;case"newAnchor":zones=[...this.gridSelection.zones,anchor.zone];break;}
this.setSelectionMixin(event.anchor,zones);this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId:this.getters.getActiveSheetId(),col,row,});this.selectedFigureId=null;}
handle(cmd){switch(cmd.type){case"START_EDITION":case"ACTIVATE_SHEET":this.selectedFigureId=null;break;case"DELETE_FIGURE":if(this.selectedFigureId===cmd.id){this.selectedFigureId=null;}
break;case"DELETE_SHEET":if(this.selectedFigureId&&this.getters.getFigure(cmd.sheetId,this.selectedFigureId)){this.selectedFigureId=null;}
break;}
switch(cmd.type){case"START":const firstSheetId=this.getters.getVisibleSheetIds()[0];this.activateSheet(firstSheetId,firstSheetId);const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:firstSheetId,col:0,row:0,});this.selectCell(col,row);this.selection.registerAsDefault(this,this.gridSelection.anchor,{handleEvent:this.handleEvent.bind(this),});this.moveClient({sheetId:firstSheetId,col:0,row:0});break;case"ACTIVATE_SHEET":{this.activateSheet(cmd.sheetIdFrom,cmd.sheetIdTo);break;}
case"REMOVE_COLUMNS_ROWS":{const sheetId=this.getters.getActiveSheetId();if(cmd.sheetId===sheetId){if(cmd.dimension==="COL"){this.onColumnsRemoved(cmd);}
else{this.onRowsRemoved(cmd);}
const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId,col,row});}
break;}
case"ADD_COLUMNS_ROWS":{const sheetId=this.getters.getActiveSheetId();if(cmd.sheetId===sheetId){this.onAddElements(cmd);const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId,col,row});}
break;}
case"MOVE_COLUMNS_ROWS":if(cmd.sheetId===this.getActiveSheetId()){this.onMoveElements(cmd);}
break;case"SELECT_FIGURE":this.selectedFigureId=cmd.id;break;case"ACTIVATE_NEXT_SHEET":this.activateNextSheet("right");break;case"ACTIVATE_PREVIOUS_SHEET":this.activateNextSheet("left");break;case"HIDE_SHEET":if(cmd.sheetId===this.getActiveSheetId()){this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:cmd.sheetId,sheetIdTo:this.getters.getVisibleSheetIds()[0],});}
break;case"UNDO":case"REDO":case"DELETE_SHEET":const deletedSheetIds=Object.keys(this.sheetsData).filter((sheetId)=>!this.getters.tryGetSheet(sheetId));for(const sheetId of deletedSheetIds){delete this.sheetsData[sheetId];}
for(const sheetId in this.sheetsData){const gridSelection=this.clipSelection(sheetId,this.sheetsData[sheetId].gridSelection);this.sheetsData[sheetId]={gridSelection:deepCopy(gridSelection),};}
if(!this.getters.tryGetSheet(this.getters.getActiveSheetId())){const currentSheetIds=this.getters.getVisibleSheetIds();this.activeSheet=this.getters.getSheet(currentSheetIds[0]);if(this.activeSheet.id in this.sheetsData){const{anchor}=this.clipSelection(this.activeSheet.id,this.sheetsData[this.activeSheet.id].gridSelection);this.selectCell(anchor.cell.col,anchor.cell.row);}
else{this.selectCell(0,0);}
const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId:this.getters.getActiveSheetId(),col,row,});}
const sheetId=this.getters.getActiveSheetId();this.gridSelection.zones=this.gridSelection.zones.map((z)=>this.getters.expandZone(sheetId,z));this.gridSelection.anchor.zone=this.getters.expandZone(sheetId,this.gridSelection.anchor.zone);this.setSelectionMixin(this.gridSelection.anchor,this.gridSelection.zones);this.selectedFigureId=null;break;}
this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));}
isGridSelectionActive(){return this.selection.isListening(this);}
getActiveSheet(){return this.activeSheet;}
getActiveSheetId(){return this.activeSheet.id;}
tryGetActiveSheetId(){return this.activeSheet?.id;}
getActiveCell(){return this.getters.getEvaluatedCell(this.getActivePosition());}
getActiveCols(){const activeCols=new Set();for(let zone of this.gridSelection.zones){if(zone.top===0&&zone.bottom===this.getters.getNumberRows(this.getters.getActiveSheetId())-1){for(let i=zone.left;i<=zone.right;i++){activeCols.add(i);}}}
return activeCols;}
getActiveRows(){const activeRows=new Set();const sheetId=this.getters.getActiveSheetId();for(let zone of this.gridSelection.zones){if(zone.left===0&&zone.right===this.getters.getNumberCols(sheetId)-1){for(let i=zone.top;i<=zone.bottom;i++){activeRows.add(i);}}}
return activeRows;}
getCurrentStyle(){const zone=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();return this.getters.getCellStyle({sheetId,col:zone.left,row:zone.top});}
getSelectedZones(){return deepCopy(this.gridSelection.zones);}
getSelectedZone(){return deepCopy(this.gridSelection.anchor.zone);}
getSelection(){return deepCopy(this.gridSelection);}
getSelectedCells(){const sheetId=this.getters.getActiveSheetId();const cells=[];for(const zone of this.gridSelection.zones){cells.push(...this.getters.getEvaluatedCellsInZone(sheetId,zone));}
return cells;}
getSelectedFigureId(){return this.selectedFigureId;}
getActivePosition(){return this.getters.getMainCellPosition({sheetId:this.getActiveSheetId(),col:this.gridSelection.anchor.cell.col,row:this.gridSelection.anchor.cell.row,});}
getSheetPosition(sheetId){if(sheetId===this.getters.getActiveSheetId()){return this.getActivePosition();}
else{const sheetData=this.sheetsData[sheetId];return sheetData?{sheetId,col:sheetData.gridSelection.anchor.cell.col,row:sheetData.gridSelection.anchor.cell.row,}:this.getters.getNextVisibleCellPosition({sheetId,col:0,row:0});}}
getStatisticFnResults(){const sheetId=this.getters.getActiveSheetId();const cells=new Set();for(const zone of this.gridSelection.zones){for(const{col,row}of positions(zone)){if(this.getters.isRowHidden(sheetId,row)||this.getters.isColHidden(sheetId,col)){continue;}
const evaluatedCell=this.getters.getEvaluatedCell({sheetId,col,row});if(evaluatedCell.type!==CellValueType.empty){cells.add(evaluatedCell);}}}
let cellsTypes=new Set();let cellsValues=[];for(let cell of cells){cellsTypes.add(cell.type);cellsValues.push(cell.value);}
const locale=this.getters.getLocale();let statisticFnResults={};for(let fn of selectionStatisticFunctions){let fnResult=undefined;if(fn.types.some((t)=>cellsTypes.has(t))){fnResult=fn.compute(cellsValues,locale);}
statisticFnResults[fn.name]=fnResult;}
return statisticFnResults;}
getAggregate(){let aggregate=0;let n=0;const sheetId=this.getters.getActiveSheetId();const cellPositions=this.gridSelection.zones.map(positions).flat();for(const{col,row}of cellPositions){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.number){n++;aggregate+=cell.value;}}
const locale=this.getters.getLocale();return n<2?null:formatValue(aggregate,{locale});}
isSelected(zone){return!!this.getters.getSelectedZones().find((z)=>isEqual(z,zone));}
isSingleColSelected(){const selection=this.getters.getSelectedZones();if(selection.length!==1||selection[0].left!==selection[0].right){return false;}
return true;}
getElementsFromSelection(dimension){if(dimension==="COL"&&this.getters.getActiveCols().size===0){return[];}
if(dimension==="ROW"&&this.getters.getActiveRows().size===0){return[];}
const zones=this.getters.getSelectedZones();let elements=[];const start=dimension==="COL"?"left":"top";const end=dimension==="COL"?"right":"bottom";for(const zone of zones){const zoneRows=Array.from({length:zone[end]-zone[start]+1},(_,i)=>zone[start]+i);elements=elements.concat(zoneRows);}
return[...new Set(elements)].sort();}
activateSheet(sheetIdFrom,sheetIdTo){if(!this.getters.isSheetVisible(sheetIdTo)){this.dispatch("SHOW_SHEET",{sheetId:sheetIdTo});}
this.setActiveSheet(sheetIdTo);this.sheetsData[sheetIdFrom]={gridSelection:deepCopy(this.gridSelection),};if(sheetIdTo in this.sheetsData){Object.assign(this,this.sheetsData[sheetIdTo]);this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));}
else{const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:sheetIdTo,col:0,row:0,});this.selectCell(col,row);}}
setSelectionMixin(anchor,zones){const{anchor:clippedAnchor,zones:clippedZones}=this.clipSelection(this.getters.getActiveSheetId(),{anchor,zones});this.gridSelection.anchor=clippedAnchor;this.gridSelection.zones=uniqueZones(clippedZones);}
selectCell(col,row){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.expandZone(sheetId,{left:col,right:col,top:row,bottom:row});this.setSelectionMixin({zone,cell:{col,row}},[zone]);}
setActiveSheet(id){const sheet=this.getters.getSheet(id);this.activeSheet=sheet;}
activateNextSheet(direction){const sheetIds=this.getters.getSheetIds();const oldSheetPosition=sheetIds.findIndex((id)=>id===this.activeSheet.id);const delta=direction==="left"?sheetIds.length-1:1;const newPosition=(oldSheetPosition+delta)%sheetIds.length;this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.getActiveSheetId(),sheetIdTo:sheetIds[newPosition],});}
onColumnsRemoved(cmd){const{cell,zone}=this.gridSelection.anchor;const selectedZone=updateSelectionOnDeletion(zone,"left",[...cmd.elements]);let anchorZone={left:cell.col,right:cell.col,top:cell.row,bottom:cell.row};anchorZone=updateSelectionOnDeletion(anchorZone,"left",[...cmd.elements]);const anchor={cell:{col:anchorZone.left,row:anchorZone.top,},zone:selectedZone,};const selections=this.gridSelection.zones.map((zone)=>updateSelectionOnDeletion(zone,"left",[...cmd.elements]));this.setSelectionMixin(anchor,selections);}
onRowsRemoved(cmd){const{cell,zone}=this.gridSelection.anchor;const selectedZone=updateSelectionOnDeletion(zone,"top",[...cmd.elements]);let anchorZone={left:cell.col,right:cell.col,top:cell.row,bottom:cell.row};anchorZone=updateSelectionOnDeletion(anchorZone,"top",[...cmd.elements]);const anchor={cell:{col:anchorZone.left,row:anchorZone.top,},zone:selectedZone,};const selections=this.gridSelection.zones.map((zone)=>updateSelectionOnDeletion(zone,"top",[...cmd.elements]));this.setSelectionMixin(anchor,selections);}
onAddElements(cmd){const start=cmd.dimension==="COL"?"left":"top";const anchorZone=updateSelectionOnInsertion(this.gridSelection.anchor.zone,start,cmd.base,cmd.position,cmd.quantity);const selection=this.gridSelection.zones.map((zone)=>updateSelectionOnInsertion(zone,start,cmd.base,cmd.position,cmd.quantity));const anchor={cell:{col:anchorZone.left,row:anchorZone.top},zone:anchorZone,};this.setSelectionMixin(anchor,selection);}
onMoveElements(cmd){const thickness=cmd.elements.length;this.dispatch("ADD_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,base:cmd.base,quantity:thickness,position:cmd.position,});const isCol=cmd.dimension==="COL";const start=cmd.elements[0];const end=cmd.elements[thickness-1];const isBasedBefore=cmd.base<start;const deltaCol=isBasedBefore&&isCol?thickness:0;const deltaRow=isBasedBefore&&!isCol?thickness:0;const target=[{left:isCol?start+deltaCol:0,right:isCol?end+deltaCol:this.getters.getNumberCols(cmd.sheetId)-1,top:!isCol?start+deltaRow:0,bottom:!isCol?end+deltaRow:this.getters.getNumberRows(cmd.sheetId)-1,},];const state=new ClipboardCellsState(target,"CUT",this.getters,this.dispatch,this.selection);const base=isBasedBefore?cmd.base:cmd.base+1;const pasteTarget=[{left:isCol?base:0,right:isCol?base+thickness-1:this.getters.getNumberCols(cmd.sheetId)-1,top:!isCol?base:0,bottom:!isCol?base+thickness-1:this.getters.getNumberRows(cmd.sheetId)-1,},];state.paste(pasteTarget,{selectTarget:true});const toRemove=isBasedBefore?cmd.elements.map((el)=>el+thickness):cmd.elements;let currentIndex=cmd.base;for(const element of toRemove){const size=this.getters.getHeaderSize(cmd.sheetId,cmd.dimension,element);this.dispatch("RESIZE_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,size,elements:[currentIndex],});currentIndex+=1;}
this.dispatch("REMOVE_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,elements:toRemove,});}
isMoveElementAllowed(cmd){const isCol=cmd.dimension==="COL";const start=cmd.elements[0];const end=cmd.elements[cmd.elements.length-1];const id=cmd.sheetId;const doesElementsHaveCommonMerges=isCol?this.getters.doesColumnsHaveCommonMerges:this.getters.doesRowsHaveCommonMerges;if(doesElementsHaveCommonMerges(id,start-1,start)||doesElementsHaveCommonMerges(id,end,end+1)||doesElementsHaveCommonMerges(id,cmd.base-1,cmd.base)){return"WillRemoveExistingMerge";}
const headers=[cmd.base,...cmd.elements];const maxHeaderValue=isCol?this.getters.getNumberCols(id):this.getters.getNumberRows(id);if(headers.some((h)=>h<0||h>=maxHeaderValue)){return"InvalidHeaderIndex";}
return"Success";}
clipSelection(sheetId,selection){const cols=this.getters.getNumberCols(sheetId)-1;const rows=this.getters.getNumberRows(sheetId)-1;const zones=selection.zones.map((z)=>{return{left:clip(z.left,0,cols),right:clip(z.right,0,cols),top:clip(z.top,0,rows),bottom:clip(z.bottom,0,rows),};});const anchorCol=clip(selection.anchor.cell.col,0,cols);const anchorRow=clip(selection.anchor.cell.row,0,rows);const anchorZone={left:clip(selection.anchor.zone.left,0,cols),right:clip(selection.anchor.zone.right,0,cols),top:clip(selection.anchor.zone.top,0,rows),bottom:clip(selection.anchor.zone.bottom,0,rows),};return{zones,anchor:{cell:{col:anchorCol,row:anchorRow},zone:anchorZone,},};}
drawGrid(renderingContext){if(this.getters.isDashboard()){return;}
const{ctx,thinLineWidth}=renderingContext;const zones=this.getSelectedZones();ctx.fillStyle="#f3f7fe";const onlyOneCell=zones.length===1&&zones[0].left===zones[0].right&&zones[0].top===zones[0].bottom;ctx.fillStyle=onlyOneCell?"#f3f7fe":"#e9f0ff";ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=1.5*thinLineWidth;for(const zone of zones){const{x,y,width,height}=this.getters.getVisibleRect(zone);ctx.globalCompositeOperation="multiply";ctx.fillRect(x,y,width,height);ctx.globalCompositeOperation="source-over";ctx.strokeRect(x,y,width,height);}
ctx.globalCompositeOperation="source-over";const position=this.getActivePosition();ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=3*thinLineWidth;let zone;if(this.getters.isInMerge(position)){zone=this.getters.getMerge(position);}
else{zone=positionToZone(position);}
const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width>0&&height>0){ctx.strokeRect(x,y,width,height);}}}
class InternalViewport{getters;sheetId;boundaries;top;bottom;left;right;offsetX;offsetY;offsetScrollbarX;offsetScrollbarY;canScrollVertically;canScrollHorizontally;viewportWidth;viewportHeight;offsetCorrectionX;offsetCorrectionY;constructor(getters,sheetId,boundaries,sizeInGrid,options,offsets){this.getters=getters;this.sheetId=sheetId;this.boundaries=boundaries;this.viewportWidth=sizeInGrid.width;this.viewportHeight=sizeInGrid.height;this.offsetScrollbarX=offsets.x;this.offsetScrollbarY=offsets.y;this.canScrollVertically=options.canScrollVertically;this.canScrollHorizontally=options.canScrollHorizontally;this.offsetCorrectionX=this.getters.getColDimensions(this.sheetId,this.boundaries.left).start;this.offsetCorrectionY=this.getters.getRowDimensions(this.sheetId,this.boundaries.top).start;this.adjustViewportOffsetX();this.adjustViewportOffsetY();}
getMaxSize(){const lastCol=this.getters.findLastVisibleColRowIndex(this.sheetId,"COL",{first:this.boundaries.left,last:this.boundaries.right,});const lastRow=this.getters.findLastVisibleColRowIndex(this.sheetId,"ROW",{first:this.boundaries.top,last:this.boundaries.bottom,});const{end:lastColEnd,size:lastColSize}=this.getters.getColDimensions(this.sheetId,lastCol);const{end:lastRowEnd,size:lastRowSize}=this.getters.getRowDimensions(this.sheetId,lastRow);const leftColIndex=this.searchHeaderIndex("COL",lastColEnd-this.viewportWidth,0);const leftColSize=this.getters.getColSize(this.sheetId,leftColIndex);const leftRowIndex=this.searchHeaderIndex("ROW",lastRowEnd-this.viewportHeight,0);const topRowSize=this.getters.getRowSize(this.sheetId,leftRowIndex);let width=lastColEnd-this.offsetCorrectionX;if(this.canScrollHorizontally){width+=Math.max(DEFAULT_CELL_WIDTH,Math.min(leftColSize,this.viewportWidth-lastColSize));width=Math.max(width,this.viewportWidth);}
let height=lastRowEnd-this.offsetCorrectionY;if(this.canScrollVertically){height+=Math.max(DEFAULT_CELL_HEIGHT+5,Math.min(topRowSize,this.viewportHeight-lastRowSize));height=Math.max(height,this.viewportHeight);}
if(lastRowEnd+FOOTER_HEIGHT>height&&!this.getters.isReadonly()){height+=FOOTER_HEIGHT;}
return{width,height};}
getColIndex(x){if(x<this.offsetCorrectionX||x>this.offsetCorrectionX+this.viewportWidth){return-1;}
return this.searchHeaderIndex("COL",x-this.offsetCorrectionX,this.left);}
getRowIndex(y){if(y<this.offsetCorrectionY||y>this.offsetCorrectionY+this.viewportHeight){return-1;}
return this.searchHeaderIndex("ROW",y-this.offsetCorrectionY,this.top);}
adjustPosition(position){const sheetId=this.sheetId;if(!position){position=this.getters.getSheetPosition(sheetId);}
const mainCellPosition=this.getters.getMainCellPosition({sheetId,...position});const{col,row}=this.getters.getNextVisibleCellPosition(mainCellPosition);if(isInside(col,this.boundaries.top,this.boundaries)){this.adjustPositionX(col);}
if(isInside(this.boundaries.left,row,this.boundaries)){this.adjustPositionY(row);}}
adjustPositionX(targetCol){const sheetId=this.sheetId;const{end}=this.getters.getColDimensions(sheetId,targetCol);const maxCol=this.getters.getNumberCols(sheetId);if(this.offsetX+this.offsetCorrectionX+this.viewportWidth<end){let finalTarget=targetCol;while(this.getters.isColHidden(sheetId,finalTarget)&&targetCol<maxCol){finalTarget++;}
const finalTargetEnd=this.getters.getColDimensions(sheetId,finalTarget).end;const startIndex=this.searchHeaderIndex("COL",finalTargetEnd-this.viewportWidth-this.offsetCorrectionX,this.boundaries.left);this.offsetX=this.getters.getColDimensions(sheetId,startIndex).end-this.offsetCorrectionX;this.offsetScrollbarX=this.offsetX;this.adjustViewportZoneX();}
else if(this.left>targetCol){let finalTarget=targetCol;while(this.getters.isColHidden(sheetId,finalTarget)&&targetCol>0){finalTarget--;}
this.offsetX=this.getters.getColDimensions(sheetId,finalTarget).start-this.offsetCorrectionX;this.offsetScrollbarX=this.offsetX;this.adjustViewportZoneX();}}
adjustPositionY(targetRow){const sheetId=this.sheetId;const{end}=this.getters.getRowDimensions(sheetId,targetRow);const maxRow=this.getters.getNumberRows(sheetId);if(this.offsetY+this.viewportHeight+this.offsetCorrectionY<end){let finalTarget=targetRow;while(this.getters.isRowHidden(sheetId,finalTarget)&&targetRow<maxRow){finalTarget++;}
const finalTargetEnd=this.getters.getRowDimensions(sheetId,finalTarget).end;const startIndex=this.searchHeaderIndex("ROW",finalTargetEnd-this.viewportHeight-this.offsetCorrectionY,this.boundaries.top);this.offsetY=this.getters.getRowDimensions(sheetId,startIndex).end-this.offsetCorrectionY;this.offsetScrollbarY=this.offsetY;this.adjustViewportZoneY();}
else if(this.top>targetRow){let finalTarget=targetRow;while(this.getters.isRowHidden(sheetId,finalTarget)&&targetRow>0){finalTarget--;}
this.offsetY=this.getters.getRowDimensions(sheetId,finalTarget).start-this.offsetCorrectionY;this.offsetScrollbarY=this.offsetY;this.adjustViewportZoneY();}}
setViewportOffset(offsetX,offsetY){this.setViewportOffsetX(offsetX);this.setViewportOffsetY(offsetY);}
adjustViewportZone(){this.adjustViewportZoneX();this.adjustViewportZoneY();}
getRect(zone){const targetZone=intersection(zone,this.zone);if(targetZone){const x=this.getters.getColRowOffset("COL",this.zone.left,targetZone.left)+
this.offsetCorrectionX;const y=this.getters.getColRowOffset("ROW",this.zone.top,targetZone.top)+this.offsetCorrectionY;const width=Math.min(this.getters.getColRowOffset("COL",targetZone.left,targetZone.right+1),this.viewportWidth);const height=Math.min(this.getters.getColRowOffset("ROW",targetZone.top,targetZone.bottom+1),this.viewportHeight);return{x,y,width,height,};}
else{return undefined;}}
isVisible(col,row){const isInside=row<=this.bottom&&row>=this.top&&col>=this.left&&col<=this.right;return(isInside&&!this.getters.isColHidden(this.sheetId,col)&&!this.getters.isRowHidden(this.sheetId,row));}
searchHeaderIndex(dimension,position,startIndex=0){const sheetId=this.sheetId;const headers=this.getters.getNumberHeaders(sheetId,dimension);let start=startIndex;let end=headers;while(start<=end&&start!==headers&&end!==-1){const mid=Math.floor((start+end)/2);const offset=this.getters.getColRowOffset(dimension,startIndex,mid);const size=this.getters.getHeaderSize(sheetId,dimension,mid);if(position>=offset&&position<offset+size){return mid;}
else if(position>=offset+size){start=mid+1;}
else{end=mid-1;}}
return-1;}
get zone(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom};}
setViewportOffsetX(offsetX){if(!this.canScrollHorizontally){return;}
this.offsetScrollbarX=offsetX;this.adjustViewportZoneX();}
setViewportOffsetY(offsetY){if(!this.canScrollVertically){return;}
this.offsetScrollbarY=offsetY;this.adjustViewportZoneY();}
adjustViewportOffsetX(){if(this.canScrollHorizontally){const{width:viewportWidth}=this.getMaxSize();if(this.viewportWidth+this.offsetScrollbarX>viewportWidth){this.offsetScrollbarX=Math.max(0,viewportWidth-this.viewportWidth);}}
this.left=this.getColIndex(this.offsetScrollbarX);this.right=this.getColIndex(this.offsetScrollbarX+this.viewportWidth);if(this.right===-1){this.right=this.boundaries.right;}
this.adjustViewportZoneX();}
adjustViewportOffsetY(){if(this.canScrollVertically){const{height:paneHeight}=this.getMaxSize();if(this.viewportHeight+this.offsetScrollbarY>paneHeight){this.offsetScrollbarY=Math.max(0,paneHeight-this.viewportHeight);}}
this.top=this.getRowIndex(this.offsetScrollbarY);this.bottom=this.getRowIndex(this.offsetScrollbarY+this.viewportHeight);if(this.bottom===-1){this.bottom=this.boundaries.bottom;}
this.adjustViewportZoneY();}
adjustViewportZoneX(){const sheetId=this.sheetId;this.left=this.searchHeaderIndex("COL",this.offsetScrollbarX,this.boundaries.left);this.right=Math.min(this.boundaries.right,this.searchHeaderIndex("COL",this.viewportWidth,this.left));if(this.left===-1){this.left=this.boundaries.left;}
if(this.right===-1){this.right=this.getters.getNumberCols(sheetId)-1;}
this.offsetX=this.getters.getColDimensions(sheetId,this.left).start-
this.getters.getColDimensions(sheetId,this.boundaries.left).start;}
adjustViewportZoneY(){const sheetId=this.sheetId;this.top=this.searchHeaderIndex("ROW",this.offsetScrollbarY,this.boundaries.top);this.bottom=Math.min(this.boundaries.bottom,this.searchHeaderIndex("ROW",this.viewportHeight,this.top));if(this.top===-1){this.top=this.boundaries.top;}
if(this.bottom===-1){this.bottom=this.getters.getNumberRows(sheetId)-1;}
this.offsetY=this.getters.getRowDimensions(sheetId,this.top).start-
this.getters.getRowDimensions(sheetId,this.boundaries.top).start;}}
class SheetViewPlugin extends UIPlugin{static getters=["getColIndex","getRowIndex","getActiveMainViewport","getSheetViewDimension","getSheetViewDimensionWithHeaders","getMainViewportRect","isVisibleInViewport","getEdgeScrollCol","getEdgeScrollRow","getVisibleFigures","getVisibleRect","getVisibleRectWithoutHeaders","getVisibleCellPositions","getColRowOffsetInViewport","getMainViewportCoordinates","getActiveSheetScrollInfo","getActiveSheetDOMScrollInfo","getSheetViewVisibleCols","getSheetViewVisibleRows","getFrozenSheetViewRatio","isPositionVisible",];viewports={};sheetViewWidth=getDefaultSheetViewSize();sheetViewHeight=getDefaultSheetViewSize();gridOffsetX=0;gridOffsetY=0;sheetsWithDirtyViewports=new Set();shouldAdjustViewports=false;allowDispatch(cmd){switch(cmd.type){case"SET_VIEWPORT_OFFSET":return this.checkScrollingDirection(cmd);case"RESIZE_SHEETVIEW":return this.chainValidations(this.checkValuesAreDifferent,this.checkPositiveDimension)(cmd);default:return"Success";}}
handleEvent(event){const sheetId=this.getters.getActiveSheetId();if(event.options.scrollIntoView){let{col,row}=findCellInNewZone(event.previousAnchor.zone,event.anchor.zone);if(event.mode==="updateAnchor"){const oldZone=event.previousAnchor.zone;const newZone=event.anchor.zone;const{top,bottom,left,right}=this.getMainInternalViewport(sheetId);if(oldZone.left===newZone.left&&oldZone.right===newZone.right){col=left>col||col>right?left:col;}
if(oldZone.top===newZone.top&&oldZone.bottom===newZone.bottom){row=top>row||row>bottom?top:row;}}
col=Math.min(col,this.getters.getNumberCols(sheetId)-1);row=Math.min(row,this.getters.getNumberRows(sheetId)-1);if(!this.sheetsWithDirtyViewports.has(sheetId)){this.refreshViewport(this.getters.getActiveSheetId(),{col,row});}}}
handle(cmd){this.cleanViewports();if(invalidateEvaluationCommands.has(cmd.type)){for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}}
switch(cmd.type){case"START":this.selection.observe(this,{handleEvent:this.handleEvent.bind(this),});this.resetViewports(this.getters.getActiveSheetId());break;case"UNDO":case"REDO":for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}
this.shouldAdjustViewports=true;break;case"RESIZE_SHEETVIEW":this.resizeSheetView(cmd.height,cmd.width,cmd.gridOffsetX,cmd.gridOffsetY);break;case"SET_VIEWPORT_OFFSET":this.setSheetViewOffset(cmd.offsetX,cmd.offsetY);break;case"SHIFT_VIEWPORT_DOWN":const sheetId=this.getters.getActiveSheetId();const{top,viewportHeight,offsetCorrectionY}=this.getMainInternalViewport(sheetId);const topRowDims=this.getters.getRowDimensions(sheetId,top);this.shiftVertically(topRowDims.start+viewportHeight-offsetCorrectionY);break;case"SHIFT_VIEWPORT_UP":{const sheetId=this.getters.getActiveSheetId();const{top,viewportHeight,offsetCorrectionY}=this.getMainInternalViewport(sheetId);const topRowDims=this.getters.getRowDimensions(sheetId,top);this.shiftVertically(topRowDims.end-offsetCorrectionY-viewportHeight);break;}
case"REMOVE_FILTER_TABLE":case"UPDATE_FILTER":this.sheetsWithDirtyViewports.add(cmd.sheetId);break;case"REMOVE_COLUMNS_ROWS":case"RESIZE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"UNGROUP_HEADERS":case"GROUP_HEADERS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_ALL_HEADER_GROUPS":case"FOLD_ALL_HEADER_GROUPS":{const sheetId="sheetId"in cmd?cmd.sheetId:this.getters.getActiveSheetId();this.sheetsWithDirtyViewports.add(sheetId);break;}
case"UPDATE_CELL":if("content"in cmd||"format"in cmd||cmd.style?.fontSize!==undefined){for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}}
break;case"ACTIVATE_SHEET":this.sheetsWithDirtyViewports.add(cmd.sheetIdTo);break;case"UNFREEZE_ROWS":case"UNFREEZE_COLUMNS":case"FREEZE_COLUMNS":case"FREEZE_ROWS":case"UNFREEZE_COLUMNS_ROWS":this.resetViewports(this.getters.getActiveSheetId());break;case"DELETE_SHEET":this.sheetsWithDirtyViewports.delete(cmd.sheetId);break;case"START_EDITION":const{col,row}=this.getters.getActivePosition();this.refreshViewport(this.getters.getActiveSheetId(),{col,row});break;}}
finalize(){for(const sheetId of this.sheetsWithDirtyViewports){this.resetViewports(sheetId);if(this.shouldAdjustViewports){const position=this.getters.getSheetPosition(sheetId);const viewports=this.getSubViewports(sheetId);Object.values(viewports).forEach((viewport)=>{viewport.adjustPosition(position);});}}
this.sheetsWithDirtyViewports=new Set();this.shouldAdjustViewports=false;this.setViewports();}
setViewports(){const sheetIds=this.getters.getSheetIds();for(const sheetId of sheetIds){if(!this.viewports[sheetId]?.bottomRight){this.resetViewports(sheetId);}}}
getColIndex(x){const sheetId=this.getters.getActiveSheetId();return Math.max(...this.getSubViewports(sheetId).map((viewport)=>viewport.getColIndex(x)));}
getRowIndex(y){const sheetId=this.getters.getActiveSheetId();return Math.max(...this.getSubViewports(sheetId).map((viewport)=>viewport.getRowIndex(y)));}
getSheetViewDimensionWithHeaders(){return{width:this.sheetViewWidth+this.gridOffsetX,height:this.sheetViewHeight+this.gridOffsetY,};}
getSheetViewDimension(){return{width:this.sheetViewWidth,height:this.sheetViewHeight,};}
getActiveMainViewport(){const sheetId=this.getters.getActiveSheetId();return this.getMainViewport(sheetId);}
getActiveSheetScrollInfo(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);return{scrollX:viewport.offsetX,scrollY:viewport.offsetY,};}
getActiveSheetDOMScrollInfo(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);return{scrollX:viewport.offsetScrollbarX,scrollY:viewport.offsetScrollbarY,};}
getSheetViewVisibleCols(){const sheetId=this.getters.getActiveSheetId();const viewports=this.getSubViewports(sheetId);return[...new Set(viewports.map((v)=>range(v.left,v.right+1)).flat())].filter((col)=>!this.getters.isHeaderHidden(sheetId,"COL",col));}
getSheetViewVisibleRows(){const sheetId=this.getters.getActiveSheetId();const viewports=this.getSubViewports(sheetId);return[...new Set(viewports.map((v)=>range(v.top,v.bottom+1)).flat())].filter((row)=>!this.getters.isHeaderHidden(sheetId,"ROW",row));}
getVisibleCellPositions(){const visibleCols=this.getSheetViewVisibleCols();const visibleRows=this.getSheetViewVisibleRows();const sheetId=this.getters.getActiveSheetId();const positions=[];for(const col of visibleCols){for(const row of visibleRows){const position={sheetId,col,row};const mainPosition=this.getters.getMainCellPosition(position);if(mainPosition.row!==row||mainPosition.col!==col){continue;}
positions.push(position);}}
return positions;}
getMainViewportRect(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);let{width,height}=viewport.getMaxSize();const x=this.getters.getColDimensions(sheetId,xSplit).start;const y=this.getters.getRowDimensions(sheetId,ySplit).start;return{x,y,width,height};}
getMaximumSheetOffset(){const sheetId=this.getters.getActiveSheetId();const{width,height}=this.getMainViewportRect();const viewport=this.getMainInternalViewport(sheetId);return{maxOffsetX:Math.max(0,width-viewport.viewportWidth+1),maxOffsetY:Math.max(0,height-viewport.viewportHeight+1),};}
getColRowOffsetInViewport(dimension,referenceIndex,index){const sheetId=this.getters.getActiveSheetId();const visibleCols=this.getters.getSheetViewVisibleCols();const visibleRows=this.getters.getSheetViewVisibleRows();if(index<referenceIndex){return-this.getColRowOffsetInViewport(dimension,index,referenceIndex);}
let offset=0;const visibleIndexes=dimension==="COL"?visibleCols:visibleRows;for(let i=referenceIndex;i<index;i++){if(!visibleIndexes.includes(i)){continue;}
offset+=this.getters.getHeaderSize(sheetId,dimension,i);}
return offset;}
isVisibleInViewport({sheetId,col,row}){return this.getSubViewports(sheetId).some((pane)=>pane.isVisible(col,row));}
getEdgeScrollCol(x,previousX,startingX){let canEdgeScroll=false;let direction=0;let delay=0;const{xSplit}=this.getters.getPaneDivisions(this.getters.getActiveSheetId());const{width}=this.getSheetViewDimension();const{x:offsetCorrectionX}=this.getMainViewportCoordinates();const currentOffsetX=this.getActiveSheetScrollInfo().scrollX;if(x>width){canEdgeScroll=true;delay=scrollDelay(x-width);direction=1;}
else if(x<offsetCorrectionX&&startingX>=offsetCorrectionX&&currentOffsetX>0){canEdgeScroll=true;delay=scrollDelay(offsetCorrectionX-x);direction=-1;}
else if(xSplit&&previousX<offsetCorrectionX&&x>offsetCorrectionX){canEdgeScroll=true;delay=scrollDelay(x);direction="reset";}
return{canEdgeScroll,direction,delay};}
getEdgeScrollRow(y,previousY,tartingY){let canEdgeScroll=false;let direction=0;let delay=0;const{ySplit}=this.getters.getPaneDivisions(this.getters.getActiveSheetId());const{height}=this.getSheetViewDimension();const{y:offsetCorrectionY}=this.getMainViewportCoordinates();const currentOffsetY=this.getActiveSheetScrollInfo().scrollY;if(y>height){canEdgeScroll=true;delay=scrollDelay(y-height);direction=1;}
else if(y<offsetCorrectionY&&tartingY>=offsetCorrectionY&&currentOffsetY>0){canEdgeScroll=true;delay=scrollDelay(offsetCorrectionY-y);direction=-1;}
else if(ySplit&&previousY<offsetCorrectionY&&y>offsetCorrectionY){canEdgeScroll=true;delay=scrollDelay(y);direction="reset";}
return{canEdgeScroll,direction,delay};}
getVisibleRect(zone){const rect=this.getVisibleRectWithoutHeaders(zone);return{...rect,x:rect.x+this.gridOffsetX,y:rect.y+this.gridOffsetY};}
getVisibleRectWithoutHeaders(zone){const sheetId=this.getters.getActiveSheetId();const viewportRects=this.getSubViewports(sheetId).map((viewport)=>viewport.getRect(zone)).filter(isDefined$1);if(viewportRects.length===0){return{x:0,y:0,width:0,height:0};}
const x=Math.min(...viewportRects.map((rect)=>rect.x));const y=Math.min(...viewportRects.map((rect)=>rect.y));const width=Math.max(...viewportRects.map((rect)=>rect.x+rect.width))-x;const height=Math.max(...viewportRects.map((rect)=>rect.y+rect.height))-y;return{x,y,width,height};}
getMainViewportCoordinates(){const sheetId=this.getters.getActiveSheetId();const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const x=this.getters.getColDimensions(sheetId,xSplit).start;const y=this.getters.getRowDimensions(sheetId,ySplit).start;return{x,y};}
ensureMainViewportExist(sheetId){if(!this.viewports[sheetId]){this.resetViewports(sheetId);}}
getSubViewports(sheetId){this.ensureMainViewportExist(sheetId);return Object.values(this.viewports[sheetId]).filter(isDefined$1);}
checkPositiveDimension(cmd){if(cmd.width<0||cmd.height<0){return"InvalidViewportSize";}
return"Success";}
checkValuesAreDifferent(cmd){const{height,width}=this.getSheetViewDimension();if(cmd.gridOffsetX===this.gridOffsetX&&cmd.gridOffsetY===this.gridOffsetY&&cmd.width===width&&cmd.height===height){return"ValuesNotChanged";}
return"Success";}
checkScrollingDirection({offsetX,offsetY,}){const pane=this.getMainInternalViewport(this.getters.getActiveSheetId());if((!pane.canScrollHorizontally&&offsetX>0)||(!pane.canScrollVertically&&offsetY>0)){return"InvalidScrollingDirection";}
return"Success";}
getMainViewport(sheetId){const viewport=this.getMainInternalViewport(sheetId);return{top:viewport.top,left:viewport.left,bottom:viewport.bottom,right:viewport.right,};}
getMainInternalViewport(sheetId){this.ensureMainViewportExist(sheetId);return this.viewports[sheetId].bottomRight;}
cleanViewports(){const sheetIds=this.getters.getSheetIds();for(let sheetId of Object.keys(this.viewports)){if(!sheetIds.includes(sheetId)){delete this.viewports[sheetId];}}}
resizeSheetView(height,width,gridOffsetX=0,gridOffsetY=0){this.sheetViewHeight=height;this.sheetViewWidth=width;this.gridOffsetX=gridOffsetX;this.gridOffsetY=gridOffsetY;this.recomputeViewports();}
recomputeViewports(){for(let sheetId of Object.keys(this.viewports)){this.resetViewports(sheetId);}}
setSheetViewOffset(offsetX,offsetY){const sheetId=this.getters.getActiveSheetId();const{maxOffsetX,maxOffsetY}=this.getMaximumSheetOffset();Object.values(this.getSubViewports(sheetId)).forEach((viewport)=>viewport.setViewportOffset(clip(offsetX,0,maxOffsetX),clip(offsetY,0,maxOffsetY)));}
getViewportOffset(sheetId){return{x:this.viewports[sheetId]?.bottomRight.offsetScrollbarX||0,y:this.viewports[sheetId]?.bottomRight.offsetScrollbarY||0,};}
resetViewports(sheetId){if(!this.getters.tryGetSheet(sheetId)){return;}
const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const nCols=this.getters.getNumberCols(sheetId);const nRows=this.getters.getNumberRows(sheetId);const colOffset=this.getters.getColRowOffset("COL",0,xSplit,sheetId);const rowOffset=this.getters.getColRowOffset("ROW",0,ySplit,sheetId);const{xRatio,yRatio}=this.getFrozenSheetViewRatio(sheetId);const canScrollHorizontally=xRatio<1.0;const canScrollVertically=yRatio<1.0;const previousOffset=this.getViewportOffset(sheetId);const sheetViewports={topLeft:(ySplit&&xSplit&&new InternalViewport(this.getters,sheetId,{left:0,right:xSplit-1,top:0,bottom:ySplit-1},{width:colOffset,height:rowOffset},{canScrollHorizontally:false,canScrollVertically:false},{x:0,y:0}))||undefined,topRight:(ySplit&&new InternalViewport(this.getters,sheetId,{left:xSplit,right:nCols-1,top:0,bottom:ySplit-1},{width:this.sheetViewWidth-colOffset,height:rowOffset},{canScrollHorizontally,canScrollVertically:false},{x:canScrollHorizontally?previousOffset.x:0,y:0}))||undefined,bottomLeft:(xSplit&&new InternalViewport(this.getters,sheetId,{left:0,right:xSplit-1,top:ySplit,bottom:nRows-1},{width:colOffset,height:this.sheetViewHeight-rowOffset},{canScrollHorizontally:false,canScrollVertically},{x:0,y:canScrollVertically?previousOffset.y:0}))||undefined,bottomRight:new InternalViewport(this.getters,sheetId,{left:xSplit,right:nCols-1,top:ySplit,bottom:nRows-1},{width:this.sheetViewWidth-colOffset,height:this.sheetViewHeight-rowOffset,},{canScrollHorizontally,canScrollVertically},{x:canScrollHorizontally?previousOffset.x:0,y:canScrollVertically?previousOffset.y:0,}),};this.viewports[sheetId]=sheetViewports;}
refreshViewport(sheetId,anchorPosition){Object.values(this.getSubViewports(sheetId)).forEach((viewport)=>{viewport.adjustViewportZone();viewport.adjustPosition(anchorPosition);});}
shiftVertically(offset){const sheetId=this.getters.getActiveSheetId();const{top}=this.getMainInternalViewport(sheetId);const{scrollX}=this.getActiveSheetScrollInfo();this.setSheetViewOffset(scrollX,offset);const{anchor}=this.getters.getSelection();if(anchor.cell.row>=this.getters.getPaneDivisions(sheetId).ySplit){const deltaRow=this.getMainInternalViewport(sheetId).top-top;this.selection.selectCell(anchor.cell.col,anchor.cell.row+deltaRow);}}
getVisibleFigures(){const sheetId=this.getters.getActiveSheetId();const result=[];const figures=this.getters.getFigures(sheetId);const{scrollX,scrollY}=this.getActiveSheetScrollInfo();const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const{width,height}=this.getters.getSheetViewDimensionWithHeaders();for(const figure of figures){if(figure.x>=offsetCorrectionX&&(figure.x+figure.width<=offsetCorrectionX+scrollX||figure.x>=width+scrollX+offsetCorrectionX)){continue;}
if(figure.y>=offsetCorrectionY&&(figure.y+figure.height<=offsetCorrectionY+scrollY||figure.y>=height+scrollY+offsetCorrectionY)){continue;}
result.push(figure);}
return result;}
isPositionVisible(position){const{scrollX,scrollY}=this.getters.getActiveSheetScrollInfo();const{x:mainViewportX,y:mainViewportY}=this.getters.getMainViewportCoordinates();const{width,height}=this.getters.getSheetViewDimension();if(position.x>=mainViewportX&&(position.x<mainViewportX+scrollX||position.x>width+scrollX+mainViewportX)){return false;}
if(position.y>=mainViewportY&&(position.y<mainViewportY+scrollY||position.y>height+scrollY+mainViewportY)){return false;}
return true;}
getFrozenSheetViewRatio(sheetId){const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const offsetCorrectionX=this.getters.getColDimensions(sheetId,xSplit).start;const offsetCorrectionY=this.getters.getRowDimensions(sheetId,ySplit).start;const width=this.sheetViewWidth+this.gridOffsetX;const height=this.sheetViewHeight+this.gridOffsetY;return{xRatio:offsetCorrectionX/width,yRatio:offsetCorrectionY/height};}}
class HeaderPositionsUIPlugin extends UIPlugin{static getters=["getColDimensions","getRowDimensions","getColRowOffset"];headerPositions={};isDirty=true;handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)){this.headerPositions={};this.isDirty=true;}
switch(cmd.type){case"START":for(const sheetId of this.getters.getSheetIds()){this.headerPositions[sheetId]=this.computeHeaderPositionsOfSheet(sheetId);}
break;case"UPDATE_CELL":this.headerPositions={};this.isDirty=true;break;case"UPDATE_FILTER":case"REMOVE_FILTER_TABLE":this.headerPositions={};this.isDirty=true;break;case"REMOVE_COLUMNS_ROWS":case"RESIZE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_ALL_HEADER_GROUPS":case"FOLD_ALL_HEADER_GROUPS":case"UNGROUP_HEADERS":case"GROUP_HEADERS":case"CREATE_SHEET":this.headerPositions[cmd.sheetId]=this.computeHeaderPositionsOfSheet(cmd.sheetId);break;case"DUPLICATE_SHEET":this.headerPositions[cmd.sheetIdTo]=deepCopy(this.headerPositions[cmd.sheetId]);break;}}
finalize(){if(this.isDirty){for(const sheetId of this.getters.getSheetIds()){this.headerPositions[sheetId]=this.computeHeaderPositionsOfSheet(sheetId);}
this.isDirty=false;}}
getColDimensions(sheetId,col){const start=this.headerPositions[sheetId]["COL"][col];const size=this.getters.getColSize(sheetId,col);const isColHidden=this.getters.isColHidden(sheetId,col);return{start,size,end:start+(isColHidden?0:size),};}
getRowDimensions(sheetId,row){const start=this.headerPositions[sheetId]["ROW"][row];const size=this.getters.getRowSize(sheetId,row);const isRowHidden=this.getters.isRowHidden(sheetId,row);return{start,size:size,end:start+(isRowHidden?0:size),};}
getColRowOffset(dimension,referenceIndex,index,sheetId=this.getters.getActiveSheetId()){const referencePosition=this.headerPositions[sheetId][dimension][referenceIndex];const position=this.headerPositions[sheetId][dimension][index];return position-referencePosition;}
computeHeaderPositionsOfSheet(sheetId){return{COL:this.computePositions(sheetId,"COL"),ROW:this.computePositions(sheetId,"ROW"),};}
computePositions(sheetId,dimension){const positions={};let offset=0;for(let i=0;i<this.getters.getNumberHeaders(sheetId,dimension)+1;i++){positions[i]=offset;if(this.getters.isHeaderHidden(sheetId,dimension,i)){continue;}
offset+=this.getters.getHeaderSize(sheetId,dimension,i);}
return positions;}}
const corePluginRegistry=new Registry().add("settings",SettingsPlugin).add("sheet",SheetPlugin).add("header grouping",HeaderGroupingPlugin).add("header visibility",HeaderVisibilityPlugin).add("filters",FiltersPlugin).add("cell",CellPlugin).add("merge",MergePlugin).add("headerSize",HeaderSizePlugin).add("borders",BordersPlugin).add("conditional formatting",ConditionalFormatPlugin).add("figures",FigurePlugin).add("chart",ChartPlugin).add("image",ImagePlugin).add("dataValidation",DataValidationPlugin);const featurePluginRegistry=new Registry().add("ui_sheet",SheetUIPlugin).add("ui_options",UIOptionsPlugin).add("selectionInputManager",SelectionInputsManagerPlugin).add("highlight",HighlightPlugin).add("grid renderer",RendererPlugin).add("autofill",AutofillPlugin).add("find_and_replace",FindAndReplacePlugin).add("sort",SortPlugin).add("automatic_sum",AutomaticSumPlugin).add("format",FormatPlugin).add("split_to_columns",SplitToColumnsPlugin).add("cell_popovers",CellPopoverPlugin).add("collaborative",CollaborativePlugin).add("history",HistoryPlugin).add("data_cleanup",DataCleanupPlugin);const statefulUIPluginRegistry=new Registry().add("selection",GridSelectionPlugin).add("evaluation_filter",FilterEvaluationPlugin).add("header_visibility_ui",HeaderVisibilityUIPlugin).add("header_positions",HeaderPositionsUIPlugin).add("viewport",SheetViewPlugin).add("clipboard",ClipboardPlugin).add("edition",EditionPlugin);const coreViewsPluginRegistry=new Registry().add("evaluation",EvaluationPlugin).add("evaluation_chart",EvaluationChartPlugin).add("evaluation_cf",EvaluationConditionalFormatPlugin).add("row_size",HeaderSizeUIPlugin).add("custom_colors",CustomColorsPlugin).add("data_validation_ui",EvaluationDataValidationPlugin);const clickableCellRegistry=new Registry();clickableCellRegistry.add("link",{condition:(position,env)=>!!env.model.getters.getEvaluatedCell(position).link,execute:(position,env)=>openLink(env.model.getters.getEvaluatedCell(position).link,env),sequence:5,});class ImageProvider{fileStore;constructor(fileStore){this.fileStore=fileStore;}
async requestImage(){const file=await this.getImageFromUser();const path=await this.fileStore.upload(file);const size=await this.getImageOriginalSize(path);return{path,size,mimetype:file.type};}
getImageFromUser(){return new Promise((resolve,reject)=>{const input=document.createElement("input");input.setAttribute("type","file");input.setAttribute("accept","image/*");input.addEventListener("change",async()=>{if(input.files===null||input.files.length!=1){reject();}
else{resolve(input.files[0]);}});input.click();});}
getImageOriginalSize(path){return new Promise((resolve,reject)=>{const image=new Image();image.src=path;image.addEventListener("load",()=>{const size={width:image.width,height:image.height};resolve(size);});image.addEventListener("error",reject);});}}
class FocusableElement{focusableElement=undefined;setFocusableElement(element){this.focusableElement=element;}
focus(){this.focusableElement?.focus();}}
const RIPPLE_KEY_FRAMES=[{transform:"scale(0)"},{transform:"scale(0.8)",offset:0.33},{opacity:"0",transform:"scale(1)",offset:1},];css`
  .o-ripple {
    z-index: 1;
  }
`;class RippleEffect extends owl.Component{static template="o-spreadsheet-RippleEffect";rippleRef=owl.useRef("ripple");setup(){let animation=undefined;owl.onMounted(()=>{const rippleEl=this.rippleRef.el;if(!rippleEl||!rippleEl.animate)
return;animation=rippleEl.animate(RIPPLE_KEY_FRAMES,{duration:this.props.duration,easing:"ease-out",});animation.addEventListener("finish",this.props.onAnimationEnd);});owl.onWillUnmount(()=>{animation?.removeEventListener("finish",this.props.onAnimationEnd);});}
get rippleStyle(){const{x,y,width,height}=this.props;const offsetX=this.props.offsetX||0;const offsetY=this.props.offsetY||0;return cssPropertiesToCss({transform:"scale(0)",left:x,top:y,"margin-left":`${-width / 2 + offsetX}px`,"margin-top":`${-height / 2 + offsetY}px`,width:`${width}px`,height:`${height}px`,background:this.props.color,"border-radius":"100%",opacity:`${this.props.opacity}`,});}}
RippleEffect.props={x:String,y:String,color:String,opacity:Number,duration:Number,width:Number,height:Number,offsetY:Number,offsetX:Number,allowOverflow:Boolean,onAnimationEnd:Function,style:String,};class Ripple extends owl.Component{static template="o-spreadsheet-Ripple";static components={RippleEffect};static defaultProps={color:"#aaaaaa",opacity:0.4,duration:800,enabled:true,onAnimationEnd:()=>{},class:"",};childContainer=owl.useRef("childContainer");state=owl.useState({ripples:[]});currentId=1;onClick(ev){if(!this.props.enabled)
return;const containerEl=this.childContainer.el;if(!containerEl)
return;const rect=this.getRippleChildRectInfo();const{x,y,width,height}=rect;const maxDim=Math.max(width,height);const rippleRect={x:ev.clientX-x,y:ev.clientY-y,width:this.props.width||maxDim*2.85,height:this.props.height||maxDim*2.85,};this.state.ripples.push({rippleRect,id:this.currentId++});}
getRippleStyle(){const containerEl=this.childContainer.el;if(!containerEl||containerEl.childElementCount!==1||!containerEl.firstElementChild){return"";}
const rect=this.getRippleChildRectInfo();return cssPropertiesToCss({top:rect.marginTop+"px",left:rect.marginLeft+"px",width:rect.width+"px",height:rect.height+"px",});}
getRippleChildRectInfo(){const el=this.childContainer.el;if(!el)
throw new Error("No child container element found");if(el.childElementCount!==1||!el.firstElementChild){const boundingRect=getBoundingRectAsPOJO(el);return{...boundingRect,marginLeft:0,marginTop:0};}
const childEl=el.firstElementChild;const margins=getElementMargins(childEl);const boundingRect=getBoundingRectAsPOJO(childEl);return{...boundingRect,marginLeft:margins.left,marginTop:margins.top,};}
removeRipple(id){const index=this.state.ripples.findIndex((r)=>r.id===id);if(index===-1)
return;this.state.ripples.splice(index,1);}
getRippleEffectProps(id){const rect=this.state.ripples.find((r)=>r.id===id)?.rippleRect;if(!rect)
throw new Error("Cannot find a ripple with the id "+id);return{color:this.props.color,opacity:this.props.opacity,duration:this.props.duration,x:this.props.ignoreClickPosition?"50%":rect.x+"px",y:this.props.ignoreClickPosition?"50%":rect.y+"px",width:rect.width,height:rect.height,offsetX:this.props.offsetX||0,offsetY:this.props.offsetY||0,allowOverflow:this.props.allowOverflow||false,style:this.getRippleStyle(),onAnimationEnd:()=>this.removeRipple(id),};}}
Ripple.props={color:{type:String,optional:true},opacity:{type:Number,optional:true},duration:{type:Number,optional:true},ignoreClickPosition:{type:Boolean,optional:true},width:{type:Number,optional:true},height:{type:Number,optional:true},offsetY:{type:Number,optional:true},offsetX:{type:Number,optional:true},allowOverflow:{type:Boolean,optional:true},enabled:{type:Boolean,optional:true},onAnimationEnd:{type:Function,optional:true},slots:Object,class:{type:String,optional:true},};function interactiveRenameSheet(env,sheetId,name,errorCallback){const result=env.model.dispatch("RENAME_SHEET",{sheetId,name});if(result.reasons.includes("MissingSheetName")){env.raiseError(_t("The sheet name cannot be empty."),errorCallback);}
else if(result.reasons.includes("DuplicatedSheetName")){env.raiseError(_t("A sheet with the name %s already exists. Please select another name.",name),errorCallback);}
else if(result.reasons.includes("ForbiddenCharactersInSheetName")){env.raiseError(_t("Some used characters are not allowed in a sheet name (Forbidden characters are %s).",FORBIDDEN_SHEET_CHARS.join(" ")),errorCallback);}}
css`
  .o-sheet {
    padding: 0 15px;
    padding-right: 10px;
    height: ${BOTTOMBAR_HEIGHT}px;
    border-left: 1px solid #c1c1c1;
    border-right: 1px solid #c1c1c1;
    margin-left: -1px;
    cursor: pointer;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
    }

    &.active {
      color: #484;
      background-color: #ffffff;
      box-shadow: 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    }

    .o-sheet-icon {
      z-index: 1;

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-sheet-name {
      outline: none;
      padding: 2px 4px;

      &.o-sheet-name-editable {
        border-radius: 2px;
        border: 2px solid mediumblue;
        /* negative margins so nothing moves when the border is added */
        margin-left: -2px;
        margin-right: -2px;
      }
    }
  }
`;class BottomBarSheet extends owl.Component{static template="o-spreadsheet-BottomBarSheet";static components={Ripple};static defaultProps={onMouseDown:()=>{},style:"",};state=owl.useState({isEditing:false});sheetDivRef=owl.useRef("sheetDiv");sheetNameRef=owl.useRef("sheetNameSpan");editionState="initializing";setup(){owl.onMounted(()=>{if(this.isSheetActive){this.scrollToSheet();}});owl.onPatched(()=>{if(this.sheetNameRef.el&&this.state.isEditing&&this.editionState==="initializing"){this.editionState="editing";this.focusInputAndSelectContent();}});}
focusInputAndSelectContent(){if(!this.state.isEditing||!this.sheetNameRef.el)
return;this.sheetNameRef.el.focus();const selection=window.getSelection();if(selection&&this.sheetNameRef.el.firstChild){selection.setBaseAndExtent(this.sheetNameRef.el.firstChild,0,this.sheetNameRef.el.firstChild,this.sheetNameRef.el.textContent?.length||0);}}
scrollToSheet(){this.sheetDivRef.el?.scrollIntoView?.();}
onFocusOut(){if(this.state.isEditing&&this.editionState!=="initializing"){this.stopEdition();}}
onMouseDown(ev){this.activateSheet();this.props.onMouseDown(ev);}
activateSheet(){this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.env.model.getters.getActiveSheetId(),sheetIdTo:this.props.sheetId,});this.scrollToSheet();}
onDblClick(){if(this.env.model.getters.isReadonly()){return;}
this.startEdition();}
onKeyDown(ev){if(!this.state.isEditing)
return;if(ev.key==="Enter"){ev.preventDefault();this.stopEdition();}
if(ev.key==="Escape"){this.cancelEdition();}}
onClickSheetName(ev){if(this.state.isEditing)
ev.stopPropagation();}
startEdition(){this.state.isEditing=true;this.editionState="initializing";}
stopEdition(){const input=this.sheetNameRef.el;if(!this.state.isEditing||!input)
return;this.state.isEditing=false;this.editionState="initializing";input.blur();const inputValue=this.getInputContent()||"";input.innerText=inputValue;interactiveRenameSheet(this.env,this.props.sheetId,inputValue,()=>this.startEdition());}
cancelEdition(){this.state.isEditing=false;this.editionState="initializing";this.sheetNameRef.el?.blur();this.setInputContent(this.sheetName);}
onIconClick(ev){if(!this.isSheetActive){this.activateSheet();}
this.props.openContextMenu(this.contextMenuRegistry,ev);}
onContextMenu(ev){if(!this.isSheetActive){this.activateSheet();}
this.props.openContextMenu(this.contextMenuRegistry,ev);}
getInputContent(){return this.sheetNameRef.el?.textContent;}
setInputContent(content){if(this.sheetNameRef.el)
this.sheetNameRef.el.textContent=content;}
get contextMenuRegistry(){return getSheetMenuRegistry({renameSheetCallback:()=>{this.scrollToSheet();this.startEdition();},});}
get isSheetActive(){return this.env.model.getters.getActiveSheetId()===this.props.sheetId;}
get sheetName(){return this.env.model.getters.getSheetName(this.props.sheetId);}}
BottomBarSheet.props={sheetId:String,openContextMenu:Function,style:{type:String,optional:true},onMouseDown:{type:Function,optional:true},};css`
  .o-selection-statistic {
    margin-right: 20px;
    padding: 4px 4px 4px 8px;
    color: #333;
    cursor: pointer;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08) !important;
    }
  }
`;class BottomBarStatistic extends owl.Component{static template="o-spreadsheet-BottomBarStatisic";static components={Ripple};selectedStatisticFn="";statisticFnResults={};setup(){this.statisticFnResults=this.env.model.getters.getStatisticFnResults();owl.onWillUpdateProps(()=>{const newStatisticFnResults=this.env.model.getters.getStatisticFnResults();if(!deepEquals(newStatisticFnResults,this.statisticFnResults)){this.props.closeContextMenu();}
this.statisticFnResults=newStatisticFnResults;});}
getSelectedStatistic(){if(Object.values(this.statisticFnResults).every((result)=>result===undefined)){return undefined;}
if(this.selectedStatisticFn===""){this.selectedStatisticFn=Object.keys(this.statisticFnResults)[0];}
return this.getComposedFnName(this.selectedStatisticFn,this.statisticFnResults[this.selectedStatisticFn]);}
listSelectionStatistics(ev){const registry=new MenuItemRegistry();let i=0;for(let[fnName,fnValue]of Object.entries(this.statisticFnResults)){registry.add(fnName,{name:this.getComposedFnName(fnName,fnValue),sequence:i,isReadonlyAllowed:true,execute:()=>{this.selectedStatisticFn=fnName;},});i++;}
const target=ev.currentTarget;const{top,left,width}=target.getBoundingClientRect();this.props.openContextMenu(left+width,top,registry);}
getComposedFnName(fnName,fnValue){const locale=this.env.model.getters.getLocale();return fnName+": "+(fnValue!==undefined?formatValue(fnValue,{locale}):"__");}}
BottomBarStatistic.props={openContextMenu:Function,closeContextMenu:Function,};const MENU_MAX_HEIGHT=250;css`
  .o-spreadsheet-bottom-bar {
    color: ${TEXT_HEADER_COLOR};
    background-color: ${BACKGROUND_GRAY_COLOR};
    padding-left: ${HEADER_WIDTH}px;
    font-size: 15px;
    border-top: 1px solid lightgrey;

    .o-sheet-item {
      cursor: pointer;
      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-all-sheets {
      max-width: 70%;
      .o-bottom-bar-fade-out {
        background-image: linear-gradient(-90deg, #cfcfcf, transparent 1%);
      }

      .o-bottom-bar-fade-in {
        background-image: linear-gradient(90deg, #cfcfcf, transparent 1%);
      }
    }

    .o-bottom-bar-arrows {
      .o-bottom-bar-arrow {
        cursor: pointer;
        &:hover:not([class*="o-disabled"]) {
          .o-icon {
            opacity: 0.9;
          }
        }

        .o-icon {
          height: 18px;
          width: 18px;
        }
      }
    }
  }
`;class BottomBar extends owl.Component{static template="o-spreadsheet-BottomBar";static components={Menu,Ripple,BottomBarSheet,BottomBarStatistic};bottomBarRef=owl.useRef("bottomBar");sheetListRef=owl.useRef("sheetList");dragAndDrop=useDragAndDropListItems();targetScroll=undefined;state=owl.useState({isSheetListScrollableLeft:false,isSheetListScrollableRight:false,});menuMaxHeight=MENU_MAX_HEIGHT;menuState=owl.useState({isOpen:false,menuId:undefined,position:null,menuItems:[],});sheetList=this.getVisibleSheets();setup(){owl.onWillUpdateProps(()=>{this.updateScrollState();const visibleSheets=this.getVisibleSheets();if(!deepEquals(this.sheetList,visibleSheets)){this.dragAndDrop.cancel();}
this.sheetList=visibleSheets;});}
clickAddSheet(ev){const activeSheetId=this.env.model.getters.getActiveSheetId();const position=this.env.model.getters.getSheetIds().findIndex((sheetId)=>sheetId===activeSheetId)+1;const sheetId=this.env.model.uuidGenerator.uuidv4();const name=this.env.model.getters.getNextSheetName(_t("Sheet"));this.env.model.dispatch("CREATE_SHEET",{sheetId,position,name});this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:sheetId});}
getVisibleSheets(){return this.env.model.getters.getVisibleSheetIds().map((sheetId)=>{const sheet=this.env.model.getters.getSheet(sheetId);return{id:sheet.id,name:sheet.name};});}
clickListSheets(ev){const registry=new MenuItemRegistry();const from=this.env.model.getters.getActiveSheetId();let i=0;for(const sheetId of this.env.model.getters.getSheetIds()){const sheet=this.env.model.getters.getSheet(sheetId);registry.add(sheetId,{name:sheet.name,sequence:i,isReadonlyAllowed:true,textColor:sheet.isVisible?undefined:"grey",execute:(env)=>{env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:from,sheetIdTo:sheetId});},});i++;}
const target=ev.currentTarget;const{left}=target.getBoundingClientRect();const top=this.bottomBarRef.el.getBoundingClientRect().top;this.openContextMenu(left,top,"listSheets",registry);}
openContextMenu(x,y,menuId,registry){this.menuState.isOpen=true;this.menuState.menuId=menuId;this.menuState.menuItems=registry.getMenuItems();this.menuState.position={x,y};}
onSheetContextMenu(sheetId,registry,ev){const target=ev.currentTarget;const{top,left}=target.getBoundingClientRect();if(ev.closedMenuId===sheetId){this.closeMenu();return;}
this.openContextMenu(left,top,sheetId,registry);}
closeMenu(){this.menuState.isOpen=false;this.menuState.menuId=undefined;this.menuState.menuItems=[];this.menuState.position=null;}
closeContextMenuWithId(menuId){if(this.menuState.menuId===menuId){this.closeMenu();}}
onWheel(ev){this.targetScroll=undefined;const target=ev.currentTarget;target.scrollLeft+=ev.deltaY*0.5;}
onScroll(){this.updateScrollState();if(this.targetScroll===this.sheetListCurrentScroll){this.targetScroll=undefined;}}
onArrowLeft(ev){if(!this.state.isSheetListScrollableLeft)
return;if(!this.targetScroll)
this.targetScroll=this.sheetListCurrentScroll;const newScroll=this.targetScroll-this.sheetListWidth;this.scrollSheetListTo(Math.max(0,newScroll));}
onArrowRight(ev){if(!this.state.isSheetListScrollableRight)
return;if(!this.targetScroll)
this.targetScroll=this.sheetListCurrentScroll;const newScroll=this.targetScroll+this.sheetListWidth;this.scrollSheetListTo(Math.min(this.sheetListMaxScroll,newScroll));}
updateScrollState(){this.state.isSheetListScrollableLeft=this.sheetListCurrentScroll>0;this.state.isSheetListScrollableRight=this.sheetListCurrentScroll<this.sheetListMaxScroll;}
scrollSheetListTo(scroll){if(!this.sheetListRef.el)
return;this.targetScroll=scroll;this.sheetListRef.el.scrollTo({top:0,left:scroll,behavior:"smooth"});}
onSheetMouseDown(sheetId,event){if(event.button!==0||this.env.model.getters.isReadonly())
return;this.closeMenu();const visibleSheets=this.getVisibleSheets();const sheetRects=this.getSheetItemRects();const sheets=visibleSheets.map((sheet,index)=>({id:sheet.id,size:sheetRects[index].width,position:sheetRects[index].x,}));this.dragAndDrop.start("horizontal",{draggedItemId:sheetId,initialMousePosition:event.clientX,items:sheets,containerEl:this.sheetListRef.el,onDragEnd:(sheetId,finalIndex)=>this.onDragEnd(sheetId,finalIndex),});}
onDragEnd(sheetId,finalIndex){const originalIndex=this.getVisibleSheets().findIndex((sheet)=>sheet.id===sheetId);const delta=finalIndex-originalIndex;if(sheetId&&delta!==0){this.env.model.dispatch("MOVE_SHEET",{sheetId:sheetId,delta:delta,});}}
getSheetStyle(sheetId){return this.dragAndDrop.itemsStyle[sheetId]||"";}
getSheetItemRects(){return Array.from(this.bottomBarRef.el.querySelectorAll(`.o-sheet`)).map((sheetEl)=>sheetEl.getBoundingClientRect()).map((rect)=>({x:rect.x,width:rect.width-1,y:rect.y,height:rect.height,}));}
get sheetListCurrentScroll(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.scrollLeft;}
get sheetListWidth(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.clientWidth;}
get sheetListMaxScroll(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.scrollWidth-this.sheetListRef.el.clientWidth;}}
BottomBar.props={onClick:Function,};css`
  .o-dashboard-clickable-cell {
    position: absolute;
    cursor: pointer;
  }
`;class SpreadsheetDashboard extends owl.Component{static template="o-spreadsheet-SpreadsheetDashboard";static components={GridOverlay,GridPopover,Popover,VerticalScrollBar,HorizontalScrollBar,FilterIconsOverlay,};onMouseWheel;canvasPosition;hoveredCell;setup(){const gridRef=owl.useRef("grid");this.canvasPosition=useAbsoluteBoundingRect(gridRef);this.hoveredCell=owl.useState({col:undefined,row:undefined});owl.useChildSubEnv({getPopoverContainerRect:()=>this.getGridRect()});useGridDrawing("canvas",this.env.model,()=>this.env.model.getters.getSheetViewDimension());this.onMouseWheel=useWheelHandler((deltaX,deltaY)=>{this.moveCanvas(deltaX,deltaY);this.hoveredCell.col=undefined;this.hoveredCell.row=undefined;});}
onCellHovered({col,row}){this.hoveredCell.col=col;this.hoveredCell.row=row;}
get gridContainer(){const sheetId=this.env.model.getters.getActiveSheetId();const{right}=this.env.model.getters.getSheetZone(sheetId);const{end}=this.env.model.getters.getColDimensions(sheetId,right);return cssPropertiesToCss({"max-width":`${end}px`});}
get gridOverlayDimensions(){return cssPropertiesToCss({height:"100%",width:"100%",});}
getCellClickableStyle(coordinates){return cssPropertiesToCss({top:`${coordinates.y}px`,left:`${coordinates.x}px`,width:`${coordinates.width}px`,height:`${coordinates.height}px`,});}
getClickableCells(){const cells=[];const sheetId=this.env.model.getters.getActiveSheetId();for(const col of this.env.model.getters.getSheetViewVisibleCols()){for(const row of this.env.model.getters.getSheetViewVisibleRows()){const position={sheetId,col,row};const action=this.getClickableAction(position);if(!action){continue;}
let zone;if(this.env.model.getters.isInMerge(position)){zone=this.env.model.getters.getMerge(position);}
else{zone=positionToZone({col,row});}
const rect=this.env.model.getters.getVisibleRect(zone);cells.push({coordinates:rect,position:{col,row},action,});}}
return cells;}
getClickableAction(position){for(const items of clickableCellRegistry.getAll().sort((a,b)=>a.sequence-b.sequence)){if(items.condition(position,this.env)){return items.execute;}}
return false;}
selectClickableCell(clickableCell){const{position,action}=clickableCell;action({...position,sheetId:this.env.model.getters.getActiveSheetId()},this.env);}
onClosePopover(){this.env.model.dispatch("CLOSE_CELL_POPOVER");}
onGridResized({height,width}){this.env.model.dispatch("RESIZE_SHEETVIEW",{width:width,height:height,gridOffsetX:0,gridOffsetY:0,});}
moveCanvas(deltaX,deltaY){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX+deltaX,offsetY:scrollY+deltaY,});}
getGridRect(){return{...this.canvasPosition,...this.env.model.getters.getSheetViewDimensionWithHeaders()};}}
SpreadsheetDashboard.props={};css`
  .o-header-group {
    .o-header-group-header {
      z-index: ${ComponentsImportance.HeaderGroupingButton};
      .o-group-fold-button {
        cursor: pointer;
        width: 13px;
        height: 13px;
        border: 1px solid ${HEADER_GROUPING_BORDER_COLOR};
        .o-icon {
          width: 7px;
          height: 7px;
        }

        &:hover {
          border-color: #777;
        }
      }
    }
    .o-group-border {
      box-sizing: border-box;
    }
  }
`;class AbstractHeaderGroup extends owl.Component{static template="o-spreadsheet-HeaderGroup";toggleGroup(){const sheetId=this.env.model.getters.getActiveSheetId();const{start,end}=this.props.group;interactiveToggleGroup(this.env,sheetId,this.dimension,start,end);}
get groupBoxStyle(){const groupBox=this.groupBox;return cssPropertiesToCss({top:`${groupBox.groupRect.y}px`,left:`${groupBox.groupRect.x}px`,width:`${groupBox.groupRect.width}px`,height:`${groupBox.groupRect.height}px`,});}
get groupButtonStyle(){return cssPropertiesToCss({"background-color":this.isGroupFolded?"#333":"#fff",color:this.isGroupFolded?"#fff":"#333",});}
get groupButtonIcon(){return this.isGroupFolded?"o-spreadsheet-Icon.PLUS":"o-spreadsheet-Icon.MINUS";}
get isGroupFolded(){const sheetId=this.env.model.getters.getActiveSheetId();const group=this.props.group;return this.env.model.getters.isGroupFolded(sheetId,this.dimension,group.start,group.end);}
onContextMenu(ev){const sheetId=this.env.model.getters.getActiveSheetId();const position={x:ev.clientX,y:ev.clientY};const group=this.props.group;const menuItems=getHeaderGroupContextMenu(sheetId,this.dimension,group.start,group.end);this.props.openContextMenu(position,menuItems);}}
AbstractHeaderGroup.props={group:Object,layerOffset:Number,openContextMenu:Function,};class RowGroup extends AbstractHeaderGroup{dimension="ROW";get groupBorderStyle(){const groupBox=this.groupBox;if(this.groupBox.groupRect.height===0){return"";}
return cssPropertiesToCss({top:`${groupBox.headerRect.height / 2}px`,left:`calc(50% - 1px)`,width:`30%`,height:`calc(100% - ${groupBox.headerRect.height / 2}px)`,"border-left":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,"border-bottom":groupBox.isEndHidden?"":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,});}
get groupHeaderStyle(){return cssPropertiesToCss({width:`100%`,height:`${this.groupBox.headerRect.height}px`,});}
get groupBox(){const sheetId=this.env.model.getters.getActiveSheetId();const{start:startRow,end:endRow}=this.props.group;const startCoordinates=this.env.model.getters.getRowDimensions(sheetId,startRow).start;const endCoordinates=this.env.model.getters.getRowDimensions(sheetId,endRow).end;let groupHeaderY=0;let groupHeaderHeight=HEADER_HEIGHT;if(startRow!==0){const headerRowDims=this.env.model.getters.getRowDimensions(sheetId,startRow-1);groupHeaderY=HEADER_HEIGHT+headerRowDims.start;groupHeaderHeight=headerRowDims.end-headerRowDims.start;}
const headerRect={x:this.props.layerOffset,y:groupHeaderY,width:GROUP_LAYER_WIDTH,height:groupHeaderHeight,};const groupRect={x:this.props.layerOffset,y:headerRect.y,width:GROUP_LAYER_WIDTH,height:headerRect.height+(endCoordinates-startCoordinates),};return{headerRect,groupRect,isEndHidden:this.env.model.getters.isRowHidden(sheetId,endRow),};}}
class ColGroup extends AbstractHeaderGroup{dimension="COL";get groupBorderStyle(){const groupBox=this.groupBox;if(groupBox.groupRect.width===0){return"";}
return cssPropertiesToCss({top:`calc(50% - 1px)`,left:`${groupBox.headerRect.width / 2}px`,width:`calc(100% - ${groupBox.headerRect.width / 2}px)`,height:`30%`,"border-top":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,"border-right":groupBox.isEndHidden?"":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,});}
get groupHeaderStyle(){return cssPropertiesToCss({width:`${this.groupBox.headerRect.width}px`,height:`100%`,});}
get groupBox(){const sheetId=this.env.model.getters.getActiveSheetId();const{start:startCol,end:endCol}=this.props.group;const startCoordinates=this.env.model.getters.getColDimensions(sheetId,startCol).start;const endCoordinates=this.env.model.getters.getColDimensions(sheetId,endCol).end;let groupHeaderX=0;let groupHeaderWidth=HEADER_WIDTH;if(startCol!==0){const headerRowDims=this.env.model.getters.getColDimensions(sheetId,startCol-1);groupHeaderX=HEADER_WIDTH+headerRowDims.start;groupHeaderWidth=headerRowDims.end-headerRowDims.start;}
const headerRect={x:groupHeaderX,y:this.props.layerOffset,width:groupHeaderWidth,height:GROUP_LAYER_WIDTH,};const groupRect={x:headerRect.x,y:this.props.layerOffset,width:headerRect.width+(endCoordinates-startCoordinates),height:GROUP_LAYER_WIDTH,};return{headerRect,groupRect,isEndHidden:this.env.model.getters.isColHidden(sheetId,endCol),};}}
css`
  .o-header-group-frozen-pane-border {
    &.o-group-rows {
      margin-top: -1px;
      border-bottom: 3px solid ${FROZEN_PANE_HEADER_BORDER_COLOR};
    }
    &.o-group-columns {
      margin-left: -1px;
      border-right: 3px solid ${FROZEN_PANE_HEADER_BORDER_COLOR};
    }
  }

  .o-header-group-main-pane {
    &.o-group-rows {
      margin-top: -2px; // Counteract o-header-group-frozen-pane-border offset
    }
    &.o-group-columns {
      margin-left: -2px;
    }
  }
`;class HeaderGroupContainer extends owl.Component{static template="o-spreadsheet-HeaderGroupContainer";static components={RowGroup,ColGroup,Menu};menu=owl.useState({isOpen:false,position:null,menuItems:[]});getLayerOffset(layerIndex){return layerIndex*GROUP_LAYER_WIDTH;}
onContextMenu(event){const sheetId=this.env.model.getters.getActiveSheetId();const position={x:event.clientX,y:event.clientY};const menuItems=createHeaderGroupContainerContextMenu(sheetId,this.props.dimension);this.openContextMenu(position,menuItems);}
openContextMenu(position,menuItems){this.menu.isOpen=true;this.menu.position=position;this.menu.menuItems=menuItems;}
closeMenu(){this.menu.isOpen=false;this.menu.position=null;this.menu.menuItems=[];}
get groupComponent(){return this.props.dimension==="ROW"?RowGroup:ColGroup;}
get hasFrozenPane(){const viewportCoordinates=this.env.model.getters.getMainViewportCoordinates();return this.props.dimension==="COL"?viewportCoordinates.x>0:viewportCoordinates.y>0;}
get scrollContainerStyle(){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const cssProperties={};if(this.props.dimension==="COL"){cssProperties.left=`${-scrollX - this.frozenPaneContainerSize}px`;}
else{cssProperties.top=`${-scrollY - this.frozenPaneContainerSize}px`;}
return cssPropertiesToCss(cssProperties);}
get frozenPaneContainerStyle(){const cssProperties={};if(this.props.dimension==="COL"){cssProperties.width=`${this.frozenPaneContainerSize}px`;}
else{cssProperties.height=`${this.frozenPaneContainerSize}px`;}
return cssPropertiesToCss(cssProperties);}
get frozenPaneContainerSize(){if(!this.hasFrozenPane){return 0;}
const viewportCoordinates=this.env.model.getters.getMainViewportCoordinates();if(this.props.dimension==="COL"){return HEADER_WIDTH+viewportCoordinates.x;}
else{return HEADER_HEIGHT+viewportCoordinates.y;}}}
HeaderGroupContainer.props={dimension:String,layers:Array,};css`
  .o-sidePanel {
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    background-color: white;
    border: 1px solid darkgray;
    user-select: none;
    .o-sidePanelHeader {
      padding: 6px;
      height: 30px;
      background-color: ${BACKGROUND_HEADER_COLOR};
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid darkgray;
      border-top: 1px solid darkgray;
      font-weight: bold;
      .o-sidePanelTitle {
        font-weight: bold;
        padding: 5px 10px;
        color: dimgrey;
      }
      .o-sidePanelClose {
        padding: 5px 10px;
        cursor: pointer;
        &:hover {
          background-color: WhiteSmoke;
        }
      }
    }
    .o-sidePanelBody {
      overflow: auto;
      width: 100%;
      height: 100%;

      .o-section {
        padding: 16px;

        .o-section-title {
          font-weight: bold;
          color: dimgrey;
          margin-bottom: 5px;
        }

        .o-section-subtitle {
          color: dimgrey;
          font-weight: 500;
          font-size: 12px;
          line-height: 14px;
          margin: 8px 0 4px 0;
        }

        .o-subsection-left {
          display: inline-block;
          width: 47%;
          margin-right: 3%;
        }

        .o-subsection-right {
          display: inline-block;
          width: 47%;
          margin-left: 3%;
        }
      }
    }

    .o-sidePanelButtons {
      padding: 16px;
      text-align: right;
    }

    .o-sidePanel-btn-link {
      font-size: 14px;
      padding: 20px 24px 11px 24px;
      height: 44px;
      cursor: pointer;
      text-decoration: none;
      &:hover {
        color: #003a39;
        text-decoration: none;
      }
    }

    .o-button.primary:not(.o-disabled) {
      background-color: ${FILTERS_COLOR};
      color: white;
      &:hover:enabled {
        opacity: 0.8;
        background-color: ${FILTERS_COLOR};
      }
    }

    input.o-required,
    select.o-required {
      border-color: #4c4c4c;
    }
    input.o-optional,
    select.o-optional {
      border: 1px solid #a9a9a9;
    }
    input.o-invalid {
      border-color: red;
    }
    select.o-input {
      background-color: white;
      text-align: left;
    }

    .o-checkbox {
      display: flex;
      justify-items: center;
      input {
        margin-right: 5px;
      }
    }

    .o-inflection {
      table {
        table-layout: fixed;
        margin-top: 2%;
        display: table;
        text-align: left;
        font-size: 12px;
        line-height: 18px;
        width: 100%;
      }
      input,
      select {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
    }

    .o-sidePanel-tools {
      color: #333;
      font-size: 13px;
      cursor: default;
      display: flex;

      .o-tool {
        display: flex;
        align-items: center;
        margin: 2px;
        padding: 0 3px;
        border-radius: 2px;

        &:hover {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }
    }
  }
`;class SidePanel extends owl.Component{static template="o-spreadsheet-SidePanel";state;setup(){this.state=owl.useState({panel:sidePanelRegistry.get(this.props.component),});owl.onWillUpdateProps((nextProps)=>(this.state.panel=sidePanelRegistry.get(nextProps.component)));}
getTitle(){return typeof this.state.panel.title==="function"?this.state.panel.title(this.env):this.state.panel.title;}}
SidePanel.props={component:String,panelProps:{type:Object,optional:true},onCloseSidePanel:Function,};css`
  .o-menu-item-button {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2px;
    border-radius: 2px;
    min-width: 20px;
  }
  .o-disabled {
    opacity: 0.6;
    cursor: default;
  }
`;class ActionButton extends owl.Component{static template="o-spreadsheet-ActionButton";actionButton=createAction(this.props.action);setup(){owl.onWillUpdateProps((nextProps)=>{if(nextProps.action!==this.props.action){this.actionButton=createAction(this.props.action);}});}
get isVisible(){return this.actionButton.isVisible(this.env);}
get isEnabled(){return this.actionButton.isEnabled(this.env);}
get isActive(){return this.actionButton.isActive?.(this.env);}
get title(){const name=this.actionButton.name(this.env);const description=this.actionButton.description(this.env);return name+(description?` (${description})`:"");}
get iconTitle(){return this.actionButton.icon(this.env);}
onClick(ev){if(this.isEnabled){this.props.onClick?.(ev);this.actionButton.execute?.(this.env);}}
get buttonStyle(){if(this.props.selectedColor){return cssPropertiesToCss({"border-bottom":`4px solid ${this.props.selectedColor}`,height:"16px","margin-top":"2px",});}
return"";}}
ActionButton.props={action:Object,hasTriangleDownIcon:{type:Boolean,optional:true},selectedColor:{type:String,optional:true},class:{type:String,optional:true},onClick:{type:Function,optional:true},};const BORDER_POSITIONS=[[["all","o-spreadsheet-Icon.BORDERS"],["hv","o-spreadsheet-Icon.BORDER_HV"],["h","o-spreadsheet-Icon.BORDER_H"],["v","o-spreadsheet-Icon.BORDER_V"],["external","o-spreadsheet-Icon.BORDER_EXTERNAL"],],[["left","o-spreadsheet-Icon.BORDER_LEFT"],["top","o-spreadsheet-Icon.BORDER_TOP"],["right","o-spreadsheet-Icon.BORDER_RIGHT"],["bottom","o-spreadsheet-Icon.BORDER_BOTTOM"],["clear","o-spreadsheet-Icon.BORDER_CLEAR"],],];css`
  .o-border-selector {
    padding: 4px;
    background-color: white;
  }
  .o-divider {
    border-right: 1px solid #e0e2e4;
    margin: 0 6px;
  }
  .o-border-selector-section {
    .o-dropdown-line {
      height: 30px;
      margin: 1px;
      .o-line-item {
        padding: 4px;
        width: 18px;
        height: 18px;
      }
    }
    .o-border-style-tool {
      padding: 0px 3px;
      margin: 2px;
      height: 25px;
    }
  }
  .o-style-preview {
    margin: 7px 5px 7px 5px;
    width: 60px;
    height: 5px;
  }
  .o-style-thin {
    border-bottom: 1px solid #000000;
  }
  .o-style-medium {
    border-bottom: 2px solid #000000;
  }
  .o-style-thick {
    border-bottom: 3px solid #000000;
  }
  .o-style-dashed {
    border-bottom: 1px dashed #000000;
  }
  .o-style-dotted {
    border-bottom: 1px dotted #000000;
  }
  .o-dropdown-border-type {
    &:not(.o-disabled):not(.active):hover {
      background-color: ${BG_HOVER_COLOR};
    }
  }
  .o-dropdown-border-check {
    width: 20px;
    font-size: 12px;
  }
  .o-border-style-dropdown {
    background: #ffffff;
    padding: 4px;
    .o-dropdown-line {
      .o-line-item.active {
        background-color: rgba(0, 0, 0, 0.2);
      }
    }
  }
  .o-border-picker-button {
    padding: 0px !important;
    margin: 5px 0px 0px 0px !important;
    height: 25px !important;
  }
`;class BorderEditor extends owl.Component{static template="o-spreadsheet-BorderEditor";static components={ColorPickerWidget,Popover};BORDER_POSITIONS=BORDER_POSITIONS;lineStyleButtonRef=owl.useRef("lineStyleButton");borderStyles=borderStyles;state=owl.useState({activeTool:undefined,});toggleDropdownTool(tool){const isOpen=this.state.activeTool===tool;this.state.activeTool=isOpen?undefined:tool;}
closeDropdown(){this.state.activeTool=undefined;}
setBorderPosition(position){this.props.onBorderPositionPicked(position);this.closeDropdown();}
setBorderColor(color){this.props.onBorderColorPicked(color);this.closeDropdown();}
setBorderStyle(style){this.props.onBorderStylePicked(style);this.closeDropdown();}
get lineStylePickerPopoverProps(){return{anchorRect:this.lineStylePickerAnchorRect,positioning:"BottomLeft",verticalOffset:0,};}
get popoverProps(){return{anchorRect:this.props.anchorRect,maxHeight:this.props.maxHeight,positioning:"BottomLeft",verticalOffset:0,};}
get lineStylePickerAnchorRect(){const button=this.lineStyleButtonRef.el;if(button===null){return{x:0,y:0,width:0,height:0};}
const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}}
BorderEditor.props={class:{type:String,optional:true},currentBorderColor:{type:String,optional:false},currentBorderStyle:{type:String,optional:false},currentBorderPosition:{type:String,optional:true},onBorderColorPicked:Function,onBorderStylePicked:Function,onBorderPositionPicked:Function,maxHeight:{type:Number,optional:true},anchorRect:Object,};class BorderEditorWidget extends owl.Component{static template="o-spreadsheet-BorderEditorWidget";static components={BorderEditor};borderEditorButtonRef=owl.useRef("borderEditorButton");state=owl.useState({currentColor:DEFAULT_BORDER_DESC.color,currentStyle:DEFAULT_BORDER_DESC.style,currentPosition:undefined,});get borderEditorAnchorRect(){const button=this.borderEditorButtonRef.el;const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}
onBorderPositionPicked(position){this.state.currentPosition=position;this.updateBorder();}
onBorderColorPicked(color){this.state.currentColor=color;this.updateBorder();}
onBorderStylePicked(style){this.state.currentStyle=style;this.updateBorder();}
updateBorder(){if(this.state.currentPosition===undefined){return;}
this.env.model.dispatch("SET_ZONE_BORDERS",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),border:{position:this.state.currentPosition,color:this.state.currentColor,style:this.state.currentStyle,},});}}
BorderEditorWidget.props={toggleBorderEditor:Function,showBorderEditor:Boolean,disabled:{type:Boolean,optional:true},dropdownMaxHeight:{type:Number,optional:true},class:{type:String,optional:true},};const COMPOSER_MAX_HEIGHT=100;const FX_SVG=`
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 121.8 122.9' width='16' height='16' focusable='false'>
  <path d='m28 34-4 5v2h10l-6 40c-4 22-6 28-7 30-2 2-3 3-5 3-3 0-7-2-9-4H4c-2 2-4 4-4 7s4 6 8 6 9-2 15-8c8-7 13-17 18-39l7-35 13-1 3-6H49c4-23 7-27 11-27 2 0 5 2 8 6h4c1-1 4-4 4-7 0-2-3-6-9-6-5 0-13 4-20 10-6 7-9 14-11 24h-8zm41 16c4-5 7-7 8-7s2 1 5 9l3 12c-7 11-12 17-16 17l-3-1-2-1c-3 0-6 3-6 7s3 7 7 7c6 0 12-6 22-23l3 10c3 9 6 13 10 13 5 0 11-4 18-15l-3-4c-4 6-7 8-8 8-2 0-4-3-6-10l-5-15 8-10 6-4 3 1 3 2c2 0 6-3 6-7s-2-7-6-7c-6 0-11 5-21 20l-2-6c-3-9-5-14-9-14-5 0-12 6-18 15l3 3z' fill='#BDBDBD'/>
</svg>
`;css`
  .o-topbar-composer {
    height: fit-content;
    margin-top: -1px;
    border: 1px solid;
    z-index: ${ComponentsImportance.TopBarComposer};

    .o-composer:empty:not(:focus):not(.active)::before {
      content: url("data:image/svg+xml,${encodeURIComponent(FX_SVG)}");
      position: relative;
      top: 20%;
    }
  }

  .user-select-text {
    user-select: text;
  }
`;class TopBarComposer extends owl.Component{static template="o-spreadsheet-TopBarComposer";static components={Composer};get composerStyle(){const style={padding:"5px 0px 5px 8px","max-height":`${COMPOSER_MAX_HEIGHT}px`,"line-height":"24px",};style.height=this.props.focus==="inactive"?`${TOPBAR_TOOLBAR_HEIGHT}px`:"fit-content";return cssPropertiesToCss(style);}
get containerStyle(){if(this.props.focus==="inactive"){return cssPropertiesToCss({"border-color":SEPARATOR_COLOR,"border-right":"none",});}
return cssPropertiesToCss({"border-color":SELECTION_BORDER_COLOR,});}}
TopBarComposer.props={focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerContentFocused:Function,};css`
  .o-font-size-editor {
    height: calc(100% - 4px);
    input.o-font-size {
      outline-color: ${SELECTION_BORDER_COLOR};
      height: 20px;
      width: 23px;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }
  }
  .o-text-options > div {
    cursor: pointer;
    line-height: 26px;
    padding: 3px 12px;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
    }
  }
`;class FontSizeEditor extends owl.Component{static template="o-spreadsheet-FontSizeEditor";static components={};fontSizes=FONT_SIZES;dropdown=owl.useState({isOpen:false});inputRef=owl.useRef("inputFontSize");rootEditorRef=owl.useRef("FontSizeEditor");setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});}
onExternalClick(ev){if(!isChildEvent(this.rootEditorRef.el,ev)){this.closeFontList();}}
get currentFontSize(){return this.env.model.getters.getCurrentStyle().fontSize||DEFAULT_FONT_SIZE;}
toggleFontList(){const isOpen=this.dropdown.isOpen;if(!isOpen){this.props.onToggle();this.inputRef.el.focus();}
else{this.closeFontList();}}
closeFontList(){this.dropdown.isOpen=false;}
setSize(fontSizeStr){const fontSize=clip(Math.floor(parseFloat(fontSizeStr)),1,400);setStyle(this.env,{fontSize});this.closeFontList();}
setSizeFromInput(ev){this.setSize(ev.target.value);}
setSizeFromList(fontSizeStr){this.setSize(fontSizeStr);}
onInputFocused(ev){this.dropdown.isOpen=true;ev.target.select();}
onInputKeydown(ev){if(ev.key==="Enter"||ev.key==="Escape"){this.closeFontList();const target=ev.target;if(ev.key==="Escape"){target.value=`${this.currentFontSize}`;}
this.props.onToggle();}}}
FontSizeEditor.props={onToggle:Function,dropdownStyle:String,class:String,};class PaintFormatButton extends owl.Component{static template="o-spreadsheet-PaintFormatButton";get isActive(){return this.env.model.getters.isPaintingFormat();}
onDblClick(){this.env.model.dispatch("ACTIVATE_PAINT_FORMAT",{persistent:true});}
togglePaintFormat(){if(this.isActive){this.env.model.dispatch("CANCEL_PAINT_FORMAT");}
else{this.env.model.dispatch("ACTIVATE_PAINT_FORMAT",{persistent:false});}}}
PaintFormatButton.props={class:{type:String,optional:true},};css`
  .o-spreadsheet-topbar {
    line-height: 1.2;
    font-size: 13px;
    font-weight: 500;
    background-color: #fff;

    .o-topbar-top {
      border-bottom: 1px solid ${SEPARATOR_COLOR};
      padding: 2px 10px;

      /* Menus */
      .o-topbar-topleft {
        .o-topbar-menu {
          padding: 4px 6px;
          margin: 0 2px;

          &.active {
            background-color: ${BG_HOVER_COLOR};
            color: #000;
          }
        }
      }
    }

    .o-topbar-composer {
      flex-grow: 1;
    }

    /* Toolbar */
    .o-topbar-toolbar {
      height: ${TOPBAR_TOOLBAR_HEIGHT}px;

      .o-readonly-toolbar {
        background-color: ${BACKGROUND_HEADER_COLOR};
        padding-left: 18px;
        padding-right: 18px;
      }

      /* Toolbar */
      .o-toolbar-tools {
        display: flex;
        flex-shrink: 0;
        margin: 0px 6px 0px 16px;
        cursor: default;

        .o-divider {
          display: inline-block;
          border-right: 1px solid ${SEPARATOR_COLOR};
          width: 0;
          margin: 0 6px;
        }

        .o-dropdown {
          position: relative;
          display: flex;
          align-items: center;

          > span {
            height: 30px;
          }

          .o-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2px;
            z-index: ${ComponentsImportance.Dropdown};
            box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
            background-color: white;

            .o-dropdown-line {
              display: flex;

              > span {
                padding: 4px;
              }
            }
          }
        }
      }
    }
  }
`;class TopBar extends owl.Component{static template="o-spreadsheet-TopBar";get dropdownStyle(){return`max-height:${this.props.dropdownMaxHeight}px`;}
static components={ColorPickerWidget,ColorPicker,Menu,TopBarComposer,FontSizeEditor,ActionButton,PaintFormatButton,BorderEditorWidget,};state=owl.useState({menuState:{isOpen:false,position:null,menuItems:[]},activeTool:"",fillColor:"#ffffff",textColor:"#000000",});isSelectingMenu=false;openedEl=null;menus=[];EDIT=ACTION_EDIT;FORMAT=ACTION_FORMAT;VIEW=ACTION_VIEW;formatNumberMenuItemSpec=formatNumberMenuItemSpec;isntToolbarMenu=false;setup(){owl.useExternalListener(window,"click",this.onExternalClick);owl.onWillStart(()=>this.updateCellState());owl.onWillUpdateProps(()=>this.updateCellState());}
get topbarComponents(){return topbarComponentRegistry.getAll().filter((item)=>!item.isVisible||item.isVisible(this.env));}
onExternalClick(ev){if(this.openedEl===ev.target){return;}
this.closeMenus();}
onClick(){this.props.onClick();this.closeMenus();}
onMenuMouseOver(menu,ev){if(this.isSelectingMenu&&this.isntToolbarMenu){this.openMenu(menu,ev);}}
toggleDropdownTool(tool,ev){const isOpen=this.state.activeTool===tool;this.closeMenus();this.state.activeTool=isOpen?"":tool;this.openedEl=isOpen?null:ev.target;}
toggleContextMenu(menu,ev){if(this.state.menuState.isOpen&&this.isntToolbarMenu){this.closeMenus();}
else{this.openMenu(menu,ev);this.isntToolbarMenu=true;}}
toggleToolbarContextMenu(menuSpec,ev){if(this.state.menuState.isOpen&&!this.isntToolbarMenu){this.closeMenus();}
else{const menu=createAction(menuSpec);this.openMenu(menu,ev);this.isntToolbarMenu=false;}}
openMenu(menu,ev){const{left,top,height}=ev.currentTarget.getBoundingClientRect();this.state.activeTool="";this.state.menuState.isOpen=true;this.state.menuState.position={x:left,y:top+height};this.state.menuState.menuItems=menu.children(this.env).sort((a,b)=>a.sequence-b.sequence);this.state.menuState.parentMenu=menu;this.isSelectingMenu=true;this.openedEl=ev.target;interactiveStopEdition(this.env);}
closeMenus(){this.state.activeTool="";this.state.menuState.isOpen=false;this.state.menuState.parentMenu=undefined;this.isSelectingMenu=false;this.openedEl=null;}
updateCellState(){const style=this.env.model.getters.getCurrentStyle();this.state.fillColor=style.fillColor||"#ffffff";this.state.textColor=style.textColor||"#000000";this.menus=topbarMenuRegistry.getMenuItems();}
getMenuName(menu){return menu.name(this.env);}
setColor(target,color){setStyle(this.env,{[target]:color});this.onClick();}}
TopBar.props={onClick:Function,focusComposer:String,onComposerContentFocused:Function,dropdownMaxHeight:Number,};function instantiateClipboard(){return new WebClipboardWrapper(navigator.clipboard);}
class WebClipboardWrapper{clipboard;constructor(clipboard){this.clipboard=clipboard;}
async write(clipboardContent){try{this.clipboard?.write(this.getClipboardItems(clipboardContent));}
catch(e){}}
async writeText(text){try{this.clipboard?.writeText(text);}
catch(e){}}
async readText(){let permissionResult=undefined;try{permissionResult=await navigator.permissions.query({name:"clipboard-read"});}
catch(e){}
try{const clipboardContent=await this.clipboard.readText();return{status:"ok",content:clipboardContent};}
catch(e){const status=permissionResult?.state==="denied"?"permissionDenied":"notImplemented";return{status};}}
getClipboardItems(content){return[new ClipboardItem({[ClipboardMIMEType.PlainText]:this.getBlob(content,ClipboardMIMEType.PlainText),[ClipboardMIMEType.Html]:this.getBlob(content,ClipboardMIMEType.Html),}),];}
getBlob(clipboardContent,type){return new Blob([clipboardContent[type]||""],{type,});}}
const ACTIVE_BG_COLOR=BACKGROUND_HEADER_FILTER_COLOR;const ACTIVE_FONT_COLOR=FILTERS_COLOR;const HOVERED_BG_COLOR=BG_HOVER_COLOR;const HOVERED_FONT_COLOR="#000";css`
  .o-spreadsheet {
    position: relative;
    display: grid;
    grid-template-columns: auto 350px;
    color: #333;
    input {
      background-color: white;
    }
    .text-muted {
      color: grey !important;
    }
    .o-disabled {
      opacity: 0.4;
      pointer: default;
      pointer-events: none;
    }

    &,
    *,
    *:before,
    *:after {
      box-sizing: content-box;
      /** rtl not supported ATM */
      direction: ltr;
    }
    .o-separator {
      border-bottom: ${MENU_SEPARATOR_BORDER_WIDTH}px solid ${SEPARATOR_COLOR};
      margin-top: ${MENU_SEPARATOR_PADDING}px;
      margin-bottom: ${MENU_SEPARATOR_PADDING}px;
    }
    .o-hoverable-button {
      border-radius: 2px;
      cursor: pointer;
      .o-icon {
        color: ${ICONS_COLOR};
      }
      &:not(.o-disabled):not(.active):hover {
        background-color: ${HOVERED_BG_COLOR};
        color: ${HOVERED_FONT_COLOR};
        .o-icon {
          color: ${HOVERED_FONT_COLOR};
        }
      }
      &.active {
        background-color: ${ACTIVE_BG_COLOR};
        color: ${ACTIVE_FONT_COLOR};
        .o-icon {
          color: ${ACTIVE_FONT_COLOR};
        }
      }
    }

    .o-grid-container {
      display: grid;
      background-color: ${HEADER_GROUPING_BACKGROUND_COLOR};

      .o-top-left {
        border: 1px solid ${GRID_BORDER_COLOR};
        margin-bottom: -1px;
        margin-right: -1px;
      }

      .o-column-groups {
        grid-column-start: 2;
        border-top: 1px solid ${GRID_BORDER_COLOR};
      }

      .o-row-groups {
        grid-row-start: 2;
      }

      .o-group-grid {
        border-top: 1px solid ${GRID_BORDER_COLOR};
        border-left: 1px solid ${GRID_BORDER_COLOR};
      }
    }
  }

  .o-two-columns {
    grid-column: 1 / 3;
  }

  .o-icon {
    width: ${ICON_EDGE_LENGTH}px;
    height: ${ICON_EDGE_LENGTH}px;
    vertical-align: middle;
  }

  .o-cf-icon {
    width: ${CF_ICON_EDGE_LENGTH}px;
    height: ${CF_ICON_EDGE_LENGTH}px;
    vertical-align: sub;
  }

  .o-text-icon {
    vertical-align: middle;
  }
`;css`
  .o-grid {
    position: relative;
    overflow: hidden;
    background-color: ${BACKGROUND_GRAY_COLOR};
    &:focus {
      outline: none;
    }

    > canvas {
      border-bottom: 1px solid #e2e3e3;
    }
    .o-scrollbar {
      &.corner {
        right: 0px;
        bottom: 0px;
        height: ${SCROLLBAR_WIDTH}px;
        width: ${SCROLLBAR_WIDTH}px;
        border-top: 1px solid #e2e3e3;
        border-left: 1px solid #e2e3e3;
      }
    }

    .o-grid-overlay {
      position: absolute;
      outline: none;
    }
  }

  .o-button {
    border: 1px solid;
    padding: 0px 20px 0px 20px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 14px;
    height: 30px;
    line-height: 16px;
    margin-right: 8px;

    &:not(:hover) {
      background-color: transparent;
    }

    &:enabled {
      cursor: pointer;
    }

    &:disabled {
      color: ${DISABLED_TEXT_COLOR};
    }

    &:last-child {
      margin-right: 0px;
    }

    &.o-button-grey {
      border-color: lightgrey;
      background: #ffffff;
      color: #333;
      &:hover:enabled {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
  }

  .o-input {
    color: #666666;
    border-radius: 4px;
    min-width: 0px;
    padding: 4px 6px;
    box-sizing: border-box;
    line-height: 1;
    width: 100%;
    height: 28px;
  }
`;class Spreadsheet extends owl.Component{static template="o-spreadsheet-Spreadsheet";static components={TopBar,Grid,BottomBar,SidePanel,SpreadsheetDashboard,HeaderGroupContainer,};sidePanel;composer;_focusGrid;keyDownMapping;isViewportTooSmall=false;get model(){return this.props.model;}
getStyle(){if(this.env.isDashboard()){return`grid-template-rows: auto;`;}
return`grid-template-rows: ${TOPBAR_HEIGHT}px auto ${BOTTOMBAR_HEIGHT + 1}px`;}
setup(){this.sidePanel=owl.useState({isOpen:false,panelProps:{}});this.composer=owl.useState({topBarFocus:"inactive",gridFocusMode:"inactive",});this.keyDownMapping={"CTRL+H":()=>this.toggleSidePanel("FindAndReplace",{}),"CTRL+F":()=>this.toggleSidePanel("FindAndReplace",{}),};const fileStore=this.model.config.external.fileStore;owl.useSubEnv({model:this.model,imageProvider:fileStore?new ImageProvider(fileStore):undefined,loadCurrencies:this.model.config.external.loadCurrencies,loadLocales:this.model.config.external.loadLocales,isDashboard:()=>this.model.getters.isDashboard(),openSidePanel:this.openSidePanel.bind(this),toggleSidePanel:this.toggleSidePanel.bind(this),clipboard:this.env.clipboard||instantiateClipboard(),startCellEdition:(content)=>this.onGridComposerCellFocused(content),focusableElement:new FocusableElement(),});owl.useExternalListener(window,"resize",()=>this.render(true));owl.useExternalListener(window,"beforeunload",this.unbindModelEvents.bind(this));this.bindModelEvents();owl.onWillUpdateProps((nextProps)=>{if(nextProps.model!==this.props.model){throw new Error("Changing the props model is not supported at the moment.");}});owl.onMounted(()=>{this.checkViewportSize();});owl.onWillUnmount(()=>this.unbindModelEvents());owl.onPatched(()=>{this.checkViewportSize();});}
get focusTopBarComposer(){return this.model.getters.getEditionMode()==="inactive"?"inactive":this.composer.topBarFocus;}
get focusGridComposer(){return this.model.getters.getEditionMode()==="inactive"?"inactive":this.composer.gridFocusMode;}
bindModelEvents(){this.model.on("update",this,()=>this.render(true));this.model.on("notify-ui",this,(notification)=>this.env.notifyUser(notification));this.model.on("raise-error-ui",this,({text})=>this.env.raiseError(text));}
unbindModelEvents(){this.model.off("update",this);this.model.off("notify-ui",this);this.model.off("raise-error-ui",this);}
checkViewportSize(){const{xRatio,yRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());if(!isFinite(xRatio)||!isFinite(yRatio)){return;}
if(yRatio>MAXIMAL_FREEZABLE_RATIO||xRatio>MAXIMAL_FREEZABLE_RATIO){if(this.isViewportTooSmall){return;}
this.env.notifyUser({text:_t("The current window is too small to display this sheet properly. Consider resizing your browser window or adjusting frozen rows and columns."),type:"warning",sticky:false,});this.isViewportTooSmall=true;}
else{this.isViewportTooSmall=false;}}
openSidePanel(panel,panelProps){if(this.sidePanel.isOpen&&panel!==this.sidePanel.component){this.sidePanel.panelProps?.onCloseSidePanel?.();}
this.sidePanel.component=panel;this.sidePanel.panelProps=panelProps;this.sidePanel.isOpen=true;}
closeSidePanel(){this.sidePanel.isOpen=false;this.focusGrid();this.sidePanel.panelProps?.onCloseSidePanel?.();}
toggleSidePanel(panel,panelProps){if(this.sidePanel.isOpen&&panel===this.sidePanel.component){this.sidePanel.isOpen=false;this.focusGrid();}
else{this.openSidePanel(panel,panelProps);}}
focusGrid(){if(!this._focusGrid){throw new Error("_focusGrid should be exposed by the grid component");}
this._focusGrid();}
onKeydown(ev){let keyDownString="";if(isCtrlKey(ev)){keyDownString+="CTRL+";}
keyDownString+=ev.key.toUpperCase();let handler=this.keyDownMapping[keyDownString];if(handler){ev.preventDefault();ev.stopPropagation();handler();return;}}
onTopBarComposerFocused(selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="contentFocus";this.composer.gridFocusMode="inactive";this.setComposerContent({selection});}
onGridComposerContentFocused(selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="inactive";this.composer.gridFocusMode="contentFocus";this.setComposerContent({selection});}
onGridComposerCellFocused(content,selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="inactive";this.composer.gridFocusMode="cellFocus";this.setComposerContent({content,selection}||{});}
setComposerContent({content,selection,}){if(this.model.getters.getEditionMode()==="inactive"){this.model.dispatch("START_EDITION",{text:content,selection});}
else if(content){this.model.dispatch("SET_CURRENT_CONTENT",{content,selection});}}
get gridHeight(){const{height}=this.env.model.getters.getSheetViewDimension();return height;}
get gridContainerStyle(){const gridColSize=GROUP_LAYER_WIDTH*this.rowLayers.length;const gridRowSize=GROUP_LAYER_WIDTH*this.colLayers.length;return cssPropertiesToCss({"grid-template-columns":`${gridColSize ? gridColSize + 2 : 0}px auto`,"grid-template-rows":`${gridRowSize ? gridRowSize + 2 : 0}px auto`,});}
get rowLayers(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getVisibleGroupLayers(sheetId,"ROW");}
get colLayers(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getVisibleGroupLayers(sheetId,"COL");}}
Spreadsheet.props={model:Object,};class LocalTransportService{listeners=[];sendMessage(message){for(const{callback}of this.listeners){callback(message);}}
onNewMessage(id,callback){this.listeners.push({id,callback});}
leave(id){this.listeners=this.listeners.filter((listener)=>listener.id!==id);}}
function inverseCommand(cmd){return inverseCommandRegistry.get(cmd.type)(cmd);}
function createEmptyStructure(node){if(typeof node==="string"){return{};}
else if(typeof node==="number"){return[];}
throw new Error(`Cannot create new node`);}
class Branch{buildTransformation;operations;constructor(buildTransformation,operations=[]){this.buildTransformation=buildTransformation;this.operations=operations;}
getOperations(){return this.operations;}
getOperation(operationId){const operation=this.operations.find((op)=>op.id===operationId);if(!operation){throw new Error(`Operation ${operationId} not found`);}
return operation;}
getLastOperationId(){return this.operations[this.operations.length-1]?.id;}
getFirstOperationAmong(op1,op2){for(const operation of this.operations){if(operation.id===op1)
return op1;if(operation.id===op2)
return op2;}
throw new Error(`Operation ${op1} and ${op2} not found`);}
contains(operationId){return!!this.operations.find((operation)=>operation.id===operationId);}
prepend(operation){const transformation=this.buildTransformation.with(operation.data);this.operations=[operation,...this.operations.map((operation)=>operation.transformed(transformation)),];}
insert(newOperation,predecessorOpId){const transformation=this.buildTransformation.with(newOperation.data);const{before,operation,after}=this.locateOperation(predecessorOpId);this.operations=[...before,operation,newOperation,...after.map((operation)=>operation.transformed(transformation)),];}
append(operation){this.operations.push(operation);}
appendBranch(branch){this.operations=this.operations.concat(branch.operations);}
fork(operationId){const{after}=this.locateOperation(operationId);return new Branch(this.buildTransformation,after);}
transform(transformation){this.operations=this.operations.map((operation)=>operation.transformed(transformation));}
cutBefore(operationId){this.operations=this.locateOperation(operationId).before;}
cutAfter(operationId){const{before,operation}=this.locateOperation(operationId);this.operations=before.concat([operation]);}
locateOperation(operationId){const operationIndex=this.operations.findIndex((step)=>step.id===operationId);if(operationIndex===-1){throw new Error(`Operation ${operationId} not found`);}
return{before:this.operations.slice(0,operationIndex),operation:this.operations[operationIndex],after:this.operations.slice(operationIndex+1),};}}
class Operation{id;data;constructor(id,data){this.id=id;this.data=data;}
transformed(transformation){return new LazyOperation(this.id,lazy(()=>transformation(this.data)));}}
class LazyOperation{id;lazyData;constructor(id,lazyData){this.id=id;this.lazyData=lazyData;}
get data(){return this.lazyData();}
transformed(transformation){return new LazyOperation(this.id,this.lazyData.map(transformation));}}
class OperationSequence{operations;constructor(operations){this.operations=operations;}
[Symbol.iterator](){return this.operations[Symbol.iterator]();}
stopWith(operationId){function*filter(execution,operationId){for(const step of execution){yield step;if(step.operation.id===operationId){return;}}}
return new OperationSequence(filter(this.operations,operationId));}
stopBefore(operationId){function*filter(execution,operationId){for(const step of execution){if(step.operation.id===operationId){return;}
yield step;}}
return new OperationSequence(filter(this.operations,operationId));}
startAfter(operationId){function*filter(execution,operationId){let skip=true;for(const step of execution){if(!skip){yield step;}
if(step.operation.id===operationId){skip=false;}}}
return new OperationSequence(filter(this.operations,operationId));}}
class Tree{buildTransformation;branches;branchingOperationIds=new Map();constructor(buildTransformation,initialBranch){this.buildTransformation=buildTransformation;this.branches=[initialBranch];}
getLastBranch(){return this.branches[this.branches.length-1];}
execution(branch){return new OperationSequence(linkNext(this._execution(branch),this._execution(branch)));}
revertedExecution(branch){return new OperationSequence(linkNext(this._revertedExecution(branch),this._revertedExecution(branch)));}
insertOperationLast(branch,operation){const insertAfter=branch.getLastOperationId()||this.previousBranch(branch)?.getLastOperationId();branch.append(operation);if(insertAfter){this.insertPrevious(branch,operation,insertAfter);}}
insertOperationAfter(branch,operation,predecessorOpId){branch.insert(operation,predecessorOpId);this.updateNextWith(branch,operation,predecessorOpId);this.insertPrevious(branch,operation,predecessorOpId);}
undo(branch,operation){const transformation=this.buildTransformation.without(operation.data);const branchingId=this.branchingOperationIds.get(branch);this.branchingOperationIds.set(branch,operation.id);const nextBranch=branch.fork(operation.id);if(branchingId){this.branchingOperationIds.set(nextBranch,branchingId);}
this.insertBranchAfter(branch,nextBranch);this.transform(nextBranch,transformation);}
redo(branch){const removedBranch=this.nextBranch(branch);if(!removedBranch)
return;const nextBranch=this.nextBranch(removedBranch);this.removeBranchFromTree(removedBranch);const undoBranchingId=this.branchingOperationIds.get(removedBranch);if(undoBranchingId){this.branchingOperationIds.set(branch,undoBranchingId);}
else{this.branchingOperationIds.delete(branch);}
if(nextBranch){this.rebaseUp(nextBranch);}}
drop(operationId){for(const branch of this.branches){if(branch.contains(operationId)){branch.cutBefore(operationId);}}}
findOperation(branch,operationId){for(const operation of this.revertedExecution(branch)){if(operation.operation.id===operationId){return operation;}}
throw new Error(`Operation ${operationId} not found`);}
rebaseUp(branch){const{previousBranch,branchingOperation}=this.findPreviousBranchingOperation(branch);if(!previousBranch||!branchingOperation)
return;const rebaseTransformation=this.buildTransformation.without(branchingOperation.data);const newBranch=previousBranch.fork(branchingOperation.id);this.branchingOperationIds.set(newBranch,this.branchingOperationIds.get(branch));this.removeBranchFromTree(branch);this.insertBranchAfter(previousBranch,newBranch);newBranch.transform(rebaseTransformation);const nextBranch=this.nextBranch(newBranch);if(nextBranch){this.rebaseUp(nextBranch);}}
removeBranchFromTree(branch){const index=this.branches.findIndex((l)=>l===branch);this.branches.splice(index,1);}
insertBranchAfter(branch,toInsert){const index=this.branches.findIndex((l)=>l===branch);this.branches.splice(index+1,0,toInsert);}
updateNextWith(branch,operation,predecessorOpId){const branchingId=this.branchingOperationIds.get(branch);const nextBranch=this.nextBranch(branch);if(!branchingId||!nextBranch){return;}
if(branch.getFirstOperationAmong(predecessorOpId,branchingId)===branchingId){const transformedOperation=this.addToNextBranch(branch,nextBranch,branchingId,operation,predecessorOpId);this.updateNextWith(nextBranch,transformedOperation,predecessorOpId);}
else{const transformation=this.buildTransformation.with(operation.data);this.transform(nextBranch,transformation);}}
addToNextBranch(branch,nextBranch,branchingId,operation,predecessorOpId){let transformedOperation=operation;if(predecessorOpId===branchingId){transformedOperation=this.getTransformedOperation(branch,branchingId,operation);nextBranch.prepend(transformedOperation);}
else if(nextBranch.contains(predecessorOpId)){transformedOperation=this.getTransformedOperation(branch,branchingId,operation);nextBranch.insert(transformedOperation,predecessorOpId);}
else{nextBranch.append(operation);}
return transformedOperation;}
getTransformedOperation(branch,branchingId,operation){const branchingOperation=branch.getOperation(branchingId);const branchingTransformation=this.buildTransformation.without(branchingOperation.data);return operation.transformed(branchingTransformation);}
shouldExecute(branch,operation){return operation.id!==this.branchingOperationIds.get(branch);}
transform(branch,transformation){branch.transform(transformation);const nextBranch=this.nextBranch(branch);if(nextBranch){this.transform(nextBranch,transformation);}}
insertPrevious(branch,newOperation,insertAfter){const{previousBranch,branchingOperation}=this.findPreviousBranchingOperation(branch);if(!previousBranch||!branchingOperation)
return;const transformation=this.buildTransformation.with(branchingOperation.data);const branchTail=branch.fork(insertAfter);branchTail.transform(transformation);previousBranch.cutAfter(insertAfter);previousBranch.appendBranch(branchTail);const operationToInsert=newOperation.transformed(transformation);this.insertPrevious(previousBranch,operationToInsert,insertAfter);}
findPreviousBranchingOperation(branch){const previousBranch=this.previousBranch(branch);if(!previousBranch)
return{previousBranch:undefined,branchingOperation:undefined};const previousBranchingId=this.branchingOperationIds.get(previousBranch);if(!previousBranchingId)
return{previousBranch:undefined,branchingOperation:undefined};return{previousBranch,branchingOperation:previousBranch.getOperation(previousBranchingId),};}
nextBranch(branch){const index=this.branches.findIndex((l)=>l===branch);if(index===-1){return undefined;}
return this.branches[index+1];}
previousBranch(branch){const index=this.branches.findIndex((l)=>l===branch);if(index===-1){return undefined;}
return this.branches[index-1];}*_revertedExecution(branch){const branchingOperationId=this.branchingOperationIds.get(branch);let afterBranchingPoint=!!branchingOperationId;const operations=branch.getOperations();for(let i=operations.length-1;i>=0;i--){const operation=operations[i];if(operation.id===branchingOperationId){afterBranchingPoint=false;}
if(!afterBranchingPoint){yield{operation:operation,branch:branch,isCancelled:!this.shouldExecute(branch,operation),};}}
const previous=this.previousBranch(branch);yield*previous?this._revertedExecution(previous):[];}*_execution(branch){for(const operation of branch.getOperations()){yield{operation:operation,branch:branch,isCancelled:!this.shouldExecute(branch,operation),};if(operation.id===this.branchingOperationIds.get(branch)){const next=this.nextBranch(branch);yield*next?this._execution(next):[];return;}}
if(!this.branchingOperationIds.get(branch)){const next=this.nextBranch(branch);yield*next?this._execution(next):[];}}}
class SelectiveHistory{HEAD_BRANCH;HEAD_OPERATION;tree;applyOperation;revertOperation;buildEmpty;buildTransformation;constructor(args){this.applyOperation=args.applyOperation;this.revertOperation=args.revertOperation;this.buildEmpty=args.buildEmpty;this.buildTransformation=args.buildTransformation;this.HEAD_BRANCH=new Branch(this.buildTransformation);this.tree=new Tree(this.buildTransformation,this.HEAD_BRANCH);const initialOperationId=args.initialOperationId;const initial=new Operation(initialOperationId,this.buildEmpty(initialOperationId));this.tree.insertOperationLast(this.HEAD_BRANCH,initial);this.HEAD_OPERATION=initial;}
get(operationId){return this.tree.findOperation(this.HEAD_BRANCH,operationId).operation.data;}
append(operationId,data){const operation=new Operation(operationId,data);const branch=this.tree.getLastBranch();this.tree.insertOperationLast(branch,operation);this.HEAD_BRANCH=branch;this.HEAD_OPERATION=operation;}
insert(operationId,data,insertAfter){const operation=new Operation(operationId,data);this.revertTo(insertAfter);this.tree.insertOperationAfter(this.HEAD_BRANCH,operation,insertAfter);this.fastForward();}
undo(operationId,undoId,insertAfter){const{branch,operation}=this.tree.findOperation(this.HEAD_BRANCH,operationId);this.revertBefore(operationId);this.tree.undo(branch,operation);this.fastForward();this.insert(undoId,this.buildEmpty(undoId),insertAfter);}
redo(operationId,redoId,insertAfter){const{branch}=this.tree.findOperation(this.HEAD_BRANCH,operationId);this.revertBefore(operationId);this.tree.redo(branch);this.fastForward();this.insert(redoId,this.buildEmpty(redoId),insertAfter);}
drop(operationId){this.revertBefore(operationId);this.tree.drop(operationId);}
getRevertedExecution(){const data=[];const operations=this.tree.revertedExecution(this.HEAD_BRANCH);for(const{operation}of operations){data.push(operation.data);}
return data;}
revertBefore(operationId){const execution=this.tree.revertedExecution(this.HEAD_BRANCH).stopWith(operationId);this.revert(execution);}
revertTo(operationId){const execution=operationId?this.tree.revertedExecution(this.HEAD_BRANCH).stopBefore(operationId):this.tree.revertedExecution(this.HEAD_BRANCH);this.revert(execution);}
revert(execution){for(const{next,operation,isCancelled}of execution){if(!isCancelled){this.revertOperation(operation.data);}
if(next){this.HEAD_BRANCH=next.branch;this.HEAD_OPERATION=next.operation;}}}
fastForward(){const operations=this.HEAD_OPERATION?this.tree.execution(this.HEAD_BRANCH).startAfter(this.HEAD_OPERATION.id):this.tree.execution(this.HEAD_BRANCH);for(const{operation:operation,branch,isCancelled}of operations){if(!isCancelled){this.applyOperation(operation.data);}
this.HEAD_OPERATION=operation;this.HEAD_BRANCH=branch;}}}
function buildRevisionLog(args){return new SelectiveHistory({initialOperationId:args.initialRevisionId,applyOperation:(revision)=>{const commands=revision.commands.slice();const{changes}=args.recordChanges(()=>{for(const command of commands){args.dispatch(command);}});revision.setChanges(changes);},revertOperation:(revision)=>revertChanges([revision]),buildEmpty:(id)=>new Revision(id,"empty",[]),buildTransformation:{with:(revision)=>(toTransform)=>{return new Revision(toTransform.id,toTransform.clientId,transformAll(toTransform.commands,revision.commands),toTransform.rootCommand,undefined,toTransform.timestamp);},without:(revision)=>(toTransform)=>{return new Revision(toTransform.id,toTransform.clientId,transformAll(toTransform.commands,revision.commands.map(inverseCommand).flat()),toTransform.rootCommand,undefined,toTransform.timestamp);},},});}
function revertChanges(revisions){for(const revision of revisions.slice().reverse()){for(let i=revision.changes.length-1;i>=0;i--){const change=revision.changes[i];applyChange(change,"before");}}}
function applyChange(change,target){let val=change.path[0];const key=change.path.at(-1);for(let pathIndex=1;pathIndex<change.path.slice(0,-1).length;pathIndex++){const p=change.path[pathIndex];if(val[p]===undefined){const nextPath=change.path[pathIndex+1];val[p]=createEmptyStructure(nextPath);}
val=val[p];}
if(change[target]===undefined){delete val[key];}
else{val[key]=change[target];}}
class EventStream{observers=new Map();defaultSubscription;mainSubscription;registerAsDefault(owner,callbacks){this.defaultSubscription={owner,callbacks};if(!this.mainSubscription){this.mainSubscription=this.defaultSubscription;}}
observe(owner,callbacks){this.observers.set(owner,{owner,callbacks});}
capture(owner,callbacks){if(this.observers.get(owner)){throw new Error("You are already subscribed forever");}
if(this.mainSubscription?.owner&&this.mainSubscription.owner!==owner){this.mainSubscription.callbacks.release?.();}
this.mainSubscription={owner,callbacks};}
release(owner){if(this.mainSubscription?.owner!==owner||this.observers.get(owner)){return;}
this.mainSubscription=this.defaultSubscription;}
getBackToDefault(){if(this.mainSubscription===this.defaultSubscription){return;}
this.mainSubscription?.callbacks.release?.();this.mainSubscription=this.defaultSubscription;}
isListening(owner){return this.mainSubscription?.owner===owner;}
send(event){this.mainSubscription?.callbacks.handleEvent(event);this.observers.forEach((sub)=>sub.callbacks.handleEvent(event));}}
class SelectionStreamProcessorImpl{getters;stream;anchor;defaultAnchor;constructor(getters){this.getters=getters;this.stream=new EventStream();this.anchor={cell:{col:0,row:0},zone:positionToZone({col:0,row:0})};this.defaultAnchor=this.anchor;}
capture(owner,anchor,callbacks){this.stream.capture(owner,callbacks);this.anchor=anchor;}
registerAsDefault(owner,anchor,callbacks){this.checkAnchorZoneOrThrow(anchor);this.stream.registerAsDefault(owner,callbacks);this.defaultAnchor=anchor;this.capture(owner,anchor,callbacks);}
resetDefaultAnchor(owner,anchor){this.checkAnchorZoneOrThrow(anchor);if(this.stream.isListening(owner)){this.anchor=anchor;}
this.defaultAnchor=anchor;}
resetAnchor(owner,anchor){this.checkAnchorZoneOrThrow(anchor);if(this.stream.isListening(owner)){this.anchor=anchor;}}
observe(owner,callbacks){this.stream.observe(owner,callbacks);}
release(owner){if(this.stream.isListening(owner)){this.stream.release(owner);this.anchor=this.defaultAnchor;}}
getBackToDefault(){this.stream.getBackToDefault();}
modifyAnchor(anchor,mode,options){const sheetId=this.getters.getActiveSheetId();anchor={...anchor,zone:this.getters.expandZone(sheetId,anchor.zone),};return this.processEvent({options,anchor,mode,});}
selectZone(anchor,options={scrollIntoView:true}){return this.modifyAnchor(anchor,"overrideSelection",options);}
selectCell(col,row){const zone=positionToZone({col,row});return this.selectZone({zone,cell:{col,row}},{scrollIntoView:true});}
moveAnchorCell(direction,step=1){if(step!=="end"&&step<=0){return new DispatchResult("InvalidSelectionStep");}
const{col,row}=this.getNextAvailablePosition(direction,step);return this.selectCell(col,row);}
setAnchorCorner(col,row){const sheetId=this.getters.getActiveSheetId();const{col:anchorCol,row:anchorRow}=this.anchor.cell;const zone={left:Math.min(anchorCol,col),top:Math.min(anchorRow,row),right:Math.max(anchorCol,col),bottom:Math.max(anchorRow,row),};const expandedZone=this.getters.expandZone(sheetId,zone);const anchor={zone:expandedZone,cell:{col:anchorCol,row:anchorRow}};return this.processEvent({mode:"updateAnchor",anchor:anchor,options:{scrollIntoView:false},});}
addCellToSelection(col,row){const sheetId=this.getters.getActiveSheetId();({col,row}=this.getters.getMainCellPosition({sheetId,col,row}));const zone=this.getters.expandZone(sheetId,positionToZone({col,row}));return this.processEvent({options:{scrollIntoView:true},anchor:{zone,cell:{col,row}},mode:"newAnchor",});}
resizeAnchorZone(direction,step=1){if(step!=="end"&&step<=0){return new DispatchResult("InvalidSelectionStep");}
const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;const{col:anchorCol,row:anchorRow}=anchor.cell;const{left,right,top,bottom}=anchor.zone;const starting=this.getStartingPosition(direction);let[deltaCol,deltaRow]=this.deltaToTarget(starting,direction,step);if(deltaCol===0&&deltaRow===0){return DispatchResult.Success;}
let result=anchor.zone;const expand=(z)=>{z=organizeZone(z);const{left,right,top,bottom}=this.getters.expandZone(sheetId,z);return{left:Math.max(0,left),right:Math.min(this.getters.getNumberCols(sheetId)-1,right),top:Math.max(0,top),bottom:Math.min(this.getters.getNumberRows(sheetId)-1,bottom),};};const{col:refCol,row:refRow}=this.getReferencePosition();let n=0;while(result!==null){n++;if(deltaCol<0){const newRight=this.getNextAvailableCol(deltaCol,right-(n-1),refRow);result=refCol<=right-n?expand({top,left,bottom,right:newRight}):null;}
if(deltaCol>0){const newLeft=this.getNextAvailableCol(deltaCol,left+(n-1),refRow);result=left+n<=refCol?expand({top,left:newLeft,bottom,right}):null;}
if(deltaRow<0){const newBottom=this.getNextAvailableRow(deltaRow,refCol,bottom-(n-1));result=refRow<=bottom-n?expand({top,left,bottom:newBottom,right}):null;}
if(deltaRow>0){const newTop=this.getNextAvailableRow(deltaRow,refCol,top+(n-1));result=top+n<=refRow?expand({top:newTop,left,bottom,right}):null;}
result=result?organizeZone(result):result;if(result&&!isEqual(result,anchor.zone)){return this.processEvent({options:{scrollIntoView:true},mode:"updateAnchor",anchor:{zone:result,cell:{col:anchorCol,row:anchorRow}},});}}
const currentZone={top:anchorRow,bottom:anchorRow,left:anchorCol,right:anchorCol,};const zoneWithDelta=organizeZone({top:this.getNextAvailableRow(deltaRow,refCol,top),left:this.getNextAvailableCol(deltaCol,left,refRow),bottom:this.getNextAvailableRow(deltaRow,refCol,bottom),right:this.getNextAvailableCol(deltaCol,right,refRow),});result=expand(union(currentZone,zoneWithDelta));const newAnchor={zone:result,cell:{col:anchorCol,row:anchorRow}};return this.processEvent({anchor:newAnchor,mode:"updateAnchor",options:{scrollIntoView:true},});}
selectColumn(index,mode){const sheetId=this.getters.getActiveSheetId();const bottom=this.getters.getNumberRows(sheetId)-1;let zone={left:index,right:index,top:0,bottom};const top=this.getters.findFirstVisibleColRowIndex(sheetId,"ROW");let col,row;switch(mode){case"overrideSelection":case"newAnchor":col=index;row=top;break;case"updateAnchor":({col,row}=this.anchor.cell);zone=union(zone,{left:col,right:col,top,bottom});break;}
return this.processEvent({options:{scrollIntoView:false,unbounded:true,},anchor:{zone,cell:{col,row}},mode,});}
selectRow(index,mode){const sheetId=this.getters.getActiveSheetId();const right=this.getters.getNumberCols(sheetId)-1;let zone={top:index,bottom:index,left:0,right};const left=this.getters.findFirstVisibleColRowIndex(sheetId,"COL");let col,row;switch(mode){case"overrideSelection":case"newAnchor":col=left;row=index;break;case"updateAnchor":({col,row}=this.anchor.cell);zone=union(zone,{left,right,top:row,bottom:row});break;}
return this.processEvent({options:{scrollIntoView:false,unbounded:true,},anchor:{zone,cell:{col,row}},mode,});}
loopSelection(){const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;if(isEqual(this.anchor.zone,this.getters.getSheetZone(sheetId))){return this.modifyAnchor({...anchor,zone:positionToZone(anchor.cell)},"updateAnchor",{scrollIntoView:false,});}
const tableZone=this.expandZoneToTable(anchor.zone);return!deepEquals(tableZone,anchor.zone)?this.modifyAnchor({...anchor,zone:tableZone},"updateAnchor",{scrollIntoView:false,}):this.selectAll();}
selectTableAroundSelection(){const tableZone=this.expandZoneToTable(this.anchor.zone);return this.modifyAnchor({...this.anchor,zone:tableZone},"updateAnchor",{scrollIntoView:false,});}
selectAll(){const sheetId=this.getters.getActiveSheetId();const bottom=this.getters.getNumberRows(sheetId)-1;const right=this.getters.getNumberCols(sheetId)-1;const zone={left:0,top:0,bottom,right};return this.processEvent({mode:"overrideSelection",anchor:{zone,cell:this.anchor.cell},options:{scrollIntoView:false,},});}
isListening(owner){return this.stream.isListening(owner);}
processEvent(newAnchorEvent){const event={...newAnchorEvent,previousAnchor:deepCopy(this.anchor)};const commandResult=this.checkEventAnchorZone(event);if(commandResult!=="Success"){return new DispatchResult(commandResult);}
this.anchor=event.anchor;this.stream.send(event);return DispatchResult.Success;}
checkEventAnchorZone(event){return this.checkAnchorZone(event.anchor);}
checkAnchorZone(anchor){const{cell,zone}=anchor;if(!isInside(cell.col,cell.row,zone)){return"InvalidAnchorZone";}
const{left,right,top,bottom}=zone;const sheetId=this.getters.getActiveSheetId();const refCol=this.getters.findVisibleHeader(sheetId,"COL",left,right);const refRow=this.getters.findVisibleHeader(sheetId,"ROW",top,bottom);if(refRow===undefined||refCol===undefined){return"SelectionOutOfBound";}
return"Success";}
checkAnchorZoneOrThrow(anchor){const result=this.checkAnchorZone(anchor);if(result==="InvalidAnchorZone"){throw new Error(_t("The provided anchor is invalid. The cell must be part of the zone."));}}
getNextAvailablePosition(direction,step=1){const{col,row}=this.anchor.cell;const delta=this.deltaToTarget({col,row},direction,step);return{col:this.getNextAvailableCol(delta[0],col,row),row:this.getNextAvailableRow(delta[1],col,row),};}
getNextAvailableCol(delta,colIndex,rowIndex){const sheetId=this.getters.getActiveSheetId();const position={col:colIndex,row:rowIndex};const isInPositionMerge=(nextCol)=>this.getters.isInSameMerge(sheetId,colIndex,rowIndex,nextCol,rowIndex);return this.getNextAvailableHeader(delta,"COL",colIndex,position,isInPositionMerge);}
getNextAvailableRow(delta,colIndex,rowIndex){const sheetId=this.getters.getActiveSheetId();const position={col:colIndex,row:rowIndex};const isInPositionMerge=(nextRow)=>this.getters.isInSameMerge(sheetId,colIndex,rowIndex,colIndex,nextRow);return this.getNextAvailableHeader(delta,"ROW",rowIndex,position,isInPositionMerge);}
getNextAvailableHeader(delta,dimension,startingHeaderIndex,position,isInPositionMerge){const sheetId=this.getters.getActiveSheetId();if(delta===0){return startingHeaderIndex;}
const step=Math.sign(delta);let header=startingHeaderIndex+delta;while(isInPositionMerge(header)){header+=step;}
while(this.getters.isHeaderHidden(sheetId,dimension,header)){header+=step;}
const outOfBound=header<0||header>this.getters.getNumberHeaders(sheetId,dimension)-1;if(outOfBound){if(this.getters.isHeaderHidden(sheetId,dimension,startingHeaderIndex)){return this.getNextAvailableHeader(-step,dimension,startingHeaderIndex,position,isInPositionMerge);}
else{return startingHeaderIndex;}}
return header;}
getReferencePosition(){const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;const{left,right,top,bottom}=anchor.zone;const{col:anchorCol,row:anchorRow}=anchor.cell;return{col:this.getters.isColHidden(sheetId,anchorCol)?this.getters.findVisibleHeader(sheetId,"COL",left,right)||anchorCol:anchorCol,row:this.getters.isRowHidden(sheetId,anchorRow)?this.getters.findVisibleHeader(sheetId,"ROW",top,bottom)||anchorRow:anchorRow,};}
deltaToTarget(position,direction,step){switch(direction){case"up":return step!=="end"?[0,-step]:[0,this.getEndOfCluster(position,"rows",-1)-position.row];case"down":return step!=="end"?[0,step]:[0,this.getEndOfCluster(position,"rows",1)-position.row];case"left":return step!=="end"?[-step,0]:[this.getEndOfCluster(position,"cols",-1)-position.col,0];case"right":return step!=="end"?[step,0]:[this.getEndOfCluster(position,"cols",1)-position.col,0];}}
getStartingPosition(direction){let{col,row}=this.getPosition();const zone=this.anchor.zone;switch(direction){case"down":case"up":row=row===zone.top?zone.bottom:zone.top;break;case"left":case"right":col=col===zone.right?zone.left:zone.right;break;}
return{col,row};}
getEndOfCluster(startPosition,dim,dir){let currentPosition=startPosition;const nextCellPosition=this.getNextCellPosition(startPosition,dim,dir);let mode=!this.isEvaluatedCellEmpty(currentPosition)&&!this.isEvaluatedCellEmpty(nextCellPosition)?"endOfCluster":"nextCluster";while(true){const nextCellPosition=this.getNextCellPosition(currentPosition,dim,dir);if(currentPosition.col===nextCellPosition.col&&currentPosition.row===nextCellPosition.row){break;}
const isNextCellEmpty=this.isEvaluatedCellEmpty(nextCellPosition);if(mode==="endOfCluster"&&isNextCellEmpty){break;}
else if(mode==="nextCluster"&&!isNextCellEmpty){currentPosition=nextCellPosition;break;}
currentPosition=nextCellPosition;}
return dim==="cols"?currentPosition.col:currentPosition.row;}
isCellEmpty({col,row}){const sheetId=this.getters.getActiveSheetId();const position=this.getters.getMainCellPosition({sheetId,col,row});return!(this.getters.getCorrespondingFormulaCell(position)||this.getters.getCell(position)?.content);}
isEvaluatedCellEmpty({col,row}){const sheetId=this.getters.getActiveSheetId();const position=this.getters.getMainCellPosition({sheetId,col,row});const cell=this.getters.getEvaluatedCell(position);return cell.type===CellValueType.empty;}
getNextCellPosition(currentPosition,dimension,direction){const dimOfInterest=dimension==="cols"?"col":"row";const startingPosition={...currentPosition};const nextCoord=dimension==="cols"?this.getNextAvailableCol(direction,startingPosition.col,startingPosition.row):this.getNextAvailableRow(direction,startingPosition.col,startingPosition.row);startingPosition[dimOfInterest]=nextCoord;return{col:startingPosition.col,row:startingPosition.row};}
getPosition(){return{...this.anchor.cell};}
expandZoneToTable(zoneToExpand){const expandZone=(zone)=>{for(const col of range(zone.left,zone.right+1)){if(!this.isCellEmpty({col,row:zone.top-1})){return{...zone,top:zone.top-1};}
if(!this.isCellEmpty({col,row:zone.bottom+1})){return{...zone,bottom:zone.bottom+1};}}
for(const row of range(zone.top,zone.bottom+1)){if(!this.isCellEmpty({col:zone.left-1,row})){return{...zone,left:zone.left-1};}
if(!this.isCellEmpty({col:zone.right+1,row})){return{...zone,right:zone.right+1};}}
return zone;};let hasExpanded=false;let zone=zoneToExpand;do{hasExpanded=false;const newZone=expandZone(zone);if(!isEqual(zone,newZone)){hasExpanded=true;zone=newZone;continue;}}while(hasExpanded);return zone;}}
class StateObserver{changes=[];commands=[];recordChanges(callback){this.changes=[];this.commands=[];callback();return{changes:this.changes,commands:this.commands};}
addCommand(command){this.commands.push(command);}
addChange(...args){const val=args.pop();const root=args[0];let value=root;let key=args.at(-1);const pathLength=args.length-2;for(let pathIndex=1;pathIndex<=pathLength;pathIndex++){const p=args[pathIndex];if(value[p]===undefined){const nextPath=args[pathIndex+1];value[p]=createEmptyStructure(nextPath);}
value=value[p];}
if(value[key]===val){return;}
this.changes.push({path:args,before:value[key],after:val,});if(val===undefined){delete value[key];}
else{value[key]=val;}}}
const catAxId=17781237;const valAxId=88853993;function createChart(chart,chartSheetIndex,data){const namespaces=[["xmlns:r",RELATIONSHIP_NSR],["xmlns:a",DRAWING_NS_A],["xmlns:c",DRAWING_NS_C],];const chartShapeProperty=shapeProperty({backgroundColor:chart.data.backgroundColor,line:{color:"000000"},});let title=escapeXml``;if(chart.data.title){title=escapeXml`
      <c:title>
        ${insertText(chart.data.title, chart.data.fontColor)}
        <c:overlay val="0" />
      </c:title>
    `;}
let plot=escapeXml``;switch(chart.data.type){case"bar":plot=addBarChart(chart.data);break;case"line":plot=addLineChart(chart.data);break;case"pie":plot=addDoughnutChart(chart.data,chartSheetIndex,data,{holeSize:0});break;}
let position="t";switch(chart.data.legendPosition){case"bottom":position="b";break;case"left":position="l";break;case"right":position="r";break;case"top":position="t";break;}
const fontColor=chart.data.fontColor;const xml=escapeXml`
    <c:chartSpace ${formatAttributes(namespaces)}>
      <c:roundedCorners val="0" />
      <!-- <manualLayout/> to manually position the chart in the figure container -->
      ${chartShapeProperty}
      <c:chart>
        ${title}
        <c:autoTitleDeleted val="0" />
        <c:plotArea>
          <!-- how the chart element is placed on the chart -->
          <c:layout />
          ${plot}
          ${shapeProperty({ backgroundColor: chart.data.backgroundColor })}
        </c:plotArea>
        ${addLegend(position, fontColor)}
      </c:chart>
    </c:chartSpace>
  `;return parseXML(xml);}
function shapeProperty(params){return escapeXml`
    <c:spPr>
      ${params.backgroundColor ? solidFill(params.backgroundColor) : ""}
      ${params.line ? lineAttributes(params.line) : ""}
    </c:spPr>
  `;}
function solidFill(color){return escapeXml`
    <a:solidFill>
      <a:srgbClr val="${color}"/>
    </a:solidFill>
  `;}
function lineAttributes(params){const attrs=[["cmpd","sng"]];if(params.width){attrs.push(["w",convertDotValueToEMU(params.width)]);}
const lineStyle=params.style?escapeXml`<a:prstDash val="${params.style}"/>`:"";return escapeXml`
    <a:ln ${formatAttributes(attrs)}>
      ${solidFill(params.color)}
      ${lineStyle}
    </a:ln>
  `;}
function insertText(text,fontColor="000000",fontsize=22){return escapeXml`
    <c:tx>
      <c:rich>
        <a:bodyPr />
        <a:lstStyle />
        <a:p>
          <a:pPr lvl="0">
            <a:defRPr b="0">
              ${solidFill(fontColor)}
              <a:latin typeface="+mn-lt"/>
            </a:defRPr>
          </a:pPr>
          <a:r> <!-- Runs -->
            <a:rPr sz="${fontsize * 100}"/>
            <a:t>${text}</a:t>
          </a:r>
        </a:p>
      </c:rich>
    </c:tx>
  `;}
function insertTextProperties(fontsize=12,fontColor="000000",bold=false,italic=false){const defPropertiesAttributes=[["b",bold?"1":"0"],["i",italic?"1":"0"],["sz",fontsize*100],];return escapeXml`
    <c:txPr>
      <a:bodyPr/>
      <a:lstStyle/>
      <a:p>
        <a:pPr lvl="0">
          <a:defRPr ${formatAttributes(defPropertiesAttributes)}>
            ${solidFill(fontColor)}
            <a:latin typeface="+mn-lt"/>
          </a:defRPr>
        </a:pPr>
      </a:p>
    </c:txPr>
  `;}
function addBarChart(chart){const colors=new ChartColors();const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets)){const color=toXlsxHexColor(colors.next());const dataShapeProperty=shapeProperty({backgroundColor:color,line:{color},});dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        ${dataset.label ? escapeXml /*xml*/ `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${dataShapeProperty}
        ${chart.labelRange ? escapeXml /*xml*/ `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""} <!-- x-coordinate values -->
        <c:val> <!-- x-coordinate values -->
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
const axisPos=chart.verticalAxisPosition==="left"?"l":"r";const grouping=chart.stacked?"stacked":"clustered";const overlap=chart.stacked?100:-20;return escapeXml`
    <c:barChart>
      <c:barDir val="col"/>
      <c:grouping val="${grouping}"/>
      <c:overlap val="${overlap}"/>
      <c:gapWidth val="70"/>
      <!-- each data marker in the series does not have a different color -->
      <c:varyColors val="0"/>
      ${joinXmlNodes(dataSetsNodes)}
      <c:axId val="${catAxId}" />
      <c:axId val="${valAxId}" />
    </c:barChart>
    ${addAx("b", "c:catAx", catAxId, valAxId, { fontColor: chart.fontColor })}
    ${addAx(axisPos, "c:valAx", valAxId, catAxId, { fontColor: chart.fontColor })}
  `;}
function addLineChart(chart){const colors=new ChartColors();const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets)){const dataShapeProperty=shapeProperty({line:{width:2.5,style:"solid",color:toXlsxHexColor(colors.next()),},});dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        <c:smooth val="0"/>
        <c:marker>
          <c:symbol val="circle" />
          <c:size val="5"/>
        </c:marker>
        ${dataset.label ? escapeXml `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${dataShapeProperty}
        ${chart.labelRange ? escapeXml `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""} <!-- x-coordinate values -->
        <c:val> <!-- x-coordinate values -->
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
const axisPos=chart.verticalAxisPosition==="left"?"l":"r";const grouping=chart.stacked?"stacked":"standard";return escapeXml`
    <c:lineChart>
      <c:grouping val="${grouping}"/>
      <!-- each data marker in the series does not have a different color -->
      <c:varyColors val="0"/>
      ${joinXmlNodes(dataSetsNodes)}
      <c:axId val="${catAxId}" />
      <c:axId val="${valAxId}" />
    </c:lineChart>
    ${addAx("b", "c:catAx", catAxId, valAxId, { fontColor: chart.fontColor })}
    ${addAx(axisPos, "c:valAx", valAxId, catAxId, { fontColor: chart.fontColor })}
  `;}
function addDoughnutChart(chart,chartSheetIndex,data,{holeSize}={holeSize:50}){const colors=new ChartColors();const maxLength=largeMax(chart.dataSets.map((ds)=>getRangeSize(ds.range,chartSheetIndex,data)));const doughnutColors=range(0,maxLength).map(()=>toXlsxHexColor(colors.next()));const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets).reverse()){const dsSize=getRangeSize(dataset.range,chartSheetIndex,data);const dataPoints=[];for(const index of range(0,dsSize)){const pointShapeProperty=shapeProperty({backgroundColor:doughnutColors[index],line:{color:"FFFFFF",width:1.5},});dataPoints.push(escapeXml`
        <c:dPt>
          <c:idx val="${index}"/>
          ${pointShapeProperty}
        </c:dPt>
      `);}
dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        ${dataset.label ? escapeXml `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${joinXmlNodes(dataPoints)}
        ${insertDataLabels({ showLeaderLines: true })}
        ${chart.labelRange ? escapeXml `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""}
        <c:val>
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
return escapeXml`
    <c:doughnutChart>
      <c:varyColors val="1" />
      <c:holeSize val="${holeSize}" />
      ${insertDataLabels()}
      ${joinXmlNodes(dataSetsNodes)}
    </c:doughnutChart>
  `;}
function insertDataLabels({showLeaderLines}={showLeaderLines:false}){return escapeXml`
    <dLbls>
      <c:showLegendKey val="0"/>
      <c:showVal val="0"/>
      <c:showCatName val="0"/>
      <c:showSerName val="0"/>
      <c:showPercent val="0"/>
      <c:showBubbleSize val="0"/>
      <c:showLeaderLines val="${showLeaderLines ? "1" : "0"}"/>
    </dLbls>
  `;}
function addAx(position,axisName,axId,crossAxId,{fontColor}){return escapeXml`
    <${axisName}>
      <c:axId val="${axId}"/>
      <c:crossAx val="${crossAxId}"/> <!-- reference to the other axe of the chart -->
      <c:delete val="0"/> <!-- by default, axis are not displayed -->
      <c:scaling>
        <c:orientation  val="minMax" />
      </c:scaling>
      <c:axPos val="${position}" />
      ${insertMajorGridLines()}
      <c:majorTickMark val="out" />
      <c:minorTickMark val="none" />
      <c:numFmt formatCode="General" sourceLinked="1" />
      <c:title>
        ${insertText("")}
      </c:title>
      ${insertTextProperties(10, fontColor)}
    </${axisName}>
    <!-- <tickLblPos/> omitted -->
  `;}
function addLegend(position,fontColor){return escapeXml`
    <c:legend>
      <c:legendPos val="${position}"/>
      <c:overlay val="0"/>
      ${insertTextProperties(10, fontColor)}
    </c:legend>
  `;}
function insertMajorGridLines(color="B7B7B7"){return escapeXml`
    <c:majorGridlines>
      ${shapeProperty({ line: { color } })}
    </c:majorGridlines>
  `;}
function stringRef(reference){return escapeXml`
    <c:strRef>
      <c:f>${reference}</c:f>
    </c:strRef>
  `;}
function numberRef(reference){return escapeXml`
    <c:numRef>
      <c:f>${reference}</c:f>
      <c:numCache />
    </c:numRef>
  `;}
function addFormula(cell){const formula=cell.content;if(!formula){return{attrs:[],node:escapeXml``};}
const attrs=[];let node=escapeXml``;let cycle=escapeXml``;const XlsxFormula=adaptFormulaToExcel(formula);if(cell.value===CellErrorType.CircularDependency){attrs.push(["t","str"]);cycle=escapeXml`<v>${cell.value}</v>`;}
node=escapeXml`<f>${XlsxFormula}</f>${cycle}`;return{attrs,node};}
function addContent(content,sharedStrings,forceString=false){let value=content;const attrs=[];const clearValue=value.trim().toUpperCase();if(!forceString&&["TRUE","FALSE"].includes(clearValue)){value=clearValue==="TRUE"?"1":"0";attrs.push(["t","b"]);}
else if(forceString||!isNumber(value,DEFAULT_LOCALE)){value=pushElement(content,sharedStrings);attrs.push(["t","s"]);}
return{attrs,node:escapeXml`<v>${value}</v>`};}
function adaptFormulaToExcel(formulaText){if(formulaText[0]==="="){formulaText=formulaText.slice(1);}
let ast;try{ast=parse(formulaText);}
catch(error){return formulaText;}
ast=convertAstNodes(ast,"STRING",convertDateFormat);ast=convertAstNodes(ast,"FUNCALL",(ast)=>{ast={...ast,value:ast.value.toUpperCase()};ast=prependNonRetrocompatibleFunction(ast);ast=addMissingRequiredArgs(ast);return ast;});return ast?astToFormula(ast):formulaText;}
function addMissingRequiredArgs(ast){const formulaName=ast.value.toUpperCase();const args=ast.args;const exportDefaultArgs=FORCE_DEFAULT_ARGS_FUNCTIONS[formulaName];if(exportDefaultArgs){const requiredArgs=functionRegistry.content[formulaName].args.filter((el)=>!el.optional);const diffArgs=requiredArgs.length-ast.args.length;if(diffArgs){for(let i=ast.args.length;i<requiredArgs.length;i++){const currentDefaultArg=exportDefaultArgs[i-diffArgs];args.push({type:currentDefaultArg.type,value:currentDefaultArg.value});}}}
return{...ast,args};}
function prependNonRetrocompatibleFunction(ast){const formulaName=ast.value.toUpperCase();return{...ast,value:NON_RETROCOMPATIBLE_FUNCTIONS.includes(formulaName)?`_xlfn.${formulaName}`:formulaName,};}
function convertDateFormat(ast){const value=ast.value.replace(new RegExp('"',"g"),"");const internalDate=parseDateTime(value,DEFAULT_LOCALE);if(internalDate){let format=[];if(mdyDateRegexp.test(value)||ymdDateRegexp.test(value)){format.push("yyyy-mm-dd");}
if(timeRegexp.test(value)){format.push("hh:mm:ss");}
return{...ast,value:formatValue(internalDate.value,{format:format.join(" "),locale:DEFAULT_LOCALE}),};}
else{return{...ast,value:ast.value.replace(/\\"/g,`""`)};}}
function addConditionalFormatting(dxfs,conditionalFormats){const cfNodes=[];for(const cf of conditionalFormats){switch(cf.rule.type){case"CellIsRule":cfNodes.push(addCellIsRule(cf,cf.rule,dxfs));break;case"ColorScaleRule":cfNodes.push(addColorScaleRule(cf,cf.rule));break;case"IconSetRule":cfNodes.push(addIconSetRule(cf,cf.rule));break;default:console.warn(`Conditional formatting ${cf.rule.type} not implemented`);break;}}
return cfNodes;}
function addCellIsRule(cf,rule,dxfs){const ruleAttributes=commonCfAttributes(cf);const operator=convertOperator(rule.operator);ruleAttributes.push(...cellRuleTypeAttributes(rule),["operator",operator]);const formulas=cellRuleFormula(cf.ranges,rule).map((formula)=>escapeXml`<formula>${formula}</formula>`);const dxf={font:{color:{rgb:rule.style.textColor},bold:rule.style.bold,italic:rule.style.italic,strike:rule.style.strikethrough,underline:rule.style.underline,},};if(rule.style.fillColor){dxf.fill={fgColor:{rgb:rule.style.fillColor}};}
ruleAttributes.push(["dxfId",pushElement(dxf,dxfs)]);return escapeXml`
    <conditionalFormatting sqref="${cf.ranges.join(" ")}">
      <cfRule ${formatAttributes(ruleAttributes)}>
        ${joinXmlNodes(formulas)}
      </cfRule>
    </conditionalFormatting>
  `;}
function cellRuleFormula(ranges,rule){const firstCell=ranges[0].split(":")[0];const values=rule.values;switch(rule.operator){case"ContainsText":return[`NOT(ISERROR(SEARCH("${values[0]}",${firstCell})))`];case"NotContains":return[`ISERROR(SEARCH("${values[0]}",${firstCell}))`];case"BeginsWith":return[`LEFT(${firstCell},LEN("${values[0]}"))="${values[0]}"`];case"EndsWith":return[`RIGHT(${firstCell},LEN("${values[0]}"))="${values[0]}"`];case"IsEmpty":return[`LEN(TRIM(${firstCell}))=0`];case"IsNotEmpty":return[`LEN(TRIM(${firstCell}))>0`];case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":return[values[0]];case"Between":case"NotBetween":return[values[0],values[1]];}}
function cellRuleTypeAttributes(rule){const operator=convertOperator(rule.operator);switch(rule.operator){case"ContainsText":case"NotContains":case"BeginsWith":case"EndsWith":return[["type",operator],["text",rule.values[0]],];case"IsEmpty":case"IsNotEmpty":return[["type",operator]];case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":case"Between":case"NotBetween":return[["type","cellIs"]];}}
function addColorScaleRule(cf,rule){const ruleAttributes=commonCfAttributes(cf);ruleAttributes.push(["type","colorScale"]);const conditionalFormats=[];for(const range of cf.ranges){const cfValueObject=[];const colors=[];let canExport=true;for(let position of["minimum","midpoint","maximum"]){const threshold=rule[position];if(!threshold){continue;}
if(threshold.type==="formula"){canExport=false;continue;}
cfValueObject.push(thresholdAttributes(threshold,position));colors.push([["rgb",toXlsxHexColor(colorNumberString(threshold.color))]]);}
if(!canExport){console.warn("Conditional formats with formula rules are not supported at the moment. The rule is therefore skipped.");continue;}
const cfValueObjectNodes=cfValueObject.map((attrs)=>escapeXml`<cfvo ${formatAttributes(attrs)}/>`);const cfColorNodes=colors.map((attrs)=>escapeXml`<color ${formatAttributes(attrs)}/>`);conditionalFormats.push(escapeXml`
      <conditionalFormatting sqref="${range}">
        <cfRule ${formatAttributes(ruleAttributes)}>
          <colorScale>
            ${joinXmlNodes(cfValueObjectNodes)}
            ${joinXmlNodes(cfColorNodes)}
          </colorScale>
        </cfRule>
      </conditionalFormatting>
    `);}
return joinXmlNodes(conditionalFormats);}
function addIconSetRule(cf,rule){const ruleAttributes=commonCfAttributes(cf);ruleAttributes.push(["type","iconSet"]);const conditionalFormats=[];for(const range of cf.ranges){const cfValueObject=[[["type","percent"],["val",0],],];let canExport=true;for(let position of["lowerInflectionPoint","upperInflectionPoint"]){if(rule[position].type==="formula"){canExport=false;continue;}
const threshold=rule[position];cfValueObject.push([...thresholdAttributes(threshold,position),["gte",threshold.operator==="ge"?"1":"0"],]);}
if(!canExport){console.warn("Conditional formats with formula rules are not supported at the moment. The rule is therefore skipped.");continue;}
const cfValueObjectNodes=cfValueObject.map((attrs)=>escapeXml`<cfvo ${formatAttributes(attrs)} />`);conditionalFormats.push(escapeXml`
      <conditionalFormatting sqref="${range}">
        <cfRule ${formatAttributes(ruleAttributes)}>
          <iconSet iconSet="${getIconSet(rule.icons)}">
            ${joinXmlNodes(cfValueObjectNodes)}
          </iconSet>
        </cfRule>
      </conditionalFormatting>
    `);}
return joinXmlNodes(conditionalFormats);}
function commonCfAttributes(cf){return[["priority",1],["stopIfTrue",cf.stopIfTrue?1:0],];}
function getIconSet(iconSet){return XLSX_ICONSET_MAP[Object.keys(XLSX_ICONSET_MAP).find((key)=>iconSet.upper.toLowerCase().startsWith(key))||"dots"];}
function thresholdAttributes(threshold,position){const type=getExcelThresholdType(threshold.type,position);const attrs=[["type",type]];if(type!=="min"&&type!=="max"){let val=threshold.value;if(type==="formula"){try{val=adaptFormulaToExcel(threshold.value);}
catch(error){val=threshold.value;}}
attrs.push(["val",val]);}
return attrs;}
function getExcelThresholdType(type,position){switch(type){case"value":return position==="minimum"?"min":"max";case"number":return"num";case"percentage":return"percent";default:return type;}}
function createDrawing(drawingRelIds,sheet,figures){const namespaces=[["xmlns:xdr",NAMESPACE.drawing],["xmlns:r",RELATIONSHIP_NSR],["xmlns:a",DRAWING_NS_A],["xmlns:c",DRAWING_NS_C],];const figuresNodes=[];for(const[figureIndex,figure]of Object.entries(figures)){switch(figure?.tag){case"chart":figuresNodes.push(createChartDrawing(figure,sheet,drawingRelIds[figureIndex]));break;case"image":figuresNodes.push(createImageDrawing(figure,sheet,drawingRelIds[figureIndex]));break;}}
const xml=escapeXml`
    <xdr:wsDr ${formatAttributes(namespaces)}>
      ${joinXmlNodes(figuresNodes)}
    </xdr:wsDr>
  `;return parseXML(xml);}
function convertFigureData(figure,sheet){const{x,y,height,width}=figure;const cols=Object.values(sheet.cols);const rows=Object.values(sheet.rows);const{index:colFrom,offset:offsetColFrom}=figureCoordinates(cols,x);const{index:colTo,offset:offsetColTo}=figureCoordinates(cols,x+width);const{index:rowFrom,offset:offsetRowFrom}=figureCoordinates(rows,y);const{index:rowTo,offset:offsetRowTo}=figureCoordinates(rows,y+height);return{from:{col:colFrom,colOff:offsetColFrom,row:rowFrom,rowOff:offsetRowFrom,},to:{col:colTo,colOff:offsetColTo,row:rowTo,rowOff:offsetRowTo,},};}
function figureCoordinates(headers,position){let currentPosition=0;for(const[headerIndex,header]of headers.entries()){if(currentPosition<=position&&position<currentPosition+header.size){return{index:headerIndex,offset:convertDotValueToEMU(position-currentPosition+FIGURE_BORDER_WIDTH),};}
else if(headerIndex<headers.length-1){currentPosition+=header.size;}}
return{index:headers.length-1,offset:convertDotValueToEMU(position-currentPosition+FIGURE_BORDER_WIDTH),};}
function createChartDrawing(figure,sheet,chartRelId){const{from,to}=convertFigureData(figure,sheet);const chartId=convertChartId(figure.id);const cNvPrAttrs=[["id",chartId],["name",`Chart ${chartId}`],["title","Chart"],];return escapeXml`
    <xdr:twoCellAnchor>
      <xdr:from>
        <xdr:col>${from.col}</xdr:col>
        <xdr:colOff>${from.colOff}</xdr:colOff>
        <xdr:row>${from.row}</xdr:row>
        <xdr:rowOff>${from.rowOff}</xdr:rowOff>
      </xdr:from>
      <xdr:to>
        <xdr:col>${to.col}</xdr:col>
        <xdr:colOff>${to.colOff}</xdr:colOff>
        <xdr:row>${to.row}</xdr:row>
        <xdr:rowOff>${to.rowOff}</xdr:rowOff>
      </xdr:to>
      <xdr:graphicFrame>
        <xdr:nvGraphicFramePr>
          <xdr:cNvPr ${formatAttributes(cNvPrAttrs)} />
          <xdr:cNvGraphicFramePr />
        </xdr:nvGraphicFramePr>
        <xdr:xfrm>
          <a:off x="0" y="0"/>
          <a:ext cx="0" cy="0"/>
        </xdr:xfrm>
        <a:graphic>
          <a:graphicData uri="${DRAWING_NS_C}">
            <c:chart r:id="${chartRelId}" />
          </a:graphicData>
        </a:graphic>
      </xdr:graphicFrame>
      <xdr:clientData fLocksWithSheet="0"/>
    </xdr:twoCellAnchor>
  `;}
function createImageDrawing(figure,sheet,imageRelId){const{from,to}=convertFigureData(figure,sheet);const imageId=convertImageId(figure.id);const cNvPrAttrs=[["id",imageId],["name",`Image ${imageId}`],["title","Image"],];const cx=convertDotValueToEMU(figure.width);const cy=convertDotValueToEMU(figure.height);return escapeXml`
    <xdr:twoCellAnchor editAs="oneCell">
      <xdr:from>
        <xdr:col>${from.col}</xdr:col>
        <xdr:colOff>${from.colOff}</xdr:colOff>
        <xdr:row>${from.row}</xdr:row>
        <xdr:rowOff>${from.rowOff}</xdr:rowOff>
      </xdr:from>
      <xdr:to>
        <xdr:col>${to.col}</xdr:col>
        <xdr:colOff>${to.colOff}</xdr:colOff>
        <xdr:row>${to.row}</xdr:row>
        <xdr:rowOff>${to.rowOff}</xdr:rowOff>
      </xdr:to>
      <xdr:pic>
        <xdr:nvPicPr>
          <xdr:cNvPr ${formatAttributes(cNvPrAttrs)}/>
          <xdr:cNvPicPr preferRelativeResize="0"/>
        </xdr:nvPicPr>
        <xdr:blipFill>
          <a:blip cstate="print" r:embed="${imageRelId}"/>
          <a:stretch>
            <a:fillRect/>
          </a:stretch>
        </xdr:blipFill>
        <xdr:spPr>
          <a:xfrm>
            <a:ext cx="${cx}" cy="${cy}" />
          </a:xfrm>
          <a:prstGeom prst="rect">
            <a:avLst/>
          </a:prstGeom>
          <a:noFill/>
        </xdr:spPr>
      </xdr:pic>
      <xdr:clientData fLocksWithSheet="0"/>
    </xdr:twoCellAnchor>
  `;}
function addNumberFormats(numFmts){const numFmtNodes=[];for(let[index,numFmt]of Object.entries(numFmts)){const numFmtAttrs=[["numFmtId",parseInt(index)+FIRST_NUMFMT_ID],["formatCode",numFmt.format],];numFmtNodes.push(escapeXml`
      <numFmt ${formatAttributes(numFmtAttrs)}/>
    `);}
return escapeXml`
    <numFmts count="${numFmts.length}">
      ${joinXmlNodes(numFmtNodes)}
    </numFmts>
  `;}
function addFont(font){if(isObjectEmptyRecursive(font)){return escapeXml``;}
return escapeXml`
    <font>
      ${font.bold ? escapeXml /*xml*/ `<b/>` : ""}
      ${font.italic ? escapeXml /*xml*/ `<i/>` : ""}
      ${font.underline ? escapeXml /*xml*/ `<u/>` : ""}
      ${font.strike ? escapeXml /*xml*/ `<strike/>` : ""}
      ${font.size ? escapeXml /*xml*/ `<sz val="${font.size}"/>` : ""}
      ${font.color && font.color.rgb
        ? escapeXml /*xml*/ `<color rgb="${toXlsxHexColor(font.color.rgb)}"/>`
        : ""}
      ${font.name ? escapeXml /*xml*/ `<name val="${font.name}"/>` : ""}
    </font>
  `;}
function addFonts(fonts){return escapeXml`
    <fonts count="${fonts.length}">
      ${joinXmlNodes(Object.values(fonts).map(addFont))}
    </fonts>
  `;}
function addFills(fills){const fillNodes=[];for(let fill of Object.values(fills)){if(fill.reservedAttribute!==undefined){fillNodes.push(escapeXml`
        <fill>
          <patternFill patternType="${fill.reservedAttribute}" />
        </fill>
      `);}
else{fillNodes.push(escapeXml`
        <fill>
          <patternFill patternType="solid">
            <fgColor rgb="${toXlsxHexColor(fill.fgColor.rgb)}" />
            <bgColor indexed="64" />
          </patternFill>
        </fill>
      `);}}
return escapeXml`
    <fills count="${fills.length}">
    ${joinXmlNodes(fillNodes)}
    </fills>
  `;}
function addBorders(borders){const borderNodes=[];for(let border of Object.values(borders)){borderNodes.push(escapeXml`
      <border>
        <left ${formatBorderAttribute(border["left"])}>
          ${addBorderColor(border["left"])}
        </left>
        <right ${formatBorderAttribute(border["right"])}>
          ${addBorderColor(border["right"])}
        </right>
        <top ${formatBorderAttribute(border["top"])}>
          ${addBorderColor(border["top"])}
        </top>
        <bottom ${formatBorderAttribute(border["bottom"])}>
          ${addBorderColor(border["bottom"])}
        </bottom>
        <diagonal ${formatBorderAttribute(border["diagonal"])}>
          ${addBorderColor(border["diagonal"])}
        </diagonal>
      </border>
    `);}
return escapeXml`
    <borders count="${borders.length}">
      ${joinXmlNodes(borderNodes)}
    </borders>
  `;}
function formatBorderAttribute(description){if(!description){return escapeXml``;}
return formatAttributes([["style",description.style]]);}
function addBorderColor(description){if(!description){return escapeXml``;}
return escapeXml`
    <color ${formatAttributes([["rgb", toXlsxHexColor(description.color.rgb)]])}/>
  `;}
function addStyles(styles){const styleNodes=[];for(let style of styles){const attributes=[["numFmtId",style.numFmtId],["fillId",style.fillId],["fontId",style.fontId],["borderId",style.borderId],];const alignAttrs=[];if(style.alignment&&style.alignment.vertical){alignAttrs.push(["vertical",style.alignment.vertical]);}
if(style.alignment&&style.alignment.horizontal){alignAttrs.push(["horizontal",style.alignment.horizontal]);}
if(style.alignment&&style.alignment.wrapText){alignAttrs.push(["wrapText","1"]);}
if(alignAttrs.length>0){attributes.push(["applyAlignment","1"]);styleNodes.push(escapeXml`<xf ${formatAttributes(attributes)}>${escapeXml /*xml*/ `<alignment ${formatAttributes(alignAttrs)}/>`}</xf>`);
            }
            else {
                styleNodes.push(escapeXml /*xml*/ `<xf ${formatAttributes(attributes)}/>`);
            }
        }
        return escapeXml /*xml*/ `<cellXfs count="${styles.length}">${joinXmlNodes(styleNodes)}</cellXfs>`;
    }
    /**
     * DXFS : Differential Formatting Records - Conditional formats
     */
    function addCellWiseConditionalFormatting(dxfs // cell-wise CF
    ) {
        const dxfNodes = [];
        for (const dxf of dxfs) {
            let fontNode = escapeXml ``;
            if (dxf.font) {
                fontNode = addFont(dxf.font);
            }
            let fillNode = escapeXml ``;
            if (dxf.fill) {
                fillNode = escapeXml /*xml*/ `<fill><patternFill><bgColor rgb="${toXlsxHexColor(dxf.fill.fgColor.rgb)}"/></patternFill></fill>`;
            }
            dxfNodes.push(escapeXml /*xml*/ `<dxf>${fontNode}
${fillNode}</dxf>`);
        }
        return escapeXml /*xml*/ `<dxfs count="${dxfs.length}">${joinXmlNodes(dxfNodes)}</dxfs>`;
    }

    const TABLE_DEFAULT_ATTRS = [
        ["name", "TableStyleLight8"],
        ["showFirstColumn", "0"],
        ["showLastColumn", "0"],
        ["showRowStripes", "0"],
        ["showColumnStripes", "0"],
    ];
    const TABLE_DEFAULT_STYLE = escapeXml /*xml*/ `<tableStyleInfo ${formatAttributes(TABLE_DEFAULT_ATTRS)}/>`;
    function createTable(table, tableId, sheetData) {
        const tableAttributes = [
            ["id", tableId],
            ["name", `Table${tableId}`],
            ["displayName", `Table${tableId}`],
            ["ref", table.range],
            ["xmlns", NAMESPACE.table],
            ["xmlns:xr", NAMESPACE.revision],
            ["xmlns:xr3", NAMESPACE.revision3],
            ["xmlns:mc", NAMESPACE.markupCompatibility],
        ];
        const xml = escapeXml /*xml*/ `<table ${formatAttributes(tableAttributes)}>${addAutoFilter(table)}
${addTableColumns(table,sheetData)}
${TABLE_DEFAULT_STYLE}</table>`;
        return parseXML(xml);
    }
    function addAutoFilter(table) {
        const autoFilterAttributes = [["ref", table.range]];
        return escapeXml /*xml*/ `<autoFilter ${formatAttributes(autoFilterAttributes)}>${joinXmlNodes(addFilterColumns(table))}</autoFilter>`;
    }
    function addFilterColumns(table) {
        const columns = [];
        for (const filter of table.filters) {
            const colXml = escapeXml /*xml*/ `<filterColumn ${formatAttributes([["colId",filter.colId]])}>${addFilter(filter)}</filterColumn>`;
            columns.push(colXml);
        }
        return columns;
    }
    function addFilter(filter) {
        const filterValues = filter.displayedValues.map((val) => escapeXml /*xml*/ `<filter ${formatAttributes([["val",val]])}/>`);
        const filterAttributes = filter.displayBlanks ? [["blank", 1]] : [];
        return escapeXml /*xml*/ `<filters ${formatAttributes(filterAttributes)}>${joinXmlNodes(filterValues)}</filters>`;
    }
    function addTableColumns(table, sheetData) {
        const tableZone = toZone(table.range);
        const columns = [];
        for (const i of range(0, zoneToDimension(tableZone).numberOfCols)) {
            const colHeaderXc = toXC(tableZone.left + i, tableZone.top);
            const colName = sheetData.cells[colHeaderXc]?.content || `col${i}`;
            const colAttributes = [
                ["id", i + 1],
                ["name", colName],
            ];
            columns.push(escapeXml /*xml*/ `<tableColumn ${formatAttributes(colAttributes)}/>`);
        }
        return escapeXml /*xml*/ `<tableColumns ${formatAttributes([["count",columns.length]])}>${joinXmlNodes(columns)}</tableColumns>`;
    }

    function addColumns(cols) {
        if (!Object.values(cols).length) {
            return escapeXml ``;
        }
        const colNodes = [];
        for (let [id, col] of Object.entries(cols)) {
            // Always force our own col width
            const attributes = [
                ["min", parseInt(id) + 1],
                ["max", parseInt(id) + 1],
                ["width", convertWidthToExcel(col.size || DEFAULT_CELL_WIDTH)],
                ["customWidth", 1],
                ["hidden", col.isHidden ? 1 : 0],
            ];
            colNodes.push(escapeXml /*xml*/ `<col ${formatAttributes(attributes)}/>`);
        }
        return escapeXml /*xml*/ `<cols>${joinXmlNodes(colNodes)}</cols>`;
    }
    function addRows(construct, data, sheet) {
        const rowNodes = [];
        for (let r = 0; r < sheet.rowNumber; r++) {
            const rowAttrs = [["r", r + 1]];
            const row = sheet.rows[r] || {};
            // Always force our own row height
            rowAttrs.push(["ht", convertHeightToExcel(row.size || DEFAULT_CELL_HEIGHT)], ["customHeight", 1], ["hidden", row.isHidden ? 1 : 0]);
            const cellNodes = [];
            for (let c = 0; c < sheet.colNumber; c++) {
                const xc = toXC(c, r);
                const cell = sheet.cells[xc];
                if (cell) {
                    const attributes = [["r", xc]];
                    // style
                    const id = normalizeStyle(construct, extractStyle(cell, data));
                    attributes.push(["s", id]);
                    let additionalAttrs = [];
                    let cellNode = escapeXml ``;
                    // Either formula or static value inside the cell
                    if (cell.isFormula) {
                        ({ attrs: additionalAttrs, node: cellNode } = addFormula(cell));
                    }
                    else if (cell.content && isMarkdownLink(cell.content)) {
                        const { label } = parseMarkdownLink(cell.content);
                        ({ attrs: additionalAttrs, node: cellNode } = addContent(label, construct.sharedStrings));
                    }
                    else if (cell.content && cell.content !== "") {
                        const isTableHeader = isCellTableHeader(c, r, sheet);
                        ({ attrs: additionalAttrs, node: cellNode } = addContent(cell.content, construct.sharedStrings, isTableHeader));
                    }
                    attributes.push(...additionalAttrs);
                    // prettier-ignore
                    cellNodes.push(escapeXml /*xml*/ `<c ${formatAttributes(attributes)}>${cellNode}</c>`);
                }
            }
            if (cellNodes.length || row.size !== DEFAULT_CELL_HEIGHT || row.isHidden) {
                rowNodes.push(escapeXml /*xml*/ `<row ${formatAttributes(rowAttrs)}>${joinXmlNodes(cellNodes)}</row>`);
            }
        }
        return escapeXml /*xml*/ `<sheetData>${joinXmlNodes(rowNodes)}</sheetData>`;
    }
    function isCellTableHeader(col, row, sheet) {
        return sheet.filterTables.some((table) => {
            const zone = toZone(table.range);
            const headerZone = { ...zone, bottom: zone.top };
            return isInside(col, row, headerZone);
        });
    }
    function addHyperlinks(construct, data, sheetIndex) {
        const sheet = data.sheets[sheetIndex];
        const cells = sheet.cells;
        const linkNodes = [];
        for (const xc in cells) {
            const content = cells[xc]?.content;
            if (content && isMarkdownLink(content)) {
                const { label, url } = parseMarkdownLink(content);
                if (isSheetUrl(url)) {
                    const sheetId = parseSheetUrl(url);
                    const sheet = data.sheets.find((sheet) => sheet.id === sheetId);
                    const location = sheet ? `${sheet.name}!A1` : INCORRECT_RANGE_STRING;
                    const hyperlinkAttributes = [
                        ["display", label],
                        ["location", location],
                        ["ref", xc],
                    ];
                    linkNodes.push(escapeXml /*xml*/ `<hyperlink ${formatAttributes(hyperlinkAttributes)}/>`);
                }
                else {
                    const linkRelId = addRelsToFile(construct.relsFiles, `xl/worksheets/_rels/sheet${sheetIndex}.xml.rels`, {
                        target: withHttps(url),
                        type: XLSX_RELATION_TYPE.hyperlink,
                        targetMode: "External",
                    });
                    const hyperlinkAttributes = [
                        ["r:id", linkRelId],
                        ["ref", xc],
                    ];
                    linkNodes.push(escapeXml /*xml*/ `<hyperlink ${formatAttributes(hyperlinkAttributes)}/>`);
                }
            }
        }
        if (!linkNodes.length) {
            return escapeXml ``;
        }
        return escapeXml /*xml*/ `<hyperlinks>${joinXmlNodes(linkNodes)}</hyperlinks>`;
    }
    function addMerges(merges) {
        if (merges.length) {
            const mergeNodes = merges.map((merge) => escapeXml /*xml*/ `<mergeCell ref="${merge}"/>`);
            return escapeXml /*xml*/ `<mergeCells count="${merges.length}">${joinXmlNodes(mergeNodes)}</mergeCells>`;
        }
        else
            return escapeXml ``;
    }
    function addSheetViews(sheet) {
        const panes = sheet.panes;
        let splitPanes = escapeXml /*xml*/ ``;
        if (panes && (panes.xSplit || panes.ySplit)) {
            const xc = toXC(panes.xSplit, panes.ySplit);
            //workbookViewId should be defined in the workbook file but it seems like Excel has a default behaviour.
            const xSplit = panes.xSplit ? escapeXml `xSplit="${panes.xSplit}"` : "";
            const ySplit = panes.ySplit ? escapeXml `ySplit="${panes.ySplit}"` : "";
            const topRight = panes.xSplit ? escapeXml `<selection pane="topRight"/>` : "";
            const bottomLeft = panes.ySplit ? escapeXml `<selection pane="bottomLeft"/>` : "";
            const bottomRight = panes.xSplit && panes.ySplit ? escapeXml `<selection pane="bottomRight"/>` : "";
            splitPanes = escapeXml /*xml*/ `<pane
${xSplit}
${ySplit}
topLeftCell="${xc}"
activePane="${panes.xSplit ? (panes.ySplit ? "bottomRight" : "topRight") : "bottomLeft"}"
state="frozen"/>${topRight}
${bottomLeft}
${bottomRight}`;
        }
        const sheetViewAttrs = [
            ["showGridLines", sheet.areGridLinesVisible ? 1 : 0],
            ["workbookViewId", 0],
        ];
        let sheetView = escapeXml /*xml*/ `<sheetViews><sheetView ${formatAttributes(sheetViewAttrs)}>${splitPanes}</sheetView></sheetViews>`;
        return sheetView;
    }

    /**
     * Return the spreadsheet data in the Office Open XML file format.
     * See ECMA-376 standard.
     * https://www.ecma-international.org/publications-and-standards/standards/ecma-376/
     */
    function getXLSX(data) {
        const files = [];
        const construct = getDefaultXLSXStructure(data);
        files.push(createWorkbook(data, construct));
        files.push(...createWorksheets(data, construct));
        files.push(createStylesSheet(construct));
        files.push(createSharedStrings(construct.sharedStrings));
        files.push(...createRelsFiles(construct.relsFiles));
        files.push(createContentTypes(files));
        files.push(createRelRoot());
        return {
            name: `my_spreadsheet.xlsx`,
            files,
        };
    }
    function createWorkbook(data, construct) {
        const namespaces = [
            ["xmlns", NAMESPACE["workbook"]],
            ["xmlns:r", RELATIONSHIP_NSR],
        ];
        const sheetNodes = [];
        for (const [index, sheet] of Object.entries(data.sheets)) {
            const attributes = [
                ["state", sheet.isVisible ? "visible" : "hidden"],
                ["name", sheet.name],
                ["sheetId", parseInt(index) + 1],
                ["r:id", `rId${parseInt(index)+1}`],
            ];
            sheetNodes.push(escapeXml /*xml*/ `<sheet ${formatAttributes(attributes)}/>`);
            addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
                type: XLSX_RELATION_TYPE.sheet,
                target: `worksheets/sheet${index}.xml`,
            });
        }
        const xml = escapeXml /*xml*/ `<workbook ${formatAttributes(namespaces)}><sheets>${joinXmlNodes(sheetNodes)}</sheets></workbook>`;
        return createXMLFile(parseXML(xml), "xl/workbook.xml", "workbook");
    }
    function createWorksheets(data, construct) {
        const files = [];
        let currentTableIndex = 1;
        for (const [sheetIndex, sheet] of Object.entries(data.sheets)) {
            const namespaces = [
                ["xmlns", NAMESPACE["worksheet"]],
                ["xmlns:r", RELATIONSHIP_NSR],
            ];
            const sheetFormatAttributes = [
                ["defaultRowHeight", convertHeightToExcel(DEFAULT_CELL_HEIGHT)],
                ["defaultColWidth", convertWidthToExcel(DEFAULT_CELL_WIDTH)],
            ];
            const tablesNode = createTablesForSheet(sheet, sheetIndex, currentTableIndex, construct, files);
            currentTableIndex += sheet.filterTables.length;
            // Figures and Charts
            let drawingNode = escapeXml ``;
            const drawingRelIds = [];
            for (const chart of sheet.charts) {
                const xlsxChartId = convertChartId(chart.id);
                const chartRelId = addRelsToFile(construct.relsFiles, `xl/drawings/_rels/drawing${sheetIndex}.xml.rels`, {
                    target: `../charts/chart${xlsxChartId}.xml`,
                    type: XLSX_RELATION_TYPE.chart,
                });
                drawingRelIds.push(chartRelId);
                files.push(createXMLFile(createChart(chart, sheetIndex, data), `xl/charts/chart${xlsxChartId}.xml`, "chart"));
            }
            for (const image of sheet.images) {
                const mimeType = image.data.mimetype;
                if (mimeType === undefined)
                    continue;
                const extension = IMAGE_MIMETYPE_TO_EXTENSION_MAPPING[mimeType];
                // only support exporting images with mimetypes specified in the mapping
                if (extension === undefined)
                    continue;
                const xlsxImageId = convertImageId(image.id);
                let imageFileName = `image${xlsxImageId}.${extension}`;
                const imageRelId = addRelsToFile(construct.relsFiles, `xl/drawings/_rels/drawing${sheetIndex}.xml.rels`, {
                    target: `../media/${imageFileName}`,
                    type: XLSX_RELATION_TYPE.image,
                });
                drawingRelIds.push(imageRelId);
                files.push({
                    path: `xl/media/${imageFileName}`,
                    imageSrc: image.data.path,
                });
            }
            const drawings = [...sheet.charts, ...sheet.images];
            if (drawings.length) {
                const drawingRelId = addRelsToFile(construct.relsFiles, `xl/worksheets/_rels/sheet${sheetIndex}.xml.rels`, {
                    target: `../drawings/drawing${sheetIndex}.xml`,
                    type: XLSX_RELATION_TYPE.drawing,
                });
                files.push(createXMLFile(createDrawing(drawingRelIds, sheet, drawings), `xl/drawings/drawing${sheetIndex}.xml`, "drawing"));
                drawingNode = escapeXml /*xml*/ `<drawing r:id="${drawingRelId}"/>`;
            }
            const sheetXml = escapeXml /*xml*/ `<worksheet ${formatAttributes(namespaces)}>${addSheetViews(sheet)}<sheetFormatPr ${formatAttributes(sheetFormatAttributes)}/>${addColumns(sheet.cols)}
${addRows(construct,data,sheet)}
${addMerges(sheet.merges)}
${joinXmlNodes(addConditionalFormatting(construct.dxfs,sheet.conditionalFormats))}
${addHyperlinks(construct,data,sheetIndex)}
${drawingNode}
${tablesNode}</worksheet>`;
            files.push(createXMLFile(parseXML(sheetXml), `xl/worksheets/sheet${sheetIndex}.xml`, "sheet"));
        }
        addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
            type: XLSX_RELATION_TYPE.sharedStrings,
            target: "sharedStrings.xml",
        });
        addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
            type: XLSX_RELATION_TYPE.styles,
            target: "styles.xml",
        });
        return files;
    }
    /**
     * Create xlsx files for each tables contained in the given sheet, and add them to the XLSXStructure ans XLSXExportFiles.
     *
     * Return an XML string that should be added in the sheet to link these table to the sheet.
     */
    function createTablesForSheet(sheetData, sheetId, startingTableId, construct, files) {
        let currentTableId = startingTableId;
        if (!sheetData.filterTables.length)
            return new XMLString("");
        const sheetRelFile = `xl/worksheets/_rels/sheet${sheetId}.xml.rels`;
        const tableParts = [];
        for (const table of sheetData.filterTables) {
            const tableRelId = addRelsToFile(construct.relsFiles, sheetRelFile, {
                target: `../tables/table${currentTableId}.xml`,
                type: XLSX_RELATION_TYPE.table,
            });
            files.push(createXMLFile(createTable(table, currentTableId, sheetData), `xl/tables/table${currentTableId}.xml`, "table"));
            tableParts.push(escapeXml /*xml*/ `<tablePart r:id="${tableRelId}"/>`);
            currentTableId++;
        }
        return escapeXml /*xml*/ `<tableParts count="${sheetData.filterTables.length}">${joinXmlNodes(tableParts)}</tableParts>`;
    }
    function createStylesSheet(construct) {
        const namespaces = [
            ["xmlns", NAMESPACE["styleSheet"]],
            ["xmlns:r", RELATIONSHIP_NSR],
        ];
        const styleXml = escapeXml /*xml*/ `<styleSheet ${formatAttributes(namespaces)}>${addNumberFormats(construct.numFmts)}
${addFonts(construct.fonts)}
${addFills(construct.fills)}
${addBorders(construct.borders)}
${addStyles(construct.styles)}
${addCellWiseConditionalFormatting(construct.dxfs)}</styleSheet>`;
        return createXMLFile(parseXML(styleXml), "xl/styles.xml", "styles");
    }
    function createSharedStrings(strings) {
        const namespaces = [
            ["xmlns", NAMESPACE["sst"]],
            ["count", strings.length],
            ["uniqueCount", strings.length],
        ];
        const stringNodes = strings.map((string) => escapeXml /*xml*/ `<si><t>${string}</t></si>`);
        const xml = escapeXml /*xml*/ `<sst ${formatAttributes(namespaces)}>${joinXmlNodes(stringNodes)}</sst>`;
        return createXMLFile(parseXML(xml), "xl/sharedStrings.xml", "sharedStrings");
    }
    function createRelsFiles(relsFiles) {
        const XMLRelsFiles = [];
        for (const relFile of relsFiles) {
            const relationNodes = [];
            for (const rel of relFile.rels) {
                const attributes = [
                    ["Id", rel.id],
                    ["Target", rel.target],
                    ["Type", rel.type],
                ];
                if (rel.targetMode) {
                    attributes.push(["TargetMode", rel.targetMode]);
                }
                relationNodes.push(escapeXml /*xml*/ `<Relationship ${formatAttributes(attributes)}/>`);
            }
            const xml = escapeXml /*xml*/ `<Relationships xmlns="${NAMESPACE["Relationships"]}">${joinXmlNodes(relationNodes)}</Relationships>`;
            XMLRelsFiles.push(createXMLFile(parseXML(xml), relFile.path));
        }
        return XMLRelsFiles;
    }
    function createContentTypes(files) {
        const overrideNodes = [];
        // hard-code supported image mimetypes
        const imageDefaultNodes = Object.entries(IMAGE_MIMETYPE_TO_EXTENSION_MAPPING).map(([mimetype, extension]) => createDefaultXMLElement(extension, mimetype));
        for (const file of files) {
            if ("contentType" in file && file.contentType) {
                overrideNodes.push(createOverride("/" + file.path, CONTENT_TYPES[file.contentType]));
            }
        }
        const relsAttributes = [
            ["Extension", "rels"],
            ["ContentType", "application/vnd.openxmlformats-package.relationships+xml"],
        ];
        const xmlAttributes = [
            ["Extension", "xml"],
            ["ContentType", "application/xml"],
        ];
        const xml = escapeXml /*xml*/ `<Types xmlns="${NAMESPACE["Types"]}">${joinXmlNodes(Object.values(imageDefaultNodes))}<Default ${formatAttributes(relsAttributes)}/><Default ${formatAttributes(xmlAttributes)}/>${joinXmlNodes(overrideNodes)}</Types>`;
        return createXMLFile(parseXML(xml), "[Content_Types].xml");
    }
    function createRelRoot() {
        const attributes = [
            ["Id", "rId1"],
            ["Type", XLSX_RELATION_TYPE.document],
            ["Target", "xl/workbook.xml"],
        ];
        const xml = escapeXml /*xml*/ `<Relationships xmlns="${NAMESPACE["Relationships"]}"><Relationship ${formatAttributes(attributes)}/></Relationships>`;
        return createXMLFile(parseXML(xml), "_rels/.rels");
    }

    var Status;
    (function (Status) {
        Status[Status["Ready"] = 0] = "Ready";
        Status[Status["Running"] = 1] = "Running";
        Status[Status["RunningCore"] = 2] = "RunningCore";
        Status[Status["Finalizing"] = 3] = "Finalizing";
    })(Status || (Status = {}));
    class Model extends EventBus {
        corePlugins = [];
        featurePlugins = [];
        statefulUIPlugins = [];
        coreViewsPlugins = [];
        range;
        session;
        /**
         * In a collaborative context, some commands can be replayed, we have to ensure
         * that these commands are not replayed on the UI plugins.
         */
        isReplayingCommand = false;
        /**
         * A plugin can draw some contents on the canvas. But even better: it can do
         * so multiple times.  The order of the render calls will determine a list of
         * "layers" (i.e., earlier calls will be obviously drawn below later calls).
         * This list simply keeps the renderers+layer information so the drawing code
         * can just iterate on it
         */
        renderers = [];
        /**
         * Internal status of the model. Important for command handling coordination
         */
        status = 0 /* Status.Ready */;
        /**
         * The config object contains some configuration flag and callbacks
         */
        config;
        corePluginConfig;
        uiPluginConfig;
        state;
        selection;
        /**
         * Getters are the main way the rest of the UI read data from the model. Also,
         * it is shared between all plugins, so they can also communicate with each
         * other.
         */
        getters;
        /**
         * Getters that are accessible from the core plugins. It's a subset of `getters`,
         * without the UI getters
         */
        coreGetters;
        uuidGenerator;
        handlers = [];
        uiHandlers = [];
        coreHandlers = [];
        constructor(data = {}, config = {}, stateUpdateMessages = [], uuidGenerator = new UuidGenerator(), verboseImport = true) {
            super();
            stateUpdateMessages = repairInitialMessages(data, stateUpdateMessages);
            const workbookData = load(data, verboseImport);
            this.state = new StateObserver();
            this.uuidGenerator = uuidGenerator;
            this.config = this.setupConfig(config);
            this.session = this.setupSession(workbookData.revisionId);
            this.coreGetters = {};
            this.range = new RangeAdapter(this.coreGetters);
            this.coreGetters.getRangeString = this.range.getRangeString.bind(this.range);
            this.coreGetters.getRangeFromSheetXC = this.range.getRangeFromSheetXC.bind(this.range);
            this.coreGetters.createAdaptedRanges = this.range.createAdaptedRanges.bind(this.range);
            this.coreGetters.getRangeDataFromXc = this.range.getRangeDataFromXc.bind(this.range);
            this.coreGetters.getRangeDataFromZone = this.range.getRangeDataFromZone.bind(this.range);
            this.coreGetters.getRangeFromRangeData = this.range.getRangeFromRangeData.bind(this.range);
            this.coreGetters.getRangeFromZone = this.range.getRangeFromZone.bind(this.range);
            this.getters = {
                isReadonly: () => this.config.mode === "readonly" || this.config.mode === "dashboard",
                isDashboard: () => this.config.mode === "dashboard",
            };
            this.uuidGenerator.setIsFastStrategy(true);
            // Initiate stream processor
            this.selection = new SelectionStreamProcessorImpl(this.getters);
            this.coreHandlers.push(this.range);
            this.handlers.push(this.range);
            this.corePluginConfig = this.setupCorePluginConfig();
            this.uiPluginConfig = this.setupUiPluginConfig();
            // registering plugins
            for (let Plugin of corePluginRegistry.getAll()) {
                this.setupCorePlugin(Plugin, workbookData);
            }
            Object.assign(this.getters, this.coreGetters);
            this.session.loadInitialMessages(stateUpdateMessages);
            for (let Plugin of coreViewsPluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.coreViewsPlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
                this.coreHandlers.push(plugin);
            }
            for (let Plugin of statefulUIPluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.statefulUIPlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
            }
            for (let Plugin of featurePluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.featurePlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
            }
            this.uuidGenerator.setIsFastStrategy(false);
            // starting plugins
            this.dispatch("START");
            // Model should be the last permanent subscriber in the list since he should render
            // after all changes have been applied to the other subscribers (plugins)
            this.selection.observe(this, {
                handleEvent: () => this.trigger("update"),
            });
            // This should be done after construction of LocalHistory due to order of
            // events
            this.setupSessionEvents();
            this.joinSession();
            if (config.snapshotRequested) {
                this.session.snapshot(this.exportData());
                this.garbageCollectExternalResources();
            }
            // mark all models as "raw", so they will not be turned into reactive objects
            // by owl, since we do not rely on reactivity
            owl.markRaw(this);
        }
        joinSession() {
            this.session.join(this.config.client);
        }
        leaveSession() {
            this.session.leave();
        }
        setupUiPlugin(Plugin) {
            const plugin = new Plugin(this.uiPluginConfig);
            for (let name of Plugin.getters) {
                if (!(name in plugin)) {
                    throw new Error(`Invalid getter name:${name}for plugin ${plugin.constructor}`);
                }
                if (name in this.getters) {
                    throw new Error(`Getter"${name}"is already defined.`);
                }
                this.getters[name] = plugin[name].bind(plugin);
            }
            const layers = Plugin.layers.map((l) => [plugin, l]);
            this.renderers.push(...layers);
            this.renderers.sort((p1, p2) => p1[1] - p2[1]);
            return plugin;
        }
        /**
         * Initialize and properly configure a plugin.
         *
         * This method is private for now, but if the need arise, there is no deep
         * reason why the model could not add dynamically a plugin while it is running.
         */
        setupCorePlugin(Plugin, data) {
            const plugin = new Plugin(this.corePluginConfig);
            for (let name of Plugin.getters) {
                if (!(name in plugin)) {
                    throw new Error(`Invalid getter name:${name}for plugin ${plugin.constructor}`);
                }
                if (name in this.coreGetters) {
                    throw new Error(`Getter"${name}"is already defined.`);
                }
                this.coreGetters[name] = plugin[name].bind(plugin);
            }
            plugin.import(data);
            this.corePlugins.push(plugin);
            this.coreHandlers.push(plugin);
            this.handlers.push(plugin);
        }
        onRemoteRevisionReceived({ commands }) {
            for (let command of commands) {
                const previousStatus = this.status;
                this.status = 2 /* Status.RunningCore */;
                this.dispatchToHandlers(this.statefulUIPlugins, command);
                this.status = previousStatus;
            }
            this.finalize();
        }
        setupSession(revisionId) {
            const session = new Session(buildRevisionLog({
                initialRevisionId: revisionId,
                recordChanges: this.state.recordChanges.bind(this.state),
                dispatch: (command) => {
                    const result = this.checkDispatchAllowed(command);
                    if (!result.isSuccessful) {
                        return;
                    }
                    this.isReplayingCommand = true;
                    this.dispatchToHandlers(this.coreHandlers, command);
                    this.isReplayingCommand = false;
                },
            }), this.config.transportService, revisionId);
            return session;
        }
        setupSessionEvents() {
            this.session.on("remote-revision-received", this, this.onRemoteRevisionReceived);
            this.session.on("revision-undone", this, ({ commands }) => {
                this.dispatchFromCorePlugin("UNDO", { commands });
                this.finalize();
            });
            this.session.on("revision-redone", this, ({ commands }) => {
                this.dispatchFromCorePlugin("REDO", { commands });
                this.finalize();
            });
            // How could we improve communication between the session and UI?
            // It feels weird to have the model piping specific session events to its own bus.
            this.session.on("unexpected-revision-id", this, () => this.trigger("unexpected-revision-id"));
            this.session.on("collaborative-event-received", this, () => {
                this.trigger("update");
            });
        }
        setupConfig(config) {
            const client = config.client || {
                id: this.uuidGenerator.uuidv4(),
                name: _t("Anonymous").toString(),
            };
            const transportService = config.transportService || new LocalTransportService();
            return {
                ...config,
                mode: config.mode || "normal",
                custom: config.custom || {},
                external: this.setupExternalConfig(config.external || {}),
                transportService,
                client,
                moveClient: () => { },
                snapshotRequested: false,
                notifyUI: (payload) => this.trigger("notify-ui", payload),
                raiseBlockingErrorUI: (text) => this.trigger("raise-error-ui", { text }),
            };
        }
        setupExternalConfig(external) {
            const loadLocales = external.loadLocales || (() => Promise.resolve(DEFAULT_LOCALES));
            return {
                ...external,
                loadLocales,
            };
        }
        setupCorePluginConfig() {
            return {
                getters: this.coreGetters,
                stateObserver: this.state,
                range: this.range,
                dispatch: this.dispatchFromCorePlugin,
                uuidGenerator: this.uuidGenerator,
                custom: this.config.custom,
                external: this.config.external,
            };
        }
        setupUiPluginConfig() {
            return {
                getters: this.getters,
                stateObserver: this.state,
                dispatch: this.dispatch,
                selection: this.selection,
                moveClient: this.session.move.bind(this.session),
                custom: this.config.custom,
                uiActions: this.config,
                session: this.session,
                defaultCurrencyFormat: this.config.defaultCurrencyFormat,
            };
        }
        // ---------------------------------------------------------------------------
        // Command Handling
        // ---------------------------------------------------------------------------
        /**
         * Check if the given command is allowed by all the plugins and the history.
         */
        checkDispatchAllowed(command) {
            const results = isCoreCommand(command)
                ? this.checkDispatchAllowedCoreCommand(command)
                : this.checkDispatchAllowedLocalCommand(command);
            if (results.some((r) => r !== "Success" /* CommandResult.Success */)) {
                return new DispatchResult(results.flat());
            }
            return DispatchResult.Success;
        }
        checkDispatchAllowedCoreCommand(command) {
            const results = this.corePlugins.map((handler) => handler.allowDispatch(command));
            results.push(this.range.allowDispatch(command));
            return results;
        }
        checkDispatchAllowedLocalCommand(command) {
            const results = this.uiHandlers.map((handler) => handler.allowDispatch(command));
            return results;
        }
        finalize() {
            this.status = 3 /* Status.Finalizing */;
            for (const h of this.handlers) {
                h.finalize();
            }
            this.status = 0 /* Status.Ready */;
        }
        /**
         * Check if a command can be dispatched, and returns a DispatchResult object with the possible
         * reasons the dispatch failed.
         */
        canDispatch = (type, payload) => {
            return this.checkDispatchAllowed(createCommand(type, payload));
        };
        /**
         * The dispatch method is the only entry point to manipulate data in the model.
         * This is through this method that commands are dispatched most of the time
         * recursively until no plugin want to react anymore.
         *
         * CoreCommands dispatched from this function are saved in the history.
         *
         * Small technical detail: it is defined as an arrow function.  There are two
         * reasons for this:
         * 1. this means that the dispatch method can be "detached" from the model,
         *    which is done when it is put in the environment (see the Spreadsheet
         *    component)
         * 2. This allows us to define its type by using the interface CommandDispatcher
         */
        dispatch = (type, payload) => {
            const command = createCommand(type, payload);
            let status = this.status;
            if (this.getters.isReadonly() && !canExecuteInReadonly(command)) {
                return new DispatchResult("Readonly" /* CommandResult.Readonly */);
            }
            if (!this.session.canApplyOptimisticUpdate()) {
                return new DispatchResult("WaitingSessionConfirmation" /* CommandResult.WaitingSessionConfirmation */);
            }
            switch (status) {
                case 0 /* Status.Ready */:
                    const result = this.checkDispatchAllowed(command);
                    if (!result.isSuccessful) {
                        return result;
                    }
                    this.status = 1 /* Status.Running */;
                    const { changes, commands } = this.state.recordChanges(() => {
                        if (isCoreCommand(command)) {
                            this.state.addCommand(command);
                        }
                        this.dispatchToHandlers(this.handlers, command);
                        this.finalize();
                    });
                    this.session.save(command, commands, changes);
                    this.status = 0 /* Status.Ready */;
                    this.trigger("update");
                    break;
                case 1 /* Status.Running */:
                    if (isCoreCommand(command)) {
                        const dispatchResult = this.checkDispatchAllowed(command);
                        if (!dispatchResult.isSuccessful) {
                            return dispatchResult;
                        }
                        this.state.addCommand(command);
                    }
                    this.dispatchToHandlers(this.handlers, command);
                    break;
                case 3 /* Status.Finalizing */:
                    throw new Error("Cannot dispatch commands in the finalize state");
                case 2 /* Status.RunningCore */:
                    if (isCoreCommand(command)) {
                        throw new Error(`A UI plugin cannot dispatch ${type}while handling a core command`);
                    }
                    this.dispatchToHandlers(this.handlers, command);
            }
            return DispatchResult.Success;
        };
        /**
         * Dispatch a command from a Core Plugin (or the History).
         * A command dispatched from this function is not added to the history.
         */
        dispatchFromCorePlugin = (type, payload) => {
            const command = createCommand(type, payload);
            const previousStatus = this.status;
            this.status = 2 /* Status.RunningCore */;
            const handlers = this.isReplayingCommand ? this.coreHandlers : this.handlers;
            this.dispatchToHandlers(handlers, command);
            this.status = previousStatus;
            return DispatchResult.Success;
        };
        /**
         * Dispatch the given command to the given handlers.
         * It will call `beforeHandle` and `handle`*/dispatchToHandlers(handlers,command){const isCommandCore=isCoreCommand(command);for(const handler of handlers){if(!isCommandCore&&handler instanceof CorePlugin){continue;}
handler.beforeHandle(command);}
for(const handler of handlers){if(!isCommandCore&&handler instanceof CorePlugin){continue;}
handler.handle(command);}}
drawGrid(context){for(let[renderer,layer]of this.renderers){context.ctx.save();renderer.drawGrid(context,layer);context.ctx.restore();}}
exportData(){let data=createEmptyWorkbookData();for(let handler of this.handlers){if(handler instanceof CorePlugin){handler.export(data);}}
data.revisionId=this.session.getRevisionId()||DEFAULT_REVISION_ID;data=deepCopy(data);return data;}
updateMode(mode){if(mode!=="normal"){this.dispatch("CANCEL_EDITION");}
this.config.mode=mode;this.trigger("update");}
exportXLSX(){this.dispatch("EVALUATE_CELLS");let data=createEmptyExcelWorkbookData();for(let handler of this.handlers){if(handler instanceof BasePlugin){handler.exportForExcel(data);}}
data=deepCopy(data);return getXLSX(data);}
garbageCollectExternalResources(){for(const plugin of this.corePlugins){plugin.garbageCollectExternalResources();}}}
function createCommand(type,payload={}){const command=deepCopy(payload);command.type=type;return command;}
const __info__={};const SPREADSHEET_DIMENSIONS={MIN_ROW_HEIGHT,MIN_COL_WIDTH,HEADER_HEIGHT,HEADER_WIDTH,TOPBAR_HEIGHT,BOTTOMBAR_HEIGHT,DEFAULT_CELL_WIDTH,DEFAULT_CELL_HEIGHT,SCROLLBAR_WIDTH,};const registries={autofillModifiersRegistry,autofillRulesRegistry,cellMenuRegistry,colMenuRegistry,linkMenuRegistry,functionRegistry,featurePluginRegistry,statefulUIPluginRegistry,coreViewsPluginRegistry,corePluginRegistry,rowMenuRegistry,sidePanelRegistry,figureRegistry,chartSidePanelComponentRegistry,chartComponentRegistry,chartRegistry,topbarMenuRegistry,topbarComponentRegistry,clickableCellRegistry,otRegistry,inverseCommandRegistry,urlRegistry,cellPopoverRegistry,numberFormatMenuRegistry,repeatLocalCommandTransformRegistry,repeatCommandTransformRegistry,};const helpers={arg,toBoolean,toJsDate,toNumber,toString,toXC,toZone,toUnboundedZone,toCartesian,numberToLetters,lettersToNumber,UuidGenerator,formatValue,createCurrencyFormat,computeTextWidth,createEmptyWorkbookData,createEmptySheet,createEmptyExcelSheet,getDefaultChartJsRuntime,chartFontColor,ChartColors,EvaluationError,CellErrorLevel,getFillingMode,rgbaToHex,colorToRGBA,positionToZone,isDefined:isDefined$1,isMatrix,lazy,genericRepeat,createAction,createActions,transformRangeData,};const links={isMarkdownLink,parseMarkdownLink,markdownLink,openLink,urlRepresentation,};const components={ChartPanel,ChartFigure,ChartJsComponent,Grid,GridOverlay,ScorecardChart,LineConfigPanel,LineBarPieDesignPanel,BarConfigPanel,LineBarPieConfigPanel,GaugeChartConfigPanel,GaugeChartDesignPanel,ScorecardChartConfigPanel,ScorecardChartDesignPanel,FigureComponent,Menu,SelectionInput,};const hooks={useDragAndDropListItems,};function addFunction(functionName,functionDescription){functionRegistry.add(functionName,functionDescription);return{addFunction:(fName,fDescription)=>addFunction(fName,fDescription),};}
const constants={DEFAULT_LOCALE,};exports.AbstractChart=AbstractChart;exports.CorePlugin=CorePlugin;exports.DispatchResult=DispatchResult;exports.EvaluationError=EvaluationError;exports.Model=Model;exports.Registry=Registry;exports.Revision=Revision;exports.SPREADSHEET_DIMENSIONS=SPREADSHEET_DIMENSIONS;exports.Spreadsheet=Spreadsheet;exports.UIPlugin=UIPlugin;exports.__info__=__info__;exports.addFunction=addFunction;exports.astToFormula=astToFormula;exports.compile=compile;exports.compileTokens=compileTokens;exports.components=components;exports.constants=constants;exports.convertAstNodes=convertAstNodes;exports.coreTypes=coreTypes;exports.findCellInNewZone=findCellInNewZone;exports.functionCache=functionCache;exports.helpers=helpers;exports.hooks=hooks;exports.invalidateCFEvaluationCommands=invalidateCFEvaluationCommands;exports.invalidateDependenciesCommands=invalidateDependenciesCommands;exports.invalidateEvaluationCommands=invalidateEvaluationCommands;exports.iterateAstNodes=iterateAstNodes;exports.links=links;exports.load=load;exports.parse=parse;exports.parseTokens=parseTokens;exports.readonlyAllowedCommands=readonlyAllowedCommands;exports.registries=registries;exports.setDefaultSheetViewSize=setDefaultSheetViewSize;exports.setTranslationMethod=setTranslationMethod;exports.tokenize=tokenize;__info__.version="17.0.19";__info__.date="2024-04-18T16:55:21.708Z";__info__.hash="9f3317a18";})(this.o_spreadsheet=this.o_spreadsheet||{},owl);;

/* /spreadsheet/static/src/o_spreadsheet/migration.js */
odoo.define('@spreadsheet/o_spreadsheet/migration',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{load,CorePlugin,tokenize,parse,convertAstNodes,astToFormula}=spreadsheet;const{corePluginRegistry}=spreadsheet.registries;const ODOO_VERSION=__exports.ODOO_VERSION=6;const MAP={PIVOT:"ODOO.PIVOT","PIVOT.HEADER":"ODOO.PIVOT.HEADER","PIVOT.POSITION":"ODOO.PIVOT.POSITION","FILTER.VALUE":"ODOO.FILTER.VALUE",LIST:"ODOO.LIST","LIST.HEADER":"ODOO.LIST.HEADER",};const dmyRegex=/^([0|1|2|3][1-9])\/(0[1-9]|1[0-2])\/(\d{4})$/i;__exports.migrate=migrate;function migrate(data){let _data=load(data,!!odoo.debug);const version=_data.odooVersion||0;if(version<1){_data=migrate0to1(_data);}
if(version<2){_data=migrate1to2(_data);}
if(version<3){_data=migrate2to3(_data);}
if(version<4){_data=migrate3to4(_data);}
if(version<5){_data=migrate4to5(_data);}
if(version<6){_data=migrate5to6(_data);}
return _data;}
function tokensToString(tokens){return tokens.reduce((acc,token)=>acc+token.value,"");}
function migrate0to1(data){for(const sheet of data.sheets){for(const xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){const tokens=tokenize(cell.content);for(const token of tokens){if(token.type==="SYMBOL"&&token.value.toUpperCase()in MAP){token.value=MAP[token.value.toUpperCase()];}}
cell.content=tokensToString(tokens);}}}
return data;}
function migrate1to2(data){for(const sheet of data.sheets){for(const xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){try{cell.content=migratePivotDaysParameters(cell.content);}catch{continue;}}}}
return data;}
function migrate2to3(data){if(data.globalFilters){for(const gf of data.globalFilters){if(gf.fields){gf.pivotFields=gf.fields;delete gf.fields;}
if(gf.type==="date"&&typeof gf.defaultValue==="object"&&"year"in gf.defaultValue){switch(gf.defaultValue.year){case"last_year":gf.defaultValue.yearOffset=-1;break;case"antepenultimate_year":gf.defaultValue.yearOffset=-2;break;case"this_year":case undefined:gf.defaultValue.yearOffset=0;break;}
delete gf.defaultValue.year;}
if(!gf.listFields){gf.listFields={};}
if(!gf.graphFields){gf.graphFields={};}}}
return data;}
function migrate3to4(data){if(data.lists){for(const list of Object.values(data.lists)){list.name=list.name||list.model;}}
if(data.pivots){for(const pivot of Object.values(data.pivots)){pivot.name=pivot.name||pivot.model;}}
return data;}
function migrate4to5(data){for(const filter of data.globalFilters||[]){for(const[id,fm]of Object.entries(filter.pivotFields||{})){if(!(data.pivots&&id in data.pivots)){delete filter.pivotFields[id];continue;}
if(!data.pivots[id].fieldMatching){data.pivots[id].fieldMatching={};}
data.pivots[id].fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){data.pivots[id].fieldMatching[filter.id].offset=fm.offset;}}
delete filter.pivotFields;for(const[id,fm]of Object.entries(filter.listFields||{})){if(!(data.lists&&id in data.lists)){delete filter.listFields[id];continue;}
if(!data.lists[id].fieldMatching){data.lists[id].fieldMatching={};}
data.lists[id].fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){data.lists[id].fieldMatching[filter.id].offset=fm.offset;}}
delete filter.listFields;const findFigureFromId=(id)=>{for(const sheet of data.sheets){const fig=sheet.figures.find((f)=>f.id===id);if(fig){return fig;}}
return undefined;};for(const[id,fm]of Object.entries(filter.graphFields||{})){const figure=findFigureFromId(id);if(!figure){delete filter.graphFields[id];continue;}
if(!figure.data.fieldMatching){figure.data.fieldMatching={};}
figure.data.fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){figure.data.fieldMatching[filter.id].offset=fm.offset;}}
delete filter.graphFields;}
return data;}
function migratePivotDaysParameters(formulaString){const ast=parse(formulaString);const convertedAst=convertAstNodes(ast,"FUNCALL",(ast)=>{if(["ODOO.PIVOT","ODOO.PIVOT.HEADER"].includes(ast.value.toUpperCase())){for(const subAst of ast.args){if(subAst.type==="STRING"){const date=subAst.value.match(dmyRegex);if(date){subAst.value=`${[date[2], date[1], date[3]].join("/")}`;}}}}
return ast;});return"="+astToFormula(convertedAst);}
function migrate5to6(data){if(!data.globalFilters?.length){return data;}
for(const filter of data.globalFilters){if(filter.type==="date"&&["year","quarter","month"].includes(filter.rangeType)){if(filter.defaultsToCurrentPeriod){filter.defaultValue=`this_${filter.rangeType}`;}
filter.rangeType="fixedPeriod";}
delete filter.defaultsToCurrentPeriod;}
return data;}
const OdooVersion=__exports.OdooVersion=class OdooVersion extends CorePlugin{export(data){data.odooVersion=ODOO_VERSION;}}
OdooVersion.getters=[];corePluginRegistry.add("odooMigration",OdooVersion);return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/odoo_module.js */
odoo.define("@odoo/o-spreadsheet",["@web/core/l10n/translation"],function(require){"use strict";const{_t,translationLoaded,translatedTerms}=require("@web/core/l10n/translation");const spreadsheet=window.o_spreadsheet;spreadsheet.setTranslationMethod(_t,()=>translatedTerms[translationLoaded]);return spreadsheet;});;

/* /spreadsheet/static/src/helpers/helpers.js */
odoo.define('@spreadsheet/helpers/helpers',[],function(require){'use strict';let __exports={};__exports.intersect=intersect;function intersect(a,b){return a.filter((x)=>b.includes(x));}
__exports.getMaxObjectId=getMaxObjectId;function getMaxObjectId(o){const keys=Object.keys(o);if(!keys.length){return 0;}
const nums=keys.map((id)=>parseInt(id,10));const max=Math.max(...nums);return max;}
__exports.toServerDateString=toServerDateString;function toServerDateString(value){return`${value.getFullYear()}-${value.getMonth() + 1}-${value.getDate()}`;}
__exports.sum=sum;function sum(array){return array.reduce((acc,n)=>acc+n,0);}
function camelToSnakeKey(word){const result=word.replace(/(.){1}([A-Z])/g,"$1 $2");return result.split(" ").join("_").toLowerCase();}
__exports.camelToSnakeObject=camelToSnakeObject;function camelToSnakeObject(obj){const result={};for(const[key,value]of Object.entries(obj)){const isPojo=typeof value==="object"&&value!==null&&value.constructor===Object;result[camelToSnakeKey(key)]=isPojo?camelToSnakeObject(value):value;}
return result;}
__exports.isEmpty=isEmpty;function isEmpty(item){if(!item){return true;}
if(typeof item==="object"){if(Object.values(item).length===0||Object.values(item).every((val)=>val===undefined)){return true;}}
return false;}
__exports.containsReferences=containsReferences;function containsReferences(cell){if(!cell.isFormula){return false;}
return cell.compiledFormula.tokens.some((token)=>token.type==="REFERENCE");}
return __exports;});;

/* /spreadsheet/static/src/public_readonly_app/main.js */
odoo.define('@spreadsheet/public_readonly_app/main',['@odoo/owl','@spreadsheet/public_readonly_app/public_readonly','@web/core/assets','@web/env','@web/session','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{App,whenReady}=require("@odoo/owl");const{PublicReadonlySpreadsheet}=require("@spreadsheet/public_readonly_app/public_readonly");const{templates}=require("@web/core/assets");const{makeEnv,startServices}=require("@web/env");const{session}=require("@web/session");const{_t}=require("@web/core/l10n/translation");(async function boot(){odoo.info={db:session.db,server_version:session.server_version,server_version_info:session.server_version_info,isEnterprise:session.server_version_info.slice(-1)[0]==="e",};odoo.isReady=false;const env=makeEnv();await startServices(env);await whenReady();const app=new App(PublicReadonlySpreadsheet,{env,props:session.spreadsheet_public_props,templates,translateFn:_t,dev:env.debug,warnIfNoStaticProps:env.debug,translatableAttributes:["data-tooltip"],});const root=await app.mount(document.getElementById("spreadsheet-mount-anchor"));odoo.__WOWL_DEBUG__={root};odoo.isReady=true;})();return __exports;});;

/* /spreadsheet/static/src/public_readonly_app/public_readonly.js */
odoo.define('@spreadsheet/public_readonly_app/public_readonly',['@odoo/owl','@web/core/utils/hooks','@web/core/network/download','@odoo/o-spreadsheet','@web/core/l10n/translation','@spreadsheet/o_spreadsheet/migration','@spreadsheet/hooks'],function(require){'use strict';let __exports={};const{Component,onWillStart,useChildSubEnv,useState}=require("@odoo/owl");const{useService}=require("@web/core/utils/hooks");const{download}=require("@web/core/network/download");const spreadsheet=require("@odoo/o-spreadsheet");const{Spreadsheet,Model,registries}=require("@odoo/o-spreadsheet");const{_t}=require("@web/core/l10n/translation");const{migrate}=require("@spreadsheet/o_spreadsheet/migration");const{useSpreadsheetPrint}=require("@spreadsheet/hooks");registries.topbarMenuRegistry.addChild("download_public_excel",["file"],{name:_t("Download"),execute:(env)=>env.downloadExcel(),isReadonlyAllowed:true,icon:"o-spreadsheet-Icon.DOWNLOAD",});const PublicReadonlySpreadsheet=__exports.PublicReadonlySpreadsheet=class PublicReadonlySpreadsheet extends Component{static props={dataUrl:String,downloadExcelUrl:String,mode:{type:String,optional:true},};setup(){this.http=useService("http");this.state=useState({isFilterShown:false,});useChildSubEnv({downloadExcel:()=>download({url:this.props.downloadExcelUrl,data:{},}),});useSpreadsheetPrint(()=>this.model);onWillStart(this.createModel.bind(this));}
get showFilterButton(){return(this.props.mode==="dashboard"&&this.globalFilters.length>0&&!this.state.isFilterShown);}
get globalFilters(){if(!this.data.globalFilters||this.data.globalFilters.length===0){return[];}
return this.data.globalFilters.filter((filter)=>filter.value!=="");}
async createModel(){this.data=await this.http.get(this.props.dataUrl);this.model=new Model(migrate(this.data),{mode:this.props.mode==="dashboard"?"dashboard":"readonly",});if(this.env.debug){spreadsheet.__DEBUG__=spreadsheet.__DEBUG__||{};spreadsheet.__DEBUG__.model=this.model;}}
toggleGlobalFilters(){this.state.isFilterShown=!this.state.isFilterShown;}}
PublicReadonlySpreadsheet.template="spreadsheet.PublicReadonlySpreadsheet";PublicReadonlySpreadsheet.components={Spreadsheet};return __exports;});;

/* /spreadsheet/static/src/hooks.js */
odoo.define('@spreadsheet/hooks',['@odoo/owl','@web/core/assets'],function(require){'use strict';let __exports={};const{useEffect,useExternalListener,useState}=require("@odoo/owl");const{loadBundle}=require("@web/core/assets");__exports.useSpreadsheetPrint=useSpreadsheetPrint;function useSpreadsheetPrint(model){let frozenPrintState=undefined;const printState=useState({active:false});useExternalListener(window,"keydown",async(ev)=>{const isMeta=ev.metaKey||ev.ctrlKey;if(ev.key==="p"&&isMeta){if(!model()){return;}
ev.preventDefault();ev.stopImmediatePropagation();await preparePrint();}},{capture:true});useExternalListener(window,"afterprint",afterPrint)
useEffect(()=>{if(printState.active){window.print();}},()=>[printState.active]);function getPrintRect(){const sheetId=model().getters.getActiveSheetId();const{bottom,right}=model().getters.getSheetZone(sheetId);const{end:width}=model().getters.getColDimensions(sheetId,right);const{end:height}=model().getters.getRowDimensions(sheetId,bottom);return{x:0,y:0,width,height};}
async function preparePrint(){if(!model()){return;}
await loadBundle("spreadsheet.assets_print");const{width,height}=model().getters.getSheetViewDimension();const{width:widthAndHeader,height:heightAndHeader}=model().getters.getSheetViewDimension();const viewRect={x:widthAndHeader-width,y:heightAndHeader-height,width,height,};frozenPrintState={viewRect,offset:model().getters.getActiveSheetDOMScrollInfo(),mode:model().config.mode,};model().updateMode("dashboard");model().dispatch("SET_VIEWPORT_OFFSET",{offsetX:0,offsetY:0});model().dispatch("RESIZE_SHEETVIEW",{...getPrintRect(),});printState.active=true;}
function afterPrint(){if(!model()){return;}
if(frozenPrintState){model().dispatch("RESIZE_SHEETVIEW",frozenPrintState.viewRect);const{scrollX:offsetX,scrollY:offsetY}=frozenPrintState.offset;model().dispatch("SET_VIEWPORT_OFFSET",{offsetX,offsetY});model().updateMode(frozenPrintState.mode);frozenPrintState=undefined;}
printState.active=false;}
return preparePrint;}
return __exports;});

                    /*******************************************
                    *  Templates                               *
                    *******************************************/

                    odoo.define('spreadsheet.public_spreadsheet.bundle.xml', ['@web/core/registry'], function(require){
                        'use strict';
                        const { registry } = require('@web/core/registry');
                        registry.category(`xml_templates`).add(`spreadsheet.public_spreadsheet`, `<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
<t t-name="o-spreadsheet-ActionButton">
    <span t-if="isVisible" class="o-menu-item-button" t-att-title="title" t-att-class="{'o-disabled': !isEnabled, active: isActive}" t-attf-class="{{props.class}}" t-on-click="onClick">
      <span t-if="iconTitle" t-att-style="buttonStyle">
        <t t-call="{{iconTitle}}"/>
      </span>
      <t t-if="props.hasTriangleDownIcon">
        <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
      </t>
    </span>
  </t>

  <t t-name="o-spreadsheet-Ripple">
    <div class="o-ripple-container position-relative" t-att-class="props.class" t-on-click="onClick">
      <div class="position-absolute w-100 h-100">
        <t t-foreach="state.ripples" t-as="ripple" t-key="ripple.id">
          <RippleEffect t-props="getRippleEffectProps(ripple.id)"/>
        </t>
      </div>
      <div class="position-relative" t-ref="childContainer">
        <t t-slot="default"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-RippleEffect">
    <div class="position-absolute" t-att-class="{ 'overflow-hidden': !props.allowOverflow }" t-att-style="props.style">
      <div class="o-ripple position-relative pe-none" t-ref="ripple" t-att-style="rippleStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-Autofill">
    <div class="o-autofill" t-att-style="style"/>
    <div class="o-autofill-handler" t-att-style="handlerStyle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick"/>
    <t t-set="tooltip" t-value="getTooltip()"/>
    <div t-if="tooltip" class="o-autofill-nextvalue" t-att-style="styleNextValue">
      <t t-component="tooltip.component" t-props="tooltip.props"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BorderEditor">
    <t t-set="border_color">Border Color</t>
    <Popover t-props="popoverProps">
      <div class="d-flex o-border-selector" t-on-click.stop="" t-att-class="props.class ? props.class : ''">
        <div class="o-border-selector-section">
          <div t-foreach="BORDER_POSITIONS" t-as="borderPositionsRow" t-key="borderPositionsRow" class="d-flex o-dropdown-button o-dropdown-line">
            <span t-foreach="borderPositionsRow" t-as="borderPosition" t-key="borderPosition" class="o-line-item o-hoverable-button" t-att-class="{active:props.currentBorderPosition === borderPosition[0]}" t-att-name="borderPosition[0]" t-on-click.stop="() =&gt; this.setBorderPosition(borderPosition[0])">
              <t t-call="{{borderPosition[1]}}"/>
            </span>
          </div>
        </div>
        <div class="o-divider"/>
        <div class="o-border-selector-section">
          <div class="m-0 p-0 d-flex align-items-center justify-content-center o-with-color o-hoverable-button" title="Border color" t-on-click.stop="(ev) =&gt; this.toggleDropdownTool('borderColorTool')">
            <ColorPickerWidget currentColor="props.currentBorderColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('borderColorTool')" showColorPicker="state.activeTool === 'borderColorTool'" onColorPicked="(color) =&gt; this.setBorderColor(color)" title="border_color" icon="props.currentBorderColor === '' ? 'o-spreadsheet-Icon.BORDER_NO_COLOR' : 'o-spreadsheet-Icon.BORDER_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-dropdown-button o-border-picker-button'"/>
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
          </div>
          <div class="o-border-style-tool d-flex align-items-center justify-content-center o-hoverable-button" title="Line style" t-ref="lineStyleButton" t-on-click.stop="(ev) =&gt; this.toggleDropdownTool('borderTypeTool')">
            <t t-call="o-spreadsheet-Icon.BORDER_TYPE"/>
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
            <Popover t-props="lineStylePickerPopoverProps" t-if="state.activeTool === 'borderTypeTool'">
              <div class="o-border-style-dropdown">
                <t t-foreach="borderStyles" t-as="borderStyle" t-key="borderStyle">
                  <div t-att-title="borderStyle" t-on-click.stop="() =&gt; this.setBorderStyle(borderStyle)">
                    <div class="d-flex o-dropdown-border-type">
                      <div class="o-dropdown-border-check">
                        <t t-if="props.currentBorderStyle === borderStyle" t-call="o-spreadsheet-Icon.CHECK"/>
                      </div>
                      <div t-attf-class="o-style-preview o-style-{{borderStyle}}"/>
                    </div>
                  </div>
                </t>
              </div>
            </Popover>
          </div>
        </div>
      </div>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-BorderEditorWidget">
    <div class="d-flex position-relative" title="Borders">
      <span t-ref="borderEditorButton" t-on-click.stop="props.toggleBorderEditor" t-att-class="props.class ? props.class : ''" t-att-disabled="props.disabled">
        <span t-att-style="iconStyle">
          <t t-call="o-spreadsheet-Icon.BORDERS"/>
        </span>
      </span>
      <BorderEditor t-if="props.showBorderEditor" onBorderColorPicked.bind="onBorderColorPicked" onBorderStylePicked.bind="onBorderStylePicked" onBorderPositionPicked.bind="onBorderPositionPicked" currentBorderColor="state.currentColor" currentBorderStyle="state.currentStyle" currentBorderPosition="state.currentPosition" maxHeight="props.dropdownMaxHeight" anchorRect="borderEditorAnchorRect"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BottomBar">
    <div class="o-spreadsheet-bottom-bar o-two-columns d-flex align-items-center overflow-hidden" t-on-click="props.onClick" t-ref="bottomBar" t-on-contextmenu.prevent="">
      <Ripple>
        <div class="o-sheet-item o-add-sheet me-2 p-1" t-if="!env.model.getters.isReadonly()" t-on-click="clickAddSheet">
          <t t-call="o-spreadsheet-Icon.PLUS"/>
        </div>
      </Ripple>
      <Ripple>
        <div class="o-sheet-item o-list-sheets me-2 p-1" t-on-click="clickListSheets">
          <t t-call="o-spreadsheet-Icon.LIST"/>
        </div>
      </Ripple>
      <div class="o-all-sheets position-relative flex-shrink-0 d-flex h-100 me-3">
        <div class="o-bottom-bar-fade-in position-absolute h-100 w-100 pe-none" t-if="state.isSheetListScrollableLeft"/>
        <div class="o-sheet-list d-flex w-100 overflow-hidden px-1" t-ref="sheetList" t-on-wheel="onWheel" t-on-scroll="onScroll">
          <t t-foreach="getVisibleSheets()" t-as="sheet" t-key="sheet.id">
            <BottomBarSheet style="getSheetStyle(sheet.id)" sheetId="sheet.id" openContextMenu="(registry, ev) =&gt; this.onSheetContextMenu(sheet.id, registry, ev)" onMouseDown="(ev) =&gt; this.onSheetMouseDown(sheet.id, ev)"/>
          </t>
        </div>
        <div class="o-bottom-bar-fade-out position-absolute h-100 w-100 pe-none" t-if="state.isSheetListScrollableRight"/>
      </div>
      <div class="o-bottom-bar-arrows d-flex h-100 me-5 align-items-center" t-if="state.isSheetListScrollableLeft || state.isSheetListScrollableRight">
        <Ripple ignoreClickPosition="true" width="20" height="20" offsetX="1" allowOverflow="true" enabled="state.isSheetListScrollableLeft">
          <div class="o-bottom-bar-arrow o-bottom-bar-arrow-left d-flex align-items-center me-2" t-att-class="{'o-disabled': !state.isSheetListScrollableLeft}" t-on-click="onArrowLeft">
            <t t-call="o-spreadsheet-Icon.CARET_LEFT"/>
          </div>
        </Ripple>
        <Ripple ignoreClickPosition="true" width="20" height="20" offsetX="-1" allowOverflow="true" enabled="state.isSheetListScrollableRight">
          <div class="o-bottom-bar-arrow o-bottom-bar-arrow-right d-flex align-items-center me-4" t-att-class="{'o-disabled': !state.isSheetListScrollableRight}" t-on-click="onArrowRight">
            <t t-call="o-spreadsheet-Icon.CARET_RIGHT"/>
          </div>
        </Ripple>
      </div>

      <BottomBarStatistic openContextMenu="(x, y, registry) =&gt; this.openContextMenu(x, y, 'listSelectionStatistics', registry)" closeContextMenu="() =&gt; this.closeContextMenuWithId('listSelectionStatistics')"/>

      <Menu t-if="menuState.isOpen" position="menuState.position" menuItems="menuState.menuItems" maxHeight="menuMaxHeight" onClose="() =&gt; this.closeMenu()" menuId="menuState.menuId"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BottomBarSheet">
    <Ripple>
      <div class="o-sheet d-flex align-items-center user-select-none text-nowrap " t-on-mousedown="(ev) =&gt; this.onMouseDown(ev)" t-on-contextmenu.prevent="(ev) =&gt; this.onContextMenu(ev)" t-ref="sheetDiv" t-att-style="props.style" t-att-title="sheetName" t-att-data-id="props.sheetId" t-att-class="{active: isSheetActive}">
        <span class="o-sheet-name" t-att-class="{'o-sheet-name-editable': state.isEditing }" t-ref="sheetNameSpan" t-esc="sheetName" t-on-click="(ev) =&gt; this.onClickSheetName(ev)" t-on-dblclick="() =&gt; this.onDblClick()" t-on-focusout="() =&gt; this.onFocusOut()" t-on-keydown="(ev) =&gt; this.onKeyDown(ev)" t-att-contenteditable="state.isEditing ? 'true': 'false'"/>
        <span class="o-sheet-icon ms-1" t-on-click.stop="(ev) =&gt; this.onIconClick(ev)">
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
    </Ripple>
  </t>

  <t t-name="o-spreadsheet-BottomBarStatisic">
    <t t-set="selectedStatistic" t-value="getSelectedStatistic()"/>
    <Ripple class="'ms-auto'" t-if="selectedStatistic !== undefined">
      <div class="o-selection-statistic text-truncate user-select-none me-4 bg-white rounded shadow" t-on-click="listSelectionStatistics">
        <t t-esc="selectedStatistic"/>
        <span class="ms-2">
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
    </Ripple>
  </t>

  <t t-name="o-spreadsheet-ClientTag">
    <div t-if="props.active" class="o-client-tag" t-att-style="tagStyle" t-esc="props.name"/>
  </t>

  <t t-name="o-spreadsheet-ColorPicker">
    <Popover t-props="popoverProps">
      <div class="o-color-picker" t-on-click.stop="" t-att-style="colorPickerStyle">
        <div class="o-color-picker-section-name">Standard</div>
        <div class="colors-grid">
          <div t-foreach="COLORS" t-as="color" t-key="color" class="o-color-picker-line-item" t-att-data-color="color" t-on-click="() =&gt; this.onColorClick(color)" t-attf-style="background-color:{{color}};">
            <div t-if="isSameColor(props.currentColor, color)" align="center" t-attf-style="color:{{checkmarkColor}}">
              ✓
            </div>
          </div>
        </div>
        <div class="o-separator"/>
        <div class="o-color-picker-section-name o-color-picker-toggler" t-on-click="toggleColorPicker">
          <span>Custom</span>
        </div>
        <div class="colors-grid o-color-picker-toggler" t-on-click.stop="toggleColorPicker">
          <div class="o-color-picker-line-item o-color-picker-toggler-button">
            <div class="o-color-picker-toggler-sign">
              <t t-call="o-spreadsheet-Icon.PLUS"/>
            </div>
          </div>
          <div t-foreach="env.model.getters.getCustomColors()" t-as="color" t-key="color" class="o-color-picker-line-item" t-att-data-color="color" t-attf-style="background-color:{{color}};" t-on-click="() =&gt; this.onColorClick(color)">
            <div t-if="isSameColor(props.currentColor, color)" align="center" t-attf-style="color:{{checkmarkColor}}">
              ✓
            </div>
          </div>
        </div>
        <div t-if="state.showGradient" class="o-custom-selector">
          <div class="o-gradient" t-on-click.stop="" t-on-mousedown="dragGradientPointer" t-att-style="gradientHueStyle">
            <div class="saturation w-100 h-100 position-absolute pe-none"/>
            <div class="lightness w-100 h-100 position-absolute pe-none"/>
            <div class="magnifier pe-none" t-att-style="pointerStyle"/>
          </div>
          <div class="o-hue-container" t-on-mousedown="dragHuePointer">
            <div class="o-hue-picker" t-on-click.stop=""/>
            <div class="o-hue-slider pe-none" t-att-style="sliderStyle">
              <t t-call="o-spreadsheet-Icon.TRIANGLE_UP"/>
            </div>
          </div>
          <div class="o-custom-input-preview">
            <input type="text" t-att-class="{'o-wrong-color': !isHexColorInputValid }" t-on-click.stop="" t-att-value="state.customHexColor" t-on-input="setHexColor" maxlength="7"/>
            <div class="o-color-preview" t-att-style="colorPreviewStyle"/>
          </div>
          <div class="o-custom-input-buttons">
            <button class="o-add-button" t-att-class="{'o-disabled': !state.customHexColor or !isHexColorInputValid}" t-on-click.stop="addCustomColor">
              Add
            </button>
          </div>
        </div>
        <div class="o-separator"/>
        <div class="o-buttons">
          <button t-on-click="resetColor" class="o-cancel">No Color</button>
        </div>
      </div>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-ColorPickerWidget">
    <div class="o-color-picker-widget">
      <span class="o-color-picker-button" t-ref="colorPickerButton" t-on-click.stop="props.toggleColorPicker" t-att-title="props.title" t-att-class="props.class ? props.class : 'o-color-picker-button-style'" t-att-disabled="props.disabled">
        <span t-att-style="iconStyle">
          <t t-call="{{props.icon}}"/>
        </span>
      </span>
      <ColorPicker t-if="props.showColorPicker" anchorRect="colorPickerAnchorRect" onColorPicked="props.onColorPicked" currentColor="props.currentColor" maxHeight="props.dropdownMaxHeight"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-TextValueProvider">
    <div t-ref="autoCompleteList" t-att-class="{           'o-autocomplete-dropdown':props.values.length }">
      <t t-foreach="props.values" t-as="v" t-key="v.text">
        <div class="d-flex flex-column text-start" t-att-class="{'o-autocomplete-value-focus': props.selectedIndex === v_index}" t-on-click="() =&gt; this.props.onValueSelected(v.text)" t-on-mousemove="() =&gt; this.props.onValueHovered(v_index)">
          <div class="o-autocomplete-value text-truncate">
            <t t-set="htmlContent" t-value="props.getHtmlContent(v.text)"/>
            <span t-foreach="htmlContent" t-as="content" t-key="content_index" t-att-class="content.class" t-attf-style="color: {{content.color || 'inherit'}};" t-esc="content.value"/>
          </div>
          <div class="o-autocomplete-description text-truncate" t-esc="v.description" t-if="props.selectedIndex === v_index"/>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Composer">
    <div class="o-composer-container w-100 h-100">
      <div class="o-composer w-100 text-start" t-att-class="{ 'text-muted': env.model.getters.isReadonly(), 'active': props.focus !== 'inactive' }" t-att-style="props.inputStyle" t-ref="o_composer" tabindex="1" t-att-contenteditable="env.model.getters.isReadonly() ? 'false' : 'true'" spellcheck="false" t-on-keydown="onKeydown" t-on-mousewheel.stop="" t-on-input="onInput" t-on-mousedown="onMousedown" t-on-click="onClick" t-on-keyup="onKeyup" t-on-paste="onPaste" t-on-compositionstart="onCompositionStart" t-on-compositionend="onCompositionEnd" t-on-dblclick="onDblClick" t-on-contextmenu="onContextMenu"/>

      <div t-if="props.focus !== 'inactive' and (autoCompleteState.showProvider or functionDescriptionState.showDescription)" class="o-composer-assistant shadow" t-att-style="assistantStyle" t-on-wheel.stop="" t-on-mousedown.prevent.stop="" t-on-click.prevent.stop="" t-on-mouseup.prevent.stop="">
        <TextValueProvider t-if="autoCompleteState.showProvider" values="autoCompleteState.values" selectedIndex="autoCompleteState.selectedIndex" onValueSelected.bind="this.autoComplete" onValueHovered.bind="this.updateAutoCompleteIndex" getHtmlContent="autoCompleteState.getHtmlContent"/>
        <FunctionDescriptionProvider t-if="functionDescriptionState.showDescription" functionName="functionDescriptionState.functionName" functionDescription="functionDescriptionState.functionDescription" argToFocus="functionDescriptionState.argToFocus"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FunctionDescriptionProvider">
    <div class="o-formula-assistant-container user-select-none shadow" t-att-class="{           'pe-none': assistantState.allowCellSelectionBehind,           'pe-auto': !assistantState.allowCellSelectionBehind           }">
      <t t-set="context" t-value="getContext()"/>
      <div class="o-formula-assistant" t-if="context.functionName" t-on-mousemove="onMouseMove" t-att-class="{'opacity-25': assistantState.allowCellSelectionBehind}">
        <div class="o-formula-assistant-head">
          <span t-esc="context.functionName"/>
          (
          <t t-foreach="context.functionDescription.args" t-as="arg" t-key="arg.name">
            <span t-if="arg_index &gt; '0'" t-esc="formulaArgSeparator"/>
            <span t-att-class="{ 'o-formula-assistant-focus': context.argToFocus === arg_index }">
              <span>
                <span t-if="arg.optional || arg.repeating || arg.default">[</span>
                <span t-esc="arg.name"/>
                <span t-if="arg.repeating">, ...</span>
                <span t-if="arg.optional || arg.repeating || arg.default">]</span>
              </span>
            </span>
          </t>
          )
        </div>

        <div class="o-formula-assistant-core pb-3 m-3">
          <div class="o-formula-assistant-gray">ABOUT</div>
          <div t-esc="context.functionDescription.description"/>
        </div>

        <t t-foreach="context.functionDescription.args" t-as="arg" t-key="arg.name">
          <div class="o-formula-assistant-arg p-3 pt-0 display-flex flex-column" t-att-class="{                 'o-formula-assistant-gray': context.argToFocus &gt;= '0',                 'o-formula-assistant-focus': context.argToFocus === arg_index,               }">
            <div>
              <span t-esc="arg.name"/>
              <span t-if="arg.optional || arg.repeating || arg.default "> - [optional] </span>
              <span t-if="arg.default">
                <span>default: </span>
                <t t-esc="arg.defaultValue"/>
              </span>
              <span t-if="arg.repeating">repeatable</span>
            </div>
            <div class="o-formula-assistant-arg-description" t-esc="arg.description"/>
          </div>
        </t>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridComposer">
    <div class="o-cell-reference" t-if="shouldDisplayCellReference" t-att-style="cellReferenceStyle" t-esc="cellReference"/>
    <div class="o-grid-composer" t-att-style="containerStyle" t-ref="gridComposer">
      <Composer t-props="composerProps"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-TopBarComposer">
    <div class="o-topbar-composer bg-white user-select-text" t-on-click.stop="" t-att-style="containerStyle">
      <Composer focus="props.focus" inputStyle="composerStyle" onComposerContentFocused="props.onComposerContentFocused"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-SpreadsheetDashboard">
    <div class="o-grid o-two-columns" tabindex="-1" t-on-wheel="onMouseWheel" t-on-click="onClosePopover">
      <div class="mx-auto h-100 position-relative" t-ref="grid" t-att-style="gridContainer">
        <GridOverlay onCellHovered.bind="onCellHovered" onGridResized.bind="onGridResized" onGridMoved.bind="moveCanvas" gridOverlayDimensions="gridOverlayDimensions"/>
        <canvas t-ref="canvas"/>
        <GridPopover hoveredCell="hoveredCell" gridRect="getGridRect()" onMouseWheel.bind="onMouseWheel" onClosePopover.bind="onClosePopover"/>
        <div t-foreach="getClickableCells()" t-as="clickableCell" t-key="clickableCell_index" class="o-dashboard-clickable-cell" t-on-click="() =&gt; this.selectClickableCell(clickableCell)" t-on-contextmenu.prevent="" t-att-style="getCellClickableStyle(clickableCell.coordinates)"/>
        <FilterIconsOverlay/>
      </div>
      <VerticalScrollBar/>
      <HorizontalScrollBar/>
      <div class="o-scrollbar corner"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationOverlay">
    <t t-foreach="checkBoxCellPositions" t-as="position" t-key="'checkbox'+position_index">
      <GridCellIcon cellPosition="position">
        <DataValidationCheckbox cellPosition="position"/>
      </GridCellIcon>
    </t>

    <t t-foreach="listIconsCellPositions" t-as="position" t-key="'list'+position_index">
      <GridCellIcon cellPosition="position" horizontalAlign="'right'">
        <DataValidationListIcon cellPosition="position"/>
      </GridCellIcon>
    </t>
  </t>

  <t t-name="o-spreadsheet-DataValidationCheckbox">
    <input type="checkbox" class="o-dv-checkbox" t-att-class="{'pe-none': isDisabled}" t-on-change="onCheckboxChange" t-att-checked="checkBoxValue"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationListIcon">
    <div class="o-dv-list-icon d-flex align-items-center justify-content-center" t-on-click="onClick">
      <t t-call="o-spreadsheet-Icon.CARET_DOWN"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ErrorToolTip">
    <div class="o-error-tooltip">
      <t t-foreach="props.errors" t-as="error" t-key="error_index">
        <div class="o-error-tooltip-title fw-bold text-danger">
          <t t-esc="error.title"/>
        </div>
        <div class="o-error-tooltip-message">
          <t t-esc="error.message"/>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartJsComponent">
    <canvas class="o-figure-canvas w-100 h-100" t-att-style="canvasStyle" t-ref="graphContainer"/>
  </t>

  <t t-name="o-spreadsheet-ScorecardChart">
    <canvas class="o-figure-canvas w-100 h-100" t-ref="chartContainer"/>
  </t>

  <t t-name="o-spreadsheet-FigureComponent">
    <div class="o-figure-wrapper pe-auto" t-att-style="wrapperStyle">
      <div class="o-figure w-100 h-100" t-on-mousedown.stop="(ev) =&gt; this.onMouseDown(ev)" t-on-contextmenu.prevent.stop="(ev) =&gt; !env.model.getters.isReadonly() and this.onContextMenu(ev)" t-ref="figure" t-att-style="props.style" t-att-data-id="props.figure.id" tabindex="0" t-on-keydown="(ev) =&gt; this.onKeyDown(ev)" t-on-keyup.stop="">
        <t t-component="figureRegistry.get(props.figure.tag).Component" t-key="props.figure.id" onFigureDeleted="props.onFigureDeleted" figure="props.figure"/>
        <div class="o-figure-menu position-absolute m-2" t-if="!env.isDashboard()">
          <div class="o-figure-menu-item" t-if="!env.model.getters.isReadonly()" t-on-click="showMenu" t-ref="menuButton" t-on-contextmenu.prevent.stop="showMenu">
            <t t-call="o-spreadsheet-Icon.LIST"/>
          </div>
          <Menu t-if="menuState.isOpen" position="menuState.position" menuItems="menuState.menuItems" onClose="() =&gt; this.menuState.isOpen=false"/>
        </div>
      </div>
      <div class="o-figure-border w-100 h-100 position-absolute pe-none" t-att-style="borderStyle"/>
      <t t-if="isSelected">
        <div class="o-fig-anchor o-top" t-att-style="this.getResizerPosition('top')" t-on-mousedown="(ev) =&gt; this.clickAnchor(0,-1, ev)"/>
        <div class="o-fig-anchor o-topRight" t-att-style="this.getResizerPosition('top right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,-1, ev)"/>
        <div class="o-fig-anchor o-right" t-att-style="this.getResizerPosition('right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,0, ev)"/>
        <div class="o-fig-anchor o-bottomRight" t-att-style="this.getResizerPosition('bottom right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,1, ev)"/>
        <div class="o-fig-anchor o-bottom" t-att-style="this.getResizerPosition('bottom')" t-on-mousedown="(ev) =&gt; this.clickAnchor(0,1, ev)"/>
        <div class="o-fig-anchor o-bottomLeft" t-att-style="this.getResizerPosition('bottom left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,1, ev)"/>
        <div class="o-fig-anchor o-left" t-att-style="this.getResizerPosition('left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,0, ev)"/>
        <div class="o-fig-anchor o-topLeft" t-att-style="this.getResizerPosition('top left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,-1, ev)"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartFigure">
    <div class="o-chart-container w-100 h-100" t-on-dblclick="onDoubleClick">
      <t t-component="chartComponent" figure="this.props.figure" t-key="this.props.figure.id + '-' + chartType"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-FiguresContainer">
    <div>
      <t t-foreach="containers" t-as="container" t-key="container.type">
        <div class="o-figure-container position-absolute pe-none overflow-hidden" t-att-style="container.style" t-att-data-id="container.type + 'Container'">
          <div class="o-figure-viewport-inverse w-0 h-0 overflow-visible position-absolute" t-att-style="container.inverseViewportStyle">
            <t t-foreach="container.figures" t-as="figure" t-key="figure.id">
              <FigureComponent onFigureDeleted="this.props.onFigureDeleted" figure="figure" style="getFigureStyle(figure)" onMouseDown="(ev) =&gt; this.startDraggingFigure(figure, ev)" onClickAnchor="(dirX, dirY, ev) =&gt; this.startResize(figure, dirX, dirY, ev)"/>
            </t>
          </div>
        </div>
      </t>
    </div>
    <div class="o-figure-container position-absolute pe-none overflow-hidden" t-if="dnd.horizontalSnap" t-att-style="dnd.horizontalSnap.containerStyle" t-att-data-id="'HorizontalSnapContainer'">
      <div class="o-figure-snap-line horizontal" t-att-style="dnd.horizontalSnap.lineStyle"/>
    </div>
    <div class="o-figure-container position-absolute pe-none overflow-hidden" t-if="dnd.verticalSnap" t-att-style="dnd.verticalSnap.containerStyle" t-att-data-id="'VerticalSnapContainer'">
      <div class="o-figure-snap-line vertical" t-att-style="dnd.verticalSnap.lineStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ImageFigure">
    <img t-att-src="getImagePath" class="w-100 h-100"/>
  </t>

  <t t-name="o-spreadsheet-FilterIcon">
    <div class="o-filter-icon" t-on-click.stop="onClick">
      <t t-if="isFilterActive" t-call="o-spreadsheet-Icon.FILTER_ICON_ACTIVE"/>
      <t t-else="" t-call="o-spreadsheet-Icon.FILTER_ICON"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-FilterIconsOverlay">
    <t t-foreach="getFilterHeadersPositions()" t-as="position" t-key="'filter'+position.col + '_' + position.row">
      <GridCellIcon cellPosition="position" offset="props.gridPosition" horizontalAlign="'right'">
        <FilterIcon cellPosition="position"/>
      </GridCellIcon>
    </t>
  </t>

  <t t-name="o-spreadsheet-FilterMenu">
    <div class="o-filter-menu d-flex flex-column bg-white" t-on-wheel.stop="">
      <div t-if="!isReadonly">
        <div class="o-filter-menu-item" t-on-click="() =&gt; this.sortFilterZone('ascending')">
          Sort ascending (A ⟶ Z)
        </div>
        <div class="o-filter-menu-item" t-on-click="() =&gt; this.sortFilterZone('descending')">
          Sort descending (Z ⟶ A)
        </div>
      </div>
      <div class="o-separator" t-if="!isReadonly"/>
      <div class="o-filter-menu-actions">
        <div class="o-filter-menu-action-text" t-on-click="selectAll">Select all</div>
        <div class="o-filter-menu-action-text" t-on-click="clearAll">Clear</div>
      </div>
      <div class="position-relative">
        <input class="w-100" t-ref="filterMenuSearchBar" type="text" t-model="state.textFilter" placeholder="Search..." t-on-keydown="onKeyDown"/>
        <i class="o-search-icon position-absolute">
          <t t-call="o-spreadsheet-Icon.SEARCH"/>
        </i>
      </div>
      <div class="o-filter-menu-list d-flex flex-column rounded" t-ref="filterValueList" t-on-click="this.clearScrolledToValue" t-on-scroll="this.clearScrolledToValue">
        <t t-foreach="displayedValues" t-as="value" t-key="value.string">
          <FilterMenuValueItem onClick="() =&gt; this.checkValue(value)" onMouseMove="() =&gt; this.onMouseMove(value)" value="value.string" isChecked="value.checked" isSelected="value.string === state.selectedValue" scrolledTo="value.scrolledTo"/>
        </t>
        <div t-if="displayedValues.length === 0" class="o-filter-menu-no-values d-flex align-items-center justify-content-center w-100 h-100 ">
          No results
        </div>
      </div>
      <div class="o-filter-menu-buttons d-flex justify-content-end">
        <div class="o-filter-menu-button o-filter-menu-button-cancel" t-on-click="cancel">
          Cancel
        </div>
        <div class="o-filter-menu-button o-filter-menu-button-primary" t-on-click="confirm">
          Confirm
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FilterMenuValueItem">
    <div t-on-click="this.props.onClick" t-on-mousemove="this.props.onMouseMove" class="o-filter-menu-item o-filter-menu-value" t-ref="menuValueItem" t-att-class="{'selected': this.props.isSelected}">
      <div>
        <div class="o-filter-menu-value-checked">
          <span t-if="this.props.isChecked">✓</span>
        </div>
      </div>
      <div class="o-filter-menu-value-text text-truncate">
        <t t-if="this.props.value === ''">(Blanks)</t>
        <t t-else="" t-esc="this.props.value"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FontSizeEditor">
    <div class="o-dropdown" t-ref="FontSizeEditor">
      <div class=" o-font-size-editor d-flex align-items-center" t-att-class="props.class" title="Font Size" t-on-click="this.toggleFontList">
        <input type="number" min="1" max="400" class="o-font-size bg-transparent border-0" t-on-keydown="onInputKeydown" t-on-click.stop="" t-on-focus.stop="onInputFocused" t-att-value="currentFontSize" t-on-change="setSizeFromInput" t-ref="inputFontSize"/>
        <span>
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
      <div class="o-dropdown-content o-text-options" t-if="dropdown.isOpen" t-on-click.stop="" t-att-style="props.dropdownStyle">
        <t t-foreach="fontSizes" t-as="fontSize" t-key="fontSize">
          <div t-esc="fontSize" t-att-data-size="fontSize" t-on-click="() =&gt; this.setSizeFromList(fontSize)"/>
        </t>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Grid">
    <div class="o-grid w-100 h-100" tabindex="-1" t-on-click="focusDefaultElement" t-on-keydown="onKeydown" t-on-wheel="onMouseWheel" t-ref="grid">
      <GridOverlay onCellClicked.bind="onCellClicked" onCellDoubleClicked.bind="onCellDoubleClicked" onCellRightClicked.bind="onCellRightClicked" onCellHovered.bind="onCellHovered" onGridResized.bind="onGridResized" onGridMoved.bind="moveCanvas" gridOverlayDimensions="gridOverlayDimensions" onFigureDeleted.bind="focusDefaultElement"/>
      <HeadersOverlay onOpenContextMenu="(type, x, y) =&gt; this.toggleContextMenu(type, x, y)"/>
      <GridComposer focus="props.focusComposer" onComposerContentFocused="props.onComposerContentFocused" onComposerCellFocused="props.onGridComposerCellFocused" gridDims="env.model.getters.getSheetViewDimensionWithHeaders()" onInputContextMenu.bind="onInputContextMenu"/>
      <canvas t-ref="canvas"/>
      <t t-foreach="env.model.getters.getClientsToDisplay()" t-as="client" t-key="getClientPositionKey(client)">
        <ClientTag name="client.name" color="client.color" col="client.position.col" row="client.position.row" active="isCellHovered(client.position.col, client.position.row)"/>
      </t>
      <GridPopover t-if="!menuState.isOpen" hoveredCell="hoveredCell" gridRect="getGridRect()" onMouseWheel.bind="onMouseWheel" onClosePopover.bind="onClosePopover"/>
      <t t-if="env.model.getters.getEditionMode() === 'inactive'">
        <Autofill position="getAutofillPosition()" isVisible="isAutofillVisible"/>
      </t>
      <t t-foreach="env.model.getters.getHighlights()" t-as="highlight" t-key="highlight_index">
        <t t-if="highlight.sheetId === env.model.getters.getActiveSheetId()">
          <Highlight zone="highlight.zone" color="highlight.color"/>
        </t>
      </t>
      <Menu t-if="menuState.isOpen" menuItems="menuState.menuItems" position="menuState.position" onClose="() =&gt; this.closeMenu()"/>
      <FilterIconsOverlay gridPosition="{ x: HEADER_WIDTH, y : HEADER_HEIGHT }"/>
      <VerticalScrollBar topOffset="HEADER_HEIGHT"/>
      <HorizontalScrollBar leftOffset="HEADER_WIDTH"/>
      <div class="o-scrollbar corner"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridAddRowsFooter">
    <div class="o-grid-add-rows mt-2 ms-2 w-100 d-flex position-relative align-items-center" t-att-style="addRowsPosition" t-on-mousedown.stop.prevent="">
      <button t-on-click="onConfirm" t-att-disabled="state.errorFlag" class="o-button o-button-grey">
        Add
      </button>
      <input type="text" class="o-grid-add-rows-input o-input mt-0 me-2" t-ref="inputRef" value="100" t-on-click.stop="" t-on-keydown.stop="onKeydown" t-on-mousedown.stop="" t-on-input.stop="onInput"/>
      <span>more rows at the bottom</span>
      <ValidationMessages t-if="state.errorFlag" messages="errorMessages" msgType="'error'"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridCellIcon">
    <div class="o-grid-cell-icon position-absolute overflow-hidden" t-if="isPositionVisible(this.props.cellPosition)" t-att-style="iconStyle">
      <t t-slot="default"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridOverlay">
    <div t-ref="gridOverlay" class="o-grid-overlay overflow-hidden" t-att-class="{'o-paint-format-cursor': isPaintingFormat}" t-att-style="style" t-on-mousedown="onMouseDown" t-on-dblclick.self="onDoubleClick" t-on-contextmenu.stop.prevent="onContextMenu">
      <FiguresContainer onFigureDeleted="props.onFigureDeleted"/>
      <DataValidationOverlay/>
      <GridAddRowsFooter t-if="!env.model.getters.isReadonly()" t-key="env.model.getters.getActiveSheetId()" focusGrid="props.onFigureDeleted"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridPopover">
    <Popover t-if="cellPopover.isOpen" positioning="cellPopover.cellCorner" maxHeight="cellPopover.Component.size and cellPopover.Component.size.maxHeight" maxWidth="cellPopover.Component.size and cellPopover.Component.size.maxHidth" anchorRect="cellPopover.anchorRect" containerRect="env.getPopoverContainerRect()" onMouseWheel="props.onMouseWheel" zIndex="zIndex">
      <t t-component="cellPopover.Component" t-props="{...cellPopover.props, onClosed : () =&gt; props.onClosePopover()}"/>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-HeaderGroup">
    <div class="o-header-group position-absolute" t-att-style="groupBoxStyle" t-att-data-id="props.group.start + '-' + props.group.end" t-on-click="toggleGroup" t-on-contextmenu.stop.prevent="onContextMenu">
      <div class="o-header-group-header position-absolute d-flex align-items-center justify-content-center overflow-hidden" t-att-style="groupHeaderStyle">
        <div class="o-group-fold-button user-select-none rounded d-flex align-items-center justify-content-center" t-att-style="groupButtonStyle">
          <t t-call="{{groupButtonIcon}}"/>
        </div>
      </div>
      <div class="o-group-border position-absolute" t-if="!isGroupFolded" t-att-style="groupBorderStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-HeaderGroupContainer">
    <div class="o-header-group-container d-flex w-100 h-100 overflow-hidden" t-att-class="{         'flex-column': props.dimension === 'ROW',         'flex-row': props.dimension === 'COL',       }" t-if="props.layers.length" t-on-contextmenu.prevent="onContextMenu">
      <div class="o-header-group-frozen-pane flex-shrink-0 overflow-hidden position-relative" t-att-class="{           'o-group-rows': props.dimension === 'ROW',           'o-group-columns': props.dimension === 'COL',         }" t-if="hasFrozenPane" t-att-style="frozenPaneContainerStyle">
        <t t-foreach="props.layers" t-as="layer" t-key="layer_index">
          <t t-foreach="layer" t-as="group" t-key="group.start + '-' + group.end">
            <t t-component="groupComponent" group=" group" layerOffset="getLayerOffset(layer_index)" openContextMenu.bind="openContextMenu"/>
          </t>
        </t>
      </div>
      <div class="o-header-group-frozen-pane-border" t-att-class="{           'o-group-rows': props.dimension === 'ROW',           'o-group-columns': props.dimension === 'COL',         }" t-if="hasFrozenPane"/>

      <div class="o-header-group-main-pane flex-shrink-0 position-relative h-100 w-100 overflow-hidden" t-att-class="{           'o-group-rows': hasFrozenPane and props.dimension === 'ROW',           'o-group-columns': hasFrozenPane and props.dimension === 'COL',         }">
        <div class="o-header-group-scroll-container position-relative" t-att-style="scrollContainerStyle">
          <t t-foreach="props.layers" t-as="layer" t-key="layer_index">
            <t t-foreach="layer" t-as="group" t-key="group.start + '-' + group.end">
              <t t-component="groupComponent" group="group" layerOffset="getLayerOffset(layer_index)" openContextMenu.bind="openContextMenu"/>
            </t>
          </t>
        </div>
      </div>

      <Menu t-if="menu.isOpen" menuItems="menu.menuItems" position="menu.position" onClose.bind="this.closeMenu"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-HeadersOverlay">
    <div class="o-overlay">
      <ColResizer onOpenContextMenu="props.onOpenContextMenu"/>
      <RowResizer onOpenContextMenu="props.onOpenContextMenu"/>
      <div class="all" t-on-mousedown.self="selectAll"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-RowResizer">
    <div class="o-row-resizer" t-on-mousemove.self="onMouseMove" t-on-mouseleave="onMouseLeave" t-on-mousedown.self.prevent="select" t-ref="rowResizer" t-on-mouseup.self="onMouseUp" t-on-contextmenu.self="onContextMenu" t-att-class="{'o-grab': state.waitingForMove, 'o-dragging': state.isMoving}">
      <div t-if="state.isMoving" class="dragging-row-line" t-attf-style="top:{{state.draggerLinePosition}}px;"/>
      <div t-if="state.isMoving" class="dragging-row-shadow" t-attf-style="top:{{state.draggerShadowPosition}}px; height:{{state.draggerShadowThickness}}px;"/>
      <t t-if="state.resizerIsActive">
        <div class="o-handle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick" t-on-contextmenu.prevent="" t-attf-style="top:{{state.draggerLinePosition - 2}}px;">
          <div class="dragging-resizer" t-if="state.isResizing"/>
        </div>
      </t>
      <t t-foreach="env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId())" t-as="hiddenItem" t-key="hiddenItem_index">
        <t t-if="!hiddenItem.includes(0)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="top:{{unhideStyleValue(hiddenItem[0]) - 17}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_UP"/>
          </div>
        </t>
        <t t-if="!hiddenItem.includes(env.model.getters.getNumberRows(env.model.getters.getActiveSheetId())-1)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="top:{{unhideStyleValue(hiddenItem[0]) + 3}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
          </div>
        </t>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColResizer">
    <div class="o-col-resizer" t-on-mousemove.self="onMouseMove" t-on-mouseleave="onMouseLeave" t-on-mousedown.self.prevent="select" t-ref="colResizer" t-on-mouseup.self="onMouseUp" t-on-contextmenu.self="onContextMenu" t-att-class="{'o-grab': state.waitingForMove, 'o-dragging': state.isMoving, }">
      <div t-if="state.isMoving" class="dragging-col-line" t-attf-style="left:{{state.draggerLinePosition}}px;"/>
      <div t-if="state.isMoving" class="dragging-col-shadow" t-attf-style="left:{{state.draggerShadowPosition}}px; width:{{state.draggerShadowThickness}}px"/>
      <t t-if="state.resizerIsActive">
        <div class="o-handle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick" t-on-contextmenu.prevent="" t-attf-style="left:{{state.draggerLinePosition - 2}}px;">
          <div class="dragging-resizer" t-if="state.isResizing"/>
        </div>
      </t>
      <t t-foreach="env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId())" t-as="hiddenItem" t-key="hiddenItem_index">
        <t t-if="!hiddenItem.includes(0)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="left:{{unhideStyleValue(hiddenItem[0]) - 17}}px; margin-right:6px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_LEFT"/>
          </div>
        </t>
        <t t-if="!hiddenItem.includes(env.model.getters.getNumberCols(env.model.getters.getActiveSheetId())-1)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="left:{{unhideStyleValue(hiddenItem[0]) + 3}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_RIGHT"/>
          </div>
        </t>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Border">
    <div class="o-border" t-on-mousedown.prevent="onMouseDown" t-att-style="style" t-att-class="{           'o-moving': props.isMoving,           'o-border-n': props.orientation === 'n',           'o-border-s': props.orientation === 's',           'o-border-w': props.orientation === 'w',           'o-border-e': props.orientation === 'e',         }"/>
  </t>

  <t t-name="o-spreadsheet-Corner">
    <div class="o-corner" t-on-mousedown.prevent="onMouseDown" t-att-style="style" t-att-class="{           'o-resizing': props.isResizing,           'o-corner-nw': props.orientation === 'nw',           'o-corner-ne': props.orientation === 'ne',           'o-corner-sw': props.orientation === 'sw',           'o-corner-se': props.orientation === 'se',         }"/>
  </t>

  <t t-name="o-spreadsheet-Highlight">
    <div class="o-highlight" t-ref="highlight">
      <t t-foreach="['n', 's', 'w', 'e']" t-as="orientation" t-key="orientation">
        <Border onMoveHighlight="(x, y) =&gt; this.onMoveHighlight(x,y)" isMoving="highlightState.shiftingMode === &quot;isMoving&quot;" orientation="orientation" zone="props.zone"/>
      </t>
      <t t-foreach="['nw', 'ne', 'sw', 'se']" t-as="orientation" t-key="orientation">
        <Corner onResizeHighlight="(isLeft, isTop) =&gt; this.onResizeHighlight(isLeft, isTop)" isResizing="highlightState.shiftingMode === &quot;isResizing&quot;" orientation="orientation" zone="props.zone" color="props.color"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconPicker">
    <div class="o-icon-picker">
      <t t-foreach="iconSets" t-as="iconSet" t-key="iconSet">
        <div class="o-cf-icon-line">
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].good)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].good].template}}"/>
          </div>
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].neutral)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].neutral].template}}"/>
          </div>
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].bad)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].bad].template}}"/>
          </div>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Icon.CLEAR_AND_RELOAD">
    <svg class="o-icon">
      <path fill="currentColor" d="M14 15H4V3h6v3h4M4 1.5A1.5 1.5 0 0 0 2.5 3v12a1.5 1.5 0 0 0 1.4 1.5h10a1.5 1.5 0 0 0 1.5-1.5V5l-3.5-3.5         "/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.EXPORT_XLSX">
    <svg class="o-icon">
      <path fill="currentColor" d="M0 1a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1m4-4V1H1v3m7 0V1H5v3M4 8V5H1v3m7 0V5H5v3m-3.5 2h2v4h3v-1.5l3 2.5-3 2.5V16h-5m9.5-6h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1h-6a1 1 0 0 1-1-1v-6a1 1 0 0 1 1-1m1.7 7 1.3-2 1.3 2h2l-2-3 2-3h-2L14 13l-1.3-2h-2l2 3-2 3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_READ_ONLY">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 7V5c0-2.5-2-4-4-4S5 2.5 5 5v2h-.5C3.5 7 3 7.5 3 8.5v7c0 1 .5 1.5 1.5 1.5h9c1 0 1.5-.5 1.5-1.5v-7c0-1-.5-1.5-1.5-1.5m-7-2c0-1.5 1-2.5 2.5-2.5s2.5 1 2.5 2.5v2h-5V5m1 7a1.5 1.5 0 0 1 3 0 1.5 1.5 0 0 1-3 0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_DASHBOARD">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 2.07A8 8 0 1 0 15.93 5L14.2 6A6 6 0 1 1 12 3.8m-2 3.47a2 2 0 1 0 .73.73l5.5-5.5-.6-.6M9.3 3.8a.6.6 0 1 1-.01-.01m1.81.51a.6.6 0 1 1-.01-.01M7.5 4.3a.6.6 0 1 1-.01-.01M5.9 5.4a.6.6 0 1 1-.01-.01M4.8 6.9a.6.6 0 1 1-.01-.01m8.71.61a.6.6 0 1 0-.01 0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_READ_WRITE">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 7V5a4 4 0 0 0-8 0v2h-.5C3.5 7 3 7.5 3 8.5v7c0 1 .5 1.5 1.5 1.5h9c1 0 1.5-.5 1.5-1.5v-7c0-1-.5-1.5-1.5-1.5m-7-2a2 2 0 0 1 5 0v2h-5m1 5a1.5 1.5 0 0 1 3 0 1.5 1.5 0 0 1-3 0m6 3.5h-9v-7h9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.IMPORT_XLSX">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 10a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1m4-4v-3h-3v3m7 0v-3h-3v3m-1 4v-3h-3v3m7 0v-3h-3v3M.5 9h2v4h3v-1.5l3 2.5-3 2.5V15h-5M1 0h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1a1 1 0 0 1 1-1m1.7 7L4 5l1.3 2h2l-2-3 2-3h-2L4 3 2.7 1h-2l2 3-2 3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNDO">
    <svg class="o-icon">
      <path fill="currentColor" d="M5.43 9.43 8 12H1V5l2.96 2.958A8.29 8.29 0 0 1 9.32 6c3.46 0 6.42 2.11 7.68 5l-2 1c-.94-2.39-3.13-3.92-5.68-4a6.57 6.57 0 0 0-3.89 1.43"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.REDO">
    <svg class="o-icon">
      <path fill="currentColor" d="M12.57 9.43 10 12h7V5l-2.96 2.96A8.29 8.29 0 0 0 8.68 6C5.22 6 2.26 8.11 1 11l2 1c.94-2.39 3.13-3.92 5.68-4a6.58 6.58 0 0 1 3.89 1.43"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.COPY">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 15.23v1.5H3a1 1 0 0 1-1-1V3.23h1.5v11a1 1 0 0 0 1 1h10m0-3.5a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h6.5a1 1 0 0 1 1 1m-9-2.5a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1H15a1 1 0 0 0 1-1v-11a1 1 0 0 0-1-1"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CUT">
    <svg class="o-icon">
      <path fill="currentColor" d="M3 2v2l4.5 5-1.2 1.3c-.4-.2-.8-.3-1.3-.3-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3c0-.5-.1-.9-.3-1.3L9 10.4l1.3 1.3c-.2.4-.3.8-.3 1.3 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3c-.5 0-.9.1-1.3.3L10.4 9 15 4.4V2h-.4L9 7.6 3.4 2H3Zm2 12.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5Zm9.5-1.5c0 .8-.7 1.5-1.5 1.5s-1.5-.7-1.5-1.5.7-1.5 1.5-1.5 1.5.7 1.5 1.5ZM9 8.5c.3 0 .5.2.5.5s-.2.5-.5.5-.5-.2-.5-.5.2-.5.5-.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PASTE">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 2.5H11C10.7 1.6 10 1 9 1s-1.5.5-2 1.5H3.5C2.5 2.5 2 3 2 4v11c0 1 .5 1.5 1.5 1.5h11c1 0 1.5-.5 1.5-1.5V4c0-1-.5-1.5-1.5-1.5Zm-4.75.75c0 .5-.34.75-.75.75s-.75-.34-.75-.75.34-.75.75-.75.75.34.75.75ZM14.5 15h-11V4H5v2.5h8V4h1.5v11"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FIND_AND_REPLACE">
    <svg class="o-icon">
      <path fill="currentColor" d="M10.75 11.25c-1 .75-2.25 1.25-3.5 1.25-3 0-5.5-2.5-5.5-5.5s2.5-5.5 5.5-5.5 5.5 2.5 5.5 5.5c0 1.25-.5 2.5-1.25 3.5l.25.25h.75l4 4-1.5 1.5-4-4v-.75l-.25-.25ZM7.25 11c2.25 0 4-1.75 4-4s-1.75-4-4-4-4 1.75-4 4 1.75 4 4 4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE">
    <svg class="o-icon">
      <path fill="currentColor" d="M12 1.75v-1H6v1H1.5v2h1v12a1.5 1.5 0 0 0 1.5 1.5h10a1.5 1.5 0 0 0 1.5-1.5v-12h1v-2M4 15.75v-12h10v12Zm2-10.5h2v9H6Zm4 0h2v9h-2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CLEAR">
    <svg class="o-icon">
      <path fill="currentColor" d="M1.5 15a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5M5.3 12.75c.1.1.3.2.5.2h4c.2 0 .4-.1.5-.2l5.5-5.5c.2-.3.2-.6 0-.8l-4.4-4.4c-.3-.2-.6-.2-.8 0l-4.8 4.8c-2.7 2.9-3.1 2.8-2.4 4M7 7.25l3.6 3.6-1 1-3.6.1-1.8-1.9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FREEZE">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 17.5h16a1 1 0 0 0 1-1v-15a1 1 0 0 0-1-1h-15a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1m9-10.5v4.5H6V7m0 9v-3.5h4.5V16M5 16H3.5L5 14.5M5 13l-3 3v-1.5l3-3M2 13v-2l3-3v2m-3-.5v-2l3-3v2M2 6V4l2-2h1v1m11 13h-4.5v-3.5H16m0-1h-4.5V7H16m0-5v4h-4.5V2m-1 4H6V2h4.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNFREEZE">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 17.5h16a1 1 0 0 0 1-1v-15a1 1 0 0 0-1-1h-15a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1M5 6H2V2h3m0 9.5H2V7h3m0 9H2v-3.5h3M10.5 7v4.5H6V7m0 9v-3.5h4.5V16m5.5 0h-4.5v-3.5H16m0-1h-4.5V7H16m0-5v4h-4.5V2m-1 4H6V2h4.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SHOW_HIDE_GRID">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v7H11V7H7v4s-.5 0-1.5 1h-1v5h-3a1.5 1.5 0 0 1-1-1M6 6V2H2v4m9 0V2H7v4m9 0V2h-4v4m-6 5V7H2v4m14-2V7h-4v2m-7.5 6.5V12H2v3.5 M14 10.5c1 0 1 .5 1 1-1.5 2.5-3.5 4.5-5 6.5-.5 0-1-.5-1-1-1-.5-1.5-1-2.5-2 0 0-.5-.5 0-1 1.5-2 4-3 7-3m-1 1.5C13.5 12 4 14 10 16c0 0-1.5-2 2.5-3.5m5 1.5c.5.5.5 1 .5 1-1.5 2-3.5 3-6 2.5.5-.5.5-1 1-1s5.5-1 2-3.5l1-1"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SHOW_HIDE_FORMULA">
    <svg class="o-icon">
      <path fill="currentColor" d="M7 14.25q-.25.75-.75 1.25T5 16q-.75 0-1.5-.5Q3 15 3 14.25q0-.5.25-.75t.75-.25q.25 0 .25.75v.5H5q.5 0 .5-.5l1.25-6.5H5V6h2l.5-2.25q.25-.75.75-1.25T9.5 2q1 0 1.5.5t.5 1q0 .5-.25.75t-.5.25q-.5 0-.75-.25t-.25-.5V3H9.5q-.25 0-.5.5L8.5 6H10v1.5H8.25m1.25 1H15v1h-4l2 2-2 2h4v1H9V14l2.5-2.5L9 9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.HIDE_ROW">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v3.5h14V2H2v9h14V7H2v9h14v-3.5H2M1 12l4-5h2l-4 5m2 0 4-5h2l-4 5m2 0 4-5h2l-4 5m2 0 4-5v4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.HIDE_COL">
    <svg class="o-icon">
      <path fill="currentColor" d="M16 .5A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2A1.5 1.5 0 0 1 2 .5h14V2h-3.5v14H16V2H7v14h4V2H2v14h3.5V2M6 1l5 4v2L6 3m0 2 5 4v2L6 7m0 2 5 4v2l-5-4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v3.5h14V2H2v9h14V7H2v9h14v-3.5H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW_BEFORE">
    <svg class="o-icon">
      <path fill="currentColor" d="M3.5 14.5A1.5 1.5 0 0 0 5 16h10a1.5 1.5 0 0 0 1.5-1.5v-7h-3V5h3V1.5A1.5 1.5 0 0 0 15 0H5a1.5 1.5 0 0 0-1.5 1.5v2h-3V9h3M15 12.5v2H5v-2M15 9v2H5V9m10-7.5v2H5v-2M12 5v2.5H2V5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW_AFTER">
    <svg class="o-icon">
      <path fill="currentColor" d="M3.5 1.5A1.5 1.5 0 0 1 5 0h10a1.5 1.5 0 0 1 1.5 1.5v7h-3V11h3v3.5A1.5 1.5 0 0 1 15 16H5a1.5 1.5 0 0 1-1.5-1.5v-2h-3V7h3M15 3.5v-2H5v2M15 7V5H5v2m10 7.5v-2H5v2m7-3.5V8.5H2V11"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h3.5V2H2h5v14h4V2H2h10.5v14H16V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL_AFTER">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 3A1.5 1.5 0 0 0 1 4.5v10A1.5 1.5 0 0 0 2.5 16h7v-3H12v3h3.5a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 3h-2V0H8v3M4.5 14.5h-2v-10h2m3.5 10H6v-10h2m7.5 10h-2v-10h2m-3.5 7H9.5v-10H12"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL_BEFORE">
    <svg class="o-icon">
      <path fill="currentColor" d="M15.5 3A1.5 1.5 0 0 1 17 4.5v10a1.5 1.5 0 0 1-1.5 1.5h-7v-3H6v3H2.5A1.5 1.5 0 0 1 1 14.5v-10A1.5 1.5 0 0 1 2.5 3h2V0H10v3m3.5 11.5h2v-10h-2m-3.5 10h2v-10h-2m-7.5 10h2v-10h-2m3.5 7h2.5v-10H6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL_SHIFT_DOWN">
    <svg class="o-icon">
      <path fill="currentColor" d="M5 2.5A1.5 1.5 0 0 1 6.5 1h10A1.5 1.5 0 0 1 18 2.5v13a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 5 15.5v-5h5.25v-3H5m11.5-2v-3h-4.75v3m-1.5 0v-3H6.5v3m10 5v-3h-4.75v3m-1.5 5v-3H6.5v3m10 0v-3h-4.75v3M0 12.5l2.5 4 2.5-4H3.25v-6h-1.5v6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL_SHIFT_RIGHT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 5A1.5 1.5 0 0 0 1 6.5v10A1.5 1.5 0 0 0 2.5 18h13a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 5h-5v5.25h-3V5m-2 11.5h-3v-4.75h3m0-1.5h-3V6.5h3m5 10h-3v-4.75h3m5-1.5h-3V6.5h3m0 10h-3v-4.75h3M12.5 0l4 2.5-4 2.5V3.25h-6v-1.5h6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE_CELL_SHIFT_UP">
    <svg class="o-icon">
      <path fill="currentColor" d="M5 2.5A1.5 1.5 0 0 1 6.5 1h10A1.5 1.5 0 0 1 18 2.5v13a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 5 15.5v-5h5.25v-3H5m11.5-2v-3h-4.75v3m-1.5 0v-3H6.5v3m10 5v-3h-4.75v3m-1.5 5v-3H6.5v3m10 0v-3h-4.75v3M0 10l2.5-4L5 10H3.25v6h-1.5v-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE_CELL_SHIFT_LEFT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 5A1.5 1.5 0 0 0 1 6.5v10A1.5 1.5 0 0 0 2.5 18h13a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 5h-5v5.25h-3V5m-2 11.5h-3v-4.75h3m0-1.5h-3V6.5h3m5 10h-3v-4.75h3m5-1.5h-3V6.5h3m0 10h-3v-4.75h3M10 0 6 2.5 10 5V3.25h6v-1.5h-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CHART">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2m1.5 12.5h2v-7h-2m3 7h2v-10h-2m3 10h2v-5h-2m3 5h2v-11h-2M2 14.5h14v1H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_IMAGE">
    <svg class="o-icon" fill="currentColor">
      <path d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2m10 4.5L10 11 8.5 9.5l-2 2.5L5 10.5l-2 3h12M3.5,5a1.5,1.5,0,0,1,3,0a1.5,1.5,0,0,1,-3,0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_LINK">
    <svg class="o-icon" fill="currentColor">
      <path d="M6.88 13.69c.19-.19.41-.28.68-.28.27 0 .51.09.72.28.43.45.43.92 0 1.4l-.84.8c-.75.75-1.63 1.12-2.64 1.12-1.04 0-1.93-.37-2.68-1.12C1.37 15.14 1 14.26 1 13.25c0-1.04.37-1.93 1.12-2.68l2.96-2.96c.93-.9 1.89-1.42 2.88-1.54.98-.12 1.84.17 2.56.86.21.21.32.45.32.72 0 .26-.1.51-.32.72-.48.43-.95.43-1.4 0-.67-.64-1.55-.41-2.67.68l-2.93 2.92c-.35.35-.52.77-.52 1.28s.17.92.52 1.24c.35.35.76.52 1.26.52.49 0 .91-.17 1.26-.52l.84-.8m9-11.48c.75.75 1.12 1.63 1.12 2.64 0 1.04-.37 1.94-1.12 2.68l-3.16 3.16c-.99.96-1.99 1.44-3 1.44-.83 0-1.57-.33-2.24-1a.913.913 0 0 1-.28-.68c0-.27.09-.5.27-.72.19-.19.43-.28.71-.28.28 0 .51.09.7.28.66.64 1.48.48 2.44-.48l3.16-3.12c.37-.37.56-.8.56-1.28 0-.51-.19-.92-.56-1.24-.32-.35-.7-.56-1.12-.62-.43-.07-.83.07-1.2.42l-1 1c-.22.19-.45.28-.72.28-.26 0-.5-.09-.68-.28-.46-.45-.46-.92 0-1.4l1-1c.72-.72 1.56-1.06 2.54-1.02.97.04 1.83.45 2.58 1.22"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_SHEET">
    <svg class="o-icon" fill="currentColor">
      <path d="M17.5 5.5V16a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2A1.5 1.5 0 0 1 2 .5h10.5M2 5.5h3.5V2H2m5.25 3.5h3.5V2h-3.5M2 10.75h3.5v-3.5H2m5.25 3.5h3.5v-3.5h-3.5m5.25 3.5H16v-3.5h-3.5M2 16h3.5v-3.5H2M7.25 16h3.5v-3.5h-3.5M12.5 16H16v-3.5h-3.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PAINT_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M9,0 L1,0 C0.45,0 0,0.45 0,1 L0,4 C0,4.55 0.45,5 1,5 L9,5 C9.55,5 10,4.55 10,4 L10,3 L11,3 L11,6 L4,6 L4,14 L6,14 L6,8 L13,8 L13,2 L10,2 L10,1 C10,0.45 9.55,0 9,0 Z" transform="translate(3 2)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CONDITIONAL_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M12.25.5c2 0 3.5 1.5 3.5 3.5v6.5c0 .5 0 2-2 2h-2.5v4c0 .5-.5 1-1 1h-2.5c-.5 0-1-.5-1-1v-4h-2.5c-1 0-2-1-2-2V.5m12 3a1.5 1.5 0 0 0-1.5-1.5h-3v2h-1.5V2h-1v4h-2V2h-1.5v8.5h10.5m-12-3h12.5V9H2.25"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CLEAR_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.12 4.05 7.28 9.2l-2.43 5.3h2.5l1.64-3.58 4.59 4.58 1.27-1.27L3.4 2.77 2.12 4.05ZM5.67 2.5l2 2h1.76l-.55 1.21 1.71 1.71 1.34-2.92h3.92v-2H5.67"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_DOWN">
    <svg class="o-icon">
      <polygon fill="currentColor" points="0 0 4 4 8 0" transform="translate(5 7)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_UP">
    <svg class="o-icon">
      <polygon fill="currentColor" points="4 0 0 4 8 4" transform="translate(5 7)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_RIGHT">
    <svg class="o-icon">
      <polygon fill="currentColor" points="0 0 4 4 0 8" transform="translate(5 5)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_LEFT">
    <svg class="o-icon">
      <polygon fill="currentColor" points="4 0 0 4 4 8" transform="translate(5 5)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BOLD">
    <svg class="o-icon">
      <path fill="currentColor" d="M13.5 6.5C13.5 4.57 11.93 3 10 3H4.5v12h6.25c1.79 0 3.25-1.46 3.25-3.25 0-1.3-.77-2.41-1.87-2.93.83-.58 1.37-1.44 1.37-2.32M9.5 5c.83 0 1.5.67 1.5 1.5S10.33 8 9.5 8h-2V5h2m-2 8v-3H10c.83 0 1.5.67 1.5 1.5S10.83 13 10 13H7.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ITALIC">
    <svg class="o-icon">
      <path fill="currentColor" d="M7 3v2h2.58l-3.66 8H3v2h8v-2H8.42l3.66-8H15V3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNDERLINE">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 15c2.76 0 5-2.24 5-5V3h-2v7c0 1.75-1.5 3-3 3s-3-1.242-3-3V3H4v7c0 2.76 2.24 5 5 5Zm-6 1v2h12v-2H3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.STRIKE">
    <svg class="o-icon">
      <path fill="currentColor" d="M4.89 6.06c0-.46.1-.87.3-1.25.2-.38.46-.7.84-.97s.78-.47 1.28-.62A5.71 5.71 0 0 1 8.93 3c.61 0 1.16.08 1.65.25.5.17.92.4 1.27.7.35.3.62.66.81 1.07.19.41.28.87.28 1.36h-2.26a1.85 1.85 0 0 0-.11-.64 1.26 1.26 0 0 0-.33-.51 1.53 1.53 0 0 0-.56-.33A2.42 2.42 0 0 0 8.89 4.8c-.3 0-.55.03-.77.1a1.52 1.52 0 0 0-.54.27 1.14 1.14 0 0 0-.43.9c0 .36.18.66.55.91l.06.04C8.02 7.19 8.5 7.5 9 8H6s-.79-.62-.82-.69c-.19-.36-.29-.77-.29-1.25M16 9H2v2h7.22c.14.05.3.1.41.15.28.12.5.26.65.38.16.13.26.27.32.42.06.15.08.33.08.51 0 .18-.03.34-.1.49a1.02 1.02 0 0 1-.31.39 1.6 1.6 0 0 1-.53.26 2.71 2.71 0 0 1-.76.09c-.33 0-.62-.03-.89-.1a1.8 1.8 0 0 1-.68-.31 1.45 1.45 0 0 1-.44-.56c-.11-.23-.19-.57-.19-.74H4.55c0 .25.06.69.18 1.02a3.15 3.15 0 0 0 1.22 1.6c.28.2.58.36.92.49.33.13.67.23 1.04.29.36.06.72.09 1.08.09.6 0 1.15-.07 1.64-.21a3.88 3.88 0 0 0 1.25-.59 2.69 2.69 0 0 0 .8-.95c.19-.38.28-.81.28-1.29 0-.45-.08-.86-.23-1.211a2.26 2.26 0 0 0-.13-.25L16 11V9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TEXT_COLOR">
    <svg class="o-icon">
      <path fill="currentColor" d="M10 1H8L3.5 13h2l1.12-3h4.75l1.12 3h2L10 1ZM7.38 8 9 3.67 10.62 8H7.38"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILL_COLOR">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 8.87S13 10.49 13 11.49c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5c0-.99-1.5-2.62-1.5-2.62m-1.79-2.08L5.91 0 4.85 1.06l1.59 1.59-4.15 4.14a.996.996 0 0 0 0 1.41l4.5 4.5c.2.2.45.3.71.3.26 0 .51-.1.71-.29l4.5-4.5c.39-.39.39-1.03 0-1.42M4.21 7 7.5 3.71 10.79 7H4.21"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MERGE_CELL">
    <svg class="o-icon">
      <path fill="currentColor" d="M3 6H1V2h7v2H3v2m7-2V2h7v4h-2V4h-5m0 10h5v-2h2v4h-7v-2m-9-2h2v2h5v2H1v-4m0-4h4V6l3 3-3 3v-2H1V8m9 1 3-3v2h4v2h-4v2l-3-3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_LEFT">
    <svg class="o-icon align-left">
      <path fill="currentColor" d="M2 16h10v-2H2v2M12 6H2v2h10V6M2 2v2h14V2H2m0 10h14v-2H2v2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_CENTER">
    <svg class="o-icon align-center">
      <path fill="currentColor" d="M4 14v2h10v-2H4m0-8v2h10V6H4m-2 6h14v-2H2v2M2 2v2h14V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_RIGHT">
    <svg class="o-icon align-right">
      <path fill="currentColor" d="M6 16h10v-2H6v2m-4-4h14v-2H2v2M2 2v2h14V2H2m4 6h10V6H6v2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_TOP">
    <svg class="o-icon align-top">
      <path d="M3 2h12v2H3m2.5 5H8v7h2V9h2.5L9 5.5" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_MIDDLE">
    <svg class="o-icon align-middle">
      <path d="M12.5 3H10V0H8v3H5.5L9 6.5M5.5 15H8v3h2v-3h2.5L9 11.5M3 8v2h12V8" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_BOTTOM">
    <svg class="o-icon align-bottom">
      <path d="M5.5 9H8V2h2v7h2.5L9 12.5M3 14v2h12v-2" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_OVERFLOW">
    <svg class="o-icon wrapping-overflow">
      <path d="M13 8H6v2h7v2l3-3-3-3M2 2h2v14H2M9 2h2v4H9m0 6h2v4H9" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_WRAP">
    <svg class="o-icon wrapping-wrap">
      <path fill="currentColor" d="M6 5v2h3.75c.75 0 1.5.67 1.5 1.5 0 .75-.75 1.5-1.5 1.5H8V8l-3 3 3 3v-2h1.5c2 0 3.5-1.5 3.5-3.5S11.5 5 9.5 5M2 2h2v14H2M14 2M14,2,h2v14h-2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_CLIP">
    <svg class="o-icon wrapping-clip">
      <path fill="currentColor" d="M2 2h2v14H2M14 2h2v14h-2v-6H6V8h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDERS">
    <svg class="o-icon">
      <path fill="currentColor" d="M2 2v14h14V2H2m6 12H4v-4h4v4m0-6H4V4h4v4m6 6h-4v-4h4v4m0-6h-4V4h4v4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_HV">
    <svg class="o-icon" fill="currentColor">
      <path d="M2 16h2v-2H2v2M4 5H2v2h2V5m1 11h2v-2H5v2m8-14h-2v2h2V2M4 2H2v2h2V2m3 0H5v2h2V2M2 13h2v-2H2v2m9 3h2v-2h-2v2m3-14v2h2V2h-2m0 5h2V5h-2v2m0 9h2v-2h-2v2m0-3h2v-2h-2v2" opacity=".54"/>
      <path d="M10 2H8v6H2v2h6v6h2v-6h6V8h-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_H">
    <svg class="o-icon" fill="currentColor">
      <path d="M8 16h2v-2H8v2M5 4h2V2H5v2m3 9h2v-2H8v2m-3 3h2v-2H5v2M2 7h2V5H2v2m0 9h2v-2H2v2M2 4h2V2H2v2m0 9h2v-2H2v2m12 0h2v-2h-2v2m0 3h2v-2h-2v2m0-9h2V5h-2v2m0-5v2h2V2h-2M8 4h2V2H8v2m3 0h2V2h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2" opacity=".54"/>
      <path d="M2 10h14V8H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_V">
    <svg class="o-icon" fill="currentColor">
      <path d="M5 16h2v-2H5v2M2 7h2V5H2v2m0-3h2V2H2v2m3 6h2V8H5v2m0-6h2V2H5v2M2 16h2v-2H2v2m0-6h2V8H2v2m0 3h2v-2H2v2M14 2v2h2V2h-2m0 8h2V8h-2v2m0 6h2v-2h-2v2m0-9h2V5h-2v2m0 6h2v-2h-2v2m-3 3h2v-2h-2v2m0-6h2V8h-2v2m0-6h2V2h-2v2" opacity=".54"/>
      <path d="M8 16h2V2H8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_EXTERNAL">
    <svg class="o-icon" fill="currentColor">
      <path d="M10 5H8v2h2V5m3 3h-2v2h2V8m-3 0H8v2h2V8m0 3H8v2h2v-2M7 8H5v2h2V8" opacity=".54"/>
      <path d="M2 2h14v14H2V2m12 12V4H4v10h10"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_LEFT">
    <svg class="o-icon" fill="currentColor">
      <path d="M8 10h2V8H8v2m0-3h2V5H8v2m0 6h2v-2H8v2m0 3h2v-2H8v2m-3 0h2v-2H5v2M5 4h2V2H5v2m0 6h2V8H5v2m9 6h2v-2h-2v2m0-6h2V8h-2v2m0 3h2v-2h-2v2m0-6h2V5h-2v2M8 4h2V2H8v2m6-2v2h2V2h-2m-3 14h2v-2h-2v2m0-6h2V8h-2v2m0-6h2V2h-2v2" opacity=".54"/>
      <path d="M2 16h2V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_TOP">
    <svg class="o-icon" fill="currentColor">
      <path d="M5 10h2V8H5v2m-3 6h2v-2H2v2m6 0h2v-2H8v2m0-3h2v-2H8v2m-3 3h2v-2H5v2m-3-3h2v-2H2v2m6-3h2V8H8v2M2 7h2V5H2v2m0 3h2V8H2v2m12 0h2V8h-2v2m0 3h2v-2h-2v2m0-6h2V5h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2m0-6h2V8h-2v2m3 6h2v-2h-2v2" opacity=".54"/>
      <path d="M2 2v2h14V2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_RIGHT">
    <svg class="o-icon" fill="currentColor">
      <path d="M2 4h2V2H2v2m3 0h2V2H5v2m0 6h2V8H5v2m0 6h2v-2H5v2M2 7h2V5H2v2m0 3h2V8H2v2m0 6h2v-2H2v2m0-3h2v-2H2v2m9-3h2V8h-2v2m-3 6h2v-2H8v2m3 0h2v-2h-2v2M8 4h2V2H8v2m3 0h2V2h-2v2m-3 9h2v-2H8v2m0-6h2V5H8v2m0 3h2V8H8v2" opacity=".54"/>
      <path d="M14 2v14h2V2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_BOTTOM">
    <svg class="o-icon" fill="currentColor">
      <path d="M7 2H5v2h2V2m3 6H8v2h2V8m0 3H8v2h2v-2m3-3h-2v2h2V8M7 8H5v2h2V8m6-6h-2v2h2V2m-3 3H8v2h2V5m0-3H8v2h2V2m-6 9H2v2h2v-2m10 2h2v-2h-2v2m0-6h2V5h-2v2m0 3h2V8h-2v2m0-8v2h2V2h-2M4 2H2v2h2V2m0 3H2v2h2V5m0 3H2v2h2V8" opacity=".54"/>
      <path d="M2 16h14v-2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_CLEAR">
    <svg class="o-icon">
      <path fill="currentColor" d="M8 16h2v-2H8v2m-3-6h2V8H5v2m0-6h2V2H5v2m3 9h2v-2H8v2m-3 3h2v-2H5v2M2 7h2V5H2v2m0 9h2v-2H2v2M2 4h2V2H2v2m0 6h2V8H2v2m6 0h2V8H8v2m-6 3h2v-2H2v2m12 0h2v-2h-2v2m0 3h2v-2h-2v2m0-6h2V8h-2v2m0-3h2V5h-2v2m0-5v2h2V2h-2M8 4h2V2H8v2m3 0h2V2h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2m0-6h2V8h-2v2" opacity=".54"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_TYPE">
    <svg class="o-icon">
      <g fill="currentColor" transform="translate(2 2)">
        <polygon points="0 0 0 2 14 2 14 0"/>
        <polygon points="0 6 0 8 5 8 5 6"/>
        <polygon points="9 6 9 8 14 8 14 6"/>
        <polygon points="0 12 0 14 2 14 2 12"/>
        <polygon points="4 12 4 14 6 14 6 12"/>
        <polygon points="8 12 8 14 10 14 10 12"/>
        <polygon points="12 12 12 14 14 14 14 12"/>
      </g>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_COLOR">
    <svg class="o-icon">
      <g fill="currentColor" transform="translate(4 2)">
        <polygon points="0 12 0 9 7 2 10 5 3 12"/>
        <polygon points="8 1 9 0 12 3 11 4"/>
      </g>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_NO_COLOR">
    <svg class="o-icon">
      <g fill="currentColor">
        <polygon points="4 12 4 9 11 2 14 5 7 12"/>
        <polygon points="12 1 13 0 16 3 15 4"/>
      </g>
      <g>
        <rect x="0" y="14" width="18" height="4" stroke="black" fill="none"/>
      </g>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.PLUS">
    <svg class="o-icon plus" viewBox="0 0 18 18">
      <path fill="currentColor" d="M8 0h2v8h8v2h-8v8H8v-8H0V8h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MINUS">
    <svg class="o-icon minus" viewBox="0 0 18 18">
      <path fill="currentColor" d="M0 8h18v2H0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.LIST">
    <svg class="o-icon" viewBox="0 0 384 384">
      <rect x="0" y="277.333" width="384" height="42.667" fill="currentColor"/>
      <rect x="0" y="170.667" width="384" height="42.667" fill="currentColor"/>
      <rect x="0" y="64" width="384" height="42.667" fill="currentColor"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.EDIT">
    <svg class="o-icon" viewBox="0 0 576 512">
      <path fill="currentColor" d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNLINK">
    <svg class="o-icon" viewBox="0 0 512 512">
      <path fill="currentColor" d="M304.083 405.907c4.686 4.686 4.686 12.284 0 16.971l-44.674 44.674c-59.263 59.262-155.693 59.266-214.961 0-59.264-59.265-59.264-155.696 0-214.96l44.675-44.675c4.686-4.686 12.284-4.686 16.971 0l39.598 39.598c4.686 4.686 4.686 12.284 0 16.971l-44.675 44.674c-28.072 28.073-28.072 73.75 0 101.823 28.072 28.072 73.75 28.073 101.824 0l44.674-44.674c4.686-4.686 12.284-4.686 16.971 0l39.597 39.598zm-56.568-260.216c4.686 4.686 12.284 4.686 16.971 0l44.674-44.674c28.072-28.075 73.75-28.073 101.824 0 28.072 28.073 28.072 73.75 0 101.823l-44.675 44.674c-4.686 4.686-4.686 12.284 0 16.971l39.598 39.598c4.686 4.686 12.284 4.686 16.971 0l44.675-44.675c59.265-59.265 59.265-155.695 0-214.96-59.266-59.264-155.695-59.264-214.961 0l-44.674 44.674c-4.686 4.686-4.686 12.284 0 16.971l39.597 39.598zm234.828 359.28l22.627-22.627c9.373-9.373 9.373-24.569 0-33.941L63.598 7.029c-9.373-9.373-24.569-9.373-33.941 0L7.029 29.657c-9.373 9.373-9.373 24.569 0 33.941l441.373 441.373c9.373 9.372 24.569 9.372 33.941 0z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.CARET_UP">
    <svg class="caret-up" viewBox="0 0 320 512">
      <path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_DOWN">
    <svg class="caret-down" viewBox="0 0 320 512">
      <path fill="currentColor" d="M31.3 192h257.3c17.8 0 26.7 21.5 14.1 34.1L174.1 354.8c-7.8 7.8-20.5 7.8-28.3 0L17.2 226.1C4.6 213.5 13.5 192 31.3 192z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_RIGHT">
    <svg class="o-icon caret-right" viewBox="0 0 192 512">
      <path d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_LEFT">
    <svg class="o-icon caret-left" viewBox="0 0 192 512">
      <path d="M192 127.338v257.324c0 17.818-21.543 26.741-34.142 14.142L29.196 270.142c-7.81-7.81-7.81-20.474 0-28.284l128.662-128.662c12.599-12.6 34.142-3.676 34.142 14.142z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.TRASH">
    <svg class="o-cf-icon trash" viewBox="0 0 448 512">
      <path fill="currentColor" d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.REFRESH">
    <svg class="o-cf-icon refresh" viewBox="0 0 512 512">
      <path fill="currentColor" d="M440.65 12.57l4 82.77A247.16 247.16 0 0 0 255.83 8C134.73 8 33.91 94.92 12.29 209.82A12 12 0 0 0 24.09 224h49.05a12 12 0 0 0 11.67-9.26 175.91 175.91 0 0 1 317-56.94l-101.46-4.86a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12H500a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12h-47.37a12 12 0 0 0-11.98 12.57zM255.83 432a175.61 175.61 0 0 1-146-77.8l101.8 4.87a12 12 0 0 0 12.57-12v-47.4a12 12 0 0 0-12-12H12a12 12 0 0 0-12 12V500a12 12 0 0 0 12 12h47.35a12 12 0 0 0 12-12.6l-4.15-82.57A247.17 247.17 0 0 0 255.83 504c121.11 0 221.93-86.92 243.55-201.82a12 12 0 0 0-11.8-14.18h-49.05a12 12 0 0 0-11.67 9.26A175.86 175.86 0 0 1 255.83 432z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.ARROW_DOWN">
    <svg class="o-cf-icon arrow-down" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#DC6965" t-att-style="color" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ARROW_UP">
    <svg class="o-cf-icon arrow-up" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#00A04A" t-att-style="color" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ARROW_RIGHT">
    <svg class="o-cf-icon arrow-right" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#F0AD4E" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.SMILE">
    <svg class="o-cf-icon smile" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#00A04A" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm4 72.6c-20.8 25-51.5 39.4-84 39.4s-63.2-14.3-84-39.4c-8.5-10.2-23.7-11.5-33.8-3.1-10.2 8.5-11.5 23.6-3.1 33.8 30 36 74.1 56.6 120.9 56.6s90.9-20.6 120.9-56.6c8.5-10.2 7.1-25.3-3.1-33.8-10.1-8.4-25.3-7.1-33.8 3.1z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MEH">
    <svg class="o-cf-icon meh" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#F0AD4E" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm8 144H160c-13.2 0-24 10.8-24 24s10.8 24 24 24h176c13.2 0 24-10.8 24-24s-10.8-24-24-24z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FROWN">
    <svg class="o-cf-icon frown" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#DC6965" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm-80 128c-40.2 0-78 17.7-103.8 48.6-8.5 10.2-7.1 25.3 3.1 33.8 10.2 8.4 25.3 7.1 33.8-3.1 16.6-19.9 41-31.4 66.9-31.4s50.3 11.4 66.9 31.4c8.1 9.7 23.1 11.9 33.8 3.1 10.2-8.5 11.5-23.6 3.1-33.8C326 321.7 288.2 304 248 304z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.GREEN_DOT">
    <svg class="o-cf-icon green-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#00A04A" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.YELLOW_DOT">
    <svg class="o-cf-icon yellow-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#F0AD4E" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.RED_DOT">
    <svg class="o-cf-icon red-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#DC6965" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_RANGE">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 3.5h8v2H9M9 8h6v2H9m0 2.5h3v2H9M6 6l1-1-3-3-3 3 1 1 1-1v8l-1-1-1 1 3 3 3-3-1-1-1 1V5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_ASCENDING">
    <svg class="o-icon" fill="currentColor">
      <path d="m3 13-1-1-1 1 3 3 3-3-1-1-1 1V0H3"/>
      <text x="9" y="7" class="small-text">A</text>
      <text x="9.3" y="15" class="small-text">Z</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_DESCENDING">
    <svg class="o-icon" fill="currentColor">
      <path d="m3 13.9-1-1-1 1 3 3 3-3-1-1-1 1V.9H3"/>
      <text x="9.3" y="7.9" class="small-text">Z</text>
      <text x="9" y="15.9" class="small-text">A</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DATA_CLEANUP">
    <svg class="o-icon" fill="currentColor">
      <path d="m13.6 6.4-2.1-2.1c-.4-.4-1-.4-1.4 0l-8.8 8.9c-.4.4-.4 1 0 1.4l2.1 2.1c.4.4 1 .4 1.4 0l8.8-8.9c.4-.4.4-1 0-1.4M8 8.5 10.5 6l1.4 1.4-2.5 2.5m3-7 1.8.8.8 1.8.8-1.8 1.8-.8-1.8-.8L14.9.4l-.8 1.8M3.5 4l1.7.7.8 1.8.8-1.8 1.8-.8-1.8-.8-.8-1.8-.8 1.8zm13.5 7.7-1.8-.8-.8-1.8-.8 1.8-1.8.8 1.8.8.8 1.8.7-1.8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON">
    <svg class="o-cf-icon filter-icon" width="10" height="10" focusable="false" viewBox="0 0 850 850">
      <path fill="currentColor" d="M 339.667 681 L 510.333 681 L 510.333 595.667 L 339.667 595.667 L 339.667 681 Z M 41 169 L 41 254.333 L 809 254.333 L 809 169 L 41 169 Z M 169 467.667 L 681 467.667 L 681 382.333 L 169 382.333 L 169 467.667 Z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON_ACTIVE">
    <svg class="o-cf-icon filter-icon-active" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M487.976 0H24.028C2.71 0-8.047 25.866 7.058 40.971L192 225.941V432c0 7.831 3.821 15.17 10.237 19.662l80 55.98C298.02 518.69 320 507.493 320 487.98V225.941l184.947-184.97C520.021 25.896 509.338 0 487.976 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON_INACTIVE">
    <svg class="o-cf-icon filter-icon-inactive" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M487.976 0H24.028C2.71 0-8.047 25.866 7.058 40.971L192 225.941V432c0 7.831 3.821 15.17 10.237 19.662l80 55.98C298.02 518.69 320 507.493 320 487.98V225.941l184.947-184.97C520.021 25.896 509.338 0 487.976 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MENU_FILTER_ICON">
    <svg class="o-icon">
      <path fill="currentColor" d="M16.6.5H1.29C.59.5.23 1.35.73 1.85l6.1 6.1v6.8c0 .26.13.5.34.65l2.64 1.85a.79.79 0 0 0 1.25-.65V7.96l6.1-6.1A.79.79 0 0 0 16.6.51"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SEARCH">
    <svg class="search-icon" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M500.3 443.7l-119.7-119.7c27.22-40.41 40.65-90.9 33.46-144.7C401.8 87.79 326.8 13.32 235.2 1.723C99.01-15.51-15.51 99.01 1.724 235.2c11.6 91.64 86.08 166.7 177.6 178.9c53.8 7.189 104.3-6.236 144.7-33.46l119.7 119.7c15.62 15.62 40.95 15.62 56.57 0C515.9 484.7 515.9 459.3 500.3 443.7zM79.1 208c0-70.58 57.42-128 128-128s128 57.42 128 128c0 70.58-57.42 128-128 128S79.1 278.6 79.1 208z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CHECK">
    <svg class="o-icon" viewBox="0 0 24 24">
      <path fill="currentColor" d="M18.707 7.293a1 1 0 0 1 0 1.414L11.414 16a2 2 0 0 1-2.828 0l-3.293-3.293a1 1 0 1 1 1.414-1.414L10 14.586l7.293-7.293a1 1 0 0 1 1.414 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PERCENT">
    <span class="o-text-icon">%</span>
  </t>
  <t t-name="o-spreadsheet-Icon.DECRASE_DECIMAL">
    <span class="o-text-icon">.0</span>
  </t>
  <t t-name="o-spreadsheet-Icon.INCREASE_DECIMAL">
    <span class="o-text-icon">.00</span>
  </t>
  <t t-name="o-spreadsheet-Icon.NUMBER_FORMATS">
    <svg class="o-icon" fill="currentColor">
      <path d="M0 6h2v8h2V4H0m9 0H5v2h4v2H6.5A1.5 1.5 0 0 0 5 9.5V14h6v-2H7v-2h2.5A1.5 1.5 0 0 0 11 8.5v-3A1.5 1.5 0 0 0 9.5 4M12 4v2h4v2h-2v2h2v2h-4v2h4.5a1.5 1.5 0 0 0 1.5-1.5v-2A1.5 1.5 0 0 0 16.5 9 1.5 1.5 0 0 0 18 7.5v-2A1.5 1.5 0 0 0 16.5 4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FONT_SIZE">
    <svg class="o-icon" fill="currentColor">
      <text x="2" y="15" class="small-text">A</text>
      <text x="6" y="15" class="heavy-text">A</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_EXCLAMATION">
    <svg class="o-icon" viewBox="0 0 512 512">
      <path fill="currentColor" d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SPLIT_TEXT">
    <svg class="o-icon">
      <path fill="currentColor" d="M14 6v2h-4v2h4v2l3-3m-9 1V8H4V6L1 9l3 3v-2m3.5-6.5h3V7H12V3.5h3V2H3v1.5h3V7h1.5m3 7.5h-3V11H6v3.5H3V16h12v-1.5h-3V11h-1.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ERROR">
    <svg class="error-icon" width="14" height="14" viewBox="0 0 512 512">
      <path fill="currentColor" d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DISPLAY_HEADER">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M.75.5h16.5v17H.75m1.5-12H.75V7h1.5v1.5H.75V10h1.5v1.5H.75V13h1.5v1.5H.75V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v-1.5h-1.5V13h1.5v-1.5h-1.5V10h1.5V8.5h-1.5V7h1.5V5.5M2.75 2.25v1.5h2v-1.5m2.5 0v1.5h7v-1.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.COG">
    <svg fill="currentColor" viewBox="0 0 16 16">
      <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
      <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PLUS_IN_BOX">
    <svg class="o-icon" width="18" height="18" style="fill:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5">
      <path stroke="currentColor" d="M1.5,1.5h15v15h-15v-15M9,5v8M5,9h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GROUP_ROWS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M6 2.5A1.5 1.5 0 0 1 7.5 1H16a1.5 1.5 0 0 1 1.5 1.5V15a1.5 1.5 0 0 1-1.5 1.5H7.5A1.5 1.5 0 0 1 6 15M7.5 2.5v2H16v-2M7.5 6v2H16V6M7.5 9.5v2H16v-2M7.5 13v2H16v-2M2 5.75V13h3v-1.5H3.5V5.75h1.25V3l-1 1v.75H3M.25 1.25v4.5h4.5v-4.5m-3.5 1h2.5v2.5h-2.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNGROUP_ROWS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M6 2.5A1.5 1.5 0 0 1 7.5 1H16a1.5 1.5 0 0 1 1.5 1.5V15a1.5 1.5 0 0 1-1.5 1.5H7.5A1.5 1.5 0 0 1 6 15M7.5 2.5v2H16v-2M7.5 6v2H16V6M7.5 9.5v2H16v-2M7.5 13v2H16v-2M2 5.75V13h3v-1.5H3.5V5.75M0 5.25.75 6l2-2 2 2 .75-.75-2-2 2-2L4.75.5l-2 2-2-2-.75.75 2 2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GROUP_COLUMNS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M2.75 6a1.5 1.5 0 0 0-1.5 1.5V16a1.5 1.5 0 0 0 1.5 1.5h12.5a1.5 1.5 0 0 0 1.5-1.5V7.5a1.5 1.5 0 0 0-1.5-1.5M2.75 7.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2M6 2h7.25v3h-1.5V3.5H6v1.25H3.25l1-1H5V3M1.5.25H6v4.5H1.5m1-3.5v2.5H5v-2.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNGROUP_COLUMNS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M2.75 6a1.5 1.5 0 0 0-1.5 1.5V16a1.5 1.5 0 0 0 1.5 1.5h12.5a1.5 1.5 0 0 0 1.5-1.5V7.5a1.5 1.5 0 0 0-1.5-1.5M2.75 7.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2M6 2h7.25v3h-1.5V3.5H6M5.5 0l.75.75-2 2 2 2-.75.75-2-2-2 2-.75-.75 2-2-2-2L1.5 0l2 2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DATA_VALIDATION">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v7H11V7H7v4s-.5 0-1.5 1h-1v5h-3a1.5 1.5 0 0 1-1-1M6 6V2H2v4m9 0V2H7v4m9 0V2h-4v4m-6 5V7H2v4m14-2V7h-4v2m-7.5 6.5V12H2v3.5"/>
      <path stroke="currentColor" style="fill:none; stroke-linecap:round; stroke-width:1.5" d="M8,13 l3 3 l6 -5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.THIN_DRAG_HANDLE">
    <svg class="o-icon" viewBox="0 0 4 16" fill="currentColor">
      <circle cx="2" cy="3.5" r="1"/>
      <circle cx="2" cy="6.5" r="1"/>
      <circle cx="2" cy="9.5" r="1"/>
      <circle cx="2" cy="12.5" r="1"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-LinkDisplay">
    <div class="o-link-tool d-flex align-items-center">

      <img t-if="link.isExternal" t-key="link.url" t-attf-src="https://www.google.com/s2/favicons?sz=16&amp;domain={{link.url}}"/>
      <a t-if="link.isExternal" class="o-link" t-att-href="link.url" target="_blank" t-on-click.prevent="openLink" t-att-title="link.url">
        <t t-esc="getUrlRepresentation(link)"/>
      </a>
      <a t-else="" class="o-link" t-on-click.prevent="openLink" t-att-title="getUrlRepresentation(link)">
        <t t-esc="getUrlRepresentation(link)"/>
      </a>
      <span t-if="!env.model.getters.isReadonly()" class="o-link-icon o-unlink" t-on-click="unlink" title="Remove link">
        <t t-call="o-spreadsheet-Icon.UNLINK"/>
      </span>
      <span t-if="!env.model.getters.isReadonly()" class="o-link-icon o-edit-link" t-on-click="edit" title="Edit link">
        <t t-call="o-spreadsheet-Icon.EDIT"/>
      </span>
    </div>
  </t>

  <t t-name="o-spreadsheet-LinkEditor">
    <div class="o-link-editor" t-on-click.stop="() =&gt; this.menu.isOpen=false" t-on-keydown="onKeyDown" t-ref="linkEditor">
      <div class="o-section">
        <div class="o-section-title">Text</div>
        <div class="d-flex">
          <input type="text" title="Link label" class="o-input flex-grow-1" t-model="link.label"/>
        </div>

        <div class="o-section-title mt-3">Link</div>
        <div class="o-link-url">
          <t t-if="link.isUrlEditable">
            <input type="text" title="Link URL" t-ref="urlInput" t-model="link.url"/>
          </t>
          <t t-else="">
            <input type="text" title="Link URL" t-att-value="getUrlRepresentation(link)" disabled="1"/>
          </t>
          <button t-if="link.url" t-on-click="removeLink" class="o-remove-url">✖</button>
          <button t-if="!link.url" t-on-click.stop="openMenu" class="o-special-link">
            <t t-call="o-spreadsheet-Icon.LIST"/>
          </button>
        </div>
      </div>
      <Menu t-if="menu.isOpen" position="menuPosition" menuItems="menuItems" onMenuClicked="(ev) =&gt; this.onSpecialLink(ev)" onClose="() =&gt; this.menu.isOpen=false"/>
      <div class="o-buttons">
        <button t-on-click="cancel" class="o-button o-button-grey o-cancel">Cancel</button>
        <button t-on-click="save" class="o-button o-button-grey o-save" t-att-disabled="!link.url">
          Confirm
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Menu">
    <Popover t-if="menuItemsAndSeparators.length" t-props="popoverProps">
      <div t-ref="menu" class="o-menu" t-on-scroll="onScroll" t-on-wheel.stop="" t-on-click.stop="" t-on-contextmenu.prevent="">
        <t t-foreach="menuItemsAndSeparators" t-as="menuItem" t-key="menuItem_index">
          <div t-if="menuItem === 'separator'" class="o-separator"/>
          <t t-else="">
            <t t-set="isMenuRoot" t-value="isRoot(menuItem)"/>
            <t t-set="isMenuEnabled" t-value="isEnabled(menuItem)"/>
            <div t-att-title="getName(menuItem)" t-att-data-name="menuItem.id" t-on-click="(ev) =&gt; this.onClickMenu(menuItem, menuItem_index, ev)" t-on-mouseover="(ev) =&gt; this.onMouseOver(menuItem, menuItem_index, ev)" class="o-menu-item" t-att-class="{ 'o-menu-root': isMenuRoot, 'disabled': !isMenuEnabled, 'o-menu-item-active': isParentMenu(subMenu, menuItem)}" t-att-style="getColor(menuItem)">
              <div class="d-flex w-100">
                <div t-if="childrenHaveIcon" class="o-menu-item-icon align-middle flex-shrink-0">
                  <t t-if="getIconName(menuItem)" t-call="{{getIconName(menuItem)}}"/>
                </div>
                <div class="o-menu-item-name align-middle text-truncate" t-esc="getName(menuItem)"/>
                <t t-set="description" t-value="menuItem.description(env)"/>
                <div t-if="description" class="o-menu-item-description ms-auto text-truncate" t-esc="description"/>
                <div t-if="isMenuRoot" class="o-menu-item-root align-middle ms-auto" t-call="o-spreadsheet-Icon.TRIANGLE_RIGHT"/>
              </div>
            </div>
          </t>
        </t>
      </div>
      <Menu t-if="subMenu.isOpen" position="subMenuPosition" menuItems="subMenu.menuItems" depth="props.depth + 1" maxHeight="props.maxHeight" onMenuClicked="props.onMenuClicked" onClose="() =&gt; this.close()" menuId="props.menuId"/>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-PaintFormatButton">
    <span class="o-menu-item-button" title="Paint Format" t-att-class="{active: isActive}" t-attf-class="{{props.class}}" t-on-click="togglePaintFormat" t-on-dblclick="onDblClick">
      <span>
        <t t-call="o-spreadsheet-Icon.PAINT_FORMAT"/>
      </span>
    </span>
  </t>

  <t t-name="o-spreadsheet-Popover">
    <t t-portal="'.o-spreadsheet'">
      <div class="o-popover" t-ref="popover" t-on-wheel="props.onMouseWheel" t-att-style="popoverStyle" t-on-click.stop="">
        <t t-slot="default"/>
      </div>
    </t>
  </t>

  <t t-name="o-spreadsheet-ScrollBar">
    <div class="o-scrollbar" t-on-scroll="onScroll" t-ref="scrollbar" t-att-style="positionCss">
      <div t-att-style="sizeCss"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-SelectionInput">
    <div class="o-selection">
      <div t-foreach="ranges" t-as="range" t-key="range.id" class="o-selection-input d-flex flex-row" t-att-class="props.class">
        <div class="position-relative w-100">
          <input type="text" spellcheck="false" t-on-input="(ev) =&gt; this.onInputChanged(range.id, ev)" t-on-focus="() =&gt; this.focus(range.id)" t-on-keydown="onKeydown" t-att-value="range.xc" t-att-style="getColor(range)" class="w-100" t-att-class="{               'o-focused' : range.isFocused,               'o-required': props.required,               'o-optional': !props.required,               'o-invalid border-danger position-relative': isInvalid || !range.isValidRange,               'text-decoration-underline': range.isFocused and state.mode === 'select-range'             }" t-ref="{{range.isFocused ? 'focusedInput' : 'unfocusedInput' + range_index}}"/>
          <span t-if="isInvalid || !range.isValidRange" class="error-icon text-danger position-absolute d-flex align-items-center" title="This range is invalid">
            <t t-call="o-spreadsheet-Icon.ERROR"/>
          </span>
        </div>
        <button class="o-btn border-0 bg-transparent fw-bold o-remove-selection" t-if="ranges.length &gt; 1" t-on-click="() =&gt; this.removeInput(range.id)">
          ✕
        </button>
      </div>

      <div class="o-selection-input d-flex flex-row">
        <button class="o-btn-action bg-transparent fw-bold o-add-selection" t-if="canAddRange" t-on-click="addEmptyInput">
          Add range
        </button>
        <button class="o-btn-action bg-transparent fw-bold o-selection-ko" t-if="isResettable" t-on-click="reset">
          Reset
        </button>
        <button class="o-btn-action bg-transparent fw-bold o-selection-ok" t-if="isConfirmable" t-on-click="confirm">
          Confirm
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-BarConfigPanel">
    <div>
      <div class="o-section pt-0">
        <label class="o-checkbox">
          <input type="checkbox" name="stacked" t-att-checked="props.definition.stacked" t-on-change="onUpdateStacked" class="align-middle"/>
          Stacked barchart
        </label>
      </div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-BarChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Vertical axis position</div>
        <select t-att-value="props.definition.verticalAxisPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('verticalAxisPosition', ev)">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data range</div>
        <SelectionInput ranges="() =&gt; [this.getDataRange()]" isInvalid="isDataRangeInvalid" hasSingleRange="true" required="true" onSelectionChanged="(ranges) =&gt; this.onDataRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateDataRange()"/>
      </div>

      <div class="o-section" t-if="configurationErrorMessages.length">
        <ValidationMessages messages="configurationErrorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleMenu('backgroundColor', ev)" showColorPicker="state.openedMenu === 'backgroundColor'" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>

      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>

      <div class="o-section">
        <div class="o-section-title">Range</div>
        <div class="o-subsection-left">
          <input type="text" t-model="state.sectionRule.rangeMin" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" class="o-input o-data-range-min" t-att-class="{ 'o-invalid': isRangeMinInvalid() }"/>
        </div>
        <div class="o-subsection-right">
          <input type="text" t-model="state.sectionRule.rangeMax" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" class="o-input o-data-range-max" t-att-class="{ 'o-invalid': isRangeMaxInvalid() }"/>
        </div>
      </div>

      <div class="o-section">
        <div class="o-section-title">Thresholds</div>
        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplate">
          <t t-set="sectionRule" t-value="state.sectionRule"/>
        </t>
      </div>

      <div class="o-section" t-if="designErrorMessages.length">
        <ValidationMessages messages="designErrorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartColorSectionTemplate">
    <div class="o-gauge-color-set">
      <table>
        <tr>
          <th class="o-gauge-color-set-colorPicker"/>
          <th class="o-gauge-color-set-text"/>
          <th class="o-gauge-color-set-value">Value</th>
          <th class="o-gauge-color-set-type">Type</th>
        </tr>

        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplateRow">
          <t t-set="sectionColor" t-value="sectionRule.colors.lowerColor"/>
          <t t-set="sectionType" t-value="'lowerColor'"/>
          <t t-set="inflectionPoint" t-value="sectionRule.lowerInflectionPoint"/>
          <t t-set="isInvalid" t-value="isLowerInflectionPointInvalid"/>
          <t t-set="inflectionPointName" t-value="'lowerInflectionPoint'"/>
        </t>

        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplateRow">
          <t t-set="sectionColor" t-value="sectionRule.colors.middleColor"/>
          <t t-set="sectionType" t-value="'middleColor'"/>
          <t t-set="inflectionPoint" t-value="sectionRule.upperInflectionPoint"/>
          <t t-set="isInvalid" t-value="isUpperInflectionPointInvalid"/>
          <t t-set="inflectionPointName" t-value="'upperInflectionPoint'"/>
        </t>

        <tr>
          <td>
            <ColorPickerWidget currentColor="sectionRule.colors.upperColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('sectionColor-upperColor', ev)" showColorPicker="state.openedMenu === 'sectionColor-upperColor'" onColorPicked="(color) =&gt; this.updateSectionColor('upperColor', color)" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
          </td>
          <td>Else</td>
          <td/>
          <td/>
          <td/>
        </tr>
      </table>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartColorSectionTemplateRow">
    <tr>
      <td>
        <ColorPickerWidget currentColor="sectionColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('sectionColor-'+sectionType, ev)" showColorPicker="state.openedMenu === 'sectionColor-'+sectionType" onColorPicked="(color) =&gt; this.updateSectionColor(sectionType, color)" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </td>
      <td>When value is below</td>
      <td>
        <input type="text" class="o-input" t-model="inflectionPoint.value" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-attf-class="o-input-{{inflectionPointName}}" t-att-class="{ 'o-invalid': isInvalid }"/>
      </td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPoint.type" t-on-change="(ev) =&gt; this.updateSectionRule(state.sectionRule)">
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
        </select>
      </td>
    </tr>
  </t>

  <t t-name="o-spreadsheet-LineBarPieConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineBarPieDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineConfigPanel">
    <div>
      <div class="o-section pt-0">
        <label class="o-checkbox">
          <input type="checkbox" name="stacked" t-att-checked="props.definition.stacked" t-on-change="onUpdateStacked" class="align-middle"/>
          Stacked linechart
        </label>
        <label class="o-checkbox">
          <input type="checkbox" name="cumulative" t-att-checked="props.definition.cumulative" t-on-change="onUpdateCumulative" class="align-middle"/>
          Cumulative data
        </label>
      </div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
        <label t-if="canTreatLabelsAsText" class="o-checkbox">
          <input type="checkbox" name="labelsAsText" t-att-checked="props.definition.labelsAsText" t-on-change="onUpdateLabelsAsText"/>
          Treat labels as text
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Vertical axis position</div>
        <select t-att-value="props.definition.verticalAxisPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('verticalAxisPosition', ev)">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartPanel">
    <div class="o-chart">
      <div class="o-panel">
        <div class="o-panel-element o-panel-configuration" t-att-class="state.panel !== 'configuration' ? 'inactive' : ''" t-on-click="() =&gt; this.activatePanel('configuration')">
          <i class="fa fa-sliders"/>
          Configuration
        </div>
        <div class="o-panel-element o-panel-design" t-att-class="state.panel !== 'design' ? 'inactive' : ''" t-on-click="() =&gt; this.activatePanel('design')">
          <i class="fa fa-paint-brush"/>
          Design
        </div>
      </div>

      <t t-set="definition" t-value="getChartDefinition()"/>
      <t t-if="state.panel === 'configuration'">
        <div class="o-section">
          <div class="o-section-title">Chart type</div>
          <t t-set="types" t-value="chartTypes"/>
          <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onTypeChange(ev.target.value)">
            <option t-foreach="chartTypes" t-as="type" t-key="type" t-att-value="type" t-esc="types[type]" t-att-selected="definition.type === type"/>
          </select>
        </div>
        <t t-component="chartPanel.configuration" definition="definition" figureId="figureId" updateChart.bind="updateChart" canUpdateChart.bind="canUpdateChart" t-key="figureId + definition.type"/>
      </t>
      <t t-else="">
        <t t-component="chartPanel.design" definition="definition" figureId="figureId" updateChart.bind="updateChart" canUpdateChart.bind="canUpdateChart" t-key="figureId + definition.type"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ScorecardChartConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Key value</div>
        <SelectionInput ranges="() =&gt; [this.getKeyValueRange()]" isInvalid="isKeyValueInvalid" hasSingleRange="true" required="true" onSelectionChanged="(ranges) =&gt; this.onKeyValueRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateKeyValueRange()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Baseline configuration</div>
        <div class="o-section-subtitle">Baseline value</div>
        <SelectionInput ranges="() =&gt; [this.getBaselineRange()]" isInvalid="isBaselineInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onBaselineRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateBaselineRange()"/>
        <div class="o-section-subtitle">Baseline format</div>
        <select t-att-value="props.definition.baselineMode" class="o-input o-type-selector o-optional" t-on-change="(ev) =&gt; this.updateBaselineMode(ev)">
          <option value="text">Absolute value</option>
          <option value="difference">Value change from key value</option>
          <option value="percentage">Percentage change from key value</option>
        </select>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ScorecardChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <t t-set="color_up">Color Up</t>
    <t t-set="color_down">Color Down</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker('backgroundColor')" showColorPicker="state.openedColorPicker === 'backgroundColor'" onColorPicked="(color) =&gt; this.setColor(color, 'backgroundColor')" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>

      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Baseline description</div>
        <input type="text" t-att-value="translate(props.definition.baselineDescr)" t-on-change="updateBaselineDescr" class="o-input o-optional"/>
      </div>
    </div>
    <div class="o-section o-chart-baseline-color">
      <div class="o-section-title">Baseline color</div>
      <div class="d-flex align-items-center">
        <span class="pe-1">Color on value increase</span>
        <ColorPickerWidget currentColor="props.definition.baselineColorUp" toggleColorPicker="() =&gt; this.toggleColorPicker('baselineColorUp')" showColorPicker="state.openedColorPicker === 'baselineColorUp'" onColorPicked="(color) =&gt; this.setColor(color, 'baselineColorUp')" title="color_up" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </div>
      <div class="d-flex align-items-center">
        <span class="pe-1">Color on value decrease</span>
        <ColorPickerWidget currentColor="props.definition.baselineColorDown" toggleColorPicker="() =&gt; this.toggleColorPicker('baselineColorDown')" showColorPicker="state.openedColorPicker === 'baselineColorDown'" onColorPicked="(color) =&gt; this.setColor(color, 'baselineColorDown')" title="color_down" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-CellIsRuleEditorPreview">
    <div class="o-cf-preview-line" t-attf-style="font-weight:{{currentStyle.bold ?'bold':'normal'}};                        text-decoration:{{getTextDecoration(currentStyle)}};                        font-style:{{currentStyle.italic?'italic':'normal'}};                        color:{{currentStyle.textColor || '#000'}};                        border-radius: 4px;                        background-color:{{currentStyle.fillColor}};">
      <t t-if="previewText" t-esc="previewText"/>
      <t t-else="">Preview text</t>
    </div>
  </t>

  <t t-name="o-spreadsheet-CellIsRuleEditor">
    <t t-set="fill_color">Fill Color</t>
    <t t-set="text_color">Text Color</t>
    <div class="o-cf-cell-is-rule">
      <div class="o-section-subtitle">Format cells if...</div>
      <select t-model="rule.operator" class="o-input o-cell-is-operator">
        <t t-foreach="Object.keys(cellIsOperators)" t-as="op" t-key="op_index">
          <option t-att-value="op" t-esc="cellIsOperators[op]"/>
        </t>
      </select>
      <t t-if="rule.operator !== 'IsEmpty' and rule.operator !== 'IsNotEmpty'">
        <input type="text" placeholder="Value or formula" t-model="rule.values[0]" t-att-class="{ 'o-invalid': isValue1Invalid }" class="o-input o-cell-is-value o-required" t-on-keydown="(ev) =&gt; this.onKeydown(ev)"/>
        <t t-if="rule.operator === 'Between' || rule.operator === 'NotBetween'">
          <input type="text" placeholder="and value or formula" t-model="rule.values[1]" t-att-class="{ 'o-invalid': isValue2Invalid }" class="o-input o-cell-is-value o-required" t-on-keydown="(ev) =&gt; this.onKeydown(ev)"/>
        </t>
      </t>
      <div class="o-section-subtitle">Formatting style</div>

      <t t-call="o-spreadsheet-CellIsRuleEditorPreview">
        <t t-set="currentStyle" t-value="rule.style"/>
      </t>
      <div class="o-sidePanel-tools">
        <div class="o-tool" title="Bold" t-att-class="{active:rule.style.bold}" t-on-click="() =&gt; this.toggleStyle('bold')">
          <t t-call="o-spreadsheet-Icon.BOLD"/>
        </div>
        <div class="o-tool" title="Italic" t-att-class="{active:rule.style.italic}" t-on-click="() =&gt; this.toggleStyle('italic')">
          <t t-call="o-spreadsheet-Icon.ITALIC"/>
        </div>
        <div class="o-tool" title="Underline" t-att-class="{active:rule.style.underline}" t-on-click="(ev) =&gt; this.toggleStyle('underline', ev)">
          <t t-call="o-spreadsheet-Icon.UNDERLINE"/>
        </div>
        <div class="o-tool" title="Strikethrough" t-att-class="{active:rule.style.strikethrough}" t-on-click="(ev) =&gt; this.toggleStyle('strikethrough', ev)">
          <t t-call="o-spreadsheet-Icon.STRIKE"/>
        </div>
        <ColorPickerWidget currentColor="rule.style.textColor || '#000000'" toggleColorPicker="(ev) =&gt; this.toggleMenu('cellIsRule-textColor', ev)" showColorPicker="state.openedMenu === 'cellIsRule-textColor'" onColorPicked="(color) =&gt; this.setColor('textColor', color)" title="text_color" icon="'o-spreadsheet-Icon.TEXT_COLOR'" class="'o-tool'"/>
        <div class="o-divider"/>
        <ColorPickerWidget currentColor="rule.style.fillColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('cellIsRule-fillColor', ev)" showColorPicker="state.openedMenu === 'cellIsRule-fillColor'" onColorPicked="(color) =&gt; this.setColor('fillColor', color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" class="'o-tool'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingEditor">
    <div class="o-cf-ruleEditor">
      <div class="o-section o-cf-range">
        <div class="o-section-title">Apply to range</div>
        <div class="o-selection-cf">
          <SelectionInput ranges="() =&gt; state.currentCF.ranges" class="'o-range'" isInvalid="isRangeValid" onSelectionChanged="(ranges) =&gt; this.onRangesChanged(ranges)" required="true"/>
        </div>
        <div class="o-section-title">Format rules</div>
        <div class="o_field_radio o_horizontal o_field_widget o-cf-type-selector">
          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('CellIsRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'CellIsRule'" type="radio" id="cellIsRule" name="ruleType" value="CellIsRule"/>
            <label for="cellIsRule" class="form-check-label o_form_label">Single color</label>
          </div>
          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('ColorScaleRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'ColorScaleRule'" type="radio" id="colorScaleRule" name="ruleType" value="ColorScaleRule"/>
            <label for="colorScaleRule" class="form-check-label o_form_label">Color scale</label>
          </div>

          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('IconSetRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'IconSetRule'" type="radio" id="iconSetRule" name="ruleType" value="IconSetRule"/>
            <label for="iconSetRule" class="form-check-label o_form_label">Icon set</label>
          </div>
        </div>
      </div>
      <div class="o-section o-cf-editor">
        <t t-if="state.currentCFType === 'CellIsRule'" t-call="o-spreadsheet-CellIsRuleEditor">
          <t t-set="rule" t-value="state.rules.cellIs"/>
        </t>
        <t t-if="state.currentCFType === 'ColorScaleRule'" t-call="o-spreadsheet-ColorScaleRuleEditor">
          <t t-set="rule" t-value="state.rules.colorScale"/>
        </t>
        <t t-if="state.currentCFType === 'IconSetRule'" t-call="o-spreadsheet-IconSetEditor">
          <t t-set="rule" t-value="state.rules.iconSet"/>
        </t>
        <div class="o-sidePanelButtons">
          <button t-on-click="props.onExitEdition" class="o-button o-button-grey o-cf-cancel">
            Cancel
          </button>
          <button t-on-click="saveConditionalFormat" class="o-button o-button-grey primary o-cf-save">
            Save
          </button>
        </div>
      </div>
      <div class="o-section">
        <div class="o-cf-error" t-foreach="state.errors || []" t-as="error" t-key="error_index">
          <t t-esc="errorMessage(error)"/>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditorPreview">
    <div class="o-cf-preview-gradient" t-attf-style="{{getPreviewGradient()}}">Preview text</div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditorThreshold">
    <t t-set="fill_color">Fill Color</t>
    <div t-attf-class="o-threshold o-threshold-{{thresholdType}}">
      <t t-if="thresholdType === 'midpoint'">
        <t t-set="type" t-value="threshold and threshold.type"/>
        <select class="o-input" name="valueType" t-on-change="onMidpointChange" t-on-click="closeMenus">
          <option value="none" t-att-selected="threshold === undefined">None</option>
          <option value="number" t-att-selected="type === 'number'">FixedNumber</option>
          <option value="percentage" t-att-selected="type === 'percentage'">Percentage</option>
          <option value="percentile" t-att-selected="type === 'percentile'">Percentile</option>
          <option value="formula" t-att-selected="type === 'formula'">Formula</option>
        </select>
      </t>
      <t t-else="">
        <select class="o-input" name="valueType" t-model="threshold.type" t-on-click="closeMenus">
          <option value="value">Cell values</option>
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
          <option value="percentile">Percentile</option>
          <option value="formula">Formula</option>
        </select>
      </t>
      <input type="text" class="o-input o-threshold-value o-required" t-model="rule[thresholdType].value" t-att-class="{ 'o-invalid': isValueInvalid(thresholdType) }" t-if="threshold !== undefined and threshold.type !== 'value'"/>
      <input type="text" class="o-input o-threshold-value" t-else="" disabled="1"/>
      <ColorPickerWidget currentColor="getThresholdColor(threshold)" toggleColorPicker="(ev) =&gt; this.toggleMenu('colorScale-'+thresholdType+'Color', ev)" showColorPicker="state.openedMenu === 'colorScale-'+thresholdType+'Color'" onColorPicked="(color) =&gt; this.setColorScaleColor(thresholdType, color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" disabled="threshold === undefined"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditor">
    <div class="o-cf-color-scale-editor">
      <div class="o-section-subtitle">Preview</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorPreview"/>
      <div class="o-section-subtitle">Minpoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.minimum"/>
        <t t-set="thresholdType" t-value="'minimum'"/>
      </t>
      <div class="o-section-subtitle">MidPoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.midpoint"/>
        <t t-set="thresholdType" t-value="'midpoint'"/>
      </t>
      <div class="o-section-subtitle">MaxPoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.maximum"/>
        <t t-set="thresholdType" t-value="'maximum'"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconSets">
    <div>
      <div class="o-section-subtitle">Icons</div>
      <div class="o-cf-iconsets">
        <div class="o-cf-iconset" t-foreach="['arrows', 'smiley', 'dots']" t-as="iconSet" t-key="iconSet" t-on-click="(ev) =&gt; this.setIconSet(iconSet, ev)">
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].good].template}}"/>
          </div>
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].neutral].template}}"/>
          </div>
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].bad].template}}"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconSetInflexionPointRow">
    <tr>
      <td>
        <div t-on-click.stop="(ev) =&gt; this.toggleMenu('iconSet-'+icon+'Icon', ev)">
          <div class="o-cf-icon-button">
            <t t-call="o-spreadsheet-Icon.{{icons[iconValue].template}}"/>
          </div>
        </div>
        <IconPicker t-if="state.openedMenu === 'iconSet-'+icon+'Icon'" onIconPicked="(i) =&gt; this.setIcon(icon, i)"/>
      </td>
      <td>When value is</td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPointValue.operator">
          <option value="gt">
            <span>&gt;</span>
          </option>
          <option value="ge">
            <span>≥</span>
          </option>
        </select>
      </td>
      <td>
        <input type="text" class="o-input" t-att-class="{ 'o-invalid': isInflectionPointInvalid(inflectionPoint) }" t-model="rule[inflectionPoint].value"/>
      </td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPointValue.type">
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
          <option value="percentile">Percentile</option>
          <option value="formula">Formula</option>
        </select>
      </td>
    </tr>
  </t>

  <t t-name="o-spreadsheet-IconSetInflexionPoints">
    <div class="o-inflection">
      <table>
        <tr>
          <th class="o-cf-iconset-icons"/>
          <th class="o-cf-iconset-text"/>
          <th class="o-cf-iconset-operator"/>
          <th class="o-cf-iconset-value">Value</th>
          <th class="o-cf-iconset-type">Type</th>
        </tr>
        <t t-call="o-spreadsheet-IconSetInflexionPointRow">
          <t t-set="iconValue" t-value="rule.icons.upper"/>
          <t t-set="icon" t-value="'upper'"/>
          <t t-set="inflectionPointValue" t-value="rule.upperInflectionPoint"/>
          <t t-set="inflectionPoint" t-value="'upperInflectionPoint'"/>
        </t>
        <t t-call="o-spreadsheet-IconSetInflexionPointRow">
          <t t-set="iconValue" t-value="rule.icons.middle"/>
          <t t-set="icon" t-value="'middle'"/>
          <t t-set="inflectionPointValue" t-value="rule.lowerInflectionPoint"/>
          <t t-set="inflectionPoint" t-value="'lowerInflectionPoint'"/>
        </t>
        <tr>
          <td>
            <div t-on-click.stop="(ev) =&gt; this.toggleMenu('iconSet-lowerIcon', ev)">
              <div class="o-cf-icon-button">
                <t t-call="o-spreadsheet-Icon.{{icons[rule.icons.lower].template}}"/>
              </div>
            </div>
            <IconPicker t-if="state.openedMenu === 'iconSet-lowerIcon'" onIconPicked="(icon) =&gt; this.setIcon('lower', icon)"/>
          </td>
          <td>Else</td>
          <td/>
          <td/>
          <td/>
        </tr>
      </table>
    </div>
  </t>
  <t t-name="o-spreadsheet-IconSetEditor">
    <div class="o-cf-iconset-rule">
      <t t-call="o-spreadsheet-IconSets"/>
      <t t-call="o-spreadsheet-IconSetInflexionPoints"/>
      <div class="btn btn-link o_refresh_measures o-cf-iconset-reverse" t-on-click="reverseIcons">
        <div class="me-1 d-inline-block">
          <t t-call="o-spreadsheet-Icon.REFRESH"/>
        </div>
        Reverse icons
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormatPreviewList">
    <div class="o-cf-preview-list h-100 overflow-auto" t-ref="cfList">
      <t t-foreach="props.conditionalFormats" t-as="cf" t-key="cf.id">
        <t t-call="o-spreadsheet-ConditionalFormattingPanelPreview"/>
      </t>
      <div class="btn btn-link o-sidePanel-btn-link o-cf-add float-end" t-on-click.prevent.stop="props.onAddConditionalFormat">
        + Add another rule
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingPanelPreview">
    <div class="o-cf-preview d-flex position-relative" t-att-class="{ 'o-cf-dragging': dragAndDrop.draggedItemId === cf.id }" t-att-style="getPreviewDivStyle(cf)" t-att-data-id="cf.id" t-on-click="(ev) =&gt; props.onPreviewClick(cf)" t-on-mousedown="(ev) =&gt; this.onMouseDown(cf, ev)">
      <div class="position-relative h-100 w-100 d-flex align-items-center">
        <div class="o-cf-drag-handle h-100 position-absolute d-flex align-items-center text-muted">
          <t t-call="o-spreadsheet-Icon.THIN_DRAG_HANDLE"/>
        </div>
        <t t-if="cf.rule.type==='IconSetRule'">
          <div class="o-cf-preview-icon d-flex justify-content-around align-items-center me-2">
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.upper].template}}"/>
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.middle].template}}"/>
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.lower].template}}"/>
          </div>
        </t>
        <t t-else="">
          <div t-att-style="getPreviewImageStyle(cf.rule)" class="o-cf-preview-icon d-flex justify-content-around align-items-center me-2">
            123
          </div>
        </t>
        <div class="o-cf-preview-description">
          <div class="o-cf-preview-ruletype">
            <div class="o-cf-preview-description-rule text-truncate">
              <t t-esc="getDescription(cf)"/>
            </div>
          </div>
          <div class="o-cf-preview-range text-truncate" t-esc="cf.ranges"/>
        </div>
        <div class="o-cf-delete">
          <div class="o-cf-delete-button text-muted" t-on-click.stop="(ev) =&gt; this.deleteConditionalFormat(cf, ev)" title="Remove rule">
            <t t-call="o-spreadsheet-Icon.TRASH"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingPanel">
    <div class="o-cf h-100">
      <t t-if="state.mode === 'list'">
        <ConditionalFormatPreviewList conditionalFormats="conditionalFormats" onPreviewClick.bind="editConditionalFormat" onAddConditionalFormat.bind="addConditionalFormat"/>
      </t>
      <t t-if="state.mode === 'edit'">
        <ConditionalFormattingEditor editedCf="state.editedCf" onExitEdition.bind="switchToList"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-CustomCurrencyPanel">
    <div class="o-custom-currency">
      <div class="o-section" t-if="availableCurrencies.length &gt; 1">
        <div class="o-section-title">Currency</div>
        <select class="o-input o-available-currencies" t-on-change="(ev) =&gt; this.updateSelectCurrency(ev)">
          <t t-foreach="availableCurrencies" t-as="currency" t-key="currency_index">
            <option t-att-value="currency_index" t-esc="currencyDisplayName(currency)" t-att-selected="currency_index === state.selectedCurrencyIndex"/>
          </t>
        </select>
      </div>
      <div class="o-section">
        <div class="o-subsection-left">
          <div class="o-section-title">Code</div>
          <input type="text" class="o-input" t-model="state.currencyCode" t-on-input="(ev) =&gt; this.updateCode(ev)"/>
        </div>
        <div class="o-subsection-right">
          <div class="o-section-title">Symbol</div>
          <input type="text" class="o-input" t-model="state.currencySymbol" t-on-input="(ev) =&gt; this.updateSymbol(ev)"/>
        </div>
      </div>
      <div class="o-section">
        <div class="o-section-title">Format</div>
        <select class="o-input o-format-proposals" t-on-change="(ev) =&gt; this.updateSelectFormat(ev)" t-att-disabled="!formatProposals.length">
          <t t-foreach="formatProposals" t-as="proposal" t-key="proposal_index">
            <option t-att-value="proposal_index" t-esc="proposal.example" t-att-selected="proposal_index === state.selectedFormatIndex"/>
          </t>
        </select>
      </div>
      <div class="o-sidePanelButtons">
        <button class="o-button o-button-grey" t-on-click="() =&gt; this.apply()" t-att-disabled="!formatProposals.length || isSameFormat">
          Apply
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationPanel">
    <div class="o-data-validation">
      <t t-if="state.mode === 'list'">
        <div class="o-dv-preview-list">
          <t t-foreach="validationRules" t-as="rule" t-key="rule.id">
            <DataValidationPreview rule="localizeDVRule(rule)" onClick="() =&gt; this.onPreviewClick(rule.id)"/>
          </t>
        </div>
        <div class="o-dv-add btn btn-link o-sidePanel-btn-link float-end" t-on-click="addDataValidationRule">
          + Add another rule
        </div>
      </t>
      <t t-else="">
        <DataValidationEditor rule="localizeDVRule(state.activeRule)" onExit.bind="onExitEditMode"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationDateCriterion">
    <select class="o-dv-date-value o-input mb-4" t-on-change="onDateValueChanged">
      <option t-foreach="dateValues" t-as="dateValue" t-key="dateValue.value" t-att-value="dateValue.value" t-esc="dateValue.title" t-att-selected="dateValue.value === props.criterion.dateValue"/>
    </select>

    <DataValidationInput t-if="props.criterion.dateValue === 'exactDate'" value="props.criterion.values[0]" onValueChanged.bind="onValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationDoubleInput">
    <DataValidationInput value="props.criterion.values[0]" onValueChanged.bind="onFirstValueChanged" criterionType="props.criterion.type"/>

    <div class="o-section-subtitle ms-1 my-2">and</div>
    <DataValidationInput value="props.criterion.values[1]" onValueChanged.bind="onSecondValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationInput">
    <div class="o-dv-input position-relative w-100">
      <input type="text" t-ref="input" t-on-input="onValueChanged" t-att-value="props.value" class="o-input" t-att-class="{             'o-invalid border-danger position-relative': errorMessage,           }" t-att-title="errorMessage" t-att-placeholder="placeholder" t-on-keydown="props.onKeyDown" t-on-blur="props.onBlur"/>
      <span t-if="errorMessage" class="error-icon text-danger position-absolute d-flex align-items-center" t-att-title="errorMessage">
        <t t-call="o-spreadsheet-Icon.ERROR"/>
      </span>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationSingleInput">
    <DataValidationInput value="props.criterion.values[0]" onValueChanged.bind="onValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationListCriterionForm">
    <t t-foreach="displayedValues" t-as="value" t-key="value_index">
      <div class="o-dv-list-values d-flex align-items-center">
        <DataValidationInput value="props.criterion.values[value_index]" onValueChanged="(v) =&gt; this.onValueChanged(v, value_index)" criterionType="props.criterion.type" onKeyDown="(ev) =&gt; this.onKeyDown(ev, value_index)" focused="value_index === state.focusedValueIndex" onBlur.bind="onBlurInput"/>
        <div class="o-dv-list-item-delete ms-2 me-1" t-on-click="() =&gt; this.removeItem(value_index)">
          <t t-call="o-spreadsheet-Icon.TRASH"/>
        </div>
      </div>
      <div class="mb-2"/>
    </t>
    <button class="o-dv-list-add-value o-button o-button-grey mb-3" t-on-click="onAddAnotherValue">
      Add another item
    </button>

    <div class="o-section-subtitle">Display style</div>
    <select class="o-dv-display-style o-input" t-on-change="onChangedDisplayStyle">
      <option t-att-selected="props.criterion.displayStyle === 'arrow'" value="arrow">Arrow</option>
      <option t-att-selected="props.criterion.displayStyle === 'plainText'" value="plainText">
        Plain text
      </option>
    </select>
  </t>

  <t t-name="o-spreadsheet-DataValidationValueInRangeCriterionForm">
    <SelectionInput ranges="() =&gt; [props.criterion.values[0] || '']" onSelectionChanged="(ranges) =&gt; this.onRangeChanged(ranges[0])" required="true" hasSingleRange="true"/>

    <div class="o-section-subtitle">Display style</div>
    <select class="o-dv-display-style o-input" t-on-change="onChangedDisplayStyle">
      <option t-att-selected="props.criterion.displayStyle === 'arrow'" value="arrow">Arrow</option>
      <option t-att-selected="props.criterion.displayStyle === 'plainText'" value="plainText">
        Plain text
      </option>
    </select>
  </t>

  <t t-name="o-spreadsheet-DataValidationEditor">
    <div class="o-dv-form w-100 h-100">
      <div class="o-section o-dv-range">
        <div class="o-section-title">Apply to range</div>
        <SelectionInput ranges="() =&gt; state.rule.ranges" onSelectionChanged="(ranges) =&gt; this.onRangesChanged(ranges)" required="true"/>

        <div class="o-subsection o-dv-settings">
          <div class="o-section-title">Criteria</div>
          <SelectMenu class="'o-dv-type o-input mb-4'" menuItems="dvCriterionMenuItems" selectedValue="selectedCriterionName"/>

          <t t-if="criterionComponent" t-component="criterionComponent" t-key="state.rule.criterion.type" criterion="state.rule.criterion" onCriterionChanged.bind="onCriterionChanged"/>
        </div>
      </div>

      <div class="o-section o-dv-invalid-option">
        <div class="o-section-title">If the data is invalid</div>
        <select class="o-dv-reject-input o-input" t-on-change="changeRuleIsBlocking">
          <option t-att-selected="!state.rule.isBlocking" value="false">Show a warning</option>
          <option t-att-selected="state.rule.isBlocking" value="true">Reject the input</option>
        </select>
      </div>

      <div class="o-sidePanelButtons">
        <button t-on-click="props.onExit" class="o-dv-cancel o-button o-button-grey">Cancel</button>
        <button t-on-click="onSave" class="o-dv-save o-button o-button-grey primary" t-att-class="{'o-disabled': !canSave }">
          Save
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationPreview">
    <div class="o-dv-preview p-3" t-on-click="props.onClick">
      <div class="d-flex justify-content-between">
        <div class="o-dv-container d-flex flex-column">
          <div class="o-dv-preview-description fw-bold text-truncate" t-esc="descriptionString"/>
          <div class="o-dv-preview-ranges text-truncate" t-esc="rangesString"/>
        </div>
        <div class="o-dv-preview-delete d-flex align-items-center text-muted px-3" t-on-click.stop="deleteDataValidation">
          <t t-call="o-spreadsheet-Icon.TRASH"/>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FindAndReplacePanel">
    <div class="o-find-and-replace">
      <div class="o-section">
        <div class="o-section-title">Search</div>
        <div class="o-input-search-container">
          <input type="text" t-ref="searchInput" class="o-input o-input-with-count" t-on-input="onInput" t-on-keydown="onKeydownSearch"/>
          <div class="o-input-count" t-if="hasSearchResult">
            <t t-esc="env.model.getters.getCurrentSelectedMatchIndex()+1"/>
            /
            <t t-esc="env.model.getters.getSearchMatches().length"/>
          </div>
          <div t-elif="!pendingSearch and state.toSearch !== ''" class="o-input-count">0 / 0</div>
        </div>
        <div>

          <label class="o-checkbox mt-1">
            <input t-model="state.searchOptions.matchCase" t-on-change="updateSearch" type="checkbox"/>
            <span>Match case</span>
          </label>
          <label class="o-checkbox">
            <input t-model="state.searchOptions.exactMatch" t-on-change="updateSearch" type="checkbox"/>
            <span>Match entire cell content</span>
          </label>
          <label class="o-checkbox">
            <input t-model="state.searchOptions.searchFormulas" t-on-change="searchFormulas" type="checkbox"/>
            <span>Search in formulas</span>
          </label>
        </div>
      </div>
      <div class="o-sidePanelButtons">
        <button t-att-disabled="!hasSearchResult" t-on-click="onSelectPreviousCell" class="o-button o-button-grey">
          Previous
        </button>
        <button t-att-disabled="!hasSearchResult" t-on-click="onSelectNextCell" class="o-button o-button-grey">
          Next
        </button>
      </div>
      <div class="o-section" t-if="!env.model.getters.isReadonly()">
        <div class="o-section-title">Replace</div>
        <div class="o-input-search-container">
          <input type="text" class="o-input o-input-without-count" t-model="state.replaceWith" t-on-keydown="onKeydownReplace"/>
        </div>
      </div>

      <div class="o-sidePanelButtons" t-if="!env.model.getters.isReadonly()">
        <button t-att-disabled="env.model.getters.getCurrentSelectedMatchIndex() === null" t-on-click="replace" class="o-button o-button-grey">
          Replace
        </button>
        <button t-att-disabled="env.model.getters.getCurrentSelectedMatchIndex() === null" t-on-click="replaceAll" class="o-button o-button-grey">
          Replace all
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-MoreFormatsPanel">
    <div class="o-more-formats-panel">
      <div t-foreach="dateFormatsActions" t-as="action" t-key="action.name(env)" t-att-data-name="action.name(env)" t-on-click="() =&gt; action.execute(env)" class="w-100 d-flex align-items-center border-bottom format-preview">
        <span class="ms-3 check-icon">
          <t t-if="action.isActive(env)" t-call="o-spreadsheet-Icon.CHECK"/>
        </span>
        <span t-out="action.description(env)"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-RemoveDuplicatesPanel">
    <div class="o-remove-duplicates">
      <div class="o-section">
        <div class="o-section-subtitle" t-esc="selectionStatisticalInformation"/>
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="state.hasHeader" t-on-change="toggleHasHeader"/>
          Data has header row
        </label>
      </div>

      <div class="o-section">
        <div class="o-section-title">Columns to analyze</div>
        <div class="o-checkbox-selection overflow-auto p-3 vh-50 border rounded">
          <label class="o-checkbox">
            <input t-att-checked="isEveryColumnSelected" t-on-change="toggleAllColumns" type="checkbox"/>
            Select all
          </label>

          <t t-foreach="Object.keys(state.columns)" t-as="colIndex" t-key="colIndex">
            <label class="o-checkbox">
              <input type="checkbox" t-att-checked="state.columns[colIndex]" t-on-change="() =&gt; this.toggleColumn(colIndex)"/>
              <t t-esc="getColLabel(colIndex)"/>
            </label>
          </t>
        </div>
      </div>

      <div class="o-sidePanelButtons">
        <button class="o-button o-button-grey" t-att-class="{'o-disabled': !canConfirm}" t-on-click="onRemoveDuplicates">
          Remove duplicates
        </button>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SelectMenu">
    <select t-att-class="props.class" t-ref="select" t-on-mousedown.stop.prevent="" t-on-click="onClick">
      <option selected="true" t-esc="props.selectedValue"/>
    </select>
    <Menu t-if="state.isMenuOpen" menuItems="props.menuItems" position="menuPosition" onClose.bind="onMenuClosed"/>
  </t>

  <t t-name="o-spreadsheet-SettingsPanel">
    <div class="o-settings-panel">
      <div class="o-section">
        <div class="o-section-title">Locale</div>
        <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onLocaleChange(ev.target.value)">
          <option t-foreach="supportedLocales" t-as="locale" t-key="locale.code" t-att-value="locale.code" t-esc="locale.name" t-att-selected="currentLocale.code === locale.code"/>
        </select>
        <div class="o-locale-preview mt-2 ms-3">
          <div>
            <span class="fw-bold me-1">Number:</span>
            <span t-esc="numberFormatPreview"/>
          </div>
          <div>
            <span class="fw-bold me-1">Date:</span>
            <span t-esc="dateFormatPreview"/>
          </div>
          <div>
            <span class="fw-bold me-1">Date time:</span>
            <span t-esc="dateTimeFormatPreview"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SidePanel">
    <div class="o-sidePanel">
      <div class="o-sidePanelHeader">
        <div class="o-sidePanelTitle" t-esc="getTitle()"/>
        <div class="o-sidePanelClose" t-on-click="() =&gt; this.props.onCloseSidePanel()">✕</div>
      </div>
      <div class="o-sidePanelBody">
        <t t-component="state.panel.Body" t-props="props.panelProps" onCloseSidePanel="props.onCloseSidePanel" t-key="'Body_' + props.component"/>
      </div>
      <div class="o-sidePanelFooter" t-if="state.panel.Footer">
        <t t-component="state.panel.Footer" t-props="props.panelProps" t-key="'Footer_' + props.component"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SplitIntoColumnsPanel">
    <div class="o-split-to-cols-panel">
      <div class="o-section">
        <div class="o-section-title">Separator</div>
        <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onSeparatorChange(ev.target.value)">
          <option t-foreach="separators" t-as="separator" t-key="separator.value" t-att-value="separator.value" t-esc="separator.name" t-att-selected="state.separatorValue === separator.value"/>
        </select>

        <input class="o-input o-required mt-3" type="text" t-if="state.separatorValue === 'custom'" t-att-value="state.customSeparator" t-on-input="updateCustomSeparator" placeholder="Add any characters or symbol"/>

        <label class="o-checkbox">
          <input type="checkbox" name="add columns" t-att-checked="state.addNewColumns" t-on-change="updateAddNewColumnsCheckbox"/>
          Add new columns to avoid overwriting cells
        </label>

        <div class="o-sidePanelButtons">
          <button class="o-button o-button-grey" t-att-class="{'o-disabled': isConfirmDisabled}" t-on-click="confirm">
            Confirm
          </button>
        </div>

        <ValidationMessages messages="errorMessages" msgType="'error'"/>
        <ValidationMessages messages="warningMessages" msgType="'warning'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Spreadsheet">
    <div class="o-spreadsheet" t-on-keydown="(ev) =&gt; !env.isDashboard() and this.onKeydown(ev)" t-att-style="getStyle()">
      <t t-if="env.isDashboard()">
        <SpreadsheetDashboard/>
      </t>
      <t t-else="">
        <TopBar onClick="() =&gt; this.focusGrid()" onComposerContentFocused="(selection) =&gt; this.onTopBarComposerFocused(selection)" focusComposer="focusTopBarComposer" dropdownMaxHeight="gridHeight"/>
        <div class="o-grid-container" t-att-class="{'o-two-columns': !sidePanel.isOpen}" t-att-style="gridContainerStyle" t-on-click="this.focusGrid">
          <div class="o-top-left"/>
          <div class="o-column-groups">
            <HeaderGroupContainer layers="colLayers" dimension="'COL'"/>
          </div>
          <div class="o-row-groups">
            <HeaderGroupContainer layers="rowLayers" dimension="'ROW'"/>
          </div>
          <div class="o-group-grid overflow-hidden">
            <Grid sidePanelIsOpen="sidePanel.isOpen" focusComposer="focusGridComposer" exposeFocus="(focus) =&gt; this._focusGrid = focus" onComposerContentFocused="() =&gt; this.onGridComposerContentFocused()" onGridComposerCellFocused="(content, selection) =&gt; this.onGridComposerCellFocused(content, selection)"/>
          </div>
        </div>
        <SidePanel t-if="sidePanel.isOpen" onCloseSidePanel="() =&gt; this.closeSidePanel()" component="sidePanel.component" panelProps="sidePanel.panelProps"/>
        <BottomBar onClick="() =&gt; this.focusGrid()"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-TopBar">
    <t t-set="text_color">Text Color</t>
    <t t-set="fill_color">Fill Color</t>
    <div class="o-spreadsheet-topbar o-two-columns d-flex flex-column user-select-none" t-on-click="props.onClick">
      <div class="o-topbar-top d-flex justify-content-between">

        <div class="o-topbar-topleft d-flex">
          <t t-foreach="menus" t-as="menu" t-key="menu_index">
            <div t-if="menu.children.length !== 0" class="o-topbar-menu o-hoverable-button rounded" t-att-class="{'active': state.menuState.parentMenu and state.menuState.parentMenu.id === menu.id}" t-on-click="(ev) =&gt; this.toggleContextMenu(menu, ev)" t-on-mouseover="(ev) =&gt; this.onMenuMouseOver(menu, ev)" t-att-data-id="menu.id">
              <t t-esc="getMenuName(menu)"/>
            </div>
          </t>
        </div>
        <div class="o-topbar-topright d-flex justify-content-end">
          <div t-foreach="topbarComponents" t-as="comp" t-key="comp.id">
            <t t-component="comp.component"/>
          </div>
        </div>
      </div>

      <div class="d-flex">
        <div class="o-topbar-toolbar d-flex flex-shrink-0">

          <div t-if="env.model.getters.isReadonly()" class="o-readonly-toolbar d-flex align-items-center text-muted">
            <span>
              <i class="fa fa-eye"/>
              Readonly Access
            </span>
          </div>
          <div t-else="" class="o-toolbar-tools d-flex flex-shrink-0 ms-4">
            <ActionButton action="EDIT.undo" class="'o-hoverable-button'"/>
            <ActionButton action="EDIT.redo" class="'o-hoverable-button'"/>
            <PaintFormatButton class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.clearFormat" class="'o-hoverable-button'"/>

            <div class="o-divider"/>

            <ActionButton action="FORMAT.formatPercent" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.decraseDecimalPlaces" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.incraseDecimalPlaces" class="'o-hoverable-button'"/>
            <ActionButton action="formatNumberMenuItemSpec" onClick="(ev) =&gt; this.toggleToolbarContextMenu(formatNumberMenuItemSpec, ev)" hasTriangleDownIcon="true" class="'o-hoverable-button'"/>

            <div class="o-divider"/>
            <FontSizeEditor class="'o-hoverable-button'" onToggle.bind="this.onClick" dropdownStyle="this.dropdownStyle"/>
            <div class="o-divider"/>

            <ActionButton action="FORMAT.formatBold" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.formatItalic" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.formatStrikethrough" class="'o-hoverable-button'"/>

            <ColorPickerWidget currentColor="state.textColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('textColorTool', ev)" showColorPicker="state.activeTool === 'textColorTool'" onColorPicked="(color) =&gt; this.setColor('textColor', color)" title="text_color" icon="'o-spreadsheet-Icon.TEXT_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-hoverable-button o-menu-item-button'"/>

            <div class="o-divider"/>

            <ColorPickerWidget currentColor="state.fillColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('fillColorTool', ev)" showColorPicker="state.activeTool === 'fillColorTool'" onColorPicked="(color) =&gt; this.setColor('fillColor', color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-hoverable-button o-menu-item-button'"/>

            <BorderEditorWidget class="'o-hoverable-button o-menu-item-button'" toggleBorderEditor="(ev) =&gt; this.toggleDropdownTool('borderTool', ev)" showBorderEditor="state.activeTool === 'borderTool'" dropdownMaxHeight="this.props.dropdownMaxHeight"/>
            <ActionButton action="EDIT.mergeCells" class="'o-hoverable-button'"/>
            <div class="o-divider"/>

            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatAlignmentHorizontal" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('horizontalAlignTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-if="state.activeTool === 'horizontalAlignTool'" t-att-style="dropdownStyle" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatAlignmentLeft" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentCenter" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentRight" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>
            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatAlignmentVertical" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('verticalAlignTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-att-style="dropdownStyle" t-if="state.activeTool === 'verticalAlignTool'" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatAlignmentTop" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentMiddle" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentBottom" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>
            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatWrapping" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('textWrappingTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-att-style="dropdownStyle" t-if="state.activeTool === 'textWrappingTool'" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatWrappingOverflow" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatWrappingWrap" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatWrappingClip" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>

            <div class="o-divider"/>

            <ActionButton action="VIEW.createRemoveFilter" class="'o-hoverable-button'"/>
          </div>
        </div>
        <TopBarComposer focus="props.focusComposer" onComposerContentFocused="props.onComposerContentFocused"/>
      </div>
    </div>
    <Menu t-if="state.menuState.isOpen" position="state.menuState.position" menuItems="state.menuState.menuItems" onClose="() =&gt; this.closeMenus()" onMenuClicked="() =&gt; this.props.onClick()"/>
  </t>

  <t t-name="o-spreadsheet-ValidationMessages">
    <t t-foreach="props.messages" t-as="msg" t-key="msg">
      <div class="d-flex align-items-center o-side-panel-error" t-att-class="divClasses">
        <t t-call="o-spreadsheet-Icon.TRIANGLE_EXCLAMATION"/>
        <span t-esc="msg"/>
      </div>
    </t>
  </t>
<t t-name="o-spreadsheet-Icon.SEE_RECORDS">
    <svg class="o-icon">
      <path fill="currentColor" d="M9.05 11.25c-1.49 0-2.7-1.21-2.7-2.7s1.21-2.7 2.7-2.7 2.7 1.21 2.7 2.7-1.21 2.7-2.7 2.7m0-1.8c.5 0 .9-.4.9-.9s-.4-.9-.9-.9-.9.4-.9.9.4.9.9.9M9 3.15c-3.75 0-6.7 2.1-8 5.06 1.3 2.97 4.25 5.74 8 5.74s6.7-2.77 8-5.74c-1.3-2.96-4.25-5.06-8-5.06m0 9c-2.84 0-4.78-1.66-6.02-3.94C4.22 5.94 6.16 4.95 9 4.95s4.8.99 6.03 3.26c-1.23 2.27-3.19 3.94-6.03 3.94"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DOWNLOAD">
    <svg class="o-icon">
      <path fill="currentColor" d="M2 10.5h1.5V15h11v-4.5H16v6H2M5.5 8H8V1h2v7h2.5L9 11.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GLOBAL_FILTERS">
    <svg width="20" height="20" viewbox="0 0 20 20">
      <path fill="currentColor" d="M1 3h12L7 9M5.5 6h3v11l-3-3M14 4h4v2h-4m-3 3h7v2h-7m0 3h7v2h-7"/>
    </svg>
  </t>
<t t-name="spreadsheet.PublicReadonlySpreadsheet">
        <div t-if="showFilterButton" t-on-click="toggleGlobalFilters" class="o-public-spreadsheet-filter-button position-absolute bg-white fw-bold my-0 mx-3 p-2 fs-6 rounded">
            <t t-call="o-spreadsheet-Icon.GLOBAL_FILTERS"/>
            <span class="ps-1">Show Filters</span>
        </div>
        <div class="o-public-spreadsheet-filters d-flex flex-column flex-nowrap overflow-y-scroll p-3" t-if="state.isFilterShown">
            <div class="o-public-spreadsheet-filters-title d-flex justify-content-between align-items-center">
                <h3 class="m-0">Filters</h3>
                <div class="o-public-spreadsheet-filters-close-button text-center bg-white" t-on-click="toggleGlobalFilters">x</div>
            </div>
            <div class="o-public-spreadsheet-filter" t-foreach="globalFilters" t-as="filter" t-key="filter.id">
                <div class="o-public-spreadsheet-filter-label fw-bolder"><t t-out="filter.label"/></div>
                <div><t t-out="filter.value"/></div>
            </div>
        </div>
        <Spreadsheet model="model"/>
    </t>


</templates>`);
                    });